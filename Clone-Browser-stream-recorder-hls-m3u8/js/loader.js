/*
 *  This file is part of Stream Recorder  v2.2.2  <https://www.hlsloader.com/>
 *  Note that the source code is copyrighted. We do not grant you the right to modify or distribute it.
 */

!function(e){var t=/^((?:[a-zA-Z0-9+\-.]+:)?)(\/\/[^\/\;?#]*)?(.*?)??(;.*?)?(\?.*?)?(#.*?)?$/,s=/^([^\/;?#]*)(.*)$/,r=/(?:\/|^)\.(?=\/)/g,n=/(?:\/|^)\.\.\/(?!\.\.\/).*?(?=\/)/g,i={buildAbsoluteURL:function(e,t,r){if(r=r||{},e=e.trim(),!(t=t.trim())){if(!r.alwaysNormalize)return e;var n=i.parseURL(e);if(!n)throw new Error("Error trying to parse base URL.");return n.path=i.normalizePath(n.path),i.buildURLFromParts(n)}var a=i.parseURL(t);if(!a)throw new Error("Error trying to parse relative URL.");if(a.scheme)return r.alwaysNormalize?(a.path=i.normalizePath(a.path),i.buildURLFromParts(a)):t;var o=i.parseURL(e);if(!o)throw new Error("Error trying to parse base URL.");if(!o.netLoc&&o.path&&"/"!==o.path[0]){var l=s.exec(o.path);o.netLoc=l[1],o.path=l[2]}o.netLoc&&!o.path&&(o.path="/");var d={scheme:o.scheme,netLoc:a.netLoc,path:null,params:a.params,query:a.query,fragment:a.fragment};if(!a.netLoc&&(d.netLoc=o.netLoc,"/"!==a.path[0]))if(a.path){var c=o.path,u=c.substring(0,c.lastIndexOf("/")+1)+a.path;d.path=i.normalizePath(u)}else d.path=o.path,a.params||(d.params=o.params,a.query||(d.query=o.query));return null===d.path&&(d.path=r.alwaysNormalize?i.normalizePath(a.path):a.path),i.buildURLFromParts(d)},parseURL:function(e){var s=t.exec(e);return s?{scheme:s[1]||"",netLoc:s[2]||"",path:s[3]||"",params:s[4]||"",query:s[5]||"",fragment:s[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(r,"");e.length!==(e=e.replace(n,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}};"object"==typeof exports&&"object"==typeof module?module.exports=i:"function"==typeof define&&define.amd?define([],(function(){return i})):"object"==typeof exports?exports.URLToolkit=i:e.URLToolkit=i}(this),(e=>{const t={log:()=>{},error:()=>{},warn:()=>{},debug:()=>{},trace:()=>{}},s={MEDIA_ATTACHING:"hlsMediaAttaching",MEDIA_ATTACHED:"hlsMediaAttached",MEDIA_DETACHING:"hlsMediaDetaching",MEDIA_DETACHED:"hlsMediaDetached",BUFFER_RESET:"hlsBufferReset",BUFFER_CODECS:"hlsBufferCodecs",BUFFER_CREATED:"hlsBufferCreated",BUFFER_APPENDING:"hlsBufferAppending",BUFFER_APPENDED:"hlsBufferAppended",BUFFER_EOS:"hlsBufferEos",BUFFER_FLUSHING:"hlsBufferFlushing",BUFFER_FLUSHED:"hlsBufferFlushed",MANIFEST_LOADING:"hlsManifestLoading",MANIFEST_LOADED:"hlsManifestLoaded",MANIFEST_PARSED:"hlsManifestParsed",LEVEL_SWITCHING:"hlsLevelSwitching",LEVEL_SWITCHED:"hlsLevelSwitched",LEVEL_LOADING:"hlsLevelLoading",LEVEL_LOADED:"hlsLevelLoaded",LEVEL_UPDATED:"hlsLevelUpdated",LEVEL_PTS_UPDATED:"hlsLevelPtsUpdated",LEVELS_UPDATED:"hlsLevelsUpdated",AUDIO_TRACKS_UPDATED:"hlsAudioTracksUpdated",AUDIO_TRACK_SWITCHING:"hlsAudioTrackSwitching",AUDIO_TRACK_SWITCHED:"hlsAudioTrackSwitched",AUDIO_TRACK_LOADING:"hlsAudioTrackLoading",AUDIO_TRACK_LOADED:"hlsAudioTrackLoaded",SUBTITLE_TRACKS_UPDATED:"hlsSubtitleTracksUpdated",SUBTITLE_TRACK_SWITCH:"hlsSubtitleTrackSwitch",SUBTITLE_TRACK_LOADING:"hlsSubtitleTrackLoading",SUBTITLE_TRACK_LOADED:"hlsSubtitleTrackLoaded",SUBTITLE_FRAG_PROCESSED:"hlsSubtitleFragProcessed",CUES_PARSED:"hlsCuesParsed",NON_NATIVE_TEXT_TRACKS_FOUND:"hlsNonNativeTextTracksFound",INIT_PTS_FOUND:"hlsInitPtsFound",FRAG_LOADING:"hlsFragLoading",FRAG_LOAD_PROGRESS:"hlsFragLoadProgress",FRAG_LOAD_EMERGENCY_ABORTED:"hlsFragLoadEmergencyAborted",FRAG_LOADED:"hlsFragLoaded",FRAG_DECRYPTED:"hlsFragDecrypted",FRAG_PARSING_INIT_SEGMENT:"hlsFragParsingInitSegment",FRAG_PARSING_USERDATA:"hlsFragParsingUserdata",FRAG_PARSING_METADATA:"hlsFragParsingMetadata",FRAG_PARSING_DATA:"hlsFragParsingData",FRAG_PARSED:"hlsFragParsed",FRAG_BUFFERED:"hlsFragBuffered",FRAG_CHANGED:"hlsFragChanged",FPS_DROP:"hlsFpsDrop",FPS_DROP_LEVEL_CAPPING:"hlsFpsDropLevelCapping",ERROR:"hlsError",DESTROYING:"hlsDestroying",KEY_LOADING:"hlsKeyLoading",KEY_LOADED:"hlsKeyLoaded",STREAM_STATE_TRANSITION:"hlsStreamStateTransition",LIVE_BACK_BUFFER_REACHED:"hlsLiveBackBufferReached"};var r,n;function i(e,t,s,r){void 0===s&&(s=1),void 0===r&&(r=!1);var n=e*t*s;return r?Math.round(n):n}function a(e,t){return void 0===t&&(t=!1),i(e,1e3,1/9e4,t)}function o(e,t){return void 0===t&&(t=1),i(e,9e4,1/t)}!function(e){e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.KEY_SYSTEM_ERROR="keySystemError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError"}(r||(r={})),function(e){e.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",e.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",e.KEY_SYSTEM_NO_SESSION="keySystemNoSession",e.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",e.KEY_SYSTEM_NO_INIT_DATA="keySystemNoInitData",e.MANIFEST_LOAD_ERROR="manifestLoadError",e.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",e.MANIFEST_PARSING_ERROR="manifestParsingError",e.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",e.LEVEL_EMPTY_ERROR="levelEmptyError",e.LEVEL_LOAD_ERROR="levelLoadError",e.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",e.LEVEL_SWITCH_ERROR="levelSwitchError",e.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",e.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",e.FRAG_LOAD_ERROR="fragLoadError",e.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",e.FRAG_DECRYPT_ERROR="fragDecryptError",e.FRAG_PARSING_ERROR="fragParsingError",e.REMUX_ALLOC_ERROR="remuxAllocError",e.KEY_LOAD_ERROR="keyLoadError",e.KEY_LOAD_TIMEOUT="keyLoadTimeOut",e.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",e.BUFFER_APPEND_ERROR="bufferAppendError",e.BUFFER_APPENDING_ERROR="bufferAppendingError",e.BUFFER_STALLED_ERROR="bufferStalledError",e.BUFFER_FULL_ERROR="bufferFullError",e.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",e.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",e.INTERNAL_EXCEPTION="internalException"}(n||(n={}));const l=/^(\d+)x(\d+)$/,d=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;class c{constructor(e){"string"==typeof e&&(e=c.parseAttrList(e));for(let t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;const s=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++)s[e]=parseInt(t.slice(2*e,2*e+2),16);return s}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}enumeratedString(e){return this[e]}decimalResolution(e){const t=l.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){let t,s={};for(d.lastIndex=0;null!==(t=d.exec(e));){let e=t[2],r='"';0===e.indexOf(r)&&e.lastIndexOf(r)===e.length-1&&(e=e.slice(1,-1)),s[t[1]]=e}return s}}var u={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,drac:!0,dvav:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0}};function h(){return"undefined"==typeof window?self:window}function m(e,i,a,o){let l,d,c,u,h,m="Android".toLowerCase(),f=o,p=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];if(l=1+((192&i[a+2])>>>6),d=(60&i[a+2])>>>2,!(d>p.length-1))return u=(1&i[a+2])<<2,u|=(192&i[a+3])>>>6,t.log(`manifest codec:${o},ADTS data:type:${l},sampleingIndex:${d}[${p[d]}Hz],channelConfig:${u}`),/firefox/i.test(m)?d>=6?(l=5,h=new Array(4),c=d-3):(l=2,h=new Array(2),c=d):-1!==m.indexOf("android")?(l=2,h=new Array(2),c=d):(l=5,h=new Array(4),o&&(-1!==o.indexOf("mp4a.40.29")||-1!==o.indexOf("mp4a.40.5"))||!o&&d>=6?c=d-3:((o&&-1!==o.indexOf("mp4a.40.2")&&(d>=6&&1===u||/vivaldi/i.test(m))||!o&&1===u)&&(l=2,h=new Array(2)),c=d)),h[0]=l<<3,h[0]|=(14&d)>>1,h[1]|=(1&d)<<7,h[1]|=u<<3,5===l&&(h[1]|=(14&c)>>1,h[2]=(1&c)<<7,h[2]|=8,h[3]=0),{config:h,samplerate:p[d],channelCount:u,codec:"mp4a.40."+l,manifestCodec:f};e.trigger(s.ERROR,{type:r.MEDIA_ERROR,details:n.FRAG_PARSING_ERROR,fatal:!0,reason:`invalid ADTS sampling index:${d}`})}function f(e,t){return 255===e[t]&&240==(246&e[t+1])}function p(e,t){return 1&e[t+1]?7:9}function g(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}function y(e,t){return!!(t+1<e.length&&f(e,t))}function b(e){return 9216e4/e}function v(e,t,s,r,n){let i,a,o,l=e.length;if(i=p(e,t),a=g(e,t),a-=i,a>0&&t+i+a<=l)return o=s+r*n,{headerLength:i,frameLength:a,stamp:o}}const _={getAudioConfig:m,isHeaderPattern:f,getHeaderLength:p,getFullFrameLength:g,isHeader:y,probe:function(e,t){if(y(e,t)){let s=p(e,t);if(t+s>=e.length)return!1;let r=g(e,t);if(r<=s)return!1;let n=t+r;if(n===e.length||n+1<e.length&&f(e,n))return!0}return!1},initTrackConfig:function(e,s,r,n,i){if(!e.samplerate){let a=m(s,r,n,i);e.config=a.config,e.samplerate=a.samplerate,e.channelCount=a.channelCount,e.codec=a.codec,e.manifestCodec=a.manifestCodec,t.log(`parsed codec:${e.codec},rate:${a.samplerate},nb channel:${a.channelCount}`)}},getFrameDuration:b,parseFrameHeader:v,appendFrame:function(e,t,s,r,n){let i=v(t,s,r,n,b(e.samplerate));if(i){let r=i.stamp,n=i.headerLength,a=i.frameLength,o={unit:t.subarray(s+n,s+n+a),pts:r,dts:r};return e.samples.push(o),{sample:o,length:a+n}}}},S={BitratesMap:[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap:[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],SamplesCoefficients:[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],BytesInSlot:[0,1,1,4],appendFrame:function(e,t,s,r,n){if(s+24>t.length)return;let i=this.parseHeader(t,s);if(i&&s+i.frameLength<=t.length){let a=r+n*(9e4*i.samplesPerFrame/i.sampleRate),o={unit:t.subarray(s,s+i.frameLength),pts:a,dts:a};return e.config=[],e.channelCount=i.channelCount,e.samplerate=i.sampleRate,e.samples.push(o),{sample:o,length:i.frameLength}}},parseHeader:function(e,t){let s=e[t+1]>>3&3,r=e[t+1]>>1&3,n=e[t+2]>>4&15,i=e[t+2]>>2&3,a=e[t+2]>>1&1;if(1!==s&&0!==n&&15!==n&&3!==i){let o=3===s?3-r:3===r?3:4,l=1e3*S.BitratesMap[14*o+n-1],d=3===s?0:2===s?1:2,c=S.SamplingRateMap[3*d+i],u=e[t+3]>>6==3?1:2,h=S.SamplesCoefficients[s][r],m=S.BytesInSlot[r],f=8*h*m;return{sampleRate:c,channelCount:u,frameLength:parseInt(h*l/c+a,10)*m,samplesPerFrame:f}}},isHeaderPattern:function(e,t){return!(255!==e[t]||224&~e[t+1]||!(6&e[t+1]))},isHeader:function(e,t){return!!(t+1<e.length&&this.isHeaderPattern(e,t))},probe:function(e,t){if(t+1<e.length&&this.isHeaderPattern(e,t)){let s=4,r=this.parseHeader(e,t),n=s;r&&r.frameLength&&(n=r.frameLength);let i=t+n;if(i===e.length||i+1<e.length&&this.isHeaderPattern(e,i))return!0}return!1}};class T{constructor(e){this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){let e=this.data,t=this.bytesAvailable,s=e.byteLength-t,r=new Uint8Array(4),n=Math.min(4,t);if(0===n)throw new Error("no bytes available");r.set(e.subarray(s,s+n)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*n,this.bytesAvailable-=n}skipBits(e){let t;this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(t=(e-=this.bitsAvailable)>>3,e-=t>>3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let s=Math.min(this.bitsAvailable,e),r=this.word>>>32-s;return e>32&&t.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=s,this.bitsAvailable>0?this.word<<=s:this.bytesAvailable>0&&this.loadWord(),s=e-s,s>0&&this.bitsAvailable?r<<s|this.readBits(s):r}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(this.word&2147483648>>>e)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){let e=this.skipLZ();return this.readBits(e+1)-1}readEG(){let e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t,s,r=8,n=8;for(t=0;t<e;t++)0!==n&&(s=this.readEG(),n=(r+s+256)%256),r=0===n?r:n}readSPS(){let e,t,s,r,n,i,a,o,l,d=0,c=0,u=0,h=0,m=this.readUByte.bind(this),f=this.readBits.bind(this),p=this.readUEG.bind(this),g=this.readBoolean.bind(this),y=this.skipBits.bind(this),b=this.skipEG.bind(this),v=this.skipUEG.bind(this),_=this.skipScalingList.bind(this);if(m(),e=m(),t=f(5),y(3),s=m(),v(),100===e||110===e||122===e||244===e||44===e||83===e||86===e||118===e||128===e){let e=p();if(3===e&&y(1),v(),v(),y(1),g())for(o=3!==e?8:12,l=0;l<o;l++)g()&&_(l<6?16:64)}v();let S=p();if(0===S)p();else if(1===S)for(y(1),b(),b(),r=p(),l=0;l<r;l++)b();v(),y(1),n=p(),i=p(),a=f(1),0===a&&y(1),y(1),g()&&(d=p(),c=p(),u=p(),h=p());let T=[1,1];if(g()&&g())switch(m()){case 1:T=[1,1];break;case 2:T=[12,11];break;case 3:T=[10,11];break;case 4:T=[16,11];break;case 5:T=[40,33];break;case 6:T=[24,11];break;case 7:T=[20,11];break;case 8:T=[32,11];break;case 9:T=[80,33];break;case 10:T=[18,11];break;case 11:T=[15,11];break;case 12:T=[64,33];break;case 13:T=[160,99];break;case 14:T=[4,3];break;case 15:T=[3,2];break;case 16:T=[2,1];break;case 255:T=[m()<<8|m(),m()<<8|m()]}return{width:Math.ceil(16*(n+1)-2*d-2*c),height:(2-a)*(i+1)*16-(a?2:4)*(u+h),pixelRatio:T}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class A{constructor(e,t){this.subtle=e,this.aesIV=t}decrypt(e,t){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e)}}class w{constructor(e,t){this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}class k{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.initTable()}uint8ArrayToUint32Array_(e){let t=new DataView(e),s=new Uint32Array(4);for(let e=0;e<4;e++)s[e]=t.getUint32(4*e);return s}initTable(){let e=this.sBox,t=this.invSBox,s=this.subMix,r=s[0],n=s[1],i=s[2],a=s[3],o=this.invSubMix,l=o[0],d=o[1],c=o[2],u=o[3],h=new Uint32Array(256),m=0,f=0,p=0;for(p=0;p<256;p++)h[p]=p<128?p<<1:p<<1^283;for(p=0;p<256;p++){let s=f^f<<1^f<<2^f<<3^f<<4;s=s>>>8^255&s^99,e[m]=s,t[s]=m;let o=h[m],p=h[o],g=h[p],y=257*h[s]^16843008*s;r[m]=y<<24|y>>>8,n[m]=y<<16|y>>>16,i[m]=y<<8|y>>>24,a[m]=y,y=16843009*g^65537*p^257*o^16843008*m,l[s]=y<<24|y>>>8,d[s]=y<<16|y>>>16,c[s]=y<<8|y>>>24,u[s]=y,m?(m=o^h[h[h[g^o]]],f^=h[h[f]]):m=f=1}}expandKey(e){let t=this.uint8ArrayToUint32Array_(e),s=!0,r=0;for(;r<t.length&&s;)s=t[r]===this.key[r],r++;if(s)return;this.key=t;let n=this.keySize=t.length;if(4!==n&&6!==n&&8!==n)throw new Error("Invalid aes key size="+n);let i,a,o,l,d=this.ksRows=4*(n+6+1),c=this.keySchedule=new Uint32Array(d),u=this.invKeySchedule=new Uint32Array(d),h=this.sBox,m=this.rcon,f=this.invSubMix,p=f[0],g=f[1],y=f[2],b=f[3];for(i=0;i<d;i++)i<n?o=c[i]=t[i]:(l=o,i%n==0?(l=l<<8|l>>>24,l=h[l>>>24]<<24|h[l>>>16&255]<<16|h[l>>>8&255]<<8|h[255&l],l^=m[i/n|0]<<24):n>6&&i%n==4&&(l=h[l>>>24]<<24|h[l>>>16&255]<<16|h[l>>>8&255]<<8|h[255&l]),c[i]=o=(c[i-n]^l)>>>0);for(a=0;a<d;a++)i=d-a,l=3&a?c[i]:c[i-4],u[a]=a<4||i<=4?l:p[h[l>>>24]]^g[h[l>>>16&255]]^y[h[l>>>8&255]]^b[h[255&l]],u[a]=u[a]>>>0}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,s,r){let n,i,a,o,l,d,c,u,h,m,f,p,g,y,b=this.keySize+6,v=this.invKeySchedule,_=this.invSBox,S=this.invSubMix,T=S[0],A=S[1],w=S[2],k=S[3],D=this.uint8ArrayToUint32Array_(s),E=D[0],x=D[1],L=D[2],I=D[3],R=new Int32Array(e),M=new Int32Array(R.length),C=this.networkToHostOrderSwap;for(;t<R.length;){for(h=C(R[t]),m=C(R[t+1]),f=C(R[t+2]),p=C(R[t+3]),l=h^v[0],d=p^v[1],c=f^v[2],u=m^v[3],g=4,y=1;y<b;y++)n=T[l>>>24]^A[d>>16&255]^w[c>>8&255]^k[255&u]^v[g],i=T[d>>>24]^A[c>>16&255]^w[u>>8&255]^k[255&l]^v[g+1],a=T[c>>>24]^A[u>>16&255]^w[l>>8&255]^k[255&d]^v[g+2],o=T[u>>>24]^A[l>>16&255]^w[d>>8&255]^k[255&c]^v[g+3],l=n,d=i,c=a,u=o,g+=4;n=_[l>>>24]<<24^_[d>>16&255]<<16^_[c>>8&255]<<8^_[255&u]^v[g],i=_[d>>>24]<<24^_[c>>16&255]<<16^_[u>>8&255]<<8^_[255&l]^v[g+1],a=_[c>>>24]<<24^_[u>>16&255]<<16^_[l>>8&255]<<8^_[255&d]^v[g+2],o=_[u>>>24]<<24^_[l>>16&255]<<16^_[d>>8&255]<<8^_[255&c]^v[g+3],g+=3,M[t]=C(n^E),M[t+1]=C(o^x),M[t+2]=C(a^L),M[t+3]=C(i^I),E=h,x=m,L=f,I=p,t+=4}return r?function(e){const t=e.byteLength,s=t&&new DataView(e).getUint8(t-1);return s?e.slice(0,t-s):e}(M.buffer):M.buffer}destroy(){this.key=void 0,this.keySize=void 0,this.ksRows=void 0,this.sBox=void 0,this.invSBox=void 0,this.subMix=void 0,this.invSubMix=void 0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.rcon=void 0}}const D=h();class E{constructor(e,t,{removePKCS7Padding:s=!0}={}){if(this.logEnabled=!0,this.observer=e,this.config=t,this.removePKCS7Padding=s,s)try{const e=D.crypto;e&&(this.subtle=e.subtle||e.webkitSubtle)}catch(e){}this.disableWebCrypto=!this.subtle}isSync(){return this.disableWebCrypto&&this.config.enableSoftwareAES}decrypt(e,s,r,n){if(this.disableWebCrypto&&this.config.enableSoftwareAES){this.logEnabled&&(t.log("JS AES decrypt"),this.logEnabled=!1);let i=this.decryptor;i||(this.decryptor=i=new k),i.expandKey(s),n(i.decrypt(e,0,r,this.removePKCS7Padding))}else{this.logEnabled&&(t.log("WebCrypto AES decrypt"),this.logEnabled=!1);const i=this.subtle;this.key!==s&&(this.key=s,this.fastAesKey=new w(i,s)),this.fastAesKey.expandKey().then((t=>{new A(i,r).decrypt(e,t).catch((t=>{this.onWebCryptoError(t,e,s,r,n)})).then((e=>{n(e)}))})).catch((t=>{this.onWebCryptoError(t,e,s,r,n)}))}}onWebCryptoError(e,i,a,o,l){this.config.enableSoftwareAES?(t.log("WebCrypto Error, disable WebCrypto API"),this.disableWebCrypto=!0,this.logEnabled=!0,this.decrypt(i,a,o,l)):(t.error(`decrypting error : ${e.message}`),this.observer.trigger(s.ERROR,{type:r.MEDIA_ERROR,details:n.FRAG_DECRYPT_ERROR,fatal:!0,reason:e.message}))}destroy(){let e=this.decryptor;e&&(e.destroy(),this.decryptor=void 0)}}class x{constructor(e,t,s,r){this.decryptdata=s,this.discardEPB=r,this.decrypter=new E(e,t,{removePKCS7Padding:!1})}decryptBuffer(e,t){this.decrypter.decrypt(e,this.decryptdata.key.buffer,this.decryptdata.iv.buffer,t)}decryptAacSample(e,t,s,r){let n=e[t].unit,i=n.subarray(16,n.length-n.length%16),a=i.buffer.slice(i.byteOffset,i.byteOffset+i.length),o=this;this.decryptBuffer(a,(function(i){i=new Uint8Array(i),n.set(i,16),r||o.decryptAacSamples(e,t+1,s)}))}decryptAacSamples(e,t,s){for(;;t++){if(t>=e.length)return void s();if(e[t].unit.length<32)continue;let r=this.decrypter.isSync();if(this.decryptAacSample(e,t,s,r),!r)return}}getAvcEncryptedData(e){let t=16*Math.floor((e.length-48)/160)+16,s=new Int8Array(t),r=0;for(let t=32;t<=e.length-16;t+=160,r+=16)s.set(e.subarray(t,t+16),r);return s}getAvcDecryptedUnit(e,t){t=new Uint8Array(t);let s=0;for(let r=32;r<=e.length-16;r+=160,s+=16)e.set(t.subarray(s,s+16),r);return e}decryptAvcSample(e,t,s,r,n,i){let a=this.discardEPB(n.data),o=this.getAvcEncryptedData(a),l=this;this.decryptBuffer(o.buffer,(function(o){n.data=l.getAvcDecryptedUnit(a,o),i||l.decryptAvcSamples(e,t,s+1,r)}))}decryptAvcSamples(e,t,s,r){for(;;t++,s=0){if(t>=e.length)return void r();let n=e[t].units;for(;!(s>=n.length);s++){let i=n[s];if(i.length<=48||1!==i.type&&5!==i.type)continue;let a=this.decrypter.isSync();if(this.decryptAvcSample(e,t,s,r,i,a),!a)return}}}}const L={video:1,audio:2,id3:3,text:4};class I{constructor(e,t,s,r){this.observer=e,this.config=s,this.typeSupported=r,this.remuxer=t,this.sampleAes=null,this.pmtUnknownTypes={}}setDecryptData(e){null!=e&&null!=e.key&&"SAMPLE-AES"===e.method?this.sampleAes=new x(this.observer,this.config,e,this.discardEPB):this.sampleAes=null}static probe(e){const s=I._syncOffset(e);return!(s<0||(s&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${s}, junk ahead ?`),0))}static _syncOffset(e){const t=Math.min(1e3,e.length-564);let s=0;for(;s<t;){if(71===e[s]&&71===e[s+188]&&71===e[s+376])return s;s++}return-1}static createTrack(e,t){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:L[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:"video"===e?0:void 0,isAAC:"audio"===e||void 0,duration:"audio"===e?t:void 0}}resetInitSegment(e,t,s,r){this.pmtParsed=!1,this._pmtId=-1,this.pmtUnknownTypes={},this._avcTrack=I.createTrack("video",r),this._audioTrack=I.createTrack("audio",r),this._id3Track=I.createTrack("id3",r),this._txtTrack=I.createTrack("text",r),this.aacOverFlow=null,this.aacLastPTS=null,this.avcSample=null,this.audioCodec=t,this.videoCodec=s,this._duration=r}resetTimeStamp(){}append(e,i,a,o){let l,d,c,u,h,m,f=e.length,p=!1;this.pmtUnknownTypes={},this.contiguous=a;let g=this.pmtParsed,y=this._avcTrack,b=this._audioTrack,v=this._id3Track,_=y.pid,S=b.pid,T=v.pid,A=this._pmtId,w=y.pesData,k=b.pesData,D=v.pesData,E=this._parsePAT,x=this._parsePMT.bind(this),L=this._parsePES,R=this._parseAVCPES.bind(this),M=this._parseAACPES.bind(this),C=this._parseMPEGPES.bind(this),O=this._parseID3PES.bind(this);const P=I._syncOffset(e);for(f-=(f+P)%188,l=P;l<f;l+=188)if(71===e[l]){if(d=!!(64&e[l+1]),c=((31&e[l+1])<<8)+e[l+2],u=(48&e[l+3])>>4,u>1){if(h=l+5+e[l+4],h===l+188)continue}else h=l+4;switch(c){case _:d&&(w&&(m=L(w))&&R(m,!1),w={data:[],size:0}),w&&(w.data.push(e.subarray(h,l+188)),w.size+=l+188-h);break;case S:d&&(k&&(m=L(k))&&(b.isAAC?M(m):C(m)),k={data:[],size:0}),k&&(k.data.push(e.subarray(h,l+188)),k.size+=l+188-h);break;case T:d&&(D&&(m=L(D))&&O(m),D={data:[],size:0}),D&&(D.data.push(e.subarray(h,l+188)),D.size+=l+188-h);break;case 0:d&&(h+=e[h]+1),A=this._pmtId=E(e,h);break;case A:d&&(h+=e[h]+1);let s=x(e,h,!0===this.typeSupported.mpeg||!0===this.typeSupported.mp3,null!=this.sampleAes);_=s.avc,_>0&&(y.pid=_),S=s.audio,S>0&&(b.pid=S,b.isAAC=s.isAAC),T=s.id3,T>0&&(v.pid=T),p&&!g&&(t.log("reparse from beginning"),p=!1,l=P-188),g=this.pmtParsed=!0;break;case 17:case 8191:break;default:p=!0}}else this.observer.trigger(s.ERROR,{type:r.MEDIA_ERROR,details:n.FRAG_PARSING_ERROR,fatal:!1,reason:"TS packet did not start with 0x47"});w&&(m=L(w))?(R(m,!0),y.pesData=null):y.pesData=w,k&&(m=L(k))?(b.isAAC?M(m):C(m),b.pesData=null):(k&&k.size&&t.log("last AAC PES packet truncated,might overlap between fragments"),b.pesData=k),D&&(m=L(D))?(O(m),v.pesData=null):v.pesData=D,null==this.sampleAes?this.remuxer.remux(b,y,v,this._txtTrack,i,a,o):this.decryptAndRemux(b,y,v,this._txtTrack,i,a,o)}decryptAndRemux(e,t,s,r,n,i,a){if(e.samples&&e.isAAC){let o=this;this.sampleAes.decryptAacSamples(e.samples,0,(function(){o.decryptAndRemuxAvc(e,t,s,r,n,i,a)}))}else this.decryptAndRemuxAvc(e,t,s,r,n,i,a)}decryptAndRemuxAvc(e,t,s,r,n,i,a){if(t.samples){let o=this;this.sampleAes.decryptAvcSamples(t.samples,0,0,(function(){o.remuxer.remux(e,t,s,r,n,i,a)}))}else this.remuxer.remux(e,t,s,r,n,i,a)}destroy(){this._initPTS=this._initDTS=void 0,this._duration=0}_parsePAT(e,t){return(31&e[t+10])<<8|e[t+11]}_trackUnknownPmt(e,s,r){const n=this.pmtUnknownTypes[e]||0;return 0===n&&(this.pmtUnknownTypes[e]=0,s.call(t,r)),this.pmtUnknownTypes[e]++,n}_parsePMT(e,s,r,n){let i,a,o,l,d={audio:-1,avc:-1,id3:-1,isAAC:!0};for(i=(15&e[s+1])<<8|e[s+2],a=s+3+i-4,o=(15&e[s+10])<<8|e[s+11],s+=12+o;s<a;){switch(l=(31&e[s+1])<<8|e[s+2],e[s]){case 207:if(!n){this._trackUnknownPmt(e[s],t.warn,"ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:-1===d.audio&&(d.audio=l);break;case 21:-1===d.id3&&(d.id3=l);break;case 219:if(!n){this._trackUnknownPmt(e[s],t.warn,"H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:-1===d.avc&&(d.avc=l);break;case 3:case 4:r?-1===d.audio&&(d.audio=l,d.isAAC=!1):this._trackUnknownPmt(e[s],t.warn,"MPEG audio found, not supported in this browser");break;case 36:this._trackUnknownPmt(e[s],t.warn,"Unsupported HEVC stream type found");break;default:this._trackUnknownPmt(e[s],t.log,"Unknown stream type:"+e[s])}s+=5+((15&e[s+3])<<8|e[s+4])}return d}_parsePES(e){let s,r,n,i,a,o,l,d,c,u=0,h=e.data;if(!e||0===e.size)return null;for(;h[0].length<19&&h.length>1;){let e=new Uint8Array(h[0].length+h[1].length);e.set(h[0]),e.set(h[1],h[0].length),h[0]=e,h.splice(1,1)}if(s=h[0],n=(s[0]<<16)+(s[1]<<8)+s[2],1===n){if(i=(s[4]<<8)+s[5],i&&i>e.size-6)return null;if(r=s[7],192&r&&(l=536870912*(14&s[9])+4194304*(255&s[10])+16384*(254&s[11])+128*(255&s[12])+(254&s[13])/2,64&r?(d=536870912*(14&s[14])+4194304*(255&s[15])+16384*(254&s[16])+128*(255&s[17])+(254&s[18])/2,l-d>54e5&&(t.warn(`${Math.round((l-d)/9e4)}s delta between PTS and DTS, align them`),l=d)):d=l),a=s[8],c=a+9,e.size<=c)return null;e.size-=c,o=new Uint8Array(e.size);for(let e=0,t=h.length;e<t;e++){s=h[e];let t=s.byteLength;if(c){if(c>t){c-=t;continue}s=s.subarray(c),t-=c,c=0}o.set(s,u),u+=t}return i&&(i-=a+3),{data:o,pts:l,dts:d,len:i}}return null}pushAccesUnit(e,s){if(e.units.length&&e.frame){const t=s.samples,r=t.length;if(isNaN(e.pts)){if(!r)return void s.dropped++;{const s=t[r-1];e.pts=s.pts,e.dts=s.dts}}!this.config.forceKeyFrameOnDiscontinuity||!0===e.key||s.sps&&(r||this.contiguous)?(e.id=r,t.push(e)):s.dropped++}e.debug.length&&t.log(e.pts+"/"+e.dts+":"+e.debug)}_parseAVCPES(e,t){let s,r,n,i=this._avcTrack,a=this._parseAVCNALu(e.data),o=this.avcSample,l=!1,d=this.pushAccesUnit.bind(this),c=function(e,t,s,r){return{key:e,pts:t,dts:s,units:[],debug:r}};e.data=null,o&&a.length&&!i.audFound&&(d(o,i),o=this.avcSample=c(!1,e.pts,e.dts,"")),a.forEach((t=>{switch(t.type){case 1:r=!0,o||(o=this.avcSample=c(!0,e.pts,e.dts,"")),o.frame=!0;let f=t.data;if(l&&f.length>4){let e=new T(f).readSliceType();2!==e&&4!==e&&7!==e&&9!==e||(o.key=!0)}break;case 5:r=!0,o||(o=this.avcSample=c(!0,e.pts,e.dts,"")),o.key=!0,o.frame=!0;break;case 6:r=!0,s=new T(this.discardEPB(t.data)),s.readUByte();for(var a=0,u=0,h=!1,m=0;!h&&s.bytesAvailable>1;){a=0;do{a+=m=s.readUByte()}while(255===m);u=0;do{u+=m=s.readUByte()}while(255===m);if(4===a&&0!==s.bytesAvailable){if(h=!0,181===s.readUByte()&&49===s.readUShort()&&1195456820===s.readUInt()&&3===s.readUByte()){let t=s.readUByte(),r=31&t,i=[t,s.readUByte()];for(n=0;n<r;n++)i.push(s.readUByte()),i.push(s.readUByte()),i.push(s.readUByte());this._insertSampleInOrder(this._txtTrack.samples,{type:3,pts:e.pts,bytes:i})}}else if(5===a&&0!==s.bytesAvailable){if(h=!0,u>16){const t=[];for(n=0;n<16;n++)t.push(s.readUByte().toString(16)),3!==n&&5!==n&&7!==n&&9!==n||t.push("-");const r=u-16,i=new Uint8Array(r);for(n=0;n<r;n++)i[n]=s.readUByte();this._insertSampleInOrder(this._txtTrack.samples,{pts:e.pts,payloadType:a,uuid:t.join(""),userDataBytes:i,userData:q(i.buffer)})}}else if(u<s.bytesAvailable)for(n=0;n<u;n++)s.readUByte()}break;case 7:if(r=!0,l=!0,!i.sps){s=new T(t.data);let e=s.readSPS();i.width=e.width,i.height=e.height,i.pixelRatio=e.pixelRatio,i.sps=[t.data],i.duration=this._duration;let r=t.data.subarray(1,4),a="avc1.";for(n=0;n<3;n++){let e=r[n].toString(16);e.length<2&&(e="0"+e),a+=e}i.codec=a}break;case 8:r=!0,i.pps||(i.pps=[t.data]);break;case 9:r=!1,i.audFound=!0,o&&d(o,i),o=this.avcSample=c(!1,e.pts,e.dts,"");break;case 12:r=!1;break;default:r=!1,o&&(o.debug+="unknown NAL "+t.type+" ")}o&&r&&o.units.push(t)})),t&&o&&(d(o,i),this.avcSample=null)}_insertSampleInOrder(e,t){let s=e.length;if(s>0){if(t.pts>=e[s-1].pts)e.push(t);else for(let r=s-1;r>=0;r--)if(t.pts<e[r].pts){e.splice(r,0,t);break}}else e.push(t)}_getLastNalUnit(){let e,t=this.avcSample;if(!t||0===t.units.length){let e=this._avcTrack.samples;t=e[e.length-1]}if(t){let s=t.units;e=s[s.length-1]}return e}_parseAVCNALu(e){let t,s,r,n,i,a=0,o=e.byteLength,l=this._avcTrack,d=l.naluState||0,c=d,u=[],h=-1;for(-1===d&&(h=0,i=31&e[0],d=0,a=1);a<o;)if(t=e[a++],d)if(1!==d)if(t)if(1===t){if(h>=0)r={data:e.subarray(h,a-d-1),type:i},u.push(r);else{let t=this._getLastNalUnit();if(t&&(c&&a<=4-c&&t.state&&(t.data=t.data.subarray(0,t.data.byteLength-c)),s=a-d-1,s>0)){let r=new Uint8Array(t.data.byteLength+s);r.set(t.data,0),r.set(e.subarray(0,s),t.data.byteLength),t.data=r}}a<o?(n=31&e[a],h=a,i=n,d=0):d=-1}else d=0;else d=3;else d=t?0:2;else d=t?0:1;if(h>=0&&d>=0&&(r={data:e.subarray(h,o),type:i,state:d},u.push(r)),0===u.length){let t=this._getLastNalUnit();if(t){let s=new Uint8Array(t.data.byteLength+e.byteLength);s.set(t.data,0),s.set(e,t.data.byteLength),t.data=s}}return l.naluState=d,u}discardEPB(e){let t,s,r=e.byteLength,n=[],i=1;for(;i<r-2;)0===e[i]&&0===e[i+1]&&3===e[i+2]?(n.push(i+2),i+=2):i++;if(0===n.length)return e;t=r-n.length,s=new Uint8Array(t);let a=0;for(i=0;i<t;a++,i++)a===n[0]&&(a++,n.shift()),s[i]=e[a];return s}_parseAACPES(e){let i,a,o,l,d,c=this._audioTrack,u=e.data,h=e.pts,m=this.aacOverFlow,f=this.aacLastPTS;if(m){let e=new Uint8Array(m.byteLength+u.byteLength);e.set(m,0),e.set(u,m.byteLength),u=e}for(o=0,d=u.length;o<d-1&&!_.isHeader(u,o);o++);if(o>0&&o<d-1)o=0;else if(o){let e,i;if(o<d-1?(e=`AAC PES did not start with ADTS header,offset:${o}`,i=!1):(e="no ADTS header found in AAC PES",i=!0),t.warn(`parsing error:${e}`),this.observer.trigger(s.ERROR,{type:r.MEDIA_ERROR,details:n.FRAG_PARSING_ERROR,fatal:i,reason:e}),i)return}if(_.initTrackConfig(c,this.observer,u,o,this.audioCodec),a=0,i=_.getFrameDuration(c.samplerate),m&&f){let e=f+i;Math.abs(e-h)>1&&(t.log(`AAC: align PTS for overlapping frames by ${Math.round((e-h)/90)}`),h=e)}for(;o<d;){if(_.isHeader(u,o)){if(o+5<d){const e=_.appendFrame(c,u,o,h,a);if(e){o+=e.length,l=e.sample.pts,a++;continue}}break}o++}m=o<d?u.subarray(o,d):null,this.aacOverFlow=m,this.aacLastPTS=l}_parseMPEGPES(e){let t=e.data,s=t.length,r=0,n=0,i=e.pts;for(;n<s;)if(S.isHeader(t,n)){let e=S.appendFrame(this._audioTrack,t,n,i,r);if(!e)break;n+=e.length,r++}else n++}_parseID3PES(e){this._id3Track.samples.push(e)}}class R{static getSilentFrame(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}const M=Math.pow(2,32)-1;class C{static init(){let e;for(e in C.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},C.types)C.types.hasOwnProperty(e)&&(C.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);let t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),s=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);C.HDLR_TYPES={video:t,audio:s};let r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),n=new Uint8Array([0,0,0,0,0,0,0,0]);C.STTS=C.STSC=C.STCO=n,C.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),C.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),C.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),C.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);let i=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);C.FTYP=C.box(C.types.ftyp,i,o,i,a),C.DINF=C.box(C.types.dinf,C.box(C.types.dref,r))}static box(e){let t,s=Array.prototype.slice.call(arguments,1),r=8,n=s.length,i=n;for(;n--;)r+=s[n].byteLength;for(t=new Uint8Array(r),t[0]=r>>24&255,t[1]=r>>16&255,t[2]=r>>8&255,t[3]=255&r,t.set(e,4),n=0,r=8;n<i;n++)t.set(s[n],r),r+=s[n].byteLength;return t}static hdlr(e){return C.box(C.types.hdlr,C.HDLR_TYPES[e])}static mdat(e){return C.box(C.types.mdat,e)}static mdhd(e,t){t*=e;const s=Math.floor(t/(M+1)),r=Math.floor(t%(M+1));return C.box(C.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,s>>24,s>>16&255,s>>8&255,255&s,r>>24,r>>16&255,r>>8&255,255&r,85,196,0,0]))}static mdia(e){return C.box(C.types.mdia,C.mdhd(e.timescale,e.duration),C.hdlr(e.type),C.minf(e))}static mfhd(e){return C.box(C.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?C.box(C.types.minf,C.box(C.types.smhd,C.SMHD),C.DINF,C.stbl(e)):C.box(C.types.minf,C.box(C.types.vmhd,C.VMHD),C.DINF,C.stbl(e))}static moof(e,t,s){return C.box(C.types.moof,C.mfhd(e),C.traf(s,t))}static moov(e){let t=e.length,s=[];for(;t--;)s[t]=C.trak(e[t]);return C.box.apply(null,[C.types.moov,C.mvhd(e[0].timescale,e[0].duration)].concat(s).concat(C.mvex(e)))}static mvex(e){let t=e.length,s=[];for(;t--;)s[t]=C.trex(e[t]);return C.box.apply(null,[C.types.mvex].concat(s))}static mvhd(e,t){t*=e;const s=Math.floor(t/(M+1)),r=Math.floor(t%(M+1));let n=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,s>>24,s>>16&255,s>>8&255,255&s,r>>24,r>>16&255,r>>8&255,255&r,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return C.box(C.types.mvhd,n)}static sdtp(e){let t,s,r=e.samples||[],n=new Uint8Array(4+r.length);for(s=0;s<r.length;s++)t=r[s].flags,n[s+4]=t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;return C.box(C.types.sdtp,n)}static stbl(e){return C.box(C.types.stbl,C.stsd(e),C.box(C.types.stts,C.STTS),C.box(C.types.stsc,C.STSC),C.box(C.types.stsz,C.STSZ),C.box(C.types.stco,C.STCO))}static avc1(e){let t,s,r,n=[],i=[];for(t=0;t<e.sps.length;t++)s=e.sps[t],r=s.byteLength,n.push(r>>>8&255),n.push(255&r),n=n.concat(Array.prototype.slice.call(s));for(t=0;t<e.pps.length;t++)s=e.pps[t],r=s.byteLength,i.push(r>>>8&255),i.push(255&r),i=i.concat(Array.prototype.slice.call(s));let a=C.box(C.types.avcC,new Uint8Array([1,n[3],n[4],n[5],255,224|e.sps.length].concat(n).concat([e.pps.length]).concat(i))),o=e.width,l=e.height,d=e.pixelRatio[0],c=e.pixelRatio[1];return C.box(C.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,C.box(C.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),C.box(C.types.pasp,new Uint8Array([d>>24,d>>16&255,d>>8&255,255&d,c>>24,c>>16&255,c>>8&255,255&c])))}static esds(e){let t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}static mp4a(e){let t=e.samplerate;return C.box(C.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0]),C.box(C.types.esds,C.esds(e)))}static mp3(e){let t=e.samplerate;return C.box(C.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0]))}static stsd(e){return"audio"===e.type?e.isAAC||"mp3"!==e.codec?C.box(C.types.stsd,C.STSD,C.mp4a(e)):C.box(C.types.stsd,C.STSD,C.mp3(e)):C.box(C.types.stsd,C.STSD,C.avc1(e))}static tkhd(e){let t=e.id,s=e.duration*e.timescale,r=e.width,n=e.height,i=Math.floor(s/(M+1)),a=Math.floor(s%(M+1));return C.box(C.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i,a>>24,a>>16&255,a>>8&255,255&a,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,255&r,0,0,n>>8&255,255&n,0,0]))}static traf(e,t){let s=C.sdtp(e),r=e.id,n=Math.floor(t/(M+1)),i=Math.floor(t%(M+1));return C.box(C.types.traf,C.box(C.types.tfhd,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),C.box(C.types.tfdt,new Uint8Array([1,0,0,0,n>>24,n>>16&255,n>>8&255,255&n,i>>24,i>>16&255,i>>8&255,255&i])),C.trun(e,s.length+16+20+8+16+8+8),s)}static trak(e){return e.duration=e.duration||4294967295,C.box(C.types.trak,C.tkhd(e),C.mdia(e))}static trex(e){let t=e.id;return C.box(C.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){let s,r,n,i,a,o,l=e.samples||[],d=l.length,c=12+16*d,u=new Uint8Array(c);for(t+=8+c,u.set([0,0,15,1,d>>>24&255,d>>>16&255,d>>>8&255,255&d,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),s=0;s<d;s++)r=l[s],n=r.duration,i=r.size,a=r.flags,o=r.cts,u.set([n>>>24&255,n>>>16&255,n>>>8&255,255&n,i>>>24&255,i>>>16&255,i>>>8&255,255&i,a.isLeading<<2|a.dependsOn,a.isDependedOn<<6|a.hasRedundancy<<4|a.paddingValue<<1|a.isNonSync,61440&a.degradPrio,15&a.degradPrio,o>>>24&255,o>>>16&255,o>>>8&255,255&o],12+16*s);return C.box(C.types.trun,u)}static initSegment(e){C.types||C.init();let t,s=C.moov(e);return t=new Uint8Array(C.FTYP.byteLength+s.byteLength),t.set(C.FTYP),t.set(s,C.FTYP.byteLength),t}}const O=o(10),P=o(.2);let U,B=null;function F(e,t){let s;if(void 0===t)return e;for(s=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=s;return e}class N{constructor(e,t){this.observer=e,this.remuxer=t}resetTimeStamp(e){this.initPTS=e}resetInitSegment(e,t,r,n){if(e&&e.byteLength){const i=this.initData=N.parseInitSegment(e);null==t&&(t="mp4a.40.5"),null==r&&(r="avc1.42e01e");const a={};i.audio&&i.video?a.audiovideo={container:"video/mp4",codec:t+","+r,initSegment:n?e:null}:(i.audio&&(a.audio={container:"audio/mp4",codec:t,initSegment:n?e:null}),i.video&&(a.video={container:"video/mp4",codec:r,initSegment:n?e:null})),this.observer.trigger(s.FRAG_PARSING_INIT_SEGMENT,{tracks:a})}else t&&(this.audioCodec=t),r&&(this.videoCodec=r)}static probe(e){return N.findBox({data:e,start:0,end:Math.min(e.length,16384)},["moof"]).length>0}static bin2str(e){return String.fromCharCode.apply(null,e)}static readUint16(e,t){e.data&&(t+=e.start,e=e.data);const s=e[t]<<8|e[t+1];return s<0?65536+s:s}static readUint32(e,t){e.data&&(t+=e.start,e=e.data);const s=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3];return s<0?4294967296+s:s}static writeUint32(e,t,s){e.data&&(t+=e.start,e=e.data),e[t]=s>>24,e[t+1]=s>>16&255,e[t+2]=s>>8&255,e[t+3]=255&s}static findBox(e,t){let s,r,n,i,a,o,l,d=[];if(e.data?(o=e.start,i=e.end,e=e.data):(o=0,i=e.byteLength),!t.length)return null;for(s=o;s<i;)r=N.readUint32(e,s),n=N.bin2str(e.subarray(s+4,s+8)),l=r>1?s+r:i,n===t[0]&&(1===t.length?d.push({data:e,start:s+8,end:l}):(a=N.findBox({data:e,start:s+8,end:l},t.slice(1)),a.length&&(d=d.concat(a)))),s=l;return d}static parseSegmentIndex(e){const t=N.findBox(e,["moov"])[0],s=t?t.end:null;let r,n=0,i=N.findBox(e,["sidx"]);if(!i||!i[0])return null;r=[],i=i[0];const a=i.data[0];n=0===a?8:16;const o=N.readUint32(i,n);n+=4,n+=0===a?8:16,n+=2;let l=i.end+0;const d=N.readUint16(i,n);n+=2;for(let e=0;e<d;e++){let e=n;const t=N.readUint32(i,e);e+=4;const s=2147483647&t;if(1==(2147483648&t)>>>31)return void console.warn("SIDX has hierarchical references (not supported)");const a=N.readUint32(i,e);e+=4,r.push({referenceSize:s,subsegmentDuration:a,info:{duration:a/o,start:l,end:l+s-1}}),l+=s,e+=4,n=e}return{earliestPresentationTime:0,timescale:o,version:a,referencesCount:d,references:r,moovEndOffset:s}}static parseInitSegment(e){let s=[];return N.findBox(e,["moov","trak"]).forEach((e=>{const r=N.findBox(e,["tkhd"])[0];if(r){let n=r.data[r.start],i=0===n?12:20,a=N.readUint32(r,i);const o=N.findBox(e,["mdia","mdhd"])[0];if(o){n=o.data[o.start],i=0===n?12:20;const r=N.readUint32(o,i),l=N.findBox(e,["mdia","hdlr"])[0];if(l){let n={soun:"audio",vide:"video"}[N.bin2str(l.data.subarray(l.start+8,l.start+12))];if(n){let i=N.findBox(e,["mdia","minf","stbl","stsd"]);if(i.length){i=i[0];let e=N.bin2str(i.data.subarray(i.start+12,i.start+16));t.log(`MP4Demuxer:${n}:${e} found`)}s[a]={timescale:r,type:n},s[n]={timescale:r,id:a}}}}}})),s}static getStartDTS(e,t){let s,r,n;return s=N.findBox(t,["moof","traf"]),r=[].concat.apply([],s.map((function(t){return N.findBox(t,["tfhd"]).map((function(s){let r,n,i;return r=N.readUint32(s,4),n=e[r].timescale||9e4,i=N.findBox(t,["tfdt"]).map((function(e){let t,s;return t=e.data[e.start],s=N.readUint32(e,4),1===t&&(s*=Math.pow(2,32),s+=N.readUint32(e,8)),s}))[0],i/n}))}))),n=Math.min.apply(null,r),isFinite(n)?n:0}static offsetStartDTS(e,t,s){N.findBox(t,["moof","traf"]).map((function(t){return N.findBox(t,["tfhd"]).map((function(r){let n=N.readUint32(r,4),i=e[n].timescale||9e4;N.findBox(t,["tfdt"]).map((function(e){let t=e.data[e.start],r=N.readUint32(e,4);if(0===t)N.writeUint32(e,4,r-s*i);else{r*=Math.pow(2,32),r+=N.readUint32(e,8),r-=s*i,r=Math.max(r,0);const t=Math.floor(r/(M+1)),n=Math.floor(r%(M+1));N.writeUint32(e,4,t),N.writeUint32(e,8,n)}}))}))}))}append(e,t,r,n){let i=this.initData;i||(this.resetInitSegment(e,this.audioCodec,this.videoCodec,!1),i=this.initData);let a,o=this.initPTS;if(void 0===o){let r=N.getStartDTS(i,e);this.initPTS=o=r-t,this.observer.trigger(s.INIT_PTS_FOUND,{initPTS:o})}N.offsetStartDTS(i,e,o),a=N.getStartDTS(i,e),this.remuxer.remux(i.audio,i.video,null,null,a,r,n,e)}destroy(){}}class z{static isHeader(e,t){return t+10<=e.length&&73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}static isFooter(e,t){return t+10<=e.length&&51===e[t]&&68===e[t+1]&&73===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}static getID3Data(e,t){const s=t;let r=0;for(;z.isHeader(e,t);)r+=10,r+=z._readSize(e,t+6),z.isFooter(e,t+10)&&(r+=10),t+=r;if(r>0)return e.subarray(s,s+r)}static _readSize(e,t){let s=0;return s=(127&e[t])<<21,s|=(127&e[t+1])<<14,s|=(127&e[t+2])<<7,s|=127&e[t+3],s}static getTimeStamp(e){const t=z.getID3Frames(e);for(let e=0;e<t.length;e++){const s=t[e];if(z.isTimeStampFrame(s))return z._readTimeStamp(s)}}static isTimeStampFrame(e){return e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info}static _getFrameData(e){const t=String.fromCharCode(e[0],e[1],e[2],e[3]),s=z._readSize(e,4);return{type:t,size:s,data:e.subarray(10,10+s)}}static getID3Frames(e){let t=0;const s=[];for(;z.isHeader(e,t);){const r=z._readSize(e,t+6);t+=10;const n=t+r;for(;t+8<n;){const r=z._getFrameData(e.subarray(t)),n=z._decodeFrame(r);n&&s.push(n),t+=r.size+10}z.isFooter(e,t)&&(t+=10)}return s}static _decodeFrame(e){return"PRIV"===e.type?z._decodePrivFrame(e):"T"===e.type[0]?z._decodeTextFrame(e):"W"===e.type[0]?z._decodeURLFrame(e):void 0}static _readTimeStamp(e){if(8===e.data.byteLength){const t=new Uint8Array(e.data),s=1&t[3];let r=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return r/=45,s&&(r+=47721858.84),Math.round(r)}}static _decodePrivFrame(e){if(e.size<2)return;const t=z._utf8ArrayToStr(e.data,!0),s=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:s.buffer}}static _decodeTextFrame(e){if(!(e.size<2)){if("TXXX"===e.type){let t=1;const s=z._utf8ArrayToStr(e.data.subarray(t),!0);t+=s.length+1;const r=z._utf8ArrayToStr(e.data.subarray(t));return{key:e.type,info:s,data:r}}{const t=z._utf8ArrayToStr(e.data.subarray(1));return{key:e.type,data:t}}}}static _decodeURLFrame(e){if("WXXX"===e.type){if(e.size<2)return;let t=1;const s=z._utf8ArrayToStr(e.data.subarray(t),!0);t+=s.length+1;const r=z._utf8ArrayToStr(e.data.subarray(t));return{key:e.type,info:s,data:r}}{const t=z._utf8ArrayToStr(e.data);return{key:e.type,data:t}}}static _utf8ArrayToStr(e,t=!1){const s=G();if(s){const r=s.decode(e);if(t){const e=r.indexOf("\0");return-1!==e?r.substring(0,e):r}return r.replace(/\0/g,"")}const r=e.length;let n,i,a,o="",l=0;for(;l<r;){if(n=e[l++],0===n&&t)return o;if(0!==n&&3!==n)switch(n>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(n);break;case 12:case 13:i=e[l++],o+=String.fromCharCode((31&n)<<6|63&i);break;case 14:i=e[l++],a=e[l++],o+=String.fromCharCode((15&n)<<12|(63&i)<<6|63&a)}}return o}}function G(){const e=h();return U||void 0===e.TextDecoder||(U=new e.TextDecoder("utf-8")),U}const q=z._utf8ArrayToStr;class H{constructor(e){this.endCC=0,this.endSN=0,this.fragments=[],this.initSegment=null,this.live=!0,this.needSidxRanges=!1,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=e,this.version=null}get hasProgramDateTime(){return!(!this.fragments[0]||!Number.isFinite(this.fragments[0].programDateTime))}}var V,j=function(){function e(e,t){this._uri=null,this.method=null,this.key=null,this.iv=null,this.baseuri=e,this.reluri=t}return Object.defineProperty(e.prototype,"uri",{get:function(){return!this._uri&&this.reluri&&(this._uri=URLToolkit.buildAbsoluteURL(this.baseuri,this.reluri,{alwaysNormalize:!0})),this._uri},enumerable:!1,configurable:!0}),e}();!function(e){e.AUDIO="audio",e.VIDEO="video"}(V||(V={}));var $=function(){function e(){var e;this._url=null,this._byteRange=null,this._decryptdata=null,this._elementaryStreams=((e={})[V.AUDIO]=!1,e[V.VIDEO]=!1,e),this.deltaPTS=0,this.rawProgramDateTime=null,this.programDateTime=null,this.title=null,this.tagList=[],this.sn=0,this.urlId=0,this.level=0}return e.prototype.setByteRange=function(e,t){var s=e.split("@",2),r=[];1===s.length?r[0]=t?t.byteRangeEndOffset:0:r[0]=parseInt(s[1]),r[1]=parseInt(s[0])+r[0],this._byteRange=r},Object.defineProperty(e.prototype,"url",{get:function(){return!this._url&&this.relurl&&(this._url=URLToolkit.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url},set:function(e){this._url=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"byteRange",{get:function(){return this._byteRange?this._byteRange:[]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"byteRangeStartOffset",{get:function(){return this.byteRange[0]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"byteRangeEndOffset",{get:function(){return this.byteRange[1]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"decryptdata",{get:function(){if(!this.levelkey&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkey){var e=this.sn;"number"!=typeof e&&(this.levelkey&&"AES-128"===this.levelkey.method&&!this.levelkey.iv&&t.warn('missing IV for initialization segment with method="'+this.levelkey.method+'" - compliance issue'),e=0),this._decryptdata=this.setDecryptDataFromLevelKey(this.levelkey,e)}return this._decryptdata},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"endProgramDateTime",{get:function(){if(null===this.programDateTime)return null;if(!Number.isFinite(this.programDateTime))return null;var e=Number.isFinite(this.duration)?this.duration:0;return this.programDateTime+1e3*e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"encrypted",{get:function(){return!(!this.decryptdata||null===this.decryptdata.uri||null!==this.decryptdata.key)},enumerable:!1,configurable:!0}),e.prototype.addElementaryStream=function(e){this._elementaryStreams[e]=!0},e.prototype.hasElementaryStream=function(e){return!0===this._elementaryStreams[e]},e.prototype.createInitializationVector=function(e){for(var t=new Uint8Array(16),s=12;s<16;s++)t[s]=e>>8*(15-s)&255;return t},e.prototype.setDecryptDataFromLevelKey=function(e,t){var s=e;return(null==e?void 0:e.method)&&e.uri&&!e.iv&&((s=new j(e.baseuri,e.reluri)).method=e.method,s.iv=this.createInitializationVector(t)),s},e}(),K=/(?:#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)|#EXT-X-SESSION-DATA:([^\n\r]*)[\r\n]+)/g,X=/#EXT-X-MEDIA:(.*)/g,Y=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/|(?!#)([\S+ ?]+)/.source,/|#EXT-X-BYTERANGE:*(.+)/.source,/|#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/|#.*/.source].join(""),"g"),J=/(?:(?:#(EXTM3U))|(?:#EXT-X-(PLAYLIST-TYPE):(.+))|(?:#EXT-X-(MEDIA-SEQUENCE): *(\d+))|(?:#EXT-X-(TARGETDURATION): *(\d+))|(?:#EXT-X-(KEY):(.+))|(?:#EXT-X-(START):(.+))|(?:#EXT-X-(ENDLIST))|(?:#EXT-X-(DISCONTINUITY-SEQ)UENCE:(\d+))|(?:#EXT-X-(DIS)CONTINUITY))|(?:#EXT-X-(VERSION):(\d+))|(?:#EXT-X-(MAP):(.+))|(?:(#)([^:]*):(.*))|(?:(#)(.*))(?:.*)\r?\n?/,W=/\.(mp4|m4s|m4v|m4a)$/i,Q=function(){function e(){}return e.findGroup=function(e,t){for(var s=0;s<e.length;s++){var r=e[s];if(r.id===t)return r}},e.convertAVC1ToAVCOTI=function(e){var t,s=e.split(".");return s.length>2?(t=s.shift()+".",t+=parseInt(s.shift()).toString(16),t+=("000"+parseInt(s.shift()).toString(16)).substr(-4)):t=e,t},e.resolve=function(e,t){return URLToolkit.buildAbsoluteURL(t,e,{alwaysNormalize:!0})},e.parseMasterPlaylist=function(t,s){var r,n=[],i={},a=!1;function o(e,t){["video","audio"].forEach((function(s){var r=e.filter((function(e){return function(e,t){var s=u[t];return!!s&&!0===s[e.slice(0,4)]}(e,s)}));if(r.length){var n=r.filter((function(e){return 0===e.lastIndexOf("avc1",0)||0===e.lastIndexOf("mp4a",0)}));t[s+"Codec"]=n.length>0?n[0]:r[0],e=e.filter((function(e){return-1===r.indexOf(e)}))}})),t.unknownCodecs=e}for(K.lastIndex=0;null!=(r=K.exec(t));)if(r[1]){var l={},d=l.attrs=new c(r[1]);l.url=e.resolve(r[2],s);var h=d.decimalResolution("RESOLUTION");h&&(l.width=h.width,l.height=h.height),l.bitrate=d.decimalInteger("AVERAGE-BANDWIDTH")||d.decimalInteger("BANDWIDTH"),l.name=d.NAME,o([].concat((d.CODECS||"").split(/[ ,]+/)),l),l.videoCodec&&-1!==l.videoCodec.indexOf("avc1")&&(l.videoCodec=e.convertAVC1ToAVCOTI(l.videoCodec)),n.push(l)}else if(r[3]){var m=new c(r[3]);m["DATA-ID"]&&(a=!0,i[m["DATA-ID"]]=m)}return{levels:n,sessionData:a?i:null}},e.parseMasterPlaylistMedia=function(t,s,r,n){var i;void 0===n&&(n=[]);var a=[],o=0;for(X.lastIndex=0;null!==(i=X.exec(t));){var l=new c(i[1]);if(l.TYPE===r){var d={attrs:l,id:o++,groupId:l["GROUP-ID"],instreamId:l["INSTREAM-ID"],name:l.NAME||l.LANGUAGE,type:r,default:"YES"===l.DEFAULT,autoselect:"YES"===l.AUTOSELECT,forced:"YES"===l.FORCED,lang:l.LANGUAGE};if(l.URI&&(d.url=e.resolve(l.URI,s)),n.length){var u=e.findGroup(n,d.groupId);d.audioCodec=u?u.codec:n[0].codec}a.push(d)}}return a},e.parseLevelPlaylist=function(e,s,r,n,i){var a,o,l,d=0,u=0,h=new H(s),m=0,f=null,p=new $,g=null;for(Y.lastIndex=0;null!==(a=Y.exec(e));){var y=a[1];if(y){p.duration=parseFloat(y);var b=(" "+a[2]).slice(1);p.title=b||null,p.tagList.push(b?["INF",y,b]:["INF",y])}else if(a[3]){if(Number.isFinite(p.duration)){var v=d++;p.type=n,p.start=u,l&&(p.levelkey=l),p.sn=v,p.level=r,p.cc=m,p.urlId=i,p.baseurl=s,p.relurl=(" "+a[3]).slice(1),Z(p,f),h.fragments.push(p),f=p,u+=p.duration,p=new $}}else if(a[4]){var _=(" "+a[4]).slice(1);f?p.setByteRange(_,f):p.setByteRange(_)}else if(a[5])p.rawProgramDateTime=(" "+a[5]).slice(1),p.tagList.push(["PROGRAM-DATE-TIME",p.rawProgramDateTime]),null===g&&(g=h.fragments.length);else{if(!(a=a[0].match(J))){t.warn("No matches on slow regex match for level playlist!");continue}for(o=1;o<a.length&&void 0===a[o];o++);var S=(" "+a[o+1]).slice(1),T=(" "+a[o+2]).slice(1);switch(a[o]){case"#":p.tagList.push(T?[S,T]:[S]);break;case"PLAYLIST-TYPE":h.type=S.toUpperCase();break;case"MEDIA-SEQUENCE":d=h.startSN=parseInt(S);break;case"TARGETDURATION":h.targetduration=parseFloat(S);break;case"VERSION":h.version=parseInt(S);break;case"EXTM3U":break;case"ENDLIST":h.live=!1;break;case"DIS":m++,p.tagList.push(["DIS"]);break;case"DISCONTINUITY-SEQ":m=parseInt(S);break;case"KEY":var A=new c(S),w=A.enumeratedString("METHOD"),k=A.URI,D=A.hexadecimalInteger("IV");if("com.apple.streamingkeydelivery"===(A.KEYFORMAT||"identity")){t.warn("Keyformat com.apple.streamingkeydelivery is not supported");continue}w&&(l=new j(s,k),k&&["AES-128","SAMPLE-AES","SAMPLE-AES-CENC"].indexOf(w)>=0&&(l.method=w,l.key=null,l.iv=D));break;case"START":var E=new c(S).decimalFloatingPoint("TIME-OFFSET");Number.isFinite(E)&&(h.startTimeOffset=E);break;case"MAP":var x=new c(S);p.relurl=x.URI,x.BYTERANGE&&p.setByteRange(x.BYTERANGE),p.baseurl=s,p.level=r,p.type=n,p.sn="initSegment",h.initSegment=p,(p=new $).rawProgramDateTime=h.initSegment.rawProgramDateTime;break;default:t.warn("line parsed but not handled: "+a)}}}return(p=f)&&!p.relurl&&(h.fragments.pop(),u-=p.duration),h.totalduration=u,h.averagetargetduration=u/h.fragments.length,h.endSN=d-1,h.startCC=h.fragments[0]?h.fragments[0].cc:0,h.endCC=m,!h.initSegment&&h.fragments.length&&h.fragments.every((function(e){return W.test(e.relurl)}))&&(t.warn("MP4 fragments found but no init segment (probably no MAP, incomplete M3U8), trying to fetch SIDX"),(p=new $).relurl=h.fragments[0].relurl,p.baseurl=s,p.level=r,p.type=n,p.sn="initSegment",h.initSegment=p,h.needSidxRanges=!0),g&&function(e,t){for(var s=e[t],r=t-1;r>=0;r--){var n=e[r];n.programDateTime=s.programDateTime-1e3*n.duration,s=n}}(h.fragments,g),h},e}();function Z(e,t){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):(null==t?void 0:t.programDateTime)&&(e.programDateTime=t.endProgramDateTime),Number.isFinite(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}Object.assign(e,{HlsEvents:s,Fragment:$,LevelKey:j,isCodecSupportedInMp4:function(e,t){return MediaSource.isTypeSupported((t||"video")+'/mp4;codecs="'+e+'"')},MpegAudio:S,M3U8Parser:Q,AESDecryptor:k,TSDemuxer:I,MP4Demuxer:N,AACDemuxer:class{constructor(e,t,s){this.observer=e,this.config=s,this.remuxer=t}resetInitSegment(e,t,s,r){this._audioTrack={container:"audio/adts",type:"audio",id:0,sequenceNumber:0,isAAC:!0,samples:[],len:0,manifestCodec:t,duration:r,inputTimeScale:9e4}}resetTimeStamp(){}static probe(e){if(!e)return!1;let s=(z.getID3Data(e,0)||[]).length;for(let r=e.length;s<r;s++)if(_.probe(e,s))return t.log("ADTS sync word found !"),!0;return!1}append(e,s,r,n){let i=this._audioTrack,a=z.getID3Data(e,0)||[],o=z.getTimeStamp(a),l=Number.isFinite(o)?90*o:9e4*s,d=0,c=l,u=e.length,h=a.length,m=[{pts:c,dts:c,data:a}];for(;h<u-1;)if(_.isHeader(e,h)&&h+5<u){_.initTrackConfig(i,this.observer,e,h,i.manifestCodec);let s=_.appendFrame(i,e,h,l,d);if(!s){t.log("Unable to parse AAC frame");break}h+=s.length,c=s.sample.pts,d++}else z.isHeader(e,h)?(a=z.getID3Data(e,h),m.push({pts:c,dts:c,data:a}),h+=a.length):h++;this.remuxer.remux(i,{samples:[]},{samples:m,inputTimeScale:9e4},{samples:[]},s,r,n)}destroy(){}},MP3Demuxer:class{constructor(e,t,s){this.observer=e,this.config=s,this.remuxer=t}resetInitSegment(e,t,s,r){this._audioTrack={container:"audio/mpeg",type:"audio",id:-1,sequenceNumber:0,isAAC:!1,samples:[],len:0,manifestCodec:t,duration:r,inputTimeScale:9e4}}resetTimeStamp(){}static probe(e){let s,r,n=z.getID3Data(e,0)||[];if(n&&void 0!==(z.getTimeStamp(n)||0))for(s=n.length,r=Math.min(e.length-1,s+100);s<r;s++)if(S.probe(e,s))return t.log("MPEG Audio sync word found !"),!0;return!1}append(e,t,s,r){let n=z.getID3Data(e,0)||[],i=z.getTimeStamp(n)||0,a=void 0!==i?90*i:9e4*t,o=n.length,l=e.length,d=0,c=0,u=this._audioTrack,h=[{pts:a,dts:a,data:n}];for(;o<l;)if(S.isHeader(e,o)){let t=S.appendFrame(u,e,o,a,d);if(!t)break;o+=t.length,c=t.sample.pts,d++}else z.isHeader(e,o)?(n=z.getID3Data(e,o),h.push({pts:c,dts:c,data:n}),o+=n.length):o++;this.remuxer.remux(u,{samples:[]},{samples:h,inputTimeScale:9e4},{samples:[]},t,s,r)}destroy(){}},MP4Remuxer:class{constructor(e,t,s,r){if(this.observer=e,this.config=t,this.typeSupported=s,this.ISGenerated=!1,null===B){const e="Android".match(/Chrome\/(\d+)/i);B=e?parseInt(e[1]):0}}destroy(){}resetTimeStamp(e){this._initPTS=this._initDTS=e}resetInitSegment(){this.ISGenerated=!1}getVideoStartPts(e){let s=!1;const r=e.reduce(((e,t)=>{const r=t.pts-e;return r<-4294967296?(s=!0,e):r>0?e:t.pts}),e[0].pts);return s&&t.debug("PTS rollover detected"),r}remux(e,r,n,i,a,o,l){if(this.ISGenerated||this.generateIS(e,r,a),this.ISGenerated){const s=e.samples.length,n=r.samples.length;let i=a,d=a;if(s&&n){const t=this.getVideoStartPts(r.samples),s=(e.samples[0].pts-t)/r.inputTimeScale;i+=Math.max(0,s),d+=Math.max(0,-s)}if(s){e.timescale||(t.warn("regenerate InitSegment as audio detected"),this.generateIS(e,r,a));let s=this.remuxAudio(e,i,o,l,d);if(n){let n;s&&(n=s.endPTS-s.startPTS),r.timescale||(t.warn("regenerate InitSegment as video detected"),this.generateIS(e,r,a)),this.remuxVideo(r,d,o,n)}}else if(n){let t=this.remuxVideo(r,d,o,0);t&&e.codec&&this.remuxEmptyAudio(e,i,o,t)}}n.samples.length&&this.remuxID3(n,a),i.samples.length&&this.remuxText(i,a),this.observer.trigger(s.FRAG_PARSED)}generateIS(e,i,a){let o,l,d=this.observer,c=e.samples,u=i.samples,h=this.typeSupported,m="audio/mp4",f={},p={tracks:f},g=void 0===this._initPTS;if(g&&(o=l=1/0),e.config&&c.length&&(e.timescale=e.samplerate,t.log(`audio sampling rate : ${e.samplerate}`),e.isAAC||(h.mpeg?(m="audio/mpeg",e.codec=""):h.mp3&&(e.codec="mp3")),f.audio={container:m,codec:e.codec,initSegment:!e.isAAC&&h.mpeg?new Uint8Array:C.initSegment([e]),metadata:{channelCount:e.channelCount}},g&&(o=l=c[0].pts-Math.round(e.inputTimeScale*a))),i.sps&&i.pps&&u.length){const e=i.inputTimeScale;if(i.timescale=e,f.video={container:"video/mp4",codec:i.codec,initSegment:C.initSegment([i]),metadata:{width:i.width,height:i.height}},g){const t=this.getVideoStartPts(u),r=Math.round(e*a);l=Math.min(l,u[0].dts-r),o=Math.min(o,t-r),this.observer.trigger(s.INIT_PTS_FOUND,{initPTS:o})}}else g&&f.audio&&this.observer.trigger(s.INIT_PTS_FOUND,{initPTS:o});Object.keys(f).length?(d.trigger(s.FRAG_PARSING_INIT_SEGMENT,p),this.ISGenerated=!0,g&&(this._initPTS=o,this._initDTS=l)):d.trigger(s.ERROR,{type:r.MEDIA_ERROR,details:n.FRAG_PARSING_ERROR,fatal:!1,reason:"no audio/video samples found"})}remuxVideo(e,i,o,l){const d=e.timescale,c=e.samples,u=[],h=c.length,m=this._initPTS;let f,p,g,y,b,v=8,_=Number.POSITIVE_INFINITY,S=Number.NEGATIVE_INFINITY,T=0,A=!1,w=this.nextAvcDts;if(0===h)return;o||(w=i*d-(c[0].pts-F(c[0].dts,c[0].pts)));for(let e=0;e<h;e++){const t=c[e];t.pts=F(t.pts-m,w),t.dts=F(t.dts-m,w),t.dts>t.pts&&(T=Math.max(Math.min(T,t.pts-t.dts),-1*P)),t.dts<c[e>0?e-1:e].dts&&(A=!0)}A&&c.sort((function(e,t){const s=e.dts-t.dts,r=e.pts-t.pts;return s||r||e.id-t.id})),y=c[0].dts,b=c[h-1].dts;const k=Math.round((b-y)/(h-1));if(T<0){if(T<-2*k){t.warn(`PTS < DTS detected in video samples, offsetting DTS to PTS ${a(-k,!0)} ms`);for(let e=0;e<h;e++)c[e].dts=c[e].pts-k}else{t.warn(`PTS < DTS detected in video samples, shifting DTS by ${a(T,!0)} ms to overcome this issue`);for(let e=0;e<h;e++)c[e].dts=c[e].dts+T}y=c[0].dts,b=c[h-1].dts}if(o){const e=y-w,s=e>k;if(s||e<-1){t.warn(s?`AVC: ${a(e,!0)} ms (${e}dts) hole between fragments detected, filling it`:`AVC: ${a(-e,!0)} ms (${e}dts) overlapping between fragments detected`),y=w;const r=c[0].pts-e;c[0].dts=y,c[0].pts=r,t.log(`Video: First PTS/DTS adjusted: ${a(r,!0)}/${a(y,!0)}, delta: ${a(e,!0)} ms`)}}B&&B<75&&(y=Math.max(0,y));let D=0,E=0;for(let e=0;e<h;e++){const t=c[e],s=t.units,r=s.length;let n=0;for(let e=0;e<r;e++)n+=s[e].data.length;E+=n,D+=r,t.length=n,t.dts=Math.max(t.dts,y),t.pts=Math.max(t.pts,t.dts,0),_=Math.min(t.pts,_),S=Math.max(t.pts,S)}b=c[h-1].dts;let x=E+4*D+8;try{p=new Uint8Array(x)}catch(e){return void this.observer.trigger(s.ERROR,{type:r.MUX_ERROR,details:n.REMUX_ALLOC_ERROR,fatal:!1,bytes:x,reason:`fail allocating video mdat ${x}`})}let L=new DataView(p.buffer);L.setUint32(0,x),p.set(C.types.mdat,4);for(let e=0;e<h;e++){const s=c[e],r=s.units;let n,i=0;for(let e=0,t=r.length;e<t;e++){const t=r[e],s=t.data,n=t.data.byteLength;L.setUint32(v,n),v+=4,p.set(s,v),v+=n,i+=4+n}if(e<h-1)f=c[e+1].dts-s.dts;else{const r=this.config,n=s.dts-c[e>0?e-1:e].dts;if(r.stretchShortVideoTrack){const e=r.maxBufferHole,i=Math.floor(e*d),o=(l?_+l*d:this.nextAudioPts)-s.pts;o>i?(f=o-n,f<0&&(f=n),t.log(`It is approximately ${a(o,!1)} ms to the next segment; using duration ${a(f,!1)} ms for the last video frame.`)):f=n}else f=n}n=Math.round(s.pts-s.dts),u.push({size:i,duration:f,cts:n,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:s.key?2:1,isNonSync:s.key?0:1}})}this.nextAvcDts=b+f;const I=e.dropped;if(e.nbNalu=0,e.dropped=0,u.length&&"Android".toLowerCase().indexOf("chrome")>-1){const e=u[0].flags;e.dependsOn=2,e.isNonSync=0}e.samples=u,g=C.moof(e.sequenceNumber++,y,e),e.samples=[];const R={data1:g,data2:p,startPTS:_/d,endPTS:(S+f)/d,startDTS:y/d,endDTS:this.nextAvcDts/d,type:"video",hasAudio:!1,hasVideo:!0,nb:u.length,dropped:I};return this.observer.trigger(s.FRAG_PARSING_DATA,R),R}remuxAudio(e,i,o,l,d){const c=e.inputTimeScale,u=e.timescale,h=c/u,m=(e.isAAC?1024:1152)*h,f=this._initPTS,p=!e.isAAC&&this.typeSupported.mpeg;let g,y,b,v,_,S,T=p?0:8,A=e.samples,w=[],k=this.nextAudioPts;if(o|=A.length&&k&&(l&&Math.abs(i-k/c)<.1||Math.abs(A[0].pts-k-f)<20*m),A.forEach((function(e){e.pts=e.dts=F(e.pts-f,i*c)})),A=A.filter((e=>e.pts>=0)),0===A.length)return;if(o||(k=0===d?0:l?Math.max(0,i*c):A[0].pts),e.isAAC){const s=this.config.maxAudioFramesDrift;for(let r=0,n=k;r<A.length;){const i=A[r];let l=i.pts,d=l-n;if(d<=-s*m)o||r>0?(t.warn(`Dropping 1 audio frame @ ${a(n,!0)/1e3}s due to ${a(d,!0)} ms overlap.`),A.splice(r,1)):(t.warn(`Audio frame @ ${a(l,!0)/1e3}s overlaps nextAudioPts by ${a(d,!0)} ms.`),n=l+m,r++);else if(d>=s*m&&d<O){const s=Math.floor(d/m);n=l-s*m,t.warn(`Injecting ${s} audio frames @ ${a(n,!0)/1e3}s due to ${a(d,!0)} ms gap.`);for(let a=0;a<s;a++){let s=Math.max(n,0);y=R.getSilentFrame(e.manifestCodec||e.codec,e.channelCount),y||(t.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),y=i.unit.subarray()),A.splice(r,0,{unit:y,pts:s,dts:s}),n+=m,r++}i.pts=i.dts=n,n+=m,r++}else Math.abs(d),i.pts=i.dts=n,n+=m,r++}}let D=A.length,E=0;for(;D--;)E+=A[D].unit.byteLength;for(let i=0,l=A.length;i<l;i++){let l=A[i],d=l.unit,c=l.pts;if(void 0!==S&&g)g.duration=Math.round((c-S)/h);else{let i=c-k,l=0;if(o&&e.isAAC&&i){if(i>0&&i<O)l=Math.round((c-k)/m),t.log(`${a(i,!0)} ms hole between AAC samples detected,filling it`),l>0&&(y=R.getSilentFrame(e.manifestCodec||e.codec,e.channelCount),y||(y=d.subarray()),E+=l*y.length);else if(i<-12){t.log(`drop overlapping AAC sample, expected/parsed/delta: ${a(k,!0)} ms / ${a(c,!0)} ms / ${a(-i,!0)} ms`),E-=d.byteLength;continue}c=k}if(_=c,!(E>0))return;E+=T;try{b=new Uint8Array(E)}catch(e){return void this.observer.trigger(s.ERROR,{type:r.MUX_ERROR,details:n.REMUX_ALLOC_ERROR,fatal:!1,bytes:E,reason:`fail allocating audio mdat ${E}`})}p||(new DataView(b.buffer).setUint32(0,E),b.set(C.types.mdat,4));for(let s=0;s<l;s++)y=R.getSilentFrame(e.manifestCodec||e.codec,e.channelCount),y||(t.log("Unable to get silent frame for given audio codec; duplicating this frame instead."),y=d.subarray()),b.set(y,T),T+=y.byteLength,g={size:y.byteLength,cts:0,duration:1024,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},w.push(g)}b.set(d,T);let u=d.byteLength;T+=u,g={size:u,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},w.push(g),S=c}let x=0;if(D=w.length,D>=2&&(x=w[D-2].duration,g.duration=x),D){this.nextAudioPts=k=S+h*x,e.samples=w,v=p?new Uint8Array:C.moof(e.sequenceNumber++,_/h,e),e.samples=[];const t=_/c,r=k/c,n={data1:v,data2:b,startPTS:t,endPTS:r,startDTS:t,endDTS:r,type:"audio",hasAudio:!0,hasVideo:!1,nb:D};return this.observer.trigger(s.FRAG_PARSING_DATA,n),n}return null}remuxEmptyAudio(e,s,r,n){let i=e.inputTimeScale,a=i/(e.samplerate?e.samplerate:i),o=this.nextAudioPts,l=(void 0!==o?o:n.startDTS*i)+this._initDTS,d=n.endDTS*i+this._initDTS,c=1024*a,u=Math.ceil((d-l)/c),h=R.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(t.warn("remux empty Audio"),!h)return void t.trace("Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec!");let m=[];for(let e=0;e<u;e++){let t=l+e*c;m.push({unit:h,pts:t,dts:t})}e.samples=m,this.remuxAudio(e,s,r)}remuxID3(e,t){const r=e.samples.length;if(!r)return;const n=e.inputTimeScale,i=this._initPTS,a=this._initDTS;for(let s=0;s<r;s++){const r=e.samples[s];r.pts=F(r.pts-i,t*n)/n,r.dts=F(r.dts-a,t*n)/n}this.observer.trigger(s.FRAG_PARSING_METADATA,{samples:e.samples}),e.samples=[]}remuxText(e,t){const r=e.samples.length,n=e.inputTimeScale,i=this._initPTS;if(r){for(let s=0;s<r;s++){const r=e.samples[s];r.pts=F(r.pts-i,t*n)/n}e.samples.sort((function(e,t){return e.pts-t.pts})),this.observer.trigger(s.FRAG_PARSING_USERDATA,{samples:e.samples})}e.samples=[]}},PassThroughRemuxer:class{constructor(e){this.observer=e}destroy(){}resetTimeStamp(){}resetInitSegment(){}remux(e,t,r,n,i,a,o,l){let d=this.observer,c="";e&&(c+="audio"),t&&(c+="video"),d.trigger(s.FRAG_PARSING_DATA,{data1:l,startPTS:i,startDTS:i,type:c,hasAudio:!!e,hasVideo:!!t,nb:1,dropped:0}),d.trigger(s.FRAG_PARSED)}}})})(this);const _export_=(()=>{const e=["https://www.hlsloader.com/","https://www.altextension.com/stream/"],t={ar:"ar",am:"am",bg:"bg",bn:"bn",ca:"ca",cs:"cs",da:"da",de:"de",el:"el",en:"en",en_AU:"en",en_GB:"en",en_US:"en",es:"es",es_419:"e4",et:"et",fa:"fa",fi:"fi",fil:"fp",fr:"fr",gu:"gu",he:"he",hi:"hi",hr:"hr",hu:"hu",id:"id",it:"it",ja:"ja",kn:"kn",ko:"ko",lt:"lt",lv:"lv",ml:"ml",mr:"mr",ms:"ms",nl:"nl",no:"no",pl:"pl",pt_BR:"br",pt_PT:"pt",ro:"ro",ru:"ru",sk:"sk",sl:"sl",sr:"sr",sv:"sv",sw:"sw",ta:"ta",te:"te",th:"th",tr:"tr",uk:"uk",vi:"vi",zh_CN:"cn",zh_TW:"tw"},s=["manifest_name","manifest_description","manifest_browser_action","action_button_off","action_button_enable","action_button_enable_weak","action_button_capturing","action_button_loader","subtitle","audio","quality","quality_high","quality_low","quality_custom","title_loading","title_recording","title_completed","warn_chapter_has_changed","warn_chunksize_excess","warn_discontig_fragments_found","error_label","error_403","error_404","error_408","error_fetch","error_try_capture","error_no_audio","error_no_video","error_no_index","error_quality_select","error_no_downloadable","drm_detected","webm_detected","capture_reason_1","capture_reason_2","capture_reason_3","refer_troubleshoot","message_completed","message_cancelled","message_resume","message_failed","message_fatal","message_error_network","disableAdblockMessage"],r="quality_high",n="quality_low",i={content:"#2a9441",border:"#1a8431"},a="#ff3030",o="speed",l="l2b_start_normal",d=e=>"[ "+e.map((e=>{if(e<1)return(""+e).padStart(8," ");const t=(e=""+Math.floor(100*(e+1e-7))).length;return(e.substr(0,t-2)+"."+e.substr(t-2,2)).padStart(8," ")})).join(" ")+" ]",c=navigator.userAgent,u=(c.includes("Firefox"),!c.includes("Edg")&&c.includes("Chrome"),c.includes("Mobi"),c.includes("Chrome")&&Number((c.match(/Chrome\/(\d+)/)||[])[1]||0),/(^[^:]+:\/\/[^\/]+\/)(.*?)([^\/]*$)/),h=e=>{const t=u.exec(e);return{origin:t[1],path:D(t[1]+t[2]),filename:t[3]}},m="message_to_serviceworker",f=["hi","di","hf","df","hk","vd","ot"],p=e=>{const t=typeof e,s=("number"===t?e:"string"===t?e.charCodeAt(0):1234)%64;return"color:#"+((s>>4&3)<<22|(s>>2&3)<<14|(3&s)<<6|1048576).toString(16)},g=(e="",t,s,...r)=>[("number"==typeof e?"tabId ":"")+"%c"+e+"%c ["+t+"]%c "+(s="object"==typeof s?JSON.stringify(s):s||""),p(e),"color:#f60b91","",...r],y=e=>["%c"+e,"color:#ff0000"],b=["B","KB","MB","GB","TB"],v=e=>new Promise(((t,s)=>{setTimeout(t,e)})),_=(e,t)=>{const s=[];return JSON.stringify(e,((e,r)=>{if(t.includes(e))return"#discard";if("_"===e[0])return"#discard";if("object"==typeof r&&null!==r){const e=s.indexOf(r);if(e>=0&&s[e]===r)return"#discard";s.push(r)}return r}))},S=()=>{const e=new Date,t=e=>(""+e).padStart(2,"0");return" "+e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+"_"+t(e.getMinutes())},T=e=>(e.match(/https?:\/\/([^\/]+)/)||[])[1],A=c.includes("Chrome")?chrome:"object"==typeof browser&&browser;if(!A)return;A.runtime.getManifest();const w=e[0],k=(e=>t[e?.replace("-","_")]||"en")(A.i18n.getUILanguage());new URL(w+("en"===k?"":k+"/")+"record.html").origin,new RegExp(e.join("|").replace(/http/g,"^http").replace(/\./g,"\\."));const external_functions={help:()=>{console.log("Commands",["log","reset","show","rules"])},log:()=>{A.storage.local.get(["log"]).then((e=>{let t=e.log;t=!t,A.storage.local.set({log:t}),console.log("Logging",t?"ON":"OFF")}),(e=>{console.log(e)}))},show:()=>{(async()=>{const e=await chrome.storage.local.getBytesInUse()+" / "+chrome.storage.local.QUOTA_BYTES;console.log("local storage   : "+e),console.log(await A.storage.local.get().catch((e=>{console.log(e)}))),console.log("session storage : "+await chrome.storage.session.getBytesInUse()+" / "+chrome.storage.session.QUOTA_BYTES),console.log(await A.storage.session.get().catch((e=>{console.log(e)})))})()},rules:()=>{(async()=>{console.log("sessionrules",await A.declarativeNetRequest.getSessionRules().catch((e=>{console.log(e)})))})()},reset:()=>{A.storage.local.clear().catch((e=>{console.log(e)})),A.storage.session.clear().catch((e=>{console.log(e)}))}};Object.assign({},external_functions);const D=e=>{if(!e)return"";const t=[],s=encodeURI(e).split("/");for(const e of s){if(e.includes("%"))break;t.push(e)}return t.join("/")};A.declarativeNetRequest?.updateSessionRules({removeRuleIds:[2147483647]}).catch(((...e)=>t=>{e.includes("ignorable")||console.log(...e,":",t?.message||"catch unkown")})("updateSessionRules"));const E=["isom","ID32","UITS","ainf","assp","avcn","bidx","bloc","bpcc","buff","bxml","ccid","cdef","cinf","clip","cmap","co64","coin","colr","crgn","crhd","csgp","cslg","cstb","ctab","ctts","cvru","dihd","dinf","dint","dref","dsgd","dstg","edts","elst","emsg","etyp","evti","fdel","feci","fecr","fidx","fiin","fire","fpar","free","frma","frpa","ftyp","gitn","grpi","grpl","hdlr","hmhd","hpix","icnu","idat","ihdr","iinf","iloc","imap","imda","imif","infe","infu","iods","ipco","iphd","ipma","ipmc","ipro","iprp","iref","j2kH","jP  ","jp2c","jp2h","jp2i","kmat","leva","load","loop","lrcu","m7hd","matt","md5i","mdat","mdhd","mdia","mdri","meco","mehd","mere","meta","mfhd","mfra","mfro","minf","mjhd","moof","moov","mstv","mvcg","mvci","mvdr","mvex","mvhd","mvra","nmhd","ochd","odaf","odda","odhd","odhe","odrb","odrm","odtt","ohdr","padb","paen","pclr","pdat","pdin","pfhd","pfil","pitm","ploc","pnot","prft","pseg","pshd","pssh","ptle","res ","resc","resd","rinf","saio","saiz","sbgp","schi","schm","sdep","sdhd","sdtp","sdvp","segr","seii","senc","sgpd","sidx","sinf","skip","smhd","srmb","srmc","srpp","ssix","sstl","stbl","stco","stdp","sthd","stmg","strd","stri","stsc","stsd","stsg","stsh","stss","stsz","stti","stts","styp","stz2","subs","suep","sumi","surl","swtc","tenc","tfad","tfdt","tfhd","tfma","tfra","tibr","tiri","tkhd","traf","trak","tref","trep","trex","trgr","trik","trun","tstb","ttyp","tyco","udta","uinf","ulst","url ","uuid","vmhd","vwdi","xml ","xml ","ades","albm","alou","angl","auth","clfn","clid","clsf","cmid","cmnm","coll","cprt","date","dscp","gnre","hinf","hnti","hpix","kind","kywd","loci","ludt","manu","modl","orie","perf","reel","rtng","scen","shot","slno","strk","thmb","titl","tlou","tsel","urat","yrrc","albm","auth","clsf","clip","cprt","crgn","crgn","ctab","dcfD","elng","imap","kmat","load","matt","pnot","wide","arg","ark","cok","com","cpy","day","dir","ed1","ed2","ed3","ed4","ed5","ed6","ed7","ed8","ed9","fmt","inf","isr","lab","lal","mak","mal","nak","nam","pdk","phg","prd","prf","prk","prl","req","snk","snm","src","swf","swk","swr","wrt","AllF","name","tnam","tagc","LOOP","ptv ","SelO","WLOC"],x={isom:{container:!0},ftyp:{struct:[["majorBrand","text",4],["minorVersion","int",4],["compatibleBrands",["text",4],"end"]]},moov:{container:!0},mvhd:{struct:[["version","int",1],["flags","int",3],["creationTime","int",4,"or",8],["modificationTime","int",4,"or",8],["timeScale","int",4],["duration","int",4,"or",8],["rate","int",4],["volume","int",2],["reserved","skip",10],["matrix",["int",4],9],["preDefined","skip",24],["nextTrackID","int",4]]},mvex:{container:!0},mehd:{struct:[["version","int",1],["flags","int",3],["fragmentDuration","int",4,"or",8]]},trex:{struct:[["version","int",1],["flags","int",3],["trackID","int",4],["sampleDescriptionIndex","int",4],["sampleDuration","int",4],["sampleSize","int",4],["sampleFlags","int",4]]},trep:{struct:[["version","int",1],["flags","int",3],["trackID","int",4]]},iods:{},trak:{container:!0},tkhd:{struct:[["version","int",1],["flags","int",3],["creationTime","int",4,"or",8],["modificationTime","int",4,"or",8],["trackID","int",4],["reserved1","int",4],["duration","int",4,"or",8],["reserved2","skip",8],["layer","int",2],["alternateGroup","int",2],["volume","int",2],["reserved3","int",2],["matrix",["int",4],9],["width","int",4],["height","int",4]]},edts:{container:!0},elst:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["segmentDuration","int",4,"or",8],["mediaTime","int",4,"or",8],["mediaRateInteger","int",2],["mediaRateFraction","int",2]],"entryCount"]]},mdia:{container:!0},mdhd:{struct:[["version","int",1],["flags","int",3],["creationTime","int",4,"or",8],["modificationTime","int",4,"or",8],["timeScale","int",4],["duration","int",4,"or",8],["languageValues","int",2],["QTQuality","int",2]]},hdlr:{struct:[["version","int",1],["flags","int",3],["preDefined","int",4],["handlerType","text",4],["reserved","skip",12],["name","text",0]]},minf:{container:!0},vmhd:{struct:[["version","int",1],["flags","int",3],["graphicsmode","int",2],["opcolorR","int",2],["opcolorG","int",2],["opcolorB","int",2]]},dinf:{container:!0},dref:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entrySize","int",4],["typeText","text",4],["entryVersion","int",1],["entryFlags","int",3]]},stbl:{container:!0},stsd:{},stts:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["sampleCount","int",4],["sampleDuration","int",4]],"entryCount"]]},stss:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["syncSamples",["int",4],"entryCount"]]},stsz:{struct:[["version","int",1],["flags","int",3],["sampleSize","int",4],["sampleCount","int",4],["sampleSizes",["int",4],"sampleCount"]]},stsc:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["firstChunk","int",4],["samplesPerChunk","int",4],["sampleDescriptionIndex","int",4]],"entryCount"]]},stco:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",4],"entryCount"]]},co64:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",8],"entryCount"]]},ctts:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["sampleCount","int",4],["sampleOffset","int",4]],"entryCount"]]},stdp:{},sdtp:{struct:[["version","int",1],["flags","int",3],["sampleDependencies",["int",4],"end"]]},stsh:{},udta:{container:!0},mdat:{},sidx:{struct:[["version","int",1],["flags","int",3],["referenceID","int",4],["timeScale","int",4],["earliestPresentationTime","int",4,"or",8],["firstOffset","int",4,"or",8],["reserved","int",2],["referenceCount","int",2],["references",[["subsegmentSize","int",4],["subsegmentDuration","int",4],["RAPDeltaTime","int",4]],"referenceCount"]]},smhd:{struct:[["version","int",1],["flags","int",3],["balance","int",2],["reserved","int",2]]},moof:{container:!0},mfhd:{struct:[["version","int",1],["flags","int",3],["sequenceNumber","int",4]]},traf:{container:!0},tfhd:{minLength:8,struct:[["version","int",1],["flags","int",3],["trackID","int",4],["baseDataOffset","int",8,"if",1],["sampleDescriptionIndex","int",4,"if",2],["defaultSampleDuration","int",4,"if",8],["defaultSampleSize","int",4,"if",16],["defaultSampleFlags","int",4,"if",32],["emptyDuration","int",4],["iframeSwitching","int",1]]},tfma:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["segmentDuration","int",4,"or",8],["mediaTime","int",4,"or",8],["mediaRateInteger","int",2],["mediaRateFraction","int",2]]},tfdt:{struct:[["version","int",1],["flags","int",3],["baseMediaDecodeTime","int",4,"or",8]]},trun:{struct:[["version","int",1],["flags","int",3],["sampleCount","int",4],["dataOffset","int",4,"if",1],["firstSampleFlags","int",4,"if",4],["samples",[["duration","int",4,"if",256],["size","int",4,"if",512],["flags","int",4,"if",1024],["compositionTimeOffset","int",4,"if",2048]],"sampleCount"]]},mfra:{container:!0},tfra:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",4],"entryCount"]]},mfro:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",4],"entryCount"]]}};class L{constructor(e,t,s){if(!e)throw new Error("usage : new Box( boxInfo , parent , offset ) or new Box( type )");if("string"==typeof e){if(this.property=x[e],!this.property)throw new Error("not supported type : "+e);this.boxInfo={type:e,container:this.property.container}}else{if(!e.type)throw new Error("Need boxInfo.type");this.boxInfo=e,this.property=x[e.type]}this.type=this.boxInfo.type,this.container=this.boxInfo.container||this.property?.container||!1,this.setData(new Uint8Array(0),0),this.offset=null!==s&&s>0?s:0,this.id=null,this.parent=t,this.children=[],this.parent&&this.parent.appendChild(this),this.wholeSize=0}setData(e,t){this.data=e,this.buffer=new I(e),t&&(this.wholeSize=t)}setDataAndSync(e,t){this.setData(e,t),this.sync(1)}size(){return this.container?"isom"===this.type?0:8:this.wholeSize||this.data&&this.data.length}sync(e){const t=this.property&&this.property.struct||this.boxInfo.struct,s=this.property&&this.property.minLength||this.boxInfo.minLength;if(!t)return 0;if(0!==e&&1!==e&&2!==e)return 0;if(0!==e){if(this.buffer.data.length<8)return 0;this.buffer.setPos(8)}return this.recursiveProc({mode:e,struct:t,minLength:s},this,0)+8}calcLength(e,t,s){const r=typeof e;if(t=t>0?t:1,"number"==r)return e;if("string"==r){if("end"==e)return Math.floor((this.size()-this.buffer.getPos())/t);{const t=e.match(/(\w+)([\-\+\*\/\d]*)/);let s=this[t[1]]||0;const r=t[2]&&t[2][0];if(r){const e=Number(t[2].substr(1));"-"===r&&(s-=e),"+"===r&&(s+=e),"*"===r&&(s*=e),"/"===r&&(s/=e)}return s}}return 0}recursiveProc(e,t,s){const{mode:r,struct:n,minLength:i}=e;let a=0;for(let e=0,o=n.length;e<o;e++){const o=n[e][0],l=n[e][1];let d=n[e][2];const c=n[e][3],u=n[e][4];if(null===c||(this.version&&this.version>0&&"or"===c&&(d=u),!this.flags||"if"!==c||this.flags&u)){if(1===r&&!this.buffer.ready())break;if(2===r&&null==t[o])break;if(0===r&&i&&i<=a&&null==t[o])break;if("int"===l)1===d?(1===r?t[o]=this.buffer.read8():2===r&&this.buffer.write8(t[o]),a+=1):2===d?(1===r?t[o]=this.buffer.read16():2===r&&this.buffer.write16(t[o]),a+=2):3===d?(1===r?t[o]=this.buffer.read24():2===r&&this.buffer.write24(t[o]),a+=3):4===d?(1===r?t[o]=this.buffer.read32():2===r&&this.buffer.write32(t[o]),a+=4):8===d&&(1===r?t[o]=this.buffer.read64():2===r&&this.buffer.write64(t[o]),a+=8);else if("skip"===l){const e=this.calcLength(d,1);1===r?(t[o]="("+e+")bytes",this.buffer.skip(e)):2===r&&this.buffer.fill(e,0),a+=e}else if("text"===l){const e=this.calcLength(d,1);e>0?(1===r?t[o]=this.buffer.readText(e):2===r&&this.buffer.writeText(t[o],e),a+=e):(1===r?t[o]=this.buffer.readTextAsNullTermination():2===r&&this.buffer.writeTextAsNullTermination(t[o]),t[o]&&(a+=t[o].length+1))}else if(l instanceof Array&&((1===r||0===r&&null==t[o])&&(t[o]=[]),l.length>0)){const e=l[0]instanceof Array;let n=0;if(e)for(let e=0,t=l[0].length;e<t;e++)n+=l[0][e][2];else n=l[1];const c=0===r?t[o].length:this.calcLength(d,n);for(let n=0;n<c;n++)if(e){const e=1===r?{}:t[o][n];e&&(a+=this.recursiveProc({mode:r,struct:l,minLength:i},e,s+1),1===r&&t[o].push(e))}else a+=this.recursiveProc({mode:r,struct:[[n,l[0],l[1]]],minLength:i},t[o],s+1)}}}return a}hasChild(e){return this.children.indexOf(e)}append(e,t){return this.appendChild(e,t&&this.find(t))}appendChild(e,t){if(e){const s=this.children;if(-1===s.indexOf(e)){if(t){const r=s.indexOf(t);-1!==r?this.children.splice(r+1,0,e):s.push(e)}else s.push(e);let r=this[e.type+"s"];r||(r=[]),r.push(e),this[e.type+"s"]=r,this[e.type]=r[0]}e.parent=this}}remove(e){return this.removeChild(e)}removeChild(e){if(e){const t=this.children.indexOf(e);if(-1!==t){this.children.splice(t,1);const s=this[e.type+"s"];if(s){const t=s.indexOf(e);t>=0&&s.splice(t,1),s.length>0?this[e.type]=s[0]:(delete this[e.type+"s"],delete this[e.type])}else delete this[e.type]}e.parent=null}}find(e){const t=s=>{if(s.type===e)return s;for(let e=0,r=s.children.length;e<r;e++){const r=t(s.children[e]);if(r)return r}return null};return t(this)}findAll(e){const t=(s,r)=>{s.type===e&&r.push(s);for(let e=0,n=s.children.length;e<n;e++)t(s.children[e],r);return r};return t(this,[])}nextSibling(){let e=!1;for(const t of this.parent?.children||[]){if(e)return t;t===this&&(e=!0)}return null}isReady(){return this.container?!this.__SHORTAGE__&&!this.__UNREAD__:!this.__SHORTAGE__}arrange(){const e=t=>{const s=t.sync(0)||t.size();"mdat"!==t.type&&s!==t.data.length&&t.setData(new Uint8Array(s)),t.sync(2);let r=t.offset+s;for(let s=0,n=t.children.length;s<n;s++)t.children[s].offset=r,r+=e(t.children[s]);return t.wholeSize=r-t.offset,t.buffer.setPos(0),t.buffer.write32(t.wholeSize),t.buffer.writeText(t.type,4),t.wholeSize};return e(this)}publish(e,t,s){const r=this.sync(0);r>0&&r>this.data.length&&this.setData(new Uint8Array(r)),this.sync(2);const n=this.size();n>0&&e&&e.writeUint8Array(this.data,0,n),s(null)}publishToFile(e,t,s){const r=this.sync(0);r>0&&r>this.data.length&&this.setData(new Uint8Array(r)),this.sync(2),this.size()>0&&e?e(this.type,((e,t)=>{t||e.write(new Blob([this.data])),s(null)})):s(null)}inspect(){return"Box : '"+this.type+"' [ "+(this.container?"container":"prop")+" ] / "+this.size()}dump(){var e="";for(var t in this)"function"!=typeof this[t]&&(e+=t+":"+this[t]+" , ");return e}static create(e,t,s){const r={};if(r.type=e,r.struct=t||x[e].struct,r.struct||s instanceof Uint8Array){const e=new L(r);if(r.struct){e.setData(new Uint8Array(0));for(let t=0,n=r.struct.length;t<n;t++){const n=r.struct[t][0],i=r.struct[t][1];e[n]=s&&s[n]||(i instanceof Array?[]:"text"===i?"":0)}}else e.setDataAndSync(s);return e}return null}static get ignore(){return{type:1,container:1,data:1,buffer:1,offset:1,id:1,parent:1,children:1,wholeSize:1,boxInfo:1,property:1}}}class I{constructor(e){this.ptr=0,this.data=e}read8(){return this.data[this.ptr++]}read16(){return 256*this.data[this.ptr++]+this.data[this.ptr++]}read24(){return 65536*this.data[this.ptr++]+256*this.data[this.ptr++]+this.data[this.ptr++]}read32(){return 16777216*this.data[this.ptr++]+65536*this.data[this.ptr++]+256*this.data[this.ptr++]+this.data[this.ptr++]}read64(){const e=this.read32();return e>2097151?this.read32()-4294967296:4294967296*e+this.read32()}readText(e){let t="";for(let s=0;s<e;s++){const e=this.data[this.ptr++];t+=String.fromCharCode(e)}return t}readTextAsNullTermination(){const e=this.data.length;let t="";for(;this.ptr<e;){const e=this.data[this.ptr++];if(0===e)break;t+=String.fromCharCode(e)}return t}readUint8Array(e,t,s){for(let r=0;r<s;r++)e[t++]=this.data[this.ptr++]}write8(e){return this.data[this.ptr++]=255&e,this}write16(e){return this.data[this.ptr++]=e>>8&255,this.data[this.ptr++]=255&e,this}write24(e){return this.data[this.ptr++]=e>>16&255,this.data[this.ptr++]=e>>8&255,this.data[this.ptr++]=255&e,this}write32(e){return this.data[this.ptr++]=e>>24&255,this.data[this.ptr++]=e>>16&255,this.data[this.ptr++]=e>>8&255,this.data[this.ptr++]=255&e,this}write64(e){return this.write32(Math.floor(e/4294967296)),this.write32(Math.floor(e%4294967296)),this}writeText(e,t){for(let s=0,r=t=t||e.length;s<r;s++)this.data[this.ptr++]=e.charCodeAt(s);return this}writeTextAsNullTermination(e){return this.writeText(e),this.data[this.ptr++]=0,this}writeUint8Array(e,t,s){if(s<512)for(let r=0;r<s;r++)this.data[this.ptr++]=e[t++];else this.data.set(e.subarray(t,t+s),this.ptr),this.ptr+=s;return this}fill(e,t){t=t||0;for(let s=0;s<e;s++)this.data[this.ptr++]=t;return this}getPos(){return this.ptr}setPos(e){return this.ptr=e,this}skip(e){return this.ptr+=e,this}remain(){return this.data.length-this.ptr}ready(){return this.ptr<this.data.length}copy(e){const t=this.data.subarray(this.ptr,this.ptr+e);return this.ptr+=e,this.ptr<0?new Uint8Array(t):t}toUint8Array(){return this.data}dump(e){const t=this.ptr,s=[];for(let t=0;t<e;t++)t%8==0&&s.push("\n"),s.push(this.read8().toString(16).padStart(2,"0"));console.log(s.join(" ")),this.ptr=t}}class R{constructor(e,t=0){if(this.rootBox=null,e){if("undefined"!=typeof Buffer&&e instanceof Buffer)this.data=new Uint8Array(e.slice(t));else{if(!(e instanceof Uint8Array))throw new Error("Usage : new MP4( Uint8Array , offset=0 ) or new MP4( Buffer )");this.data=e.slice(t)}this.root=this.parse()}else this.data=new Uint8Array(0),this.root=new L("isom")}parse(){const e=new I(this.data),t=(s,r=0)=>{if(e.remain()>=8){const n=e.getPos();let i=s?e.read32():e.data.length;const a=s?e.readText(4):"isom";if("mdat"===a&&1===i&&(i=e.read64()),E.includes(a)){let o="isom"===a?0:8;const l=new L({size:i,type:a},s,n);if(l.container){let e=null;for(;o<i&&(e=t(l,r+1));)o+=e.boxInfo.size,e.__SHORTAGE__&&(l.__SHORTAGE__=e.__SHORTAGE__),e.__UNREAD__&&(l.__UNREAD__=e.__UNREAD__)}return o===i&&(l.container=!0),e.setPos(n),l.container?(l.setData(e.copy(8),i),i>o&&(l.__UNREAD__=i-o),"isom"===a&&o>i&&(l.__SHORTAGE__=o-i)):e.remain()<i?(l.wholeSize=i,l.__SHORTAGE__=i-e.remain()):l.setDataAndSync(e.copy(i),i),e.setPos(n+i),l}}return null};return t()}get root(){return this.rootBox}set root(e){this.rootBox=e}size(){if(!this.root)return 0;const e=t=>{let s,r=t.children.length,n=t.size();for(s=0;s<r;s++)n+=e(t.children[s]);return n};return e(this.root)}tree(e,t,s=30){if(!this.root)return(e||console.log)("no box found");const r="                                  ",n=(i,a)=>{let o=(i.offset+r).substr(0,10)+"| "+r.substr(0,2*a)+"+"+i.type+" / "+i.size()+(i.container?" ( total "+i.wholeSize+" ) ":"")+(i.id?" , ID:"+i.id:"")+(i.__SHORTAGE__?"(-"+i.__SHORTAGE__+")":"");if((e||console.log)(o),t)for(const t in i)if(!("function"==typeof i[t]||i[t]instanceof L||L.ignore[t])){let n=i[t];if(i[t]instanceof Array){if(i[t][0]instanceof L)continue;n=JSON.stringify(i[t].slice(0,s)),i[t].length>s&&(n+=" ...")}o="          | "+r.substr(0,2*a)+"  > "+t+" : "+n,(e||console.log)(o)}for(let e=0,t=i.children.length;e<t;e++)n(i.children[e],a+1)};n(this.root,0)}publish(e,t){if(!this.root)throw new Error("no rootbox found");const s=this.size(),r=new I(new Uint8Array(s)),n=(t,i)=>{let a=t.children.length;t.publish(r,(t=>{e(Math.floor(100*t/s))}),(e=>{const s=e=>{e<a?n(t.children[e],(t=>{s(e+1)})):i(null)};s(0)}))};n(this.root,(e=>{t(e,r.data)}))}async publishAsync(){return new Promise(((e,t)=>{if(!this.root)return t("no rootbox found");const s=this.size(),r=new I(new Uint8Array(s)),n=(e,t)=>{let s=e.children.length;e.publish(r,null,(()=>{const r=i=>{i<s?n(e.children[i],(()=>{r(i+1)})):t()};r(0)}))};n(this.root,(()=>{e(r.data)}))}))}async clone(){const e=await this.publishAsync();return new R(e)}}const M={1:"NID",2:"CDA",3:"CDB",4:"CDC",5:"IDR",6:"SEI",7:"SPS",8:"PPS",9:"AUD",10:"ESQ",11:"EST",12:"FID",13:"SPE",14:"PRF",15:"SSP",19:"ACP",20:"CSE",21:"CDV"};R.Box=L,R.SimpleView=I,R.NAL=class{constructor(e,t){this.ptr=0,this.data=e,this.units=[],this.parse(t)}parse(e=1){let t;const s=new I(this.data);if(s.remain()<8)return this.units.push("ERR","Shortage");const r=s.read32();if("mdat"!==s.readText(4))return this.units.push("ERR","BadSignature");for(1===r&&s.skip(8);s.remain()>5&&this.units.length<e;){const e=s.read32();if(s.remain()<e){t="InvalidSize";break}const r=s.getPos(),n=s.read8(),i=31&n;if(128&n){t="ForbiddenZero";break}const a=M[i];if(!a){t="InvalidType";break}this.units.push(a),s.setPos(r+e)}t&&(this.units=["ERR",t])}};const C=(e,t,s)=>{if(t.includes("mp4a")){const r=t.match(/mp4a\.(\d+)\.(\d+)/);if(r){const t=parseInt(r[1],16);if(parseInt(r[2],10),e&&64===t){const e={decConfigDescr:{objectTypeId:t,decSpecificInfo:{info:{objectType:2}}}},r=F.modifyESDS(s,e);if(r.err)qe&&console.log(...g("process","render","error at modifyESDS"));else if(qe)for(const e of r.logs)console.log(...g("process","render","modifyESDS",e))}}}},O=async(e,t,s)=>{const r=s?._master?._tab?.id;if(qe&&console.log(...g(r,"MP4","start building")),!e||0===e.length)throw new Error("buildMP4 : Video contains no media");let n=0;for(let t=0;t<e.length;t++)e[t].mimetype.includes("video")&&(n=t);2===e.length&&1===n&&(e=[e[1],e[0]],n=0);const i=localStorage?.HLS_BUILDER_ALLOW_FFMPEG,a=localStorage?.HLS_BUILDER_ADD_SDTP,o=localStorage?.HLS_BUILDER_PREFER_MDAT32,l="soun",d="vide",{skipLiveKeyFrame:c,keyFrameComplement:u,modifyESDSTrackConfig:h,over4G:m,over13H:f}=t,p=[];for(let t=0,s=e.length;t<s;t++){const s=e[t];let r=0;for(let e=0,n=s.mdats.length;e<n;e++)void 0!==s.start[e]&&(p.push({track:t,num:e,order:r,start:s.start[e]}),r++)}p.sort(((e,t)=>e.start-t.start));for(const t of e)t.mdats[0]&&9===t.mdats[0].size&&(t.mdats=[]);const y=[],b=[];for(const t of e){let e;e=t.init&&t.init.data&&t.init.data.length>0?t.init.data.length<2e4?new R(t.init.data.slice()):t.init:await t.init.clone(),y.push(e),b.push(e.root)}y.length;for(let t=0,s=b.length;t<s;t++){const s=b[t];s.moov.mvhd.version=s.moov.trak.tkhd.version=s.moov.trak.mdia.mdhd.version=0,s.moov.trak.tkhd.flags=3;const r=t+1;s.moov.trak.tkhd.trackID=s.moov.mvex.trex.trackID=r,s.ftyp&&(i?(s.ftyp.majorBrand="isom",s.ftyp.minorVersion=512,s.ftyp.compatibleBrands=["isom","iso2","avc1","mp41"]):(s.ftyp.majorBrand="mp42",s.ftyp.minorVersion=0,s.ftyp.compatibleBrands=["isom","iso2","avc1","mp41","mp42"])),C(h,e[t].init.id,{root:s})}const _=new R,S=_.root;S.append(b[n].ftyp),S.append(new R.Box("moov")),S.moov.append(b[n].moov.mvhd);for(const e of b)S.moov.append(e.moov.trak);S.moov.mvhd.nextTrackID=y.length+1,S.moov.mvhd.creationTime=S.moov.mvhd.modificationTime=0;for(let e=0,t=y.length;e<t;e++)S.moov.traks[e].tkhd.creationTime=S.moov.traks[e].mdia.mdhd.creationTime=S.moov.traks[e].tkhd.modificationTime=S.moov.traks[e].mdia.mdhd.modificationTime=0;const T=await(async(e,t)=>{const s=[{type:d,length:0,moofs:[],hasBaseMediaDecodeTime:!1},{type:l,length:0,moofs:[],hasBaseMediaDecodeTime:!1}];for(const r of s)for(const s of e)s.mdia.hdlr.handlerType===r.type&&Object.assign(r,{trackID:s.tkhd.trackID,timeScale:s.mdia.mdhd.timeScale,length:t[s.tkhd.trackID-1].moofs.length});const r=Math.max(s[0].length,s[1].length);for(let e=0;e<r;e++)for(let r=0;r<2;r++){const n=s[r],i=t[n.trackID-1]?.moofs[e];if(!i){n.moofs[e]={empty:!0,baseMediaDecodeTime:0,duration:0};continue}const a=(i instanceof R?i:i instanceof L?{root:{moof:i}}:new R(new Uint8Array(await K(i)))).root.moof.traf,o=(a.tfdt.baseMediaDecodeTime<0?0:a.tfdt.baseMediaDecodeTime)/n.timeScale;let l=!1;if(e>0)if(n.moofs[e-1].empty)l=!0;else{const{baseMediaDecodeTime:t,duration:s}=n.moofs[e-1];(o<t||o>t+2*s)&&(l=!0)}let d=0,c=0;for(const e of a.truns||[]){e.samples&&0!==e.samples.length||(e.samples=new Array(e.sampleCount||0).fill({}));const t=e.samples||[];for(const e of t)d+=e.duration||a.tfhd?.defaultSampleDuration||b[r].moov?.mvex?.trex?.sampleDuration||0,33554432&e.flags&&c++}d/=n.timeScale;const u=(a.trun?.samples?.[0]?.compositionTimeOffset||0)/n.timeScale;n.moofs[e]={baseMediaDecodeTime:o,compositionTimeOffset:u,duration:d,keyFrames:c,discontig:l},o>0&&(n.hasBaseMediaDecodeTime=!0)}return s})(S.moov.traks,e),A=(e=>{const t=[[],[]];if(!e[0].length||!e[1].length)return t;if(e[0].length>1&&!e[0].hasBaseMediaDecodeTime||e[1].length>1&&!e[1].hasBaseMediaDecodeTime)return t;const s=[0,0],n=[0,0];e[0].elstPadding=e[1].elstPadding=0;for(let i=0,a=Math.max(e[0].length,e[1].length);i<a;i++){const a=e[0].moofs[i],o=e[1].moofs[i];if(a&&o){if(a.empty&&(a.baseMediaDecodeTime=n[0]-s[0],a.duration=0,e[0].moofs[i+1]&&!e[0].moofs[i+1].empty&&(e[0].moofs[i+1].discontig=!0)),o.empty&&(o.baseMediaDecodeTime=n[1]-s[1],o.duration=0,e[1].moofs[i+1]&&!e[1].moofs[i+1].empty&&(e[1].moofs[i+1].discontig=!0)),0===i){const n=a.baseMediaDecodeTime-o.baseMediaDecodeTime,i=n>0?0:1,l=Math.abs(n);if(qe&&console.log(...g(r,"MP4","buildElst, start : diff="+n+" (video="+a.baseMediaDecodeTime+",audio="+o.baseMediaDecodeTime+")")),l>.01){const s=e[i].moofs?.[0]?.compositionTimeOffset||0;t[i].push({segmentDuration:Math.ceil(1e3*(l+s)),mediaTime:-1,mediaRateInteger:1,mediaRateFraction:0})}e[i].elstPadding=l,s[0]=s[1]=-Math.min(o.baseMediaDecodeTime,a.baseMediaDecodeTime)}else if(a.discontig&&o.discontig){const e=a.baseMediaDecodeTime-o.baseMediaDecodeTime-(n[0]-n[1]);e>=0?(s[0]=n[0]+e-a.baseMediaDecodeTime,s[1]=n[1]-o.baseMediaDecodeTime):(s[0]=n[0]-a.baseMediaDecodeTime,s[1]=n[1]-e-o.baseMediaDecodeTime)}else a.discontig?s[0]=n[0]-a.baseMediaDecodeTime:o.discontig&&(s[1]=n[1]-o.baseMediaDecodeTime);a.baseMediaDecodeTime+=s[0],o.baseMediaDecodeTime+=s[1],n[0]=a.baseMediaDecodeTime+a.duration,n[1]=o.baseMediaDecodeTime+o.duration}}for(let s=0;s<2;s++){const r=e[s],i=Math.ceil(1e3*(n[s]-r.elstPadding))||0,a=r.moofs?.[0]?.compositionTimeOffset||0,o=Math.ceil(a*r.timeScale)||0;t[s].push({segmentDuration:i,mediaTime:o,mediaRateInteger:1,mediaRateFraction:0})}return t})(T);let w=[{},{}];try{localStorage.nosync?qe&&console.log(...g(r,"MP4","ignore durationDebt due to set the localStorage.nosync=true.")):w=await(e=>{const t=[{},{}];if(e[0].length>1&&!e[0].hasBaseMediaDecodeTime||e[1].length>1&&!e[1].hasBaseMediaDecodeTime)return t;let s=[0,0],n=!1;e[0].duration=e[1].duration=0,e[0].original_duration=e[1].original_duration=0;const i=Math.max(e[0].length,e[1].length);for(let a=0;a<i;a++){for(let r=0;r<2;r++){if(e[r].moofs[a].empty)continue;const n=0;if(a<i-2-1){const i=e[r].duration-(e[r].moofs[a].baseMediaDecodeTime-e[r].elstPadding+n);i<-.05?(s[r]++,s[r]>=2&&(t[r][a+1]=Math.ceil(i*e[r].timeScale),e[r].duration-=i,s[r]=0)):s[r]=0}e[r].original_duration+=e[r].moofs[a].duration,e[r].duration+=e[r].moofs[a].duration}if(a===i-2-2){const s=e[0].original_duration-e[1].original_duration;Math.abs(s)<.1&&(n=!0,qe&&(console.log(...g(r,"MP4","durationDebtList : "+JSON.stringify(t))),console.log(...g(r,"MP4","ignore debt due to less difference between video and audio duration, abs("+s+")sec < 0.1sec )"))))}}if(qe){for(let t=0;t<2;t++)e[t].sec=e[t].duration/e[t].timeScale;n||console.log(...g(r,"MP4","durationDebtList : "+JSON.stringify(t)))}return n?[{},{}]:t})(T)}catch(e){console.log(e.stack||e.message||e)}if(qe){console.log("neo-debt-v",JSON.stringify(w[0])),console.log("neo-debt-a",JSON.stringify(w[1]));let e=0;e=0;for(const t in w[0])e+=w[0][t];console.log("neo-debt-v",e),e=0;for(const t in w[1])e+=w[1][t];console.log("neo-debt-a",e)}let k=0;for(const t of S.moov.traks){const s=t.mdia.minf.stbl,n=t.tkhd.trackID,i=t.mdia.hdlr.handlerType,o=i===d;i===l&&(t.tkhd.alternateGroup=1,t.tkhd.volume=256);let{stsz:c,stts:h,stsc:f,stss:p,stco:y,ctts:_,sdtp:S,co64:T}=s;c||s.append(c=R.Box.create("stsz")),h||s.append(h=R.Box.create("stts")),f||s.append(f=R.Box.create("stsc")),o&&(p||s.append(p=R.Box.create("stss"),"stts"),p.syncSamples=[]),!S&&a&&(S=R.Box.create("sdtp")),_||(_=R.Box.create("ctts")),m?(T||s.append(T=R.Box.create("co64")),y&&(s.remove(y),y=null)):(y||s.append(y=R.Box.create("stco")),T&&(s.remove(T),T=null)),c.sampleSizes=[],h.entries=[],f.entries=[],a&&(S.sampleDependencies=[]),_.entries=[];let D=0,E=0,x=0,I=0,M=0,C=-1,O=0,P=0;const U=[];let B=0;for(const t of e[n-1].moofs){if(!t)continue;const s=t instanceof R?t:t instanceof L?{root:{moof:t}}:new R(new Uint8Array(await K(t))),r=s.root.moof;s.root.mdat&&e[n-1].mdats.push(new Blob([s.root.mdat.data]));const m=r.traf,g=m.tfhd,y=b[n-1].moov.mvex&&b[n-1].moov.mvex.trex;E++;let T=0,A=0;P+=w[n-1][E]||0;for(const e of m.truns||[]){e.samples&&0!==e.samples.length||(e.samples=new Array(e.sampleCount||0).fill({}));for(const t of e.samples){const s=Object.assign({},t);if(D++,s.duration=s.duration||g?.defaultSampleDuration||y?.sampleDuration||0,s.size=s.size||g?.defaultSampleSize||y?.sampleSize||0,s.flags=s.flags||g?.defaultSampleFlags||y?.sampleFlags||0,P=Math.ceil(P),0!==P)if(i===d){const e=P>0?Math.min(s.duration-1,P):P;s.duration-=e,P-=e}else i===l&&P<0&&s.duration<-P&&(T++,M++,B+=s.duration,c.sampleSizes.push(0),P+=s.duration);u&&0===A&&U.push(D),A++,(33554432&s.flags)>0&&o&&p.syncSamples.push(D),c.sampleSizes.push(s.size),I!==s.duration&&(M>0&&(h.entries.push({sampleCount:M,sampleDuration:I}),M=0),I=s.duration),M++,B+=s.duration,(2048&e.flags)>0&&(C!==s.compositionTimeOffset&&O>0&&(_.entries.push({sampleCount:O,sampleOffset:C}),O=0),C=s.compositionTimeOffset,O++)}T+=e.sampleCount,m.sdtp&&a&&S.sampleDependencies.push(...m.sdtp.sampleDependencies)}x!==T&&(x=T,f.entries.push({firstChunk:E,samplesPerChunk:x,sampleDescriptionIndex:1})),E%100==0&&await v(1)}h.entries.push({sampleCount:M,sampleDuration:I}),-1!==C&&_.entries.push({sampleCount:O,sampleOffset:C});const F=()=>{const e=[1];let t=0;for(const e of c.sampleSizes)t+=e;const s=t/c.sampleSizes.length;t=0;for(const e of c.sampleSizes){const r=e-s;t+=r*r}const r=Math.sqrt(t/c.sampleSizes.length);for(let t=1,n=c.sampleSizes.length;t<n;t++)(c.sampleSizes[t]-s)/r>3&&e.push(t+1);return e};if(o){if(qe&&console.log(...g(r,"MP4","keyframe length : "+p.syncSamples.length+", chunks : "+E)),p.syncSamples.length<1+Math.ceil(.8*E)){const e=F();qe&&console.log(...g(r,"MP4","length of estimated keyframes : "+e.length)),e.length>p.syncSamples.length?(p.syncSamples=e,qe&&console.log(...g(r,"MP4","use estimated keyframes"))):u&&U.length>p.syncSamples.length&&(p.syncSamples=U,qe&&console.log(...g(r,"MP4","use the firstframe of chunks as keyframes"))),0===p.syncSamples.length&&(p.syncSamples=[1],qe&&console.log(...g(r,"MP4","no keyframes, set stss.syncSamples=[1]")))}p.entryCount=p.syncSamples.length}c.sampleCount=c.sampleSizes.length,h.entryCount=h.entries.length,f.entryCount=f.entries.length,m?(T.entryCount=E,T.chunkOffsets=new Array(E)):(y.entryCount=E,y.chunkOffsets=new Array(E)),_.entries.length&&(_.entryCount=_.entries.length,i===d&&(1===_.entryCount&&0===_.entries[0].sampleOffset||s.append(_))),t.mdia.mdhd.duration=B,t.tkhd.duration=Math.ceil(B/t.mdia.mdhd.timeScale*1e3),t.edts||t.append(new R.Box("edts"),"tkhd"),t.edts.elst||t.edts.append(R.Box.create("elst"));const N=_.entryCount>0?_.entries[0].sampleOffset:0,z=A[n-1]||[];qe&&(console.log("reference",JSON.stringify([{segmentDuration:t.tkhd.duration,mediaTime:N,mediaRateInteger:1,mediaRateFraction:0}])),console.log("neo      ",JSON.stringify(z))),z.length>0?(t.edts.elst.entryCount=z.length,t.edts.elst.entries=z,qe&&console.log("use neo elst !!")):(t.edts.elst.entryCount=1,t.edts.elst.entries=[{segmentDuration:t.tkhd.duration,mediaTime:N,mediaRateInteger:1,mediaRateFraction:0}],qe&&console.log("use reference elst")),a&&S.sampleDependencies.length&&s.append(S),t.mdia.mdhd.duration=B,k=Math.max(B/t.mdia.mdhd.timeScale,k)}const D=Math.ceil(1e3*k);S.moov.mvhd.timeScale=1e3,S.moov.mvhd.duration=D,S.arrange();const E=!m&&o;let x=_.size()+(E?8:16);const I=x;for(const t of p)m?S.moov.traks[t.track].mdia.minf.stbl.co64.chunkOffsets[t.order]=x:S.moov.traks[t.track].mdia.minf.stbl.stco.chunkOffsets[t.order]=x,x+=e[t.track].mdats[t.num].size-8;const M=[new Blob([await _.publishAsync()])],O=[];for(const t of p)O.push(e[t.track].mdats[t.num].slice(8));const P=F.generate_mdat_head(x-I,E);M.push(P),M.push(...O);const U=new Blob(M,{type:"appplication/octet-stream"});return qe&&console.log(...g(r,"MP4","complete building")),U},P=async(e,t,s)=>{const r=s?._master?._tab?.id;if(qe&&console.log(...g(r,"MP4","start building")),!e||0===e.length)throw new Error("buildMP4 : Video contains no media");let n=0;for(let t=0;t<e.length;t++)e[t].mimetype.includes("video")&&(n=t);2===e.length&&1===n&&(e=[e[1],e[0]],n=0);const{skipLiveKeyFrame:i,keyFrameComplement:a,modifyESDSTrackConfig:o,over4G:l,over13H:d}=t,c=[];for(let t=0,s=e.length;t<s;t++){const s=e[t];let r=0;for(let e=0,n=s.mdats.length;e<n;e++)void 0!==s.start[e]&&(c.push({track:t,num:e,order:r,start:s.start[e]}),r++)}c.sort(((e,t)=>e.start-t.start));for(const t of e)t.mdats[0]&&9===t.mdats[0].size&&(t.mdats=[]);const u=[],h=[];for(const t of e){let e;e=t.init&&t.init.data&&t.init.data.length>0?t.init.data.length<2e4?new R(t.init.data.slice()):t.init:await t.init.clone(),u.push(e),h.push(e.root)}u.length;for(let e=0,t=h.length;e<t;e++){const t=h[e];t.moov.mvhd.version=t.moov.trak.tkhd.version=t.moov.trak.mdia.mdhd.version=0,t.moov.trak.tkhd.flags=3;const s=e+1;if(t.moov.trak.tkhd.trackID=t.moov.mvex.trex.trackID=s,t.ftyp&&(t.ftyp.majorBrand="mp42",t.ftyp.minorVersion=0,t.ftyp.compatibleBrands=["isom","iso2","avc1","mp41","mp42"]),o){const e=t.moov.trak.mdia.minf.stbl.stsd,s=new I(e.data);s.skip(12);const r=s.read32();for(let e=0;e<r;e++){const e=s.read32();if("mp4a"===s.readText(4)){s.skip(28);const e=s.getPos(),t=s.read32();if("esds"===s.readText(4)){s.skip(5);const r=s.read8();s.skip(4);const n=s.read8();s.skip(14);const i=s.read8();if(4===i){const a=s.read8(),o=s.read8();s.skip(2);const l=[];for(let e=0,r=t-38;e<r;e++)l.push(s.read8());s.setPos(e),s.write32(t),s.skip(9),s.write8(r-2),s.skip(4),s.write8(n-2),s.skip(14),s.write8(i-2),s.write8(16+(7&a)),s.write8(248&o);for(const e of l)s.write8(e);s.write16(0)}}else s.skip(t-8)}else s.skip(e-8)}}}const m=new R,f=m.root;f.append(h[n].ftyp),f.append(new R.Box("moov")),f.moov.append(h[n].moov.mvhd);for(const e of h)f.moov.append(e.moov.trak);f.moov.mvhd.nextTrackID=u.length+1,f.moov.mvhd.creationTime=f.moov.mvhd.modificationTime=0;for(let e=0,t=u.length;e<t;e++)f.moov.traks[e].tkhd.creationTime=f.moov.traks[e].mdia.mdhd.creationTime=f.moov.traks[e].tkhd.modificationTime=f.moov.traks[e].mdia.mdhd.modificationTime=0;const p=await(async(e,t)=>{const s=[{type:"vide",length:0,moofs:[],hasBaseMediaDecodeTime:!1},{type:"soun",length:0,moofs:[],hasBaseMediaDecodeTime:!1}];for(const r of s)for(const s of e)s.mdia.hdlr.handlerType===r.type&&Object.assign(r,{trackID:s.tkhd.trackID,timeScale:s.mdia.mdhd.timeScale,length:t[s.tkhd.trackID-1].moofs.length});const r=Math.max(s[0].length,s[1].length);for(let e=0;e<r;e++)for(let r=0;r<2;r++){const n=s[r],i=t[n.trackID-1]?.moofs[e];if(!i){n.moofs[e]={empty:!0,baseMediaDecodeTime:0,duration:0};continue}const a=(i instanceof R?i:i instanceof L?{root:{moof:i}}:new R(new Uint8Array(await K(i)))).root.moof.traf,o=(a.tfdt.baseMediaDecodeTime<0?0:a.tfdt.baseMediaDecodeTime)/n.timeScale;let l=!1;if(e>0)if(n.moofs[e-1].empty)l=!0;else{const{baseMediaDecodeTime:t,duration:s}=n.moofs[e-1];(o<t||o>t+2*s)&&(l=!0)}let d=0,c=0;for(const e of a.truns||[]){e.samples&&0!==e.samples.length||(e.samples=new Array(e.sampleCount||0).fill({}));const t=e.samples||[];for(const e of t)d+=e.duration||a.tfhd?.defaultSampleDuration||h[r].moov?.mvex?.trex?.sampleDuration||0,33554432&e.flags&&c++}d/=n.timeScale;const u=(a.trun?.samples?.[0]?.compositionTimeOffset||0)/n.timeScale;n.moofs[e]={baseMediaDecodeTime:o,compositionTimeOffset:u,duration:d,keyFrames:c,discontig:l},o>0&&(n.hasBaseMediaDecodeTime=!0)}return s})(f.moov.traks,e),y=(e=>{const t=[[],[]];if(!e[0].length||!e[1].length)return t;if(e[0].length>1&&!e[0].hasBaseMediaDecodeTime||e[1].length>1&&!e[1].hasBaseMediaDecodeTime)return t;const s=[0,0],n=[0,0];e[0].elstPadding=e[1].elstPadding=0;for(let i=0,a=Math.max(e[0].length,e[1].length);i<a;i++){const a=e[0].moofs[i],o=e[1].moofs[i];if(a&&o){if(a.empty&&(a.baseMediaDecodeTime=n[0]-s[0],a.duration=0,e[0].moofs[i+1]&&!e[0].moofs[i+1].empty&&(e[0].moofs[i+1].discontig=!0)),o.empty&&(o.baseMediaDecodeTime=n[1]-s[1],o.duration=0,e[1].moofs[i+1]&&!e[1].moofs[i+1].empty&&(e[1].moofs[i+1].discontig=!0)),0===i){const n=a.baseMediaDecodeTime-o.baseMediaDecodeTime,i=n>0?0:1,l=Math.abs(n);if(qe&&console.log(...g(r,"MP4","buildElst, start : diff="+n+" (video="+a.baseMediaDecodeTime+",audio="+o.baseMediaDecodeTime+")")),l>.01){const s=e[i].moofs?.[0]?.compositionTimeOffset||0;t[i].push({segmentDuration:Math.floor(1e3*(l+s)),mediaTime:-1,mediaRateInteger:1,mediaRateFraction:0})}e[i].elstPadding=l,s[0]=s[1]=-Math.min(o.baseMediaDecodeTime,a.baseMediaDecodeTime)}else if(a.discontig&&o.discontig){const e=a.baseMediaDecodeTime-o.baseMediaDecodeTime-(n[0]-n[1]);e>=0?(s[0]=n[0]+e-a.baseMediaDecodeTime,s[1]=n[1]-o.baseMediaDecodeTime):(s[0]=n[0]-a.baseMediaDecodeTime,s[1]=n[1]-e-o.baseMediaDecodeTime)}else a.discontig?s[0]=n[0]-a.baseMediaDecodeTime:o.discontig&&(s[1]=n[1]-o.baseMediaDecodeTime);a.baseMediaDecodeTime+=s[0],o.baseMediaDecodeTime+=s[1],n[0]=a.baseMediaDecodeTime+a.duration,n[1]=o.baseMediaDecodeTime+o.duration}}for(let s=0;s<2;s++){const r=e[s],i=Math.floor(1e3*(n[s]-r.elstPadding))||123456789,a=r.moofs?.[0]?.compositionTimeOffset||0,o=Math.floor(a*r.timeScale)||0;t[s].push({segmentDuration:i,mediaTime:o,mediaRateInteger:1,mediaRateFraction:0})}return t})(p);let b=[{},{}];try{localStorage.nosync?qe&&console.log(...g(r,"MP4","ignore durationDebt due to set the localStorage.nosync=true.")):b=await(e=>{const t=[{},{}];if(e[0].length>1&&!e[0].hasBaseMediaDecodeTime||e[1].length>1&&!e[1].hasBaseMediaDecodeTime)return t;let s=[0,0],n=!1;e[0].duration=e[1].duration=0,e[0].original_duration=e[1].original_duration=0;const i=Math.max(e[0].length,e[1].length);for(let a=0;a<i;a++){for(let r=0;r<2;r++){if(e[r].moofs[a].empty)continue;const n=0;if(a<i-2-1){const i=e[r].duration-(e[r].moofs[a].baseMediaDecodeTime-e[r].elstPadding+n);i<-.05?(s[r]++,s[r]>=2&&(t[r][a+1]=Math.floor(i*e[r].timeScale),e[r].duration-=i,s[r]=0)):s[r]=0}e[r].original_duration+=e[r].moofs[a].duration,e[r].duration+=e[r].moofs[a].duration}if(a===i-2-2){const s=e[0].original_duration-e[1].original_duration;Math.abs(s)<.1&&(n=!0,qe&&(console.log(...g(r,"MP4","durationDebtList : "+JSON.stringify(t))),console.log(...g(r,"MP4","ignore debt due to less difference between video and audio duration, abs("+s+")sec < 0.1sec )"))))}}if(qe){for(let t=0;t<2;t++)e[t].sec=e[t].duration/e[t].timeScale;n||console.log(...g(r,"MP4","durationDebtList : "+JSON.stringify(t)))}return n?[{},{}]:t})(p)}catch(e){console.log(e.stack||e.message||e)}if(qe){console.log("neo-debt-v",JSON.stringify(b[0])),console.log("neo-debt-a",JSON.stringify(b[1]));let e=0;e=0;for(const t in b[0])e+=b[0][t];console.log("neo-debt-v",e),e=0;for(const t in b[1])e+=b[1][t];console.log("neo-debt-a",e)}let _=0;for(const t of f.moov.traks){const s=t.mdia.minf.stbl,n=t.tkhd.trackID,i=t.mdia.hdlr.handlerType;"soun"===i&&(t.tkhd.alternateGroup=1,t.tkhd.volume=256);let{stsz:o,stts:d,stsc:c,stss:u,stco:m,ctts:f,sdtp:p,co64:S}=s;o||s.append(o=R.Box.create("stsz")),d||s.append(d=R.Box.create("stts")),c||s.append(c=R.Box.create("stsc")),u||s.append(u=R.Box.create("stss")),p||(p=R.Box.create("sdtp")),f||(f=R.Box.create("ctts")),l?(S||s.append(S=R.Box.create("co64")),m&&(s.remove(m),m=null)):(m||s.append(m=R.Box.create("stco")),S&&(s.remove(S),S=null)),o.sampleSizes=[],d.entries=[],c.entries=[],u.syncSamples=[],p.sampleDependencies=[],f.entries=[];let T=0,A=0,w=0,k=0,D=0,E=-1,x=0,I=0;const M=[];let C=0;for(const t of e[n-1].moofs){if(!t)continue;const s=t instanceof R?t:t instanceof L?{root:{moof:t}}:new R(new Uint8Array(await K(t))),r=s.root.moof;s.root.mdat&&e[n-1].mdats.push(new Blob([s.root.mdat.data]));const l=r.traf,m=l.tfhd,g=h[n-1].moov.mvex&&h[n-1].moov.mvex.trex;A++;let y=0,_=0;I+=b[n-1][A]||0;for(const e of l.truns||[]){e.samples&&0!==e.samples.length||(e.samples=new Array(e.sampleCount||0).fill({}));for(const t of e.samples){const s=Object.assign({},t);if(T++,s.duration=s.duration||m&&m.defaultSampleDuration||g&&g.sampleDuration||0,s.size=s.size||m&&m.defaultSampleSize||g&&g.sampleSize||0,s.flags=s.flags||m&&m.defaultSampleFlags||g&&g.sampleFlags||0,I=Math.floor(I),0!==I)if("vide"===i){const e=I>0?Math.min(s.duration-1,I):I;s.duration-=e,I-=e}else"soun"===i&&I<0&&s.duration<-I&&(y++,D++,C+=s.duration,o.sampleSizes.push(0),I+=s.duration);a&&0===_&&M.push(T),_++,(33554432&s.flags)>0&&("soun"===i||u.syncSamples.push(T)),o.sampleSizes.push(s.size),k!==s.duration&&(D>0&&(d.entries.push({sampleCount:D,sampleDuration:k}),D=0),k=s.duration),D++,C+=s.duration,(2048&e.flags)>0&&(E!==s.compositionTimeOffset&&x>0&&(f.entries.push({sampleCount:x,sampleOffset:E}),x=0),E=s.compositionTimeOffset,x++)}y+=e.sampleCount,l.sdtp&&p.sampleDependencies.push(...l.sdtp.sampleDependencies)}w!==y&&(w=y,c.entries.push({firstChunk:A,samplesPerChunk:w,sampleDescriptionIndex:1})),A%100==0&&await v(1)}d.entries.push({sampleCount:D,sampleDuration:k}),-1!==E&&f.entries.push({sampleCount:x,sampleOffset:E});const O=()=>{const e=[1];let t=0;for(const e of o.sampleSizes)t+=e;const s=t/o.sampleSizes.length;t=0;for(const e of o.sampleSizes){const r=e-s;t+=r*r}const r=Math.sqrt(t/o.sampleSizes.length);for(let t=1,n=o.sampleSizes.length;t<n;t++)(o.sampleSizes[t]-s)/r>3&&e.push(t+1);return e};if("vide"===i&&(qe&&console.log(...g(r,"MP4","keyframe length : "+u.syncSamples.length+", chunks : "+A)),u.syncSamples.length<1+Math.floor(.8*A))){const e=O();qe&&console.log(...g(r,"MP4","length of estimated keyframes : "+e.length)),e.length>u.syncSamples.length?(u.syncSamples=e,qe&&console.log(...g(r,"MP4","use estimated keyframes"))):a&&M.length>u.syncSamples.length&&(u.syncSamples=M,qe&&console.log(...g(r,"MP4","use the firstframe of chunks as keyframes"))),0===u.syncSamples.length&&(u.syncSamples=[1],qe&&console.log(...g(r,"MP4","no keyframes, set stss.syncSamples=[1]")))}o.sampleCount=o.sampleSizes.length,d.entryCount=d.entries.length,c.entryCount=c.entries.length,u.entryCount=u.syncSamples.length,l?(S.entryCount=A,S.chunkOffsets=new Array(A)):(m.entryCount=A,m.chunkOffsets=new Array(A)),f.entries.length&&(f.entryCount=f.entries.length,"soun"!==i&&s.append(f)),t.mdia.mdhd.duration=C,t.tkhd.duration=Math.floor(C/t.mdia.mdhd.timeScale*1e3),t.edts||t.append(new R.Box("edts")),t.edts.elst||t.edts.append(R.Box.create("elst"));const P=f.entryCount>0?f.entries[0].sampleOffset:0,U=y[n-1]||[];qe&&(console.log("reference",JSON.stringify([{segmentDuration:t.tkhd.duration,mediaTime:P,mediaRateInteger:1,mediaRateFraction:0}])),console.log("neo      ",JSON.stringify(U))),U.length>0?(t.edts.elst.entryCount=U.length,t.edts.elst.entries=U,qe&&console.log("use neo elst !!")):(t.edts.elst.entryCount=1,t.edts.elst.entries=[{segmentDuration:t.tkhd.duration,mediaTime:P,mediaRateInteger:1,mediaRateFraction:0}],qe&&console.log("use reference elst")),p.sampleDependencies.length&&s.append(p),t.mdia.mdhd.duration=C,_=Math.max(C/t.mdia.mdhd.timeScale,_)}const S=Math.floor(1e3*_);f.moov.mvhd.timeScale=1e3,f.moov.mvhd.duration=S,f.arrange();let T=m.size();for(const t of c)l?f.moov.traks[t.track].mdia.minf.stbl.co64.chunkOffsets[t.order]=T+8:f.moov.traks[t.track].mdia.minf.stbl.stco.chunkOffsets[t.order]=T+8,T+=e[t.track].mdats[t.num].size;const A=[new Blob([await m.publishAsync()])];for(const t of c)A.push(e[t.track].mdats[t.num]);const w=new Blob(A,{type:"appplication/octet-stream"});return qe&&console.log(...g(r,"MP4","complete building")),w},U=(e,t)=>{try{const s=e.root.moov.trak.tkhd,r=t.root.moov.trak.tkhd,n=((e,t)=>{const s=e.length;if(s!==t.length)return!1;for(let r=0;r<s;r++)if(e[r]!==t[r])return!1;return!0})(s.matrix,r.matrix)&&s.width===r.width&&s.height===r.height,i=e.root.moov.trak.mdia.mdhd,a=t.root.moov.trak.mdia.mdhd,o=i.timeScale===a.timeScale&&i.languageValues===a.languageValues,l=e.root.moov.trak.mdia.hdlr,d=t.root.moov.trak.mdia.hdlr,c=l.handlerType===d.handlerType&&l.name===d.name;return n&&o&&c}catch(e){return!0}},B=e=>4294967295&e,F={LOG:!1,PREPROCESS_NONE:1,PREPROCESS_REMOVE_ELST_PADDING:2,PREPROCESS_ALLIGN_DURATION:3,build:(e,t)=>{if(!e)return;const{head:s,mdat:r}=e,n=F.generate_mdat_head(r.size,t);return new Blob([new Blob([s]),n,r],{type:"video/mp4"})},generate_mdat_head:(e,t)=>{if(t){const t=new ArrayBuffer(4);return new DataView(t).setUint32(0,e+8,!1),new Blob([t,"mdat"])}{const t=new ArrayBuffer(4);new DataView(t).setUint32(0,1,!1);const s=new ArrayBuffer(8);return new DataView(s).setBigUint64(0,BigInt(e+16),!1),new Blob([t,"mdat",s])}},get_header_info:e=>{const t=e.byteLength;if(t<8)return{};const s=new DataView(e),r=new TextDecoder,n=s.getUint32(0,!1),i=r.decode(e.slice(4,8));return t<16||1!==n?{size32:n,atom:i}:{size32:n,atom:i,size64:s.getBigUint64(8,!1)}},decouple:e=>{const t=e.data;if(1===e?.root?.mdats?.length){const s=e.root.mdat.offset,r=e.root.mdat.wholeSize,n=t.slice(0,s),i=e.root.find("co64")?16:8;return{head:n,mdat:new Blob([t.slice(s+i,s+r)])}}return{head:t,error:"cannot decouple"}},hasVideo:e=>{const t=e?.root?.findAll("hdlr")||[];for(const e of t)if("vide"==e.handlerType)return!0;return!1},hasAudio:e=>{const t=e?.root?.findAll("hdlr")||[];for(const e of t)if("soun"==e.handlerType)return!0;return!1},toSingleTrack:(e,t)=>{const s=e?.root?.findAll("trak")||[];for(const e of s){const s=e.find("hdlr");s?.handlerType!=t&&e.parent.removeChild(e)}},init_for_mixing:(e,t)=>{if(e.chunk_length={vide:0,soun:0},e.mp4=new R(e.head),e.mp4){const s=e.mp4.root,r=s.wholeSize+(s.find("co64")?16:8),n=s.moov.traks;for(const t of n||[]){const s=t.mdia.minf.stbl;let{stco:n,co64:i}=s;if(n&&!i&&(i=R.Box.create("co64"),i.entryCount=n.entryCount,i.chunkOffsets=[...n.chunkOffsets],s.append(i),s.remove(n)),i){const s=t.mdia.hdlr.handlerType;e.chunk_length[s]=i.entryCount;for(let e=0;e<i.entryCount;e++)i.chunkOffsets[e]-=r}}t||F.adjustAllDurationRelateds(e.mp4)}e.mp4&&(e.chunk_length.vide||e.chunk_length.soun)||(e.error=!0)},paddingToSameDuration:e=>{if(e?.root?.moov?.traks?.length>1){F.adjustAllDurationRelateds(e);const{moov:t}=e.root,{traks:s}=t,r=t.mvhd.timeScale||1;for(const e of s){const s=e.mdia.mdhd.timeScale||1,n=t.mvhd.duration-e.tkhd.duration,i=Math.ceil(n/r*s);i&&n&&(F.padEnd_stts(e,i),F.addEnd_elst(e,n))}}},padStart_stts:(e,t)=>F.padding_stts(e,t,"start"),padEnd_stts:(e,t)=>F.padding_stts(e,t,"end"),padding_stts:(e,t,s)=>{if(!t)return;const r="start"===s?0:-1,n=e?.mdia,i=n?.mdhd,a=n?.minf?.stbl?.stts;if(n&&i&&a&&a.entryCount)if(1===a.entries.at(r).sampleCount)a.entries.at(r).sampleDuration+=t;else{const e={sampleCount:1,sampleDuration:t+a.entries.at(r).sampleDuration};a.entries.at(r).sampleCount-=1,a.entries=0===r?[e,...a.entries]:[...a.entries,e],a.entryCount=a.entries.length}},addStart_elst:(e,t)=>F.add_elst(e,t,"start"),addEnd_elst:(e,t)=>F.add_elst(e,t,"end"),add_elst:(e,t,s)=>{if(!t)return;const r=e?.edts?.elst;if(r.entryCount)for(let e=0;e<r.entryCount;e++){const n="start"===s?e:r.entryCount-e-1;if(-1!==B(r.entries[n].mediaTime)){r.entries[n].segmentDuration+=t;break}}},padding_elst:(e,t)=>{const s=e?.edts?.elst;if(s.entryCount)if(-1===B(s.entries[0].mediaTime))s.entries[0].segmentDuration+=t;else{const e={segmentDuration:t,mediaTime:-1,mediaRateInteger:1,mediaRateFraction:0};s.entries=[e,...s.entries],s.entryCount=s.entries.length}},remove_elst_padding:e=>{const{elst:t}=e?.edts;t&&-1===B(t.entries[0]?.mediaTime)&&(t.entries.shift(),t.entryCount--)},concat_elst:(e,t,s,r=0)=>{const[n,i]=[e.edts.elst,t.edts.elst];F.LOG&&(console.log("A",JSON.stringify(n.entries)),console.log("B",JSON.stringify(i.entries))),-1===B(i.entries[0]?.mediaTime)&&(r+=i.entries[0].segmentDuration,i.entries.shift(),i.entryCount--);let a=Math.ceil(r/s*e.mdia.mdhd.timeScale);F.padEnd_stts(e,a);for(let e=0;e<i.entryCount;e++){const t=i.entries[e];t&&(r+=t.segmentDuration)}F.addEnd_elst(e,Math.ceil(r))},normalize_stbl:e=>{const{ctts:t,stsz:s}=e;s?.sampleCount&&!s.sampleSizes&&(s.sampleSizes=new Array(s.sampleCount).fill(s.sampleSize))},concat_stbl:(e,t)=>{const s=e.mdia.minf.stbl,r=t.mdia.minf.stbl;F.normalize_stbl(s),F.normalize_stbl(r);const n=[["stts","entryCount","entries"],["stss","entryCount","syncSamples"],["ctts","entryCount","entries"],["stsc","entryCount","entries"],["stsz","sampleCount","sampleSizes"],["co64","entryCount","chunkOffsets"]];for(let e=0;e<r.stss?.entryCount;e++)r.stss.syncSamples[e]+=s.stsz.sampleCount;for(let e=0;e<r.stsc?.entryCount;e++)r.stsc.entries[e].firstChunk+=s.co64.entryCount;for(const[e,t,i]of n)if(s[e]){if(r[e]){const n=s[e][i],a=r[e][i];n&&a&&(s[e][i]=[...n,...a],s[e][t]=s[e][i].length)}}else if(r[e]){const n=r[e][i];if(n){const r=R.Box.create(e),a="ctts"===e?[{sampleCount:s.stsz?.sampleCount||0,sampleOffset:0}]:[];r[i]=[...a,...n],r[t]=r[i].length,s.append(r)}}!s.stsd&&r.stsd&&s.append(r.stsd)},arrangeChunkOffset:(e,t)=>{let s=e.wholeSize;s+=16;const r=[],n={vide:0,soun:0};for(const i of t){const{mdat:t,chunk_length:a}=i;for(const t of e.moov.traks){const e=t.mdia.hdlr.handlerType,{co64:r}=t.mdia.minf.stbl;for(let t=0;t<a[e];t++)r.chunkOffsets[n[e]]+=s,n[e]++}s+=t.size,r.push(t)}return r},concat:async(e,t)=>{if(!e?.length)return null;const{padding:s=0,preprocess:r,debug:n}=t||{};s&&2!==e.length&&F.LOG&&console.error("MP4Utils.concat: padding works with sources.length === 2. current",e.length);for(let t=0;t<e.length;t++){const s=e[t];if(F.init_for_mixing(s,!0),s.err)return console.error("fatal@MP4Utils.init_for_mixing");if(r===F.PREPROCESS_REMOVE_ELST_PADDING){if(t>0)for(const e of s.mp4?.root?.moov?.traks||[])F.remove_elst_padding(e)}else r===F.PREPROCESS_ALLIGN_DURATION&&t<e.length-1&&F.paddingToSameDuration(s.mp4);F.adjustAllDurationRelateds(s.mp4)}const i=new R,a=i.root,o=e[0].mp4.root;a.append(o.ftyp),a.append(o.moov);{let t=0;for(const s of e){const e=s.mp4.root.moov.traks.length;t<e&&(t=e)}const s=[];for(const r of e){const e=r.mp4.root.moov.traks.length;e===t?s.push(r):F.LOG&&console.log("OUT","[TODO] concat : ignore src due to lack of track,",e,"/",t)}e=s}const l=[e[0]],d=a.moov.mvhd.timeScale;for(let t=1;t<e.length;t++){const r=e[t].mp4.root;for(let e=0;e<a.moov.traks.length;e++){const t=a.moov.traks[e],n=r.moov.traks[e];if(n){const e=s*d;F.concat_elst(t,n,d,e),F.concat_stbl(t,n)}}l.push(e[t])}F.adjustAllDurationRelateds(i),a.arrange();const c=F.arrangeChunkOffset(a,l);return{head:await i.publishAsync(),mdat:new Blob(c,{type:"video/mp4"}),start:e.at(0).start,end:e.at(-1).end,mimeType:e.at(0).mimeType}},mux:async(e,t,s)=>{const{useSTTSPadding:r,alignDuration:n}=s||{},i=Math.min(e.start,t.start);e.offset=e.start-i,t.offset=t.start-i;const a=(F.init_for_mixing(e),F.init_for_mixing(t),e.err||t.err?console.error("fatal@MP4Utils.init_for_mixing"):F.hasVideo(e?.mp4)&&F.hasAudio(t?.mp4)?[e,t]:F.hasVideo(t?.mp4)&&F.hasAudio(e?.mp4)?[t,e]:[]),[o,l]=a;if(!o||!l)return null;F.toSingleTrack(o.mp4,"vide"),delete o.chunk_length.soun,F.toSingleTrack(l.mp4,"soun"),delete l.chunk_length.vide;const d=new R,c=d.root;c.append(o.mp4.root.ftyp),c.append(o.mp4.root.moov),l.mp4.root.moov.trak.tkhd.trackID=2,c.moov.append(l.mp4.root.moov.trak),c.moov.mvhd.nextTrackID=3;const u=c.moov.mvhd.timeScale;for(const e of a){const{trak:t}=e.mp4.root.moov;if(e.offset){const s=Math.ceil(e.offset*u),n=Math.ceil(e.offset*t.mdia.mdhd.timeScale);r?(F.padStart_stts(t,n),F.addStart_elst(t,s)):F.padding_elst(t,s)}}n&&F.paddingToSameDuration(d),F.adjustAllDurationRelateds(d),c.arrange();const h=F.arrangeChunkOffset(c,a);return{head:await d.publishAsync(),mdat:new Blob(h,{type:"video/mp4"})}},dumpESDS:e=>{const t=[],s=e?.root?.moov?.traks||[];for(const e of s){const s=e.mdia?.minf?.stbl?.stsd;if(!s)continue;const r=new R.SimpleView(s.data);t.push("size       : "+r.read32()),t.push("signature  : "+r.readText(4)),t.push("version    : "+r.read8()),t.push("flag       : "+r.read24());const n=r.read32();t.push("entryCount : "+n);for(let e=0;e<n;e++){const e=r.read32(),s=r.readText(4);if(t.push("         size     : "+e),t.push("         code     : "+s),"mp4a"===s){t.push("         >> mp4a specific"),t.push("         skip               : (6)"),r.skip(6),t.push("         dataReferenceIndex : "+r.read16()),t.push("         soundVersion       : "+r.read16()),t.push("         skip               : (6)"),r.skip(6),t.push("         channels           : "+r.read16()),t.push("         sampleSize         : "+r.read16()),t.push("         compressionId      : "+r.read16()),t.push("         packetSize         : "+r.read16()),t.push("         timeScale          : "+r.read32());const e=r.read32(),s=r.readText(4);if(t.push("                 size            : "+e),t.push("                 code            : "+s),"esds"===s){t.push("                 >> esds specific");let e=null;const s=()=>{let e=0,t=0;for(;t<4;t++){const t=r.read8();if(e<<=7,e+=127&t,!(128&t))break}return t++,{size:e,n:t}},n=e=>{const t={id:6},{size:n,n:i}=s();t.size=n,t.size_n=i+"bytes",t.predefined=r.read8(),e.slConfigDescr=t},i=e=>{const t={id:5},{size:n,n:i}=s();t.size=n,t.size_n=i+"bytes";const a={};if(t.size>=2){const e=r.read16();if(a.objectType=(63488&e)>>11,a.frequencyIndex=(1920&e)>>7,a.channelConfiguration=(120&e)>>3,a.frameLengthFlag=(4&e)>>2,a.dependsOnCoreCoder=(2&e)>>1,a.extensionFlag=1&e,t.size>2){const e=t.size-2;a.remain=r.copy(e)}}t.info=a,e.decSpecificInfo=t},a=e=>{const n={id:4},{size:i,n:a}=s();n.size=i,n.size_n=a+"bytes",n.objectTypeId=r.read8();const o=r.read8();n.streamType=(252&o)>>2,n.upStream=(2&o)>>1,n.bufferSizeDB=r.read24(),n.maxBitrate=r.read32(),n.avgBitrate=r.read32();const d=r.read8();5===d?l[d](n):t.push("Found unsupported tag:"+d+"@decConfigDescr"),e.decConfigDescr=n},o=e=>{const n={id:3},{size:i,n:a}=s();n.size=i,n.size_n=a+"bytes";const o=r.getPos()+n.size;n.ES_ID=r.read16();const d=r.read8();for(n.streamDependenceFlag=128&d,n.URL_Flag=64&d,n.OCRstreamFlag=32&d,n.streamPriority=31&d,n.streamDependenceFlag&&(n.dependsOn_ES_ID=r.read16()),n.URL_Flag&&(n.URLlength=r.read8(),r.skip(n.URLlength)),n.OCRstreamFlag&&(n.OCR_ES_Id=r.read16());r.getPos()<o;){const e=r.read8();if(4!==e&&6!==e){t.push("Found unsupported tag:"+e+"@object");break}l[e](n)}e.object=n},l=[0,0,0,o,a,i,n],d={};t.push("                 version            : "+r.read8()),t.push("                 flag               : "+r.read24());const c=r.read8();return t.push("                 childId            : "+c),3===c?l[c](d):e="Found unsupported tag:"+c+"@root",t.push("                 desc            :\n"+JSON.stringify(d,null,4)),t}}}}return t},modifyESDS:(e,t)=>{const s=e?.root?.moov?.traks||[];for(const e of s){const s=e.mdia?.minf?.stbl?.stsd;if(!s)continue;const r=new R.SimpleView(s.data);r.skip(12);const n=r.read32();for(let e=0;e<n;e++)if(r.read32(),"mp4a"===r.readText(4)){r.skip(28);const e=r.read32();if("esds"===r.readText(4)){let s=null;const n=[],i=()=>{let e=0;for(let t=0;t<4;t++){const t=r.read8();if(e<<=7,e+=127&t,!(128&t))break}return e},a=e=>{const a={id:4};if(a.size=i(),a.objectTypeId=r.read8(),t?.decConfigDescr?.objectTypeId){const{objectTypeId:e}=t.decConfigDescr;e!==a.objectTypeId&&n.push({ptr:r.getPos()-1,size:1,value:e,log:"replace decConfigDescr.objectTypeId from "+a.objectTypeId+" to "+e})}const o=r.read8();a.streamType=(252&o)>>2,a.upStream=(2&o)>>1,a.bufferSizeDB=r.read24(),a.maxBitrate=r.read32(),a.avgBitrate=r.read32();const d=r.read8();5===d?l[d](a):s="Found unsupported tag:"+d+"@decConfigDescr",e.decConfigDescr=a},o=e=>{const t={id:3};t.size=i();const n=r.getPos()+t.size;t.ES_ID=r.read16();const a=r.read8();for(t.streamDependenceFlag=128&a,t.URL_Flag=64&a,t.OCRstreamFlag=32&a,t.streamPriority=31&a,t.streamDependenceFlag&&(t.dependsOn_ES_ID=r.read16()),t.URL_Flag&&(t.URLlength=r.read8(),r.skip(t.URLlength)),t.OCRstreamFlag&&(t.OCR_ES_Id=r.read16());r.getPos()<n;){const e=r.read8();if(4!==e&&6!==e){s="Found unsupported tag:"+e+"@object";break}l[e](t)}e.object=t},l=[0,0,0,o,a,e=>{const s={id:5};s.size=i();const a={};if(s.size>=2){const e=r.read16();if(a.objectType=(63488&e)>>11,a.frequencyIndex=(1920&e)>>7,a.channelConfiguration=(120&e)>>3,a.frameLengthFlag=(4&e)>>2,a.dependsOnCoreCoder=(2&e)>>1,a.extensionFlag=1&e,t?.decConfigDescr?.decSpecificInfo?.info){const s=t.decConfigDescr.decSpecificInfo.info,i=((31&(s.objectType||a.objectType))<<11)+((15&(s.frequencyIndex||a.frequencyIndex))<<7)+((15&(s.channelConfiguration||a.channelConfiguration))<<3)+((1&(s.frameLengthFlag||a.frameLengthFlag))<<2)+((1&(s.dependsOnCoreCoder||a.dependsOnCoreCoder))<<1)+(1&(s.extensionFlag||a.extensionFlag));e!==i&&n.push({ptr:r.getPos()-2,size:2,value:i,log:"replace audioSpecificConfig from "+e.toString(2).padStart(16,"0")+" to "+i.toString(2).padStart(16,"0")})}if(s.size>2){const e=s.size-2;a.remain=r.copy(e)}}s.info=a,e.decSpecificInfo=s},e=>{const t={id:6};t.size=i(),t.predefined=r.read8(),e.slConfigDescr=t}],d={size:e,logs:[]};r.skip(4);const c=r.read8();if(3===c?l[c](d):s="Found unsupported tag:"+c+"@root",s)d.error=s;else for(const e of n){const{ptr:t,size:s,value:n,log:i}=e;r.setPos(t),r["write"+8*s]?.(n),d.logs.push(i)}return d}}}return{logs:[]}},binary_search_ftyp_moof:(e,t=4)=>{for(let s=0;s<e.length-3;s+=t)if(102===e[s]&&116===e[s+1]&&121===e[s+2]&&112===e[s+3]||109===e[s]&&111===e[s+1]&&111===e[s+2]&&102===e[s+3])return s-4;return-1},binary_searched_ptr:(e,t,s=8192,r=0)=>{const n=F.binary_search(e,t,s,r);return-1===n?null:e.slice(n)},binary_search:(e,t,s,r)=>{if(e){r&&s&&(s+=r);const n=[];for(const e of t){const t=[];for(const s of e)t.push(s.charCodeAt(0));n.push({name:e,data:t})}for(let i=r,a=Math.min(e.length-3,s||e.length);i<a;i++)for(const a of n){const n=a.data;if(4===n.length&&e[i]===n[0]&&e[i+1]===n[1]&&e[i+2]===n[2]&&e[i+3]===n[3]&&i-4>=0){if("ftyp"===a.name&&e[i-4]+e[i-3]+e[i-2]>0)continue;i-=4;const n=i;return F.LOG&&console.log("    + MP4Utils.binary_search: found",a.name,"@",n,"/",e.byteLength,"bytes",", target=",t.join(","),"search_range("+r+"-"+(s?s-1:"")+")"),i}}}return-1},inspect:(e=[],t=!1)=>{t&&console.log("- - inspect"),e instanceof Array||(e=[e]);for(const s of e){const e=s?.root?.moov;if(!e)continue;const r=e.mvhd.timeScale||1,n=e.mvhd.duration/r;let i=0;const a=[];for(const t of e.traks||[]){const e=t.tkhd.duration/r,s=t.mdia.mdhd.timeScale||1,n=t.mdia.mdhd.duration/s,o=t.mdia.hdlr?.handlerType,l={type:o,duration:n,padding:0,segmentDuration:0,tkhd_duration:e};for(const{segmentDuration:e=0,mediaTime:s=0}of t.edts?.elst?.entries||[{}])-1===B(s)?l.padding=e/r:l.segmentDuration=e/r;a.push(l),i<e&&(i=e)}for(const e of a){const{type:s,tkhd_duration:r,duration:a,padding:o}=e,l=o?"###"+o+"###":"***********",d="*******"+a+"*******"+(r===i?"*****":"   ");t&&console.log(s,l+d+(o?"":"        "),JSON.stringify(e),", whole duration:",n)}}},adjustAllDurationRelateds:e=>{const t=e?.root?.moov;if(!t)return;console.log("- - adjustAllDurations");const s=t.mvhd.timeScale||1;let r=0;for(const e of t.traks||[]){const t=e.mdia.mdhd.timeScale||1,n=e.mdia.hdlr?.handlerType,i=e=>Math.ceil(e/t*s),a=e?.mdia?.minf?.stbl?.stts;if(a){let t=0;for(let e=0;e<a.entryCount;e++){const{sampleCount:s=0,sampleDuration:r=0}=a.entries[e]||{};t+=s*r}e.mdia.mdhd.duration!==t&&(console.log("[modify]",n,", trak.mdia.mdhd.duration =",t,", prev",e.mdia.mdhd.duration),e.mdia.mdhd.duration=t);let s=0;for(const r of e.edts?.elst?.entries||{}){if(-1!==B(r.mediaTime)){const s=i(t);r.segmentDuration!==s&&(console.log("[modify]",n,", elst.segmentDuration =",s,", prev",r.segmentDuration),r.segmentDuration=s);const a=e.mdia.minf.stbl.ctts?.entries[0];a&&r.mediaTime!==a.sampleOffset&&(console.log("[modify]",n,", elst.mediaTime =",a.sampleOffset,", prev",r.mediaTime),r.mediaTime=a.sampleOffset)}s+=r.segmentDuration}e.tkhd.duration!==s&&(console.log("[modify]",n,", trak.tkhd.duration =",s,", prev",e.tkhd.duration),e.tkhd.duration=s)}r<e.tkhd.duration&&(r=e.tkhd.duration)}t.mvhd.duration!==r&&(console.log("[modify] moov.mvhd.duration =",r,", prev",t.mvhd.duration),t.mvhd.duration=r)},x100:async({head:e,mdat:t})=>{const s=[];for(let r=0;r<100;r++)s.push({head:e,mdat:t});return await F.concat(s)}},N=localStorage.ilog,z=e=>{const t=e.root;if(t.moov){const e=t.moov.traks.length;if(e>1&&t.moov.mvex.trexs.length===e){const s=[];for(let r=0;r<e;r++){const e=new R,n=e.root;t.ftyp&&n.append(t.ftyp),n.append(new R.Box("moov")),n.moov.append(t.moov.mvhd),n.moov.append(new R.Box("mvex")),n.moov.mvex.append(t.moov.mvex.trexs[r]),n.moov.append(t.moov.traks[r]),n.arrange(),s.push(e)}return s}}else if(t.moof){const s=t.moof.trafs?.length||0;if(s<2)return[e];const r=[],n=e.data,i=t.sidxs?.length===t.moofs.length*s;let a=0;for(let e=0;e<t.moofs.length;e++){const s=t.moofs[e],o=s.trafs?.length||0;for(let e=0;e<o;e++){const l=s.trafs[e],d=new R,c=d.root;t.styp&&c.append(t.styp);const u=i?a:t.sidxs?.length===o?e:0;t.sidx&&c.append(t.sidxs[u]),c.append(new R.Box("moof")),c.moof.append(s.mfhd),c.moof.append(l),c.arrange(),c.publish(null,null,(()=>{})),r.push(d);const h=[];let m=0;for(const e of l.truns||[]){let t=s.offset+e.dataOffset,r=0;for(let t=0;t<e.sampleCount;t++)r+=(e.samples?.[t]||{}).size||l.tfhd?.defaultSampleSize||0;h.push(n.slice(t,t+r)),m+=r}const f=new Uint8Array(8);m+=8,f.set([m>>24&255,m>>16&255,m>>8&255,255&m,109,100,97,116]),d.mdat=new Blob([f,...h]),d.isDivided=!0}a++}return r.length>0?r:[e]}return[e]},G=e=>{const t=e?.init?.root?.moov?.trak?.mdia;if(t){const e=t.mdhd?.timeScale;if(e)return e;if(t.hdlr){if("vide"===t.hdlr.handlerType)return 9e4;if("soun"===t.hdlr.handlerType)return 48e3}}return 1e3},q=(e,t,s)=>{if(!e||!t)return{moofDuration:0,moofStart:0};s=s||0;const r=t&&t.moofs&&t.moofs[s],n=t&&t.sidx;if(0===s&&(r?.traf?.tfdt?.baseMediaDecodeTime||0)<-2147483648&&(r.traf.tfdt.baseMediaDecodeTime=0),n){const{timeScale:t,earliestPresentationTime:i}=n;let a;Math.abs(r.traf.tfdt.baseMediaDecodeTime/e.root.moov.trak.mdia.mdhd.timeScale-i/t)>.1&&N&&console.log("baseMediaDecodeTime !== earliestPresentationTime",r.traf.tfdt.baseMediaDecodeTime/e.root.moov.trak.mdia.mdhd.timeScale,i/t),i&&t?a=i/t:r.traf.tfdt.baseMediaDecodeTime&&e.root.moov.trak.mdia.mdhd.timeScale&&(a=r.traf.tfdt.baseMediaDecodeTime/e.root.moov.trak.mdia.mdhd.timeScale);const o=n.references&&n.references[s]&&n.references[s].subsegmentDuration;if(t&&void 0!==a&&o)return{moofDuration:o/t,moofStart:a}}if(r&&e?.root?.moov){const t=e.root.moov.trak?.mdia?.mdhd?.timeScale||0,s=r.traf;if(s&&t){const{tfhd:r,trun:n,tfdt:i}=s;if(r&&i&&n){const n=i.baseMediaDecodeTime/t,a=r.defaultSampleDuration;let o=0;for(const e of s.truns){const t=e.sampleCount||e.samples?.length||0;for(let s=0;s<t;s++)o+=(e.samples?.[s]||{}).duration||a||0}if(0===o){const t=e.root.moov.mvex?.trex?.sampleDuration||0;for(const e of s.truns)o+=(e.sampleCount||e.samples?.length||0)*t}return o/=t,{moofDuration:o,moofStart:n}}}}return{moofDuration:0,moofStart:0}},H=e=>{if(e&&e.start){const t=e.start.length;if(t>1)for(let s=e.contig;s<t-1;s++){const t=e.start[s],r=e.duration[s],n=e.start[s+1];if(Math.abs(t+r-n)>.1)return N&&(console.log("---:--- discontig track found"),console.log("        start:"+t,"duration:"+r,"next:"+n),console.log("        start    "+d(e.start)),console.log("        duration "+d(e.duration))),!0;e.contig=s+1}}return!1},V=e=>{let t=0;for(const s of e)s.init&&s.moofs.length>0&&t++;return e.length===t},j=e=>{for(const t of e){const e=t.start.length-1;if(e>=2){const{moofs:s,mdats:r,start:n,durations:i}=t;if(s.length===r.length&&s.length===n.length&&s.length===i.length&&n[e-2]<n[e]&&n[e]<n[e-1]){const t=n[e-2]+i[e-2];Math.abs(t-n[e])<Math.abs(t-n[e-1])&&(qe&&console.log("swap misplaced data",n[e-2],n[e-1],n[e]),(t=>{for(const s of t){const t=s[e-1];s[e-1]=s[e],s[e]=t}})([s,r,n,i]))}}}},$=e=>{for(const t of e)if(t.init&&t.moofs.length>1){const e=t.moofs.length-1;t.start[e]===t.start[e-1]&&t.durations[e]===t.durations[e-1]&&(N&&(console.log("    remove same start/duration"),console.log("        track-start    "+d(t.start)),console.log("        track-duration "+d(t.durations))),t.moofs.splice(e-1,1),t.mdats.splice(e-1,1),t.start.splice(e-1,1),t.durations.splice(e-1,1))}if(2!==e.length)return;if(e[0].start.length<1||e[1].start.length<1)return;const t=e[0],s=e[1];let r=null,n=Math.abs(t.start[0]-s.start[0]);if(t.start.length>1){const e=Math.abs(t.start[1]-s.start[0]);e<n&&(n=e,r=t)}if(s.start.length>1){const e=Math.abs(s.start[1]-t.start[0]);e<n&&(n=e,r=s)}r&&(N&&(console.log("[ - ]   remove the first to sync a/v"),console.log("        a "+d(t.start)),console.log("        b "+d(s.start))),r.moofs.splice(0,1),r.mdats.splice(0,1),r.start.splice(0,1),r.durations.splice(0,1))},K=async e=>new Promise(((t,s)=>{const r=new FileReader;r.onload=e=>{t(r.result)},r.onerror=e=>{s(r.error)},r.readAsArrayBuffer(e)}));let X=[];const Y=e=>{let{url:t,method:s,headers:r,resultType:n,timeout:i}=e;return new Promise(((s,r)=>{t=ue(t),e.revokeList=X,X=[],A.runtime.sendMessage({cmd:"l2b_fetch_request",params:e,type:m},(e=>{const{ok:t,blobUrl:n,buffer:i,array:a,message:o}=e||{};if(t){if(n)fetch(n).then((e=>{e.ok?(X.push(n),s(e)):r({status:-1,message:"failed to fetch"})})).catch((e=>{r({status:-1,error:e})}));else if(i||a){const e=i||new Uint8Array(a).buffer;s({ok:t,arrayBuffer:async()=>e,text:async()=>new TextDecoder("utf-8").decode(new Uint8Array(e))})}}else r({status:-1,message:o})})),i&&setTimeout((()=>{r({status:408})}),i)}))};class J{constructor(e,t,s){this.url=e,this.method=t||"GET",this.headersCandidate=[],this.succeed_headers_index=0,this.master=null,this.details=null,this.root=s}async load(e={}){const{retry:t=6,interval:s=300}=e,r=Math.max(1,Math.min(6,t));this.headersCandidate=Qe(1,this.url,this.root?.headersCandidate,{excludes:["range"]}),this.succeed_headers_index=this.root?.succeed_headers_index||0;for(let e=0;e<r;e++){const t=(e+this.succeed_headers_index)%this.headersCandidate.length,n=this.headersCandidate[t];await et.set(n);const i=await this.loadPlayList();if(300===i.status)return i.dnr_headers=this.headersCandidate,i.succeed_headers_index=t,this.succeed_headers_index=t,i;if(999===i.status)return{status:999};if(e===r-1)return i;await v(s)}return{status:900,message:"not reach here"}}get isMaster(){return this.master}get isLevelDetail(){return this.details}async loadPlayList(){const{url:e,method:t}=this;try{const s=await Y({url:e,method:t});if(s.ok){let t=await s.text();if(je?.settings?.ignoreHLSDiscontinuity&&(t=t.replaceAll("#EXT-X-DISCONTINUITY","#IGNORED")),t.indexOf("#EXTINF:")>0||t.indexOf("#EXT-X-TARGETDURATION:")>0)this.details=await this._handleTrackOrLevelPlaylist(t,e,0);else{const s=await this._handleMasterPlaylist(t,e,null,null,null);this.master=this.onManifestLoaded(s)}return{status:300,message:"ok"}}return{status:s.status}}catch(e){return"Extension context invalidated."===e?.message?{status:999}:(qe&&console.log(...y(e.message||e.error?.message||e)),{status:900,message:e.message||e.error?.message||e||"unkown"})}}async _handleMasterPlaylist(e,t,s,r,n){const i=e,{levels:a}=M3U8Parser.parseMasterPlaylist(i,t),o=M3U8Parser.parseMasterPlaylistMedia(i,t,"SUBTITLES");let l=M3U8Parser.parseMasterPlaylistMedia(i,t,"AUDIO",a.map((e=>({id:e.attrs.AUDIO,codec:e.audioCodec}))));if(l.length){let e=!1;l.forEach((t=>{t.url||(e=!0)})),!1===e&&a[0].audioCodec&&!a[0].attrs.AUDIO&&l.unshift({type:"main",name:"main"})}return{levels:a,audioTracks:l,subtitles:o}}async _handleTrackOrLevelPlaylist(e,t,s){const r=M3U8Parser.parseLevelPlaylist(e,t,s,"main");if(!r.targetduration)throw Error("[Abort] invalid target duration"+e.status);return r}onManifestLoaded(e){let t,s=[],r={},n=null,i=!1,a=!1,o=/chrome|firefox/.test(navigator.userAgent.toLowerCase()),l=[];const d=e.subtitles,c=d&&d.length>0;if(e.levels.forEach((e=>{e.loadError=0,e.fragmentError=!1,i=i||!!e.videoCodec,a=a||!!e.audioCodec||!(!e.attrs||!e.attrs.AUDIO),!0===o&&e.audioCodec&&-1!==e.audioCodec.indexOf("mp4a.40.34")&&(e.audioCodec=void 0),n=r[e.bitrate],void 0===n?(e.url=[e.url],e.urlId=0,r[e.bitrate]=e,s.push(e)):n.url.push(e.url)})),!0===i&&!0===a&&(s=s.filter((({videoCodec:e})=>!!e))),s=s.filter((({audioCodec:e,videoCodec:t})=>(!e||isCodecSupportedInMp4(e))&&(!t||isCodecSupportedInMp4(t)))),e.audioTracks&&(l=e.audioTracks.filter((e=>!e.audioCodec||isCodecSupportedInMp4(e.audioCodec,"audio")))),s.length>0){t=s[0].bitrate,s.sort(((e,t)=>e.bitrate-t.bitrate));for(let e=0;e<s.length&&s[e].bitrate!==t;e++);return{levels:s,audioTracks:l,audio:a,video:i,altAudio:l.length>0,subtitles:d,subtitle:c}}throw Error("no level with compatible codecs found in manifest")}}const W={mp4:MediaSource.isTypeSupported("video/mp4"),mpeg:MediaSource.isTypeSupported("audio/mpeg"),mp3:MediaSource.isTypeSupported('audio/mp4; codecs="mp3"')},Q=[{demux:TSDemuxer,remux:MP4Remuxer},{demux:MP4Demuxer,remux:PassThroughRemuxer},{demux:AACDemuxer,remux:MP4Remuxer},{demux:MP3Demuxer,remux:MP4Remuxer}],Z={stretchShortVideoTrack:!1,maxBufferHole:.5,maxAudioFramesDrift:1,enableSoftwareAES:!0,forceKeyFrameOnDiscontinuity:!0};class ee{constructor(e,t,s,r){this.demuxer=null,this.remuxer=null,this.initSegment=e,this.audioCodec=t,this.videoCodec=s,this.duration=r,this.result={},this.resolve=null,this.reject=null,this._evt_=[]}init(){this.demuxer&&(this.demuxer.resetInitSegment(this.initSegment,this.audioCodec,this.videoCodec,this.duration),this.demuxer.resetTimeStamp()),this.remuxer&&(this.remuxer.resetInitSegment(),this.remuxer.resetTimeStamp())}get observer(){return{trigger:(e,t)=>{if(this._evt_.push(e.replace(/hlsFrag/,"").replace(/hls/,"")),"hlsError"===e&&this.reject({fatal:!1,message:t}),e===HlsEvents.FRAG_PARSED)return He&&console.log(...g(null,"DMXR",this._evt_.join(","))),this._evt_=[],this.resolve(this.result);e===HlsEvents.FRAG_PARSING_INIT_SEGMENT?this.result[e]=t:e===HlsEvents.FRAG_PARSING_DATA&&(this.result[e]||(this.result[e]=[]),this.result[e].push(t))}}}demux(e,t,s,r,n){return new Promise((async(t,i)=>{this.result={},this.resolve=t,this.reject=i;try{if(e=new Uint8Array(e),!this.demuxer){for(const t of Q)if(t.demux.probe(e)){this.remuxer=new t.remux(this.observer,Z,W,navigator.vendor),this.demuxer=new t.demux(this.observer,this.remuxer,Z,W);break}if(!this.demuxer)return i({fatal:!0,message:"suitable demuxer not found"});n=!1}n||this.init(),this.demuxer.append(e,s,n,r)}catch(e){console.log(...y(e.stack)),i({fatal:!0,message:e.message})}}))}}class te{constructor(e,t){const{vId:s,settings:r}=e;this.vId=s,this.settings=r;const n=document.createElement("div"),i=document.getElementById("VideoTemplate_v15").innerHTML;n.innerHTML=i,document.getElementById("videos").appendChild(n),this.container=n,this.loading=!0,this.size=0,this.duration=0;const a=async()=>{this.saveButton.classList.contains("disabled")||(this.saveButton.classList.add("disabled"),this.saveButton.classList.add("loading"),this.loading&&t&&await t(),setTimeout((()=>{this.saveButton.classList.remove("disabled"),this.saveButton.classList.remove("loading")}),6e4),await Ge({cmd:Be,params:{vId:s}}),await v(1e3),this.saveButton.classList.remove("disabled"),this.saveButton.classList.remove("loading"))};this.saveButton.addEventListener("click",a),this.forceRenderLink.addEventListener("click",a),this.closeButton.addEventListener("click",(async()=>{await Ge({cmd:Ue,params:{vId:s}})})),this.errorLabel.innerHTML="&nbsp;";const o=this.video;o._mouseEvents={enter:()=>{o.src&&(o.controls=!0)},leave:()=>{o.src&&(o.controls=!1)}},o.addEventListener("mouseover",o._mouseEvents.enter),o.addEventListener("mouseout",o._mouseEvents.leave),this.dateLabel=S(),this.titleLabel.innerText=je.title,this.titleLink.title=je.title,this.titleLink.href=je.url,this.doneInit={}}start(){}pause(){}update(){}update_subtitleProgress(){}get video(){return this.container.querySelector("video")}get progress(){return this.container.querySelector("progress")}get loadCtrls(){return this.container.querySelectorAll(".loadCtrls")}get downloadLink(){return this.container.querySelector(".donwloadLink")}get stopButton(){return this.container.querySelector(".stopButton")}get startButton(){return this.container.querySelector(".startButton")}get saveButton(){return this.container.querySelector(".saveButton")}get closeButton(){return this.container.querySelector(".closeButton")}get forceRenderLink(){return this.container.querySelector(".forceRenderLink")}get ignoreMasterIndex(){return this.container.querySelector(".ignoreMasterIndex")}get titleLabel(){return this.container.querySelector(".titleLabel")}get titleLink(){return this.container.querySelector(".titleLink")}get sizeLabel(){return this.container.querySelector(".sizeLabel")}get durationLabel(){return this.container.querySelector(".durationLabel")}get progressLabel(){return this.container.querySelector(".progressLabel")}get qualityLabel(){return this.container.querySelector(".qualityLabel")}get subtitleSelectLabel(){return this.container.querySelector(".subtitleSelectLabel")}get subtitleProgress(){return this.container.querySelector(".subtitleProgress")}get audioSelectLabel(){return this.container.querySelector(".audioSelectLabel")}get qualitySelectLabel(){return this.container.querySelector(".qualitySelectLabel")}get boostLabel(){return this.container.querySelector(".boostLabel")}get boostV2(){return this.container.querySelector(".v216_boost")}get boostV2Label(){return this.container.querySelector(".v216_boostLabel")}get boostV2Option(){return this.container.querySelector(".v216_boostOption")}get errorLabel(){return this.container.querySelector(".errorLabel")}get statusLabel(){return this.container.querySelector(".statusLabel")}addSize(e){this.setSize(this.size+e)}setSize(e){this.size=e;const t=(e=>{if(e<1)return{value:0,unitIdx:0};const t=Math.floor(Math.log(e)/Math.log(1024)),s=Math.floor(10*e/Math.pow(1024,t))/10;return s<1e3?{value:s,unitIdx:t}:{value:Math.floor(s),unitIdx:t}})(this.size);this.sizeLabel.innerText=t.value+" "+b[t.unitIdx]}addDuration(e){this.setDuration(this.duration+e)}setDuration(e){this.duration=e,this.durationLabel.innerText=this.getDurationString()}getDurationString(){return String(Math.trunc(this.duration/60))+":"+String(Math.trunc(this.duration%60)).padStart(2,"0")}setQuality(e){this.qualityLabel.innerHTML=e}setWarn(e){this.errorLabel.innerHTML=e,this.errorLabel.style.display="inline"}setError(e){this.errorLabel.innerHTML=e,this.errorLabel.style.display="inline";const t=this.errorLabel.querySelector(".tryCapture");t&&t.addEventListener("click",(()=>{document.getElementById("forceCaptureButton").click()})),this.progress.style.background=a,this.stopButton.classList.add("disabled"),document.title.includes("!")||(document.title="! "+document.title)}setStatus(e,t){void 0!==t&&(this.statusLabel.style.background=t),void 0!==e&&(this.statusLabel.innerText=e)}showControl(e){this.loadCtrls.forEach((t=>{t.style.display=e?"inline":"none"}))}showSaveButton(e){this.saveButton.style.display=e?"inline":"none"}showCloseButton(e){this.closeButton.style.display=e?"inline":"none"}terminate(){const e=i;this.setStatus("RECORDED",e.content),this.progress.setAttribute("value",0),this.progress.style.background=e.content,this.saveButton.style.background=e.content,this.saveButton.style.borderColor=e.border,this.loading=!1,this.showControl(!1),this.showSaveButton(!0)}removeSelf(){const e=document.getElementById("videos");e&&e.contains(this.container)&&(e.removeChild(this.container),Ge({cmd:Ue,params:{vId:this.vId}}))}setMessage(e,t){"title"===e?document.title=t:"warn"===e?this.setWarn(t):"error"===e&&this.setError(t)}setQualityOptionByMaster(e){const t=(t,r)=>{t.addEventListener("click",(async()=>{this.stopButton.click(),this.forceRenderLink.style.display="none";try{const t={},n=await r(e);if(null!=n.level){const{quality:r,level:i,audioLevel:a}=s(n.quality,n.level,e);Object.assign(t,{quality:r,level:i,audioLevel:a})}else t.audioLevel=n.audioLevel;const i={level:e.settings.level,quality:e.settings.quality,audioLevel:e._suitable_audio_level,mId:e.mId},a=await Ge({cmd:Ce,params:Object.assign(i,t)});2===a.status?(this.startButton.click(),a.message&&this.setWarn(a.message)):-1===a.status&&this.setError(a.message)}catch(e){"cancelled"===e?.message?this.startButton.click():console.log(...y(e?.stack||e))}}))},s=(e,t,s)=>{const{audioTracks:i,selected_audioLevel:a}=s,{level:o,levelObj:l}=((e,t,s)=>{const{levels:i,settings:a}=s;return t=e===n?0:e===r?i.length-1:t||a.level,{level:t=Math.max(0,Math.min(i.length-1,t)),levelObj:i[t]}})(e,t,s),d=i.filter((e=>e.groupId===l.attrs.AUDIO)),c=d.find((e=>e.default))||d[0],u=i[a],h=d.includes(u)?u:c;let m=i.indexOf(h);return m=Math.max(0,Math.min(i.length-1,m)),{quality:e,level:o,levelObj:l,suitableAudioTracks:d,audioLevel:m,audioObj:h}};e.levels.length>1?(this.qualitySelectLabel.innerHTML=Ve.quality+'&nbsp;-&nbsp;<a href="javascript:void(0)">'+Ve[this.settings.quality]+"</a>",this.qualitySelectLabel.style.display="inline",t(this.qualitySelectLabel,ie)):this.qualitySelectLabel.innerHTML=Ve.quality+"&nbsp;-&nbsp;( no option )";const{quality:i,level:a}=e.settings,{level:o,suitableAudioTracks:l,audioLevel:d,audioObj:c}=s(i,a,e);if(e._suitable_audio_tracks=l,e._suitable_audio_level=d,l.length>1){const e=c.lang||c.name;this.audioSelectLabel.innerHTML=Ve.audio+'&nbsp;-&nbsp;<a href="javascript:void(0)">'+e+"</a>",this.audioSelectLabel.style.display="inline",t(this.audioSelectLabel,ae)}e.subtitles.length>0&&(this.subtitleSelectLabel.innerHTML=Ve.subtitle,this.subtitleSelectLabel.style.display="inline",((t,s)=>{t.addEventListener("click",(async()=>{try{if(this.loadingSubs)return;const t=await s(e);this.loadingSubs=!0,t.vId=this.vId,t.mId=e.mId,this.subtitleProgress.style.display="block",this.subtitleProgress.value=0,this.subtitleProgress.max=0;const r=await Ge({cmd:Fe,params:t});this.subtitleProgress.style.display="none",this.loadingSubs=!1,-1===r.status&&this.setError(r.message)}catch(e){console.log(...y(e?.stack||e))}}))})(this.subtitleSelectLabel,oe))}}class se extends te{constructor(e,t){super(e,t);const{vId:s,settings:r}=e;if(this.setStatus("HLS"),this.durationLabel.style.display="none",this.progressLabel.style.display="inline",this.isBoosting=!1,this.boostLevel=3,this.boostV2){this.boostV2.style.display="inline",this.boostV2Label.addEventListener("click",(()=>{this.isBoosting=!this.isBoosting,this.boostV2Label.style.setProperty("color",this.isBoosting?"#f88":"#939aa6"),this.boostV2Option.style.opacity=this.isBoosting?1:0,Ge({cmd:Ne,params:{vId:s,parallel_max:this.isBoosting?this.boostLevel:1}})}));for(const e of this.boostV2Option.querySelectorAll("button"))e.addEventListener("click",(t=>{if(this.isBoosting){this.boostLevel=Math.max(1,Math.min(6,Number(e.querySelector("span").innerText)));for(const t of this.boostV2Option.querySelectorAll("button"))t.classList[t==e?"add":"remove"]("active");Ge({cmd:Ne,params:{vId:s,parallel_max:this.boostLevel}})}}))}le("hls"),this.startButton.addEventListener("click",(async()=>{await Ge({cmd:Oe,params:{vId:s}})})),this.stopButton.addEventListener("click",(async()=>{await Ge({cmd:Pe,params:{vId:s}})}));const n=$e[e.mId];n&&this.setQualityOptionByMaster(n)}start(){this.startButton.classList.add("disabled"),this.stopButton.classList.remove("disabled"),this.forceRenderLink.style.display="none",this.progress.style.removeProperty("background"),this.errorLabel.innerHTML="&nbsp;",document.title=document.title.replace("! ","")}pause(e){this.startButton.classList.remove("disabled"),this.stopButton.classList.add("disabled"),this.forceRenderLink.style.display="inline",e&&this.setError(e)}update_videoProgress(e){const{size:t,duration:s,quality:r,progress:n}=e,{max:i,current:a,offset:o}=n;this.setSize(t),this.setQuality(r),this.progress.max=i,this.progress.value=a,this.progressLabel.innerText=a+" / "+i,document.title=a+o+" / "+(i+o)+" - "+Ve.title_loading}update_subtitleProgress(e){this.subtitleProgress.value=e.current+1,this.subtitleProgress.max=e.total}}class re extends te{constructor(e,t){super(e,t),this.setStatus("LIVE",a),this.showControl(!1),this.showSaveButton(!0),this.showCloseButton(!0),this.statusLabel.style.marginTop="8px",this.boostV2.style.display="none",le("live");const s=$e[e.mId];s&&this.setQualityOptionByMaster(s)}update_videoProgress(e){const{size:t,duration:s,quality:r}=e;this.setSize(t),this.setQuality(r),this.setDuration(s||0),document.title=this.durationLabel.innerText+" - "+Ve.title_recording}}class ne extends te{constructor(e,t){super(e,t),this.setStatus("REC",a),this.showControl(!1),this.showSaveButton(!0),this.boostV2.style.display="none",le("capture"),document.getElementById("waitingData").style.display="block",this.success=!1}update_videoProgress(e){const{size:t,duration:s,quality:r}=e;this.success||(document.getElementById("waitingData").style.display="none",this.success=!0),this.setSize(t),this.setQuality(r),this.setDuration(s),document.title=this.durationLabel.innerText+" - "+Ve.title_recording}}const ie=e=>{const{levels:t,settings:s}=e;return new Promise(((e,i)=>{const a=document.createElement("div");a.innerHTML=document.getElementById("selectLevelModalTemplate_v15").innerHTML,document.body.appendChild(a);const o=a.querySelector("div"),l=()=>{document.body.removeChild(a)},d=o.querySelectorAll('input[name="level"]'),c=o.querySelector("select"),u=s.quality,h=s.level;for(let e=0,s=t.length;e<s;e++){const s=t[e],r=s.attrs.BANDWIDTH,n=s.attrs.RESOLUTION,i=document.createElement("option"),a=(n?n+" , ":"")+(r?r+" bps":"");i.setAttribute("value",e),i.innerHTML=a,e===h&&(i.selected=!0),c.appendChild(i)}const m=e=>{"quality_custom"===e.target.value?c.classList.remove("disabled"):c.classList.add("disabled")};for(const e of d)e.addEventListener("click",m);for(const e of document.querySelectorAll('input[name="level"]'))e.value===u&&e.click();o.querySelector(".close-modal").addEventListener("click",(()=>{i({message:"cancelled"}),l()})),o.querySelector("button").addEventListener("click",(()=>{const s=document.querySelector('input:checked[name="level"]');if(s){const i=s.value;e(i===r?{level:t.length-1,quality:i}:i===n?{level:0,quality:i}:{level:c.selectedIndex,quality:i})}else e({level:0,quality:n});l()})),o.classList.add("active")}))},ae=e=>{const{audioTracks:t,_suitable_audio_tracks:s,_suitable_audio_level:r}=e,n=s.indexOf(t[r]);return new Promise(((e,r)=>{const i=document.createElement("div");i.innerHTML=document.getElementById("selectAudioModalTemplate_v15").innerHTML,document.body.appendChild(i);const a=i.querySelector("div"),o=()=>{document.body.removeChild(i)},l=a.querySelector(".form-group"),d=a.querySelector(".radioTemplate").innerHTML;for(let e=0,t=s.length;e<t;e++){const t=s[e],{audioCodec:r,lang:i,name:a,details:o}=t,c=o.totalduration,u=e,h=`[ ${i} ]  ${a} ( ${r} )`,m="Duration : "+String(Math.trunc(c/60))+":"+String(Math.trunc(c%60)).padStart(2,"0"),f=document.createElement("div");f.innerHTML=d.replace(/\$value/,u).replace(/\$label/,h).replace(/\$tooltip/,m),e==n&&(f.querySelector("input").checked=!0),l.appendChild(f)}a.querySelector(".close-modal").addEventListener("click",(()=>{r({message:"cancelled"}),o()})),a.querySelector("button").addEventListener("click",(()=>{const r=a.querySelector('input:checked[name="audios"]');if(r){const n=Number(r.value),i=s[n],a=t.indexOf(i);e({audioLevel:a})}else e({audioLevel:0});o()})),a.classList.add("active")}))},oe=e=>{const{subtitles:t}=e;return new Promise(((e,s)=>{const r=document.createElement("div");r.innerHTML=document.getElementById("selectSubtitleModalTemplate_v15").innerHTML,document.body.appendChild(r);const n=r.querySelector("div"),i=()=>{document.body.removeChild(r)},a=n.querySelector("select");for(let e=0,s=t.length;e<s;e++){const{lang:s,name:r}=t[e],n=document.createElement("option"),i=`[ ${s} ]  ${r}`;n.setAttribute("value",e),n.innerHTML=i,a.appendChild(n)}n.querySelector(".close-modal").addEventListener("click",(()=>{s({message:"cancelled"}),i()})),n.querySelector("button").addEventListener("click",(()=>{e({subtitle:a.selectedIndex}),i()})),n.classList.add("active")}))},le=e=>{document.getElementById("important_hls").style.display="none",document.getElementById("important_live").style.display="none",document.getElementById("important_capture").style.display="capture"===e?"inline":"none"},de={url:{}},ce=async e=>{qe&&console.log(...g(e?._master?._tab.id,"flush","start"));const t=e.isLive&&e.hasAltAudio?(e=>{let t=0;for(const s of e){const e=s.start.length;e>0&&s.start[e-1]>t&&(t=s.start[e-1])}let s=t;for(const t of e)t.start.length>0&&t.start[0]<s&&(s=t.start[0]);const r=[];for(const t of e){const{mimetype:e,init:s}=t;r.push({mimetype:e,init:s,moofs:[],mdats:[],start:[]})}for(let n=s;n<=t;n++){const t=[];for(let s=0,r=e.length;s<r;s++){const r=e[s].start.indexOf(n);-1!==r&&t.push(r)}if(t.length===e.length)for(let s=0,n=e.length;s<n;s++){const n=e[s],i=t[s],a=r[s];a.moofs.push(n.moofs[i]),a.mdats.push(n.mdats[i]),a.start.push(n.start[i])}}return r})(e.tracks):(e=>{const t=[];for(const s of e)if(s.init&&s.moofs.length>0){const e=s.moofs.slice(0),r=s.mdats.slice(0),n=s.start.slice(0),{mimetype:i,init:a}=s;t.push({mimetype:i,init:a,moofs:e,mdats:r,start:n})}return t})(e.tracks),{size:s,sourceType:r}=e;if(0===t.length||0===t[0].moofs.length)return null;const n={skipLiveKeyFrame:4===r,keyFrameComplement:4===r,modifyESDSTrackConfig:4===r,over4G:s>4e9,over13H:!1};try{const s=localStorage?.HLS_USE_OLD_BUILDER?P:O,r=await s(t,n,e),i=URL.createObjectURL(r);return de.url[i]=1,e._master.saveSettings(),i}catch(e){return console.log(...y(e.stack||e)),null}},ue=e=>(e.startsWith("//")&&(e=location.protocol+e),e),he=async(e,t)=>{const s=e?._master?._tab?.id,r=t?e._master.audioTracks[e._master.selected_audioLevel||0]:e._master.levels[e._master.selected_level];if(t&&(e.hasAltAudio=r?.details?.fragments?.length>0,!e.hasAltAudio))return;qe&&console.log(...g(s,"liveLoader"+(t?"(audio)":""),"start"));const n=t?"_audio":"",i=r.details,a=i.fragments,o=1e3*Math.max((i.averagetargetduration||i.totalduration/i.fragments)-.1,.5);let l=1,d=!1;const c=()=>{d=!1};e["destroyFunc"+n]=c;const{url:u,method:h}=i,m=new J(u,h),f=(e,t)=>{c(),qe&&console.log(...g(s,"liveLoader"+n+".stopLoadingPlayList",e||"")),t&&(l=t)},p=t=>{t='<span style="color:#f88;font-size:x-small">'+t+"</span>",e._master._tab.sendMessage(Re,{vId:e.vId,on:"error",message:t})},y=(t,s="#f88")=>{const r='<span style="color:'+s+';font-size:x-small" p="1">'+(Ve[t]||"")+"</span>";e._master._tab.sendMessage(Re,{vId:e.vId,on:"warn",message:r}),ct("warn",t)};let b=0;d=!0,(async()=>{for(;d;){try{const e=await m.load({retry:6,interval:300});if(300!==e.status)return 999===e.status?(p("[ FATAL ] Connection has been lost. It appears that the extension has been reset."),f("failed to load playlist, stop liveLoader"+n,1)):f("may be end of live : reason ( status_code : "+e.status+" )",1);{const e=m.details&&m.details.fragments||[];if(!(e.length>0))return f("end of live : reason ( details.fragments.length === 0 )",1);{let t=a[a.length-1];for(const n of e)n.sn>t.sn?(n.sn-t.sn>1&&(qe&&console.log("discontig fragments found","curFrag ",t.sn,"latestFrags",n.sn,"errCnt",b),y("warn_discontig_fragments_found")),a.push(n),n._n=t._n+1,n._parent=i,n.demuxer=r.details.demuxer,t=n,b=0):n.cc!==t.cc&&(qe&&console.log(...g(s,"liveLoader._loop","found current.cc !== previous.cc , continue")),y("warn_chapter_has_changed"));if(b++,b>=30)return f("end of live : reason ( errCnt === 30 )",1)}}}catch(e){f("failed to load playlist, stop liveLoader"+n,2),p("[ FATAL ] Failed to load index, "+(e.message||e))}await v(o)}})();let _=0;for(;d;){const s=a[_];if(s){const r=_<a.length-1?1:4,{data:i,error:o}=await be(s,r);if(!d)break;if(o){if(_<a.length-1){_++;continue}f("failed to fetch fragment, stop liveLoader"+n,1),p("Failed to fetch TS, abort, status : "+(o.status||"none"));break}try{await s.demuxer.demux({video:e,fragment:s,data:i})}catch(e){f("failed to demux, stop liveLoader"+n,2),p("[ FATAL ] Failed to demux : "+e.message);break}if(_++,!t&&(e.createPreviewOnce(),e.updateProgress(),5===_))for(let t=0,s=e.tracks.length;t<s;t++)if(!e.tracks[t].init){const s=e.index.audio===t?"error_no_audio":"error_no_video";e._master._tab.sendMessage(Re,{vId:e.vId,on:"warn",message:Ve[s]+Ve.error_try_capture})}}else await v(o)}f(),qe&&console.log(...g(s,"liveLoader"+(t?"(audio)":""),"stop")),1===l&&(await e.flush(),e.complete()),t||e._master._tab.sendMessage(Re,{on:"title",message:Ve.title_completed})},me=e=>{const t=e=>{"mdat"!==e.type&&(e.data=null,e.buffer=null);for(let s=0,r=e.children.length;s<r;s++)t(e.children[s])};return t(e)},fe=(e,t,s)=>{const{type:r,startPTS:n,endPTS:i,startDTS:a,endDTS:l,hasAudio:d,hasVideo:c,dropped:u,nb:h,data1:m,data2:f}=s;let p=0;if(!r.match(/audio|video/))return;if("audiovideo"===r)return((e,t,s)=>{const{type:r,startPTS:n,endPTS:i,startDTS:a,endDTS:o,hasAudio:l,hasVideo:d,dropped:c,nb:u,data1:h,data2:m}=s,f=new R(new Uint8Array(h)),p=z(f);if(1===p.length){const s=p[0];for(let r=0;r<s.root.moofs.length;r++){const n=s.root.moofs[r],i=e.getTrackByNumber(n.traf.tfhd.trackID),a=i.moofs.length;i.moofs[a]=n,i.mdats[a]=new Blob([s.root.mdats[r].data]),i.start[a]=1e9*t.cc+a}for(let s=0;s<e.tracks.length;s++)e.tracks[s].duration+=t.duration}else{let s=t._n,r=0;for(const n of p){const i=e.getTrackByNumber(n.root.moof.traf.tfhd.trackID);p.length>2?(s=i.moofs.length,r<2&&(i.duration+=t.duration),r++):i.duration+=t.duration,i.moofs[s]=n.root.moof,i.mdats[s]=n.mdat,i.start[s]=1e9*t.cc+t.sn+.01*r}}e.size+=h?.byteLength||0})(e,t,s);const g=e.getTrackByType(r);let y=g.init;const b=t._n;if(y&&y.id.includes("void")&&f&&MpegAudio.isHeader(f,0)){const e=MpegAudio.parseHeader(f,0);y=g.init=(e=>{const{sampleRate:t,channelCount:s}=e,r=new R,n=r.root;n.append(new R.Box("moov"));const i=R.Box.create("mvhd",null,{timeScale:t,duration:0,rate:65536,volume:256,matrix:[65536,0,0,0,65536,0,0,0,1073741824],preDefined:24,nextTrackID:0});n.moov.append(i),n.moov.append(new R.Box("trak"));const a=n.moov.trak,o=R.Box.create("tkhd",null,{flags:3,trackID:1,duration:0,layer:0,alternateGroup:1,volume:256,matrix:[65536,0,0,0,65536,0,0,0,1073741824]});a.append(o),a.append(new R.Box("mdia"));const l=R.Box.create("mdhd",null,{timeScale:t,duration:5120,languageValues:21956});a.mdia.append(l);const d=R.Box.create("hdlr",null,{handlerType:"soun",name:"SoundHandler"});a.mdia.append(d),a.mdia.append(new R.Box("minf")),a.mdia.minf.append(R.Box.create("smhd")),a.mdia.minf.append(new R.Box("dinf")),a.mdia.minf.dinf.append(R.Box.create("dref",null,{entryCount:1,entrySize:12,typeText:"url ",entryVersion:0,entryFlags:1})),a.mdia.minf.append(new R.Box("stbl"));const c=R.Box.create("stsd",[["version","int",1],["flags","int",3],["entryCount","int",4],["entrySize","int",4],["code","text",4],["reserved","int",3],["reserved2","int",3],["dataReferenceIndex","int",2],["reserved3","int",8],["channelCount","int",2],["sampleSize","int",2],["reserved4","int",4],["sampleRate","int",2],["reserved5","int",2]],{entryCount:1,entrySize:36,code:".mp3",dataReferenceIndex:1,channelCount:s,sampleSize:16,sampleRate:t});return a.mdia.minf.stbl.append(c),n.moov.append(new R.Box("mvex")),n.moov.mvex.append(R.Box.create("trex",null,{sampleDescriptionIndex:1,sampleFlags:65537})),r.id=`audio/mp3:${n.moov.trak.mdia.mdhd.timeScale}`,n.arrange(),r})(e)}if(m&&!f){const e=new R(new Uint8Array(m));for(let s=0;s<e.root.moofs.length;s++){const r=g.moofs.length,n=e.root.moofs[s],i=n.offset,a=i+n.wholeSize;tt.priority===o?(me(n),g.moofs[r]=n):g.moofs[r]=new Blob([m.slice(i,a)]),g.mdats[r]=new Blob([e.root.mdats[s].data]),g.start[r]=1e9*t.cc+t.sn,p+=a-i+g.mdats[r].size}}else if(y&&y.id.includes("mp3")){if(!f)return;const{moof:e,mdat:s}=(e=>{const t=[],s=e.length;for(let r=0;r<s;){const s=MpegAudio.parseHeader(e,r);if(!s)break;const n=s.frameLength;t.push({duration:s.samplesPerFrame,size:n}),r+=n}const r=new R;r.root.append(new R.Box("moof")),r.root.moof.append(new R.Box("traf")),r.root.moof.traf.append(R.Box.create("tfhd",[["version","int",1],["flags","int",3],["trackID","int",4],["defaultSampleFlags","int",4,"if",32]],{flags:32,defaultSampleFlags:65536})),r.root.moof.traf.append(R.Box.create("tfdt",null,{}));const n=R.Box.create("trun",null,{flags:768,sampleCount:t.length,samples:t});r.root.moof.traf.append(n),r.root.arrange();const i=new Uint8Array(8),a=s+8;return i.set([a>>24&255,a>>16&255,a>>8&255,255&a,109,100,97,116]),{moof:r,mdat:new Blob([i,e])}})(f);g.moofs[b]=e,g.mdats[b]=s,g.start[b]=1e9*t.cc+t.sn,p=f.byteLength}else{if(!m||!f)return;if(tt.priority===o){const e=new R(new Uint8Array(m));me(e.rootBox),g.moofs[b]=e}else g.moofs[b]=new Blob([m]);g.mdats[b]=new Blob([f]),g.start[b]=1e9*t.cc+t.sn,p=m.byteLength+f.byteLength}g.duration+=t.duration,e.size+=p};class pe{constructor(e){this.demuxer=new ee(e.details.initSegment.data||[],e.audioCodec,e.videoCodec,e.details.totalduration),this.prevSN=-1,this.prevCC=-1,this.prevError=null}async demux(e){const{video:t,fragment:s,data:r}=e,n=isNaN(s.startDTS)?s.start:s.startDTS;try{const e=s.sn===this.prevSN+1&&s.cc===this.prevCC&&!this.prevError;this.prevError=null,this.prevSN=s.sn,this.prevCC=s.cc;const i=await this.demuxer.demux(r,s.decryptdata,n,!0,e),a=i[HlsEvents.FRAG_PARSING_INIT_SEGMENT];a&&((e,t,s)=>{let r=s.tracks;r.audiovideo&&(r=(e=>{const t=new R(e.initSegment).root;if(!t.moov)return e;const{container:s,codec:r}=e,n={};for(let e=0,i=t.moov.traks.length;e<i;e++){const i=new R,a=i.root;t.ftyp&&a.append(t.ftyp),a.append(new R.Box("moov")),a.moov.append(t.moov.mvhd),a.moov.append(new R.Box("mvex")),a.moov.mvex.append(t.moov.mvex.trexs[e]),a.moov.append(t.moov.traks[e]),a.arrange(),n["vide"===t.moov.traks[e].mdia.hdlr.handlerType?"video":"audio"]={initSegment:i,container:s,codec:r,isMP4:!0}}return n})(r.audiovideo));for(const t in r){if(!t.match(/audio|video/))continue;const s=r[t],n=e.getTrackByType(t);if(s.initSegment){const e=s.isMP4?s.initSegment:new R(s.initSegment),r=e.root&&e.root.moov;e.id=r?`${s.container}:${s.codec}:${r.trak.tkhd.width}:${r.trak.tkhd.height}:${r.trak.mdia.mdhd.timeScale}`:`${s.container}:${s.codec}:void`,n.init=e,He&&console.log(...g("","onFragParsingInitSegment",`  >> found ${t} initSegment`))}try{if("video"===t){const e=n.init.root.moov.trak.tkhd;n.quality=Math.floor(e.width/65536+.4)+" x "+Math.floor(e.height/65536+.4)}else{const e=n.init.root.moov.trak.mdia.mdhd;n.quality=e.timeScale+" Hz"}}catch(e){n.quality=""}}e.updateQualityLabel()})(t,0,a);const o=i[HlsEvents.FRAG_PARSING_DATA];if(o)for(const e of o)fe(t,s,e)}catch(e){if(He&&e.stack&&console.log(...y(e.stack)),He&&console.log(...g("","Demuxer.demux",(e.fatal?"FATAL, ":"Continue, ")+e.message)),e.fatal)throw e;this.prevError=e}}}const ge=e=>{const t=(e?.match(/https?:\/\/([^\/]+)/)||[])[1]||"";return"localhost"!==t&&!t.includes(".")},ye=(e,t)=>(e&&t&&(e=e.replace(/(https?:\/\/)([^\/]+)/,"$1"+t)),e),be=async(e,t,s)=>{if(t=Math.max(1,Math.min(5,t||1)),e.decryptdata&&null!=e.decryptdata.uri&&null==e.decryptdata.key)return{error:new Error("HLS-encryption is not supported : abort"),data:null};He&&console.log(...((e,t)=>[`Load Fragment :     -   CC:${t.cc} , SN:${t.sn} , start:${void 0!==t.start?t.start:""}  ${t.url}`])(0,e)),He&&console.log("Detect byterange : ",JSON.stringify(e._byteRange));let r=e.url;const n=e._parent,i=e._byteRange?{Range:"bytes="+e._byteRange[0]+"-"+(e._byteRange[1]-1)}:{};if(!r)return{error:"no url",data:null};const a=Qe(3,r,n.dnr_headers);let o=null;for(let l=0;l<t;l++){try{const t=(l+(n.succeed_headers_index||0))%a.length,d=a[t];await et.set(d);const c=await Y({url:r,method:"GET",headers:i,timeout:s});if(c.ok){const s=await c.arrayBuffer();return e.loaded=s.byteLength,e.autoLevel=!1,t>0&&(n.succeed_headers_index=t),n.succeed_hostname=(r.match(/https?:\/\/([^\/]+)/)||[])[1],{error:null,data:s}}{He&&console.log(...g("","fetchFragment","retry fetch at fetchFragment , "+(l+1)));const e=c.status;if(408===e)return{error:e,data:null};o=e}}catch(e){if(408===e.status)return{error:e,data:null};-1===e.status&&ge(r)&&(r=ye(r,n.succeed_hostname)),He&&console.log(...g("","fetchFragment","retry fetch at fetchFragment , "+(l+1))),o=e}await v(350)}return{error:o,data:null}},ve=async e=>{if(e){const t=e.details;if(t){if(t.initSegment){t.initSegment._parent=t;const{data:e,error:s}=await be(t.initSegment);t.initSegment.data=s?null:new Uint8Array(e)}else t.initSegment={data:null};const s=new pe(e);t.demuxer=s;let r=0,n=-1;for(const e of t.fragments)n!==e.cc&&(n=e.cc,r=0),e._parent=t,e.demuxer=s,e._n=r,r++}}},_e=async(e,t={})=>{const{levels:s,audioTracks:i,subtitles:a,settings:o,selected_audioLevel:l}=e;let{level:d,quality:c,audioLevel:u}=t;const h=c||o.quality;d=h===n?0:h===r?s.length-1:d||o.level,d=Math.max(0,Math.min(s.length-1,d));let m=s[d];if(void 0===u){const t=i.filter((e=>e.groupId===m.attrs.AUDIO)),s=t.find((e=>e.default))||t[0],r=i[l],n=t.includes(r)?r:s;u=e.audioTracks.indexOf(n)}u=Math.max(0,Math.min(i.length-1,u));const f=i[u];if(qe&&(console.log(...g(e._tab.id,"selectLevel","current - Audio "+l+" , Video "+o.level+" ( "+o.quality+" )")),console.log(...g(e._tab.id,"selectLevel","request - Audio "+t?.audioLevel+" , Video "+t?.level+" ( "+c+" )")),console.log(...g(e._tab.id,"selectLevel","result  - Audio "+u+" , Video "+d))),void 0!==t.level&&(e.settings.level=d,e.settings.quality=c,e.saveSettings(),e.selected_level===d&&e.selected_audioLevel===u))return{status:2};if(await ve(m),await ve(f),!m?.details){let e=!1;for(let t=0;t<s.length;t++)if(t!==d&&s[t].details){d=t,m=s[d],await ve(m),e=!0;break}if(!e)return{status:-1,message:"Failed to init the level of quality, abort."}}if(!m?.details?.live||!e?._tab?.settings?.blockLive){e.setLevel(d,u),e.video?.destroy();for(const t of e.archives)t.destroy();return e.archives=[],e.updateUI("level initialized"),m.details.live?new Te(e,!0).start().catch((e=>{qe&&console.log(...y(e.stack))})):new Te(e).start().catch((e=>{qe&&console.log(...y(e.stack))})),{status:1}}};class Se{constructor(e,t,s){this._master=e,this.settings=Object.assign({},e.settings),this.vId=Math.floor(1e8*Math.random()),this.sourceType=s,this.tracks=[],this.index={},this.size=0,this.isPreviewed=!1,this.isLive=t,this.hasAltAudio=!1,this._master.video=this,this.mId=e.mId,this.stat=1,this.blobURL=null,this.dateLabel=S(),this.attempt_saving_count=0}async load(){this.stat=2,this._master._tab.sendMessage(Le,{vId:this.vId,action:2})}async pause(e){this.stat=1,this._master._tab.sendMessage(Le,{vId:this.vId,action:1,message:e})}complete(){this.stat=3,this._master.archives.push(this)}destroy(){this.blobURL&&(URL.revokeObjectURL(this.blobURL),delete de.url[this.blobURL],this.blobURL=null),this.stat=4,this._master.video===this&&(this._master.video=null),this._master._tab.sendMessage(Le,{vId:this.vId,action:4}),qe&&console.log(...g(this._master._tab.id,"video.destroy","vId : "+this.vId))}updateQualityLabel(){let e="",t="";for(const s of this.tracks)s?.mimetype?.includes("video")&&(e=s.quality),s?.mimetype?.includes("audio")&&(t=s.quality);this.quality=e+(""!==e?" - ":"")+t}async updateUI(e){await this._master._tab.sendMessage(xe,{signature:e,video:_(this,["demuxer","data","fragments","moofs","mdats","rootBox","parent"])})}async updateProgress(e){const t=this.tracks[0]?.duration;await this._master._tab.sendMessage(De,{vId:this.vId,size:this.size,duration:t,quality:this.quality,progress:e})}async flush(){if(4!==this.stat){const e=await ce(this);if(e)return this.blobURL&&this.blobURL!==e&&(URL.revokeObjectURL(this.blobURL),delete de.url[this.blobURL]),this.blobURL=e,await this._master._tab.sendMessage(Ie,{vId:this.vId,p:"flush"}),!0}return!1}async createPreviewOnce(e){if(!this.isPreviewed){e=e||0;for(const t of this.tracks)if(t.init&&t.mimetype.includes("video")&&t.moofs.length>e&&t.mdats.length>e){this.isPreviewed=!0;const e=await ce(this);e?(await this._master._tab.sendMessage(Ie,{vId:this.vId,url:e,p:"preview"}),URL.revokeObjectURL(e),delete de.url[e]):this.isPreviewed=!1;break}}}getTrackByType(e){return void 0===this.index[e]&&(this.index[e]=this.tracks.length,this.tracks.push({init:null,moofs:[],mdats:[],start:[],durations:[],duration:0,mimetype:e,quality:""})),this.tracks[this.index[e]]}getTrackByNumber(e){for(const t of this.tracks)if(t.init?.root?.moov?.trak?.tkhd?.trackID===e)return t;return null}clearAllTracks(){for(const e of this.tracks)this.clearTrack(e)}clearTrack(e){e.moofs=[],e.mdats=[],e.start=[],e.durations=[],e.duration=0}get qualityLabel(){let e="",t="";for(const s of this.tracks)s.init&&(s.mimetype.includes("video")&&(e=s.quality),s.mimetype.includes("audio")&&(t=s.quality));return e+(""!==e?" - ":"")+t}assign(e){for(const t in e)this[t]=e[t]}}class Te extends Se{constructor(e,t,s){super(e,t,2),this.isLive=t,this.contig=!1,this.parallel_max=1,s&&this.inherit(s),this.updateUI("new_hlsvideo")}inherit(e){const{tracks:t,index:s,isLive:r}=e,n=[];for(const e of t){const{mimetype:t,init:s}=e;n.push({mimetype:t,init:s,moofs:[],mdats:[],start:[],durations:[]})}this.tracks=n,this.index=s,this.isLive=r}async start(){super.load(),this.isLive?(he(this,!0),await he(this)):await(async e=>{const t=e._master._tab.id;qe&&console.log(...g(t,"hlsLoader","start"));const s=e._master.levels[e._master.selected_level],r=e._master.audioTracks[e._master.selected_audioLevel||0];e.hasAltAudio=r?.details?.fragments?.length>0;const n=(e=>{const t=1e5;return e.sort(((e,s)=>e.cc*t+e.start-(s.cc*t+s.start))),e})([...s.details.fragments,...e.hasAltAudio?r.details.fragments:[]]),i={};let a=0,o=n[0].cc;for(let e=0,t=n.length;e<t;e++){const t=n[e];o!==t.cc&&(i[o]=a,o=t.cc,a=0),a++}i[o]=a;const l=e.contig||0;o=n[l].cc;const d=(location.href.match(/start=(\d+)/)||[])[1],c=(location.href.match(/stop=(\d+)/)||[])[1],u=0===l&&d&&!e.hasAltAudio?Math.max(0,Number(d)):l,h=0===l&&c&&!e.hasAltAudio?Math.min(n.length,Number(c)):n.length,m={max:Math.min(h-u,i[o]),current:0,offset:u},f=(new Date).getTime(),p={},y={},b={},v=(e,t)=>{e[t=t||0]&&(e[t](),delete e[t])},_=(e,t)=>new Promise(((s,r)=>{v(e,t=t||0),e[t]=s}));let S=u,T=h;for((async()=>{let s=0,r=u,i=h;try{for(;r<i&&r<n.length;){for(;s<e.parallel_max&&r<S+30&&(await e.wait(),!(r>=i||r>=n.length));){const i=n[r];if(i.__fragment_index__=r,o!==i.cc){qe&&console.log(...g(t,"hlsLoader, chapter changed,",o+"->"+i.cc));const n=new Te(e._master,!1,e);return n.contig=r,await n.start(),s=S=99999,v(p,i.__fragment_index__)}(async t=>{const n=t.__fragment_index__;s++;const{data:i,error:a}=await be(t,6);s--,v(p,n),v(b),a?(e.pause("Failed to fetch TS, "+(a.status||a.message)),r=n,await e.wait()):t._data=i})(i),r++}s>=e.parallel_max&&await _(b),r>=S+30&&await _(y)}}catch(e){qe&&console.log(...g(t,"hlsLoader",e?.stack||e?.message||e))}})();S<T;){const t=n[S];if(t._data){try{await t.demuxer.demux({video:e,fragment:t,data:t._data})}catch(t){const s=Ke[e?.vId];if(s){const e=s.ignoreMasterIndex;e&&(e.style.display="inline",e.href=location.href+"&ignore-master-index")}e.pause("[ FATAL ] Failed to demux : "+t.message);break}delete t._data,v(y),S++,m.current++,e.createPreviewOnce(),e.updateProgress(m)}else await _(p,S)}if(qe){const e=(new Date).getTime();console.log(...g(t,"hlsLoader","load all fragments, "+h+" / "+h)),console.log(...g(t,"hlsLoader","time : "+(e-f)))}await e.flush(),e.complete(),e._master._tab.sendMessage(Re,{on:"title",message:Ve.title_completed+" - "+h+" / "+h})})(this)}async wait(){return new Promise(((e,t)=>2===this.stat?e():4===this.stat?t({message:"receive VIDEO_STATUS.DESTORY"}):void(this.pauseResolver=e)))}async destroy(){super.destroy(),this.destroyFunc&&this.destroyFunc(),this.destroyFunc_audio&&this.destroyFunc_audio(),this.destroyFunc=this.destroyFunc_audio=null}}class Ae extends Se{constructor(e,t,s){if(super(e,!0,4),s){const{tracks:e,index:t}=s;this.assign({tracks:e,index:t})}this.mediasourceid=t,this.bufferid_to_trackId={},this.updateUI("new_capturedvideo")}}const we=class{constructor(e,t,s,r,n,i=null){this._tab=e,this.mId=i||Math.floor(1e8*Math.random()),this.url=t,this.levels=s instanceof Array?s:s?[s]:[],this.audioTracks=r instanceof Array?r:r?[r]:[],this.subtitles=n instanceof Array?n:n?[n]:[],this.video=null,this.archives=[],this.settings=Object.assign({},e.settings),this.selected_level=this.settings.level,this.selected_audioLevel=null}async updateUI(e){await this._tab.sendMessage(Ee,{master:_(this,["demuxer","data","fragments","moofs","mdats","rootBox","parent"]),signature:e})}setLevel(e,t){this.selected_level=e,this.selected_audioLevel=t}getLevel(){}saveSettings(){const e=T(this._tab.url),t=tt.domain[e],s=this.settings.quality,r=this.settings.level,n=this._tab.mode;t&&t.quality===s&&t.level===r&&t.mode===n||(tt.domain[e]||={},Object.assign(tt.domain[e],{quality:s,level:r,mode:n}),st(tt))}},ke=class{constructor(e,t){this.id=e,this.parentTabId=t.id,this.url=t.url||"",this.title=t.title||"no-title",this.mode=1,this.foundMasterIndex=!1,this.mastersList=[],this.origin=(this.url.match(/https?:\/\/[^\/]+/)||[])[0]||"noOrigin";const s=T(this.url),n=tt.domain[s]||{};this.settings=Object.assign({level:0,quality:r,mode:1,ignoreHLSDiscontinuity:!1,blockLive:!1},n),this.suppressIndex=!1}get isLoader(){return this.parentTabId}async consume(e){if(this.suppressIndex&&this.mastersList.length>0)return;const t=await(async(e,t)=>{let s=[];const r=t=>{for(const s of e.mastersList)if(s.url===t)return!0;return!1};for(const n of t){if(n.processed)continue;n.processed=!0;const{method:t,headers:i}=n,a=i.Referer||i.referer||i.REFERER||"",o=i.Origin||i.origin||i.ORIGIN,l=o&&"null"!==o?o:(a.match(/https?:\/\/[^\/]+/)||[])[0]||"",d=URLToolkit.buildAbsoluteURL(l,n.url,{alwaysNormalize:!0});if(r(d))continue;const c=location?.href?.includes("ignore-master-index");try{const r=new J(d,t);let n=await r.load();if(300===n.status){if(r.isMaster){if(c)continue;e.foundMasterIndex||(s=[],e.foundMasterIndex=!0);const n=r.master,{levels:i,audioTracks:a,subtitles:o}=n;s.push(new we(e,d,i,a,o));{const e=[],s=[];for(const n of[...i,...a]){if(!n.url)continue;const i="string"==typeof n.url?n.url:n.url[0],a=URLToolkit.buildAbsoluteURL(l,i,{alwaysNormalize:!0}),o=new J(a,t,r);e.push(o.load()),s.push({level:n,subList:o})}const n=await Promise.all(e);for(let e=0;e<n.length;e++){const r=n[e];if(300===r.status){const{level:n,subList:i}=s[e];i.isLevelDetail?(n.details=i.details,n.details.dnr_headers=r.dnr_headers,n.details.succeed_headers_index=r.succeed_headers_index,n.details.method=t):He&&console.log("Skip error at subList.load",subListUrl,r.status)}}}}else if(r.isLevelDetail&&!e.foundMasterIndex){const i={attrs:{},audioCodec:null,videoCodec:null,width:0,height:0,bitrate:0,details:r.details,url:d};i.details.dnr_headers=n.dnr_headers,i.details.succeed_headers_index=n.succeed_headers_index,i.details.method=t,s.push(new we(e,d,i))}}else He&&console.log("Skip error at playList.load",d,n.status,n.message)}catch(e){qe&&console.log(...y(e.stack||e.message||e))}}return s})(this,e);t.forEach((e=>_e(e))),this.mastersList.push(...t),this.mastersList.length>1&&dt()}sendMessage(e,t){ze({cmd:e,params:t})}findMaster(e){return this.mastersList.find((t=>t.mId===e))}findVideo(e){for(const t of this.mastersList){if(t.video?.vId===e)return{master:t,video:t.video};for(const s of t.archives)if(s.vId===e)return{master:t,video:s}}return{master:null,video:null}}};Object.assign(ke,{TAB_ID:0,PARENT_ID:1,CHILD_ID:2});const De="cmd_internal_update_video_progress",Ee="cmd_internal_update_master",xe="cmd_internal_update_video",Le="cmd_internal_update_ui",Ie="cmd_internal_flushed",Re="cmd_internal_message",Me="cmd_internal_subtitle_progress",Ce="cmd_ui_select_option",Oe="cmd_ui_resume",Pe="cmd_ui_pause",Ue="cmd_ui_cancel",Be="cmd_ui_save",Fe="cmd_ui_download_subtitle",Ne="cmd_ui_set_parallel",ze=(e,t,s)=>{const{cmd:r,params:n}=e;if(s||(s=()=>{}),r!==De&&qe&&console.log(...g(je?.id,"internalMessage(received)",r)),r===Ee){const e=JSON.parse(n.master);at(e)}else if(r===xe){const e=JSON.parse(n.video);lt(e)}else if(r===De){const e=Ke[n.vId];e&&e.update_videoProgress(n)}else if(r===Le){const{vId:e,action:t,message:s}=n,r=Ke[e];r&&(2===t?r.start():1===t?r.pause(s):4===t&&(r.removeSelf(),delete Ke[e]))}else if(r===Ie){const{vId:e,url:t}=n,r=Ke[e];if(t)return fetch(t).then((e=>e.blob())).then((e=>{if(r?.video){const t=r.video,s=()=>{r.video.currentTime=10,r.video.pause(),t.removeEventListener("play",s)};t.autoplay=!0,t.muted=!0,t.addEventListener("play",s),t.src=URL.createObjectURL(e)}s({result:!0})})).catch((e=>{s({result:!1})})),!0;r&&r.terminate()}else if(r===Re){const{vId:e,on:t,message:s}=n;if("title"===t)document.title=s;else if(e){const r=Ke[e];r&&r.setMessage(t,s)}}else if(r===Me){const{vId:e}=n,t=Ke[e];t&&t.update_subtitleProgress(n)}s({result:!0})},Ge=async e=>{const{cmd:t,params:s}=e,r=je;if(t===Ce){const{mId:e}=s,t=r.findMaster(e);return t?await _e(t,s):{status:-1,message:"Internal error at CMD_UI_SELECT_OPTION. Please tell the message to the developer."}}if(t!==Oe)if(t!==Pe)if(t!==Ue)if(t!==Be)if(t!==Fe)if(t!==Ne);else{const{vId:e,parallel_max:t}=s,{master:n,video:i}=r.findVideo(e);i&&(i.parallel_max=Math.min(6,Math.max(1,t)))}else{const{subtitle:e,mId:t,vId:n}=s,i=r.findMaster(t);if(i){const t=await(async(e,t,s)=>{const r=e.subtitles?.[t];if(r){const t=new J(r.url);if(300===(await t.load()).status){const n=[],i=t.details.fragments,a=i.length;for(let t=0;t<a;t++){const r=i[t],o=await fetch(r.url,{method:"GET"});if(!o.ok)return!1;{const r=await o.text();n.push(r),n.push("\n\n"),await e._tab.sendMessage(Me,{vId:s,current:t,total:a})}}const o=new Blob(n,{type:"text/vtt"});if(o){const t=URL.createObjectURL(o);if(t){const s=document.createElement("a");return s.href=t,s.download=(e?._tab?.title||"no_title")+"_"+r.lang+"_"+r.name+".vtt",s.click(),!0}}}}return!1})(i,e,n);return t}}else{const{master:e,video:t}=r.findVideo(s.vId);if(t){const e=e=>{const s=document.createElement("a");s.href=e,s.download=(t?._master?._tab?.title||"no-title")+(t.isLive?t.dateLabel:"")+".mp4",t.attempt_saving_count&&(s.download="Rescued_video_"+t.dateLabel+".mp4"),s.click()};if(t.blobURL&&!t.attempt_saving_count)e(t.blobURL),t.attempt_saving_count++;else{const s=await ce(t);e(s),URL.revokeObjectURL(s),delete de.url[s]}}}else{const{vId:e}=s,{master:t,video:n}=r.findVideo(e);n&&n.destroy()}else{const{vId:e}=s,{master:t,video:n}=r.findVideo(e);n&&n.pause()}else{const{vId:e}=s,{master:t,video:n}=r.findVideo(e);n&&(n.pauseResolver&&(n.pauseResolver(),n.pauseResolver=null),n.load())}},qe=localStorage.hls_log,He="verbose"===qe,Ve=((e=s)=>{const t={};for(const s of e)t[s]=A.i18n.getMessage(s);return t})();let je=null;const $e={},Ke={},Xe=(()=>{const e=[null,void 0,!0,!1,"type","url",...f],t=["null","undefined","true","false","type","url",...f],s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_=",r=" !$%&()*+./;<>?@^|",n=64,i=e=>e?(e.timestamp=(new Date).getTime(),e.items.hashmap):(console.error("no keyvalue"),[]),a=(e,t,i)=>{let a=t.indexOf(e);if(-1===a){if(i)return"~~~~";t.push(e),a=t.length-1}return a<n?s[a]:a<1088?r[Math.floor(a/n)]+s[a%n]:r[Math.floor(a/1088)%17]+r[Math.floor(a/n)%17]+s[a%n]},o=(e,t)=>{if(null===e)return t.indexOf(e);const s=typeof e;if("undefined"===s)return t.indexOf(e);if("boolean"===s)return t.indexOf(e);if("number"===s)return"#"+e.toString(32)+"#";if("string"===s)return a(e,t);if(null!=e.length){const s=[];for(const r of e)s.push(o(r,t));return s}{const s={};for(const r in e)s["~"+a(r,t)]=o(e[r],t);return s}},l=(t,s)=>{const r=i(s);0===r.length&&r.push(...e);const n=o(t,r);return JSON.stringify(n).replace(/[":,~]/g,"")},d=(e,a,o)=>{const l=i(a),d=[];let c=null,u=!0,h=!1,m=!1,f=-1;const p=()=>{d.push(u&&!h?":":","),u=!u};for(let i=0;i<e.length;i++){const a=e[i];if("#"===a)m=!m,m?f=0:(d.push(f),p(),f=-1);else if(m)"-"!==a&&(f=32*f+parseInt(a,32),"-"===c&&(f*=-1));else{const e=s.indexOf(a),i=r.indexOf(a);if(e<0&&i<0){const e="}"===a||"]"===a;e&&","===d[d.length-1]&&d.pop(),d.push(a),u="{"===a,"["===a?h=!0:"]"===a&&(h=!1),e&&p()}else if(e>=0){if(f=-1===f?e:f*n+e,f<4)d.push(t[f]);else{if(void 0===l[f])return console.log(f),console.log(JSON.stringify(l)),null;if(!l[f].replaceAll)return console.error(f),console.error(l[f]),null;d.push('"'+l[f].replaceAll('"','\\"')+'"')}p(),f=-1}else f=-1===f?i:17*f+i}c=a}","===d[d.length-1]&&d.pop();const g=d.join("");return o?g:JSON.parse(g)};return{compress:l,decompress:d,compress_x2:(e,t)=>{const s={...e},{type:r,url:n}=s;delete s.type,delete s.url;const i=n.match(/(^[^:]+:\/\/[^\/]+\/)(.*?)([^\/]*$)/);i||console.error(n);const a=l(s,t).match(/\{([^\{]+)\{([^\}]*)/),o={type:r,url:i.slice(1,4),request:a[2],response:a[1]};let d=l(o,t).replace(/[{}]/g,"");return d=d[1]+d.substr(3),d},decompress_x2:(t,s,r)=>{t=e.indexOf("type")+t[0]+e.indexOf("url")+t.substr(1);const n=d("{"+t+"}",s);if(!n?.url)return console.error(JSON.stringify(n)),null;const i=n.url.join(""),{type:a,request:o,response:l}=n,c=d("{"+l+"{"+o+"}}",s);if(!c)return console.error("error at decompressed_2nd",i,JSON.stringify(o||{}),JSON.stringify(l||{})),null;const u=Object.assign({type:a,url:i,...c});return r?JSON.stringify(u):u},hash:(e,t)=>{const s=i(t);return a(e,s,!0)}}})(),Ye={hashmap:[],indexes:[],fragments:[],fragment_urls:{},candidate_headers_by_url:{},candidate_headers_by_path:{},candidate_headers_by_origin:{}},Je=(e,t,s)=>{if(!e)return null;const r={...e};if(t)for(const e in r)t.includes(e.toLowerCase())&&delete r[e];return s&&Object.assign(r,s),r},We=(e,t)=>{if(!e)return null;for(const s in e)if(t.includes(s.toLowerCase()))return{k:e[s]};return!1},Qe=(e,t,s,r)=>{const{base_headers:n={},exclude_headers:i=[]}=r||{},{origin:a,path:o,filename:l}=h(t);let d=Ye.candidate_headers_by_url[t]||Ye.candidate_headers_by_path[o]||Ye.candidate_headers_by_origin[a];const c=[],u=[{priority:1,url:t,h:Ye.candidate_headers_by_url},{priority:2,url:o,h:Ye.candidate_headers_by_path},{priority:3,url:a,h:Ye.candidate_headers_by_origin}];for(const{priority:t,url:s,h:r}of u)e===t&&(d=Je(d,["range","cookie"],n),d&&(c.push({priority:t,url:s,headers:d}),We(d,["referer","origin"])&&(d=Je(d,["referer","origin"]),d&&c.push({priority:t,url:s,headers:d}))));return 0===c.length&&(s?c.push(...Ze(e,s,t,r)):c.push({priority:4,url:t,headers:null})),c},Ze=(e,t,s,r)=>{const{base_headers:n={},exclude_headers:i=[]}=r||{},{origin:a,path:o,filename:l}=h(s),d=structuredClone(t);for(const t of d)t.url=1===e?s:2===e?o:a,t.priority=e,Object.assign(t,n);return d},et=(()=>{const e=[0,0,0,0,0,0],t=[0,100,200,300,400,500],s=[1,20,50,100,10,10],r={};return{set:async({url:n,headers:i,excludes:a,priority:o=1})=>{if(i){const l=JSON.stringify(i),d=r[n];if(d){if(d.serialized===l)return}else e[o]++;const c=t[o]+e[o]%s[o],u={itemId:c,url:n,headers:i,excludes:a,priority:o};for(const e in r)if(e!==n&&r[e]?.itemId===c){delete r[e];break}r[n]={itemId:c,serialized:l,priority:o},await rt({cmd:"l2b_set_dnr_session_rule",params:u})}}}})(),tt=function(){const e=localStorage.hls_option;let t={uuid:"",counter:0,version:"",domain:{}};try{e&&Object.assign(t,JSON.parse(e)),t.counter=Math.max(0,Math.floor(Number(t.counter)||0)),localStorage.hls_option=JSON.stringify(t)}catch(e){console.log(...y(e.stack))}return t}(),st=e=>{localStorage.hls_option=JSON.stringify(e)},rt=async(e,t)=>(async(e,t,s)=>(qe&&e===m&&console.log(...((e="",t,s,...r)=>[("number"==typeof e?"frameId ":"")+"%c"+e+"%c ["+t+"]%c "+(s="object"==typeof s?JSON.stringify(s):s||""),p(e),"color:#f60b91","",...r])(s,"sendMessageToSW",t.cmd.toUpperCase()+":"+JSON.stringify(t.params))),t.type=e,new Promise(((r,n)=>{try{A.runtime.sendMessage(t,(n=>{const i=A.runtime.lastError;qe&&i&&console.log(...g(s,"error@"+e+"("+t.cmd+")",JSON.stringify(t.params)+" "+JSON.stringify(i))),r(i?{error:i}:n)}))}catch(e){r({error:e.message})}}))))(m,e,t),nt=(e,t)=>{if(je.mode!==e||t){qe&&console.log(...g(je?.id,"set_mode",e)),je.mode=e,it(),ot();const t=document.querySelector(4===e?"#waitingData":"#waitingHLS");t&&(t.style.display="block")}(e=>{const t=e?["remove","add"]:["add","remove"],s=document.getElementById("runAsNormalLabel");s&&s.classList[t[0]]("text-gray");const r=document.getElementById("forceCaptureLabel");r&&r.classList[t[1]]("text-gray")})(1==e)},it=()=>{qe&&console.log(...g(je?.id,"remove_all","remove all videoUIs"));for(const e in $e)delete $e[e];for(const e in Ke)Ke[e].removeSelf(),delete Ke[e]},at=e=>{const t=e?.mId;t&&($e[t]=e)},ot=()=>{const e=document.querySelector("#waitingHLS");e&&"none"!==e.style.display&&(e.style.display="none");const t=document.querySelector("#waitingData");t&&"none"!==t.style.display&&(t.style.display="none")},lt=e=>{ot();const t=e?.vId;if(t){let s=Ke[t];s||(s=e.isLive?2===e.sourceType?new re(e):new ne(e):new se(e),Ke[t]=s)}},dt=()=>{const e=document.getElementById("suppressIndexButtonContainer");if("none"===e.style.display){const t=document.getElementById("suppressIndexButton");t.addEventListener("click",(async()=>{je.suppressIndex=t.checked})),e.style.display="block"}},ct=(e,t)=>{const s=document.getElementById("statistics");s&&(t?s.setAttribute(e,btoa(t)):s.removeAttribute(e),s.click())};document.addEventListener("DOMContentLoaded",(async()=>{const e=await rt({cmd:"l2b_notify_ready",params:{counter:tt.counter}});if(e){qe&&console.log(...g(null,"CMD_LtoB_NOTIFY_READY",JSON.stringify(e)));const{error:t,info:s,settings:r}=e;if(!t){const{id:e,root:t}=s;je=new ke(e,t),Object.assign(tt,r),st(tt),(()=>{const e=document.getElementById("forceCaptureButton");e.addEventListener("click",(async()=>{if(e.checked){const t=document.getElementById("forceCaptureModal");t.classList.add("active"),await new Promise(((e,s)=>{const r=t.querySelectorAll(".close-modal"),n=()=>{for(const e of r)e.removeEventListener("click",n);e(!1)};for(const e of r)e.addEventListener("click",n);const i=document.getElementById("confirmCaptureOKButton"),a=()=>{i.removeEventListener("click",a),e(!0)};i.addEventListener("click",a)}))?(rt({cmd:"l2b_intercept_request",params:{}}),nt(4)):(e.checked=!1,document.querySelector("#forceCaptureModal .modal-title").innerHTML=Ve.capture_reason_1,4===je.mode&&(nt(1),rt({cmd:l,params:{}}))),t.classList.remove("active")}else nt(1),rt({cmd:l,params:{}})})),document.querySelector("#forceCaptureModal .modal-title").innerHTML=Ve.capture_reason_1})(),4===je.settings.mode?(nt(4,!0),document.querySelector("#forceCaptureModal .modal-title").innerHTML=Ve.capture_reason_3,document.getElementById("forceCaptureButton").click()):(nt(1,!0),await rt({cmd:l,params:{}}));const n=document.getElementById("version");n&&(n.innerText="ver "+r.version),ct("version",r.version),ct("domain",T(t?.url||"")),document.querySelectorAll('[class*="v222"]').forEach((e=>{e.style.display=""}))}}})),A.runtime.onMessage.addListener((async(e,t,s)=>{const{cmd:r,params:n}=e;if(qe&&console.log(...g(je?.id,"onMessage",r)),"b2l_notify_found_file"===r){const{type:e,items:t,item:s}=n;t?(async e=>{const{hashmap:t,indexes:s,fragments:r}=e;Ye.hashmap.push(...t),Ye.indexes.push(...s),Ye.fragments.push(...r);let n=-1;const i=[];for(const e of s){const t=Xe.decompress_x2(e,{items:Ye});if(t){i.push(t);const{url:e,headers:s,contentType:r,suffix:a}=t,{origin:o,path:l,filename:d}=h(e);Ye.candidate_headers_by_url[e]=s,Ye.candidate_headers_by_path[l]=s,Ye.candidate_headers_by_origin[o]=s,(r?.match(/(mpegurl|m3u)/)||a?.match(/^(m3u8|m3u)$/))&&n<0&&(n=i.length-1),r?.includes("text")&&e?.includes("playlist")&&e?.match(/master|media|video/)&&ct("weakindex","found")}}n>0&&i.splice(0,n),i.length&&await je.consume(i);for(const e of r){const t=Xe.decompress_x2(e,{items:Ye});if(t){const{url:e,headers:s,type:r}=t,{origin:n,path:i,filename:a}=h(e);Ye.candidate_headers_by_origin[n]=s}}})(t):s&&(e=>{if(!e?.url)return;const{url:t,headers:s,type:r,contentType:n,suffix:i}=e,{origin:a,path:o,filename:l}=h(t);if("hi"===r){if(!n.match(/(mpegurl|m3u)/)&&!i.match(/^(m3u8|m3u)$/))return;Ye.candidate_headers_by_url[t]=s,Ye.candidate_headers_by_path[o]=s,Ye.candidate_headers_by_origin[a]=s,je.consume([e])}else Ye.candidate_headers_by_origin[a]=s})(s)}else"b2l_intercept_data"===r&&(async(e,t)=>{if(!e)return;const{url:s,mimetype:r,mediasourceid:n,bufferid:i,timestamp:a}=t;if(N&&console.log(...g(e?.id,"intercept_onData","mediaSourceId="+n+",bufferId="+i)),"b2l_disconnect_capture"===s){qe&&console.log(...g(e?.id,"intercept_onData","receive CMD_BtoL_DISCONNECT_CAPTURE"));for(const t of e.mastersList){const e=t.video;e&&(await e.flush(),e.complete())}return void e.sendMessage(Re,{on:"title",message:Ve.title_completed})}if(r.includes("webm"))return void(N&&console.log("webm detect, ignore"));let l=e.findMaster(n);l||(N&&console.log("    create new master "+n),l=new we(e,e.url,null,null,null,n),e.mastersList.push(l));let d=l.video;d||(d=new Ae(l,n));let{tracks:c,index:u}=d;if("abort"===s)return qe&&console.log(...g(e?.id,"intercept_onData","receive abort")),await d.flush(),d.complete(),void d._master._tab.sendMessage(Re,{on:"title",message:Ve.title_completed});const h=await(e=>new Promise(((t,s)=>{const r=new XMLHttpRequest;r.onreadystatechange=()=>{4===r.readyState&&200===r.status&&t(r.response)},r.open("GET",e),r.responseType="blob",r.send()})))(s),m=await K(h),f=new R(new Uint8Array(m));let p=0;const y=z(f);for(const t of y){let s,a=t.root.moov?.trak?.tkhd?.trackID||t.root.moof?.traf?.tfhd?.trackID;a?d.bufferid_to_trackId[i]=a:a=d.bufferid_to_trackId[i],s=i+(a||y.indexOf(t)%2+1),d=l.video;const h=t.root.moovs,f=t.root.moofs,g=t.root.mdats||t.mdat;void 0===u[s]&&(u[s]=c.length,c.push({init:null,moofs:[],mdats:[],start:[],durations:[],duration:0,contig:0,mimetype:r,quality:""}));const b=c[u[s]],v=e=>{e=e||0;const{moofDuration:s,moofStart:r}=q(b.init,t.root,e),n=t.root.moofs[e],i=r+Math.min(1e4,n.mfhd?.sequenceNumber||0)/1e8;return b._prev={sequenceNumber:i,moofStart:r,moofDuration:s},{moof:n,sequenceNumber:i,moofStart:r,moofDuration:s}};if(N){const e=r.includes("video")||r.includes("avc1"),s=r.includes("audio")||r.includes("mp4a"),{moofDuration:n,moofStart:i}=q(b.init,t.root),a=b.init?b.init.root.moov.trak.tkhd.width>0?"video":"audio":"unknown",o=[];s&&o.push("audio"),e&&o.push("video");const l=[];h&&l.push("initSegment"),f&&l.push("Moof"),g&&l.push("Mdat");const d=f?t.root.moofs.map((e=>e.mfhd.sequenceNumber)).join(","):"no-sequenceNumber";console.log(d+" -> ","("+o.join(",")+")","("+l.join(",")+")","start:"+i+", duration:"+n+", "+y.indexOf(t)+"-"+a)}if(h){b.init&&V(c)&&!U(b.init,t)&&(N&&console.log("    ---+--- new init segment found , flushed"),await d.flush(),d.complete(),d.clearTrack(b),d=new Ae(l,n,d)),b.init=t,b.init.id=r;const e=b.init.root.moov.trak;e&&(e.tkhd.width?(b.quality=Math.floor(e.tkhd.width/65536+.4)+" x "+Math.floor(e.tkhd.height/65536+.4),b.mimetype="video"):(b.quality=e.mdia.mdhd.timeScale+" Hz",b.mimetype="audio")),d.updateQualityLabel()}if(f){if(t.root.moofs[0]&&t.root.moofs[0].traf&&t.root.moofs[0].traf.senc)return void e.sendMessage(Re,{vId:d.vId,on:"error",message:Ve.drm_detected});if(G(b),t.isDivided){const{moof:e,sequenceNumber:s,moofStart:r,moofDuration:n}=v();b.moofs.push(t),b.start.push(s),b.durations.push(n),b.duration+=n}else for(let e=0,s=t.root.moofs.length;e<s;e++){const{moof:t,sequenceNumber:s,moofStart:r,moofDuration:n}=v(e),i=t.offset,a=i+t.wholeSize;-1===b.start.indexOf(s)&&(tt.priority===o?b.moofs.push(t):b.moofs.push(new Blob([m.slice(i,a)])),b.start.push(s),b.durations.push(n),b.duration+=n)}if(0===u[s]&&b.moofs.length>=5e3&&b.moofs.length%1e3==0){const e=Ve.warn_chunksize_excess.replace("NUM_CHUNKS",b.moofs.length);d._master._tab.sendMessage(Re,{vId:d.vId,on:"warn",message:'<span style="color:#f88;font-size:x-small">'+e+"</span>"})}}if(g)if(t.isDivided)b.mdats.push(t.mdat),p+=t.mdat.size;else if(f&&t.root.moofs.length===t.root.mdats.length)for(let e=0,s=t.root.mdats.length;e<s;e++){const{moof:s,sequenceNumber:r,moofStart:n,moofDuration:i}=v(e),a=b.start.indexOf(r);-1===a||b.mdats[a]||(b.mdats[a]=new Blob([t.root.mdats[e].data]),p+=t.root.mdats[e].data.byteLength)}else for(const e of t.root.mdats)b.mdats.push(new Blob([e.data])),p+=e.data.byteLength;$(c),j(c),H(b)&&await d.flush()&&(d.complete(),d.clearAllTracks(),d=new Ae(l,n,d))}d&&(d.size+=p,d.updateProgress(),d.createPreviewOnce(1))})(je,n);s({result:!0})}))})();