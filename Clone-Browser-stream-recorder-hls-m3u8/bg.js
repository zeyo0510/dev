/*
 *  This file is part of Stream Recorder  v2.2.2  <https://www.hlsloader.com/>
 *  Note that the source code is copyrighted. We do not grant you the right to modify or distribute it.
 *
 *
 *  - Release Note to Chrome Web Store Team -
 *
 *  v2.2.2
 *   Allow users to select several behavior options.
 *
 *  v2.2.1
 *   Improved robustness in index detection.
 *
 *  v2.2.0
 *   Fixed minor bugs. Support for incognito mode. Allows exporting in a legacy manner for compatibility with previous versions.
 *
 *  v2.1.6
 *   To support windows 7/8.1 users, implement a method that does not use chrome.runtime.getContexts().
 *
 *  v2.1.4
 *   Transitioned to MV3. Multilingual is also supported.
 *   Since there were frequent cases of fetch failures in v2.0.2, we changed the method to fetch with offscreen and pass data as URLs.
 *
 *  v2.0.4 ( *Rollbacked version. The entity is the same as v1.3.11 )
 *
 *  v2.0.2 ( *This version has been reverted due to many problems )
 *   Transitioned to MV3. Multilingual is also supported.
 *   For the sake of transparency and reliability we did not want to minify the source code.
 *   Disappointingly, an extension appeared that completely copied the code, contrary to our intentions, and we decided that we should minify it.
 *   Please contact us at loadmonkey.inquiry@gmail.com and we can provide you with more readable source code, if you need it.
 *
 *  v1.3.0
 *   To improve stability, we've updated the version of the external library - libs/hls.js. ref) https://github.com/video-dev/hls.js/
 *   Furthermore, we've reviewed and rewritten most of the code using the latest ECMAScript coding style.
 *   There's almost no change in the functionality, but it might be cumbersome to review the code as you can't diff it from the previous version.
 *   The debugging log can be referenced by setting "localStorage.log=true" on the developer console of background/content page and may help you to understand the sequence.
 *
 *  v1.2.2
 *   Because Chrome85 blocks CORS requests in content scripts, we have fixed the affected code in this extension.
 *   Technically, We moved the cross-origin fetches to the background page.
 *   Note that the cross-origin fetches are only called by the content script of our own pages, never run on an unspecified page.
 *   Therefore, we believe it is highly unlikely that a compromised renderer process will hijack our content script.
 *   This is a quick fix, so we will be working on a more secure and faster implementation in the near future.
 *
 *  Thank you for your cooperation.
 */

const _export_=(()=>{const e=["https://www.hlsloader.com/","https://www.altextension.com/stream/"],DISABLE_ON_YOUTUBE_REGEXP=/^https?:\/\/www\.youtube\.com\//,t={ar:"ar",am:"am",bg:"bg",bn:"bn",ca:"ca",cs:"cs",da:"da",de:"de",el:"el",en:"en",en_AU:"en",en_GB:"en",en_US:"en",es:"es",es_419:"e4",et:"et",fa:"fa",fi:"fi",fil:"fp",fr:"fr",gu:"gu",he:"he",hi:"hi",hr:"hr",hu:"hu",id:"id",it:"it",ja:"ja",kn:"kn",ko:"ko",lt:"lt",lv:"lv",ml:"ml",mr:"mr",ms:"ms",nl:"nl",no:"no",pl:"pl",pt_BR:"br",pt_PT:"pt",ro:"ro",ru:"ru",sk:"sk",sl:"sl",sr:"sr",sv:"sv",sw:"sw",ta:"ta",te:"te",th:"th",tr:"tr",uk:"uk",vi:"vi",zh_CN:"cn",zh_TW:"tw"},s={disable:{title:"action_button_off",path:"icon_disable_64.png"},enable:{title:"action_button_enable",path:"icon_enable_64.png"},enable_weak:{title:"action_button_enable_weak",path:"icon_enable_64.png"},capture:{title:"action_button_capturing",path:"icon_capturing_64.png"},normal:{title:"action_button_loader",path:"icon_normal_64.png"}},o="b2c_check_alive",a="b2c_check_navigation",n="b2l_notify_found_file",i="b2l_intercept_data",r="b2o_fetch_request",_export_={},c=navigator.userAgent,d=c.includes("Firefox"),l=(!c.includes("Edg")&&c.includes("Chrome"),c.includes("Mobi"),c.includes("Chrome")&&Number((c.match(/Chrome\/(\d+)/)||[])[1]||0),/^[^?]+?\.([a-z0-9A-Z]+?)(\?.*?)?$/i),u=/^(post|get)$/i,m="light",g=["hi","di","hf","df","hk","vd","ot"],f=e=>{const t=typeof e,s=("number"===t?e:"string"===t?e.charCodeAt(0):1234)%64;return"color:#"+((s>>4&3)<<22|(s>>2&3)<<14|(3&s)<<6|1048576).toString(16)},p=(e="",t,s,...o)=>[("number"==typeof e?"tabId ":"")+"%c"+e+"%c ["+t+"]%c "+(s="object"==typeof s?JSON.stringify(s):s||""),f(e),"color:#f60b91","",...o],h=()=>Date.now(),v=e=>new URL(e).hostname,b=e=>new Promise(((t,s)=>{setTimeout(t,e)})),w=e=>{let t=0;for(let s=0;s<e.length;s++)t=Math.imul(31,t)+e.charCodeAt(s)|0;return new Uint32Array([t])[0].toString(36)},y=()=>{const e=(Date.now()+Math.floor(Math.random()*Date.now())).toString();return String.fromCharCode(97+Math.floor(25*Math.random()))+w(e)},_=["application/dash+xml","application/dashdelta","application/f4m","application/ogg","application/vnd.adobe.flash.movie","application/x-mpegurl","application/x-smaf","audio/32kadpcm","audio/3gpp","audio/3gpp2","audio/aac","audio/ac3","audio/amr","audio/amr-wb","audio/asc","audio/atrac-advanced-lossless","audio/atrac-x","audio/atrac3","audio/basic","audio/dls","audio/echospeech","audio/evrc","audio/evrcb","audio/evrcnw","audio/evrcwb","audio/ilbc","audio/l16","audio/midi","audio/mobile-xmf","audio/mp3","audio/mp4","audio/mpeg","audio/ogg","audio/opus","audio/prs.sid","audio/qcelp","audio/smv","audio/tsplayer","audio/vnd.audikoz","audio/vnd.dece.audio","audio/vnd.digital-winds","audio/vnd.dolby.mlp","audio/vnd.dts","audio/vnd.dts.hd","audio/vnd.everad.plj","audio/vnd.lucent.voice","audio/vnd.ms-playready.media.pya","audio/vnd.nortel.vbk","audio/vnd.nuera.ecelp4800","audio/vnd.nuera.ecelp7470","audio/vnd.nuera.ecelp9600","audio/vnd.qcelp","audio/vnd.rip","audio/vnd.rn-realaudio","audio/vnd.sealedmedia.softseal.mpeg","audio/voxware","audio/wav","audio/wave","audio/webm","audio/x-aiff","audio/x-annodex","audio/x-bamba","audio/x-chacha","audio/x-flac","audio/x-matroska","audio/x-midi","audio/x-mio","audio/x-mod","audio/x-mpegurl","audio/x-ms-wax","audio/x-ms-wma","audio/x-pdxmidi","audio/x-pn-realaudio","audio/x-pn-wav","audio/x-realaudio","audio/x-s3m","audio/x-stm","audio/x-twinvq","audio/x-wav","video/3gpp","video/3gpp2","video/avi","video/divx","video/flv","video/iso.segment","video/mj2","video/mp2t","video/mp4","video/mpeg","video/mpeg4","video/mpg","video/ogg","video/quicktime","video/vnd.dece.hd","video/vnd.dece.mobile","video/vnd.dece.mp4","video/vnd.dece.pd","video/vnd.dece.sd","video/vnd.dece.video","video/vnd.dvb.file","video/vnd.fvt","video/vnd.mpegurl","video/vnd.ms-playready.media.pyv","video/vnd.nokia.interleaved-multimedia","video/vnd.radgamettools.bink","video/vnd.radgamettools.smacker","video/vnd.rn-realvideo","video/vnd.sealed.mpeg1","video/vnd.sealed.mpeg4","video/vnd.sealed.swf","video/vnd.sealedmedia.softseal.mov","video/vnd.vivo","video/webm","video/x-annodex","video/x-bamba","video/x-flv","video/x-javafx","video/x-m4v","video/x-matroska","video/x-matroska-3d","video/x-mng","video/x-ms-asf","video/x-ms-wm","video/x-ms-wmv","video/x-ms-wmx","video/x-ms-wvx","video/x-msvideo","video/x-qmsys","video/x-sgi-movie","video/x-tango","video/x-vif"],x=["3g2","3gp","3gpp","3gpp2","669","726","aa3","aac","aal","aba","ac3","acn","aif","aifc","aiff","amr","asf","asx","at3","atx","au","avi","awb","axa","axv","bik","bk2","cha","divx","dls","dts","dtshd","dvb","dxm","ecelp4800","ecelp7470","ecelp9600","enw","eol","es","evb","evc","evw","f4m","flac","flv","fvt","fxm","kar","koz","l16","lbc","lvp","m15","m1v","m2t","m2ts","m2v","m3u","m3u8","m4a","m4s","m4u","m4v","med","mid","midi","mio","mj2","mjp2","mk3d","mka","mkv","mlp","mmf","mng","mod","mov","movie","mp1","mp2","mp3","mp4","mpd","mpdd","mpe","mpeg","mpg","mpg4","mpga","mtm","mts","mxmf","mxu","nim","oga","ogg","ogv","ogx","omg","opus","pdx","plj","psid","pya","pyv","qcp","qm","qt","ra","ram","rip","rm","rv","s11","s14","s1m","s1q","s3m","sid","smk","smo","smov","smp","smp3","smpg","smv","snd","spx","ssw","sswf","stm","swf","tgo","ts","tsa","tsi","tsv","ult","uni","uva","uvh","uvm","uvp","uvs","uvu","uvv","uvva","uvvh","uvvm","uvvp","uvvs","uvvu","uvvv","vba","vbk","vif","viv","vox","vqf","vql","wav","wave","wax","weba","webm","wm","wma","wmv","wmx","wvx"],I=[83,84,43,98,132,59,74,5,1,0,7,10,15,22,11,8,19,18,20,29,39,41,40,37,42,51,50,65,92,81,60,81,95,100,119,106,126,136,49,140,38,73,30,31,102,52,104,155,34,35,36,106,111,109,124,158,161,161,164,12,23,9,27,44,71,65,67,76,59,163,167,33,110,161,109,118,131,159,161,1,0,21,28,45,61,68,134,82,86,82,87,97,77,141,142,145,143,144,146,32,46,93,105,94,25,120,113,125,115,130,122,157,165,24,154,45,47,63,72,70,75,16,166,168,169,170,21,107,78,133,156],R=c.includes("Chrome")?chrome:"object"==typeof browser&&browser;if(!R)return;const k=R.runtime.getManifest(),S=e[0],T=(e=>t[e?.replace("-","_")]||"en")(R.i18n.getUILanguage());let O=S+("en"===T?"":T+"/")+"record.html";new URL(O).origin,new RegExp(e.join("|").replace(/http/g,"^http").replace(/\./g,"\\."));const q=(...e)=>t=>{e.includes("ignorable")||console.log(...e,":",t?.message||"catch unkown")},U=(...e)=>()=>{const t=R.runtime.lastError;t&&A&&console.log(...e,":",t.message)},external_functions={help:()=>{console.log("Commands",["log","reset","show","rules"])},log:()=>{R.storage.local.get(["log"]).then((e=>{let t=e.log;t=!t,R.storage.local.set({log:t}),console.log("Logging",t?"ON":"OFF")}),(e=>{console.log(e)}))},show:()=>{(async()=>{const e=await chrome.storage.local.getBytesInUse()+" / "+chrome.storage.local.QUOTA_BYTES;console.log("local storage   : "+e),console.log(await R.storage.local.get().catch((e=>{console.log(e)}))),console.log("session storage : "+await chrome.storage.session.getBytesInUse()+" / "+chrome.storage.session.QUOTA_BYTES),console.log(await R.storage.session.get().catch((e=>{console.log(e)})))})()},rules:()=>{(async()=>{console.log("sessionrules",await R.declarativeNetRequest.getSessionRules().catch((e=>{console.log(e)})))})()},reset:()=>{R.storage.local.clear().catch((e=>{console.log(e)})),R.storage.session.clear().catch((e=>{console.log(e)}))}};Object.assign(_export_,external_functions);function L(e,t,s,o){const a={},n=e=>{const t={};for(const s in e)"function"!=typeof e[s]&&(t[s]=structuredClone(e[s]));return t},i=(i,r,c)=>{const l=structuredClone(e[t]);if(r&&"object"==typeof r)for(const e in r)"function"!=typeof r[e]&&(l[e]=structuredClone(r[e]));return l.id=i,l.lifetime=h()+(c||2592e5),(e=>{if(e?.id){const i=t+"_"+e.id,r=((e,t)=>{let s=!1,o=0;return(...t)=>{s?o++:(s=!0,setTimeout((()=>{o>0&&e(...t),s=!1,o=0}),3e3),0===o&&e(...t))}})((()=>{-3!==a[e.id]&&(A&&console.log(...p("tab"===t?e.id:"global","storage."+s,"sync "+i)),R.storage[s].set({[i]:d?n(e):e}).catch(q("storage",s,"set")))}));e.sync=t=>{a[e.id]=e;const s=h();return t&&(e.lifetime=s+t),e.lifetime&&setTimeout(e.remove,e.lifetime-s),o&&o(e,"sync"),r(),e},e.remove=()=>(-3!==a[e.id]&&(a[e.id]=-3,o&&o(e,"remove"),R.storage[s].remove(i).catch(q("storage",s,"remove")),A&&console.log(...p("tab"===t?e.id:"global","storage."+s,"remove "+i))),e),e.assign=t=>Object.assign(e,t)}})(l),o&&o(l,"new"),l};"session"===s&&(async()=>{const e=h(),s=await R.storage.session.get().catch(q("storage.session.get"));if(s)for(const o in s)if(o.startsWith(t+"_")){const{lifetime:t}=s[o];t&&t<e&&R.storage.session.remove(o).catch(q("storage.session.remove"))}})();const r=t;return{["find_"+r]:e=>a[e]||0,["new_"+r]:i,["restore_"+r]:async e=>{if(!a[e]){a[e]=-1;const o=t+"_"+e,n=await R.storage[s].get(o).catch(q("storage",s,"get"));a[e]=n?.[o]?i(e,n[o]):-2}return a[e]<1?void 0:a[e]}}}const M=(e,t=[])=>{const s={referer:!0,origin:!0},o=[];if(null!=e.length)for(const a of e||[]){const e=a.name.toLowerCase();t.includes(e)||(o.push({header:a.name,operation:"set",value:a.value}),s[e]&&(s[e]=!1))}else for(const a in e||{}){const n=a.toLowerCase();t.includes(n)||(o.push({header:a,operation:"set",value:e[a]}),s[n]&&(s[n]=!1))}for(const e in s);return o},C=e=>{if(!e)return"";const t=[],s=encodeURI(e).split("/");for(const e of s){if(e.includes("%"))break;t.push(e)}return t.join("/")};R.declarativeNetRequest?.updateSessionRules({removeRuleIds:[2147483647]}).catch(q("updateSessionRules"));const j=(e,t)=>{const s=navigator.userAgent.includes("Chrome")?chrome:"object"==typeof browser?browser:chrome,o=location.host?location.origin:location.ancestorOrigins[0];window.addEventListener("message",(async e=>{if(e?.origin===o){const{cmd:t,params:o}=e?.data||{};if("c2c_transfer"===t){s.runtime.sendMessage({type:"message_to_serviceworker",cmd:"c2b_intercept_ondata",params:o});for(const t in e.data)delete e.data[t]}}}))},N=(e,t)=>{if(/^https?:\/\/www\.youtube\.com\//.exec(location.href||""))return;if(MediaSource._)return;const s=location.host?location.origin:location.ancestorOrigins[0],o="c2c_transfer",a=t=>{const s={targetTabId:e};for(const e in t)s[e.toLowerCase()]=t[e];return s},n=MediaSource;MediaSource=class extends n{constructor(){super(arguments),this._mediaSourceId=Math.floor(1e10*Math.random())}addSourceBuffer(e){const t=super.addSourceBuffer.apply(this,arguments),n=t.appendBuffer;t._bufferId=Math.floor(1e10*Math.random());const i=this;return t.appendBuffer=function(t){if(t.length||t.byteLength){const n=new Blob([t]),r=URL.createObjectURL(n),c={url:r,mimeType:e,mediaSourceId:i._mediaSourceId,bufferId:this._bufferId,timestamp:Date.now()};window.postMessage({cmd:o,params:a(c)},s),setTimeout((()=>{URL.revokeObjectURL(r)}),6e4)}n.apply(this,arguments)},t.addEventListener("abort",(()=>{const e={url:"abort",mimeType:"",mediaSourceId:i._mediaSourceId,bufferId:this._bufferId,timestamp:Date.now()};window.postMessage({cmd:o,params:a(e)},s)})),t}static get _(){return 1}}};let A=!1;const B=R.i18n;let E=-1;R.storage.session.get(["sessionId"]).then((e=>{e.sessionId?E=e.sessionId:(E=y(),R.storage.session.set({sessionId:E}).catch(q("storage.session.set")))})).catch(q("storage.session.get"));let D=-1,H=-1,W=m;R.storage.local.get(["log","uuid","counter","theme"]).then((e=>{A=e.log,D=e.counter||0,W=e.theme||m,H=e.uuid,H||(H=y(),R.storage.local.set({uuid:H}).catch(q("storage.local.set")))})).catch(q("storage.local.get"));const J=(e,t,s,o,a,n=-1)=>{A&&console.log(...p(s,"executeScript",{frameId:n}));const i={tabId:s};-1===n?i.allFrames=!0:n>0&&(i.frameIds=[n]),R.scripting.executeScript({target:i,func:e,injectImmediately:!0,world:t,args:[o,a]}).catch(q("ignorable","executeScript"))},z={},F={},$={},P={},Q={},G={};let Y=!1;const K={local:{log:"true",uuid:-1,counter:-1},tab:{id:0,url:"",title:"",root:0,child:0,child_pending:0,stat:1,mode:1,items:{hashmap:[],indexes:[],fragments:[],sync:{hashmap:0,indexes:0,fragments:0},count:{index:0,fragment:0,display:0}},ruleIds:[],stub:!1,timestamp:0},domain:{id:0,spa:{refresh:!1},filter:{video:!0,audio:!0,image:!1,others:!1,zero:!0,index:!0,fragments:!1},threshold:{size:0}},cache:{id:"tabinfo",tabs:{}},val:{id:0,_value_:void 0}},{__domains__:X,restore_domain:Z,new_domain:V}=L(K,"domain","local"),{__tabs__:ee,restore_tab:te,new_tab:se,find_tab:oe}=L(K,"tab","session",(async(e,t)=>{const{id:s,url:o,root:a,child:r,timestamp:c}=e;if("new"===t)d=e,Object.assign(d,{push:(e,t)=>{if(d.items[t].length>100)return;const s=me.compress_x2(e,d);d.items[t].push(s),d.sync(),pe(d),2===d.stat&&1===d.mode&&d.child&&d.consume()},pass_through:(e,t)=>{2===d.stat&&1===d.mode&&d.child&&R.tabs.sendMessage(d.child,{cmd:n,params:{type:1,item:e}}).catch(q(n,d.child))},consume:async e=>{const t={hashmap:d.items.hashmap.slice(d.items.sync.hashmap),indexes:d.items.indexes.slice(d.items.sync.indexes),fragments:d.items.fragments.slice(d.items.sync.fragments)};d.items.sync.hashmap=d.items.hashmap.length,d.items.sync.indexes=d.items.indexes.length,d.items.sync.fragments=d.items.fragments.length,R.tabs.sendMessage(d.child,{cmd:n,params:{type:1,items:t}}).catch(q(n,d.child))},start:async e=>{A&&console.log(...p(d.id,"Tab.start","")),d.stat=2,d.mode=e,1===d.mode?(d.consume(!0),fe(d)):setTimeout((()=>{fe(d)}),1e3)},stop:()=>{A&&console.log(...p(d.id,"Tab.stop","")),d.stat=1},reset:()=>{A&&console.log(...p(d.id,"Tab.reset","")),d.items.sync.hashmap=0,d.items.sync.indexes=0,d.items.sync.fragments=0,d.stat=1,d.mode=1,delete Q[d.id],delete G[d.id],fe(d)},destroy:()=>{A&&console.log(...p(d.id,"Tab.destroy","")),d.stop(),delete tabs[d.id];const e=Object.assign({},d.storedBlob);setTimeout((()=>{for(const t in e)URL.revokeObjectURL(t)}),3e3)},on_close:async()=>{const e=d.id;if(d.child)d.virtualize();else if(d.root){const e=await te(d.root);e&&(e.stub?e.remove():(e.child=0,4===e.mode&&(e.mode=1,fe(e)),e.sync()))}delete z[e],delete F[e],delete $[e],delete P[e],delete Q[e],delete G[e],R.declarativeNetRequest.updateSessionRules({removeRuleIds:d.ruleIds}).catch(q("declarativeNetRequest.updateSessionRules")),d.remove()},revokeObjectURL:e=>{if(e)for(const t of e)URL.revokeObjectURL(t),delete d.storedBlob[t]},sendMessage:(e,t)=>(A&&console.log(...p(d.id,"sendMessage",e)),new Promise(((s,o)=>{d.child&&2===d.stat?R.tabs.sendMessage(d.child,{cmd:e,params:t}).then((e=>{s(e)})).catch((t=>{t&&A&&console.log(e,":",t.message),s()})):s()}))),virtualize:async()=>{if(d.stub)return!1;const e=await te(d.child);if(e){const t=se(e.id+"_stub",d);return t.stub=!0,t.sync(),e.root=t.id,e.sync(),4===d.mode&&R.tabs.sendMessage(e.id,{cmd:i,params:{url:"b2l_disconnect_capture"}}).catch(q(i,e.id)),!0}return!1}});else if("remove"===t){const e=await re();delete e.tabs[s],e.sync()}else if("sync"===t){const e=await re();e.tabs[s]=Object.assign(e.tabs[s]||{},{hash:w(o),root:a,child:r,timestamp:c}),e.sync()}var d})),{__caches__:ae,restore_cache:ne,new_cache:ie}=L(K,"cache","session"),re=async()=>await ne("tabinfo")||await ie("tabinfo"),{__val__:ce,restore_val:de,resolve_val:le,new_val:ue}=L(K,"val","session"),me=(()=>{const e=[null,void 0,!0,!1,"type","url",...g],t=["null","undefined","true","false","type","url",...g],s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_=",o=" !$%&()*+./;<>?@^|",a=64,n=e=>e?(e.timestamp=(new Date).getTime(),e.items.hashmap):(console.error("no keyvalue"),[]),i=(e,t,n)=>{let i=t.indexOf(e);if(-1===i){if(n)return"~~~~";t.push(e),i=t.length-1}return i<a?s[i]:i<1088?o[Math.floor(i/a)]+s[i%a]:o[Math.floor(i/1088)%17]+o[Math.floor(i/a)%17]+s[i%a]},r=(e,t)=>{if(null===e)return t.indexOf(e);const s=typeof e;if("undefined"===s)return t.indexOf(e);if("boolean"===s)return t.indexOf(e);if("number"===s)return"#"+e.toString(32)+"#";if("string"===s)return i(e,t);if(null!=e.length){const s=[];for(const o of e)s.push(r(o,t));return s}{const s={};for(const o in e)s["~"+i(o,t)]=r(e[o],t);return s}},c=(t,s)=>{const o=n(s);0===o.length&&o.push(...e);const a=r(t,o);return JSON.stringify(a).replace(/[":,~]/g,"")},d=(e,i,r)=>{const c=n(i),d=[];let l=null,u=!0,m=!1,g=!1,f=-1;const p=()=>{d.push(u&&!m?":":","),u=!u};for(let n=0;n<e.length;n++){const i=e[n];if("#"===i)g=!g,g?f=0:(d.push(f),p(),f=-1);else if(g)"-"!==i&&(f=32*f+parseInt(i,32),"-"===l&&(f*=-1));else{const e=s.indexOf(i),n=o.indexOf(i);if(e<0&&n<0){const e="}"===i||"]"===i;e&&","===d[d.length-1]&&d.pop(),d.push(i),u="{"===i,"["===i?m=!0:"]"===i&&(m=!1),e&&p()}else if(e>=0){if(f=-1===f?e:f*a+e,f<4)d.push(t[f]);else{if(void 0===c[f])return console.log(f),console.log(JSON.stringify(c)),null;if(!c[f].replaceAll)return console.error(f),console.error(c[f]),null;d.push('"'+c[f].replaceAll('"','\\"')+'"')}p(),f=-1}else f=-1===f?n:17*f+n}l=i}","===d[d.length-1]&&d.pop();const h=d.join("");return r?h:JSON.parse(h)};return{compress:c,decompress:d,compress_x2:(e,t)=>{const s={...e},{type:o,url:a}=s;delete s.type,delete s.url;const n=a.match(/(^[^:]+:\/\/[^\/]+\/)(.*?)([^\/]*$)/);n||console.error(a);const i=c(s,t).match(/\{([^\{]+)\{([^\}]*)/),r={type:o,url:n.slice(1,4),request:i[2],response:i[1]};let d=c(r,t).replace(/[{}]/g,"");return d=d[1]+d.substr(3),d},decompress_x2:(t,s,o)=>{t=e.indexOf("type")+t[0]+e.indexOf("url")+t.substr(1);const a=d("{"+t+"}",s);if(!a?.url)return console.error(JSON.stringify(a)),null;const n=a.url.join(""),{type:i,request:r,response:c}=a,l=d("{"+c+"{"+r+"}}",s);if(!l)return console.error("error at decompressed_2nd",n,JSON.stringify(r||{}),JSON.stringify(c||{})),null;const u=Object.assign({type:i,url:n,...l});return o?JSON.stringify(u):u},hash:(e,t)=>{const s=n(t);return i(e,s,!0)}}})();let ge=null;(async()=>{})();const fe=async e=>{if(!e)return;if(e.stub)return;const t=e.id,o=e.url&&DISABLE_ON_YOUTUBE_REGEXP.exec(e.url),a=e.root||o?"disable":4===e.mode?"capture":e.items?.indexes.length?"enable":"normal";if(a===P[t])return;const n=s[a],i=B.getMessage(n.title),r="images/"+n.path;if(P[t]=a,((e,t,s)=>{e=e.length?e:[e];for(const o of e)try{d?(R.action.enable(o).catch(q("action.enabled")),R.action.setTitle({tabId:o,title:t}).catch(q("action.setTitle")),R.action.setIcon({tabId:o,path:s}).catch(q("action.setIcon"))):(R.action.enable(o,U("action.enabled")),R.action.setTitle({tabId:o,title:t},U("action.setTitle")),R.action.setIcon({tabId:o,path:s},U("action.setIcon")))}catch(e){}})(t,i,r),Y&&e.items?.indexes.length){const t=await R.tabs.get(e.id);t&&setTimeout((()=>{we(t)}),1e3)}},pe=async e=>{const t=await R.storage.session.getBytesInUse().catch(q("storage.session.getBytesInUse"));if(t&&t>.95*R.storage.session.QUOTA_BYTES){let t=e;const s=await re();for(const e in s.tabs){const{timestamp:o,child:a}=s.tabs[e];if(a&&o<t.timestamp){const s=te(e);s&&(t=s)}}t.remove()}};let he=0;R.tabs.onUpdated.addListener((async(e,t,s)=>{U("tabs.onUpdated")();const{status:o,url:n,title:i,favIconUrl:r}=t;if(n?.includes("startautotesting_"+H)&&-1!==H&&(Y=!0,n?.includes("_forcecapture")&&!Q[e]&&setTimeout((()=>{we(s)}),1e3)),i){const t=Date.now();return void(he<t&&(setTimeout((async()=>{const t=await te(e);t&&t.title!==i&&(t.title=i,t.sync())}),500),he=t+1e3))}if(r||i)return;if("loading"!==o)return;if(n&&!n.startsWith("http"))return fe({id:e});A&&console.log(...p(e,"tabs.onUpdated",JSON.stringify(t)));const c=F[e];delete F[e];let d=n&&c!==n;const l=n||c;let u=await te(e);if(u)if(u.root)if(!n||n?.startsWith(O)){A&&console.log(...p(e,"tabs.onUpdated","LoaderTab [ reloading ] , ignore"));const t=await te(u.root);t&&t.reset()}else A&&console.log(...p(e,"tabs.onUpdated > Remove tab ( new page )",n)),await u.on_close(),u=null;else{if(Q[e])return A&&console.log(...p(e,"tabs.onUpdated > ignore reload due to injecting scrpt",u.url,c)),void delete Q[e];if(n){const t=e=>(/^[^:]+:\/\/([^\/]+)/.exec(e||"")||[])[1];if(t(n)!==t(u.url)&&(d=!1),d){await b(100);const t=await R.tabs.sendMessage(e,{cmd:a,params:{prevUrl:u.url,currentUrl:n}},{frameId:0}).catch(q(a,e));t&&("moved"===t?(A&&console.log(...p(e,"tabs.onUpdated > SPA, Remove tab ( new page )",n,t)),await u.on_close(),u=null):(A&&console.log(...p(e,"tabs.onUpdated > SPA",n,t)),u.url=n,u.sync()))}else A&&console.log(...p(e,"tabs.onUpdated > Remove tab ( new page )",n)),await u.on_close(),u=null}else c&&(A&&console.log(...p(e,"tabs.onUpdated > Remove tab ( reload )",u.url,c)),await u.on_close(),u=null)}u||l&&(u=se(e),u.url=l,u.sync(),ve(u),A&&console.log(...p(e,"tabs.onUpdated > New tab ",u.url))),fe(u)})),R.tabs.onRemoved.addListener((async e=>{const t=await te(e);t&&(A&&console.log(...p(e,"tabs.onRemoved",t.url)),t.on_close())})),R.webNavigation.onCommitted.addListener((e=>{const{url:t,tabId:s,frameId:o,frameType:a}=e;if(DISABLE_ON_YOUTUBE_REGEXP.exec(t))return;const n=G[s];if(n){const e=y();J(j,"ISOLATED",s,n,e),J(N,"MAIN",s,n,e)}})),R.webRequest.onBeforeRequest.addListener((async e=>{const{tabId:t,requestId:s,url:o,method:a}=e;u.test(a)&&o.startsWith("http")&&!o.startsWith(O)&&!DISABLE_ON_YOUTUBE_REGEXP.exec(o)&&(A&&console.log(...p(t,"web.onBeforeRequest@main_frame",o,s)),Z(v(o)),F[t]=o)}),{urls:["<all_urls>"],types:["main_frame"]},[]),R.webRequest.onBeforeSendHeaders.addListener((async e=>{const{tabId:t,requestId:s,url:o,method:a,requestHeaders:n}=e;u.test(a)&&o.startsWith("http")&&!o.startsWith(O)&&!DISABLE_ON_YOUTUBE_REGEXP.exec(o)&&(z[t]?.[o]||($[t]||={},$[t][s]={requestHeaders:n}))}),{urls:["<all_urls>"]},["requestHeaders","extraHeaders"]);const ve=async e=>{const t=e.id;for(const s in $[t]){const o=$[t][s];await be(o,e)}delete $[t]},be=async(e,t)=>{const{tabId:s,requestId:o,url:a,responseHeaders:n,statusCode:i,method:r}=e;z[s]||={},z[s][a]=!0;const c=$[s]?.[o];if(!c)return;let{requestHeaders:d}=c;if(delete $[s][o],i<200||i>=300)return;if(t.root||DISABLE_ON_YOUTUBE_REGEXP.exec(t.url))return;const u=(e=>{const t=[];try{for(let s=0,o=e.length;s<o;s++)t[s]=e[s].name.toLowerCase()}catch(t){((e,t)=>{const s=(new Date).toLocaleString(),o={["elog-headersNameToLowerCase-"+s]:t};R.storage.local.set(o).catch(q("storage.session.set")),console.error(o)})(0,{headers:e})}return t})(n),m=n[u.indexOf("content-type")],g=m?m.value.toLowerCase():"none/unknown";let f=(e=>{const t=_.indexOf(e);return x[I[t]]})(g)||((l.exec(a)||[])[1]||(g.match(/\/[^\/;]+/)||["xxx"])[0].replace(/^\/(x-)?/,"")).toLowerCase();"dll"!==f&&"exe"!==f||(f="xxx");const h=Number(n[u.indexOf("content-length")]?.value||0),v=((a?.match(/[^\/]+$/)||[])[0]||"").match(/^[^\?&#]*/)[0],b="xmlhttprequest"===e.type&&a.match(/[\.\/](m3u|hls)/)&&!v?.match(/\.(js|json|html)$/)&&0===t.items?.indexes?.length&&h<102400;let w=g.match(/(mpegurl|m3u)/)||f.match(/^(m3u8|m3u)$/)||b;const y=g.match(/mp2t/)||f.match(/^(ts|tsv|tsa)$/)||16===h;if(w||(w=g?.includes("text")&&a?.includes("playlist")&&a?.match(/master|media|video/)&&(await(async(e,t)=>{try{const s=await(async(e,t)=>{let s=0;try{const o=new AbortController,a=o.signal;s=setTimeout((()=>{o.abort()}),5e3);const n=await fetch(e,{signal:a});if(n.ok){const e=new Uint8Array(t),s=n.body.getReader();let o=0;for(;o<t;){const{done:a,value:n}=await s.read();if(a)break;for(let s=0;s<n.length&&o<t;s++)e[o]=n[s],o++}return s.cancel(),e}}catch(e){return null}finally{s&&clearTimeout(s)}})(e,t);return s?(new TextDecoder).decode(s):""}catch(e){return""}})(a,100)).includes("EXTM3U")),!w&&!y)return;d=(e=>{const t={};for(const s of e||[])t[s.name]=s.value;return t})(d),_[g]&&(f=_[g][0]);const k={type:w?"hi":16===h?"hk":"hf",url:a,suffix:f,contentType:g,method:r,headers:d},S=w?"indexes":"fragments";if(t.items[S].length>("indexes"===S?50:10))return void t.pass_through(k,S);const T=me.compress(a.match(/(^[^:]+:\/\/[^\/]+\/)(.*?)([^\/]*$)/).slice(1,4),t);for(const e of t.items[S])if(-1!==e.indexOf(T))return A&&console.log("already registered");A&&console.log(...p(s,"web.onHeadersReceived > Found item",((e,t,s)=>{if(e.length>90){const t=Math.floor(43);return e.substr(0,t)+"..."+e.substr(e.length-t,t)}return e})(a))),t.push(k,S),w&&fe(t)};R.webRequest.onHeadersReceived.addListener((async e=>{let{tabId:t,requestId:s,url:o,responseHeaders:a,statusCode:n,method:i,initiator:r}=e;if(!u.test(i)||!o.startsWith("http")||o.startsWith(O)||DISABLE_ON_YOUTUBE_REGEXP.exec(o))return;if(-1===t){if(!r)return;if(r.startsWith("chrome-extension://"))return;const o=r+"/*";let a=await R.tabs.query({currentWindow:!0,active:!0,url:o});if(0===a?.length&&(a=(await R.tabs.query({url:o})).sort(((e,t)=>e.id-t.id))),0===a?.length&&(a=await R.tabs.query({currentWindow:!0,active:!0})),a?.length>0){await b(500);const o=a.at(-1);e.tabId=o.id,t=o.id;const n=$[-1]?.[s];n&&$[o.id]&&($[o.id][s]=n,delete $[-1][s])}}const c=oe(t);if(c<1){if($[t]||={},$[t][s]||={},Object.assign($[t][s],e),0===c){const e=await te(t);e&&await ve(e)}}else await be(e,c)}),{urls:["<all_urls>"]},["responseHeaders","extraHeaders"]);const we=async e=>{if(e){const t=await te(e.id);if(t){const s=t.url&&DISABLE_ON_YOUTUBE_REGEXP.exec(t.url);if(t.root||s);else{const{child:s,child_pending:o}=t;if(s)R.tabs.update(s,{active:!0}).catch(q("tabs.update"));else if(o);else{const s=(e=>{const t=e.match(/^https?\:\/\/([^\/]+)(.+)/);if(t){let e,s=t[1];const o=s.length;let a=0,n=0;const i=t[2];let r=4294967295;for(e=0;e<o;e++)a+=s.charCodeAt(e)<<4*e,n+=s.charCodeAt(o-e-1)<<4*e;if(i.length>=8)for(r=a,e=0;e<8;e++)r+=i.charCodeAt(e)<<4*e;return{u:t[1],h:a.toString(16),rh:n.toString(16),x:r.toString(16)}}return null})(e.url);if(s){const o=O+"?s="+s.h,a=await R.tabs.create({url:o,index:e.index+1,active:!1}).catch(q("tabs.create"));if(a){A&&console.log(...p(e.id,"tabs.create","tabId relation : "+e.id+" => "+a.id)),setTimeout((()=>{R.tabs.update(a.id,{active:!0,autoDiscardable:!1}).catch(q("tabs.update"))}),250),t.child_pending=a.id,t.sync();const s=se(a.id);s.root=e.id,s.url=o,s.sync(),-1!==D&&(D<0&&(D=0),D++,R.storage.local.set({counter:D}).catch(q("storage.local.set"))),(async()=>{const e="offscreen.html",t=R.runtime.getURL(e);if("getContexts"in R.runtime){const e=await R.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"],documentUrls:[t]}).catch(q("runtime.getContexts"));if(e?.length>0)return}else{const t=await clients.matchAll();if("string"==typeof t&&t.includes(e))return;if(t?.length>0)return await t.some((e=>{e?.url?.includes(R.runtime.id)}))}ge?await ge:(ge=R.offscreen.createDocument({url:e,reasons:["BLOBS"],justification:"reason for needing URL.createObjectURL"}).catch(q("offscreen.createDocument")),await ge,ge=null)})()}}}}}}};return R.action.onClicked.addListener(we),R.runtime.onMessage.addListener(((e,t,s)=>"message_to_serviceworker"===e.type&&((async()=>{const{cmd:a,params:n}=e,c=t.tab?.id,l=t.frameId,u=await te(c);if(!u)return s();if(A&&console.log(...p(c,"rt.onMessage",JSON.stringify(e))),"c2b_notify_ready"===a){const e={tabId:c,frameId:l,sessionId:E};if(0===l){const{title:e,darkmode:t}=n,s=t?"dark":m;W!==s&&(W=s,R.storage.local.set({theme:W}).catch(q("storage.local.set"))),u.title=e,u.sync()}return s({accept:!0,yourinfo:e})}if("l2b_notify_ready"===a){const e=n.counter||0;D<e&&(D=e,R.storage.local.set({counter:D}).catch(q("storage.local.set")));const t=u.root,a=await te(t);if(!a)return s({error:"no root"});let i=!1;if(!a.stub){const e=await R.tabs.sendMessage(t,{cmd:o,params:{}},{frameId:0}).catch(q(o));e?.title&&(a.title=e.title,i=!0)}a.child_pending===u.id&&(a.child=u.id,a.child_pending=0,i=!0,fe(a)),i&&a.sync();const{id:r,title:c,url:d}=a,l={id:u.id,root:{id:r,url:d,title:c,domain:v(d)}},m={uuid:H,counter:D,version:k.version};return s({info:l,settings:m})}if("l2b_start_normal"===a){const e=u.root,t=await te(e);return t?(t.start(1),s({msg:"OK"})):s({msg:"NG"})}if("l2b_set_dnr_session_rule"===a){const{itemId:e,url:t,headers:o,excludes:a=[],priority:i=1}=n,r=1e3*(Number(c)%1e4+1)+e;return u.ruleIds.includes(r)||u.ruleIds.push(r),u.sync(),await R.declarativeNetRequest.updateSessionRules({removeRuleIds:[r],addRules:[{action:{type:"modifyHeaders",requestHeaders:M(o,a)},condition:{tabIds:[-1],urlFilter:C(t),resourceTypes:["xmlhttprequest"]},id:r,priority:i}]}).catch(q("declarativeNetRequest.updateSessionRules")),A&&(console.log("+",t),console.log(JSON.stringify(o,null,4))),s({result:!0})}if("l2b_fetch_request"===a){if(t?.tab?.incognito)return((e,t,s)=>{const{params:o}=e;return t.tab,t.frameId,(async()=>{if(!o)return s({ok:!1,message:"no params"});const{url:e,method:t,headers:a,timeout:n,revokeList:i}=o,r={method:t||"GET",mode:"cors",credentials:"include",headers:a},c=await fetch(e,r).catch((e=>s({ok:!1,message:e.messsage})));if(c?.ok){const e=await c.arrayBuffer();if(d)return s({ok:!0,buffer:e});{const t=Array.from(new Uint8Array(e));return s({ok:!0,array:t})}}s({ok:!1,message:c.status})})(),!0})({params:n},t,s);{const e=await R.runtime.sendMessage({cmd:r,params:n,type:"message_to_offscreen"}).catch(q(r));return s(e)}}if("l2b_intercept_request"===a){const e=u.root,t=await te(e);return t&&!t.stub?(t.start(4),Q[e]=!0,G[e]=c,setTimeout((()=>{delete Q[e],delete G[e]}),1e4),R.tabs.update(t.id,{active:!0}).catch(q("tabs.update @ CMD_LtoB_INTERCEPT_REQUEST")),R.tabs.reload(t.id,{bypassCache:!0}).catch(q("tabs.reload @ CMD_LtoB_INTERCEPT_REQUEST")),s(!0)):s(!1)}"c2b_intercept_ondata"===a?(R.tabs.sendMessage(n.targetTabId,{cmd:i,params:n}).catch(q(i)),s(!0)):(A&&console.log(...p(c,"tr.onMessage","unkown cmd : "+a+" frameId: "+l)),s(!0))})(),!0))),(async()=>{console.log(...p("",k.name+" "+k.version,"start at "+(new Date).getTime())),(async()=>{const e=await R.tabs.query({}).catch(q("tabs.query")),t=[];for(const s of e||[])t.push(s.id);const s=await R.declarativeNetRequest.getSessionRules().catch(q("declarativeNetRequest.getSessionRules"));if(s){const e=[];for(const o of s){let s=!1;for(const e of o?.condition?.tabIds||[])if(t.includes(e)){s=!0;break}s||e.push(o.id)}R.declarativeNetRequest.updateSessionRules({removeRuleIds:e}).catch(q("declarativeNetRequest.updateSessionRules"))}})()})(),_export_})();Object.assign(this,_export_);