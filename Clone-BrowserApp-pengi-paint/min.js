chrome.app.runtime.onLaunched.addListener(function(a){function n(a,b){var c=new FileReader;c.onload=function(a){b(a.target.result)},c.readAsDataURL(a)}function o(a){w.title=a+" - "+x.appName}function p(a){return}function q(a){var b=a||"image",c=a.lastIndexOf(".");c!=-1&&(b=a.substr(0,c));var d=b;a&&b.substr(b.length-k.length)!=k&&(d+=k);switch(h){case g:d+=".jpg";break;default:d+=".png"}return d}function r(a,f){var g=arguments,h=this;b[a]=f;if(!c)return chrome.storage.sync.set({preferences:b},function(){}),c=!0,setTimeout(function(){c=!1},d*1e3),!0;e&&clearTimeout(e),e=setTimeout(function(){r.apply(h,g)},1e3)}function s(a,b){var c=q(j);v.chrome.fileSystem.chooseEntry({type:"saveFile",suggestedName:c,accepts:[{mimeTypes:["image/"+a],extensions:[a]}]},function(a){t(b,a),l=a})}function t(a,b){var c=q(j),d=new ArrayBuffer(a.length),e=new Uint8Array(d);for(var f=0;f<a.length;f++)e[f]=a.charCodeAt(f);var g=new Blob([d],{type:"image/png"});b.createWriter(function(a){a.onwrite=function(){j=c,o(c)},a.write(g)})}function u(a,b,c,d,e){function q(){var a=document.activeElement,c=document.createElement("input");c.type="text",c.focus(),c.style.opacity=0,b.body.appendChild(c),b.execCommand("paste"),c.parentNode.removeChild(c),b.body.focus()}function u(a){l=null,a.file(function(a){n(a,function(b){o(a.name),k.board.openUrl(b),j=a.name,h=f;if(a.type=="image/jpg"||a.type=="image/jpeg")h=g})})}function v(a){var b=a.clipboardData,c=b.items,d=!1;for(var e=0;e<c.length;e++){var f=c[e];if(f.kind!="file")continue;if(f.type.indexOf("image/")!==0)continue;d=!0;break}return a.stopPropagation(),a.preventDefault(),k.board.setHasClipboard(d),!1}function w(){b.body.addEventListener("paste",v,!1),b.execCommand("paste"),b.body.removeEventListener("paste",v,!1)}var i={};d&&(i.createblank=!1),i.msLoadDelay=e||0;var k=PengiUILoader(a,b,c,i);k.on("historychange",function(a){p(a.hasUndo())}),k.on("prefwriterequest",function(a,b){r(a,b)}),k.on("savefile",function(){var a;switch(h){case f:a="png";break;default:a="jpeg"}var b=k.board.getSurface().getCanvas(),c=b.toDataURL("image/"+a),d=atob(c.substr(c.indexOf(",")+1));l?t(d,l):a=="jpeg"?k.message.savewarn(function(){s(a,d)}):s(a,d)}),k.on("requestpaste",function(){m?q():a.chrome.permissions.request({permissions:["clipboardRead"]},function(a){a?m=!0:k.message.pastewarn()})}),k.on("requestfile",function(){a.chrome.fileSystem.chooseEntry({accepts:[{mimeTypes:["image/*"]}]},u)}),b.body.addEventListener("dragover",function(a){return a.stopPropagation(),a.preventDefault(),!1},!1),b.body.addEventListener("drop",function(a){var b=a.dataTransfer.files,c=b[0];return n(c,function(a){o(c.name),k.board.openUrl(a),j=c.name,h=f;if(c.type=="image/jpg"||c.type=="image/jpeg")h=g}),a.stopPropagation(),a.preventDefault(),!1},!1),a.addEventListener("focus",function(a){w()},!1),d&&u(d)}function y(c){c=c||{},chrome.app.window.create("app/wrapper.html",{width:800,height:600,minWidth:800,minHeight:600,frame:"native",hidden:!0},function(d){c.nosplash?d.show():setTimeout(function(){d.show()},i),v=d.contentWindow,w=v.document,v.onload=function(){w.title=x.appName,chrome.storage.sync.get("preferences",function(c){b=c.preferences||{};var d=null;a&&a.items&&a.items.length>0&&(d=a.items[0].entry),u(v,w,b,d,i)})}})}var b={},c=!1,d=10,e=!1,f=1,g=2,h=f,i=2500,j="",k="_edit",l=null,m=!1;chrome.permissions.contains({permissions:["clipboardRead"]},function(a){m=a});var v,w,x={appName:chrome.runtime.getManifest().name,version:chrome.runtime.getManifest().version};if(typeof a=="undefined"||typeof a.items=="undefined")var z=chrome.app.window.create("splash.html",{width:462,height:342,resizable:!1,frame:"none"},function(a){y();var b=a.contentWindow;b.onload=function(){var a=b.document.getElementById("splash");a.className="color";var c=b.document.getElementById("version");c.innerHTML="Version "+chrome.runtime.getManifest().version+"<br/>Â© Copyright 2013 <a target='_blank' href='http://lostsource.com/?app=Pengi&source=splash'>lostsource.com</a>, All rights reserved."},setTimeout(function(){a.close()},i)});else y({nosplash:!0})})