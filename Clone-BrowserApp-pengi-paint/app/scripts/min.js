function applyStylesToNode(a,b){for(var c in b)a.style[c]=b[c]}function getScrollbarWidth(){var a=document.createElement("div");a.style.visibility="hidden",a.style.width="100px",a.style.msOverflowStyle="scrollbar",document.body.appendChild(a);var b=a.offsetWidth;a.style.overflow="scroll";var c=document.createElement("div");c.style.width="100%",a.appendChild(c);var d=c.offsetWidth;return a.parentNode.removeChild(a),b-d}function copyCanvasResampled(a,b,c,d,e,f,g){function t(a,b,c,d,e,f){var g=i*4,k=a*m;if(k>i)return!1;var l=b*m;if(l>j)return!1;var n=k*4+l*i*4;for(var o=0;o<m;o++){var p=o*g,q=l+o,r=(q+1)*g;for(var s=0;s<m;s++){var t=s*4,u=n+t+p;if(u>=r)continue;h[u]=c,h[u+1]=d,h[u+2]=e,h[u+3]=f}}return!0}var h=f.data,i=f.width,j=f.height,k=document;b=b||0,c=c||0;var l=a.getContext("2d"),m=g/d;if(m<1){var n=k.createElement("canvas");n.width=f.width,n.height=f.height;var o=n.getContext("2d");o.drawImage(a,b,c,d,e,0,0,n.width,n.height);var p=o.getImageData(0,0,n.width,n.height).data;for(var q=0;q<p.length;q++)h[q]=p[q];return n=null,!0}m=Math.ceil(m),d=Math.round(i/m),e=Math.round(j/m);var r=l.getImageData(b,c,d,e),s=r.data;for(var q=0;q<d;q++)for(var u=0;u<e;u++){var v=q*4+u*d*4;t(q,u,s[v],s[v+1],s[v+2],s[v+3])}}function setRegionTransparent(a,b,c,d,e){setRegionValues(a,b,c,d,e,{a:0})}function setRegionRGB(a,b,c,d,e,f){setRegionValues(a,b,c,d,e,{r:f.r||0,g:f.g||0,b:f.b||0,a:255})}function setRegionValues(a,b,c,d,e,f){f=f||{};var g=a.getImageData(b,c,d,e),h=g.data;for(var i=0,j=h.length;i<j;i+=4)typeof f.r!="undefined"&&(h[i]=f.r),typeof f.g!="undefined"&&(h[i+1]=f.g),typeof f.b!="undefined"&&(h[i+2]=f.b),typeof f.a!="undefined"&&(h[i+3]=f.a);a.putImageData(g,b,c)}function mirrorImageData(a,b){var c=a.createImageData(b.width,b.height),d=c.data,e=b.data,f=b.width*4,g=e.length,h=0,i=-1,j=0,k,l;for(var m=0;m<g;m+=4){var n=Math.floor(m/f);h=n*f,n!=i?j=0:j++,i=n,k=b.width+j*-1-1,l=h+k*4,d[l]=e[m],d[l+1]=e[m+1],d[l+2]=e[m+2],d[l+3]=e[m+3]}return c}function flipImageData(a,b){var c=a.createImageData(b.width,b.height),d=c.data,e=b.data,f=b.width*4,g=e.length,h=-1,i=0,j,k;for(var l=0;l<g;l+=4){var m=Math.floor(l/f);m!=h?i=0:i++,h=m,j=b.height+m*-1-1,k=f*j+i*4,d[k]=e[l],d[k+1]=e[l+1],d[k+2]=e[l+2],d[k+3]=e[l+3]}return c}function grayscaleImageData(a,b){var c=a.createImageData(b.width,b.height),d=c.data,e=b.data,f=e.length;for(var g=0;g<f;g+=4){var h=Math.floor(e[g]*.2126+e[g+1]*.7152+e[g+2]*.0722);d[g]=h,d[g+1]=h,d[g+2]=h,d[g+3]=e[g+3]}return c}function sepiaImageData(a,b){var c=a.createImageData(b.width,b.height),d=c.data,e=b.data,f=e.length;for(var g=0;g<f;g+=4){var h=Math.floor(e[g]*.393+e[g+1]*.769+e[g+2]*.189),i=Math.floor(e[g]*.349+e[g+1]*.686+e[g+2]*.168),j=Math.floor(e[g]*.272+e[g+1]*.534+e[g+2]*.131);h=h>255?255:h,i=i>255?255:i,j=j>255?255:j,d[g]=h,d[g+1]=i,d[g+2]=j,d[g+3]=e[g+3]}return c}function invertImageData(a,b){var c=a.createImageData(b.width,b.height),d=c.data,e=b.data,f=e.length;for(var g=0;g<f;g+=4)d[g]=255-e[g],d[g+1]=255-e[g+1],d[g+2]=255-e[g+2],d[g+3]=e[g+3];return c}function clockwiseImageData(a,b){var c=a.createImageData(b.height,b.width),d=c.data,e=b.data,f=b.width*4,g=b.height*4,h=e.length,i=-1,j=0,k,l,m;for(var n=0;n<h;n+=4){var o=Math.floor(n/f);o!=i?j=0:j++,i=o,l=j,k=b.height-o-1,m=l*g+k*4,d[m]=e[n],d[m+1]=e[n+1],d[m+2]=e[n+2],d[m+3]=e[n+3]}return c}function antiClockwiseImageData(a,b){var c=a.createImageData(b.height,b.width),d=c.data,e=b.data,f=b.width*4,g=b.height*4,h=e.length,i=-1,j=0,k,l,m;for(var n=0;n<h;n+=4){var o=Math.floor(n/f);o!=i?j=0:j++,i=o,k=o,l=b.width-j-1,m=l*g+k*4,d[m]=e[n],d[m+1]=e[n+1],d[m+2]=e[n+2],d[m+3]=e[n+3]}return c}function getImageDataFromFile(a,b){b=b||function(){};var c=new FileReader;c.onload=function(a){var c=document.createElement("img");c.style.position="absolute",c.style.visibility="hidden",document.body.appendChild(c),c.onload=function(){var a=this.offsetWidth,c=this.offsetHeight,d=document.createElement("canvas");d.width=a,d.height=c;var e=d.getContext("2d");e.drawImage(this,0,0);var f=e.getImageData(0,0,a,c);b(f),this.parentNode.removeChild(this)},c.src=a.target.result},c.readAsDataURL(a)}function SurfaceTool(){this._surfacehandlers={},this._eventMap={},this._eventList=[],this._props={},this._precursor="default"}var Pengi=function(){function d(a,b){return c[a]=c[a]||[],c[a].push(b),function(a,b){return{destroy:function(){c[a][b]=null},exists:function(){return typeof c[a][b]=="function"?!0:!1}}}(a,c[a].length-1)}function e(b,d){d=d||[];var e,f;if(!c[b])return DBG.warn("board","No handlers registered for '"+b+"' event"),!1;DBG.log("board","Emitting '"+b+"' to '"+c[b].length+"' listeners");for(e=0,f=c[b].length;e<f;e+=1)typeof c[b][e]=="function"&&c[b][e].apply(a,d)}function f(){function e(a){var b={dataURI:a.toDataURL(),canvas:{width:a.width,height:a.height}};return b}function f(a,d){d=d||[],typeof c[a]=="function"&&c[a].apply(b,d)}var a=[],b=this,d=-1;this.push=function(b,c){return c=c?!0:!1,c||(d+=1,a.splice(d)),DBG.log("surfacehistory","push","curPos",d,"sticky",c),JSON.stringify(b)!==JSON.stringify(a[a.length-1])?(a.push(b),f("change",this),d>=a.length&&(d=a.length-1),!0):(d>=a.length&&(d=a.length-1),f("change",this),!1)},this.pushCanvas=function(a){return this.push(e(a))},this.getDataAndPush=function(b){this.push(b,!0)||(d-=1);var c=a[d];return DBG.log("surfacehistory","getDataAndPush","curPos",d,"curdata",c),f("change",this),c},this.getDataAndPushCanvas=function(a){return this.getDataAndPush(e(a))},this.getData=function(){d-=1;var b=a[d];return DBG.log("surfacehistory","getData","curPos",d),f("change",this),b},this.getNextData=function(){d+=1,DBG.log("surfacehistory","getNextData","curPos",d);var b=a[d];return f("change",this),b},this.hasUndo=function(){return d===0&&a[d]&&a.length===1?!0:a[d-1]?!0:!1},this.hasRedo=function(){return a.length>0&&a[d+1]?!0:!1},this.on=function(a,b){c[a]=b}}function g(a,c,d,e,g){function D(){applyStylesToNode(m,{left:"0px",top:"0px"});var a=m.getBoundingClientRect(),b=r.getBoundingClientRect(),c=Math.round(b.left-a.left)+1,d=Math.round(b.top-a.top)+1,e=!1,f,g,h;applyStylesToNode(r,{width:Math.round(a.width)+"px",height:Math.round(a.height)+"px"}),v.scale<1?f=1/(v.scale-2)*-1:f=v.scale,Math.floor(f*p.width)>r.offsetWidth&&(e=!0),Math.floor(f*p.height)>r.offsetHeight&&(e=!0),g=r.offsetWidth,h=r.offsetHeight,e?(G("canPan"),s.style.overflow="scroll",h+=t,g+=t):(s.style.overflow="hidden",h-=1,g-=1),s.style.width=g+"px",s.style.height=h+"px",applyStylesToNode(m,{left:c+"px",top:d+"px"})}function E(a,b){return y[a]=y[a]||[],y[a].push(b),function(a,b){return DBG.log("surface","Registering '"+a+"' event [Index, "+b+"]"),{destroy:function(){y[a][b]=null},exists:function(){return typeof y[a][b]=="function"?!0:!1}}}(a,y[a].length-1)}function F(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&a[c]&&(b+=1);return b}function G(a,b){b=b||[];if(!y[a])return!1;var c,d,e=F(y[a]);if(e===0)return!1;DBG.log("surface","Emitting '"+a+"' to '"+e+"' listeners");for(c=0,d=y[a].length;c<d;c+=1)typeof y[a][c]=="function"&&y[a][c].apply(h,b)}function I(a){var b,c,d,f,i;if(a.target.nodeName==="INPUT")return!0;var j=a.type,k=["touchstart","touchmove","touchend"],l=!1,m,n;if(k.indexOf(j)>-1)if((!a.touches||a.touches.length<=1)&&!H){switch(j){case"touchstart":j="mousedown";break;case"touchmove":j="mousemove";break;case"touchend":j="mouseup"}l=!0,a.touches[0]?(m=a.touches[0].pageX,n=a.touches[0].pageY):a.changedTouches[0]&&(m=a.changedTouches[0].clientX,n=a.changedTouches[0].clientY),a.target.parentNode&&(m-=a.target.parentNode.offsetLeft,n-=a.target.parentNode.offsetTop)}else if(a.touches)for(var o=0;o<a.touches.length;o++){var p=a.touches[o];p._custom={touch:!0,type:j,surface:h};var q,r;q=p.pageX,r=p.pageY,p.target&&p.target.parentNode&&(q-=p.target.parentNode.offsetLeft,r-=p.target.parentNode.offsetTop),v.scale<1?d=1/(v.scale-2)*-1:d=v.scale;var s=Math.floor(q/d),t=Math.floor(r/d);p._custom.cellX=s,p._custom.cellY=t,p._custom.pixelX=s+v.offsetX,p._custom.pixelY=t+v.offsetY,p._custom.viewX=s*d,p._custom.viewY=t*d}a._custom={surface:h,type:j,touch:l,lastCellX:z,lastCellY:A,lastPixelX:B,lastPixelY:C};if(a instanceof e.MouseEvent||l)v.scale<1?d=1/(v.scale-2)*-1:d=v.scale,m=m||a.offsetX,n=n||a.offsetY,b=Math.floor(m/d),c=Math.floor(n/d),a._custom.cellX=b,a._custom.cellY=c,a._custom.pixelX=b+v.offsetX,a._custom.pixelY=c+v.offsetY,a._custom.viewX=b*d,a._custom.viewY=c*d,B=a._custom.pixelX,C=a._custom.pixelY;switch(j){case"click":case"mousedown":f=g.activeElement,f&&f.blur();case"mouseup":var u=a.button||0;u===0&&(i="left"),u===1&&(i="middle"),u===2&&(i="right"),i+=j,a._custom.type=i,G.apply(this,[i,[a]]),G.apply(this,[j,[a]]);break;case"mousemove":if(b!=z||c!=A)z=b,A=c,G.apply(this,[j,[a]]);break;default:G.apply(this,[a.type,[a]])}return a.preventDefault(),!1}function J(){v.tool&&v.tool.unload(),L(K().name,!0)}function K(){return v.tool}function L(a,c){function d(a){var c=a.name,d="tool."+c+".",e,f;for(var g in b){if(g.substr(0,d.length)!=d)continue;e=g.substr(d.length);if(!e)continue;f=b[g],a.setProp(e,f)}}function e(){if(typeof ToolBox[a]=="undefined")throw Error("Tool '"+a+"' not found in ToolBox :(");var b=new ToolBox[a](h);b.on("beforecommit",function(){j.pushCanvas(p)}),b.on("commit",function(){G("commit")}),b.on("clipboardwrite",function(a){h.setClipboardData(a)}),v.tool=b,d(b),G("toolchange",[b])}if(v.tool&&a==v.tool.name&&!c)return!1;v.tool?v.tool.unload(function(){e()}):e()}function M(a,b){var c=typeof a=="undefined"?p.width:a,d=typeof b=="undefined"?p.height:b;if(m&&m.width==c&&m.height==d)return!1;m&&m.parentNode&&m.parentNode.removeChild(m),m=g.createElement("canvas"),m.setAttribute("width",c),m.setAttribute("height",d);var e=["mousewheel","mousemove","mousedown","mouseup","mouseout","contextmenu","dblclick","touchstart","touchmove","touchend"];for(var f=0;f<e.length;f++)m.addEventListener(e[f],I,!1);applyStylesToNode(m,{position:"absolute",left:"0px",top:"0px",display:"block"});var h=["keydown","keyup"];r.hasChildNodes()?r.insertBefore(m,r.firstChild):r.appendChild(m);var i=g.body;for(var f=0;f<h.length;f++)i.addEventListener(h[f],I,!1);n=m.getContext("2d"),o=n.createImageData(c,d)}function N(a,b,c){isFinite(a)||(a=0),isFinite(b)||(b=0);var c=w||c,d=v.scale,e;d<1?e=1/(d-2)*-1:e=d;var f=Math.ceil(m.width/e),g=Math.ceil(m.height/e),i=a+f,j=b+g;i>p.width&&(a-=i-p.width),j>p.height&&(b-=j-p.height),a=a<0?0:a,b=b<0?0:b;if(!c&&v.offsetX==a&&v.offsetY==b)return!1;v.offsetX=a,v.offsetY=b,h.render(!1)}function O(a){var b=new Image;b.onload=function(){Q(this)},b.src=a}function P(a,b,c){var d=!0;a==p.width&&b==p.height&&(d=!1),d&&(p=g.createElement("canvas"),p.setAttribute("width",a),p.setAttribute("height",b),G("imageresize",[{width:a,height:b}]),q=p.getContext("2d"));if(typeof c=="string"){var e=g.createElement("img");e.onload=function(){q.clearRect(0,0,p.width,p.height),q.drawImage(this,0,0)},e.src=c}else q.clearRect(0,0,p.width,p.height),q.putImageData(c,0,0);M(),D(),h.render(!0),G("refitCanvas")}function Q(a){q.clearRect(0,0,p.width,p.height),q.drawImage(a,0,0),h.render()}function R(){var a=Math.ceil(p.width/v.scale),b=Math.ceil(a/2+v.offsetX)+1,c=Math.ceil(p.height/v.scale),d=Math.ceil(c/2+v.offsetY)+1;return{x:b,y:d}}function S(){var a=0,b=Math.floor(h.getSizeFactor()*100),c=b,d=0;while(c==b){d++;if(d>100){a=0;break}a++,c=Math.floor(h.getSizeFactor(a)*100)}return a}function T(){var a=0,b=Math.floor(h.getSizeFactor()*100),c=b,d=0;while(c==b){d++;if(d>100){a=0;break}a--,c=Math.floor(h.getSizeFactor(a)*100)}return a}function U(){return Math.floor(h.getSizeFactor()*100)}var h=this,i=null,j=new f,k="default",l="default",m,n,o,p,q,r,s,t,u,v={scale:1,cellX:0,cellY:0,offsetX:0,offsetY:0,fgColor:{r:0,g:0,b:0},bgColor:{r:255,g:255,b:255},tool:null},w=!0,x=-1,y={},z=-1,A=-1,B=-1,C=-1;j.on("change",function(){G("historychange",[j])}),a=parseInt(a,10)||0,c=parseInt(c,10)||0;if(!a||!c)throw new Error("Surface width + height are required in constructor");p=g.createElement("canvas"),p.setAttribute("width",a),p.setAttribute("height",c),q=p.getContext("2d"),q.drawImage(d,0,0),this.on=function(a,b){return E(a,b)},r=g.createElement("div"),s=g.createElement("div"),applyStylesToNode(s,{position:"absolute",overflow:"scroll",zIndex:100,pointerEvents:"none",boxShadow:"0px 0px 12px 1px #222222",border:"1px solid white"}),t=getScrollbarWidth(),u=g.createElement("div"),s.appendChild(u),applyStylesToNode(r,{position:"relative",overflow:"hidden",margin:"25px",marginLeft:"107px",marginTop:"15px",cursor:"default",webkitUserSelect:"none",backgroundImage:"url('transquares.gif')"});var H=!1;h.on("mousewheel",function(a){a.wheelDelta>0?h.zoomIn(a._custom.pixelX,a._custom.pixelY):h.zoomOut(a._custom.pixelX,a._custom.pixelY),G("mousewheelZoom")}),h.on("leftmousedown",function(a){K().handle(a)}),h.on("rightmousedown",function(a){K().handle(a)}),M(),this.setCursor=function(a){if(a==l)return!1;k=l||"default",r.style.cursor=a,l=a},this.revertCursor=function(){h.setCursor(k)},this.getCursor=function(){return l||"default"},this.setOffset=function(a,b){N(a,b)},this.setClipboardData=function(a){i=a},this.getClipboardData=function(){return i},this.getWindow=function(){return e},this.setScale=function(a,b,c){b=b||0,c=c||0,D(),v.scale=a;var d;a<1?d=1/(v.scale-2)*-1:d=a;var e=Math.ceil(m.width/d),f=Math.ceil(m.height/d),g=b-Math.ceil(e/2),h=c-Math.ceil(f/2);N(g,h,!0),N(g,h,!0)},this.appendTo=function(a){if(!(a instanceof e.Node))throw Error(a+" is not a DOM Element");a.appendChild(r),applyStylesToNode(s,{top:r.offsetTop+"px",left:r.offsetLeft+"px"}),a.appendChild(s),s.addEventListener("scroll",function(a){var b;v.scale<1?b=1/(v.scale-2)*-1:b=v.scale;var c=Math.floor(this.scrollLeft/b),d=Math.floor(this.scrollTop/b);(c!=v.offsetX||d!=v.offsetY)&&N(c,d,!0)},!1),D()},this.mirrorImage=function(){J(),j.pushCanvas(p);var a=mirrorImageData(q,q.getImageData(0,0,p.width,p.height));q.putImageData(a,0,0),h.render()},this.flipImage=function(){J(),j.pushCanvas(p);var a=flipImageData(q,q.getImageData(0,0,p.width,p.height));q.putImageData(a,0,0),h.render()},this.grayscaleImage=function(){J(),j.pushCanvas(p);var a=grayscaleImageData(q,q.getImageData(0,0,p.width,p.height));q.putImageData(a,0,0),h.render()},this.sepiaImage=function(){J(),j.pushCanvas(p);var a=sepiaImageData(q,q.getImageData(0,0,p.width,p.height));q.putImageData(a,0,0),h.render()},this.invertImage=function(){J(),j.pushCanvas(p);var a=invertImageData(q,q.getImageData(0,0,p.width,p.height));q.putImageData(a,0,0),h.render()},this.clockImage=function(){J(),j.pushCanvas(p);var a=clockwiseImageData(q,q.getImageData(0,0,p.width,p.height));h.setScale(1),P(a.width,a.height,a),h.render()},this.antiClockImage=function(){J(),j.pushCanvas(p);var a=antiClockwiseImageData(q,q.getImageData(0,0,p.width,p.height));h.setScale(1),P(a.width,a.height,a),h.render()},this.resizeImage=function(a,b){a=a||1,b=b||1,J(),j.pushCanvas(p);var c=document.createElement("canvas");c.width=a,c.height=b;var d=c.getContext("2d");d.drawImage(p,0,0,a,b);var e=d.getImageData(0,0,a,b);h.setScale(1),P(e.width,e.height,e),h.render()},this.refitCanvas=P,this.undo=function(){if(!j.hasUndo())return!1;J();var a;return j.hasRedo()?a=j.getData():a=j.getDataAndPushCanvas(p),a?(P(a.canvas.width,a.canvas.height,a.dataURI),O(a.dataURI)):!1},this.redo=function(){if(!j.hasRedo())return!1;J();var a=j.getNextData();return a?(P(a.canvas.width,a.canvas.height,a.dataURI),O(a.dataURI)):!1},this.renderFromContext=function(a){this.render(!1,a)},this.render=function(a,b){w=!1;var c=b?b.canvas:p,d=e.innerWidth-141,f=e.innerHeight-108,g=v.scale,h=Math.ceil(p.width),i=Math.ceil(p.height),j;g<1?j=1/(g-2)*-1:j=g;var k=Math.floor(p.width*j),l=Math.floor(p.height*j),q=k,r=l;if(x!=v.scale||a)k>d&&(q=d),l>f&&(r=f),M(q,r),D();var t=v.offsetX,y=v.offsetY,j;v.scale<1?j=1/(v.scale-2)*-1:j=v.scale,n.clearRect(0,0,m.width,m.height),g<1?n.drawImage(p,t,y,p.width-t,p.height-y,0,0,Math.floor(k-t*j),Math.floor(l-y*j)):(copyCanvasResampled(c,t,y,h,i,o,p.width*g),n.putImageData(o,0,0)),x=v.scale,u.style.width=p.width*j+"px",u.style.height=p.height*j+"px",s.scrollLeft=v.offsetX*j,s.scrollTop=v.offsetY*j,G("render")},this.setBackgroundColor=function(a,b,c){v.bgColor.r=a||0,v.bgColor.g=b||0,v.bgColor.b=c||0,G("bgcolorchange",[v.bgColor]),G("colorchange",[{bgColor:v.bgColor,fgColor:v.fgColor}])},this.setForegroundColor=function(a,b,c){v.fgColor.r=a||0,v.fgColor.g=b||0,v.fgColor.b=c||0,G("fgcolorchange",[v.fgColor]),G("colorchange",[{bgColor:v.bgColor,fgColor:v.fgColor}])},this.scrollBy=function(a,b){s.scrollLeft+=a,s.scrollTop+=b},this.zoomOutToFit=function(){var a=1,b=100,c=0;for(;;){c++;var d=!1,e;a<1?e=1/(a-2)*-1:e=a,Math.floor(e*p.width)>r.offsetWidth&&(d=!0),Math.floor(e*p.height)>r.offsetHeight&&(d=!0);if(!d||c>=b)break;a--}if(a<1){var f=R(),g=g||f.x,i=i||f.y;h.setScale(a)}G("zoomChange",[U()])},this.getSizeFactor=function(a){a=a||0;var b=v.scale+a;return b<1?1/(b-2)*-1:b},this.zoomIn=function(a,b){var c=R();a=a||c.x,b=b||c.y;var d=S();h.setScale(v.scale+d,a,b),G("zoomChange",[U()])},this.zoomOut=function(a,b){var c=R();a=a||c.x,b=b||c.y;var d=T();h.setScale(v.scale+d,a,b),G("zoomChange",[U()])},this.loadTool=function(a){L(a)},this.getBackgroundColor=function(){return JSON.parse(JSON.stringify(v.bgColor))},this.getForegroundColor=function(){return JSON.parse(JSON.stringify(v.fgColor))},this.getScale=function(){return v.scale},this.getOffsetX=function(){return v.offsetX},this.getOffsetY=function(){return v.offsetY},this.getContainer=function(){return r},this.getCanvas=function(){return p},this.getContext=function(){return q},this.getPngDataAsString=function(){var a=this.getCanvas().toDataURL("image/png"),b="base64,",c=a.indexOf(b);if(c==-1)throw Error("Cannot find proper Data URI signature");var d=[137,80,78,71,13,10,26,10],e=a.substr(c+b.length),f=atob(e);for(var g=0;g<d.length;g++)if(f.charCodeAt(g)!=d[g])throw Error("Invalid PNG Header");return f},this.getContextCopy=function(){var a=g.createElement("canvas");a.width=p.width,a.height=p.height;var b=a.getContext("2d");return b.drawImage(p,0,0),b},this.getViewCanvas=function(){return m},this.getViewContext=function(){return n},this.getPixelsPerSquare=function(){return Math.floor(p.width*v.scale/(p.width/v.scale))},this.destroy=function(){r.parentNode&&r.parentNode.removeChild(r),s.parentNode&&s.parentNode.removeChild(s)},this.getCurrentTool=function(){return K()},this.getImageWidth=function(){return p.width},this.getImageHeight=function(){return p.height},h.setScale(1)}function h(a,c){var d,f=a.ownerDocument;this.getDocument=function(){return f},this.getContainer=function(){return a},this.getSurface=function(){return d||!1},this.setHasClipboard=function(a){e("hasclipboard",[a])},this.loadImageOnSurface=function(h){d=new g(h.offsetWidth,h.offsetHeight,h,c,f),d.appendTo(a),e("surfaceready");var i=b["surface.fgColor"]||{r:0,g:0,b:0},j=b["surface.bgColor"]||{r:255,g:255,b:255};d.setForegroundColor(i.r,i.g,i.b),d.setBackgroundColor(j.r,j.g,j.b),d.zoomOutToFit();var k=new ToolBox.Pan(d);d.on("middlemousedown",function(a){e("mousePan"),k.handle(a)}),d.on("keydown",function(a){if(a.keyCode==17){var b=d.getCurrentTool().name;switch(b){case"Fill":case"Pencil":case"Rect":case"Circle":case"Line":(function(a){var b=d.on("keyup",function(e){d.getCurrentTool().name=="Eyedrop"&&d.loadTool(a),b.destroy(),c&&c.destroy()}),c=d.on("keyup",function(e){d.getCurrentTool().name=="Eyedrop"&&d.loadTool(a),d.loadTool(a),c.destroy(),b&&b.destroy()})})(b),d.loadTool("Eyedrop")}}}),d.loadTool(b["surface.tool"]||"Rect")}}"use strict";var a,b={},c={};return h.prototype.createNew=function(a,b){var c=document.createElement("canvas");c.width=a,c.height=b;var d=c.getContext("2d");d.fillStyle="white",d.fillRect(0,0,a,b),this.openUrl(c.toDataURL())},h.prototype.openUrl=function(a){var b=this.getDocument(),c=this.getContainer(),d=b.createElement("img"),f=this;this.getSurface()&&this.getSurface().destroy(),applyStylesToNode(d,{visibility:"hidden",position:"absolute",top:"0px",left:"opx"}),d.onload=function(){f.loadImageOnSurface(d),this.parentNode.removeChild(this)},d.onerror=function(){throw e("loaderror"),Error("Could not load "+a)},c.appendChild(d),d.src=a},{createIn:function(c,d,e){var f=d||window;b=e||{};if(c instanceof f.Node)return a=new h(c,f),a;throw Error(c+" is not a DOM Element")},on:function(a,b){return d(a,b)}}}(),DBG=function(){function f(a,b){if(!g(a))return!1;var d=a=="warn"?console.warn:console.log,f=(b[0]||"").toLowerCase();if(e.indexOf(f)==-1)return!1;b[0]="["+b[0].toUpperCase()+"]",d.apply(console,b),c&&console.trace()}function g(c){return a&&b&&d.indexOf(c)>-1?!0:!1}var a=!1,b=typeof console.log=="undefined"?!1:!0,c=!1,d=["log","warn"],e=["crop","cropinstance"];return{log:function(){f("log",arguments)},warn:function(){f("warn",arguments)}}}();SurfaceTool.prototype.registerHandler=function(a,b){this.destroyHandler(a),DBG.log("surfacetool","registerHandler: ",a),this._surfacehandlers[a]=this.surface.on(a,b)},SurfaceTool.prototype.removeHandlers=function(){for(var a in this._surfacehandlers)DBG.log("surfacetool","removeHandler (surface): ",a),this._surfacehandlers[a].destroy();this._surfacehandlers={}},SurfaceTool.prototype.requestUnload=function(a){DBG.log("surfacetool","requestUnload was not overidden"),typeof a=="function"&&a()},SurfaceTool.prototype.destroyHandler=function(a){this._surfacehandlers[a]&&(DBG.log("surfacetool","destroyHandler",a),this._surfacehandlers[a].destroy())},SurfaceTool.prototype.getSurface=function(){return this.surface},SurfaceTool.prototype.getInstance=function(){return null},SurfaceTool.prototype.setSurface=function(a){this._precursor==null&&(this._precursor=a.getCursor()),this.surface=a},SurfaceTool.prototype.unload=function(a){var b=this;this.requestUnload(function(){b.surface.setCursor(b._precursor),b.removeHandlers();for(var c=0;c<b._eventList.length;c++)DBG.log("surfacetool","destroyHandler (internal)",b._eventList[c].type),b._eventList[c].destroy();b._eventList.length=0,typeof a=="function"&&a()})},SurfaceTool.prototype.emitEvent=function(a,b){function c(a){var b=0;for(var c in a)a[c]&&b++;return b}b=b||[];if(!this._eventMap[a]||!c(this._eventMap[a]))return DBG.warn("surfacetool","No handlers registered for '"+a+"' event"),!1;DBG.log("surfacetool","Emitting '"+a+"' to '"+c(this._eventMap[a])+"' listeners");for(var d=0,e=this._eventMap[a].length;d<e;d++){if(typeof this._eventMap[a][d]!="function")continue;this._eventMap[a][d].apply(this.getInstance(),b)}},SurfaceTool.prototype.on=function(a,b){this._eventMap[a]=this._eventMap[a]||[],this._eventMap[a].push(b);var c=this,d=function(a,b){return{type:a,destroy:function(){c._eventMap[a][b]=null},exists:function(){return typeof c._eventMap[a][b]=="function"?!0:!1}}}(a,this._eventMap[a].length-1);return this._eventList.push(d),d},SurfaceTool.prototype.setProp=function(a,b){this._props[a]=b,this.emitEvent("propchange",[{name:a,value:b}])},SurfaceTool.prototype.getProp=function(a){return this._props[a]||null},SurfaceTool.prototype.sendHelp=function(a){this.emitEvent("helptip",[{msg:a}])},SurfaceTool.prototype.resetHelp=function(){var a="";this.tip&&this.tip.msg&&(a=this.tip.msg),this.emitEvent("helptip",[{msg:a}])};var ToolBox=ToolBox||{};ToolBox.Select=function(a){this.name="Select",this.tip={msg:"Click and drag to create selection"},this.setSurface(a),this._instance=null,this._mcanvas=null,this._outsourcedData=null,this.setPointerToCrosshair(),this.registerKeyboardHandler()},ToolBox.Select.prototype=new SurfaceTool,ToolBox.Select.constructor=ToolBox.Select,ToolBox.Select.prototype.getInstance=function(){return this._instance},ToolBox.Select.prototype.getOutsource=function(){return this._outsourcedData},ToolBox.Select.prototype.showMovableHelp=function(){var a=this.getInstance();a.exists()&&this.sendHelp("Click and drag on selection to move its position")},ToolBox.Select.prototype.floatClipboardData=function(){var a=this.getSurface(),b=a.getClipboardData();if(!b)return!1;var c=0,d=0;this.initialize(),this._outsourcedData=b;var e=new this.Marquee(c,d,a,this,{nocut:!0});this.setInstance(e),e.setEnd(c+b.width,d+b.height),this.renderMarquee(),this.registerMoverHandler(),a.render()},ToolBox.Select.prototype.registerKeyboardHandler=function(){var a=this,b=this.getSurface();this.registerHandler("keydown",function(c){var d=a.getInstance();switch(c.keyCode){case 46:var e=d.getSourceBounds();if(!e.width||!e.height)return DBG.warn("marqueeinstance","Cannot commit","srcBounds:",e),!1;var f=b.getBackgroundColor();a.emitEvent("beforecommit"),setRegionRGB(b.getContext(),e.x,e.y,e.width,e.height,f),a.emitEvent("commit"),a.removeHandlers(),a.destroyInstance(),a.removeMarquee(),a.setPointerToCrosshair(),b.render();break;case 65:if(!c.ctrlKey)break;a.initialize();var d=new a.Marquee(0,0,b,a,{noimage:!0});a.setInstance(d),d.setEnd(b.getImageWidth(),b.getImageHeight()),a.renderMarquee(),b.setCursor("move"),a.registerMoverHandler(),a.showMovableHelp();break;case 67:if(!c.ctrlKey)break;if(!d||!d.exists())return!1;a.emitEvent("clipboardwrite",[a.getSelectionImageData()]);break;case 86:if(!c.ctrlKey)break;var g=b.getClipboardData();if(!g)return!1;var h=0,i=0;c._custom.lastPixelX&&(h=c._custom.lastPixelX-Math.floor(g.width/2)),c._custom.lastPixelY&&(i=c._custom.lastPixelY-Math.floor(g.height/2)),a.initialize(),a._outsourcedData=g;var d=new a.Marquee(h,i,b,a,{nocut:!0});a.setInstance(d),d.setEnd(h+g.width,i+g.height),a.renderMarquee(),a.handleInstanceMove(c._custom.lastPixelX,c._custom.lastPixelY,c._custom,d),a.registerHandler("mousedown",function(c){a.defloat(),a.initialize(),b.render(),b.revertCursor()}),b.render()}})},ToolBox.Select.prototype.setPointerToCrosshair=function(){var a=this.getSurface();a.setCursor("url(images/assets/crosshair.png) 12 12, pointer")},ToolBox.Select.prototype.requestUnload=function(a){this.defloat();var b=this.getSurface();b.render(),DBG.log("marquee","requestUnload, removing previous marquee"),this.removeMarquee(),a()},ToolBox.Select.prototype.removeMarquee=function(){var a=this.getMarqueeCanvas();a&&a.parentNode&&a.parentNode.removeChild(a);var b=this.getSurface();b.revertCursor()},ToolBox.Select.prototype.setInstance=function(a){this._instance=a},ToolBox.Select.prototype.getMarqueeCanvas=function(){return this._mcanvas},ToolBox.Select.prototype.initMarqueeCanvas=function(){return this._mcanvas=document.createElement("div"),applyStylesToNode(this._mcanvas,{border:"1px dashed white",boxShadow:"0px 0px 8px 0px #222222",position:"absolute",display:"none",pointerEvents:"none",backgroundRepeat:"no-repeat",backgroundPosition:"0px 0px"}),this._mcanvas},ToolBox.Select.prototype.initialize=function(){this._outsourcedData=null,this.removeHandlers();var a=this.getSurface(),b=this;if(!a)return DBG.warn("marquee","Cannot initialize without surface"),!1;DBG.log("marquee","Initializing"),this.registerHandler("render",function(a){var c=b.getInstance();c&&(c.didCut=!1),b.renderMarquee()});var c=this.getMarqueeCanvas();c&&c.parentNode&&(DBG.log("marquee","removing previous marquee"),c.parentNode.removeChild(c)),a.getContainer().appendChild(this.initMarqueeCanvas()),this.registerKeyboardHandler()},ToolBox.Select.prototype.defloat=function(){this.removeHandlers();var a=this.getInstance();a&&a.commit(),this.destroyInstance()},ToolBox.Select.prototype.destroyInstance=function(){this.removeHandlers(),this.setInstance(null),this.registerKeyboardHandler()},ToolBox.Select.prototype.handleInstanceMove=function(a,b,c,d){var e=d.getDestination(),f=this.getSurface(),g=this;f.setCursor("move"),d.setBackgroundColor(f.getBackgroundColor()),g.registerHandler("mousemove",function(c){var f=c._custom,h=f.pixelX-a,i=f.pixelY-b;d.setDestination(e.x+h,e.y+i),g.renderMarquee()}),g.registerHandler("leftmouseup",function(a){g.registerMoverHandler()})},ToolBox.Select.prototype.handleLeftClick=function(a){var b=a._custom,c=this.getSurface(),d=this,e=this.getInstance();if(e&&e.hasPoint(b.pixelX,b.pixelY))return d._mcanvas.style.boxShadow="none",d.handleInstanceMove(b.pixelX,b.pixelY,b,e),!1;e?(this.defloat(),this.initialize()):this.initialize(),e=new this.Marquee(b.pixelX,b.pixelY,c,this),this.setInstance(e),c.render(),d.registerHandler("mousemove",function(a){var b=a._custom;e.setEnd(b.pixelX,b.pixelY),d.renderMarqueeNoImage()}),d.registerHandler("mouseout",function(a){d.registerMoverHandler()}),d.registerHandler("leftmouseup",function(a){d.registerMoverHandler(),d.showMovableHelp()})},ToolBox.Select.prototype.handleRightClick=function(a){this.defloat();var b=this.getSurface();b.render();var c=this.getMarqueeCanvas();c&&c.parentNode&&(DBG.log("marquee","rightClick, removing previous marquee"),c.parentNode.removeChild(c),b.setCursor("url(images/assets/crosshair.png) 12 12, pointer")),this.removeHandlers()},ToolBox.Select.prototype.handle=function(a){switch(a._custom.type){case"leftmousedown":this.handleLeftClick.apply(this,arguments);break;case"rightmousedown":this.handleRightClick.apply(this,arguments)}},ToolBox.Select.prototype.Marquee=function(a,b,c,d,e){e=e||{};var f={x:a,y:b,width:0,height:0},g=!1,h={r:255,g:255,b:255},i=this;this.renderCount=0,this.needsCut=function(){return!e.nocut},this.exists=function(){return f.width==0||f.height==0?!1:!0},this.setDestination=function(a,b){DBG.log("marqueeinstance","setDestination","x:"+a+",y:"+b),g={},g.x=a,g.y=b},this.setEnd=function(c,d){f.width=c-a,f.height=d-b,f.width<0&&(f.width*=-1,f.x=c),f.height<0&&(f.height*=-1,f.y=d),DBG.log("marqueeinstance","setEnd",f)},this.getSourceBounds=function(){return f},this.getFloatBounds=function(){var a=c.getCanvas(),b=this.getSourceBounds(),d=c.getScale(),e;d<1?e=1/(d-2)*-1:e=d;var f=(b.x-c.getOffsetX())*e,g=(b.y-c.getOffsetY())*e,h=b.width*e,i=b.height*e,j=0,k=0,l=this.getDestination();l.floatX+h>a.width&&(j=l.floatX+h-a.width),l.floatY+i>a.height&&(k=l.floatY+i-a.height);var m={x:Math.ceil(f),y:Math.ceil(g),width:Math.ceil(h),height:Math.ceil(i),visibleWidth:Math.ceil((l.floatX<0?h+l.floatX:h)-j),visibleHeight:Math.ceil((l.floatY<0?i+l.floatY:i)-k)};return m.visibleWidth=m.visibleWidth<0?0:m.visibleWidth,m.visibleHeight=m.visibleHeight<0?0:m.visibleHeight,m},this.getFloatImageCanvas=function(a){var b=this.getSourceBounds(),e=document.createElement("canvas");e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.width=a.destWidth,e.height=a.destHeight;var f=e.getContext("2d"),g=f.createImageData(a.destWidth,a.destHeight),h=c.getCanvas(),i=b.x+a.srcX,j=b.y+a.srcY,k=d.getOutsource();if(k){h=document.createElement("canvas"),h.width=k.width,h.height=k.height;var l=h.getContext("2d");l.putImageData(k,0,0),i=a.srcX,j=a.srcY}return copyCanvasResampled(h,i,j,a.srcWidth,a.srcHeight,g,a.destWidth),f.putImageData(g,0,0,0,0,a.destWidth,a.destHeight),e},this.hasPoint=function(a,b){var c=this.getSourceBounds(),d=this.getDestination();return a>=d.x&&b>=d.y&&a<d.x+c.width&&b<d.y+c.height?!0:!1},this.getDestination=function(){var a=c.getScale(),b;a<1?b=1/(a-2)*-1:b=a;var d=(f.x-c.getOffsetX())*b,e=(f.y-c.getOffsetY())*b,h={};if(g!==!1)h={x:g.x,y:g.y};else{var i=this.getSourceBounds();h={x:i.x,y:i.y}}return h.floatX=(h.x-c.getOffsetX())*b,h.floatY=(h.y-c.getOffsetY())*b,h},this.setBackgroundColor=function(a){h.r=a.r||0,h.g=a.g||0,h.b=a.b||0},this.commit=function(){DBG.log("marqueeinstance","commiting");var a=c.getContext(),b=this.getSourceBounds();if(!b.width||!b.height)return DBG.warn("marqueeinstance","Cannot commit","srcBounds:",b),!1;var e=d.getOutsource();e||(e=a.getImageData(b.x,b.y,b.width,b.height)),d.emitEvent("beforecommit"),i.needsCut()&&setRegionRGB(a,b.x,b.y,b.width,b.height,h);var f=this.getDestination();a.putImageData(e,f.x,f.y),d.emitEvent("commit")}},ToolBox.Select.prototype.renderMarquee=function(a){a=a||{};var b=this.getInstance(),c=this.getSurface();if(!b||!b.exists())return DBG.warn("marquee","renderMarquee","Instance does not exist"),!1;var d=b.getFloatBounds(),e=b.getDestination(),f="none",g=this.getMarqueeCanvas(),h=d.width,i=d.height,j=e.floatX,k=e.floatY,l=c.getSizeFactor(),m=0,n=0;e.floatX<0&&(h+=e.floatX,j=0,m=e.floatX*-1),e.floatY<0&&(i+=e.floatY,k=0,n=e.floatY*-1);var o=c.getContainer().offsetWidth,p=c.getContainer().offsetHeight,q=j+h,r=k+i,s=q-o,t=r-p;s>0&&(h-=s),t>0&&(i-=t),h<0&&(h=0),i<0&&(i=0);var u={srcX:Math.floor(m/l),srcY:Math.floor(n/l),srcWidth:Math.ceil(h/l),srcHeight:Math.ceil(i/l),destWidth:h,destHeight:i};DBG.log("marquee","renderMarquee","left:",j+"px","top:",k+"px","width:",h+"px","height:",i+"px","clip:",u);if(u.srcWidth&&u.srcHeight){if(!a.noimage){var v=b.getFloatImageCanvas(u);this._mcanvas.innerHTML="",this._mcanvas.appendChild(v)}applyStylesToNode(g,{display:"block",left:j+"px",top:k+"px",width:h+"px",height:i+"px",zIndex:1})}else DBG.warn("marquee","renderMarquee","Out of view, no need to render"),applyStylesToNode(g,{display:"none"});if(!a.noimage&&b.needsCut()&&!b.didCut){b.didCut=!0;var w=c.getBackgroundColor(),x=d.x,y=d.y,z=d.width,A=d.height;x<0&&(z+=x,x=0),y<0&&(A+=y,y=0),z<0&&(z=0),A<0&&(A=0);var B=z+x,C=A+y;B>o&&(z-=B-o),C>p&&(A-=C-p),z<0&&(z=0),A<0&&(A=0),z&&A&&setRegionRGB(c.getViewContext(),x,y,z,A,w)}},ToolBox.Select.prototype.renderMarqueeNoImage=function(){this.renderMarquee({noimage:!0})},ToolBox.Select.prototype.getSelectionImageData=function(){var a=this.getInstance(),b=this.getSurface(),c=b.getContext(),d=a.getSourceBounds();return c.getImageData(d.x,d.y,d.width,d.height)},ToolBox.Select.prototype.registerMoverHandler=function(){this.destroyHandler("leftmouseup"),this.destroyHandler("mousemove");var a=this.getInstance(),b=this.getSurface(),c=this;if(!a.exists())return!1;this.registerHandler("mousemove",function(d){var e=d._custom;a.hasPoint(e.pixelX,e.pixelY)?b.setCursor("move"):c.setPointerToCrosshair()})};var ToolBox=ToolBox||{};ToolBox.Crop=function(a){this.name="Crop",this.tip={msg:"Click and Drag to select crop area"},this.setSurface(a),this._instance=null,this._mcanvas=null,this._dragAction="move",this._resizable=!1,this._cdivs={up:null,down:null,left:null,right:null},a.setCursor("url(images/assets/crosshair.png) 12 12, pointer")},ToolBox.Crop.prototype=new SurfaceTool,ToolBox.Crop.constructor=ToolBox.Crop,ToolBox.Crop.prototype.getInstance=function(){return this._instance},ToolBox.Crop.prototype.requestUnload=function(a){this.defloat(),a()},ToolBox.Crop.prototype.setInstance=function(a){this._instance=a},ToolBox.Crop.prototype.getMarqueeCanvas=function(){return this._mcanvas},ToolBox.Crop.prototype.initMarqueeCanvas=function(){var a=this.getSurface();for(var b in this._cdivs){var c=document.createElement("div");this._cdivs[b]=c,applyStylesToNode(c,{position:"absolute",pointerEvents:"none",backgroundColor:"#000000",opacity:.7}),a.getContainer().appendChild(c)}},ToolBox.Crop.prototype.initialize=function(){this.removeHandlers();var a=this.getSurface(),b=this;if(!a)return DBG.warn("crop","Cannot initialize without surface"),!1;DBG.log("crop","Initializing"),b.emitEvent("init"),b.resetHelp(),this.registerHandler("render",function(a){b.renderMarquee()}),this.initMarqueeCanvas()},ToolBox.Crop.prototype.defloat=function(){this.destroyInstance()},ToolBox.Crop.prototype.doCrop=function(){var a=this.getInstance(),b=a.getDestination(),c=a.getSourceBounds(),d=this.getSurface(),e=d.getContext(),f=e.canvas,g=b.x<0?0:b.x,h=b.y<0?0:b.y,i=b.x<0?c.width+b.x:c.width,j=b.y<0?c.height+b.y:c.height,k=(f.width-(i+g))*-1,l=(f.height-(j+h))*-1;i=k>0?i-k:i,j=l>0?j-l:j;if(i==0||j==0)return!1;this.emitEvent("beforecommit");var m=e.getImageData(g,h,i,j);d.setScale(1),d.refitCanvas(i,j,m),d.render(),this.emitEvent("commit"),this.removeHandlers(),d.setCursor("default"),this.defloat(),this.initialize()},ToolBox.Crop.prototype.destroyInstance=function(){this.removeHandlers();for(var a in this._cdivs){var b=this._cdivs[a];b&&b.parentNode&&b.parentNode.removeChild(b)}var c=this.getSurface();c.setCursor("url(images/assets/crosshair.png) 12 12, pointer"),this.setInstance(null)},ToolBox.Crop.prototype.handleLeftClick=function(a){var b=a._custom,c=this.getSurface(),d=this,e=this.getInstance();if(e&&e.hasPoint(b.pixelX,b.pixelY)){var f=e.getDestination(),g=e.getSourceBounds(),h=g.x,i=g.y,j=g.width,k=g.height,l=b.pixelX,m=b.pixelY;return d.registerHandler("mousemove",function(a){var b=a._custom,c=b.pixelX-l,g=b.pixelY-m;switch(e._dragAction){case"move":e.setDestination(f.x+c,f.y+g);break;case"n-resize":var n=k+g*-1,o=i+g;n<0&&(n*=-1,o=i+k),e.setStartY(o),e.setHeight(n);break;case"ne-resize":e.setStartY(i+g),e.setWidth(j+c),e.setHeight(k+g*-1);break;case"se-resize":e.setEnd(h+j+c,i+k+g);break;case"w-resize":e.setStartX(h+c),e.setWidth(j+c*-1);break;case"nw-resize":e.setStartX(h+c),e.setStartY(i+g),e.setWidth(j+c*-1),e.setHeight(k+g*-1);break;case"sw-resize":e.setStartX(h+c),e.setWidth(j+c*-1),e.setEndY(i+k+g);break;case"e-resize":e.setEndX(h+j+c);break;case"s-resize":e.setEndY(i+k+g)}d.renderMarquee()}),d.registerHandler("leftmouseup",function(a){d.registerMoverHandler()}),d.registerHandler("dblclick",function(a){d.doCrop()}),!1}e?(this.defloat(),this.initialize()):this.initialize(),e=new this.Marquee(b.pixelX,b.pixelY,c,this),this.setInstance(e),c.render(),d.registerHandler("mousemove",function(a){var b=a._custom;e.setEnd(b.pixelX,b.pixelY),d.renderMarquee()}),d.registerHandler("mouseout",function(a){d.registerMoverHandler()}),d.registerHandler("leftmouseup",function(a){d.registerMoverHandler(),e.exists()&&(d.sendHelp("Double-click on crop area to apply"),d.emitEvent("areacreate"))})},ToolBox.Crop.prototype.handle=function(a){switch(a._custom.type){case"leftmousedown":this.handleLeftClick.apply(this,arguments)}},ToolBox.Crop.prototype.Marquee=function(a,b,c,d){var e={x:a,y:b,width:0,height:0},f=!1,g=this;this.exists=function(){return e.width==0||e.height==0?!1:!0},this.setDestination=function(a,b){DBG.log("cropinstance","setDestination","x:"+a+",y:"+b),f={},f.x=a,f.y=b},this.setWidth=function(a){e.width=a},this.setHeight=function(a){e.height=a},this.setStart=function(a,b){a!==null&&(e.x=a),b!==null&&(e.y=b),DBG.log("cropinstance","setStart",e)},this.setStartX=function(a){this.setStart(a,null)},this.setStartY=function(a){this.setStart(null,a)},this.setEnd=function(c,d){c!==null&&(e.width=c-a),d!==null&&(e.height=d-b),c!==null&&e.width<0&&(e.width*=-1,e.x=c),d!==null&&e.height<0&&(e.height*=-1,e.y=d),DBG.log("cropinstance","setEnd",e)},this.setEndX=function(a){this.setEnd(a,null)},this.setEndY=function(a){this.setEnd(null,a)},this.getSourceBounds=function(){return e},this.getFloatBounds=function(){var a=c.getCanvas(),b=this.getSourceBounds(),d=c.getScale(),e;d<1?e=1/(d-2)*-1:e=d;var f=(b.x-c.getOffsetX())*e,g=(b.y-c.getOffsetY())*e,h=b.width*e,i=b.height*e,j=0,k=0,l=this.getDestination();l.floatX+h>a.width&&(j=l.floatX+h-a.width),l.floatY+i>a.height&&(k=l.floatY+i-a.height);var m={x:Math.ceil(f),y:Math.ceil(g),width:Math.ceil(h),height:Math.ceil(i),visibleWidth:Math.ceil((l.floatX<0?h+l.floatX:h)-j),visibleHeight:Math.ceil((l.floatY<0?i+l.floatY:i)-k)};return m.visibleWidth=m.visibleWidth<0?0:m.visibleWidth,m.visibleHeight=m.visibleHeight<0?0:m.visibleHeight,m},this.hasPoint=function(a,b){var c=this.getSourceBounds(),d=this.getDestination();return a>=d.x&&b>=d.y&&a<d.x+c.width&&b<d.y+c.height?!0:!1},this.getDestination=function(){var a=c.getScale(),b;a<1?b=1/(a-2)*-1:b=a;var d=(e.x-c.getOffsetX())*b,g=(e.y-c.getOffsetY())*b,h={};if(f!==!1)h={x:f.x,y:f.y};else{var i=this.getSourceBounds();h={x:i.x,y:i.y}}return h.floatX=(h.x-c.getOffsetX())*b,h.floatY=(h.y-c.getOffsetY())*b,h},this.commit=function(){DBG.log("cropinstance","commiting");var a=c.getContext(),b=this.getSourceBounds();if(!b.width||!b.height)return DBG.warn("cropinstance","Cannot commit","srcBounds:",b),!1;var e=a.getImageData(b.x,b.y,b.width,b.height);d.emitEvent("beforecommit");var f=this.getDestination();a.putImageData(e,f.x,f.y),d.emitEvent("commit")}},ToolBox.Crop.prototype.renderMarquee=function(){var a=this.getInstance(),b=this.getSurface();if(!a||!a.exists())return DBG.warn("crop","renderMarquee","Instance does not exist"),!1;var c=a.getFloatBounds(),d=a.getDestination(),e=d.floatX<0?0:d.floatX,f=d.floatY<0?0:d.floatY;applyStylesToNode(this._cdivs.up,{top:"0px",left:"0px",width:b.getViewCanvas().width+"px",height:f+"px"}),applyStylesToNode(this._cdivs.down,{top:d.floatY+c.height+"px",left:"0px",width:b.getViewCanvas().width+"px",height:b.getViewCanvas().height-(d.floatY+c.height)+"px"}),applyStylesToNode(this._cdivs.left,{top:d.floatY+"px",left:"0px",width:e+"px",height:c.height+"px"}),applyStylesToNode(this._cdivs.right,{top:d.floatY+"px",left:d.floatX+c.width+"px",width:b.getViewCanvas().width-(d.floatX+c.width)+"px",height:c.height+"px"})},ToolBox.Crop.prototype.registerMoverHandler=function(){function a(a,b){var c=2;d.getScale()==1&&(c=4);for(var e=b-c;e<b+c;e++)if(e==a)return!0;return!1}var b=this;this.destroyHandler("leftmouseup"),this.destroyHandler("mousemove");var c=this.getInstance(),d=this.getSurface();if(!c.exists())return!1;this.registerHandler("mousemove",function(e){var f=e._custom;if(!c.hasPoint(f.pixelX,f.pixelY))return d.setCursor("url(images/assets/crosshair.png) 12 12, pointer"),!0;if(!b._resizable)return c._dragAction="move",d.setCursor("move"),!0;var g=c.getDestination(),h=c.getSourceBounds(),i="";a(f.pixelY,g.y)?i="n":a(f.pixelY,g.y+h.height-1)&&(i="s"),a(f.pixelX,g.x)?i+="w":a(f.pixelX,g.x+h.width-1)&&(i+="e"),i?(c._dragAction=i+"-resize",d.setCursor(i+"-resize")):(c._dragAction="move",d.setCursor("move"))})};var ToolBox=ToolBox||{};ToolBox.Eyedrop=function(a){this.name="Eyedrop",this.tip={msg:"Left click to select Foreground colour, Right click to select Background colour"},this.setSurface(a),a.setCursor("url(images/tooleyedropper.png) 1 14, pointer"),this.registerHandler("mousemove",function(b){var c=b._custom,d=a.getContext().getImageData(c.pixelX,c.pixelY,1,1).data,e="R:"+d[0]+"; G:"+d[1]+"; B:"+d[2],f=d[0].toString(16);f=f.length<2?"0"+f:f;var g=d[1].toString(16);g=g.length<2?"0"+g:g;var h=d[2].toString(16);h=h.length<2?"0"+h:h,e+="\nHex: #"+f+g+h;var i=a.getContainer();i.setAttribute("title",e)})},ToolBox.Eyedrop.prototype=new SurfaceTool,ToolBox.Eyedrop.constructor=ToolBox.Eyedrop,ToolBox.Eyedrop.prototype.requestUnload=function(a){var b=this.getSurface();b.revertCursor();var c=b.getContainer();c.setAttribute("title",""),a()},ToolBox.Eyedrop.prototype.handle=function(a){var b=a._custom,c=this.getSurface(),d=c.getContext().getImageData(b.pixelX,b.pixelY,1,1);switch(a.button){case 0:c.setForegroundColor(d.data[0],d.data[1],d.data[2]);break;case 2:c.setBackgroundColor(d.data[0],d.data[1],d.data[2])}};var ToolBox=ToolBox||{};ToolBox.Pan=function(a){this.name="Pan",this.setSurface(a),a.setCursor("url(images/assets/fleur.png) 12 12, pointer")},ToolBox.Pan.prototype=new SurfaceTool,ToolBox.Pan.constructor=ToolBox.Pan,ToolBox.Pan.prototype.handle=function(a){function i(){d.revertCursor(),b.removeHandlers()}var b=this,c=a._custom,d=this.getSurface(),e=d.getOffsetX(),f=d.getOffsetY(),g=c.cellX,h=c.cellY;d.setCursor("url(images/assets/hand3.png) 12 12, pointer"),this.registerHandler("mousemove",function(a){var b=a._custom,c=g-b.cellX,i=h-b.cellY;d.setOffset(c+e,i+f),d.setCursor("url(images/assets/hand3.png) 12 12, pointer")}),this.registerHandler("leftmouseup",function(a){i()}),this.registerHandler("middlemouseup",function(a){i()}),this.registerHandler("rightmouseup",function(a){i()}),this.registerHandler("mouseout",function(a){d.revertCursor(),b.removeHandlers()})};var ToolBox=ToolBox||{};ToolBox.Zoom=function(a){this.name="Zoom",this.tip={msg:"Left click to Zoom in, Right click to Zoom out"},a.setCursor("url(images/zoompointer.png) 8 8, pointer"),this.setSurface(a)},ToolBox.Zoom.prototype=new SurfaceTool,ToolBox.Zoom.constructor=ToolBox.Zoom,ToolBox.Zoom.prototype.handle=function(a){var b=a._custom,c=this.getSurface();switch(a._custom.type){case"leftmousedown":a.ctrlKey?c.zoomOut(b.pixelX,b.pixelY):c.zoomIn(b.pixelX,b.pixelY);break;case"rightmousedown":c.zoomOut(b.pixelX,b.pixelY)}};var ToolBox=ToolBox||{};ToolBox.Pencil=function(a){this.name="Pencil",this.setSurface(a),a.setCursor("url('images/pencilpointer.png') 3 12, pointer"),this.setProp("size",1)},ToolBox.Pencil.prototype=new SurfaceTool,ToolBox.Pencil.constructor=ToolBox.Pencil,ToolBox.Pencil.prototype.requestUnload=function(a){a()},ToolBox.Pencil.prototype.handleClick=function(a){function k(a){d.destroyHandler("mousemove"),i.lineWidth!==1&&i.stroke(),c.render(),d.emitEvent("commit"),d.removeHandlers()}var b=a._custom,c=this.getSurface(),d=this,e=b.pixelX+.5,f=b.pixelY+.5,g=e,h=f,i=c.getContext();i.lineWidth=this.getProp("size"),i.lineCap="round",i.strokeStyle=this._color,d.emitEvent("beforecommit");var j=null;i.lineWidth===1?(j=i.createImageData(1,1),j.data[0]=this._rgbcolor.r,j.data[1]=this._rgbcolor.g,j.data[2]=this._rgbcolor.b,j.data[3]=255,i.putImageData(j,b.pixelX,b.pixelY),c.render()):(i.beginPath(),i.moveTo(e,f),i.lineTo(e+.5,f+.5),i.stroke(),c.render()),this.registerHandler("mousemove",function(a){var b=a._custom,d=b.pixelX+.5,e=b.pixelY+.5;i.lineWidth===1?(i.putImageData(j,b.pixelX,b.pixelY),g=b.pixelX,h=b.pixelY,c.render()):(i.beginPath(),i.moveTo(g,h),i.lineTo(d,e),i.stroke(),g=d,h=e,c.render())}),this.registerHandler("mouseup",k),this.registerHandler("mouseout",k)},ToolBox.Pencil.prototype.handle=function(a){var b;switch(a._custom.type){case"leftmousedown":b=this.getSurface().getForegroundColor();break;case"rightmousedown":b=this.getSurface().getBackgroundColor()}this.setColor(b),this.handleClick.apply(this,arguments)},ToolBox.Pencil.prototype.setColor=function(a){this._rgbcolor=a,this._color="rgb("+a.r+","+a.g+","+a.b+")"};var ToolBox=ToolBox||{};ToolBox.Line=function(a){this.name="Line",this.setSurface(a),a.setCursor("url(images/assets/crosshair.png) 12 12, pointer"),this.setProp("lineWidth",1)},ToolBox.Line.prototype=new SurfaceTool,ToolBox.Line.constructor=ToolBox.Line,ToolBox.Line.prototype.requestUnload=function(a){a()},ToolBox.Line.prototype.handleClick=function(a){function n(a){d.destroyHandler("mousemove");var b=a._custom,e=b.pixelX,f=b.pixelY;i.lineTo(e,f),i.stroke(),c.render(),d.emitEvent("commit"),d.removeHandlers()}var b=a._custom,c=this.getSurface(),d=this,e=[],f=b.pixelX,g=b.pixelY,h=c.getContext(),i=c.getContextCopy(),j=i.canvas,k=i.getImageData(0,0,j.width,j.height);i.lineWidth=this.getProp("lineWidth"),i.strokeStyle=this._color,d.emitEvent("beforecommit");var l=f,m=g;this.registerHandler("mousemove",function(a){var b=a._custom,d=b.pixelX,e=b.pixelY;i.putImageData(k,0,0),i.beginPath(),i.moveTo(l,m),i.lineTo(d,e),i.stroke(),h.drawImage(j,0,0),c.render()}),this.registerHandler("mouseup",n),this.registerHandler("mouseout",n)},ToolBox.Line.prototype.handle=function(a){var b;switch(a._custom.type){case"leftmousedown":b=this.getSurface().getForegroundColor();break;case"rightmousedown":b=this.getSurface().getBackgroundColor()}this.setColor(b),this.handleClick.apply(this,arguments)},ToolBox.Line.prototype.setColor=function(a){this._color="rgb("+a.r+","+a.g+","+a.b+")"};var ToolBox=ToolBox||{};ToolBox.Rect=function(a){this.name="Rect",this.setSurface(a),a.setCursor("url(images/assets/crosshair.png) 12 12, pointer"),this.setProp("mode","strokefill"),this.setProp("lineWidth",1)},ToolBox.Rect.prototype=new SurfaceTool,ToolBox.Rect.constructor=ToolBox.Rect,ToolBox.Rect.prototype.requestUnload=function(a){a()},ToolBox.Rect.prototype.handleClick=function(a){function q(a){d.destroyHandler("mousemove");var b=a._custom,e=b.pixelX,f=b.pixelY;i.lineTo(e,f),i.stroke(),c.render(),d.emitEvent("commit"),d.removeHandlers()}var b=a._custom,c=this.getSurface(),d=this,e=[],f=b.pixelX,g=b.pixelY,h=c.getContext(),i=c.getContextCopy(),j=i.canvas,k=i.getImageData(0,0,j.width,j.height),l=this.getProp("lineWidth");i.lineWidth=l,i.strokeStyle=this._fgcolor,i.fillStyle=this._bgcolor,d.emitEvent("beforecommit");var m=f,n=g,o=m,p=n;d.emitEvent("boundschange",[{left:f,top:g,right:f,bottom:g,width:0,height:0}]),l%2!=0&&(m-=.5,n-=.5),this.registerHandler("mousemove",function(a){var b=a._custom,e=b.pixelX,f=b.pixelY;i.putImageData(k,0,0),i.beginPath();var g=o<e?o:e,q=p<f?p:f,r=e>o?e:o,s=f>p?f:p;d.emitEvent("boundschange",[{left:g,top:q,right:r,bottom:s,width:r-g,height:s-q}]),l%2!=0&&(e-=.5,f-=.5),i.rect(m,n,e-m,f-n),d.getProp("mode")!="stroke"&&i.fill(),d.getProp("mode")!="fill"&&i.stroke(),h.drawImage(j,0,0),c.render()}),this.registerHandler("mouseup",q),this.registerHandler("mouseout",q)},ToolBox.Rect.prototype.handle=function(a){var b,c;switch(a._custom.type){case"leftmousedown":b=this.getSurface().getForegroundColor(),c=this.getSurface().getBackgroundColor();break;case"rightmousedown":c=this.getSurface().getForegroundColor(),b=this.getSurface().getBackgroundColor()}this.setFgColor(b),this.setBgColor(c),this.handleClick.apply(this,arguments)},ToolBox.Rect.prototype.setFgColor=function(a){this._fgcolor="rgb("+a.r+","+a.g+","+a.b+")"},ToolBox.Rect.prototype.setBgColor=function(a){this._bgcolor="rgb("+a.r+","+a.g+","+a.b+")"};var ToolBox=ToolBox||{};ToolBox.Circle=function(a){this.name="Circle",this.setSurface(a),a.setCursor("url(images/assets/crosshair.png) 12 12, pointer"),this.setProp("mode","strokefill"),this.setProp("lineWidth",2)},ToolBox.Circle.prototype=new SurfaceTool,ToolBox.Circle.constructor=ToolBox.Circle,ToolBox.Circle.prototype.requestUnload=function(a){a()},ToolBox.Circle.prototype.handleClick=function(a){function o(a){d.destroyHandler("mousemove");var b=a._custom,e=b.pixelX,f=b.pixelY;i.lineTo(e,f),i.stroke(),c.render(),d.emitEvent("commit"),d.removeHandlers()}var b=a._custom,c=this.getSurface(),d=this,e=[],f=b.pixelX,g=b.pixelY,h=c.getContext(),i=c.getContextCopy(),j=i.canvas,k=i.getImageData(0,0,j.width,j.height),l=this.getProp("lineWidth");i.lineWidth=l,i.strokeStyle=this._fgcolor,i.fillStyle=this._bgcolor,d.emitEvent("beforecommit");var m=f,n=g;l%2!=0&&(m-=.5,n-=.5),this.registerHandler("mousemove",function(a){var b=a._custom,e=b.pixelX,f=b.pixelY;i.putImageData(k,0,0),i.beginPath(),l%2!=0&&(e+=.5,f+=.5);var g=e-m;g=g<0?g*=-1:g,i.arc(m,n,g,0,2*Math.PI),d.getProp("mode")!="stroke"&&i.fill(),d.getProp("mode")!="fill"&&i.stroke(),h.drawImage(j,0,0),c.render()}),this.registerHandler("mouseup",o),this.registerHandler("mouseout",o)},ToolBox.Circle.prototype.handle=function(a){var b,c;switch(a._custom.type){case"leftmousedown":b=this.getSurface().getForegroundColor(),c=this.getSurface().getBackgroundColor();break;case"rightmousedown":c=this.getSurface().getForegroundColor(),b=this.getSurface().getBackgroundColor()}this.setFgColor(b),this.setBgColor(c),this.handleClick.apply(this,arguments)},ToolBox.Circle.prototype.setFgColor=function(a){this._fgcolor="rgb("+a.r+","+a.g+","+a.b+")"},ToolBox.Circle.prototype.setBgColor=function(a){this._bgcolor="rgb("+a.r+","+a.g+","+a.b+")"};var ToolBox=ToolBox||{};ToolBox.Fill=function(a){this.name="Fill",this.setSurface(a),a.setCursor("url('images/toolfill.png') 1 14, pointer"),this._donePixels={},this._inprogress=!1},ToolBox.Fill.prototype=new SurfaceTool,ToolBox.Fill.constructor=ToolBox.Fill,ToolBox.Fill.prototype.requestUnload=function(a){a()},ToolBox.Fill.prototype.reset=function(){this._donePixels={}},ToolBox.Fill.prototype.handleClick=function(a){if(this._inprogress)return!1;this._inprogress=!0,this.reset();var b=a._custom,c=this.getSurface(),d=this,e=b.pixelX,f=b.pixelY,g=c.getContext(),h=g.canvas,i=g.getImageData(0,0,h.width,h.height),j=this.getColor(),k=this.getPixelAt(i,e,f);if(!k)return!1;var l={r:k.r,g:k.g,b:k.b};if(JSON.stringify(l)==JSON.stringify(j))return this._inprogress=!1,!1;var m=[];m.push(k),this._inprogress=!0;while(m.length>0){var n=m.pop();if(n.r==l.r&&n.g==l.g&&n.b==l.b){this._donePixels[n.x]=this._donePixels[n.x]||{};if(this._donePixels[n.x][n.y])continue;this.setPixelAt(i,n.x,n.y,j),this._donePixels[n.x][n.y]=1;var o=this.getRelatives(i,n.x,n.y);for(var e=0;e<o.length;e++)m.push(o[e])}}d.emitEvent("beforecommit"),g.putImageData(i,0,0),c.render(),d.emitEvent("commit"),this._inprogress=!1},ToolBox.Fill.prototype.getRelatives=function(a,b,c){var d=[],e;return e=this.getPixelAt(a,b-1,c),e!==!1&&d.push(e),e=this.getPixelAt(a,b+1,c),e!==!1&&d.push(e),e=this.getPixelAt(a,b,c-1),e!==!1&&d.push(e),e=this.getPixelAt(a,b,c+1),e!==!1&&d.push(e),d},ToolBox.Fill.prototype.getPixelPosition=function(a,b,c){var d=b*4+c*4*a.width;for(var b=0;b<4;b++)if(typeof a.data[b+d]!="number")return!1;return d},ToolBox.Fill.prototype.setPixelAt=function(a,b,c,d){var e=this.getPixelPosition(a,b,c);a.data[e]=d.r,a.data[e+1]=d.g,a.data[e+2]=d.b,a.data[e+3]=255},ToolBox.Fill.prototype.getPixelAt=function(a,b,c){if(b<0||c<0)return!1;if(b+1>a.width||c+1>a.height)return!1;var d={r:0,g:0,b:0,alpha:0,x:b,y:c},e=this.getPixelPosition(a,b,c);return e===!1?!1:(d.r=a.data[e],d.g=a.data[e+1],d.b=a.data[e+2],d.alpha=a.data[e+3],d)},ToolBox.Fill.prototype.handle=function(a){var b;switch(a._custom.type){case"leftmousedown":b=this.getSurface().getForegroundColor();break;case"rightmousedown":b=this.getSurface().getBackgroundColor()}this.setColor(b),this.handleClick.apply(this,arguments)},ToolBox.Fill.prototype.setColor=function(a){this._color=a},ToolBox.Fill.prototype.getColor=function(){return this._color}