var PengiUILoader=function(a,b,c,d){function g(a){if(c["help.donetip."+a])return!1;if(f.indexOf(a)!=-1)return!1;f.push(a);var b=e[a];b.id=a,LostUI.notifications.create(b)}function h(a){if(c["help.donetip."+a])return!1;K("prefwriterequest",["help.donetip."+a,!0])}function i(a){var b="R:"+a.r+"; G:"+a.g+"; B:"+a.b,c=a.r.toString(16);c=c.length<2?"0"+c:c;var d=a.g.toString(16);d=d.length<2?"0"+d:d;var e=a.b.toString(16);return e=e.length<2?"0"+e:e,b+="\nHex: #"+c+d+e,b}function j(a){var c=b.getElementById("bgcolorbox");c.style.backgroundColor="rgb("+a.r+","+a.g+","+a.b+")",c.setAttribute("title",i(a))}function k(a){var c=b.getElementById("fgcolorbox");c.style.backgroundColor="rgb("+a.r+","+a.g+","+a.b+")",c.setAttribute("title",i(a))}function l(a){var c=b.createElement("canvas"),d=64,e=Math.sqrt(d);c.width=e,c.height=e;var f=c.getContext("2d");f.drawImage(a,0,0,a.width,a.height,0,0,e,e);var g=f.getImageData(0,0,e,e),h=0,i=0,j=0,k=0,l=0,m=0;for(var n=0;n<g.data.length;n+=4){var o=[g.data[n],g.data[n+1],g.data[n+2]];o.sort(function(a,b){return a-b});var p=o[2]-o[1];p+=o[1]-o[0],l+=p,m++}k=Math.ceil(l/m);for(var n=0;n<g.data.length;n+=4){var o=[g.data[n],g.data[n+1],g.data[n+2]];o.sort(function(a,b){return a-b});var p=o[2]-o[1];p+=o[1]-o[0];if(p<k){d--;continue}h+=g.data[n],i+=g.data[n+1],j+=g.data[n+2]}h=Math.floor(h/d),i=Math.floor(i/d),j=Math.floor(j/d);var q,r,s,t=Math.max(h,i,j);t||(t=1);var u={},v=255/t;q=Math.floor(v*h),u.r=q,r=Math.floor(v*i),u.g=r,s=Math.floor(v*j),u.b=s,b.body.style.backgroundColor="rgb("+u.r+","+u.g+","+u.b+")"}function m(a){var c=b.getElementById("optRectStrokeFill"),d=b.getElementById("optRectStroke"),e=b.getElementById("optRectFill");c.className="actionBtt",d.className="actionBtt",e.className="actionBtt";switch(a){case"stroke":d.className+=" selected";break;case"fill":e.className+=" selected";break;case"strokefill":c.className+=" selected"}}function n(a){var c=b.getElementById("optCircleStrokeFill"),d=b.getElementById("optCircleStroke"),e=b.getElementById("optCircleFill");c.className="actionBtt",d.className="actionBtt",e.className="actionBtt";switch(a){case"stroke":d.className+=" selected";break;case"fill":e.className+=" selected";break;case"strokefill":c.className+=" selected"}}function o(a){var c="images/circlestrokefill.gif",d="images/circlestroke.gif",e="images/circlefill.gif",f=b.getElementById("imgCircleStrokeFill"),g=b.getElementById("imgCircleStroke"),h=b.getElementById("imgCircleFill");y(c,{r:101,g:67,b:33},a.getForegroundColor(),function(b){y(b,{r:18,g:52,b:86},a.getBackgroundColor(),function(b){f.style.backgroundImage="url('"+b+"')",y(d,{r:101,g:67,b:33},a.getForegroundColor(),function(a){g.style.backgroundImage="url('"+a+"')"}),y(e,{r:18,g:52,b:86},a.getBackgroundColor(),function(a){h.style.backgroundImage="url('"+a+"')"})})})}function p(a){var c="images/rectstrokefill.gif",d="images/rectstroke.gif",e="images/rectfill.gif",f=b.getElementById("imgRectStrokeFill"),g=b.getElementById("imgRectStroke"),h=b.getElementById("imgRectFill");y(c,{r:101,g:67,b:33},a.getForegroundColor(),function(b){y(b,{r:18,g:52,b:86},a.getBackgroundColor(),function(b){f.style.backgroundImage="url('"+b+"')",y(d,{r:101,g:67,b:33},a.getForegroundColor(),function(a){g.style.backgroundImage="url('"+a+"')"}),y(e,{r:18,g:52,b:86},a.getBackgroundColor(),function(a){h.style.backgroundImage="url('"+a+"')"})})})}function q(a){if(this.className.indexOf("disabled")!=-1)return!1;var b=z.getSurface();switch(this.getAttribute("data-action")){case"undo":b.undo();break;case"redo":b.redo();break;default:throw Error("Unhandled action button ID")}}function r(a,c){function e(a){var b=a.value,c="";for(var e=0;e<b.length;e++){var f=b.charAt(e).toLowerCase();if(d.indexOf(f)==-1)continue;c+=f}c="#"+c.split("#").join(""),c=c.substr(0,7),a.value=c}var d=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","#"];LostUI.dialogs.create({title:"Colour",icon:"url('images/pallete.png')",content:b.getElementById("tplColours"),width:"300px",height:"440px",submit:function(b){a(b.hex),LostUI.dialogs.close()},cancellable:!0,ready:function(a){function f(){a.preview.style.backgroundColor="rgb("+a.red.value+","+a.green.value+","+a.blue.value+")"}function g(){a.hex.value=v({r:parseInt(a.red.value,10),g:parseInt(a.green.value,10),b:parseInt(a.blue.value,10)}),f()}var h=u(c);a.red.oninput=function(){g()},a.green.oninput=function(){g()},a.blue.oninput=function(){g()},a.hex.onkeypress=function(a){var b=String.fromCharCode(a.charCode).toLowerCase();if(d.indexOf(b)==-1)return!1},a.hex.oninput=function(){e(this);var b=u(this.value);a.red.value=b.r||0,a.green.value=b.g||0,a.blue.value=b.b||0,f()};var i=!1,j;a.spectrum.onmousedown=function(c){i||(i=b.createElement("canvas"),i.width=this.offsetWidth,i.height=this.offsetHeight,j=i.getContext("2d"),j.drawImage(this,0,0));var d=j.getImageData(c.offsetX,c.offsetY,1,1);return a.red.value=d.data[0],a.green.value=d.data[1],a.blue.value=d.data[2],g(),!1},a.red.value=h.r,a.green.value=h.g,a.blue.value=h.b,a.hex.value=c,f()}})}function s(){var b=a.navigator.userAgent,c=b.indexOf("Chrome")+7;return parseInt(b.substr(c),10)}function t(a,c){if(s()<29){r.apply(this,arguments);return}var d=b.createElement("input");c=c||"#000000",d.onchange=function(){a(this.value),this.parentNode&&this.parentNode.removeChild(this)},d.type="color",d.style.zIndex=-100,d.style.left="0px",d.style.top="0px",d.style.position="absolute",d.value=c,d.style.visibility="hidden",b.body.appendChild(d),d.focus(),d.click()}function u(a){a=a.substr(1);var b={};return b.r=parseInt(a.substr(0,2),16),b.g=parseInt(a.substr(2,2),16),b.b=parseInt(a.substr(4,2),16),b}function v(a){var b="#",c;return c=a.r.toString(16),b+=c.length==1?"0"+c:c,c=a.g.toString(16),b+=c.length==1?"0"+c:c,c=a.b.toString(16),b+=c.length==1?"0"+c:c,b}function w(a,c){b.getElementById("imageDims").innerHTML=a+" x "+c}function x(){var a,c=b.getElementsByClassName("actionBtt"),d=b.getElementsByClassName("dropaction"),e=[];for(var f=0;f<c.length;f++)e.push(c[f]);for(var f=0;f<d.length;f++)e.push(d[f]);var g,h={};for(var f=0;f<e.length;f++){a=e[f],g=a.getAttribute("data-action");if(!g)continue;h[g]=a}return h}function y(a,c,d,e){var f=b.createElement("img");f.onload=function(){var a=b.createElement("canvas");a.width=this.offsetWidth,a.height=this.offsetHeight;var f=a.getContext("2d");f.drawImage(this,0,0),this.parentNode.removeChild(this);var g=f.getImageData(0,0,a.width,a.height),h=g.data,i,j,k;for(var l=0,m=h.length;l<m;l+=4)i=h[l],j=h[l+1],k=h[l+2],i==c.r&&j==c.g&&k==c.b&&(h[l]=d.r,h[l+1]=d.g,h[l+2]=d.b);f.putImageData(g,0,0),e(a.toDataURL()),a=null},f.src=a,f.style.visibility="hidden",b.body.appendChild(f)}function A(){var a=b.getElementsByClassName("dropDown");for(var c=0;c<a.length;c++)a[c].onclick=function(){this.style.display="none"}}function F(){LostUI.dialogs.create({width:"225px",height:"160px",title:"Create New Image",icon:"url('images/actnew.png')",content:b.getElementById("tplCreatenew"),submit:function(a){LostUI.dialogs.close(),z.createNew(a.width,a.height)}})}function G(){var a=b.getElementById("toolbox"),c=a.getElementsByClassName("actionBtt");for(var d=0;d<c.length;d++)c[d].onclick=function(){var a=this.getAttribute("data-type");z.getSurface().loadTool(a)}}function H(a){var c=b.getElementById("toolbox"),d=c.getElementsByClassName("actionBtt");for(var e=0;e<d.length;e++)d[e].className="actionBtt",d[e].getAttribute("data-type")==a&&(d[e].className="actionBtt selected");I(a)}function I(a){var c=b.getElementById("toolOptions"),d=c.getElementsByClassName("optionGroup");for(var e=0;e<d.length;e++){var f=d[e].getAttribute("data-tool");if(a==f){d[e].style.display="block";continue}d[e].style.display="none"}}function K(a,b){if(typeof J[a]!="function")return!1;b=b||[],J[a].apply(this,b)}var e={dropperToggle:{title:"Dropper Tool",message:"Press <kbd>Ctrl</kbd> to toggle while using another drawing tool",image:"url('images/tippicker.png')"},zoomWheel:{title:"Zoom",message:"Use the mouse wheel to zoom in or zoom out",image:"url('images/tipmousewheel.png')"},middlePan:{title:"Panning",message:"Hold down the middle mouse button to pan the image",image:"url('images/tipmousewheel.png')"}},f=[];d=d||{},d.msLoadDelay=d.msLoadDelay||0;var z;b.getElementById("sidebar").style.height=a.innerHeight-35+"px",G(),A(),b.body.ontouchmove=function(){return!1};var B=x(),C=b.getElementById("switchcolors");B.imagetools.onclick=function(){function c(d){a.style.backgroundImage="";if(d.target.parentNode===a)return!1;if(d.target.className=="dropaction")return!1;var e=b.getElementsByClassName("dropDown");for(var f=0;f<e.length;f++)e[f].style.display="none";b.body.removeEventListener("mousedown",c,!1)}var a=this,d=b.getElementById("toolsDropDown");d.style.display="block",this.style.backgroundImage="url('images/assets/browser_toolbar_bezel_pressed.png')",b.body.addEventListener("mousedown",c,!1)},B.undo.onclick=q,B.redo.onclick=q;var D=b.getElementById("pixelCoor"),E=b.getElementById("zoomLevel");z=Pengi.createIn(b.body,a,c),Pengi.on("loaderror",function(){LostUI.dialogs.create({width:"360px",height:"165px",title:"Error",icon:"url('images/warning.png')",cancellable:!1,content:b.getElementById("tplLoaderror"),submit:function(){LostUI.dialogs.close(),K("requestfile")}})}),Pengi.on("mousePan",function(){h("middlePan")}),Pengi.on("hasclipboard",function(a){a?B.paste.className="actionBtt":B.paste.className="actionBtt disabled"}),Pengi.on("surfaceready",function(){LostUI.dialogs.setDocument(b),LostUI.loader.setDocument(b),LostUI.notifications.setDocument(b),setTimeout(function(){g("zoomWheel")},d.msLoadDelay);var c=this.getSurface();l(c.getViewCanvas()),w(c.getImageWidth(),c.getImageHeight()),B.undo.className="actionBtt disabled",B.redo.className="actionBtt disabled",B.paste.className="actionBtt",B.new.onclick=function(){F()},B.open.onclick=function(){K("requestfile")},B.save.onclick=function(){K("savefile")},B.paste.onclick=function(){var a=this.className;if(a.indexOf("disabled")!=-1)return!1;b.body.className="pasteField",K("requestpaste"),b.body.className=""},b.getElementById("fgcolorbox").onclick=function(){var a=v(c.getForegroundColor());t(function(a){var b=u(a);c.setForegroundColor(b.r,b.g,b.b)},a)},b.getElementById("bgcolorbox").onclick=function(){var a=v(c.getBackgroundColor());t(function(a){var b=u(a);c.setBackgroundColor(b.r,b.g,b.b)},a)},b.getElementById("footer").style.width=a.innerWidth-2+"px",b.getElementById("sidebar").style.height=a.innerHeight-35+"px",a.onresize=function(){c.render(!0),b.getElementById("sidebar").style.height=a.innerHeight-35+"px",b.getElementById("footer").style.width=a.innerWidth-2+"px"},c.on("mousewheelZoom",function(){h("zoomWheel")}),c.on("canPan",function(){g("middlePan")});var e=!1;c.on("render",function(){e&&clearTimeout(e),e=setTimeout(function(){l(c.getViewCanvas()),e=!1},1e3)}),c.on("imageresize",function(a){w(a.width,a.height)}),c.on("bgcolorchange",function(a){j(a),p(c),o(c)}),c.on("fgcolorchange",function(a){k(a),p(c),o(c)}),c.on("toolchange",function(a){var c=a.name,d=b.getElementById("contexthelp");d.innerHTML=a.tip&&a.tip.msg||"",H(c);var e=b.getElementById("toolOptions");e.style.opacity=1,a.on("helptip",function(a){d.innerHTML=a&&a.msg||""});switch(c){case"Circle":n(a.getProp("mode"));var f=b.getElementById("optCircleLineWidth");f.value=a.getProp("lineWidth"),f.onchange=function(){a.setProp("lineWidth",this.value)};var g=b.getElementById("optCircleStrokeFill"),h=b.getElementById("optCircleStroke"),i=b.getElementById("optCircleFill");g.onclick=function(){a.setProp("mode","strokefill")},i.onclick=function(){a.setProp("mode","fill")},h.onclick=function(){a.setProp("mode","stroke")},a.on("propchange",function(a){switch(a.name){case"mode":n(a.value)}});break;case"Rect":m(a.getProp("mode"));var f=b.getElementById("optRectLineWidth");f.value=a.getProp("lineWidth"),f.onchange=function(){a.setProp("lineWidth",this.value)};var g=b.getElementById("optRectStrokeFill"),h=b.getElementById("optRectStroke"),i=b.getElementById("optRectFill");g.onclick=function(){a.setProp("mode","strokefill")},i.onclick=function(){a.setProp("mode","fill")},h.onclick=function(){a.setProp("mode","stroke")},a.on("propchange",function(a){switch(a.name){case"mode":m(a.value)}}),a.on("boundschange",function(a){var b="";a.width&&a.height&&(b=" ["+parseFloat(a.width/a.height+"").toFixed(3)+"] "),D.innerHTML="("+a.left+", "+a.top+") &#x21E8 ("+a.right+", "+a.bottom+") = ("+a.width+" x "+a.height+") "+b+" &#x205E; "});break;case"Pencil":var f=b.getElementById("optPencilSize");f.value=a.getProp("size"),f.onchange=function(){a.setProp("size",this.value)};break;case"Line":var f=b.getElementById("optLineWidth");f.value=a.getProp("lineWidth"),f.onchange=function(){a.setProp("lineWidth",this.value)};break;case"Crop":var f=b.getElementById("optCropApply");a.on("areacreate",function(){f.disabled=!1}),a.on("init",function(){f.disabled=!0}),f.onclick=function(){a.doCrop()};break;default:e.style.opacity=0}K("prefwriterequest",["surface.tool",c]),a.on("propchange",function(b){K("prefwriterequest",["tool."+a.name+"."+b.name,b.value])})}),c.on("zoomChange",function(a){E.innerHTML="&#x205E; Zoom: "+a+"%"}),c.on("fgcolorchange",function(a){K("prefwriterequest",["surface.fgColor",a])}),c.on("bgcolorchange",function(a){K("prefwriterequest",["surface.bgColor",a])}),c.on("mousemove",function(a){var b=a._custom;D.innerHTML="(x:"+b.pixelX+" y:"+b.pixelY+") &#x205E; "}),c.on("mouseout",function(a){D.innerHTML=""}),c.on("historychange",function(a){K("historychange",[a]),a.hasUndo()?B.undo.className="actionBtt":B.undo.className="actionBtt disabled",a.hasRedo()?B.redo.className="actionBtt":B.redo.className="actionBtt disabled"}),C.onclick=function(){var a=c.getForegroundColor(),b=c.getBackgroundColor();c.setForegroundColor(b.r,b.g,b.b),c.setBackgroundColor(a.r,a.g,a.b)};var f=!1;b.body.addEventListener("keydown",function(a){function c(a){f.parentNode.removeChild(f)}if(a.keyCode==17){if(!f||!f.parentNode)f=b.createElement("input"),f.type="text",f.style.opacity=0,f.style.position="absolute",f.style.top="0px",f.style.left="0px",f.className="pasteField";b.body.appendChild(f),f.focus(),f.onkeydown=function(a){var c=new KeyboardEvent(a.type,{bubbles:!0,cancelable:!0,key:String.fromCharCode(a.keyCode),"char":String.fromCharCode(a.charCode),ctrlKey:a.ctrlKey,shiftKey:a.shiftKey});delete c.keyCode,Object.defineProperty(c,"keyCode",{value:a.keyCode}),b.body.dispatchEvent(c)},f.onkeyup=function(a){a.keyCode==17&&this.parentNode.removeChild(this);var c=b.createEvent("KeyboardEvent");c.initKeyboardEvent("keyup",a.bubbles,a.cancelable,a.view,a.charCode,a.keyCode,a.location),b.body.dispatchEvent(c)}}},!1),b.body.addEventListener("paste",function(a){if(a.target.className!="pasteField")return!1;var b=a.clipboardData,d=b.items;for(var e=0;e<d.length;e++){var f=d[e];if(f.kind!="file")continue;if(f.type.indexOf("image/")!==0)continue;getImageDataFromFile(f.getAsFile(),function(a){c.setClipboardData(a),c.loadTool("Select");var b=c.getCurrentTool();b.floatClipboardData()})}},!1),b.body.addEventListener("keydown",function(a){if(a.target.nodeName==="INPUT")return!0;var b=a.ctrlKey||a.altKey||a.shiftKey,d=10;a.shiftKey&&(d*=10);switch(a.keyCode){case 109:case 189:c.zoomOut();break;case 107:case 187:c.zoomIn();break;case 37:c.scrollBy(d*-1,0);break;case 38:c.scrollBy(0,d*-1);break;case 39:c.scrollBy(d,0);break;case 40:c.scrollBy(0,d);break;case 66:!b&&c.loadTool("Pencil");break;case 72:!b&&c.loadTool("Pan");break;case 73:!b&&c.loadTool("Eyedrop");break;case 76:!b&&c.loadTool("Line");break;case 77:!b&&c.loadTool("Select");break;case 82:!b&&c.loadTool("Rect");break;case 67:!b&&c.loadTool("Crop");break;case 71:!b&&c.loadTool("Fill");break;case 78:a.ctrlKey&&F();break;case 79:a.ctrlKey&&K("requestfile");break;case 83:a.ctrlKey&&K("savefile");break;case 90:a.ctrlKey?a.shiftKey?c.redo():c.undo():!b&&c.loadTool("Zoom");break;default:}}),B.flip.onclick=function(){c.flipImage()},B.mirror.onclick=function(){c.mirrorImage()},B.grayscale.onclick=function(){c.grayscaleImage()},B.sepia.onclick=function(){c.sepiaImage()},B.invert.onclick=function(){c.invertImage()},B.rotatecw.onclick=function(){c.clockImage()},B.rotateccw.onclick=function(){c.antiClockImage()},B.resize.onclick=function(){var a=4e3;LostUI.dialogs.create({width:"210px",height:"200px",title:"Resize Image",icon:"url('images/actresize.png')",content:b.getElementById("tplResize"),ready:function(b){function f(){b.height.value=Math.floor(b.width.value/d)}function g(){b.width.value=Math.floor(b.height.value*d)}function h(){var c=!1;b.width.value>a&&(b.width.value=a,c=!0,e&&f()),b.height.value>a&&(b.height.value=a,c=!0,e&&g()),c&&h()}var d=c.getImageWidth()/c.getImageHeight(),e=b.keepratio.checked;b.width.value=c.getImageWidth(),b.height.value=c.getImageHeight(),b.keepratio.onclick=function(){e=this.checked,e&&f()},b.width.oninput=function(){h(),e&&f()},b.height.oninput=function(){h(),e&&g()}},submit:function(b){var d=b.width||100;d>a&&(d=a);var e=b.height||100;e>a&&(e=a),c.resizeImage(d,e),LostUI.dialogs.close()}})}}),d.createblank!==!1&&z.createNew(640,480);var J={};return{on:function(a,b){J[a]=b},openUrl:function(a){LostUI.loader.show(),z.openUrl(a)},board:z,message:{savewarn:function(a){if(c["messages.savewarn.skip"])return a(),!0;LostUI.dialogs.create({width:"420px",height:"260px",title:"Data Loss Warning",icon:"url('images/warning.png')",cancellable:!1,content:b.getElementById("tplSavewarn"),submit:function(b){b.dontask&&K("prefwriterequest",["messages.savewarn.skip",!0]),LostUI.dialogs.close(),a.apply(this,arguments)}})},pastewarn:function(a){a=a||function(){},LostUI.dialogs.create({width:"380px",height:"170px",title:"Clipboard Error",icon:"url('images/warning.png')",cancellable:!1,content:b.getElementById("tplPasteErr"),submit:function(b){LostUI.dialogs.close(),a.apply(this,arguments)}})}}}}