(()=>{function t(t,e,r,i){Object.defineProperty(t,e,{get:r,set:i,enumerable:!0,configurable:!0})}var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},r={},i={},a=e.parcelRequire60cc;null==a&&((a=function(t){if(t in r)return r[t].exports;if(t in i){var e=i[t];delete i[t];var a={id:t,exports:{}};return r[t]=a,e.call(a.exports,a,a.exports),a.exports}var s=new Error("Cannot find module '"+t+"'");throw s.code="MODULE_NOT_FOUND",s}).register=function(t,e){i[t]=e},e.parcelRequire60cc=a),a.register("eW2D8",(function(e,r){t(e.exports,"ERROR_TYPES",(()=>E)),t(e.exports,"FRAME_PERMS",(()=>x)),t(e.exports,"FRAME_PERMS_CONTAINS",(()=>_)),t(e.exports,"filesToRecord",(()=>y)),t(e.exports,"captureToFiles",(()=>M));var i=a("8rN6d"),s=a("ff4Ef"),n=a("8bPtr"),l=a("hH2tP"),o=a("6PWuH"),c=a("95ETH"),h=a("kWRp9"),u=a("jQEAy"),d=a("7ntRd"),f=a("eC8rE"),g=a("erNYL"),p=a("iW6yY"),m=a("2z2pA"),w=a("lk6Fz"),b=a("6pLLc");const E={UNKNOWN_MESSAGE:"UnknownMessage",TIMED_OUT:"TimedOut",CHROME_TABS:u.ERROR_NAME,CHROME_SCRIPTING:h.ERROR_NAME,MISSING_BLOB:"MissingBlob",CONTENT_SCRIPT:"ContentScript"},x={permissions:["webNavigation"],origins:["<all_urls>"]},_={permissions:["webNavigation"],origins:["https://*/*","http://*/*"]},y=(t,e,r,i,a,s)=>f.Capture.from(t,e,r,i,a,s).save(),M=(t,e,r,i,a)=>R(t,r,i,a).then((t=>{let r=t.blobs,i=t.scaleMultiplier,a=t.metadata;return Promise.all(r.map(((t,r)=>function(t,e,r){if(!t){let t=new Error(`_saveBlobToFs got no blob: ${e}, ${r}`);return t.name=E.MISSING_BLOB,Promise.reject(t)}e=function(t,e){if(!e)return t;let r=t.split("."),i=r.pop();return r.join(".")+"-"+(e+1)+"."+i}(e,r);let i=t.size+2048;return p.default.requestFs(i).then((t=>p.default.getFile(t,e,{create:!0}))).then((e=>p.default.writeFile(e,t))).then((()=>({filename:e,size:t.size})))}(t,e,r)))).then((t=>({files:t,scaleMultiplier:i,metadata:a})))})),R=(t,e,r,i)=>v(t,e,r,i).then((e=>(i.add_url&&e.canvasObjs.forEach((r=>{let i=r.ctx,a=r.width,s=(r.height,e.scaleMultiplier);i.scale(s,s),i.fillStyle="#00000055",i.fillRect(0,0,a/s,40),i.fillStyle="#fff",i.font="20px Arial",i.textBaseline="middle",i.fillText(t.url,20,20)})),e.toBlobs().then((t=>({blobs:t,scaleMultiplier:e.scaleMultiplier,metadata:e.metadata})))))),v=(S=(0,i.default)((function(t,e,r,i){var a;return(0,n.__generator)(this,(function(n){return e=e||function(){},""===t.url||"about:blank"===t.url||t.url.startsWith("about:blank#")?a=Promise.resolve().then((()=>{const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const r=e.getContext("2d");return r.fillStyle="#fff",r.fillRect(0,0,e.width,e.height),e.toDataURL()})):"chrome://newtab/"===t.url||"chrome://apps/"===t.url||"edge://newtab/"===t.url||"edge://apps/"===t.url||t.url.startsWith("https://ntp.msn.com/edge/ntp")?a=u.captureVisibleTab(t.windowId,i.fmt_details.capture):t.url.startsWith("data:image/")&&(a=Promise.resolve(t.url)),a?[2,C(a,e,i.fmt_details.canvas)]:[2,new Promise(((a,n)=>{const o=[new(0,w.default)(i.fmt_details.canvas)];let u,f,p=[];chrome.runtime.onMessage.addListener(((a,b,y)=>{try{if(void 0===u&&void 0!==a.windowWidth&&(u=a.windowWidth),void 0!==a.complete&&void 0!==a.canvasId&&o.length>1){let t=o.length,e=(t-a.canvasId-1)/t+a.complete/t;a.complete=e}switch(a.msg){case l.MSG_CAPTURE:{var M;e(a.complete);let i=a.canvasId;if(!N(i)){let t=new Error(`Bad canvasId in capture request: ${i}`);return t.name="CaptureRequestError",n(t)}let s=p[i];if(s&&(a.clip.x+=s.left,a.clip.y+=s.top),0===i){const t={ww:a.windowWidth,wh:a.windowHeight,dpr:a.devicePixelRatio};o[i].updateMetadata(t)}return(null===(M=a.links)||void 0===M?void 0:M.length)&&o[i].appendMetadataLinks(a.links),function(t,e,r,i,a,s){return k.apply(this,arguments)}(t.windowId,a,u,o[i],r,a.isFrame?f:void 0).then((t=>{y(t||!0)})).catch(n),!0}case l.MSG_CAPTURE_ERROR:return n({name:E.CONTENT_SCRIPT,message:a.name+": "+a.message,stack:a.stack}),!1;case l.MSG_CAPTURE_FRAME:{let r=o.length;o.push(new(0,w.default)(i.fmt_details.canvas));let u=["top","left","width","height","windowWidth"].filter((t=>!N(a[t])));if(u.length){let t=new Error(`Bad props on ${l.MSG_CAPTURE_FRAME} request: ${u.join(", ")}`);return t.name="CaptureFrameRequestError",n(t)}return p[r]=a,function(t,e,r,i,a,s,n,l,o){let u=i.id;return Promise.resolve().then((()=>c.contains(_))).then((t=>!!t||(g.trigger("needFramePermsClick",{tagName:o}),g.oncePromise("clicked").then((t=>"ok"===t.action&&c.request(x)))))).then((o=>o?d.getAllFrames({tabId:u}).then((i=>{if((i=i.filter((t=>0===t.parentFrameId))).length<=1)return i[0];let a=i.filter((e=>e.url===t));if(a.length>=1){if(1!==a.length){let e=`multiple frames found with url: ${t}`;m.default.warn(e)}return a[0]}return function(t,e,r,i){let a=r*i;function s(t,e){return Math.abs(a+t*e-Math.min(r,t)*Math.min(i,e)*2)}const n={};return e.forEach((t=>{n[String(t.frameId)]=t})),h.executeScript({target:{tabId:t,allFrames:!0},func:()=>[window.innerWidth,window.innerHeight]}).then((t=>{let e,r;return t.map((t=>{let e=t.frameId,r=t.result;const i=n[String(e)];return i?{detail:i,result:r,diff:s(r[0],r[1])}:null})).filter(Boolean).forEach((t=>{let i=t.detail,a=t.diff;(null==e||a<e)&&(e=a,r=i)})),r}))}(u,i,e,r)})).then((t=>t?O(i,t.frameId,a,s,n,l).catch((t=>{if(h.isExecuteScriptChromeError(t))return null;throw t})):null)).then((t=>s.frame_persist?t:c.remove(x).then((()=>t)))):null))}(a.url,a.width,a.height,t,e,i,r,o[r],a.tagName).then((t=>{if(!t||0===t.canvases.length)return y({skip:!0});const e=t.scaleMultiplier,i=t.pageWidth,a=t.pageHeight,n=p[r],l=[["left","left"],["right","left"],["top","top"],["bottom","top"]];t.canvases.forEach((t=>{l.forEach((r=>{let i=(0,s.default)(r,2),a=i[0],l=i[1];if(t[a]+=n[l]*e,isNaN(t[a])){const t=new Error(`attr isNaN: ${a}`);throw t.name="CanvasObjAttrError",t}}))}));const c=o[r];(c.metadata.links||[]).forEach((t=>{t.bounds.forEach((t=>{t.x+=n.left,t.y+=n.top}))})),o[r-1].appendMetadataLinks(c.metadata.links),f=t,y({width:i,height:a})})).catch(n),!0}case l.MSG_CAPTURE_COMPLETE:return null==a.canvasId&&alert(`Bad request, missing canvasId: ${JSON.stringify(a)}`),F.emit(a),y(),!1;default:{let t="Unknown message received from content script: "+a.msg;return m.default.error(t),n({name:E.UNKNOWN_MESSAGE,message:t}),!1}}}catch(t){m.default.error(t),n(t)}})),O(t,null,e,i,0,o[0],!0).then((()=>{const t=o[0];t.sortLinks(),a(t)})).catch((t=>n(t)))}))]}))})),function(t,e,r,i){return S.apply(this,arguments)});var S;const C=function(){var t=(0,i.default)((function(t,e,r,i){var a,s,l,o,c;return(0,n.__generator)(this,(function(n){switch(n.label){case 0:return e(0),[4,t];case 1:return a=n.sent(),e(.5),[4,(0,b.loadImage)(a)];case 2:return s=n.sent(),l=s.img,o=s.width,c=s.height,e(1),(i=i||new(0,w.default)(r)).setObjs(o,c),i.drawImage(l,0,0,o,c),[2,i]}}))}));return function(e,r,i,a){return t.apply(this,arguments)}}(),O=function(){var t=(0,i.default)((function(t,e,r,a,s,o,c){return(0,n.__generator)(this,(function(d){return[2,new Promise(((d,f)=>{function g(){return g=(0,i.default)((function(){var i,f,g,p,w,E,x,_;return(0,n.__generator)(this,(function(n){switch(n.label){case 0:return i=6e3,[4,P(t.url)];case 1:n.sent(),f=!1,n.label=2;case 2:return n.trys.push([2,4,,5]),[4,(0,b.timeoutWrap)(u.sendMessage(t.id,{msg:l.MSG_CHECK_EXISTS},{frameId:e}),50,"tabs.sendSendMessage.checkExists")];case 3:return g=n.sent(),m.default.debug("Message.checkExists",g),g&&g.startTime&&"js/page/index.js"===g.script&&(f=!0),[3,5];case 4:return p=n.sent(),m.default.debug("Message.checkExists.error",p),[3,5];case 5:if(f)return[3,11];n.label=6;case 6:return n.trys.push([6,8,,11]),[4,(0,b.timeoutWrap)(A(t,e,"js/page/index.js"),i,"api._executeScript")];case 7:return n.sent(),[3,11];case 8:return w=n.sent(),c&&(h.isExecuteScriptChromeError(w)||s>0)?(E=u.captureVisibleTab(t.windowId,a.fmt_details.capture),[4,C(E,r,a.fmt_details.capture,o)]):[3,10];case 9:return n.sent(),d(I(o)),[2];case 10:throw w;case 11:return r(0),x={msg:l.MSG_SCROLL_PAGE,canvasId:s,opts:a},e=e||0,[4,u.sendMessage(t.id,x,{frameId:e})];case 12:return n.sent(),_=t=>{if(t.canvasId===s){F.off(_),o.applyBgRegions();const t=I(o);d(t)}},F.on(_),[2]}}))})),g.apply(this,arguments)}(function(){return g.apply(this,arguments)})().catch(f)}))]}))}));return function(e,r,i,a,s,n,l){return t.apply(this,arguments)}}(),I=t=>{const e=t.canvasObjs,r=t.scaleMultiplier||1;return{canvases:e,pageWidth:t.totalWidth/r,pageHeight:t.totalHeight/r,scaleMultiplier:r}};function P(t){return T.apply(this,arguments)}function T(){return(T=(0,i.default)((function(t){return(0,n.__generator)(this,(function(e){switch(e.label){case 0:return o.isFileUrl(t)?[4,o.isAllowedFileSchemeAccess()]:[3,2];case 1:if(!e.sent())return g.trigger("needFilePermsClick"),[2,new Promise((()=>{}))];e.label=2;case 2:return[2]}}))}))).apply(this,arguments)}function k(){return k=(0,i.default)((function(t,e,r,i,a,s){var l,o,c,h,d,f,g,p,w,E,x,_,y,M,R,v;return(0,n.__generator)(this,(function(n){switch(n.label){case 0:if(s)return s.canvases.forEach((t=>{let e=t.canvas,r=t.left,a=t.top,s=t.width,n=t.height;i.drawImage(e,r,a,s,n)})),[2,e];l="",n.label=1;case 1:0,n.label=2;case 2:return n.trys.push([2,4,,8]),[4,u.captureVisibleTab(t,{format:"png"})];case 3:return l=n.sent(),[3,9];case 4:return o=n.sent(),u.isCaptureVisibleTabQuotaError(o)?(m.default.debug("Encountered capture quota error"),[4,(0,b.sleep)(50)]):[3,6];case 5:return n.sent(),[3,7];case 6:throw o;case 7:return[3,8];case 8:return[3,1];case 9:if(!l)throw(c=new Error("No dataURI generated for visible tab")).name="APICaptureStepError",c;return[4,(0,b.loadImage)(l)];case 10:return h=n.sent(),d=h.img,f=h.width,g=h.height,e.image={width:f,height:g},p=r===f?1:f/r,i.setScaleMultiplier(p),1!==p&&i.scaleAll(e,["x","y","totalWidth","totalHeight","capture.*","clip.*"]),i.isEmpty()&&(i.setObjs(e.totalWidth,e.totalHeight,e.canvasBg),i.size()>1&&a&&a(i.size()),e.bgRegions&&(e.bgRegions.forEach((t=>i.scaleAll(t,["sample.*","fill.*"]))),i.setBgRegions(e.bgRegions))),w=e.x+e.capture.x,E=e.y+e.capture.y,x=e.clip.width,_=e.clip.height,y=w-e.clip.x,M=E-e.clip.y,R=e.image.width,v=e.image.height,0===x||0===_?m.default.warn("Zero area mask!",JSON.stringify(e)):0===R||0===v?m.default.warn("Zero area for image!",JSON.stringify(e)):i.drawImage(d,y,M,R,v,e,{x:w,y:E,width:x,height:_}),[2,e]}}))})),k.apply(this,arguments)}function A(t,e,r){t.url;if(function(t){let e=chrome.runtime.getURL("");return t.url.substring(0,e.length)===e}(t)){let e,i=chrome.runtime.getURL(r);try{e=chrome.extension.getViews({type:"tab",tabId:t.id})}catch(t){e=chrome.extension.getViews({type:"tab"})}let a=e.filter((e=>e.location.href===t.url));return a.length||m.default.error("No matching window found for: "+t.url),Promise.all(a.map((t=>new Promise(((e,r)=>{let a=t.document.createElement("script");a.src=i,a.addEventListener("load",e,!1),t.document.body.appendChild(a)})))))}{const i={files:[r],target:{tabId:t.id}};return"number"==typeof e&&(i.target.frameIds=[e]),h.executeScript(i)}}const N=t=>"number"==typeof t,F=function(){const t="CaptureCompleteListener";return{on:e=>g.on(t,e),off:e=>g.off(t,e),emit:e=>g.trigger(t,e)}}()})),a.register("hH2tP",(function(e,r){t(e.exports,"MSG_CAPTURE",(()=>i)),t(e.exports,"MSG_CAPTURE_COMPLETE",(()=>a)),t(e.exports,"MSG_CAPTURE_ERROR",(()=>s)),t(e.exports,"MSG_CAPTURE_FRAME",(()=>n)),t(e.exports,"MSG_CHECK_EXISTS",(()=>l)),t(e.exports,"MSG_LOG",(()=>o)),t(e.exports,"MSG_SCROLL_PAGE",(()=>c));const i="capture",a="captureComplete",s="captureError",n="captureFrame",l="checkExists",o="log",c="scrollPage"})),a.register("kWRp9",(function(e,r){t(e.exports,"ERROR_NAME",(()=>s)),t(e.exports,"executeScript",(()=>l)),t(e.exports,"isExecuteScriptChromeError",(()=>o));var i=a("3k2hL");const s="ChromeScriptingError",n=(0,i.genWrapError)(s),l=t=>n(chrome.scripting.executeScript(t),"executeScript"),o=t=>(0,i.isLastError)(t)&&t.name===s&&"executeScript"===t.via&&(-1!==t.message.indexOf("Extension manifest must request permission")||-1!==t.message.indexOf("Frame with ID")&&-1!==t.message.indexOf("is showing error page")||-1!==t.message.indexOf('"chrome-error://'))})),a.register("7ntRd",(function(e,r){t(e.exports,"getAllFrames",(()=>s));const i=(0,a("3k2hL").genWrapError)("ChromeWebNavigationError"),s=t=>i(chrome.webNavigation.getAllFrames(t),"getAllFrames")})),a.register("lk6Fz",(function(e,r){t(e.exports,"default",(()=>h));var i=a("jBCXK"),s=a("hGGFE"),n=a("j4JJz"),l=a("2z2pA");const o=28800,c=9e3;class h{size(){return this.canvasObjs.length}isEmpty(){return 0===this.canvasObjs.length}updateMetadata(t){this.metadata=(0,i.default)({},this.metadata,t)}appendMetadataLinks(t){if(t){const e=[...this.metadata.links||[],...t];this.metadata=(0,s.default)((0,i.default)({},this.metadata),{links:e})}}sortLinks(){this.metadata.links&&this.metadata.links.sort(((t,e)=>t.bounds[0].y===e.bounds[0].y?t.bounds[0].x-e.bounds[0].x:t.bounds[0].y-e.bounds[0].y))}setScaleMultiplier(t){this.scaleMultiplier=t}setObjs(t,e,r){this.totalWidth=t,this.totalHeight=e;let i,a,s,n,l,h=e>o||t>o||e*t>2592e5,u=t>e,d=h?u?o:c:t,f=h?u?c:o:e,g=Math.ceil(t/d),p=Math.ceil(e/f),m=0,w=[];for(i=0;i<p;i++)for(a=0;a<g;a++){s=document.createElement("canvas"),s.width=a==g-1&&t%d||d,s.height=i==p-1&&e%f||f;let o=s.getContext("2d");r&&(o.fillStyle=r,o.fillRect(0,0,s.width,s.height)),n=a*d,l=i*f,w.push({canvas:s,ctx:o,index:m,left:n,right:n+s.width,top:l,bottom:l+s.height,width:s.width,height:s.height}),m++}this.canvasObjs=w}toDataURLs(){return this.canvasObjs.map((t=>t.canvas.toDataURL(this.exportFormat)))}toBlobs(){return Promise.all(this.canvasObjs.map((t=>(0,n.canvasToBlob)(t.canvas,this.exportFormat))))}fillRect(t,e,r,i,a){this._filter(e,r,i,a).forEach((s=>{let n=this._shift(s,e,r);s.ctx.fillStyle=t,s.ctx.fillRect(n.x,n.y,i,a)}))}strokeRect(t,e,r,i,a){this._filter(e,r,i,a).forEach((s=>{let n=this._shift(s,e,r);s.ctx.strokeStyle=t,s.ctx.strokeRect(n.x,n.y,i,a)}))}drawImage(t,e,r,a,s,n,l){this._debugCounter++,this._filter(e,r,a,s).forEach((o=>{const c=this._shift(o,e,r),h=l?(0,i.default)({},l,this._shift(o,l.x,l.y)):void 0,u=o.ctx;if(u.save(),h){const t=new Path2D,e=h.x,r=h.y,i=h.width,a=h.height,s=Math.floor(h.x),n=Math.floor(h.y);let l=Math.ceil(h.width),o=Math.ceil(h.height);s+l<e+i&&(l+=1),n+o<r+a&&(o+=1),t.rect(s,n,l,o),u.clip(t)}if(u.drawImage(t,c.x,c.y),u.restore(),n&&"object"==typeof n&&!0===n.debug){const t=l||{x:c.x,y:c.y,width:a,height:s};let e=Math.max(0,t.x),r=Math.max(0,t.y),i=t.x<0?t.width+t.x:t.width,o=t.y<0?t.height+t.y:t.height;u.save(),u.strokeStyle="#0F0",u.lineWidth=3,u.strokeRect(e,r,i,o);const h=15;u.font=`${h}px Arial`,u.textAlign="left",u.textBaseline="top";const d=`#${this._debugCounter}: ${this._str(n)}`,f=5,g=u.measureText(d).width;u.fillStyle="rgba(0, 0, 0, .4)",u.fillRect(e,r,g+2*f,h+2*f),u.fillStyle="#FFF",u.fillText(d,e+f,r+f)}}))}_str(t){try{if("capture"===t.msg)return JSON.stringify({x:t.x,y:t.y,clip:t.clip,capture:t.capture})}catch(t){}try{return JSON.stringify(t)}catch(e){return`${t}`}}_filter(t,e,r,i){let a=t+r,s=e+i;return this.canvasObjs.filter((r=>t<r.right&&a>r.left&&e<r.bottom&&s>r.top))}_shift(t,e,r){return{x:Math.round(e-t.left),y:Math.round(r-t.top)}}_constrain(t,e,r,i,a){const s=this._shift(t,e,r),n=s.x,l=n+i,o=s.y,c=o+a,h=Math.max(0,n),u=Math.max(0,o);return{x:h,y:u,width:Math.min(t.height,l-h),height:Math.min(t.height,c-u)}}scale(t){return(t||0)*this.scaleMultiplier}scaleAll(t,e){e.forEach((e=>{if("*"===e)Object.keys(t).forEach((e=>t[e]=this.scale(t[e])));else{let r=e.indexOf(".");-1===r?t[e]=this.scale(t[e]):this.scaleAll(t[e.substring(0,r)],[e.substring(r+1)])}}))}setBgRegions(t){this.bgRegions=t}applyBgRegions(){this.bgRegions.forEach(((t,e)=>{let r=t.sample,i=t.fill;const a=new Map;this._filter(r.x,r.y,r.width,r.height).forEach((t=>{let e=this._constrain(t,r.x,r.y,r.width,r.height);if(e.width>0&&e.height>0){let r=document.createElement("canvas");r.width=e.width,r.height=e.height;let i,s=r.getContext("2d");s.drawImage(t.canvas,-e.x,-e.y);try{i=s.getImageData(0,0,e.width,e.height)}catch(t){l.default.error(t)}i&&this._getHisto(i.data,a)}}));let s=0,n=0;if(a.forEach(((t,e)=>{t>s&&(s=t,n=e)})),0!==n){const t=`rgb(${this._toRgb(n).join(", ")})`;this.fillRect(t,i.x,i.y,i.width,i.height)}}))}_getHisto(t,e){e=e||new Map;for(let r=0,i=t.length;r<i;r+=4)if(255===t[r+3]){const i=this._toInt(t[r],t[r+1],t[r+2]);e.set(i,(e.get(i)||0)+1)}return e}_toInt(t,e,r){return(t<<16)+(e<<8)+r}_toRgb(t){const e=255&t,r=255&(t>>=8);return[255&(t>>=8),r,e]}constructor(t){this.exportFormat=t,this.canvasObjs=[],this.bgRegions=[],this.scaleMultiplier=1,this.totalWidth=0,this.totalHeight=0,this.metadata={},this._debugCounter=0,this.scaleMultiplier=1,this.totalWidth=0,this.totalHeight=0,this.metadata={},this._debugCounter=0}}}))})();
//# sourceMappingURL=popup.77323d67.js.map
