var Viewport=function(c){function Q(){var a=new UI.Panel;a.setPosition("fixed");a.setTop("50px");a.setLeft("50px");a.setWidth("570px");a.setFontSize("19px");a.setColor("#fff");a.setDisplay("block");f.add(a);var b=(new UI.Text).setValue(String.fromCharCode(9728));b.setFontSize("72px");a.add(b);b=(new UI.Text).setValue("WebGL is required to run this app and it is turned off!");a.add(b);a.add(new UI.Break,new UI.Break);b=(new UI.Text).setValue("Please enable WebGL for your Google Chrome.");a.add(b);
b=(new UI.Text).setValue("Learn more about Google Chrome WebGL support");a.add(b);b=new UI.Text;b.setColor("#00f");b.setMarginLeft("8px");b.setValue("here");b.setCursor("pointer");b.onClick(function(){window.open("https://support.google.com/chrome/answer/1220892","_blank")});a.add(b);b=(new UI.Text).setValue("Check for WebGL compatibility ");a.add(b);b=new UI.Text;b.setColor("#00f");b.setMarginLeft("8px");b.setValue("here");b.setCursor("pointer");b.onClick(function(){window.open("http://get.webgl.org/",
"_blank")});a.add(b);a.add(new UI.Break,new UI.Break);b=(new UI.Text).setFontSize("14px").setValue('To diagnose issues, please open "chrome://gpu/" link in your Chrome browser.');a.add(b);b=(new UI.Text).setFontSize("14px").setValue('To turn WebGL on/off, please open "chrome://flags/" link and reset "Disable WebGL" flag.');a.add(b)}function M(){var a=D.getObjectByName("undo");a&&(a.spriteId=c.history.canUndo()?1:0,a.update());if(a=D.getObjectByName("redo"))a.spriteId=c.history.canRedo()?1:0,a.update();
undoMenuItem.setOpacity(c.history.canUndo()?1:.5);redoMenuItem.setOpacity(c.history.canRedo()?1:.5);l()}function aa(){var a=0,b=0,c=0;e.traverse(function(q){q instanceof T.Mesh&&!0!==q.dummy&&(a++,q=q.geometry,q instanceof T.Geometry?(b+=q.vertices.length,c+=q.faces.length):q instanceof T.BufferGeometry&&(b+=q.attributes.position.array.length/3,c=void 0!==q.attributes.index?c+q.attributes.index.array.length/3:c+b/3))});A.setValue("objects: "+a+", vertices: "+b+", faces: "+c)}function R(){c.scene.traverse(function(a){if(a.material&&
(a.material.needsUpdate=!0,a.material instanceof T.MeshFaceMaterial))for(var b=0;b<a.material.materials.length;b++)a.material.materials[b].needsUpdate=!0})}function ba(a){a.fog&&(a.fog.color.setHex(N),void 0!==a.fog.near&&(a.fog.near=S),void 0!==a.fog.far&&(a.fog.far=U),void 0!==a.fog.density&&(a.fog.density=V))}function ca(a){for(a||(a=e);a.parent&&1>=a.children.length;)a=a.parent;a.parent||(a=e);var b=D.getObjectByName("nest");a&&(T.GeometryUtils.isNested(a)?(b&&0==b.spriteId&&b.nextSprite(),a==
e||e instanceof T.Platform&&e.isPlatformVisible()?editNestingMenuItem.setTextContent("Undo Auto Placement"):editNestingMenuItem.setTextContent("Assemble Object")):(b&&1==b.spriteId&&b.nextSprite(),a==e||e instanceof T.Platform&&e.isPlatformVisible()?editNestingMenuItem.setTextContent("Auto Place Objects"):editNestingMenuItem.setTextContent("Disassemble Object")),b.update())}function da(){ea();requestAnimationFrame(da)}function l(){c.noRendering||(cameraLight.position=g.position,F.updateMatrixWorld(),
e.updateMatrixWorld(),r.render(),n.render(la,E),ea())}function ea(){O+=ma.getDelta();W++;1<=O&&(B.setValue("fps: "+W),O=W=0)}var d=c.signals,t=this;this.showInverted=!0;var f=new UI.Panel;f.setPosition("absolute");f.setBackgroundColor("#aaa");var A=new UI.Text;A.setPosition("absolute");A.setRight("15px");A.setBottom("5px");A.setFontSize("12px");A.setColor("#999999");A.setValue("objects: 0, vertices: 0, faces: 0");f.add(A);var G=new UI.Text;G.setClass("center-bottom auto-hide-3s");G.setFontSize("16px");
G.setColor("#999999");G.setValue("Drag and drop model files here");f.add(G);var B=new UI.Text;B.setId("fps");B.setPosition("absolute");B.setLeft("15px");B.setBottom("5px");B.setFontSize("12px");B.setColor("#999999");f.add(B);var ma=new T.Clock,O=0,W=0,e=c.scene,F=c.sceneHelpers,C=new T.Scene,la=c.sceneOrtho,X=15658734,H=this.objects=[],I=new T.GridHelper(500,25);I.setColors(11184810,14540253);I.visible=!1;var Y=new T.MeshPhongMaterial({specular:3355443,emissive:15658734,color:0,side:T.BackSide}),
fa=new T.Mesh(new T.SphereGeometry(1E4,32,8),Y);fa.rotation.set(Math.PI/2,0,0);var ga=new T.PointLight(16777215,1,0);ga.position.set(0,0,-1).multiplyScalar(9E3);C.add(I);C.add(fa);C.add(ga);e.platformHelper&&C.add(e.platformHelper);var g=new T.PerspectiveCamera(50,1,.1,2E4),E=new T.OrthographicCamera(0,window.innerWidth,0,window.innerHeight,-1E4,1E4);E.position.z=10;g.up.set(0,0,1);g.position.set(-250,-500,250);g.lookAt(e.position);cameraLight=new T.PointLight(16777215,1);cameraLight.position.set(-250,
-500,250);cameraLight.dummy=!0;e.add(cameraLight);var v=new T.SelectionHelper;v.material.transparent=!0;v.visible=!1;v.material.linewidth=1.2;v.material.opacity=.7;v.material.color.set(7368816);F.add(v);var J=new T.BridgeHelper;J.visible=!1;F.add(J);var n;if(window.WebGLRenderingContext){try{n=new T.WebGLRenderer({antialias:!0,alpha:!1})}catch(a){return Q(),f}if(!n.context)return Q(),f}else return Q(),f;n.setClearColor(X);n.autoClear=!1;n.autoUpdateScene=!1;f.dom.appendChild(n.domElement);var r=new T.GlowPass(e,
C,F,n,g),w=new T.WallThicknessAnalysis(n);c.wallThicknessAnalysis=w;var m=new T.TransformControls(g,f.dom,e,n,c);m.setSpace("world");m.addEventListener("change",function(){u.enabled=!0;u.controlKeyDown||!m.axis&&!k.dragging||(u.enabled=!1);for(var a=[],b=0;b<m.objects.length;++b){var h=m.objects[b];a[b]={objectId:h.id,matrix:h.matrix.clone(),oldMatrix:h.oldMatrix?h.oldMatrix.clone():null}}(function(a){c.history.add(function(){for(var b=0;b<a.length;++b){var h=c.getObjectById(a[b].objectId);h&&a[b].oldMatrix&&
(a[b].oldMatrix.decompose(h.position,h.quaternion,h.scale),d.objectChanged.dispatch(h))}},function(){for(var b=0;b<a.length;++b){var h=c.getObjectById(a[b].objectId);h&&a[b].matrix&&(a[b].matrix.decompose(h.position,h.quaternion,h.scale),d.objectChanged.dispatch(h))}})})(a);c.selected?d.objectChanged.dispatch(c.selected):l()});m.addEventListener("update",function(){u.enabled=!0;u.controlKeyDown||!m.axis&&!k.dragging||(u.enabled=!1);c.selected?d.objectChanging.dispatch(c.selected):l()});m.addEventListener("render",
function(){l()});F.add(m);var k=new T.MeasurementControls(this,g,f);k.enabled=!1;k.addEventListener("change",function(){u.enabled=!0;u.controlKeyDown||!m.axis&&!k.dragging||(u.enabled=!1);l()});k.addEventListener("select",function(a){a&&a.measurement?c.select(a.measurement):c.deselect()});k.addEventListener("sceneChanged",function(){d.sceneGraphChanged.dispatch()});k.addEventListener("objectAdded",function(a){console.log("measurement added",a.object);a&&a.object&&d.objectAdded.dispatch(a.object);
d.sceneGraphChanged.dispatch();l()});F.add(k);holeSelectionControls=new T.HoleSelectionControls(this,n,g,f);holeSelectionControls.enabled=!1;holeSelectionControls.addEventListener("select",function(a){a&&"fillHole"==a.mode&&(a.object||holeSelectionControls.dispatchEvent({type:"cancel",mode:a.mode}))});holeSelectionControls.addEventListener("selected",function(a){if(a){if("fillHole"==a.mode&&1==a.selections.length){var b=a.selections[0];c.applySequentialOperation(function(a){T.GeometryUtils.updateEdgeFaces(a.geometry);
a=(new T.HoleFillerOperation(c,c.notifications)).operate(a,b.points[0]);T.SceneUtils.updateBadEdges(a,!0,!0);return a},[b.object],null,!0);d.sceneGraphChanged.dispatch()}else if("createBridge"==a.mode&&2<=a.selections.length){var h=a.selections[0];a=a.selections[1];var q=h.object.geometry.vertices[h.points[0]].clone(),e=h.object.geometry.vertices[h.points[1]].clone(),Z=a.object.geometry.vertices[a.points[0]].clone(),f=a.object.geometry.vertices[a.points[1]].clone();h.object!=a.object&&(Z=h.object.worldToLocal(a.object.localToWorld(Z)),
f=h.object.worldToLocal(a.object.localToWorld(f)));c.applySequentialOperation(function(a){T.GeometryUtils.updateEdgeFaces(a.geometry);a=(new T.CreateBridgeOperation(c,c.notifications)).operate(a,q,e,Z,f);T.SceneUtils.updateBadEdges(a,!0,!0);return a},[h.object],null,!0)}J.visible=!1;holeSelectionControls.enableHover=!1;c.signals.materialChanged.dispatch()}holeSelectionControls.disable();d.toggleBadEdges.dispatch(holeSelectionControls.originalBadEdgesVisibility)});holeSelectionControls.addEventListener("hover",
function(a){if(a){var b,h,q,d;if("fillHole"==a.mode){var e=a;e.object&&(b=e.object.localToWorld(e.object.geometry.vertices[e.points[0]].clone()),h=e.object.localToWorld(e.object.geometry.vertices[e.points[1]].clone()),q=b,d=h)}else"createBridge"==a.mode&&(e=0<holeSelectionControls.selections.length?holeSelectionControls.selections[0]:a,e.object&&a.object&&(b=e.object.localToWorld(e.object.geometry.vertices[e.points[0]].clone()),h=e.object.localToWorld(e.object.geometry.vertices[e.points[1]].clone()),
q=a.object.localToWorld(a.object.geometry.vertices[a.points[0]].clone()),d=a.object.localToWorld(a.object.geometry.vertices[a.points[1]].clone())));b&&h&&q&&d&&(J.update(b,h,q,d),J.visible=!0,c.signals.materialChanged.dispatch())}});holeSelectionControls.addEventListener("cancel",function(a){J.visible=!1;holeSelectionControls.disable();d.toggleBadEdges.dispatch(holeSelectionControls.originalBadEdgesVisibility)});var z=new T.BlogControls(c,document.body);z.setPosition(80);var ha="None",N=11184810,
S=1,U=5E3,V=2.5E-4,ia=new T.Picking;c.select(g);var ja=new T.Vector2,K=new T.Vector2,C=function(a){if(!a||!a.cancel){a.preventDefault();var b=f.dom.getBoundingClientRect();a=a.touches?a.touches[0]:a;x=a.clientX-b.left;y=a.clientY-b.top;ja.set(x,y);K.set(x,y);document.addEventListener("mouseup",P,!1);document.addEventListener("touchend",P,!1);"none"!==$("#picker").css("display")&&($("#picker").hide(),c.signals.saveUI.dispatch())}},P=function(a){if(!a||!a.cancel)if(!a||"mouseout"!=a.type||!a.relatedTarget||
a.relatedTarget.parentElement!=f.dom){if(void 0==a.touches){var b=f.dom.getBoundingClientRect();x=a.clientX-b.left;y=a.clientY-b.top;K.set(x,y)}else x=K.x,y=K.y;2>ja.distanceTo(K)&&((b=ia.pickObject(e,n,g,x,y,!1,!1))&&b.object?(b=void 0!==b.object.userData.object?b.object.userData.object:b.object,a&&(a.ctrlKey?c.setMark([b]):a.shiftKey&&(c.mark([b]),c.mark(c.selected))),c.select(b)):c.select(g));document.removeEventListener("mouseup",P);document.removeEventListener("touchend",P)}};f.dom.addEventListener("mousedown",
C,!1);f.dom.addEventListener("touchmove",function(a){if((!a||!a.cancel)&&a.touches){var b=f.dom.getBoundingClientRect();a=a.touches[0];x=a.clientX-b.left;y=a.clientY-b.top;K.set(x,y)}},!1);f.dom.addEventListener("touchstart",C,!1);f.dom.addEventListener("dblclick",function(a){var b=e,h=f.dom.getBoundingClientRect();x=a.clientX-h.left;y=a.clientY-h.top;(a=ia.pickObject(b,n,g,x,y,!1,!1))&&a.object&&(c.select(a.object),u.focus(a.object))},!1);var u=new T.EditorControls(g,f.dom,e,n);u.addEventListener("change",
function(){m.update();k.update();l()});var D=new HUD(c,f.dom),ka=function(a){var b=(new T.V3).copy(a).normalize(),c=T.GeometryUtils.getGlobalBoundingBox(e);a=(new T.V3).addVectors(c.min,c.max).multiplyScalar(.5);var d=(new T.V3).subVectors(c.max,c.min),c=Math.max(d.x,Math.max(d.y,d.z)),L=b.lengthSq();if(NaN==L||Infinity==L||0>=c)return g.position.set(-250,-500,250),e instanceof T.Platform&&e.isPlatformVisible()?("Inch"==e.units?g.position.divideScalar(50.8):g.position.divideScalar(2),g.position.add(e.getPlatformBox().center()),
a=e.getPlatformBox().center()):a.set(0,0,0),g.up.set(0,0,1),g.updateMatrix(),cameraLight.position.copy(g.position),u.focus(a),!1;var c=Math.max(c,.2),L=(new T.V3).copy(b).cross(new T.V3(d.x,0,0)).length(),f=(new T.V3).copy(b).cross(new T.V3(0,d.y,0)).length(),d=(new T.V3).copy(b).cross(new T.V3(0,0,d.z)).length();b.multiplyScalar(Math.max(c,1.4*Math.sqrt(L*L+f*f+d*d)));b=(new T.V3).copy(a).sub(b);g.position.copy(b);g.updateMatrix();cameraLight.position.copy(b);u.focus(a);l();return!0};d.historyUndo.add(function(){M()});
d.historyRedo.add(function(){M()});d.historyAdded.add(function(){M()});d.historyCleared.add(function(){M()});d.restoreMeasurement.add(function(a){a&&a.measurementGizmo&&k.attachGizmo(a.measurementGizmo)});d.measureDistance.add(function(a,b){measure=new T.MeasurementDistance;k.add(measure);a&&k.load(b?b:e,measure,a);k.enabled=!0});d.measureThickness.add(function(a,b){measure=new T.MeasurementThickness;k.add(measure);a&&k.load(b?b:e,measure,a);k.enabled=!0});d.measureAngle.add(function(a,b){measure=
new T.MeasurementAngle(a);k.add(measure);a&&k.load(b?b:e,measure,a);k.enabled=!0});d.measureRadius.add(function(a,b){measure=new T.MeasurementRadius(a);k.add(measure);a&&k.load(b?b:e,measure,a);k.enabled=!0});d.measureAnnotation.add(function(a,b){measure=new T.MeasurementAnnotation(a);k.add(measure);a&&k.load(b?b:e,measure,a);k.enabled=!0});d.nest.add(function(a){var b=[],h=[];c.applyParallelOperation(function(a){var f=[];if(e instanceof T.Platform&&e.isPlatformVisible())if(0<a.filter(function(a){return a instanceof
T.Scene}).length)a=e.children.filter(function(a){return!(a instanceof T.Light||a instanceof T.Camera)});else for(var g in e.nestedObjectIds){var p=c.getObjectById(e.nestedObjectIds[g]);p&&p instanceof T.Object3D&&f.push(p)}else{var k=[];for(g in a){for(p=a[g];p.parent&&1>=p.children.length;)p=p.parent;p&&p.children&&(k=k.concat(p.children))}a=k}p=!0;for(g in a)p=p&&(T.GeometryUtils.isNested(a[g])||a[g].dummy);f=e instanceof T.Platform&&e.isPlatformVisible()?a.concat(f):a;for(g in f)b[f[g].id]=f[g].position.clone();
p?T.GeometryUtils.undoNesting(a):e instanceof T.Platform&&e.isPlatformVisible()?T.GeometryUtils.nestObjects2D(f,e):a[0]!=e&&a[0]&&a[0].parent?(p=a[0].parent.localToWorld((new T.V3).copy(a[0].parent.position)),T.GeometryUtils.nestObjects2D(a,p)):T.GeometryUtils.nestObjects2D(a,null);for(g in f)if(p=f[g])h[p.id]=p.position.clone(),T.GeometryUtils.resetGlobalBoundingBox(p),d.objectChanged.dispatch(p),ca(p),p==e&&d.unzoomCamera.dispatch();return f},[a],null,!1,function(a,c,h,e){for(var f in h)(a=h[f])&&
b[a.id]&&(console.log("undo move",b[a.id],a),a.position.copy(b[a.id]),a.updateMatrixWorld(),T.GeometryUtils.resetGlobalBoundingBox(a),m.update());d.materialChanged.dispatch()},function(a,b,c,e){for(var f in c)(a=c[f])&&h[a.id]&&(console.log("redo move",h[a.id],a),a.position.copy(h[a.id]),a.updateMatrixWorld(),T.GeometryUtils.resetGlobalBoundingBox(a),m.update());d.materialChanged.dispatch()})});d.splitShells.add(function(a){c.applySequentialOperation(function(a){return(new T.SplitShellsOperation).operate(c,
a)},[a],null,!0);d.sceneGraphChanged.dispatch();c.signals.materialChanged.dispatch()});d.mergeChildren.add(function(a){c.applySequentialOperation(function(a){return(new T.MergeChildrenOperation).operate(c,a)},[a],null,!0);d.sceneGraphChanged.dispatch();c.signals.materialChanged.dispatch()});d.reduce.add(function(a){c.applyParallelOperation(function(a,d){var e=new T.ReduceOperation(c,c.notifications);e.initNotifications("Reducing faces","");e.estimateParameters(a);return e.operate(c,a,!0,null,d)},
[a],function(a){if(a){for(var h in a)T.SceneUtils.updateBadEdges(a[h],!0,!0);d.sceneGraphChanged.dispatch()}c.signals.materialChanged.dispatch()},!0)});d.removeSharpTriangles.add(function(a){c.applyParallelOperation(function(a,d){var e=new T.RemoveSharpTrianglesOperation(c,c.notifications);e.initNotifications("Removing sharp faces","");e.estimateParameters(a);return e.operate(c,a,!0,null,d)},[a],function(a){if(a){for(var h in a)T.SceneUtils.updateBadEdges(a[h],!0,!0);d.sceneGraphChanged.dispatch()}c.signals.materialChanged.dispatch()},
!0)});d.fixNormals.add(function(a){c.applyParallelOperation(function(a,d){var e=new T.FixNormalsOperation(c,c.notifications);e.initNotifications("Fixing normals","");return e.operate(c,a,!0,null,d)},[a],function(a){if(a){for(var h in a)T.SceneUtils.updateBadEdges(a[h],!0,!0);d.sceneGraphChanged.dispatch()}c.signals.materialChanged.dispatch()})});d.invertNormals.add(function(a){c.applyParallelOperation(function(a,d){return(new T.InvertNormalsOperation(c,c.notifications)).operate(c,a,!0,null,d)},[a],
function(a){a&&d.sceneGraphChanged.dispatch();c.signals.materialChanged.dispatch()},!1,function(a,h,e,f){(new T.InvertNormalsOperation(c)).operate(c,a,!0);d.materialChanged.dispatch()},function(a,h,e,f){(new T.InvertNormalsOperation(c)).operate(c,a,!0);d.materialChanged.dispatch()})});d.stitch.add(function(a){c.applyParallelOperation(function(a,d){var e=new T.StitchOperation(c,c.notifications);e.initNotifications("Stitching","");return e.operate(c,a,!0,null,d)},[a],function(a){if(a){for(var h in a)T.SceneUtils.updateBadEdges(a[h],
!0,!0);d.sceneGraphChanged.dispatch()}c.signals.materialChanged.dispatch()},!0)});d.fillHole.add(function(a){holeSelectionControls.enable("fillHole",1,!0);holeSelectionControls.originalBadEdgesVisibility=t.BadEdgesVisible();d.toggleBadEdges.dispatch(!0)});d.createBridge.add(function(a){holeSelectionControls.enable("createBridge",2,!0);holeSelectionControls.originalBadEdgesVisibility=t.BadEdgesVisible();d.toggleBadEdges.dispatch(!0)});d.smooth.add(function(a){c.applySequentialOperation(function(a){a=
(new T.SubdivisionModifier).operate(c,a);T.SceneUtils.updateBadEdges(a,!0,!0);return a},[a],null,!0);d.sceneGraphChanged.dispatch();c.signals.materialChanged.dispatch()});d.group.add(function(a){c.applyParallelOperation(function(a,d){return(new T.GroupOperation).operate(c,a,!1,null,d)},[a],function(a){d.sceneGraphChanged.dispatch();c.signals.materialChanged.dispatch()},!1,function(a,h,e,f){(new T.UngroupOperation).operate(c,e,!1,null,function(){d.materialChanged.dispatch()})},function(a,h,e,f){a&&
e&&1==e.length&&(h=new T.GroupOperation,h.customGroup=e[0],h.operate(c,a,!1,null,function(){d.materialChanged.dispatch()}))})});d.ungroup.add(function(a){c.applyParallelOperation(function(a,d){return(new T.UngroupOperation).operate(c,a,!1,null,d)},[a],function(a){d.sceneGraphChanged.dispatch();c.signals.materialChanged.dispatch()},!0,function(a,e,f,g){f&&a&&1==a.length&&(e=new T.GroupOperation,e.customGroup=a[0],e.operate(c,f,!1,null,function(){d.materialChanged.dispatch()}))},function(a,e,f,g){(new T.UngroupOperation).operate(c,
a,!1,null,function(){d.materialChanged.dispatch()})})});d.cloneObject.add(function(a){c.applySequentialOperation(function(a){if(void 0!==a&&null!==a&&void 0!==a.parent){var d=a.clone();c.addObject(d,a.parent);return d}},[a],null,!1,function(a,e,f,g){f&&c.removeObject(f);c.selected&&f&&f.id==c.selected.id&&c.select(a);d.materialChanged.dispatch()},function(a,e,f,g){f&&c.addObject(f,g);c.selected&&a&&a.id==c.selected.id&&c.select(f);d.materialChanged.dispatch()});d.sceneGraphChanged.dispatch();c.signals.materialChanged.dispatch()});
d.mirrorObject.add(function(a){c.applyParallelOperation(function(a,d){return(new T.MirrorOperation(c,c.notifications)).operate(c,a,!0,null,d)},[a],function(a){a&&d.sceneGraphChanged.dispatch();c.signals.materialChanged.dispatch()},!0,function(a,e,f,g){(new T.MirrorOperation(c)).operate(c,a,!0);d.materialChanged.dispatch()},function(a,e,f,g){(new T.MirrorOperation(c)).operate(c,a,!0);d.materialChanged.dispatch()})});d.deleteObject.add(function(a){c.applySequentialOperation(function(a){void 0!==a&&
null!==a&&void 0!==a.parent&&c.removeObject(a)},[a]);c.deselect();d.sceneGraphChanged.dispatch();c.signals.materialChanged.dispatch()});d.toggleBadEdges.add(function(a){var b=D.getObjectByName("show_edges");b&&(void 0!==a?b.spriteId=a?1:0:b.nextSprite());T.SceneUtils.badEdgesMaterial.visible=void 0!==a?a:!T.SceneUtils.badEdgesMaterial.visible;T.SceneUtils.updateBadEdges(e,T.SceneUtils.badEdgesMaterial.visible,!0);c.selected&&d.objectChanged.dispatch(c.selected);l()});this.BadEdgesVisible=function(){return T.SceneUtils.badEdgesMaterial.visible};
d.toggleTriangleVisualization.add(function(a){var b=D.getObjectByName("show_triangles");b&&(void 0!==a?b.spriteId=a?1:0:b.nextSprite());T.SceneUtils.updateTriangleVisualization(e,void 0!==a?a:!T.SceneUtils.wireframeMaterial.visible);l()});this.TrianglesVisible=function(){return T.SceneUtils.wireframeMaterial.visible};d.toggleInvertedTriangles.add(function(a){var b=D.getObjectByName("show_inverted");b&&(void 0!==a?b.spriteId=a?0:1:b.nextSprite());t.showInverted=void 0!==a?a:!t.showInverted;c.scene.traverse(function(a){a instanceof
T.Mesh&&(a.material.side=t.showInverted?T.DoubleSide:T.FrontSide)});c.signals.materialChanged.dispatch()});this.InvertedVisible=function(){return this.showInverted};d.togglePrinterVisibility.add(function(){c.scene instanceof T.Platform&&(c.scene.setPlatformVisible(!c.scene.isPlatformVisible()),c.scene.saveToDefaultProfile(),c.signals.sceneGraphChanged.dispatch())});d.toggleGridVisibility.add(function(a){I.visible=void 0!==a?a:!I.visible});this.GridVisible=function(){return I.visible};d.changeBackgroundColor.add(function(a){$.farbtastic("#picker").setColor(a);
Y.emissive.set(a);l()});this.BackgroundColor=function(){return"#"+Y.emissive.getHexString()};d.loadUI.add(function(a){try{chrome.storage.local.get("ui_options",function(b){(b=b.ui_options)?(void 0!==b.backgroundColor&&b.backgroundColor!=t.BackgroundColor()&&c.signals.changeBackgroundColor.dispatch(b.backgroundColor),void 0!==b.showEdges&&b.showEdges!=t.BadEdgesVisible()&&c.signals.toggleBadEdges.dispatch(b.showEdges),void 0!==b.showTriangles&&b.showTriangles!=t.TrianglesVisible()&&c.signals.toggleTriangleVisualization.dispatch(b.showTriangles),
void 0!==b.showInverted&&b.showInverted!=t.InvertedVisible()&&c.signals.toggleInvertedTriangles.dispatch(b.showInverted),void 0!==b.showGrid&&b.showGrid!=t.GridVisible()&&c.signals.toggleGridVisibility.dispatch(b.showGrid)):c.signals.toggleGridVisibility.dispatch(!0);a&&a()})}catch(b){console.log(b)}});d.saveUI.add(function(){var a={backgroundColor:t.BackgroundColor(),showEdges:t.BadEdgesVisible(),showTriangles:t.TrianglesVisible(),showInverted:t.InvertedVisible(),showGrid:t.GridVisible()};chrome.storage.local.set({ui_options:a})});
d.rescaleSelected.add(function(a){function b(a){return function(b){if(b instanceof T.Scene)for(var c=0;c<b.children.length;++c)b.children[c].scale.x*=a,b.children[c].scale.y*=a,b.children[c].scale.z*=a,d.objectChanged.dispatch(b.children[c]);else b.scale.x*=a,b.scale.y*=a,b.scale.z*=a,d.objectChanged.dispatch(b);return b}}c.applySequentialOperation(b(a),null,null,!1,function(a,c,d,e,f){b(1/f).call(this,d)},function(a,c,d,e,f){b(f).call(this,d)},a)});d.resetView.add(function(){c.deselect();var a;for(a=
e.children.length-1;0<=a;a--)object=e.children[a],void 0!==object.parent&&object!=cameraLight&&(object.traverse(function(a){c.removeHelper(a)}),object.parent.remove(object),d.objectRemoved.dispatch(object)),T.GeometryUtils.disposeObject(object);e.comments=null;c.history.clear();m.detach();z.update();T.GeometryUtils.resetGlobalBoundingBox(e);d.sceneGraphChanged.dispatch();d.setDefaultView.dispatch("default")});d.editorChanged.add(function(){e=c.scene;r.scene=c.scene;var a;for(a=0;a<e.children.length&&
e.children[a]!=cameraLight;++a);a==e.children.length&&e.add(cameraLight)});d.unzoomCamera.add(function(){e.updateMatrixWorld();var a=(new T.V3(0,0,-1)).applyQuaternion(g.quaternion);ka(a)});d.zoomInCamera.add(function(){u.zoom(new T.V3(0,0,-300))});d.zoomOutCamera.add(function(){u.zoom(new T.V3(0,0,300))});d.setDefaultView.add(function(a){var b=new T.V3;switch(a){case "top":b.set(0,0,500);g.up.set(0,1,0);break;case "bottom":b.set(0,0,-500);g.up.set(0,1,0);break;case "left":b.set(-500,0,0);g.up.set(0,
0,1);break;case "right":b.set(500,0,0);g.up.set(0,0,1);break;case "front":b.set(0,-500,0);g.up.set(0,0,1);break;case "back":b.set(0,500,0);g.up.set(0,0,1);break;case "iso":b.set(-300,-300,300);g.up.set(0,0,1);break;default:b.set(-250,-500,250),g.up.set(0,0,1)}e instanceof T.Platform&&e.isPlatformVisible()&&("Inch"==e.units?b.divideScalar(50.8):b.divideScalar(2));0==ka((new T.V3).copy(b).negate())&&(e instanceof T.Platform&&e.isPlatformVisible()&&b.add(e.getPlatformBox().center()),cameraLight.position.copy(b),
g.position.copy(b),g.lookAt(e instanceof T.Platform&&e.isPlatformVisible()?e.getPlatformBox().center():new T.V3(0,0,0)),cameraLight.position.copy(g.position),l())});d.transformModeChanged.add(function(a){m.setScene(e);m.setMode(a)});d.snapChanged.add(function(a){m.setSnap(a)});d.spaceChanged.add(function(a){m.setSpace(a)});d.rendererChanged.add(function(a){f.dom.removeChild(n.domElement);n=a;n.setClearColor(X);n.autoClear=!1;n.autoUpdateScene=!1;n.setSize(f.dom.offsetWidth,f.dom.offsetHeight);r.renderer=
n;f.dom.appendChild(n.domElement);l()});d.toggleWallThickness.add(function(){var a=D.getObjectByName("show_analysis");a&&a.nextSprite();w.enabled=!w.enabled;d.updateWallThickness.dispatch();w.enabled&&notifications&&notifications.remind("Structural Analysis",!c.selected||c.selected instanceof T.PerspectiveCamera?'Select an object to perform analysis on.\nWhen done, explore settings in "Analysis" tab.':'Notice the new "Analysis" tab!\nYou can find useful settings there.',0,0,7776E6,!0)});d.updateWallThickness.add(function(){var a=
!c.selected||c.selected instanceof T.PerspectiveCamera?c.scene:c.selected;if(w.enabled){var b=function(){r.enabled=!1;r.xrayMode=!0;var a=!1;w.operate(function(b,c){a?0==b%1&&d.materialChanged.dispatch():(e(),a=!0);notifications&&notifications.updateProgress(g,b/c*100)},function(){e();notifications&&notifications.endProgress(g);d.objectChanged.dispatch(c.selected)})},e=function(){d.updateXRay.dispatch(a);r.xrayMode=!0;r.enabled=!0;r.wallThicknessMode=!0;r.setSize(f.dom.offsetWidth,f.dom.offsetHeight);
d.materialChanged.dispatch()};w.setScene(c.scene);w.restoreAnalysisMode();if(w.updateObjects()){var g;notifications?g=notifications.createProgress("Structural Analysis","Computing thicknesses and intersections",function(){w.abort=!0},"Abort Analysis",b):b()}else e()}else w.setAnalysisMode(0),r.enabled=!0,r.xrayMode=!1,r.wallThicknessMode=!1,d.materialChanged.dispatch()});d.sceneGraphChanged.add(function(){e=c.scene;aa();printingTogglePrinterMenuItem.setTextContent(c.scene.isPlatformVisible()?"Remove 3D Printer":
"Add 3D Printer");r.xrayMode&&(!c.selected||c.selected instanceof T.PerspectiveCamera)&&d.updateWallThickness.dispatch()});d.objectSelected.add(function(a){v.visible=!1;c.hasMarked()||m.detach();null!==a&&(v.update(a)&&(v.visible=!0),k.select(a),!1!==a instanceof T.PerspectiveCamera||!1!==a instanceof T.Platform||!1!==a instanceof T.Measurement||c.hasMarked()||m.attach(a));r.glowEnabled=c.hasMarked()||c.selected&&!1===c.selected instanceof T.PerspectiveCamera;d.updateWallThickness.dispatch();ca(a);
l()});d.objectMarked.add(function(a){null!==a&&!1===a instanceof T.PerspectiveCamera&&!1===a instanceof T.Platform&&!1===a instanceof T.Measurement&&m.attach(a);c.hasMarked()&&c.selected&&a!=c.selected&&!1===c.selected instanceof T.PerspectiveCamera&&m.detach(c.selected);r.glowEnabled=a&&!1===a instanceof T.PerspectiveCamera;l()});d.objectUnmarked.add(function(a){null!==a&&!1===a instanceof T.PerspectiveCamera&&!1===a instanceof T.Platform&&!1===a instanceof T.Measurement&&m.detach(a);!c.hasMarked()&&
c.selected&&!1===c.selected instanceof T.PerspectiveCamera&&m.attach(c.selected);r.glowEnabled=c.hasMarked()||c.selected&&!1===c.selected instanceof T.PerspectiveCamera;l()});d.updateXRay.add(function(a,b){T.SceneUtils.updateXray(a instanceof T.PerspectiveCamera?c.scene:a,g);void 0!==b&&(r.subtractPass.uniforms.opacity.value=b)});d.objectAdded.add(function(a){var b=!1;G.setDisplay("none");a.traverse(function(a){a instanceof T.Measurement&&a.measurementGizmo&&k.attachGizmo(a.measurementGizmo);a instanceof
T.Light&&(b=!0);!0!==a.dummy&&H.push(a)});T.SceneUtils.updateTriangleVisualization(a);T.SceneUtils.badEdgesMaterial.visible&&T.SceneUtils.updateBadEdges(a,!1,!0);!0===b&&R()});d.objectChanging.add(function(a){m.update();k.update();a!==g&&(v.visible&&v.update(a),void 0!==c.helpers[a.id]&&c.helpers[a.id].update(),aa());l()});d.objectChanged.add(function(a){T.GeometryUtils.resetGlobalBoundingBox(a);d.objectChanging.dispatch(a)});d.objectRemoved.add(function(a){var b=!1;a.traverse(function(a){a instanceof
T.Light&&(b=!0);a instanceof T.Measurement&&k.remove(a);!0!==a.dummy&&(a=H.indexOf(a),0<=a&&H.splice(a,1))});T.GeometryUtils.disposeObject(a);!0===b&&R()});d.helperAdded.add(function(a){H.push(a.getObjectByName("picker"))});d.helperRemoved.add(function(a){a=H.indexOf(a.getObjectByName("picker"));0<=a&&H.splice(a,1)});d.materialChanged.add(function(a){l()});d.renderHelpers.add(function(){l()});d.clearColorChanged.add(function(a){n.setClearColor(a);l();X=a});d.fogTypeChanged.add(function(a){a!==ha&&
("None"===a?e.fog=null:"Fog"===a?e.fog=new T.Fog(N,S,U):"FogExp2"===a&&(e.fog=new T.FogExp2(N,V)),R(),ha=a);l()});d.fogColorChanged.add(function(a){N=a;ba(e);l()});d.fogParametersChanged.add(function(a,b,c){S=a;U=b;V=c;ba(e);l()});d.windowResize.add(function(){g.aspect=f.dom.offsetWidth/f.dom.offsetHeight;g.updateProjectionMatrix();E.left=0;E.right=f.dom.offsetWidth;E.top=0;E.bottom=f.dom.offsetHeight;E.updateProjectionMatrix();z.setHeight(f.dom.offsetHeight/2);z.setWidth(Math.min(600,document.body.offsetWidth-
80));z.setMaxWidth(document.body.offsetWidth-80);n.setSize(f.dom.offsetWidth,f.dom.offsetHeight);r.setSize(f.dom.offsetWidth,f.dom.offsetHeight);l()});d.playAnimations.add(function(a){function b(){requestAnimationFrame(b);for(var c=0;c<a.length;c++)a[c].update(.016);l()}b()});d.reloadComments.add(function(a){z.load(a)});d.googleDriveCommentsChanged.add(function(a){e.comments=a;z.activeCommentId=null;z.update();z.scrollBottom()});da();return f};
