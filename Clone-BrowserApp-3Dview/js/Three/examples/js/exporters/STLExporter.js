T.STLExporter=function(){this.stlContent=""};
T.STLExporter.prototype={constructor:T.STLExporter,exportScene:function(a,e){var b=[];a.traverse(function(a){a instanceof T.Mesh&&!a.dummy&&b.push(a)});return e?this.binaryExportMeshes(b):this.exportMeshes(b)},exportMesh:function(a,e){return e?this.binaryExportMeshes([a]):this.exportMeshes([a])},exportMeshes:function(a){this.addLineToContent("solid exported");var e,b,f,d,c,m,k,h,g;for(e=0;e<a.length;e++)for(b=a[e],f=b.geometry,c=b.matrixWorld,m=b.position,b=0;b<f.faces.length;b++)d=f.faces[b],k=d.normal,
h=this.getTransformedPosition(f.vertices[d.a],c,m),g=this.getTransformedPosition(f.vertices[d.b],c,m),d=this.getTransformedPosition(f.vertices[d.c],c,m),this.addTriangleToContent(k,h,g,d);this.addLineToContent("endsolid exported");return this.stlContent},clearContent:function(){this.stlContent=""},addLineToContent:function(a){this.stlContent+=a+"\n"},addTriangleToContent:function(a,e,b,f){this.addLineToContent("\tfacet normal "+a.x+" "+a.y+" "+a.z);this.addLineToContent("\t\touter loop");this.addLineToContent("\t\t\tvertex "+
e.x+" "+e.y+" "+e.z);this.addLineToContent("\t\t\tvertex "+b.x+" "+b.y+" "+b.z);this.addLineToContent("\t\t\tvertex "+f.x+" "+f.y+" "+f.z);this.addLineToContent("\t\tendloop");this.addLineToContent("\tendfacet")},binaryExportMeshes:function(a){if(a&&void 0!=a.length&&0!=a.length){var e=new ArrayBuffer(84),b=new DataView(e);insertTextToDataView(b,"Exported from Chrome 3DView.COLOR=");var f=new T.Color(1,1,1);void 0!==a[0].color?f=a[0].color:void 0!==a[0].material&&void 0!==a[0].material.color&&(f=
a[0].material.color);b.setUint32(34,f.getHex(),!0);var d=0;insertTextToDataView(b,"PARTS=",38);for(var c=44,m=!0,k=0;k<a.length;++k){var h=a[k].geometry.faces.length,d=d+h;0<h&&c<=b.byteLength-8&&b.setUint32(c,h,!0);c+=4;void 0!==a[k].color?a[k].color.getHex()!==f.getHex()&&(m=!1):void 0!==a[k].material&&void 0!==a[k].material.color&&a[k].material.color.getHex()!==f.getHex()&&(m=!1)}c<=b.byteLength-8&&b.setUint32(c,0,!0);b.setUint32(b.byteLength-4,d,!0);for(var b=new ArrayBuffer(50*d),d=new DataView(b),
g,l,p,q,w,x,n,r,t,u,v,k=c=0;k<a.length;k++)for(g=a[k],void 0!==g.color?f=g.color:void 0!==g.material&&void 0!==g.material.color&&(f=g.material.color),h=g.geometry,p=g.matrixWorld,q=g.position,w=g.rotation,x=h.useColor||h.useVertexColor||h.useFaceColor||h.hasColors,g=0;g<h.faces.length;g++)l=h.faces[g],r=this.getTransformedNormal(l.normal,w),t=this.getTransformedPosition(h.vertices[l.a],p,q),u=this.getTransformedPosition(h.vertices[l.b],p,q),v=this.getTransformedPosition(h.vertices[l.c],p,q),l.color&&
x?(n=l.color,l=0):(n=f,l=m?32768:0),l+=Math.round(31*n.r)+(Math.round(31*n.g)<<5)+(Math.round(31*n.b)<<10),d.setFloat32(c+0,r.x,!0),d.setFloat32(c+4,r.y,!0),d.setFloat32(c+8,r.z,!0),d.setFloat32(c+12,t.x,!0),d.setFloat32(c+16,t.y,!0),d.setFloat32(c+20,t.z,!0),d.setFloat32(c+24,u.x,!0),d.setFloat32(c+28,u.y,!0),d.setFloat32(c+32,u.z,!0),d.setFloat32(c+36,v.x,!0),d.setFloat32(c+40,v.y,!0),d.setFloat32(c+44,v.z,!0),d.setUint16(c+48,l,!0),c+=50;try{return new Blob([e,b],{type:"application/octet-stream"})}catch(y){console.log(y)}}},
getTransformedPosition:function(a,e,b){a=a.clone();void 0!==e?a.applyMatrix4(e):void 0!==b&&a.add(b);return a},getTransformedNormal:function(a,e){var b=a.clone();void 0!==e&&b.applyEuler(e);return b}};
