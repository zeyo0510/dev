T.ReduceOperation=function(){T.OperationBase.call(this,editor,notifications);this.initIterations(3,[3,2,2],1,0);this.maxEdgeLength=1;this.processEdgesPercent=.2;this.maxAngleCos=.99};T.ReduceOperation.prototype=Object.create(T.OperationBase.prototype);
T.ReduceOperation.prototype.estimateParameters=function(a){(a=T.GeometryUtils.getGlobalBoundingBox(a))&&Infinity!==Math.abs(a.min.distanceTo(a.max))&&(a=Math.abs(a.max.z-a.min.z),editor&&editor.scene&&editor.scene instanceof T.Platform&&editor.scene.isPlatformVisible()?this.maxEdgeLength="Mm"==editor.scene.units?4:.1:this.maxEdgeLength=1E3<a?a/100:10<a?4:.1<a?.1:a/10)};
T.ReduceOperation.prototype.preOperateObject=function(a,h){a.noRendering=!0;h.newGeometry=h.geometry.clone();var k=h.newGeometry;k.mergeVertices();k.computeFaceNormals()};T.ReduceOperation.prototype.postOperateObject=function(a,h){var k=new T.Mesh(h.newGeometry,h.material.clone());h.newGeometry=void 0;return T.OperationBase.prototype.postOperateMesh.call(this,a,h,k)};
T.ReduceOperation.prototype.operateIteration=function(a,h){function k(a,b){void 0===n[a]&&(n[a]=[]);n[a].push(b)}for(var b=a.newGeometry,n={},p=this.maxEdgeLength*this.maxEdgeLength,e,c=0,f=b.faces.length;c<f&&!this.cancelled;++c)e=b.faces[c],k(e.a,c),k(e.b,c),k(e.c,c),void 0!==e.d&&k(e.d,c);e=T.GeometryUtils.updateEdgeFaces(b,!0);var d,g,m=[],l;for(l in e){if(this.cancelled)break;d=e[l];f=T.GeometryUtils.getIndexesFromKey(l);c=f[0];f=f[1];d&&2==d.length?(g=a.localToWorld(b.vertices[c].clone()).distanceToSquared(a.localToWorld(b.vertices[f].clone())),
d=b.faces[d[0]].normal.dot(b.faces[d[1]].normal),g<=p&&m.push({v1:c,v2:f,edgeLengthSq:g,cos:d})):(b.vertices[c].removed=!0,b.vertices[f].removed=!0)}m.sort(function(a,b){return a.edgeLengthSq*(.9994>a.cos?2:1)-b.edgeLengthSq*(.9994>b.cos?2:1)});c=0;for(f=m.length*this.processEdgesPercent;c<f&&!this.cancelled;++c)d=m[c],l=b.vertices[d.v1],g=b.vertices[d.v2],!0!==l.removed&&!0!==g.removed&&a.localToWorld(l.clone()).distanceToSquared(a.localToWorld(g.clone()))<=p&&(l=T.RemoveSharpTrianglesOperation.getCollapseEdgeError(d.v1,
d.v2,b,e,this.maxAngleCos),g=T.RemoveSharpTrianglesOperation.getCollapseEdgeError(d.v2,d.v1,b,e,this.maxAngleCos),void 0!==l&&(void 0===g||l<g)?T.RemoveSharpTrianglesOperation.collapseEdge(d.v1,d.v2,b,e):void 0!==g&&T.RemoveSharpTrianglesOperation.collapseEdge(d.v2,d.v1,b,e));for(c=0;c<b.vertices.length;++c)b.vertices[c].removed=void 0;b.mergeVertices();b.edgeFaceMap=void 0};
