T.GeometryUtils.nestObjects2D=function(a,c,d){function h(a,e,b){var p=new T.V3,f=a.size(),k=r&&c.isPlatformVisible()?new T.V3(c.margin,c.margin,c.margin):a.size().add(e.size()).multiplyScalar(.1);switch(b){case 0:p.set(e.min.x,e.max.y+k.y,e.min.z);break;case 1:p.set(e.max.x+k.x,e.min.y,e.min.z);break;case 2:p.set(e.min.x,e.min.y-f.y-k.y,e.min.z);break;case 3:p.set(e.min.x-f.x-k.x,e.min.y,e.min.z)}return p.sub(a.min)}function v(a){for(var e,c=null,b={source:null,target:null},f=Math.min(a.length,50),
k=0;k<f;++k)for(var d=0;d<k;++d)if(k!=d){e=t(a[d],a[k]);var g=h(a[d].bb,a[k].bb,e),l=a[d].bb;e=a[k].bb;l=(new T.Box3).copy(l);g&&l.translate(g);l.union(e);e=Math.abs((l.max.x-l.min.x)*(l.max.y-l.min.y))-Math.abs((e.max.x-e.min.x)*(e.max.y-e.min.y));if(null==c||e<c)b.target=k,b.source=d,c=e}return b}function t(a,e){var b=a.bb.size(),d=e.bb.size(),f=Math.abs(d.x)>Math.abs(d.y)?0:1;r&&c.isPlatformVisible()&&(f=c.getPlatformBox().size(),f=d.x+b.x>f.x-3*c.margin?0:1);return f+2*(Math.abs(b.z)>Math.abs(d.z)?
0:1)}function w(a,e,b,c){var d=a[c].objects,f=a[e].objects,g=a[e].bb;c=a[c].bb;for(var h=0;h<f.length;++h){var l=f[h];l.nestingTranslation||(l.nestingTranslation=new T.V3);l.nestingTranslation.add(b);d.push(l)}c.union(g.translate(b));a.splice(e,1)}var r=c&&c instanceof T.Platform;if(a&&a.length){for(var f=[],m=a.length,b=0;b<m;++b)if(!a[b].dummy){T.GeometryUtils._undoNesting(a[b]);var n=T.GeometryUtils.getGlobalBoundingBox(a[b]);f.push({bb:n,objects:[a[b]]});d&&d(b/m*20,100)}f.sort(function(a,c){var b=
a.bb.size(),d=c.bb.size();return Math.max(b.x,b.y)-Math.max(d.x,d.y)});for(m=f.length;1<f.length;){b=v(f);if(null==b.source||null==b.target)break;a=f[b.source];var n=f[b.target],q=t(a,n);a=0==a.bb.size().lengthSq()?0:h(a.bb,n.bb,q);w(f,b.source,a,b.target);d&&d(20+f.length/m*70,100)}if(1==f.length){m=f[0].bb.size();b=f[0].bb.center();a=c&&(c instanceof T.V3||c instanceof T.Platform)?c instanceof T.V3?(new T.V3).copy(c).sub(b):(new T.V3(c.margin,c.margin,c.minimumZ)).add(c.getPlatformBox().min).sub(f[0].bb.min):
(new T.V3(0,0,.5*m.z)).sub(b);for(var n=new T.V3,q=new T.Quaternion,u=new T.V3,m=f[0].objects.length,b=0;b<m;++b){var g=f[0].objects[b];g.nestingTranslation?g.nestingTranslation.add(a):g.nestingTranslation=(new T.V3).copy(a);g.parent?(g.parent.matrixWorld.decompose(n,q,u),g.position.add(g.nestingTranslation.applyQuaternion(q).divide(u))):g.position.add(g.nestingTranslation);T.GeometryUtils.resetGlobalBoundingBox(g);r&&c.isPlatformVisible()&&0>c.nestedObjectIds.indexOf(g.id)&&c.nestedObjectIds.push(g.id);
d&&d(90+b/m*10,100)}}d&&d(100,100)}};T.GeometryUtils._undoNesting=function(a){a&&a.nestingTranslation&&(a.position.sub(a.nestingTranslation),a.updateMatrixWorld(),a.nestingTranslation=null,T.GeometryUtils.resetGlobalBoundingBox(a))};
T.GeometryUtils.undoNesting=function(a){if(a)for(var c=0;c<a.length;++c){var d=a[c];if(d&&d.nestingTranslation){T.GeometryUtils._undoNesting(d);for(var h=d;h.parent;)h=h.parent;h instanceof T.Platform&&(h.nestedObjectIds=h.nestedObjectIds.filter(function(a){return a!=d.id}))}}};T.GeometryUtils.isNested=function(a){return a.nestingTranslation};
