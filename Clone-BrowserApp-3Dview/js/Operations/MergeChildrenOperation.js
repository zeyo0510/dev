T.MergeChildrenOperation=function(){};
T.MergeChildrenOperation.prototype.operate=function(g,a,h){for(var b=a.children.filter(function(a){return!(a instanceof T.Light)}),k=[],d=0;d<b.length;++d)this.operate(g,b[d],!0);if(!(a instanceof T.Measurement)){var b=a.children.filter(function(a){return!(a instanceof T.Light)}),e=T.SceneUtils.createMesh(a.geometry?a.geometry.clone():new T.Geometry,a.material?a.material.clone():void 0);T.Object3D.prototype.clone.call(a,e,!1);for(d=0;d<b.length;++d){var c=b[d];c instanceof T.Mesh?this.mergeGeometries(e,
c):c instanceof T.Measurement&&k.push(c)}(a.parent?a.parent:a).add(e);e.updateMatrixWorld();g.signals.objectAdded.dispatch(e);for(d=0;d<k.length;++d){for(var c=k[d],q=c.measurementGizmo.controlPoints,n=c.measurementGizmo.getControlPointsWorld(),f=0;f<n.length;++f)q[f].object=e,q[f].point=e.worldToLocal(n[f]);(h?a.parent?a.parent:a:e).add(c);g.signals.objectAdded.dispatch(c)}if(a.parent)g.removeHelper(a),a.parent.remove(a),g.signals.objectRemoved.dispatch(a);else for(d=0;d<b.length;++d)c=b[d],g.removeHelper(c),
a.remove(c),g.signals.objectRemoved.dispatch(c);return e}};
T.MergeChildrenOperation.prototype.mergeGeometries=function(g,a,h){a.updateMatrix();var b=a.matrix;g=g.geometry;var k=a.geometry,d;a=g.vertices.length;var e=g.vertices,c=k.vertices,q=g.faces,n=k.faces;g=g.faceVertexUvs[0];k=k.faceVertexUvs[0];void 0===h&&(h=0);void 0!==b&&(d=(new T.Matrix3).getNormalMatrix(b));for(var f=0,m=c.length;f<m;f++){var l=c[f].clone();void 0!==b&&l.applyMatrix4(b);e.push(l)}f=0;for(m=n.length;f<m;f++){var c=n[f],p,r=c.vertexNormals,t=c.vertexColors,l=new T.F3(c.a+a,c.b+a,
c.c+a);l.normal.copy(c.normal);void 0!==d&&l.normal.applyMatrix3(d).normalize();b=0;for(e=r.length;b<e;b++)p=r[b].clone(),void 0!==d&&p.applyMatrix3(d).normalize(),l.vertexNormals.push(p);l.color.copy(c.color);b=0;for(e=t.length;b<e;b++)p=t[b],l.vertexColors.push(p.clone());l.materialIndex=c.materialIndex+h;q.push(l)}f=0;for(m=k.length;f<m;f++)if(h=k[f],d=[],void 0!==h){b=0;for(e=h.length;b<e;b++)d.push(new T.Vector2(h[b].x,h[b].y));g.push(d)}};
