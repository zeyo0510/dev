T.FixNormalsOperation=function(){T.OperationBase.call(this,editor,notifications);this.initIterations(1,[5],1,0);this.maxRays=7};T.FixNormalsOperation.prototype=Object.create(T.OperationBase.prototype);
T.FixNormalsOperation.prototype.preOperateObject=function(e,b){b.newGeometry=b.geometry.clone();var a=b.newGeometry;a.mergeVertices();a.computeFaceNormals();a.verticesNeedUpdate=!0;b.updateMatrixWorld();this.edgeFacesMap=T.GeometryUtils.updateEdgeFaces(a);this.ray=new T.Raycaster;if(1==a.faces[0].normalsFixed)for(var p=0;p<a.faces.length;++p)a.faces[0].normalsFixed=!1};
T.FixNormalsOperation.prototype.postOperateObject=function(e,b){var a=new T.Mesh(b.newGeometry,b.material.clone());b.newGeometry=void 0;return T.OperationBase.prototype.postOperateMesh.call(this,e,b,a)};
T.FixNormalsOperation.prototype.operateIteration=function(e){for(var b=this,a=e.newGeometry,p=0,q=0;p<a.faces.length&&!b.cancelled;){for(;q<a.faces.length&&a.faces[q].normalsFixed;)++q;if(q==a.faces.length)break;var v=[],g=[],n=0,l=0,y=new T.V3;T.GeometryUtils.traverseAdjacentFaces(q,a,this.edgeFacesMap,function(d,c,e,f){c=a.faces[d];if(!c||c.normalsFixed||b.cancelled)return!1;l=T.GeometryUtils.triangleArea(a.vertices[c.a],a.vertices[c.b],a.vertices[c.c]);y.add((new T.V3).copy(c.normal).multiplyScalar(l));
T.GeometryUtils.computeFaceCentroid.call(a,c);0==g.length?g.push({metric:l,faceIndex:d}):(e=c.normal.dot(a.faces[g[n].faceIndex].normal),f=c.centroid.distanceTo(a.faces[g[n].faceIndex].centroid),l=l*f*(1-Math.abs(e)),.5>Math.abs(e)&&(g.length<b.maxRays||l>g[(n+1)%b.maxRays].metric)&&(n=(n+1)%b.maxRays,g[n]={metric:l,faceIndex:d}));c.normalsFixed=!0;p++;v.push(d);return!0},!0);for(var f=0,m=0,k=0;k<g.length&&!b.cancelled;++k){var d=a.faces[g[k].faceIndex],t=(new T.Matrix3).getNormalMatrix(e.matrixWorld),
t=(new T.V3).copy(d.normal).applyMatrix3(t).normalize(),d=e.localToWorld(d.centroid);b.ray.set(d,t);for(var h=[],c=[],r=0;2>r;++r){for(var u=b.ray.intersectObject(e,!0),w=0,x=0;x<u.length;++x)if(u[x].faceIndex==g[k].faceIndex){w=1;break}c[r]=u.length-w;h[r]=u.length%2==(w+r)%2;b.ray.set(d,t.negate())}0==c[0]&&(f+=5);0==c[1]&&(m+=5);h[0]&&h[1]?f+=2:h[0]||h[1]?c[0]<c[1]&&h[0]||c[0]>c[1]&&h[1]?++f:(c[0]<c[1]&&!h[0]||c[0]>c[1]&&!h[1])&&++m:m+=2}if(f<m||f==m&&0<y.y)for(k=f=0;k<v.length&&!b.cancelled;++k)d=
a.faces[v[k]],f=d.a,d.a=d.b,d.b=f,T.GeometryUtils.computeFaceNormal.call(a,d)}a.verticesNeedUpdate=!0;a.normalsNeedUpdate=!0;a.tangentsNeedUpdate=!0;a.buffersNeedUpdate=!0};T.InvertNormalsOperation=function(){T.OperationBase.call(this,editor,notifications);this.initIterations(0,[],1,0)};T.InvertNormalsOperation.prototype=Object.create(T.OperationBase.prototype);
T.InvertNormalsOperation.prototype.preOperateObject=function(e,b){var a=b.geometry;T.GeometryUtils.invertGeometry(a);a.verticesNeedUpdate=!0;a.normalsNeedUpdate=!0;a.tangentsNeedUpdate=!0;a.buffersNeedUpdate=!0};T.InvertNormalsOperation.prototype.postOperateObject=function(e,b){e.signals.objectChanged.dispatch(b)};
