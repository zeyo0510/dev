function getBestThumbnailFromHistory(){for(var t={url:null,quality:0},n=0;n<thumbnailsHistory.length;++n)t.quality<thumbnailsHistory[n].quality&&(t=thumbnailsHistory[n]);return t}function _createThumbnail(n,t,i){function h(){var t=r.videoWidth,i=r.videoHeight,n,u;t&&i&&(n=t/i,u=157/108,n>u?(r.style.height=108,r.style.width=108*n+"px",r.style.left=(157-108*n)/2+"px"):(r.style.width=157,r.style.height=157/n+"px",r.style.top=(108-157/n)/2+"px"))}function u(){(f!==null&&clearTimeout(f),r)&&(r.removeEventListener("error",s,!1),r.removeEventListener("canplay",o,!1),thumbnailsHistory=[],r.src&&webkitURL.revokeObjectURL(r.src),r.elementId&&mediaElements[r.elementId]&&delete mediaElements[r.elementId],discardElement(r),r=null)}function o(){var n;if(r.pause(),r.currentTime>=r.duration||thumbnailsHistory.length>5||r.duration<1&&r.currentTime>0){thumbnailsHistory.push(getElementPreview(r));n=getBestThumbnailFromHistory();i&&i(n.url);u();return}r.readyState>=2?(n=getElementPreview(r),thumbnailsHistory.push(n),n&&n.quality>2.5?(i&&i(n.url),u()):r.currentTime=r.currentTime==0?Math.min(180,r.duration/9):Math.min(r.currentTime*2,r.duration)):(n=getBestThumbnailFromHistory(),i&&i(n.url),u())}function s(n){debugWorkers&&console.log("error loading thumbnail",n,r.error);var t=getBestThumbnailFromHistory(),f=r.error&&(r.error.code==1||r.error.code==2)?undefined:null;i&&i(t.url?t.url:f);u()}function c(){debugWorkers&&console.log("timeout");var n=getBestThumbnailFromHistory();i&&i(n.url);u()}function l(){thumbnail=getElementPreview(r);i(thumbnail.url);u()}var t=t?t:"video",r=createElement(t),e,f;r&&(e=getUID()+"-"+getUID(),mediaElements[e]=r,r.elementId=e,t!=="video"&&r.setAttribute("type",t),f=null,r.addEventListener("canplay",o,!1),r.addEventListener("loadedmetadata",h,!1),r.addEventListener("error",s,!1),r.addEventListener("load",l,!1),r.src=n,f=setTimeout(c,thumbnailLoadingTimeout),r.pause&&r.pause())}function discardElement(n){var t=document.getElementById("leakGarbageBin");t||(t=document.createElement("DIV"),t.id="leakGarbageBin",t.style.display="none",document.body.appendChild(t));t.appendChild(n);t.innerHTML=""}function createElement(n){if(n){var t=null;return n.indexOf("image")>=0?t=document.createElement("img"):n.indexOf("audio")>=0?t=document.createElement("audio"):n.indexOf("video")>=0&&(t=document.createElement("video"),n!=="video"&&t.setAttribute("type",n)),t}}function getUID(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}function getThumbnailQuality(n){for(var e,t,c,w=n.data.length,u=[],r=[],l=0,a=0,v=0,s,y,h,i,o,p,f=0;f<n.height;f+=4)for(e=0;e<n.width;e+=4){if(s=f>=n.height/4&&f<=n.height*3/4&&e>=n.width/4&&e<=n.width*3/4,s&&++a,++l,t=(e+f*n.width)*4,t+n.width*4+6>=w)break;for(c=n.data[t]+n.data[t+1]+n.data[t+2]+n.data[t+3],y=Math.max(Math.max(n.data[t+0],n.data[t+4],n.data[t+n.width*4+0],n.data[t+n.width*4+4])-Math.min(n.data[t+0],n.data[t+4],n.data[t+n.width*4+0],n.data[t+n.width*4+4]),Math.max(n.data[t+1],n.data[t+5],n.data[t+n.width*4+1],n.data[t+n.width*4+5])-Math.min(n.data[t+1],n.data[t+5],n.data[t+n.width*4+1],n.data[t+n.width*4+5]),Math.max(n.data[t+2],n.data[t+6],n.data[t+n.width*4+2],n.data[t+n.width*4+6])-Math.min(n.data[t+2],n.data[t+6],n.data[t+n.width*4+2],n.data[t+n.width*4+6])),y>25&&s&&++v,r[0]=Math.floor(c/75),r[1]=Math.floor(n.data[t+4]/25),r[2]=Math.floor(n.data[t+n.width*4+1]/25),r[3]=Math.floor(n.data[t+n.width*4+6]/25),i=0;i<r.length;++i)u[i]===undefined&&(u[i]=[]),u[i][r[i]]=u[i][r[i]]===undefined?1:u[i][r[i]]+1}for(h=0,i=0;i<r.length;++i){o=0;for(t in u[i])p=u[i][t],p>l*.1&&++o;o>=4&&(o=Math.max(1,7-o));h+=o}return h*v/a}function checkSameColor(n){for(var u=null,r,t,f,e=n.data.length,i=0;i<n.height;i+=8)for(r=0;r<n.width;r+=8){if(t=(r+i*n.width)*4,t>=e)break;if(f=n.data[t]+n.data[t+1]+n.data[t+2]+n.data[t+3],u){if(Math.abs(u-f)>75)return!1}else u=f}return!0}function getElementPreview(n){var i=document.createElement("canvas"),r=n.clientWidth?n.clientWidth:n.style.width?n.style.width.substr(0,n.style.width.length-2):157,u=n.clientHeight?n.clientHeight:n.style.height?n.style.height.substr(0,n.style.height.length-2):108,t,f;return i.width=r,i.height=u,t=i.getContext("2d"),t.drawImage(n,0,0,r,u),f=getThumbnailQuality(t.getImageData(0,0,r,u)),debugImageQialityChecker&&(t.font="20px Arial",t.fillStyle="red",t.fillText(n.currentTime.toString(),50,20),t.fillText(f.toString(),50,40)),{url:i.toDataURL("image/webp",.5),quality:f}}var mediaElements=[],thumbnailsHistory=[],thumbnailLoadingTimeout=5e3,debugWorkers=!1,debugImageQialityChecker=!1;window.addEventListener("load",function(){console.log(window._src,window._type);window._data=undefined;_createThumbnail(window._src,window._type,function(n){window._data=n;debugWorkers?console.log(n):window.close()})})