function loadThumbnailTimeStamps(n){try{chrome.storage.local.get("ThumbnailTimeStamps",function(t){var i=t.ThumbnailTimeStamps;i!==undefined&&(thumbnailTimeStamps=i);n&&n()})}catch(t){}}function saveThumbnailTimeStamps(){try{chrome.storage.local.set({ThumbnailTimeStamps:thumbnailTimeStamps})}catch(n){}}function setThumbnailTimeStamp(n){thumbnailTimeStamps[n]?thumbnailTimeStamps[n].used=(new Date).getTime():thumbnailTimeStamps[n]={created:(new Date).getTime(),used:(new Date).getTime()};saveThumbnailTimeStamps()}function loadThumbnail(n,t){try{chrome.storage.local.get(n,function(i){t&&t(i[n])})}catch(i){}}function saveThumbnail(n,t){try{if(t===undefined)return;setThumbnailTimeStamp(n);var i={};i[n]=t;chrome.storage.local.set(i)}catch(r){}}function getThumbnail(n,t,i,r,u){function e(n){saveThumbnail(f,n);u&&u(n)}if(u){var o=t.hashCode(),f="T-"+o+(i?"-"+i:""),s=i=="gdrive"?1:0;loadThumbnail(f,function(i){i===undefined||forceThumbnailReload?createThumbnail(n,t,r,s,e):e(i)})}}function createThumbnail(n,t,i,r,u){thumbnailQueue[r].push({fileEntry:n,name:t,type:i,callback:u});thumbnailQueue[r].length==1&&processNextThumbnail(r)}function pauseThumbnais(){thumbnailPause=!0;updateThumbnailsProgress(!1)}function resumeThumbnais(){var n,t;for(thumbnailPause=!1,n=0;n<thumbnailQueue.length;++n)t=thumbnailQueue[n][0],t&&(t.processing||processNextThumbnail(n))}function clearThumbnaisQueue(){for(var t,n=0;n<thumbnailQueue.length;++n)t=thumbnailQueue[n][0],thumbnailQueue[n]=t&&t.processing?[t]:[];updateThumbnailsProgress()}function updateThumbnailsProgress(n){var r=document.getElementById("thumbnails-generation"),i,t,u;if(r){for(i=0,t=0;t<thumbnailQueue.length;++t)(window.gGenerateThumbnails||t!=1)&&(i+=thumbnailQueue[t].length);n!=!1&&i?(r.style.display="block",u=document.getElementById("progress-indicator"),u&&(u.innerText=chrome.i18n.getMessage("generatingThumbnailsText")+i)):r.style.display="none"}}function processNextThumbnail(n){function t(t){t?t.availableCapacity>209715200?_processNextThumbnail(n):pauseThumbnais():_processNextThumbnail(n)}thumbnailPause||(window.gGenerateThumbnails||n!=1)&&(thumbnailQueue[n][0]&&(thumbnailQueue[n][0].processing=!0),chrome.system&&chrome.system.memory&&chrome.system.memory.getInfo?chrome.system.memory.getInfo(t):_processNextThumbnail(n))}function _processNextThumbnail(n){function i(i){thumbnailQueue[n].shift();t.callback&&t.callback(i);processNextThumbnail(n)}if(updateThumbnailsProgress(),thumbnailQueue[n].length!=0){var t=thumbnailQueue[n][0];if(!t){processNextThumbnail(n);return}_createThumbnail(t.fileEntry,t.name,t.type,i)}}function getUID(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}function _createThumbnail(n,t,i,r){function e(){u&&webkitURL&&webkitURL.revokeObjectURL(u)}function s(n){console.log("error loading thumbnail for",t,n);e();r&&r(null)}function f(n,t,i){chrome.app.window.create("thumbnails/thumbnail-worker.html",debugWorkers?{}:{hidden:!0,id:getUID()},function(r){r&&r.contentWindow&&(r.contentWindow._src=n,r.contentWindow._type=t,r.onClosed.addListener(function(){e();i&&r&&i(r.contentWindow._data)}))})}function o(n,t,i){getMediaFileSrc(n,function(r){console.log("fallback for",n);f(r,t,i)})}var u=null,i=i?i:"video";n?n.file(function(n){u=webkitURL.createObjectURL(n);f(u,i,r)},s):requestGoogleDriveFileProperties(t,function(n){n.thumbnailLink&&!debugWorkers?loadFromUrl(n.thumbnailLink,function(n){u=window.URL.createObjectURL(n);f(u,"image",function(n){n?r(n):o(t,i,r)})},function(){o(t,i,r)}):f(authUrl(n.downloadUrl),i,r)})}function loadFromUrl(n,t,i){try{var r=new XMLHttpRequest;onError=function(n){i&&i(n)};onLoad=function(n){t&&t(n.target.response)};r.addEventListener("load",function(n){n.target.status===200||n.target.status===0?onLoad(n):onError(n)},!1);r.addEventListener("error",onError,!1);r.open("GET",n,!0);googleDriveAccessToken&&r.setRequestHeader("Authorization","Bearer "+googleDriveAccessToken);r.responseType="blob";r.send(null)}catch(u){console.log(u)}}var thumbnailTimeStamps=[],thumbnailQueue=[[],[]],thumbnailPause=!1,forceThumbnailReload=!1,debugWorkers=!1;loadThumbnailTimeStamps();String.prototype.hashCode=function(){var n,t,i;if(Array.prototype.reduce)return this.split("").reduce(function(n,t){return n=(n<<5)-n+t.charCodeAt(0),n&n},0);if(n=0,this.length===0)return n;for(t=0;t<this.length;t++)i=this.charCodeAt(t),n=(n<<5)-n+i,n=n&n;return n}