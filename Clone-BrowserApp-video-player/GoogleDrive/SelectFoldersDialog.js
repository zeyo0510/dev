function showSelectFoldersDialog(){showPasswordDialog(function(n){n&&_showSelectFoldersDialog()})}function _showSelectFoldersDialog(){function vt(){var n=window.getVideoElement();n&&n.addEventListener("keydown",onKeyDown,!1);window.addEventListener("keydown",onKeyDown,!1);window.gGenerateThumbnails=document.getElementById("thumbnails-checkbox").checked;window.gHideUnsupported=document.getElementById("unsupported-checkbox").checked;window.gShowTitles=document.getElementById("titles-checkbox").checked;gAnalyticsConfig.setTrackingPermitted(document.getElementById("statistics-checkbox").checked);saveMediaFolders();resumeThumbnais();saveLastState();i&&window.wizardDialog.closeDialog(i);chrome.mediaGalleries.getMediaFileSystems({interactive:"no"},getGalleriesInfo)}var at=window.getVideoElement(),i,n,r,tt,l,a,u,ot,it,v,y,f,st,rt,p,w,e,ht,ut,o,b,t,ct,ft,k,d,s,lt,et,h,g,nt,c;at&&at.removeEventListener("keydown",onKeyDown,!1);window.removeEventListener("keydown",onKeyDown,!1);i=document.createElement("div");i.id="select-folders";i.className="bbm-modal bbm-modal--open";window.wizardDialog.openDialog(i,.7)&&(n=document.createElement("div"),n.className="bbm-views bbm-modal__views",i.appendChild(n),r=document.createElement("h"),r.textContent=chrome.i18n.getMessage("foldersDialogTitle"),n.appendChild(r),r=document.createElement("h2"),r.textContent=chrome.i18n.getMessage("foldersDialogDescription"),n.appendChild(r),tt=document.createElement("div"),tt.className="folders-wrapper",tt.id="folders-wrapper",n.appendChild(tt),l=document.createElement("div"),l.className="thumbnails-wrapper",n.appendChild(l),a=document.createElement("div"),a.className="thumbnails-checkbox left checkbox",l.appendChild(a),u=document.createElement("input"),u.type="checkbox",u.value="None",u.id="thumbnails-checkbox",u.checked=window.gGenerateThumbnails,a.appendChild(u),ot=document.createElement("label"),ot.htmlFor="thumbnails-checkbox",a.appendChild(ot),it=document.createElement("div"),it.className="thumbnails-text",it.textContent=chrome.i18n.getMessage("foldersDialogThumbnailsCheckbox"),l.appendChild(it),v=document.createElement("div"),v.className="titles-wrapper",n.appendChild(v),y=document.createElement("div"),y.className="titles-checkbox left checkbox",v.appendChild(y),f=document.createElement("input"),f.type="checkbox",f.value="None",f.id="titles-checkbox",f.checked=window.gShowTitles,y.appendChild(f),st=document.createElement("label"),st.htmlFor="titles-checkbox",y.appendChild(st),rt=document.createElement("div"),rt.className="titles-text",rt.textContent=chrome.i18n.getMessage("foldersDialogTitlesCheckbox"),v.appendChild(rt),p=document.createElement("div"),p.className="unsupported-wrapper",n.appendChild(p),w=document.createElement("div"),w.className="unsupported-checkbox left checkbox",p.appendChild(w),e=document.createElement("input"),e.type="checkbox",e.value="None",e.id="unsupported-checkbox",e.checked=window.gHideUnsupported,w.appendChild(e),ht=document.createElement("label"),ht.htmlFor="unsupported-checkbox",w.appendChild(ht),ut=document.createElement("div"),ut.className="unsupported-text",ut.textContent=chrome.i18n.getMessage("foldersDialogUnsupportedCheckbox"),p.appendChild(ut),window.gDisablePasswordProtection||(o=document.createElement("div"),o.id="password-checkbox-wrapper",o.className="password-wrapper",n.appendChild(o),b=document.createElement("div"),b.className="password-checkbox left checkbox",o.appendChild(b),t=document.createElement("input"),t.type="checkbox",t.value="None",t.id="password-checkbox",t.checked=window.gPasswordMD5?!0:!1,t.onclick=function(){t.checked?changePasswordDialog():(window.gPasswordMD5="",configureMainButtons())},b.appendChild(t),ct=document.createElement("label"),ct.htmlFor="password-checkbox",b.appendChild(ct),ft=document.createElement("div"),ft.className="password-text",ft.textContent=chrome.i18n.getMessage("passwordProtect"),o.appendChild(ft)),k=document.createElement("div"),k.className="statistics-wrapper",n.appendChild(k),d=document.createElement("div"),d.className="statistics-checkbox left checkbox",k.appendChild(d),s=document.createElement("input"),s.type="checkbox",s.value="None",s.id="statistics-checkbox",s.checked=gAnalyticsConfig&&gAnalyticsConfig.isTrackingPermitted()==!0,d.appendChild(s),lt=document.createElement("label"),lt.htmlFor="statistics-checkbox",d.appendChild(lt),et=document.createElement("div"),et.className="statistics-text",et.textContent=chrome.i18n.getMessage("foldersDialogStatisticsCheckbox"),k.appendChild(et),h=document.createElement("div"),h.className="buttons-wrapper",n.appendChild(h),g=document.createElement("button"),g.className="left",g.textContent=chrome.i18n.getMessage("foldersDialogLocalButton"),g.onclick=onAddLocalFolder,h.appendChild(g),nt=document.createElement("button"),nt.className="left",nt.textContent=chrome.i18n.getMessage("foldersDialogGDriveButton"),nt.onclick=showAddGDriveFolderDialog,h.appendChild(nt),c=document.createElement("button"),c.className="right bold",c.textContent=chrome.i18n.getMessage("foldersDialogDoneButton"),c.onclick=vt,h.appendChild(c),c.focus(),pauseThumbnais(),loadMediaFolders(function(){updateMediaFolders()}))}function getActiveFoldersCount(n){for(var i=0,t=0;t<mediaFolders.length;++t)mediaFolders[t].active!==!1&&mediaFolders[t].checked&&(!n||mediaFolders[t].type==n)&&++i;return i}function getFolderById(n){for(var t=0;t<mediaFolders.length;++t)if(mediaFolders[t].id==n)return mediaFolders[t];return null}function getFolderByName(n,t){for(var i=0;i<mediaFolders.length;++i)if(mediaFolders[i].name==n&&(!t||mediaFolders[i].type==t))return mediaFolders[i];return null}function galleryIsVisible(n){var t=getFolderById(n);return t&&t.checked&&t.active!==!1}function addFolder(n,t,i,r,u){var f=getFolderByName(t,r),e;return(f||(f=getFolderById(n)),f)?(f.id=n,f.name=t,f.type=r,u!==undefined&&(f.active=u),f):(e={id:n,name:t,checked:i,type:r},u!==undefined&&(e.active=u),mediaFolders.push(e))}function removeFolder(n){for(var t=0;t<mediaFolders.length;++t)if(mediaFolders[t].id==n){mediaFolders[t].type=="local"&&chrome.mediaGalleries.dropPermissionForMediaFileSystem?(chrome.mediaGalleries.dropPermissionForMediaFileSystem(n),mediaFolders.splice(t,1)):mediaFolders[t].active=!1;return}}function removeFolderUIElement(n){var t=document.getElementById("folder-"+n);t&&t.parentNode&&t.parentNode.removeChild(t)}function updateMediaFolders(n){function t(t){for(var r,i=0;i<t.length;++i)r=chrome.mediaGalleries.getMediaFileSystemMetadata(t[i]),addFolder(r.galleryId,r.name,!1,"local");updateMediaFoldersUI();n&&n(t)}try{chrome.mediaGalleries.getMediaFileSystems({interactive:"no"},t)}catch(i){n&&n()}}function saveMediaFolders(){try{console.log("saving media folders",mediaFolders);chrome.storage.local.set({mediaFolders:mediaFolders})}catch(n){}}function loadMediaFolders(n){try{chrome.storage.local.get("mediaFolders",function(t){var r=t.mediaFolders,i;if(r!==undefined){for(mediaFolders=[],i=0;i<r.length;++i)r[i].name&&r[i].id&&addFolder(r[i].id,r[i].name,r[i].checked,r[i].type,r[i].active);console.log("loaded media folders",mediaFolders)}n&&n(mediaFolders)})}catch(t){n&&n()}}function updateMediaFoldersUI(){var e=document.getElementById("folders-wrapper"),n,t,r,i,o,s,f,u;if(e)for(e.innerHTML="",n=0;n<mediaFolders.length;++n)mediaFolders[n].active!=!1&&(t=document.createElement("div"),t.className="folder-element",t.id="folder-"+mediaFolders[n].id,e.appendChild(t),r=document.createElement("div"),r.className="folders-checkbox left checkbox",t.appendChild(r),i=document.createElement("input"),i.type="checkbox",i.value="None",i.id="folder-checkbox-"+mediaFolders[n].id,i.checked=mediaFolders[n].checked,i.setAttribute("folder-id",mediaFolders[n].id),i.onchange=onCheckboxChanged,r.appendChild(i),o=document.createElement("label"),o.htmlFor="folder-checkbox-"+mediaFolders[n].id,r.appendChild(o),s=document.createElement("div"),s.className=mediaFolders[n].type=="gdrive"?"folder-type left gdrive-folder":"folder-type left local-folder",t.appendChild(s),f=document.createElement("div"),f.className="folder-name",f.textContent=mediaFolders[n].name,t.appendChild(f),u=document.createElement("div"),u.className="remove-folder right",u.setAttribute("folder-id",mediaFolders[n].id),u.onclick=onRemoveFolder,t.appendChild(u))}function onCheckboxChanged(n){var i=n.target.getAttribute("folder-id"),t=getFolderById(i);t&&(t.checked=n.target.checked)}function onAddLocalFolder(){chrome.mediaGalleries.addUserSelectedFolder(function(n,t){for(var r,i=0;i<n.length;++i)r=chrome.mediaGalleries.getMediaFileSystemMetadata(n[i]),addFolder(r.galleryId,r.name,!0,"local",n[i].name==t?!0:undefined);updateMediaFoldersUI()})}function onRemoveFolder(n){var t=n.target.getAttribute("folder-id");removeFolder(t);removeFolderUIElement(t)}function showAddGDriveFolderDialog(){function l(){addFolder(selectedGDriveFolder.id,selectedGDriveFolder.name,!0,"gdrive",!0);n&&window.wizardDialog.closeDialog(n);updateMediaFoldersUI()}function a(){n&&window.wizardDialog.closeDialog(n)}var n=document.createElement("div"),i,o,r,e,s,h,c,f,u,t;n.id="select-gdrive";n.className="bbm-modal bbm-modal--gdrive";window.wizardDialog.openDialog(n,.1,!0)&&(i=document.createElement("div"),i.className="bbm-views bbm-modal__views",n.appendChild(i),o=document.createElement("h"),o.textContent=chrome.i18n.getMessage("GDriveFolderDialogTitle"),i.appendChild(o),r=document.createElement("div"),r.className="folders-wrapper grdive-folders-wrapper",r.id="grdive-folders-wrapper",i.appendChild(r),e=document.createElement("div"),e.className="spinner-center spinner",e.id="grdive-folders-loading",r.appendChild(e),s=document.createElement("table"),r.appendChild(s),h=document.createElement("tr"),s.appendChild(h),c=document.createElement("td"),c.id="grdive-folders-tree",h.appendChild(c),f=document.createElement("div"),f.className="buttons-wrapper",i.appendChild(f),u=document.createElement("button"),u.className="right",u.textContent="Cancel",u.onclick=a,f.appendChild(u),u.focus(),t=document.createElement("button"),t.className="right bold",t.id="gdrive-ok-button",t.textContent="OK",t.onclick=l,t.disabled=!0,f.appendChild(t),updateGDriveFoldersTree(function(){var n=document.getElementById("grdive-folders-loading");n&&(n.style.display="none");$("#grdive-folders-tree").fancytree({source:gdriveFoldersTree,clickFolderMode:3,activate:function(n,t){var i=t.node;selectGDRiveFolder(i)},checkbox:!1})}))}function parentIsSelected(n,t){function i(t){var r,u;if(!t)return null;if(t.key==n)return[t];if(t.children)for(r=0;r<t.children.length;++r)if(u=i(t.children[r]),u)return u.push(t),u;return null}function r(n){var i,r;if(!n)return!1;for(i=0;i<n.length&&n[i].key!=t;++i);if(i==n.length)return!1;for(i=0;i<n.length;++i){if(r=getFolderById(n[i].key),r&&r.active!==!1&&r.checked)return!0;if(n[i].key==t)return!1}return!1}var u=i(gdriveFoldersTree[0]);return r(u)}function resetGDriveFoldersTree(){gdriveFoldersTree=[]}function updateGDriveFoldersTree(n){function r(n,t){for(var i=0;i<t.length;++i)if(t[i].id==n)return i;return-1}function t(n,t,i){for(var u,r=i==undefined?0:i;r<t.length;++r)if(t[r].parents)for(u=0;u<t[r].parents.length;++u)if(t[r].parents[u].id==n||n=="root"&&t[r].parents[u].isRoot)return r;return-1}function i(n,u,f){var s=null,o,e;if(u=="root")n.push({title:"Google Drive",key:"root",expanded:!0}),s=n[0];else{if(o=r(u,f),o<0)return;n.children||(n.children=[]);n.children.push({title:f[o].title,key:f[o].id,folder:!0});s=n.children[n.children.length-1]}for(e=t(u,f);e>=0;)i(s,f[e].id,f),e=t(u,f,e+1)}var u=document.getElementById("grdive-folders-tree");if(gdriveFoldersTree&&gdriveFoldersTree.length>0){n&&n();return}queryGoogleDriveFiles("mimeType = 'application/vnd.google-apps.folder' and trashed=false",function(t){gdriveFoldersTree=[];i(gdriveFoldersTree,"root",t);n&&n()})}function selectGDRiveFolder(n){for(var r,t="",i=n;i&&i.title!=="Google Drive";i=i.parent)t=t?i.title+"\\"+t:i.title;t==""&&(t="Google Drive");selectedGDriveFolder={id:n.key,name:t};r=document.getElementById("gdrive-ok-button");r&&(r.disabled=!1)}var mediaFolders=[],gdriveFoldersTree=[],selectedGDriveFolder={}