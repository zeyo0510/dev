/*
    Copyright (c) 2015-2020 Alexander Shutau. All rights reserved.
    No part of the materials including graphics, logos, designs, codes,
    available in this application may be copied, reproduced, translated
    or reduced to any electronic medium or machine-readable form, in
    whole or in part, without specific permission. Distribution for
    commercial purposes is prohibited.
    
      #@@#
                        e@@e
    #@@@@e  #@.e@@@@e.  #@@# .e@#  .e@@@@e.  #@.e@#
      #@@#  #@@#  #@@#  #@@@@@#<   #@@#_.#'  #@@#
      #@@#  #@@#  #@@#  #@@# '@@#  '#@@@@@#  #@@# (R)
    
      V e c t o r   g r a p h i c s   e d i t o r
    
*/
"use strict";!function(e){function s(e,t){return(t=t||document).querySelector(e)}(e=e.Dom||(e.Dom={})).create=function(e,t){var n=document.createElement("div");n.innerHTML=e;var o,r=n.firstElementChild;for(o in t){var i=s(o,r);if(!i)throw new Error('Selector "'+o+"\" didn't return anything.");(0,t[o])(i)}return r},e.select=s,e.remove=function(e){return e.parentNode?e.parentNode.removeChild(e):e}}(xp=xp||{}),function(l){!function(s){(e=s.HeatLevel||(s.HeatLevel={}))[e.Log=1]="Log",e[e.Info=2]="Info",e[e.Warn=4]="Warn",e[e.Error=8]="Error";var a=s.HeatLevel;(e=s.Domain||(s.Domain={}))[e.Misc=16]="Misc",e[e.Binding=32]="Binding",e[e.UI=64]="UI",e[e.Test=128]="Test";var e=s.Domain;s.DisplayMessages=a.Warn|a.Error|e.Misc|e.Binding|e.UI|e.Test,s.write=function(e,t,n){for(var o,r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];if(0<(t&s.DisplayMessages)&&0<(e&s.DisplayMessages))switch(o="string"==typeof n?(r.unshift(n),l.formatString.apply(null,r)):n,e){case a.Log:console.log(o);break;case a.Info:console.info(o);break;case a.Warn:console.warn(o);break;case a.Error:console.error(o);break;default:throw new Error("Not implemented.")}},window.console||(window.console={}),window.console.log||(window.console.log=function(){}),window.console.info||(window.console.info=function(){}),window.console.warn||(window.console.warn=function(){}),window.console.error||(window.console.error=function(){})}(l.Log||(l.Log={}))}(xp=xp||{}),function(d){d.formatString=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];for(var o=e,r=0;r<t.length;r++)o=o.replace(new RegExp("\\{"+r+"\\}","gm"),t[r]);return o},d.clone=function(e){var c=[],p=[],h=function(e){var t=c.indexOf(e);if(0<=t)return p[t];t=typeof e;if(null===e||"string"==t||"boolean"==t||"number"==t||"undefined"==t||"function"==t)return e;if(e instanceof Object){if(e instanceof Date){var n=new Date;n.setDate(e.getTime()),n=n}else if(e instanceof Array){for(var o=[],r=0;r<e.length;r++)o[r]=h(e[r]);n=o}else if(e instanceof d.ObservableCollection){for(var i=new d.ObservableCollection,r=0;r<e.length;r++)i.push(h(e[r]));n=i}else if(e instanceof d.ObservableObject){var s={};for(a in e)s[a]=h(e[a]);n=d.observable(s)}else if(e instanceof Node)n=e.cloneNode(!0);else{var a,l=new(Object.getPrototypeOf(e).constructor);for(a in e)e.hasOwnProperty(a)&&(l[a]=h(e[a]));n=l}return c.push(e),p.push(n),n}throw new Error("Item type is not supported for cloning.")};return h(e)},d.createUuid=function(){for(var e=[],t="0123456789abcdef",n=0;n<36;n++)e[n]=t.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")},d.getClassName=function(e){return(e=/function\s+(.+?)\s*\(/.exec(e.constructor.toString()))&&1<e.length?e[1]:""},d.applyConstructor=function(e,t){return new(e.bind.apply(e,[null].concat(t)))},d.hidePrototypeProperties=function(e,t){var n,o,r=e.prototype;for(n in r)t&&0!==t.length&&!(0<=t.indexOf(n))||(o=Object.getOwnPropertyDescriptor(r,n))&&o.configurable&&(o.enumerable=!1,Object.defineProperty(r,n,o))}}(xp=xp||{}),function(l){!function(Path){function i(e,t,n){if(void 0===n&&(n=!0),e){if(""===(t=t.replace(/\[(.+)\]/g,".$1")))return e;var o=t.split("."),r=e;return o.every(function(e){if(null!=r)return r=r[e],!0;if(n)throw new Error('Unable to get property by path "'+t+'".');return!1}),r}if(n)throw new Error('Unable to get property by path "'+t+'".')}function s(e){e=(e=e.replace(/\[(.+)\]/g,".$1")).match(/^(.*)\.[^\.]*$/);return e&&e[1]?e[1]:""}function a(e){e=(e=e.replace(/\[(.+)\]/g,".$1")).match(/(^.*\.)?([^\.]*)$/);return e&&e[2]?e[2]:""}Path.getPropertyByPath=i,Path.setPropertyByPath=function(e,t,n,o){void 0===o&&(o=!0);var e=i(e,s(t),o),r=a(t);if(!(r in e)&&o)throw new Error(l.formatString('Unable to set property value "{0}" by path "{1}". Property is unreachable.',n,t));e[r]=n},Path.getObjectPath=s,Path.getPropertyName=a,Path.replaceIndexers=function(n){return n.replace(e,function(e,t){if(!o.test(t))throw new Error(l.formatString('Wrong property identifier. Property: "{0}". Path: "{1}".',n,t));return"."+t})};var e=/\[(.+?)\]/g,o=/^[0-9A-Z_$]*$/i}(l.Path||(l.Path={}))}(xp=xp||{}),function(e){var t=(n.prototype.get=function(t){var e=this.pairs.filter(function(e){return e.key===t});return 0<e.length?e[0].value:void 0},n.prototype.set=function(t,e){var n=this.pairs.filter(function(e){return e.key===t});0<n.length?void 0===e?this.pairs.splice(this.pairs.indexOf(n[0]),1):n[0].value=e:this.pairs.push({key:t,value:e})},n.prototype.remove=function(t){var e=this.pairs.filter(function(e){return e.key===t});0<e.length&&this.pairs.splice(this.pairs.indexOf(e[0]),1)},n);function n(e){this.pairs=e||[]}e.Dictionary=t}(xp=xp||{}),function(e){var t=(n.prototype.addHandler=function(t,e){e={event:this,handler:t,scope:e};if(this.handlers.filter(function(e){return e.handler===t})[0])throw new Error("Duplicate subscription.");return this.handlers.push(e),e},n.prototype.removeHandler=function(t){var e=this.handlers.filter(function(e){return e.handler===t})[0];if(!e)throw new Error("Unable to remove event handler :\n"+t.toString());return this.handlers.splice(this.handlers.indexOf(e),1),e.handler},n.prototype.removeAllHandlers=function(){this.handlers=[]},n.prototype.hasHandler=function(t){return 0<this.handlers.filter(function(e){return e.handler===t}).length},n.prototype.invoke=function(t){this.handlers.slice(0).forEach(function(e){e.handler.call(e.scope,t)})},n);function n(){this.handlers=[]}e.Event=t;o.prototype.subscribe=function(e,t,n){n=e.addHandler(t,n);return this.subscriptions.push(n),n},o.prototype.unsubscribe=function(e){for(var t;0<=(t=this.subscriptions.indexOf(this.subscriptions.filter(e)[0]));){var n=this.subscriptions[t];n.event.removeHandler(n.handler),this.subscriptions.splice(t,1)}},o.prototype.unsubscribeAll=function(){this.subscriptions.forEach(function(e){e.event.removeHandler(e.handler)}),this.subscriptions=[]},t=o;function o(){this.subscriptions=[]}e.EventRegistrar=t}(xp=xp||{}),function(i){function t(e){return e&&"object"==typeof e&&"onPropertyChanged"in e}i.isNotifier=t;var ObservableObject=function(){function ObservableObject(e,t){void 0===t&&(t=!0),this.__initProperties__(),this.__convertNested__=t,e&&this.__copySource__(e)}return ObservableObject.prototype.__initProperties__=function(){Object.defineProperty(this,"onPropertyChanged",{configurable:!0,value:new i.Event}),Object.defineProperty(this,"__convertNested__",{configurable:!0,writable:!0,value:!0})},ObservableObject.prototype.__copySource__=function(e){if(e instanceof ObservableObject)throw new Error("Source object is already observable.");if(Array.isArray(e))throw new Error("Source must not be an array. Use ObservableCollection.");if(!(e instanceof Object))throw new Error("Source must be an object.");for(var t in e)ObservableObject.extend(this,t,e[t],this.__convertNested__)},ObservableObject.isConvertable=function(e){return!("object"!=typeof e||t(e)||null===e||e instanceof Date)},ObservableObject.extend=function(t,n,o,e){if(void 0===e&&(e=!0),n in t)throw new Error('Unable to create notification property. Object already has "'+n+'" property.');if("onPropertyChanged"===n)throw new Error('Unable to create notification property. Reserved name "'+n+'" is used.');var r;o instanceof Date&&((r=new Date).setTime(o.getTime()),o=r);e=e&&ObservableObject.isConvertable(o)?(o=i.observable(o),function(e){ObservableObject.isConvertable(e)&&(e=i.observable(e)),o=e,t.onPropertyChanged.invoke(n)}):function(e){o=e,t.onPropertyChanged.invoke(n)},Object.defineProperty(t,n,{get:function(){return o},set:e,enumerable:!0,configurable:!0})},ObservableObject}();i.ObservableObject=ObservableObject,i.hidePrototypeProperties(ObservableObject)}(xp=xp||{});var xp,Geo,__extends=this&&this.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function o(){this.constructor=e}e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)};Object.defineProperties(Array.prototype,{move:{value:function(e,t){if(e<0&&(e=this.length+e),t<0&&(t=this.length+t),e>this.length-1||t>this.length-1||e<0||t<0)throw new Error("Index was out of range.");e=this.splice(e,1)[0];return this.splice(t,0,e),this}},attach:{value:function(e,t){return this.splice(t,0,e),this.length}},detach:{value:function(e){return this.splice(e,1)[0]}}}),function(t){(ObservableCollection=t.CollectionChangeAction||(t.CollectionChangeAction={}))[ObservableCollection.Create=0]="Create",ObservableCollection[ObservableCollection.Replace=1]="Replace",ObservableCollection[ObservableCollection.Delete=2]="Delete",ObservableCollection[ObservableCollection.Move=3]="Move",ObservableCollection[ObservableCollection.Attach=4]="Attach",ObservableCollection[ObservableCollection.Detach=5]="Detach";var r=t.CollectionChangeAction;t.isCollectionNotifier=function(e){return e&&"object"==typeof e&&"onCollectionChanged"in e};var ObservableCollection=function(n){function ObservableCollection(e,t){void 0===t&&(t=!0),n.call(this,e,t)}return __extends(ObservableCollection,n),ObservableCollection.prototype.__initProperties__=function(){var o=this;n.prototype.__initProperties__.call(this);function e(e,t,n){Object.defineProperty(o,e,{configurable:!0,enumerable:!1,writable:!!n,value:t})}e("onCollectionChanged",new t.Event),e("inner",[],!0),e("sorting",!1,!0),e("splicing",!1,!0)},ObservableCollection.prototype.__copySource__=function(e){var n=this;if(e&&(!Array.isArray(e)||e instanceof ObservableCollection))throw new Error("Source must be an array.");e&&e.forEach(function(e,t){n.add(e,t)})},ObservableCollection.prototype.add=function(e,t,n){if(e=this.createNotifierIfPossible(e),this.inner.splice(t,0,e),this.appendIndexProperty(),this.onCollectionChanged.invoke({action:n?r.Attach:r.Create,newIndex:t,newItem:e}),this.onPropertyChanged.invoke("length"),!this.__splicing__)for(var o=t;o<this.inner.length;o++)this.onPropertyChanged.invoke(o.toString())},ObservableCollection.prototype.remove=function(e,t){var n=this.inner.splice(e,1)[0];if(this.deleteIndexProperty(),this.onCollectionChanged.invoke({action:t?r.Detach:r.Delete,oldIndex:e,oldItem:n}),this.onPropertyChanged.invoke("length"),!this.__splicing__)for(var o=e;o<this.inner.length+1;o++)this.onPropertyChanged.invoke(o.toString());return n},ObservableCollection.prototype.appendIndexProperty=function(){var t=this,n=this.inner.length-1;Object.defineProperty(this,n.toString(),{get:function(){return t.inner[n]},set:function(e){e=t.createNotifierIfPossible(e),t.onCollectionChanged.invoke({action:r.Replace,oldIndex:n,newIndex:n,oldItem:t.inner[n],newItem:t.inner[n]=e}),t.onPropertyChanged.invoke(n.toString())},enumerable:!0,configurable:!0})},ObservableCollection.prototype.deleteIndexProperty=function(){delete this[this.inner.length]},ObservableCollection.prototype.createNotifierIfPossible=function(e){return this.__convertNested__&&t.ObservableObject.isConvertable(e)&&(e=t.observable(e)),e},Object.defineProperty(ObservableCollection.prototype,"length",{get:function(){return this.inner.length},enumerable:!0,configurable:!0}),ObservableCollection.prototype.move=function(e,t){if(this.inner.move(e,t),this.onCollectionChanged.invoke({action:r.Move,oldIndex:e,newIndex:t,oldItem:this.inner[t],newItem:this.inner[t]}),!this.__sorting__)for(var n=Math.min(e,t);n<=Math.max(e,t);n++)this.onPropertyChanged.invoke(n.toString());return this.inner},ObservableCollection.prototype.attach=function(e,t){return this.add(e,t,!0),this.inner.length},ObservableCollection.prototype.detach=function(e){return this.remove(e,!0)},ObservableCollection.prototype.pop=function(){return this.remove(this.inner.length-1)},ObservableCollection.prototype.push=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[+n]=arguments[n];return e.forEach(function(e){t.add(e,t.inner.length)}),this.inner.length},ObservableCollection.prototype.reverse=function(){this.__sorting__=!0;for(var e=this.inner.length,t=0;t<e-1;t++)this.move(0,e-1-t);this.__sorting__=!1;for(t=0;t<e;t++)e%2==1&&Math.floor(e/2)===t||this.onPropertyChanged.invoke(t.toString());return this.inner},ObservableCollection.prototype.shift=function(){return this.remove(0)},ObservableCollection.prototype.sort=function(e){var t=this,n=this.inner.slice(),o=n.slice().sort(e),r=n.map(function(e,t){return{old:t,new:o.indexOf(e)}});r.sort(function(e,t){return t.new-e.new});for(var i=0;i<r.length;i++)for(var s=i+1;s<r.length;s++)r[i].old<r[s].old&&r[s].old--;return this.__sorting__=!0,r.forEach(function(e){return e.old!==e.new&&t.move(e.old,e.new)}),this.__sorting__=!1,r.forEach(function(e){e.new!==e.old&&t.onPropertyChanged.invoke(e.new.toString())}),this.inner},ObservableCollection.prototype.splice=function(e,t){for(var n=this,o=[],r=2;r<arguments.length;r++)o[r-2]=arguments[r];if(void 0===e)throw new Error("The specified arguments may lead to unexpected result.");if(e<0&&(e=this.inner.length+e),e<0||e>this.inner.length||t<0)throw new Error("Index was out of range.");t=isNaN(t)?this.inner.length-e:t;var i=this.inner.length;this.__splicing__=!0;for(var s,a=new Array,l=0;l<t;l++){var c=this.remove(e);a.push(c)}o&&(s=e,o.forEach(function(e){n.add(e,s),s++})),this.__splicing__=!1;for(var p=o?o.length:0,h=this.inner.length,d=t===p?e+p:Math.max(h,i),l=e;l<d;l++)this.onPropertyChanged.invoke(l.toString());return a},ObservableCollection.prototype.unshift=function(){for(var e=[],t=0;t<arguments.length;t++)e[+t]=arguments[t];return this.splice(0,0,1<e.length?e:e[0]),this.inner.length},ObservableCollection.prototype.concat=function(){for(var e=[],t=0;t<arguments.length;t++)e[+t]=arguments[t];return this.inner.concat.apply(this.inner,arguments)},ObservableCollection.prototype.join=function(e){return this.inner.join.apply(this.inner,arguments)},ObservableCollection.prototype.slice=function(e,t){return this.inner.slice.apply(this.inner,arguments)},ObservableCollection.prototype.toJSON=function(){return this.inner},ObservableCollection.prototype.toString=function(){return Object.prototype.toString.call(this)},ObservableCollection.prototype.toLocaleString=function(){return this.inner.toLocaleString()},ObservableCollection.prototype.indexOf=function(e,t){return this.inner.indexOf.apply(this.inner,arguments)},ObservableCollection.prototype.lastIndexOf=function(e,t){return this.inner.lastIndexOf.apply(this.inner,arguments)},ObservableCollection.prototype.forEach=function(e,t){return this.inner.forEach.apply(this.inner,arguments)},ObservableCollection.prototype.every=function(e,t){return this.inner.every.apply(this.inner,arguments)},ObservableCollection.prototype.some=function(e,t){return this.inner.some.apply(this.inner,arguments)},ObservableCollection.prototype.filter=function(e,t){return this.inner.filter.apply(this.inner,arguments)},ObservableCollection.prototype.map=function(e,t){return this.inner.map.apply(this.inner,arguments)},ObservableCollection.prototype.reduce=function(e,t){return this.inner.reduce.apply(this.inner,arguments)},ObservableCollection.prototype.reduceRight=function(e,t){return this.inner.reduceRight.apply(this.inner,arguments)},ObservableCollection}(t.ObservableObject);t.ObservableCollection=ObservableCollection,t.hidePrototypeProperties(ObservableCollection)}(xp=xp||{}),function(n){n.observable=function(e,t){if(void 0===t&&(t=!0),n.isNotifier(e))throw new Error("Source object is already observable.");if("object"!=typeof e)throw new Error("Source must be an object.");if(e instanceof Date)throw new Error("Dates cannot be converted into an observable.");return new(Array.isArray(e)?n.ObservableCollection:n.ObservableObject)(e,t)}}(xp=xp||{}),function(f){var e=(Object.defineProperty(t.prototype,"result",{get:function(){return this.resultField},set:function(e){this.resultField=e,this.onPropertyChanged.invoke("result")},enumerable:!0,configurable:!0}),t.prototype.exec=function(){var e,t,n=[];for(e in this.params)"p"===e[0]&&((t=this.params[e])instanceof f.ObservableCollection&&(t=t.slice()),n.push(t));try{this.resultField=this.func.apply(null,n)}catch(e){f.Log.write(f.Log.HeatLevel.Warn,f.Log.Domain.Binding,"Expression error: "+e),this.resultField=null}this.onPropertyChanged.invoke("result")},t.prototype.resetWith=function(t){this.sourceSetToken=!0,this.scope=t,this.managers.forEach(function(e){e.resetWith(t)}),this.sourceSetToken=!1,this.exec()},t.prototype.unbind=function(){this.managers.forEach(function(e){return e.unbind()}),this.onPropertyChanged.removeAllHandlers()},t);function t(e,t){var r=this;this.sourceSetToken=!1,this.scope=t,Object.defineProperty(this,"onPropertyChanged",{value:new f.Event});var n=e.match(/\{([^\s\(\)]+?)\}/g),o=[];if(n)for(var i=0;i<n.length;i++){var s=n[i].replace("{","").replace("}","");if(""===s)throw new Error('Empty path binding for expression is not supported. Expression: "'+e+'"');o.indexOf(s)<0&&o.push(s)}this.propsPaths=o;var a=e,l=[];this.params={onPropertyChanged:new f.Event},this.collectionRegistrations={},o.forEach(function(e,t){var n="p"+t;a=a.split("{"+e+"}").join(n),l.push(n);var o="_"+n;r.params[o]=null,Object.defineProperty(r.params,n,{get:function(){return r.params[o]},set:function(e){var t;r.collectionRegistrations[n]&&(r.collectionRegistrations[n].unsubscribeAll(),delete r.collectionRegistrations[n]),void 0!==e&&f.isCollectionNotifier(e)&&((t=new f.EventRegistrar).subscribe(e.onCollectionChanged,function(e){r.exec()},r),r.collectionRegistrations[n]=t),r.params[o]=e,r.sourceSetToken||r.exec()},enumerable:!0,configurable:!0})}),this.func=function(){for(var e={},t=0;t<arguments.length;t++)e["p"+t]=arguments[t];return c(a,e)},this.managers=[],this.propsPaths.forEach(function(e,t){e=new f.BindingManager(r.params,l[t],r.scope,e);r.managers.push(e)}),this.exec()}function c(e,h){function o(e){for(var t;t!==e;)e=(t=e).replace(/\([^\(\)]*\)/g,function(e){return new Array(e.length+1).join(" ")});return e}function t(e){var t=e.replace(/((".*?")|('.*?'))/g,function(e,t){return new Array(t.length+1).join(" ")});return(t=(t=o(t)).indexOf(this.op))<0?null:[e.slice(0,t),e.slice(t+this.op.length,e.length)]}function n(e){var t=e.replace(/((".*?")|('.*?'))/g,function(e,t){return new Array(t.length+1).join(" ")});return(t=(t=o(t)).indexOf(this.op))<0?null:[e.slice(t+this.op.length,e.length)]}var d=[{op:"?:",fn:function(e,t,n){return e?t:n},split:function(e){var t=e.replace(/((".*?")|('.*?'))/g,function(e,t){return new Array(t.length+1).join(" ")}),n=(t=o(t)).indexOf(this.op[0]);if(n<0)return null;t=t.indexOf(this.op[1],n+1);return t<0?null:[e.slice(0,n),e.slice(n+1,t),e.slice(t+1,e.length)]}},{op:"||",fn:function(e,t){return e||t},split:t},{op:"&&",fn:function(e,t){return e&&t},split:t},{op:"!==",fn:function(e,t){return e!==t},split:t},{op:"===",fn:function(e,t){return e===t},split:t},{op:"!=",fn:function(e,t){return e!=t},split:t},{op:"==",fn:function(e,t){return e==t},split:t},{op:">=",fn:function(e,t){return t<=e},split:t},{op:">",fn:function(e,t){return t<e},split:t},{op:"<=",fn:function(e,t){return e<=t},split:t},{op:"<",fn:function(e,t){return e<t},split:t},{op:"-",fn:function(e,t){return e-t},split:t},{op:"+",fn:function(e,t){return e+t},split:t},{op:"/",fn:function(e,t){return e/t},split:t},{op:"*",fn:function(e,t){return e*t},split:t},{op:"typeof",fn:function(e){return typeof e},split:n},{op:"!",fn:function(e){return!e},split:n}],u=function(e,t){if(e=e.trim(),void 0===t&&(t=0),t===d.length){if("("===e[0]&&")"===e[e.length-1])return u(e.slice(1,e.length-1),0);if("true"===e)return!0;if("false"===e)return!1;var n=+e;if(""!==e&&!isNaN(n))return n;if(/^(".*")|('.*')$/.test(e))return e.slice(1,e.length-1);if(e in h)return h[e];if(e in window)return window[e];n=e.indexOf(".");if(0<=n){var o=e.slice(0,n);if(!(o in h||o in window))throw new Error("Expression scope doesn't contain \""+o+'".');var r=(o in h?h:window)[o],i=e.slice(n+1,e.length),o=f.Path.getObjectPath(i),r=f.Path.getPropertyByPath(r,o,!1);if("object"!=typeof r||null===r)return void f.Log.write(f.Log.HeatLevel.Info,f.Log.Domain.Binding,"Unable to execute expression: Item supposed to be an object.");if((i=(o=f.Path.getPropertyName(i)).match(/\((.*)\)$/))&&i[1]){o=o.slice(0,i.index);var s=i[1].split(",").map(function(e){return u(e)});return r[o].apply(r,s)}return r[o]}if((i=e.match(/\((.*)\)$/))&&i[1]){o=e.slice(0,i.index),s=i[1].split(",").map(function(e){return u(e)});return r[o].apply(r,s)}throw new Error("Expression scope doesn't contain \""+e+'".')}var s=d[t],a=s.split(e);if(a){for(var l=[],c=0;c<a.length;c++){var p=u(a[c],t);l.push(p)}return s.fn.apply(null,l)}return u(e,t+1)};return u(e)}f.Expression=e,f.hidePrototypeProperties(e),f.evaluate=c}(xp=xp||{}),function(a){var e=(t.prototype.registerPathObjects=function(e){var o=this;if(void 0===e&&(e=0),this.pathObjects){for(var t=this.pathObjects,n=e;n<t.length-1;n++)a.isNotifier(t[n].obj)&&t[n].obj.onPropertyChanged.removeHandler(t[n].handler);this.pathObjects.splice(e,t.length-e)}var r=this.pathParts;0===e&&(this.pathObjects=[]),this.pathObjects[e]={obj:0===e?this.scope:a.Path.getPropertyByPath(this.scope,r.slice(0,e).join("."))};for(t=this.pathObjects,n=e;n<r.length;n++){var i=r[n];t[n].prop=i;var s=t[n].obj;if(!s)break;t[n+1]={obj:s[i]},a.isNotifier(s)&&(i=n==r.length-1?function(t){return function(e){e===t&&o.updateTarget()}}(i):function(t,n){return function(e){e===t&&(o.registerPathObjects(n),o.updateTarget())}}(i,n+1),t[n].obj.onPropertyChanged.addHandler(i,this),t[n].handler=i)}this.pathObjects=t},t.prototype.resetWith=function(e){this.logMessage(a.formatString('Reset with "{0}".',this.scope)),this.scope=e,this.registerPathObjects(),this.updateTarget()},t.prototype.updateSource=function(){var e=a.Path.getPropertyByPath(this.target,this.targetPropertyPath),t=this.pathParts.length,n=this.pathObjects[t-1].obj;"object"==typeof n&&null!==n?(this.logMessage(a.formatString('Update source "{0}" property with value "{1}".',this.path,e)),n[this.pathParts[t-1]]=e):this.logMessage(a.formatString('Unable to update source property "{0}". It is unreachable.',this.path))},t.prototype.updateTarget=function(){var e=a.Path.getPropertyByPath(this.scope,this.path,!1),t=a.Path.getObjectPath(this.targetPropertyPath),n=a.Path.getPropertyName(this.targetPropertyPath),t=a.Path.getPropertyByPath(this.target,t);null!=e?(this.logMessage(a.formatString('Update target with "{0}" property value "{1}".',this.path,e)),t[n]=e):(this.logMessage(a.formatString('Unable to reach value "{0}". Using default value "{1}".',this.path,this.defaultValue)),t[n]=this.defaultValue)},t.prototype.unbind=function(){if(this.logMessage("Unbind."),this.pathObjects)for(var e=this.pathObjects,t=0;t<e.length-1;t++)a.isNotifier(e[t].obj)&&e[t].obj.onPropertyChanged.removeHandler(e[t].handler)},t.prototype.logMessage=function(e){a.Log.write(a.Log.HeatLevel.Log,a.Log.Domain.Binding,'BM of "{0}#{1}.{2}": {3}',a.getClassName(this.target),this.target.name,this.targetPropertyPath,e)},t);function t(e,t,n,o,r){if(!t)throw new Error("Target property path is not set.");if(!o)throw new Error("Unable to bind to empty path.");if(this.target=e,this.targetPropertyPath=t,this.scope=n,this.path=o,this.defaultValue=r,this.pathParts=a.Path.replaceIndexers(o).split("."),!this.pathParts||this.pathParts.length<1)throw new Error(a.formatString('Wrong binding path: "{0}".',o));this.pathParts.forEach(function(e){if(""===e)throw new Error(a.formatString('Unable to bind to empty path. Path: "{0}".',o))}),this.registerPathObjects(),this.updateTarget()}a.BindingManager=e}(xp=xp||{}),function(e){var s,t=(s=e.BindingManager,__extends(n,s),n);function n(e,t,n,o,r){var i;s.call(this,(i={},Object.defineProperty(i,"result",{set:function(e){n(e)},get:function(){if(o)return o()}}),i),"result",e,t,r)}e.BindingCallManager=t}(xp=xp||{}),function(c){var e=(t.property=function(t,n,o,e){e=e||{};var r,i,s,a=c.isNotifier(o),l=o instanceof c.ObservableObject&&o.__convertNested__;void 0===e.enumerable&&(e.enumerable=!0),i=e.getterConvertor?(r=e.getterConvertor,function(){return r(o)}):function(){return o},a=e.setterConvertor?(s=e.setterConvertor,a?function(e){c.ObservableObject.isConvertable(e)&&(e=c.observable(e,l)),o=s(e),t.onPropertyChanged.invoke(n)}:function(e){o=s(e),t.onPropertyChanged.invoke(n)}):a?function(e){c.ObservableObject.isConvertable(e)&&(e=c.observable(e,l)),o=e,t.onPropertyChanged.invoke(n)}:function(e){o=e,t.onPropertyChanged.invoke(n)},Object.defineProperty(t,n,{get:i,set:a,configurable:!0,enumerable:e.enumerable})},t.nonEnumerableField=function(e,t,n){Object.defineProperty(e,t,{enumerable:!1,configurable:!0,writable:!0,value:n})},t);function t(){Object.defineProperty(this,"onPropertyChanged",{enumerable:!1,configurable:!0,writable:!1,value:new c.Event})}c.Model=e}(xp=xp||{}),function(c){var e=(t.prototype.unsubscribeScopeFromChanges=function(){this.__registrar__.unsubscribeAll()},t);function t(n,o){var r=this;Object.defineProperty(this,"onPropertyChanged",{value:new c.Event}),Object.defineProperty(this,"__registrar__",{value:new c.EventRegistrar});function t(t){Object.defineProperty(r,t,{enumerable:!0,configurable:!0,get:function(){return n[t]},set:function(e){s=!0,n[t]=e,s=!1,r.onPropertyChanged.invoke(t)}}),i.push(t)}var i=[],s=!1;for(e in n)t(e);if(c.isNotifier(n)&&this.__registrar__.subscribe(n.onPropertyChanged,function(e){s||(i.indexOf(e)<0&&t(e),r.onPropertyChanged.invoke(e))},this),o){var e,a=[],l=function(t){Object.defineProperty(r,t,{enumerable:!0,configurable:!0,get:function(){return o[t]},set:function(e){s=!0,o[t]=e,s=!1,r.onPropertyChanged.invoke(t)}}),a.push(t)};for(e in o)i.indexOf(e)<0&&l(e);c.isNotifier(o)&&this.__registrar__.subscribe(o.onPropertyChanged,function(e){!s&&i.indexOf(e)<0&&(a.indexOf(e)<0&&l(e),r.onPropertyChanged.invoke(e))},this)}}c.Scope=e,c.hidePrototypeProperties(e)}(xp=xp||{}),function(s){s.serialize=function(e,n,o,t){return void 0===n&&(n=!0),void 0===t&&(t=" "),JSON.stringify(e,function(e,t){return n&&null!==t&&"object"==typeof t&&!Array.isArray(t)&&Object.getPrototypeOf(t)!==Object&&(t.__xp_model__=s.getClassName(t)),o&&(t=o(e,t)),t},t)},s.deserialize=function(e,t,r){var i={};return t&&t.forEach(function(e){var t=e.toString().match(/^function\s*(.*?)\s*\(/)[1];if(t in i)throw new Error('Duplicate model name: "'+t+'".');i[t]=e}),JSON.parse(e,function(e,t){if(r&&(t=r(e,t)),"object"==typeof t&&null!==t&&"__xp_model__"in t){if("ObservableObject"===t.__xp_model__||"ObservableCollection"===t.__xp_model__)return delete t.__xp_model__,s.observable(t);e=i[t.__xp_model__];if(!e)throw new Error('No costructor specified for model "'+t.__xp_model__+'".');var n,o=new e;for(n in t)"__xp_model__"!==n&&(o[n]=t[n]);return o}return t})}}(xp=xp||{}),(xp||(xp={})).createEventArgs=function(e,t,n){var o=e.domElement.getBoundingClientRect(),e={domEvent:t,element:e};return t instanceof TouchEvent?(n=n||t.changedTouches[0],e.elementX=n.pageX-o.left,e.elementY=n.pageY-o.top):("pageX"in t&&(e.elementX=t.pageX-o.left),"pageY"in t&&(e.elementY=t.pageY-o.top)),e},function(i){var n,e=(n=i.Model,__extends(t,n),t.prototype.initElement=function(){this.defineProperties(),this.domElement=this.getTemplate(),this.initEvents(),this.setDefaults()},t.prototype.getTemplate=function(){throw new Error("Unable to create an instance of an abstract element.")},t.prototype.renderTo=function(e){e.parentElement.replaceChild(this.domElement,e),this.__setRenderedState__(!0)},t.prototype.__setRenderedState__=function(e){(this.__isRendered__=e)&&this.onRendered&&this.onRendered.invoke(this)},t.prototype.initEvents=function(){var e=this;this.bindings=new i.Dictionary,this.expressions=new i.Dictionary,this.onScopeChanged=new i.Event,this.onRendered=new i.Event,this.onClick=new i.Event,this.onDoubleClick=new i.Event,this.onMouseDown=new i.Event,this.onMouseUp=new i.Event,this.onMouseMove=new i.Event,this.onMouseEnter=new i.Event,this.onMouseLeave=new i.Event,this.onKeyPress=new i.Event,this.onKeyDown=new i.Event,this.onKeyUp=new i.Event,this.onRemoved=new i.Event,this.onRemoved.addHandler(function(){e.onScopeChanged.removeAllHandlers(),e.onRendered.removeAllHandlers(),e.onClick.removeAllHandlers(),e.onDoubleClick.removeAllHandlers(),e.onMouseDown.removeAllHandlers(),e.onMouseUp.removeAllHandlers(),e.onMouseMove.removeAllHandlers(),e.onMouseEnter.removeAllHandlers(),e.onMouseLeave.removeAllHandlers(),e.onKeyPress.removeAllHandlers(),e.onKeyDown.removeAllHandlers(),e.onKeyUp.removeAllHandlers()},this),this.initSimpleDomEvent("click",this.onClick),this.initSimpleDomEvent("dblclick",this.onDoubleClick),this.initSimpleDomEvent("mousedown",this.onMouseDown),this.initSimpleDomEvent("mouseup",this.onMouseUp),this.initSimpleDomEvent("mousemove",this.onMouseMove),this.initSimpleDomEvent("mouseover",this.onMouseEnter),this.initSimpleDomEvent("mouseout",this.onMouseLeave),this.initSimpleDomEvent("keypress",this.onKeyPress),this.initSimpleDomEvent("keydown",this.onKeyDown),this.initSimpleDomEvent("keyup",this.onKeyUp)},t.prototype.initSimpleDomEvent=function(e,t){var n=this;this.domElement.addEventListener(e,function(e){e=i.createEventArgs(n,e);t.invoke(e)})},t.prototype.applyMarkup=function(e){for(var t in e){var n,o,r=e[t];"string"==typeof r?(n=r.match(/^\{(.*)\}$/),o=r.match(/^\((.*)\)$/),n&&n[1]?this.bind(t,n[1]):o&&o[1]?this.express(t,o[1]):this[t]=r):this[t]instanceof i.Event?this[t].addHandler(e[t],this):this[t]=r}},t.prototype.defineProperty=function(t,n){var o,r=this;Object.defineProperty(this,t,{enumerable:!0,configurable:!0,get:function(){return n.getter?n.getter():o},set:function(e){if(n.acceptedValues&&n.acceptedValues.indexOf(e)<0)throw new Error(i.formatString('The value "{0}" is not accepted for a {1}. List of accepted values: {2}.',e,i.getClassName(r),n.acceptedValues.join(", ")));n.setter&&n.setter(e),o=e,n.observable&&r.onPropertyChanged.invoke(t)}})},t.prototype.defineProperties=function(){var t=this;this.defineProperty("enabled",{setter:function(e){e?(t.domElement.classList.remove("disabled"),t.domElement.style.pointerEvents=""):(t.domElement.classList.add("disabled"),t.domElement.style.pointerEvents="none")},observable:!0}),this.defineProperty("name",{setter:function(e){return t.domElement.id=e},getter:function(){return t.domElement.id}}),this.defineProperty("key",{}),this.defineProperty("width",{setter:function(e){return t.domElement.style.width=e},getter:function(){return t.domElement.offsetWidth+"px"}}),this.defineProperty("height",{setter:function(e){return t.domElement.style.height=e},getter:function(){return t.domElement.offsetHeight+"px"}}),this.defineProperty("minWidth",{setter:function(e){return t.domElement.style.minWidth=e},getter:function(){return t.domElement.style.minWidth}}),this.defineProperty("minHeight",{setter:function(e){return t.domElement.style.minHeight=e},getter:function(){return t.domElement.style.minHeight}}),this.defineProperty("maxWidth",{setter:function(e){return t.domElement.style.maxWidth=e},getter:function(){return t.domElement.style.maxWidth}}),this.defineProperty("maxHeight",{setter:function(e){return t.domElement.style.maxHeight=e},getter:function(){return t.domElement.style.maxHeight}}),this.defineProperty("margin",{setter:function(e){return t.domElement.style.margin=e},getter:function(){return t.domElement.style.margin}});var n="";this.defineProperty("style",{getter:function(){return n},setter:function(e){n&&n.split(" ").forEach(function(e){return t.domElement.classList.remove(e)}),(n=e).split(" ").forEach(function(e){return t.domElement.classList.add(e)})}}),this.defineProperty("flex",{setter:function(e){switch(t.domElement.classList.remove("flex-None"),t.domElement.classList.remove("flex-Stretch"),t.domElement.classList.remove("flex-Grow"),t.domElement.classList.remove("flex-Shrink"),e){case"none":t.domElement.classList.add("flex-None");break;case"stretch":t.domElement.classList.add("flex-Stretch");break;case"grow":t.domElement.classList.add("flex-Grow");break;case"shrink":t.domElement.classList.add("flex-Shrink");break;default:throw new Error('Unknown flex value "'+e+'".')}},acceptedValues:["none","shrink","grow","stretch"]}),this.defineProperty("visible",{setter:function(e){e?t.domElement.classList.remove("hidden"):t.domElement.classList.add("hidden")},observable:!0})},t.prototype.setDefaults=function(){this.enabled=!0,this.visible=!0},Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),t.prototype.__setParent__=function(e){if(e&&e.children.indexOf(this)<0)throw new Error('The "parent" property must be set only by parent.');this._parent&&this._parent.onScopeChanged.removeHandler(this.parentScopeChangeHandler),(this._parent=e)&&(this._parent.onScopeChanged.addHandler(this.parentScopeChangeHandler,this),this.parentScopeChangeHandler(),!this.__isRendered__&&e.__isRendered__&&this.__setRenderedState__(!0))},t.prototype.remove=function(){this.detach(),this.bindings.pairs.forEach(function(e){return e.value.unbind()}),this.bindings.pairs.splice(0),this.expressions.pairs.forEach(function(e){return e.value.unbind()}),this.expressions.pairs.splice(0),i.Dom.remove(this.domElement),this.onRemoved.invoke(this),this.onRemoved.removeAllHandlers()},t.prototype.insertBefore=function(e){if(!e.parent)throw new Error("Target element has no parent.");var t;t=this.parent===e.parent?this.parent.children.indexOf(this)<(t=this.parent.children.indexOf(e))?t-1:t:e.parent.children.indexOf(e),e.parent.insert(this,t)},t.prototype.insertAfter=function(e){if(!e.parent)throw new Error("Target element has no parent.");var t;t=this.parent===e.parent?this.parent.children.indexOf(this)<(t=this.parent.children.indexOf(e))?t:t+1:e.parent.children.indexOf(e)+1,e.parent.insert(this,t)},t.prototype.appendTo=function(e){e.append(this)},t.prototype.prependTo=function(e){e.prepend(this)},t.prototype.detach=function(){this.parent&&this.parent.detachChild(this)},t.prototype.bubbleBy=function(e){for(var t=this;t;){if(!0==!!e(t))return t;t=t.parent}return null},t.prototype.focus=function(){this.domElement.focus()},t.prototype.bind=function(e,t,n,o){var r=this.bindings.get(e);if(r&&r.unbind(),""===e||""===t)throw new Error("Binding path cannot be empty.");if("scope"===e&&!this.useParentScope&&!n)throw new Error("Unable to bind element's scope to itself.");n||(this.useParentScope?this.parent&&(n=this.parent.scope):n=this.scope),"string"==typeof e?this.bindings.set(e,new i.BindingManager(this,e,n,t,o)):this.bindings.set(e,new i.BindingCallManager(n,t,e,null,o))},t.prototype.unbind=function(e){var t=this.bindings.get(e);t&&(t.unbind(),this.bindings.remove(e));t=this.expressions.get(e);t&&(t.unbind(),this.expressions.remove(e))},t.prototype.express=function(t,e,n){var o=this,r=this.expressions.get(t);r&&r.unbind(),r=new i.Expression(e,n||this.scope),this.expressions.set(t,r),"string"==typeof t?this.bindings.set(t,new i.BindingManager(this,t,r,"result")):this.bindings.set(t,new i.BindingCallManager(r,"result",function(e){return t(e,o)}))},Object.defineProperty(t.prototype,"scope",{get:function(){return this._scope},set:function(n){var o=this;this.bindings.get("scope")&&n!==this.parent.scope&&(n=new i.Scope(n,this.parent.scope)),i.Log.write(i.Log.HeatLevel.Log,i.Log.Domain.UI|i.Log.Domain.Binding,'{0}:{1}: Set data scope "{2}".',i.getClassName(this),this.name||"-",n),this._scope=n,this.bindings.pairs.forEach(function(e){var t=e.key,e=e.value;"scope"===t||o.expressions.get(t)||e.resetWith(n)}),this.expressions.pairs.forEach(function(e){var t=e.key,e=e.value;"scope"!==t&&e.resetWith(n)}),this.onScopeChanged.invoke(n)},enumerable:!0,configurable:!0}),t.prototype.onInput=function(e,t){i.Log.write(i.Log.HeatLevel.Log,i.Log.Domain.UI,'{0}:{1}.{2}: Input "{3}".',i.getClassName(this),this.name||"-",e,t),"string"==typeof e?i.Path.setPropertyByPath(this,e,t):e(t);e=this.bindings.get(e);e&&e.updateSource()},t);function t(e){var t=this;n.call(this),this.__isRendered__=!1,this.parentScopeChangeHandler=function(){var e;t.useParentScope&&((e=t.bindings.get("scope"))?e.resetWith(t.parent.scope):t.scope=t.parent.scope)},this.useParentScope=!0,this.initElement(),e&&this.applyMarkup(e),this.init&&this.init(this)}i.Element=e}(xp=xp||{}),function(o){var r,e=(r=o.Element,__extends(t,r),t.prototype.getTemplate=function(){var t=this;return o.Dom.create('\n                <button class="Button" type="button">\n                    <span class="wrapper">\n                        <span class="icon"></span>\n                        <span class="text"></span>\n                    </span>\n                </button>',{".icon":function(e){return t.iconElement=e},".text":function(e){return t.textElement=e}})},t.prototype.setDefaults=function(){r.prototype.setDefaults.call(this),this.icon=null,this.text=""},t.prototype.defineProperties=function(){var t,n=this;r.prototype.defineProperties.call(this),this.defineProperty("icon",{setter:function(e){"string"==typeof e&&""!==e?(t&&("."===t[0]?n.iconElement.classList.remove(t.slice(1)):n.iconElement.style.backgroundImage=""),"*"!==(e=e.trim())&&("."===e[0]?n.iconElement.classList.add(e.slice(1)):n.iconElement.style.backgroundImage=o.formatString("url({0})",e),t=e),n.iconElement.classList.remove("hidden")):n.iconElement.classList.add("hidden")}}),this.defineProperty("text",{setter:function(e){!0==!!e?(n.textElement.textContent=e,n.textElement.classList.remove("hidden")):n.textElement.classList.add("hidden")}})},t);function t(e){r.call(this,e)}o.Button=e}(xp=xp||{}),function(n){var o,e=(o=n.Element,__extends(t,o),t.prototype.getTemplate=function(){var t=this;return n.Dom.create('\n                <label class="CheckBox">\n                    <input type="checkbox"/>\n                    <span class="check"></span>\n                    <label class="text"></label>\n                </label>',{input:function(e){return t.checkElement=e},".text":function(e){return t.textElement=e}})},t.prototype.initEvents=function(){var t=this;o.prototype.initEvents.call(this),this.onCheckChange=new n.Event,this.onRemoved.addHandler(function(){return t.onCheckChange.removeAllHandlers()},this),this.domElement.addEventListener("change",function(e){t.readonly||(t.onInput("checked",t.checked),(e=n.createEventArgs(t,e)).checked=t.checked,t.onCheckChange.invoke(e))})},t.prototype.setDefaults=function(){o.prototype.setDefaults.call(this),this.checked=!1,this.readonly=!1,this.text=""},t.prototype.defineProperties=function(){var t=this;o.prototype.defineProperties.call(this),this.defineProperty("checked",{getter:function(){return t.checkElement.checked},setter:function(e){return t.checkElement.checked=e},observable:!0}),this.defineProperty("text",{setter:function(e){!0==!!e?(t.textElement.textContent=e,t.textElement.classList.remove("hidden")):t.textElement.classList.add("hidden")}}),this.defineProperty("readonly",{setter:function(e){e?(t.checkElement.readOnly=!0,t.domElement.style.pointerEvents="none"):(t.checkElement.readOnly=!1,t.domElement.style.pointerEvents="")}}),this.defineProperty("enabled",{setter:function(e){e?t.domElement.classList.remove("disabled"):t.domElement.classList.add("disabled"),!t.readonly&&e?(t.checkElement.readOnly=!1,t.domElement.style.pointerEvents=""):(t.checkElement.readOnly=!0,t.domElement.style.pointerEvents="none")},observable:!0})},t);function t(e){o.call(this,e)}n.CheckBox=e}(xp=xp||{}),function(e){var n,t=(n=e.Element,__extends(o,n),o.prototype.getTemplate=function(){return e.Dom.create('<label class="Label"></label>')},o.prototype.defineProperties=function(){var t=this;n.prototype.defineProperties.call(this),this.defineProperty("text",{setter:function(e){t.domElement.textContent=e},observable:!0})},o);function o(e){n.call(this,e)}e.Label=t}(xp=xp||{}),function(e){var t,n=(t=e.Element,__extends(o,t),o.prototype.getTemplate=function(){return e.Dom.create('<span class="Placeholder">&nbsp;</span>')},o.prototype.setDefaults=function(){t.prototype.setDefaults.call(this)},o);function o(){t.apply(this,arguments)}e.Placeholder=n}(xp=xp||{}),function(e){var n,t=(n=e.CheckBox,__extends(o,n),o.prototype.getTemplate=function(){var t=this;return e.Dom.create('\n                <label class="RadioButton">\n                    <input type="radio"/>\n                    <span class="check"></span>\n                    <label class="text"></label>\n                </label>',{input:function(e){return t.checkElement=e},".text":function(e){return t.textElement=e}})},o.prototype.initEvents=function(){var t=this;n.prototype.initEvents.call(this),this.onCheckChange.addHandler(function(e){e.checked&&t.onInput("selectedItem",t.item)},this)},o.prototype.defineProperties=function(){var t=this;n.prototype.defineProperties.call(this),this.defineProperty("group",{getter:function(){return t.checkElement.name},setter:function(e){return t.checkElement.name=e}}),this.defineProperty("item",{setter:function(e){t.checked!=(e==t.selectedItem)&&(t.checked=e==t.selectedItem)},observable:!0}),this.defineProperty("selectedItem",{setter:function(e){t.checked!=(e==t.item)&&(t.checked=e==t.item)},observable:!0})},o);function o(e){n.call(this,e)}e.RadioButton=t}(xp=xp||{}),function(o){var r,e=(r=o.RadioButton,__extends(t,r),t.prototype.getTemplate=function(){var t=this;return o.Dom.create('\n                <label class="ToggleButton">\n                    <input type="radio"/>\n                    <span class="icon"></span>\n                    <span class="text"></span>\n                </label>',{input:function(e){return t.checkElement=e},".icon":function(e){return t.iconElement=e},".text":function(e){return t.textElement=e}})},t.prototype.setDefaults=function(){r.prototype.setDefaults.call(this),this.icon=null},t.prototype.defineProperties=function(){var t,n=this;r.prototype.defineProperties.call(this),this.defineProperty("checked",{getter:function(){return n.checkElement.checked},setter:function(e){(n.checkElement.checked=e)?n.domElement.classList.add("checked"):n.domElement.classList.remove("checked")},observable:!0}),this.defineProperty("icon",{setter:function(e){"string"==typeof e&&""!==e?(t&&("."===t[0]?n.iconElement.classList.remove(t.slice(1)):n.iconElement.style.backgroundImage=""),"*"!==(e=e.trim())&&("."===e[0]?n.iconElement.classList.add(e.slice(1)):n.iconElement.style.backgroundImage=o.formatString("url({0})",e),t=e),n.iconElement.classList.remove("hidden")):n.iconElement.classList.add("hidden")}})},t);function t(e){r.call(this,e)}o.ToggleButton=e}(xp=xp||{}),function(i){var s,e=(s=i.Element,__extends(t,s),t.prototype.getTemplate=function(){return i.Dom.create('<input class="TextBox" type="text" />')},t.prototype.initEvents=function(){var n=this;s.prototype.initEvents.call(this),this.onTextChange=new i.Event,this.onRemoved.addHandler(function(){return n.onTextChange.removeAllHandlers()},this);function t(e){var t=i.createEventArgs(n,e);t.oldText=o,e=n.value.toString(),t.newText=e,n.onTextChange.invoke(t),n.onInput("text",n.value),n.onInput("value",n.value),o=e}var o="";this.domElement.addEventListener("change",function(e){t(e)}),this.domElement.addEventListener("input",function(e){n.notifyOnKeyDown&&t(e)});var r=!!navigator.userAgent.match(/Trident\/7\./);this.domElement.addEventListener("keypress",function(e){13===e.keyCode&&r&&t(e)})},t.prototype.setDefaults=function(){s.prototype.setDefaults.call(this),this.type="string",this.readonly=!1,this.placeholder=""},t.prototype.defineProperties=function(){var n=this;s.prototype.defineProperties.call(this),this.defineProperty("text",{getter:function(){return n.domElement.value},setter:function(e){null==e&&(e=""),n.domElement.value=e},observable:!0}),this.defineProperty("value",{getter:function(){switch(n.type){case"string":return n.text;case"number":return parseFloat(n.text)||0;default:throw new Error("TextBox type value is not implemented.")}},setter:function(e){var t=typeof e;"number"!=t&&"boolean"!=t||(e=e.toString()),null==e&&(e=""),n.text=e},observable:!0}),this.defineProperty("type",{setter:function(e){switch(e){case"string":n.domElement.type="text";break;case"number":n.domElement.type="number";break;default:throw new Error("TextBoxType value is not implemented.")}},acceptedValues:["string","number"]}),this.defineProperty("min",{setter:function(e){return n.domElement.setAttribute("min",e.toString())}}),this.defineProperty("max",{setter:function(e){return n.domElement.setAttribute("max",e.toString())}}),this.defineProperty("step",{setter:function(e){return n.domElement.setAttribute("step",e.toString())}}),this.defineProperty("readonly",{setter:function(e){n.domElement.readOnly=!!e}}),this.defineProperty("placeholder",{getter:function(){return n.domElement.placeholder},setter:function(e){n.domElement.placeholder=e||""}})},t);function t(e){s.call(this,e)}i.TextBox=e}(xp=xp||{}),function(e){var t,n=(t=e.TextBox,__extends(o,t),o.prototype.getTemplate=function(){return e.Dom.create('<textarea class="TextArea TextBox" spellcheck="false"></textarea>')},o);function o(){t.apply(this,arguments)}e.TextArea=n}(xp=xp||{}),function(i){var s,e=(s=i.Element,__extends(t,s),t.prototype.getTemplate=function(){return document.createElement("div")},t.prototype.applyMarkup=function(e){var t,n={};for(t in e)n[t]=e[t];if(n.html&&n.url||!n.html&&!n.url)throw new Error('One property, "html" or "url", must be specified.');n.html&&(this.html=n.html,delete n.html),n.url&&(this.url=n.url,delete n.url),s.prototype.applyMarkup.call(this,n)},t.prototype.defineProperties=function(){var n=this;s.prototype.defineProperties.call(this);var o=!1,t=!1,r=!1;this.defineProperty("html",{getter:function(){return n.domElement.outerHTML},setter:function(e){if(!r&&t)throw new Error("Unable to set HTML twice.");e=i.Dom.create(e);if(1!==e.nodeType)throw new Error("Html control must have one root element.");n.domElement.parentNode&&n.domElement.parentNode.replaceChild(e,n.domElement),n.domElement=e,t=!0,n.initEvents()}}),this.defineProperty("url",{setter:function(e){if(o)throw new Error("Unable to set URL twice.");var t=new XMLHttpRequest;t.open("get",e),t.onreadystatechange=function(){4===t.readyState&&(r=o=!0,n.html=t.responseText,r=!1)},t.send(null)}})},t);function t(e){s.call(this,e)}i.Html=e}(xp=xp||{}),function(o){var r,e=(r=o.Element,__extends(i,r),i.prototype.initElement=function(){this.children=[],r.prototype.initElement.call(this)},i.prototype.getContainerElement=function(){return this.domElement},i.prototype.__setRenderedState__=function(t){this.__isRendered__=t,this.children&&this.children.forEach(function(e){e.__setRenderedState__(t)}),t&&this.onRendered&&this.onRendered.invoke(this)},i.prototype.defineProperties=function(){var t=this;r.prototype.defineProperties.call(this),this.defineProperty("padding",{setter:function(e){return t.domElement.style.padding=e},getter:function(){return t.domElement.style.padding}})},i.prototype.append=function(e){this.insert(e,this.children.length)},i.prototype.prepend=function(e){this.insert(e,0)},i.prototype.insert=function(e,t){if(e.parent!==this||this.children.indexOf(e)!=t){if(t>this.children.length)throw new Error("Index was out or range.");var n,o,r=this.getContainerElement();e.parent===this?((o=(n=this.children.indexOf(e))<t?t+1:t)===this.children.length?r.appendChild(e.domElement):r.insertBefore(e.domElement,r.children.item(o)),this.children.move(n,t)):(e.parent&&e.parent.detachChild(e),t===this.children.length?r.appendChild(e.domElement):r.insertBefore(e.domElement,r.children.item(t)),this.children.splice(t,0,e),e.__setParent__(this))}},i.prototype.detachChild=function(e){var t=this.children.indexOf(e);if(t<0)throw new Error("Element is not a child of this container.");this.children.splice(t,1),e.__setParent__(null),o.Dom.remove(e.domElement)},i.prototype.cascadeBy=function(e,t){if(void 0===t&&(t=!1),t&&!0==!!e(this))return this;for(var n=0;n<this.children.length;n++){if(!0==!!e(this.children[n]))return this.children[n];if(this.children[n]instanceof i){var o=this.children[n].cascadeBy(e,!1);if(null!=o)return o}}return null},i.prototype.find=function(t){return this.cascadeBy(function(e){return t(e)})},i.prototype.findAll=function(t){var n=[];return this.cascadeBy(function(e){t(e)&&n.push(e)}),n},i.prototype.remove=function(){this.removeChildren(),r.prototype.remove.call(this)},i.prototype.removeChildren=function(){for(var e=this.children.length-1;0<=e;e--)this.children[e].remove();this.children=[]},i);function i(e,t){var n=this;r.call(this,e),t&&t.forEach(function(e){return n.append(e)}),this.cascadeBy(function(e){if(e!==n&&e.name){if(e.name in n)throw new Error(o.formatString('Unable to set named child "{0}". Container\'s property is already defined.',e.name));n[e.name]=e}})}o.Container=e}(xp=xp||{}),function(e){var n,t=(n=e.Container,__extends(o,n),o.prototype.setDefaults=function(){n.prototype.setDefaults.call(this),this.itemsIndent="none",this.scrollBar="both",this.wrapping="nowrap"},o.prototype.defineProperties=function(){var t=this;n.prototype.defineProperties.call(this),this.defineProperty("itemsIndent",{setter:function(e){switch(t.domElement.classList.remove("itemsIndent-05"),t.domElement.classList.remove("itemsIndent-1"),t.domElement.classList.remove("itemsIndent-2"),t.domElement.classList.remove("itemsIndent-4"),e){case"none":break;case"0.5em":t.domElement.classList.add("itemsIndent-05");break;case"1em":t.domElement.classList.add("itemsIndent-1");break;case"2em":t.domElement.classList.add("itemsIndent-2");break;case"4em":t.domElement.classList.add("itemsIndent-4");break;default:throw new Error("Unknown items indent value: "+e)}},acceptedValues:["none","0.5em","1em","2em","4em"]}),this.defineProperty("scrollBar",{setter:function(e){switch(t.domElement.classList.remove("scrollBar-None"),t.domElement.classList.remove("scrollBar-Horizontal"),t.domElement.classList.remove("scrollBar-Vertical"),t.domElement.classList.remove("scrollBar-Both"),e){case"none":t.domElement.classList.add("scrollBar-None");break;case"horizontal":t.domElement.classList.add("scrollBar-Horizontal");break;case"vertical":t.domElement.classList.add("scrollBar-Vertical");break;case"both":t.domElement.classList.add("scrollBar-Both");break;default:throw new Error("Unknown scroll bar value: "+e)}},acceptedValues:["none","horizontal","vertical","both"]}),this.defineProperty("wrapping",{setter:function(e){switch(t.domElement.classList.remove("wrapping-NoWrap"),t.domElement.classList.remove("wrapping-Wrap"),e){case"nowrap":t.domElement.classList.add("wrapping-NoWrap");break;case"wrap":t.domElement.classList.add("wrapping-Wrap");break;default:throw new Error("Unknown wrapping value: "+e)}},acceptedValues:["nowrap","wrap"]})},o);function o(){n.apply(this,arguments)}e.Stack=t}(xp=xp||{}),function(e){var n,t=(n=e.Stack,__extends(o,n),o.prototype.getTemplate=function(){return e.Dom.create('<div class="HBox"></div>')},o.prototype.setDefaults=function(){n.prototype.setDefaults.call(this),this.contentAlign="left",this.itemsAlign="stretch"},o.prototype.defineProperties=function(){var t=this;n.prototype.defineProperties.call(this),this.defineProperty("contentAlign",{setter:function(e){switch(t.domElement.classList.remove("contentAlign-Left"),t.domElement.classList.remove("contentAlign-Center"),t.domElement.classList.remove("contentAlign-Right"),e){case"left":t.domElement.classList.add("contentAlign-Left");break;case"center":t.domElement.classList.add("contentAlign-Center");break;case"right":t.domElement.classList.add("contentAlign-Right");break;default:throw new Error("Unknown content alignment value: "+e)}},acceptedValues:["left","center","right"]}),this.defineProperty("itemsAlign",{setter:function(e){switch(t.domElement.classList.remove("itemsAlign-Top"),t.domElement.classList.remove("itemsAlign-Middle"),t.domElement.classList.remove("itemsAlign-Bottom"),t.domElement.classList.remove("itemsAlign-Stretch"),e){case"top":t.domElement.classList.add("itemsAlign-Top");break;case"middle":t.domElement.classList.add("itemsAlign-Middle");break;case"bottom":t.domElement.classList.add("itemsAlign-Bottom");break;case"stretch":t.domElement.classList.add("itemsAlign-Stretch");break;default:throw new Error("Unknown items alignment value: "+e)}},acceptedValues:["top","middle","bottom","stretch"]})},o);function o(e,t){n.call(this,e,t)}e.HBox=t}(xp=xp||{}),function(e){var n,t=(n=e.Stack,__extends(o,n),o.prototype.getTemplate=function(){return e.Dom.create('<div class="VBox"></div>')},o.prototype.setDefaults=function(){n.prototype.setDefaults.call(this),this.contentAlign="top",this.itemsAlign="stretch"},o.prototype.defineProperties=function(){var t=this;n.prototype.defineProperties.call(this),this.defineProperty("contentAlign",{setter:function(e){switch(t.domElement.classList.remove("contentAlign-Top"),t.domElement.classList.remove("contentAlign-Middle"),t.domElement.classList.remove("contentAlign-Bottom"),e){case"top":t.domElement.classList.add("contentAlign-Top");break;case"middle":t.domElement.classList.add("contentAlign-Middle");break;case"bottom":t.domElement.classList.add("contentAlign-Bottom");break;default:throw new Error("Unknown content alignment value: "+e)}},acceptedValues:["top","middle","bottom"]}),this.defineProperty("itemsAlign",{setter:function(e){switch(t.domElement.classList.remove("itemsAlign-Left"),t.domElement.classList.remove("itemsAlign-Center"),t.domElement.classList.remove("itemsAlign-Right"),t.domElement.classList.remove("itemsAlign-Stretch"),e){case"left":t.domElement.classList.add("itemsAlign-Left");break;case"center":t.domElement.classList.add("itemsAlign-Center");break;case"right":t.domElement.classList.add("itemsAlign-Right");break;case"stretch":t.domElement.classList.add("itemsAlign-Stretch");break;default:throw new Error("Unknown items alignment value: "+e)}},acceptedValues:["left","center","right","stretch"]})},o);function o(e,t){n.call(this,e,t)}e.VBox=t}(xp=xp||{}),function(r){var t,e=(t=r.VBox,__extends(n,t),n.prototype.getTemplate=function(){return r.Dom.create('<div class="List VBox"></div>')},n.prototype.setDefaults=function(){t.prototype.setDefaults.call(this),this.itemId="item"},n.prototype.defineProperties=function(){var n=this;t.prototype.defineProperties.call(this),this.defineProperty("items",{setter:function(e){var t;n.removeReplacementHandlers(),n.removeChildren(),n.itemsRegistar.unsubscribeAll(),e&&n.itemCreator&&(e.forEach(function(e,t){n.addItem(t,e)}),r.isCollectionNotifier(e)&&n.itemsRegistar.subscribe(e.onCollectionChanged,function(t){switch(t.action){case r.CollectionChangeAction.Attach:case r.CollectionChangeAction.Create:n.addItem(t.newIndex,t.newItem);break;case r.CollectionChangeAction.Detach:case r.CollectionChangeAction.Delete:var e=n.itemReplacementHandlers.filter(function(e){return e.item===t.oldItem})[0];e.holder.onPropertyChanged.removeHandler(e.handler),n.itemReplacementHandlers.splice(n.itemReplacementHandlers.indexOf(e),1),n.children[t.oldIndex].remove();break;case r.CollectionChangeAction.Replace:n.itemReplacementToken||(n.children[t.newIndex].scope[n.itemId]=t.newItem);break;case r.CollectionChangeAction.Move:n.insert(n.children[t.oldIndex],t.newIndex);break;default:throw new Error("Not implemented.")}},n),r.isNotifier(e)&&(t=function(e){},n.itemsRegistar.subscribe(e.onPropertyChanged,t,n)))}}),this.defineProperty("itemCreator",{setter:function(){return n.items=n.items}})},n.prototype.initEvents=function(){t.prototype.initEvents.call(this),this.itemsRegistar=new r.EventRegistrar},n.prototype.addItem=function(e,t){var n=this.itemCreator(t);n.name=r.createUuid(),n.useParentScope=!1,this.insert(n,e),n.scope=this.createItemScopeFrom(t)},n.prototype.createItemScopeFrom=function(e){var n=this,t={};t[this.itemId]=e;var t=new r.Scope(r.observable(t),this.scope),o={item:e,handler:function(e){if(e===n.itemId){var t=n.items.indexOf(o.item);if(t<0)throw new Error("Item does not belong to List items.");n.itemReplacementToken=!0,n.items[t]=o.holder[e],n.itemReplacementToken=!1,o.item=o.holder[e]}},holder:t};return o.holder.onPropertyChanged.addHandler(o.handler,this),this.itemReplacementHandlers.push(o),t},n.prototype.remove=function(){this.removeReplacementHandlers(),t.prototype.remove.call(this)},n.prototype.removeReplacementHandlers=function(){this.itemReplacementHandlers&&(this.itemReplacementHandlers.forEach(function(e){e.holder.onPropertyChanged.removeHandler(e.handler)}),this.itemReplacementHandlers=[])},n);function n(e){t.call(this,e),this.itemReplacementToken=!1,this.itemReplacementHandlers=[]}r.List=e}(xp=xp||{}),function(t){var n,e=(n=t.VBox,__extends(o,n),o.prototype.getTemplate=function(){var e=document.body;return e.classList.add("Window"),e.classList.add("VBox"),this.__setRenderedState__(!0),e},o.prototype.initElement=function(){if(n.prototype.initElement.call(this),o.instance)throw new Error("There is already another Window.");o.instance=this},o.prototype.setDefaults=function(){n.prototype.setDefaults.call(this),this.title="XP Application"},o.prototype.defineProperties=function(){n.prototype.defineProperties.call(this),this.defineProperty("title",{getter:function(){return document.title},setter:function(e){return document.title=e},observable:!0})},o.prototype.showModal=function(e){if(this.tint||this.modal)throw new Error("Another modal is displayed.");this.tint=new t.ModalTint,this.tint.appendTo(this),(this.modal=e).appendTo(this.tint)},o.prototype.closeModal=function(){this.modal.remove(),this.tint.remove(),this.modal=null,this.tint=null},o.prototype.__showContextMenu__=function(e){var t=this;this.__contextMenu__&&this.__contextMenu__.close(),this.__contextMenu__=e,this.append(e),e.onClosed.addHandler(function(){return t.__contextMenu__=null})},o);function o(e,t){n.call(this,e,t)}t.Window=e}(xp=xp||{}),function(e){var n,t=(n=e.VBox,__extends(o,n),o.prototype.show=function(){e.Window.instance.showModal(this)},o.prototype.close=function(){this.onClose&&!this.onClose()||e.Window.instance.closeModal()},o.prototype.getTemplate=function(){return e.Dom.create('<div class="Modal VBox"></div>')},o);function o(e,t){n.call(this,e,t)}e.Modal=t;var r,t=(r=e.Container,__extends(i,r),i.prototype.getTemplate=function(){return e.Dom.create('<div class="ModalTint"></div>')},i);function i(){r.apply(this,arguments)}e.ModalTint=t}(xp=xp||{}),function(s){var a,e=(a=s.Modal,__extends(o,a),o.show=function(e,t,n){new o(e,t,n).show()},o);function o(e,t,n){var o=this;a.call(this,{padding:"1em 1.5em",width:"32em",margin:"-15% 0 0 0"}),void 0!==t&&new s.Label({text:t,style:"title",margin:"0 0 1rem 0"}).appendTo(this),void 0!==e&&new s.Label({margin:"0 0 2em 0",text:e,style:"message"}).appendTo(this),n=n||{OK:function(){}};var r,i=new s.HBox({contentAlign:"right"});for(r in n)!function(t){new s.Button({text:t,minWidth:"4em",init:function(e){return e.onClick.addHandler(function(){n[t](),o.close()})}}).appendTo(i)}(r);i.appendTo(this)}s.MessageBox=e}(xp=xp||{}),function(p){var n,e=(n=p.VBox,__extends(r,n),r.prototype.getTemplate=function(){return p.Dom.create('<div class="ContextMenu VBox"></div>')},r.prototype.createMenuItem=function(e){new t(e,this).appendTo(this)},r.prototype.close=function(e){this.onClosed.invoke(e||null),this.remove()},r.prototype.initEvents=function(){var e=this;n.prototype.initEvents.call(this),this.onClosed=new p.Event,this.onRemoved.addHandler(function(){return e.onClosed.removeAllHandlers()})},r.prototype.show=function(e,t){var n=this,o=function(e){window.removeEventListener("click",o),window.removeEventListener("mousedown",o),window.removeEventListener("touchstart",o),window.removeEventListener("keydown",r),n.close()},r=function(e){27===e.keyCode&&o(e)};setTimeout(function(){window.addEventListener("click",o),window.addEventListener("mousedown",o),window.addEventListener("touchstart",o),window.addEventListener("keydown",r)},0);var i=e instanceof window.Element?e:null;if(i){var s=t,a=i.getBoundingClientRect();if("vertical"===s)var l=a.left,c=a.bottom;else{if("horizontal"!==s)throw new Error("Unexpected direction.");l=a.right,c=a.top}}else l=e,c=t;this.domElement.style.left=l+"px",this.domElement.style.top=c+"px",p.Window.instance.__showContextMenu__(this);e=this.domElement.getBoundingClientRect(),t=document.documentElement.getBoundingClientRect();e.right>t.right&&(l-=i?"vertical"===s?e.width-a.width:e.width+a.width:e.width,this.domElement.style.left=l+"px"),e.bottom>t.bottom&&(c-=i?"vertical"===s?e.height+a.height:e.height-a.height:e.height,this.domElement.style.top=c+"px")},r.show=function(e,t,n,o){n=new r(n);return o&&n.onClosed.addHandler(o),n.show(e,t),n},r);function r(e){var t=this;n.call(this),e.forEach(function(e){return t.createMenuItem(e)})}p.ContextMenu=e;var o,t=(o=p.Element,__extends(i,o),i.prototype.initItemData=function(t){var n=this;t.icon&&("."===t.icon[0]?this.iconElement.classList.add(t.icon.slice(1)):this.iconElement.style.backgroundImage=p.formatString("url({0})",t.icon)),t.key&&(this.keyElement.textContent=t.key),t.disabled&&(this.enabled=!1),this.textElement.textContent=t.text,this.domElement.addEventListener("touchstart",function(e){return e.stopPropagation()}),this.domElement.addEventListener("click",function(e){return e.stopPropagation()}),this.onMouseDown.addHandler(function(e){e.domEvent.stopPropagation(),t.action(),n.menu.close(t)},this)},i.prototype.getTemplate=function(){var t=this;return p.Dom.create('\n                <span class="ContextMenuItem" role="button">\n                    <span class="wrapper">\n                        <span class="icon"></span>\n                        <span class="text"></span>\n                        <span class="key"></span>\n                    </span>\n                </button>',{".icon":function(e){return t.iconElement=e},".text":function(e){return t.textElement=e},".key":function(e){return t.keyElement=e}})},i);function i(e,t){o.call(this),this.menu=t,this.initItemData(e)}}(xp=xp||{}),function(n){var e;(e=n.Tests||(n.Tests={})).assert=function(e){var t=typeof e;if("boolean"!=t)throw new Error("Assert statement must be boolean but not "+t+".");if(!0!==e)throw new Error(n.formatString("Statement is wrong."))},e.assertEqual=function(e,t){if(e!==t)throw new Error(n.formatString('"{0}" is not equal to "{1}".',e,t))}}(xp=xp||{}),function(e){!function(o){function r(e){var t,n=Math.max(e.r,e.g,e.b),o=Math.min(e.r,e.g,e.b);if(n===o)t=0;else if(n===e.r&&e.g>=e.b)t=60*(e.g-e.b)/(n-o);else if(n===e.r&&e.g<e.b)t=60*(e.g-e.b)/(n-o)+360;else if(n===e.g)t=60*(e.b-e.r)/(n-o)+120;else{if(n!==e.b)throw new Error("Unable to convert color: red = "+e.r+", green = "+e.g+", blue = "+e.b+".");t=60*(e.r-e.g)/(n-o)+240}return{h:t,s:0===n?0:1-o/n,b:n/255}}function i(e){var t,n;if(t=e.match(o.regexps.rgb))n={r:parseInt(t[1],10),g:parseInt(t[2],10),b:parseInt(t[3],10),a:1};else if(t=e.match(o.regexps.rgba))n={r:parseInt(t[1],10),g:parseInt(t[2],10),b:parseInt(t[3],10),a:parseFloat(t[4])};else if(t=e.match(o.regexps.hexShort))n={r:parseInt(t[1]+t[1],16),g:parseInt(t[2]+t[2],16),b:parseInt(t[3]+t[3],16),a:1};else{if(!(t=e.match(o.regexps.hex)||a[e]&&a[e].match(o.regexps.hex)))throw new Error('Color "'+e+'" is not valid.');n={r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16),a:1}}if(n.r<0||255<n.r||n.g<0||255<n.g||n.b<0||255<n.b||n.a<0||1<n.a)throw new Error('Color "'+e+'" is not valid.');return n}function s(e){e=e.a+e.r+e.g+e.b;return 0<=e&&e<=1020}function t(e,t){var n=e.toString(16);if(t&&n.length<t)for(var o=0;o<t-n.length;o++)n="0"+n;return n}o.hsbToRgb=function(e){if(e.h<0||360<e.h||e.s<0||1<e.s||e.b<0||1<e.b)throw new Error("Unable to convert color: hue = "+e.h+", saturation = "+e.s+", brightness = "+e.b+".");e.h<60?r={r:255,g:Math.round(e.h/60*255),b:0}:e.h<120?r={r:Math.round((120-e.h)/60*255),g:255,b:0}:e.h<180?r={r:0,g:255,b:Math.round((e.h-120)/60*255)}:e.h<240?r={r:0,g:Math.round((240-e.h)/60*255),b:255}:e.h<300?r={r:Math.round((e.h-240)/60*255),g:0,b:255}:e.h<=360&&(r={r:255,g:0,b:Math.round((360-e.h)/60*255)});var t=Math.max(r.r,r.g,r.b),n=r.r+(t-r.r)*(1-e.s),o=r.g+(t-r.g)*(1-e.s),r=r.b+(t-r.b)*(1-e.s),e={r:n*e.b,g:o*e.b,b:r*e.b};return{r:Math.round(e.r),g:Math.round(e.g),b:Math.round(e.b)}},o.rgbToHsb=r,o.rgbaToHsla=function(e){var t=r(e),n=(2-t.s)*t.b/2,o=t.s*t.b/(n<.5?2*n:2-2*n);return isNaN(o)&&(o=0),{h:t.h,s:o,l:n,a:e.a}},o.regexps={rgb:/^\s*rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)\s*$/,rgba:/^\s*rgba\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d?\.?\d)\s*\)\s*$/,hexShort:/^\s*#([\dA-Fa-f])([\dA-Fa-f])([\dA-Fa-f])\s*$/,hex:/^\s*#([\dA-Fa-f]{2})([\dA-Fa-f]{2})([\dA-Fa-f]{2})\s*$/},o.parse=i,o.areEqual=function(e,t){var n,o;if("string"==typeof e)n=i(e);else{if(!s(e))throw new Error("Invalid color.");n=e}if("string"==typeof t)o=i(t);else{if(!s(t))throw new Error("Invalid color.");o=t}return n.r===o.r&&n.g===o.g&&n.b===o.b&&n.a===o.a},o.rgbToCmyk=function(e){var t={},n=e.r/255,o=e.g/255,e=e.b/255;return t.k=Math.min(1-n,1-o,1-e),t.c=(1-n-t.k)/(1-t.k),t.m=(1-o-t.k)/(1-t.k),t.y=(1-e-t.k)/(1-t.k),t.c=Math.round(100*t.c),t.m=Math.round(100*t.m),t.y=Math.round(100*t.y),t.k=Math.round(100*t.k),t},o.rgbToString=function(e){return xp.formatString("rgb({0},{1},{2})",e.r,e.g,e.b)},o.rgbaToString=function(e){return xp.formatString("rgba({0},{1},{2},{3})",e.r,e.g,e.b,e.a)},o.hslToString=function(e){return xp.formatString("hsl({0},{1}%,{2}%)",e.h,100*e.s,100*e.l)},o.hslaToString=function(e){return xp.formatString("hsla({0},{1}%,{2}%,{3})",e.h,100*e.s,100*e.l,e.a)},o.rgbToHexString=function(e){return("#"+t(e.r,2)+t(e.g,2)+t(e.b,2)).toUpperCase()};var a={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32",darkgrey:"#a9a9a9",darkslategrey:"#2f4f4f",dimgrey:"#696969",grey:"#808080",lightgray:"#d3d‌​3d3",lightslategrey:"#778899",slategrey:"#708090"}}(e.Color||(e.Color={}))}(Inker=Inker||{}),function(e){var a;function i(e,t){for(var n in t)e.setAttribute(n,String(t[n]))}(a=e.Svg||(e.Svg={})).SvgNS="http://www.w3.org/2000/svg",a.XlinkNS="http://www.w3.org/1999/xlink",a.create=function(e,t,n){var o,r=document.createElementNS(a.SvgNS,e);for(o in t)r.setAttribute(o,t[o]);return"svg"===e&&i(r,{xmlns:a.SvgNS}),n&&n.forEach(function(e){return r.appendChild(e)}),r},a.setAttributes=i,a.setAttribute=function(e,t,n){e.setAttribute(t,String(n))},a.getNumber=function(e,t){return parseFloat(e.getAttribute(t))},a.insertChild=function(e,t,n){if(t.parentNode===e){var o=Array.prototype.indexOf.call(e.childNodes,t);if(o===n)return;o<n&&n++}n=e.childNodes.item(n),e.insertBefore(t,n)},a.getChild=function(e,t){var n=e.firstElementChild;if(!n)return null;if(0===t)return n;for(var o=0;n=n.nextElementSibling;)if(++o===t)return n;return null},a.remove=function(e){e.parentNode&&e.parentNode.removeChild(e)},a.parseTransform=function(r){var i=[];function e(e,t){var n,o=r.indexOf(e+"(");0<=o&&(o+=e.length+1,n=r.indexOf(")",o),e={command:e},t(r.substring(o,n).split(" ").map(parseFloat),e),i.push([e,o]))}return r=r.replace(","," ").replace(/\s+/g," "),e("translate",function(e,t){t.x=e[0],t.y=e[1]||0}),e("rotate",function(e,t){t.r=Geo.rad(e[0])}),e("scale",function(e,t){t.x=e[0],t.y=e[1]||0}),i.sort(function(e,t){return e[1]-t[1]}).map(function(e){return e[0]})},a.getClosestPointOnSvgPath=function(e,n){function t(e){var t=e.x-n.x,e=e.y-n.y;return t*t+e*e}for(var o,r,i,s,a,l,c,p,h,d=e.getTotalLength(),u=d/e.pathSegList.numberOfItems*.125,f=1/0,m=0;m<=d;m+=u)(s=t(i=e.getPointAtLength(m)))<f&&(o=i,r=m,f=s);for(u*=.5;.5<u;)0<=(c=r-u)&&(p=t(a=e.getPointAtLength(c)))<f?(o=a,r=c,f=p):(c=r+u)<=d&&(h=t(l=e.getPointAtLength(c)))<f?(o=l,r=c,f=h):u*=.5;return{x:o.x,y:o.y}},(e=a.Dev||(a.Dev={})).drawPoints=function(e,t,n,o,r){void 0===n&&(n=!1),void 0===o&&(o="blue"),void 0===r&&(r=4);var i=e.map(function(e){e=a.create("circle",{cx:n?t.translateXOut(e.x):e.x,cy:n?t.translateXOut(e.y):e.y,r:2,fill:o});return t.levels.viewport.appendChild(e),e}),s=function(){i.forEach(function(e){return a.remove(e)}),window.removeEventListener("keydown",s)};window.addEventListener("keydown",s)},e.drawLine=function(e,n,o,t){void 0===o&&(o=!1),void 0===t&&(t="blue");var e=e.map(function(e,t){e=o?n.translatePtOut(e):e;return(0===t?"M":"L")+e.x+","+e.y}).join(" "),r=a.create("path",{d:e,stroke:t,fill:"none"});n.levels.viewport.appendChild(r);var i=function(){a.remove(r),window.removeEventListener("keydown",i)};window.addEventListener("keydown",i)},e.drawSvgArc=function(e,t,n,o){void 0===n&&(n=!1),void 0===o&&(o="blue");var e="M"+e[0]+","+e[1]+" "+e[2]+" "+e[3]+" "+e[4]+" "+e[5]+","+e[6],r=a.create("path",{d:e,stroke:o,fill:"none"});t.levels.viewport.appendChild(r);var i=function(){a.remove(r),window.removeEventListener("keydown",i)};window.addEventListener("keydown",i)}}(Inker=Inker||{}),function(i){function s(e,t){var n=t.x-e.x,e=t.y-e.y;return o(Math.atan2(e,n))}function o(e){for(;e>=2*Math.PI;)e-=2*Math.PI;for(;e<0;)e+=2*Math.PI;return e}function r(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<=-Math.PI;)e+=2*Math.PI;return e}function a(e,t,n){return{x:e.x+t*Math.cos(n),y:e.y+t*Math.sin(n)}}function l(e,t,n,o,r){var i=e.x===t.x,s=n.x===o.x;if(i&&s)return null;if(i)var a,l=(o.y-n.y)/(o.x-n.x),c=o.y-o.x*l,p=l*(a=e.x)+c;else if(s){var h=(t.y-e.y)/(t.x-e.x),d=t.y-t.x*h;p=h*(a=n.x)+d}else{if((h=(t.y-e.y)/(t.x-e.x))===(l=(o.y-n.y)/(o.x-n.x)))return null;d=t.y-t.x*h;a=((c=o.y-o.x*l)-d)/(h-l),p=Math.abs(d)<Math.abs(c)?h*a+d:l*a+c}return r||a>=Math.min(e.x,t.x)&&a<=Math.max(e.x,t.x)&&(0===h||p>=Math.min(e.y,t.y)&&p<=Math.max(e.y,t.y))&&a>=Math.min(n.x,o.x)&&a<=Math.max(n.x,o.x)&&(0===l||p>=Math.min(n.y,o.y)&&p<=Math.max(n.y,o.y))?{x:a,y:p}:null}function c(e,t,n,o){var r=s(t,n),r=l(t,n,e,i.placePoint(e,1,r+Math.PI/2),!0);return o||r.x>=Math.min(t.x,t.x)&&r.x<=Math.max(n.x,n.x)&&(t.y===n.y||r.y>=Math.min(t.y,n.y)&&r.y<=Math.max(t.y,n.y))?r:i.getLength(e,t)<i.getLength(e,n)?t:n}i.pt=function(e,t){return{x:e,y:t}},i.getLength=function(e,t){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))},i.getMidPoint=function(e,t,n){return void 0===n&&(n=.5),{x:e.x+(t.x-e.x)*n,y:e.y+(t.y-e.y)*n}},i.getAngle=s,i.rad=function(e){return e*Math.PI/180},i.deg=function(e){return e/Math.PI*180},i.ca=o,i.ca2=r,i.getMidAngle=function(e,t,n){void 0===n&&(n=.5);var o={x:0,y:0},e=a(o,1-n,e);return s(o,a(e,n,t))},i.getQ=function(e,t){return t<e&&(t+=2*Math.PI),Math.abs(r(t-e))},i.getQPt=function(e,t,n,o){return t=s(e,t),(o=s(n,o))<t&&(o+=2*Math.PI),Math.abs(r(o-t))},i.getQS=function(e,t){return t<e&&(t+=2*Math.PI),r(t-e)},i.getQSPt=function(e,t,n,o){return t=s(e,t),(o=s(n,o))<t&&(o+=2*Math.PI),r(o-t)},i.placePoint=a,i.getLinesIntersection=l,i.getDistanceToLine=function(e,t,n,o){return o=c(e,t,n,o),i.getLength(o,e)},i.getClosestPointAtLine=c}(Geo=Geo||{}),function(m){!function(e){function p(e,t,n,o,r){return t*(1-e)*(1-e)*(1-e)+3*n*(1-e)*(1-e)*e+3*o*(1-e)*e*e+r*e*e*e}function n(e,t){if(e<0||1<e)throw new Error("Out of range.");for(var n=0,o=t.length-1,r=0;r<=o;r++)n+=t[r]*Math.pow(1-e,o-r)*Math.pow(e,r)*i(o)/i(r)/i(o-r);return Math.round(1e6*n)/1e6}function c(e,t){return{x:n(e,t.map(function(e){return e.x})),y:n(e,t.map(function(e){return e.y}))}}e.bezier1=function(e,t,n){return t*(1-e)+n*e},e.bezier2=function(e,t,n,o){return t*(1-e)*(1-e)+2*n*(1-e)*e+o*e*e},e.bezier3=p,e.bezier3Pt=function(e,t){return{x:p(e,t[0].x,t[1].x,t[2].x,t[3].x),y:p(e,t[0].y,t[1].y,t[2].y,t[3].y)}},e.bezier=n,e.bezierPt=c;var t=[];function i(e){return 0===e||1===e?1:isNaN(t[e])?t[e]=i(e-1)*e:t[e]}function h(e){for(var t=0,n=1;n<e.length;n++)t+=m.getLength(e[n-1],e[n]);return(t+=m.getLength(e[0],e[e.length-1]))/2}function d(e,t){void 0===t&&(t=.5);var n=e,o=[m.getMidPoint(n[0],n[1],t),m.getMidPoint(n[1],n[2],t),m.getMidPoint(n[2],n[3],t)],e=[m.getMidPoint(o[0],o[1],t),m.getMidPoint(o[1],o[2],t)],t=m.getMidPoint(e[0],e[1],t);return{seg1:[n[0],o[0],e[0],t],seg2:[t,e[1],o[2],n[3]]}}function u(e,t){e.length,e.length,t.length,t.length;for(var n=0;n<e.length;n++)for(var o=e[n],r=n===e.length-1?e[0]:e[n+1],i=0;i<t.length;i++){var s=t[i],a=i===t.length-1?t[0]:t[i+1];if(m.getLinesIntersection(o,r,s,a))return!0}return!1}function f(e){return!!e&&!isNaN(e.x)&&!isNaN(e.y)}e.minBezier3=function(e,t,n,o){var r=Math.min(e,o);if(3*t-e-3*n+o==0){if(e-2*t+n==0)return r;var i=(e-t)/(2*e-4*t+2*n);if(0<=i&&i<=1)return 0<-6*e*i+6*e+18*t*i-12*t-18*n*i+6*n+6*o*i&&(s=p(i,e,t,n,o))<r?s:r}else{var s,a=(-Math.sqrt(-e*n+e*o+t*t-t*n-t*o+n*n)-e+2*t-n)/(3*t-e-3*n+o),l=(Math.sqrt(-e*n+e*o+t*t-t*n-t*o+n*n)-e+2*t-n)/(3*t-e-3*n+o),c=null,i=null;if(0<=a&&a<=1&&0<-6*e*a+6*e+18*t*a-12*t-18*n*a+6*n+6*o*a&&(s=p(a,e,t,n,o))<r&&(c=s),0<=l&&l<=1&&0<-6*e*l+6*e+18*t*l-12*t-18*n*l+6*n+6*o*l&&(s=p(l,e,t,n,o))<r&&(i=s),c&&i)return Math.min(c,i);if(c)return c;if(i)return i}return r},e.maxBezier3=function(e,t,n,o){var r=Math.max(e,o);if(3*t-e-3*n+o==0){if(e-2*t+n==0)return r;var i=(e-t)/(2*e-4*t+2*n);if(0<=i&&i<=1)return-6*e*i+6*e+18*t*i-12*t-18*n*i+6*n+6*o*i<0&&r<(s=p(i,e,t,n,o))?s:r}else{var s,a=(-Math.sqrt(-e*n+e*o+t*t-t*n-t*o+n*n)-e+2*t-n)/(3*t-e-3*n+o),l=(Math.sqrt(-e*n+e*o+t*t-t*n-t*o+n*n)-e+2*t-n)/(3*t-e-3*n+o),c=null,i=null;if(0<=a&&a<=1&&-6*e*a+6*e+18*t*a-12*t-18*n*a+6*n+6*o*a<0&&r<(s=p(a,e,t,n,o))&&(c=s),0<=l&&l<=1&&-6*e*l+6*e+18*t*l-12*t-18*n*l+6*n+6*o*l<0&&r<(s=p(l,e,t,n,o))&&(i=s),c&&i)return Math.max(c,i);if(c)return c;if(i)return i}return r},e.getBezier3Intersections=function(e,t,l){void 0===l&&(l=.001),e.forEach(f),t.forEach(f);var c=[],p=function(e,t,n,o,r,i){var s,a;u(e,t)&&((s=h(e)+h(t))<=(i=i||s*l)?(s={pt:a={x:(e.map(function(e){return e.x}).reduce(function(e,t){return e+t})+t.map(function(e){return e.x}).reduce(function(e,t){return e+t}))/8,y:(e.map(function(e){return e.y}).reduce(function(e,t){return e+t})+t.map(function(e){return e.y}).reduce(function(e,t){return e+t}))/8},a:m.getAngle(e[0],e[3]),t:n},a={pt:a,a:m.getAngle(t[0],t[3]),t:o},c.push({int1:s,int2:a})):(e=d(e),t=d(t),r/=2,p(e.seg1,t.seg1,n-r,o-r,r,i),p(e.seg1,t.seg2,n-r,o+r,r,i),p(e.seg2,t.seg1,n+r,o-r,r,i),p(e.seg2,t.seg2,n+r,o+r,r,i)))};function n(e){e.pt.x=Math.round(e.pt.x/l)*l,e.pt.y=Math.round(e.pt.y/l)*l,e.a=Math.round(180*e.a/Math.PI/l)*l*Math.PI/180}return p(e,t,.5,.5,.5),c.forEach(function(e){n(e.int1),n(e.int2)}),c},e.getBezier3LineIntersections=function(e,t,a){void 0===a&&(a=.001),e.forEach(f),t.forEach(f),h(e);var l=[],c=function(e,t,n,o,r){var i,s;e.forEach(f),t.forEach(f),u(e,t)&&((i=h(e))<=(r=r||i*a)?(s={pt:{x:(s=m.getDistanceToLine(e[0],t[0],t[1]))<(i=m.getDistanceToLine(e[3],t[0],t[1]))?e[0].x:i<s?e[3].x:(e[0].x+e[3].x)/2,y:s<i?e[0].y:i<s?e[3].y:(e[0].y+e[3].y)/2},a:m.getAngle(e[0],e[1]),t:n},l.push(s)):(e=d(e),o/=2,c(e.seg1,t,n-o,o,r),c(e.seg2,t,n+o,o,r)))};return c(e,t,.5,.5),l},e.getSegmentLength=h,e.splitBezier3Segment=d,e.arePolygonsIntersected=u,e.getPointAtLength=function(e,t){for(var n,o=0,r=t[0],i=0;i<=100&&(n=c(i/100,t),!(e<=(o+=m.getLength(n,r))));i++)r=n;return n},e.getClosestPoint=function(e,t,n){void 0===n&&(n=.001);for(var o,r,i=1/n,s=1/0,a=null,l=0;l<=i;l++)r=c(l/i,t),(o=m.getLength(r,e))<s&&(s=o,a=r);return a}}(m.Bezier||(m.Bezier={}))}(Geo=Geo||{});var Inker,__extends=this&&this.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function o(){this.constructor=e}e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)};!function(a){var t,e=(t=xp.Model,__extends(n,t),n.prototype.addStartupTask=function(e){this.startupTasks.push(e)},n.prototype.start=function(){function t(){++n===e.startupTasks.length&&(console.info("App ready"),e.window=new a.Window(e),e.initTools(),e.file.start(),e.onStarted.invoke(!0))}var e=this,n=0;this.startupTasks.forEach(function(e){e(t)})},n.prototype.close=function(){var t=this;this.isClosing=!0;var n=this.documents.length-1,o=function(){var e=t.documents[n];e?(t.document=e,t.file.close(e,function(){setTimeout(function(){n--,o()})})):t.environment.exit()};o()},n.prototype.initControllers=function(){var e=this;this.clipboard=new a.ClipboardController(this),this.feature=new a.FeatureController(this),this.file=new a.FileController(this),this.font=new a.FontController(this),this.key=new a.KeyController(this),this.memento=new a.MementoController(this),this.message=new a.MessageController(this),this.settings=new a.SettingsController(this),this.onStarted.addHandler(function(){return e.feature.applyFeatures()})},n.prototype.setDefaultTool=function(){this.currentTool=this.getTool(a.Tools.DrawTool)},Object.defineProperty(n.prototype,"currentTool",{get:function(){return this._currentTool},set:function(n){var e,t,o,r,i,s=this;this._currentTool&&(this._currentTool.disable(),this.window.canvas.removeLastCursor(),t=this._currentTool.toolPanel.domElement.getBoundingClientRect(),this._currentTool.toolPanel.isActive=!1),(this._currentTool=n)&&(n.enable(),this.window.canvas.setCursor(n.getCursor()),n.toolPanel.isActive=!0,this.window.toolSelector.handleLayout(),!t||(e=n.toolPanel.domElement.getBoundingClientRect().height-t.height)&&(t=this.window.canvas.viewport,this.window.canvas.viewport={zoom:t.zoom,x:t.x,y:t.y-e}),this.toolTip&&(this.toolTip.remove(),this.toolTip=null),o=function(){var e=r.domElement.getBoundingClientRect(),t=s.window.canvas.domElement.getBoundingClientRect();return{title:"How to use "+n.getName()+" tool?",content:n.getHelpMessage(),location:{x:0,y:e.top+e.height/2-t.top},bounds:t}},this.settings.help.displayTips&&n.getHelpMessage()&&(r=this.toolButtons.get(n),this.toolTip=new a.UI.ToolTip(this,o()),i=function(){s.toolTip.refresh(o())},window.addEventListener("resize",i),this.toolTip.onRemoved.addHandler(function(){window.removeEventListener("resize",i)}))),this.onPropertyChanged.invoke("currentTool")},enumerable:!0,configurable:!0}),n.prototype.initTools=function(){this.tools=[],this.initTool(a.Tools.BrowseTool),this.initTool(a.Tools.SelectTool),this.initTool(a.Tools.PathTool),this.initTool(a.Tools.DrawTool),this.initTool(a.Tools.ShapeTool),this.initTool(a.Tools.TextTool),this.initTool(a.Tools.RulerTool),this.window.toolSelector.handleLayout()},n.prototype.initTool=function(e){var t=this,n=new e(this,this.window.canvas),e=new xp.ToggleButton({icon:n.getIcon(),text:n.getName(),style:"toolToggle",item:n,selectedItem:"{currentTool}"});this.window.toolSelector.addToolButton(e),this.toolButtons.set(n,e),n.toolPanel.isActive=!1,this.window.toolPanelContainer.append(n.toolPanel),this.tools.push(n),new xp.BindingCallManager(this,"settings.markers.size",function(e){isNaN(e)&&(e=12),a.Tools.Markers.MarkerStyle.size=(e-.5)*devicePixelRatio,t.currentTool&&t.currentTool.refreshMarkers()})},n.prototype.getTool=function(t){return this.tools.filter(function(e){return e instanceof t})[0]},n.prototype.saveDate=function(){var t=this;this.environment.getItem("firstDate",function(e){e||t.environment.setItem("firstDate",Date.now().toString())})},n.prototype.getDate=function(t){this.environment.getItem("firstDate",function(e){t(+e)})},n.prototype.onTouchSupportDetected=function(){},n);function n(){var e=this;t.call(this),this.toolButtons=new xp.Dictionary,this.platform=new o,this.documents=new xp.ObservableCollection([]),xp.Model.property(this,"document"),xp.Model.property(this,"window"),this.onStarted=new xp.Event,this.startupTasks=[],this.platform.onTouchSupportDetected.addHandler(function(){return e.onTouchSupportDetected()}),this.environment=new(this.platform.isChromeApp?a.ChromeAppEnvironment:window.InkerEnvironment?a.WebViewEnvironment:a.WebEnvironment),this.environment.onBack(function(){e.memento.isUndoPossible&&e.memento.undo()}),this.initControllers(),this.saveDate()}a.Application=e;var o=function(){var e=this;window.chrome&&window.chrome.app&&window.chrome.app.runtime?(this.name="Google Chrome App",this.isSupported=!0,this.isChromeApp=!0,this.isChrome=!0):(window.chrome?(this.name="Google Chrome",this.isSupported=!0,this.isChrome=!0):(this.name="Unknown",this.isSupported=!1),this.isWeb=!0),this.isMobile=0<=navigator.userAgent.indexOf("iPhone")||0<=navigator.userAgent.indexOf("iPad")||0<=navigator.userAgent.indexOf("Android")||0<=navigator.userAgent.indexOf("Windows Phone")||0<=navigator.userAgent.indexOf("IEMobile")||0<=navigator.userAgent.indexOf("Mobile");var t=function(){window.removeEventListener("touchstart",t,!0),e.supportsTouch=!0,e.onTouchSupportDetected.invoke(!0)};this.onTouchSupportDetected=new xp.Event,window.addEventListener("touchstart",t,!0)}}(Inker=Inker||{}),function(e){function l(e){return e.match(/^(.*[\\\/])?([^\.]+)(\..*)?$/)[2]}function c(e){return e+".ink"}var t=(n.prototype.getItem=function(e,t){t(localStorage.getItem(e))},n.prototype.setItem=function(e,t,n){localStorage.setItem(e,t),n&&n()},n.prototype.getLocalItem=function(e,t){this.getItem("local:"+e,t)},n.prototype.setLocalItem=function(e,t,n){this.setItem("local:"+e,t,n)},n.prototype.openFile=function(e,t){var n=document.createElement("input");n.type="file",n.style.display="none",e.extensions&&0<e.extensions.length&&(n.accept=e.extensions.map(function(e){return"."+e}).join(","));var o=new FileReader;o.onerror=function(e){return t(e.error,null,null)},o.onloadend=function(){var e=n.value.replace(/(^.*?[\\|\/]{0,1})([^\\\/]+?)($)/,"$2");t(null,o.result,e)},n.onchange=function(){n.files[0]&&(e.isBlob?o.readAsDataURL(n.files[0]):o.readAsText(n.files[0]),document.body.removeChild(n))},document.body.appendChild(n),n.click()},n.prototype.saveFile=function(t,e,n,o){var r,i=document.createElement("a");i.style.display="none",window.navigator.msSaveOrOpenBlob?(i.click=function(){window.navigator.msSaveOrOpenBlob(e,t)},document.body.appendChild(i),i.click(),o(null,t),document.body.removeChild(i)):((r=new FileReader).onload=function(){var e=r.result;i.setAttribute("download",t),i.setAttribute("href",e),document.body.appendChild(i),i.click(),o(null,t),document.body.removeChild(i)},r.readAsDataURL(e))},n.prototype.openDocument=function(o,e,r){o?r(new Error("Web version does not support opening documents directly."),null,null,null):this.openFile(e,function(e,t,n){e&&r(e,null,null,null),r(null,t,l(n),o||xp.createUuid())})},n.prototype.saveDocument=function(n,e,t,o,r){this.saveFile(c(e),t,o,function(e,t){e?r(e,null,null):r(e,l(t),n)})},n.prototype.getRecentDocuments=function(e){e([])},n.prototype.onOpenDocument=function(e){},n.prototype.getFeature=function(n,o){var r=this;this.getItem("features",function(e){e=e||"[]";var t=JSON.parse(e);new s(function(e,t){return 0<e.indexOf("@")&&e.indexOf("@")<e.length-1&&t.toLocaleLowerCase().trim()===i("dmllbmNrdGVvcnI=")},function(e){e&&t.indexOf(n)<0&&t.push(n),r.setItem("features",JSON.stringify(t)),o(null,t)}).show()})},n.prototype.queryFeatures=function(t){this.getItem("features",function(e){e=e||"[]";e=JSON.parse(e);t(null,e)})},n.prototype.exit=function(){window.close()},n.prototype.onBack=function(e){},n);function n(){this.docPaths={}}function i(e){return window["a,b".split(",").join("to")](e)}e.WebEnvironment=t;var r,s=(r=xp.Modal,__extends(o,r),o.prototype.onCancel=function(){this.close(),this.callback(!1)},o.prototype.onValueEntered=function(){var e=this.eml.value,t=this.input.value;this.validator(e,t)?(this.close(),this.callback(!0)):(this.eml.value="",this.input.value="",this.eml.focus())},o);function o(e,t){var n=this;r.call(this,{style:i("Y29udGVudA=="),padding:"1em",itemsIndent:"0.5em"},[new xp.Html({html:i("PHAgY2xhc3M9ImNvZGVEZXNjcmlwdGlvbiI+QXQgdGhlIG1vbWVudCB1c2FnZSBvZiBhZHZhbmNlZCBmZWF0dXJlcyBpcyBhdmFpbGFibGUgZm9yIHVzZXJzIG9mIElua2VyIGZvciBBbmRyb2lkLiBJZiB5b3UgYWxyZWFkeSBwdXJjaGFzZWQgdGhlc2UgZmVhdHVyZXMgYXQgR29vZ2xlIFBsYXkgKCQxMCksIHJlcXVlc3QgdGhlIENvZGUgYXQgPGI+aW5rZXJhcHBAZ21haWwuY29tPC9iPiBieSBzZW5kaW5nIHB1cmNoYXNlIGRhdGUgYW5kIHRyYW5zYWN0aW9uIElELiBXZSB3aWxsIHNlbmQgeW91IHRoZSBDb2RlLCB3aGljaCB0byBzaG91bGQgZW50ZXIgYmVsb3cuPC9wPg=="),width:"24em"}),new xp.TextBox({placeholder:i("ZS1tYWls"),flex:"stretch",width:"24em",init:function(e){return n.eml=e}}),new xp.TextBox({placeholder:i("Y29kZS4uLg=="),flex:"stretch",width:"24em",init:function(e){return n.input=e}}),new xp.HBox({contentAlign:"right"},[new xp.Button({text:i("Q2FuY2Vs"),style:i("bGFyZ2VCdXR0b24="),onClick:function(e){return n.onCancel()}}),new xp.Button({text:i("T0s="),style:i("bGFyZ2VCdXR0b24="),onClick:function(e){return n.onValueEntered()}})])]),this.validator=e,this.callback=t,this.onRendered.addHandler(function(){n.eml.focus()});function o(e){13===e.keyCode&&(n.input.text?n.eml.text?n.onValueEntered():n.eml.focus():n.input.focus()),27===e.keyCode&&n.onCancel()}window.addEventListener("keypress",o),this.onRemoved.addHandler(function(){return window.removeEventListener("keypress",o)})}a.prototype.getItem=function(t,n){chrome.storage.sync.get(t,function(e){n(e[t])})},a.prototype.setItem=function(e,t,n){var o,o=((o={})[e]=t,o);chrome.storage.sync.set(o,function(){n&&n()})},a.prototype.getLocalItem=function(t,n){chrome.storage.local.get(t,function(e){n(e[t])})},a.prototype.setLocalItem=function(e,t,n){var o,o=((o={})[e]=t,o);chrome.storage.local.set(o,function(){n&&n()})},a.prototype.openFile=function(e,o){this.openFileDialog(e,function(e,t,n){e?o(e,null,null):o(e,t,n.name)})},a.prototype.openFileDialog=function(e,o){var t=this;chrome.fileSystem.chooseEntry({type:"openFile",accepts:[this.cutChromeFSAccepts(e)]},function(n){t.readFileEntry(n,e.isBlob,function(e,t){e?o(e,null,null):o(e,t,n)})})},a.prototype.saveFile=function(e,t,n,o){this.saveFileDialog(e,t,n,function(e,t){e?o(e,null):o(null,t.name)})},a.prototype.saveFileDialog=function(e,r,t,i){chrome.fileSystem.chooseEntry({type:"saveFile",suggestedName:e,accepts:[this.cutChromeFSAccepts(t)]},function(o){o.createWriter(function(t){var n=!(t.onerror=function(e){return i(e.error,null)});t.onwriteend=function(e){n||(t.truncate(t.position),n=!0,i(null,o))},t.write(r)},function(e){return i(e,null)})})},a.prototype.getRecentDocuments=function(t){this.getFileEntriesInfo(function(e){e=e.map(function(e){return{id:e.id,name:e.name,lastAccessDate:e.lastAccessDate}});t(e)})},a.prototype.openDocument=function(t,e,o){var r=this;t?this.getFileEntriesInfo(function(e){e=e.filter(function(e){return e.id===t})[0];chrome.fileSystem.restoreEntry(e.id,function(n){r.readFileEntry(n,!1,function(e,t){e?o(e,null,null,null):r.saveFileEntryInfo(n,function(e){o(null,t,l(n.name),e)})})})}):this.openFileDialog(e,function(e,t,n){e?o(e,null,null,null):r.saveFileEntryInfo(n,function(e){o(null,t,l(n.name),e)})})},a.prototype.saveDocument=function(t,o,r,i,s){var a=this;this.getFileEntriesInfo(function(e){var n=e.filter(function(e){return e.id===t})[0];n?chrome.fileSystem.restoreEntry(n.id,function(e){chrome.fileSystem.getWritableEntry(e,function(e){a.writeFileEntry(e,r,function(e,t){e?s(e,null,null):s(null,l(t.name),n.id)})})}):a.saveFileDialog(c(o),r,i,function(e,t){e?s(e,null,null):a.saveFileEntryInfo(t,function(e){s(null,l(t.name),e)})})})},a.prototype.onOpenDocument=function(o){function e(n){r.readFileEntry(n.entry,!1,function(e,t){e?o(e,null,null,null):r.saveFileEntryInfo(n.entry,function(e){o(null,t,l(n.entry.name),e)})})}var r=this,t=window.launchDataItems;t&&t.forEach(e),window.onLaunchDataItems=e},a.prototype.readFileEntry=function(e,n,o){e.file(function(e){var t=new FileReader;t.onerror=function(e){return o(e.error,null)},t.onloadend=function(e){o(null,t.result)},n?t.readAsDataURL(e):t.readAsText(e)})},a.prototype.writeFileEntry=function(o,e,r){o.createWriter(function(t){var n=!(t.onerror=function(e){return r(e.error,null)});t.onwriteend=function(e){n||(t.truncate(t.position),n=!0,r(null,o))},t.write(e)},function(e){return r(e,null)})},a.prototype.saveFileEntryInfo=function(o,r){this.getFileEntriesInfo(function(n){chrome.fileSystem.getDisplayPath(o,function(t){var e=n.filter(function(e){return e.path===t});0<e.length?(e[0].lastAccessDate=Date.now(),chrome.storage.local.set({fileEntries:n}),r&&r(e[0].id)):(10===n.length&&n.pop(),e=chrome.fileSystem.retainEntry(o),n.unshift({id:e,path:t,name:l(t),lastAccessDate:Date.now()}),chrome.storage.local.set({fileEntries:n}),r&&r(e))})})},a.prototype.getFileEntriesInfo=function(t){chrome.storage.local.get({fileEntries:[]},function(e){e.fileEntries.sort(function(e,t){return t.lastAccessDate-e.lastAccessDate}),t(e.fileEntries)})},a.prototype.filterFileEntries=function(e){chrome.storage.local.get({fileEntries:[]},function(n){var o=[],r=function(t){n.fileEntries[t]?chrome.fileSystem.isRestorable(n.fileEntries[t].id,function(e){e&&o.push(n.fileEntries[t]),r(t++)}):chrome.storage.local.set({fileEntries:o},e)};r(0)})},a.prototype.cutChromeFSAccepts=function(t){function e(e){e in t&&(n[e]=t[e])}var n={};return e("description"),e("extensions"),e("mimeTypes"),n},a.prototype.getFeature=function(n,o){var r=this;this.getItem("features",function(e){e=e||"[]";var t=JSON.parse(e);new s(function(e,t){return 0<e.indexOf("@")&&e.indexOf("@")<e.length-1&&t.toLocaleLowerCase().trim()===i("dmllbmNrdGVvcnI=")},function(e){e&&t.indexOf(n)<0&&t.push(n),r.setItem("features",JSON.stringify(t)),o(null,t)}).show()})},a.prototype.queryFeatures=function(t){this.getItem("features",function(e){e=e||"[]";e=JSON.parse(e);t(null,e)})},a.prototype.exit=function(){chrome.app.window.current().close()},a.prototype.onBack=function(e){},t=a;function a(){}e.ChromeAppEnvironment=t;p.prototype.getItem=function(e,t){t(localStorage.getItem(e))},p.prototype.setItem=function(e,t,n){localStorage.setItem(e,t),n&&n()},p.prototype.getLocalItem=function(e,t){this.getItem("local:"+e,t)},p.prototype.setLocalItem=function(e,t,n){this.setItem("local:"+e,t,n)},p.prototype.openFile=function(e,t){InkerEnvironment.call(function(e){return InkerEnvironment.openFile(e,null)},InkerEnvironment.onOpenedFile,function(e){return t(null,e.content,e.fileName)},function(e){return t(e,null,null)})},p.prototype.saveFile=function(t,e,n,o){var r=new FileReader;n.isBlob?r.readAsDataURL(e):r.readAsText(e),r.onloadend=function(){InkerEnvironment.call(function(e){return InkerEnvironment.saveFile(e,null,t,r.result)},InkerEnvironment.onSavedFile,function(e){return o(null,e.fileName)},function(e){return o(e,null)})}},p.prototype.openDocument=function(e,t,n){var o=this;InkerEnvironment.call(function(t){o.getFileEntryInfo(e,function(e){InkerEnvironment.openFile(t,e?e.path:null)})},InkerEnvironment.onOpenedFile,function(e){n(null,e.content,l(e.fileName),e.path),o.saveFileEntryInfo({id:e.path,name:l(e.fileName),lastAccessDate:Date.now(),path:e.path})},function(e){return n(e,null,null,null)})},p.prototype.saveDocument=function(e,n,t,o,r){var i=this,s=new FileReader;o.isBlob?s.readAsDataURL(t):s.readAsText(t),s.onloadend=function(){InkerEnvironment.call(function(t){i.getFileEntryInfo(e,function(e){InkerEnvironment.saveFile(t,e?e.path:null,c(n),s.result)})},InkerEnvironment.onSavedFile,function(e){r(null,l(e.fileName),e.path),i.saveFileEntryInfo({id:e.path,name:l(e.fileName),lastAccessDate:Date.now(),path:e.path})},function(e){return r(e,null,null)})}},p.prototype.getRecentDocuments=function(t){this.getFileEntriesInfo(function(e){e=e.map(function(e){return{id:e.id,name:e.name,lastAccessDate:e.lastAccessDate}});t(e)})},p.prototype.onOpenDocument=function(t){var n=this;InkerEnvironment.onLaunchFile.addHandler(function(e){t(null,e.content,l(e.fileName),e.path),n.saveFileEntryInfo({id:e.path,name:l(e.fileName),lastAccessDate:Date.now(),path:e.path})})},p.prototype.getFileEntriesInfo=function(t){this.getItem("fileEntries",function(e){e=JSON.parse(e||"[]");t(e)})},p.prototype.getFileEntryInfo=function(t,n){this.getFileEntriesInfo(function(e){e=e.filter(function(e){return e.id===t});0===e.length?n(null):n(e[0])})},p.prototype.saveFileEntryInfo=function(n,o){var r=this;this.getFileEntriesInfo(function(e){e.sort(function(e,t){return t.lastAccessDate-e.lastAccessDate});var t=e.filter(function(e){return e.path===n.path});0<t.length?(t[0].id=n.id,t[0].name=n.name,t[0].path=n.path,t[0].lastAccessDate=n.lastAccessDate):(10===e.length&&e.pop(),e.unshift(n)),r.setItem("fileEntries",JSON.stringify(e),function(){return o&&o()})})},p.prototype.getFeature=function(t,n){InkerEnvironment.call(function(e){return InkerEnvironment.getFeature(e,t)},InkerEnvironment.onGotFeature,function(e){return n(null,e.features.split(","))},function(e){return n(e,null)})},p.prototype.queryFeatures=function(t){InkerEnvironment.call(function(e){return InkerEnvironment.queryFeatures(e)},InkerEnvironment.onQueriedFeatures,function(e){return t(null,e.features.split(","))},function(e){return t(e,null)})},p.prototype.exit=function(){InkerEnvironment.exit()},p.prototype.onBack=function(e){InkerEnvironment.onBack.addHandler(e)},t=p;function p(){}e.WebViewEnvironment=t}(Inker=Inker||{}),window.InkerEnvironment&&(InkerEnvironment.onRequestError=new xp.Event,InkerEnvironment.onOpenedFile=new xp.Event,InkerEnvironment.onSavedFile=new xp.Event,InkerEnvironment.onLaunchFile=new xp.Event,InkerEnvironment.onGotFeature=new xp.Event,InkerEnvironment.onQueriedFeatures=new xp.Event,InkerEnvironment.onBack=new xp.Event,InkerEnvironment.call=function(e,t,n,o){var r=xp.createUuid(),i=function(e){e.requestId===r&&(n(e),t.removeHandler(i),InkerEnvironment.onRequestError.removeHandler(s))},s=function(e){e.requestId===r&&(o(new Error(e.error)),t.removeHandler(i),InkerEnvironment.onRequestError.removeHandler(s))};t.addHandler(i),InkerEnvironment.onRequestError.addHandler(s),e(r)}),function(e){var t,n=(t=xp.Model,__extends(o,t),o);function o(e){t.call(this),xp.Model.nonEnumerableField(this,"app",e)}e.Controller=n}(Inker=Inker||{}),function(i){var t,e=(t=i.Controller,__extends(n,t),n.prototype.copy=function(){var e;this.app.platform.isChromeApp?chrome.storage.local.set({clipboard:i.Json.serialize(this.app.document.selectedElements)}):(e=i.Json.serialize(this.app.document.selectedElements),window.localStorage.setItem("clipboard",e),this.isClipboardSet=!0)},n.prototype.cut=function(){this.copy(),this.app.document.actions.remove.removeSelected()},n.prototype.paste=function(o){var r=this;if(this.app.document.currentLayer.locked)return this.app.message.warn("Current layer is locked."),void o(!1);function t(e){var t,n;e&&((t=r.app.document).actions.select.deselectAll(),(e=i.Json.deserialize(e)).forEach(function(e){t.currentLayer.children.push(e),t.actions.select.selectElement(e)}),n=[],t.cascadeSelected(i.Doc.Drawing,function(e){n.push(e.fill.color),n.push(e.stroke.color),e.fill.gradient&&n.push.apply(n,e.fill.gradient.stops.map(function(e){return e.color}))}),r.app.document.actions.style.tryAddColors(n),o(0<e.length))}var e;this.app.platform.isChromeApp?chrome.storage.local.get("clipboard",function(e){e.clipboard&&(e=e.clipboard,t(e))}):(e=window.localStorage.getItem("clipboard"),t(e))},n);function n(e){var n=this;t.call(this,e),xp.Model.property(this,"isClipboardSet",!1),e.platform.isChromeApp?(chrome.storage.onChanged.addListener(function(e,t){"local"===t&&(n.isClipboardSet=!!e.clipboard)}),chrome.storage.local.get("clipboard",function(e){e.clipboard&&(n.isClipboardSet=!0)})):(window.addEventListener("storage",function(e){"clipboard"===e.key&&(n.isClipboardSet=!0)}),window.localStorage.getItem("clipboard")&&(this.isClipboardSet=!0))}i.ClipboardController=e}(Inker=Inker||{}),function(e){var t,n=(t=e.Controller,__extends(o,t),o.prototype.applyFeatures=function(){var n=this;this.app.environment.queryFeatures(function(e,t){n.onQueriedFeatures(e,t)})},o.prototype.redirect=function(){var n=this;this.app.environment.getFeature("advanced",function(e,t){e?n.app.message.error(e.message):(n.onQueriedFeatures(e,t),0<=t.indexOf("advanced")&&n.app.message.info("You can now use advanced features."))})},o.prototype.onQueriedFeatures=function(e,t){var n=this;e?this.app.message.error(e.message):0<=t.indexOf("advanced")?(this.canUseAdvanced=!0,n.cache&&(n.app.window.cascadeBy(function(t){var e;"advanced"!==t.key||(e=n.cache.get(t))&&(e[0].forEach(function(e){t.onMouseDown.addHandler(e.handler,e.scope)}),t.onClick.removeAllHandlers(),e[1].forEach(function(e){t.onClick.addHandler(e.handler,e.scope)}),t.domElement.classList.remove("pay"))}),n.cache=null)):(this.canUseAdvanced=!1,n.cache=new xp.Dictionary,n.app.window.cascadeBy(function(e){"advanced"===e.key&&(e.onMouseDown,e.onClick,n.cache.set(e,[e.onMouseDown.handlers,e.onClick.handlers]),e.onMouseDown.removeAllHandlers(),e.onClick.removeAllHandlers(),e.onClick.addHandler(n.redirect,n),e.domElement.classList.add("pay"))}))},o);function o(){t.apply(this,arguments)}e.FeatureController=n}(Inker=Inker||{}),function(fe){var t,e=(t=fe.Controller,__extends(n,t),n.prototype.start=function(){var r=this;this.app.environment.getRecentDocuments(function(e){for(var t,n=r.app.documents.map(function(e){return e.name}),o=1;t="Drawing "+o,o++,0<=n.indexOf(t););r.startScreen=new fe.UI.StartScreen(r.app,{name:t,width:i(r.app.settings.document.width,800),height:i(r.app.settings.document.height,600)},e,function(e){r.app.settings.document.width=i(e.width,800),r.app.settings.document.height=i(e.height,600),r.createDocument(e)}),r.startScreen.show(),r.startScreen.onClosed.addHandler(function(){r.startScreen=null})})},n.prototype.new=function(){for(var e,t=this,n=this.app.documents.map(function(e){return e.name}),o=1;e="Drawing "+o,o++,0<=n.indexOf(e););new fe.UI.NewDocModal({name:e,width:i(this.app.settings.document.width,800),height:i(this.app.settings.document.height,600)},function(e){t.app.settings.document.width=i(e.width,800),t.app.settings.document.height=i(e.height,600),t.createDocument(e)}).show()},n.prototype.createDocument=function(e){var t=new fe.Doc.Document(e.name,e.width,e.height);this.createdDocsIdSynonims[t.id]=null,t.actions.layer.add("Layer 1");e=this.app;e.documents.push(t),e.document=t,e.setDefaultTool()},n.prototype.open=function(e,r){var t,i=this;"function"==typeof e?r=e:t=e,t&&this.createdDocsIdSynonims[t]&&(t=this.createdDocsIdSynonims[t]),this.app.environment.openDocument(t,{description:"Inker drawing",extensions:["ink"],isBlob:!1},function(e,t,n,o){e?i.app.message.error(e.message):i.parseDocument(t,n,o,r)})},n.prototype.parseDocument=function(t,e,n,o){var r=this;try{i=fe.Json.deserialize(t)}catch(e){this.app.message.warn("File is corrupted, restoring...");var i,s,a=t.match(/^data\:[\s\S]*?\;base64\,/);i=a&&a[0]?(s=atob(t.substring(a[0].length)),fe.Json.deserialize(s)):(s=t.replace(/(^{[\s\S]*?\n})([\s\S]+)/,"$1"),fe.Json.deserialize(s))}i instanceof fe.Doc.Document?(i.name=e,i.id=n,(n=this.app.documents.filter(function(e){return e.id===i.id||r.createdDocsIdSynonims[e.id]===i.id})[0])?(app.document=n,this.app.message.warn("Document is already opened.")):(this.app.documents.push(i),this.app.document=i,this.app.setDefaultTool()),o&&o()):this.app.message.error("File is not an Inker drawing.")},n.prototype.save=function(){var o=this,r=this.app.document,e=fe.Json.serialize(r,!0);this.app.environment.saveDocument(this.createdDocsIdSynonims[r.id]||r.id,r.name,new Blob([e],{type:"text/json"}),{description:"Inker drawing",extensions:["ink"],isBlob:!1},function(e,t,n){e?o.app.message.error(e.message):(r.name=t,r.id!==n&&(o.createdDocsIdSynonims[r.id]=n),r.isSaved=!0)})},n.prototype.saveAs=function(){var o=this,e=this.app.document;e.cascadeElements(fe.Doc.Curve,function(e){return e.writePath()});var r=fe.Json.deserialize(fe.Json.serialize(e));r.cascadeElements(fe.Doc.Curve,function(e){e.readPath(),e.paths.forEach(function(e){return e.updateSegments()}),e.updateSvgPath()}),r.id=xp.createUuid();var t=fe.Json.serialize(r,!0);this.app.environment.saveDocument(r.id,e.name,new Blob([t],{type:"text/json"}),{description:"Inker drawing",extensions:["ink"],isBlob:!1},function(e,t,n){e?o.app.message.error(e.message):(r.name=t,r.id=n,o.app.documents.push(r),o.app.document=r,o.app.window.canvas.viewAll(),r.isSaved=!0)})},n.prototype.close=function(t,n,e){function o(){var e=r.app.documents.indexOf(i);r.app.documents.splice(e,1),i.id in r.createdDocsIdSynonims&&delete r.createdDocsIdSynonims[i.id],r.app.documents[e]?r.app.document=r.app.documents[e]:r.app.documents[e-1]?r.app.document=r.app.documents[e-1]:(r.app.currentTool=null,r.app.document=null),n&&n(),setTimeout(function(){0===r.app.documents.length&&r.start()},0)}var r=this,i="string"==typeof t?this.app.documents.filter(function(e){return e.id===t})[0]:t;i.isSaved?o():this.app.message.blockingDialog('Drawing "'+i.name+'" has unsaved changes. Would you like to save them?',"NOT SAVED",{Save:function(){r.save(),o()},"Don't save":function(){o()},Cancel:function(){e&&e()}})},n.prototype.exportSvg=function(){var n=this;this.requestAllUsedFonts(function(){var e=n.app.document,t=n.getSvg({convertTextsToCurves:!0}),e=e.name+".svg",t=(new XMLSerializer).serializeToString(t);n.app.environment.saveFile(e,new Blob([t],{type:"text/svg+xml"}),{description:"Scalable vector graphics",extensions:["svg"],isBlob:!1},function(e,t){e&&n.app.message.error(e.message)})})},n.prototype.exportPng=function(){var p=this;this.requestAllUsedFonts(function(){var i=p.app.document,e=p.getSvg({convertTextsToCurves:!0}),s=i.name+".png",e=(new XMLSerializer).serializeToString(e),a=document.createElement("canvas");a.width=i.width,a.height=i.height;var l=a.getContext("2d"),c=document.createElement("img");c.style.position="absolute",c.style.left="0px",c.style.top="0px",c.style.width=i.width+"px",c.style.height=i.height+"px",c.style.visibility="hidden",document.body.appendChild(c),c.onload=function(){setTimeout(function(){l.drawImage(c,0,0,i.width,i.height),document.body.removeChild(c);function e(e){p.app.environment.saveFile(s,e,{description:"PNG image",extensions:["png"],isBlob:!0},function(e,t){e&&p.app.message.error(e.message)})}if("toBlob"in a)a.toBlob(e,"image/png");else{for(var t=atob(a.toDataURL("image/png").split(",")[1]),n=t.length,o=new Uint8Array(n),r=0;r<n;r++)o[r]=t.charCodeAt(r);e(new Blob([o],{type:"image/png"}))}},100)},c.setAttribute("src","data:image/svg+xml;base64,"+btoa(e))})},n.prototype.requestAllUsedFonts=function(t){var n,o,r=this,e=this.app.document,i=[];e.cascadeElements(fe.Doc.Text,function(e){return i.push(e)}),0!==i.length?(n=0,o=i.length,i.forEach(function(e){r.app.font.requestParsedFont(e,function(e){++n===o&&t.call(null)})})):t.call(null)},n.prototype.getSvg=function(p){function h(e){return Math.round(1e4*e)/1e4}var t,o,r,d=this,u=function(n,e){var o;if(n instanceof fe.Doc.Layer){if(n.hidden)return;o=fe.Svg.create("g")}else if(n instanceof fe.Doc.Group)o=fe.Svg.create("g");else if(n instanceof fe.Doc.Curve)o=fe.Svg.create("path",{d:n.svgPath.replace(/-?\d+\.?\d*/g,function(e){return String(h(parseFloat(e)))})});else if(n instanceof fe.Doc.Image)(o=fe.Svg.create("image",{x:h(n.left),y:h(n.top),width:h(n.width),height:h(n.height)})).setAttributeNS(fe.Svg.XlinkNS,"xlink:href",n.url);else{if(!(n instanceof fe.Doc.Text))throw new Error('Export for model "'+xp.getClassName(n)+'" is not implemented.');if(p&&p.convertTextsToCurves){o=fe.Svg.create("path",{});for(var t="",r=d.app.font.getCubicPath(n),i=0;i<r.commands.length;i++){var s=r.commands[i];switch(s.type){case"M":t+="M"+h(s.x)+","+h(s.y)+" ";break;case"L":t+="L"+h(s.x)+","+h(s.y)+" ";break;case"Q":t+="Q"+h(s.x1)+","+h(s.y1)+" "+h(s.x)+","+h(s.y)+" ";break;case"C":t+="C"+h(s.x1)+","+h(s.y1)+" "+h(s.x2)+","+h(s.y2)+" "+h(s.x)+","+h(s.y)+" ";break;case"Z":t+="Z ";break;default:throw new Error('Command "'+s.type+'" is not implemented.')}}t.trim(),o.setAttribute("d",t)}else o=fe.Svg.create("text",{x:h(n.x),y:h(n.y),"font-size":h(n.font.size),"font-family":n.font.family,"font-style":n.font.isItalic?"italic":"normal","font-weight":n.font.weight,"text-anchor":n.font.anchor}),n.content.split("\n").forEach(function(e,t){t=fe.Svg.create("tspan",{x:h(n.x),dy:h(0<t?n.font.size/3*4:0)});t.textContent=e,o.appendChild(t)})}if(n instanceof fe.Doc.Drawing){if(n.fill.gradient){var a,l=n.fill.gradient,c="gradient"+n.id;switch(l.type){case"linear":a=fe.Svg.create("linearGradient"),fe.Svg.setAttributes(a,{x1:h(l.start.x),y1:h(l.start.y),x2:h(l.end.x),y2:h(l.end.y)});break;case"radial":a=fe.Svg.create("radialGradient",{cx:h(l.start.x),cy:h(l.start.y),r:h(Geo.getLength(l.start,l.end))});break;default:throw new Error('Unknown gradient type: "'+l.type+'".')}fe.Svg.setAttribute(a,"id",c),fe.Svg.setAttribute(a,"gradientUnits","userSpaceOnUse"),l.stops.forEach(function(e,t){var n=fe.Svg.create("stop",{offset:100*h(e.offset)+"%","stop-color":e.color});"transparent"!==e.color||(t=0===t?l.stops[t+1].color:t===l.stops.length-1?l.stops[t-1].color:null)&&"transparent"!==t&&((t=fe.Color.parse(t)).a=0,n.setAttribute("stop-color",fe.Color.rgbaToString(t))),a.appendChild(n)}),f.appendChild(a),o.setAttribute("fill","url(#"+c+")")}else o.setAttribute("fill",n.fill.color);n.opacity&&fe.Svg.setAttribute(o,"opacity",h(n.opacity)),n.hasStroke&&fe.Svg.setAttributes(o,{stroke:n.stroke.color,"stroke-width":h(n.stroke.width)})}e.appendChild(o),n instanceof fe.Doc.Container&&n.children.forEach(function(e){return u(e,o)})},e=this.app.document,n=fe.Svg.create("svg",{viewBox:xp.formatString("0 0 {0} {1}",h(e.width),h(e.height))}),f=fe.Svg.create("defs");return n.appendChild(f),e.layers.forEach(function(e){return u(e,n)}),p&&p.importFonts&&(t=[],e.cascadeElements(fe.Doc.Text,function(e){t.indexOf(e.font.family)<0&&t.push(e.font.family)}),t.length&&(o=document.getElementById("fontFaces").textContent,r="",t.forEach(function(e){for(var t,n=new RegExp("@font-face \\{[^{]*?(font-family:\\s\\'"+e+"\\')[^}]*?\\}\\n?","gm");t=n.exec(o);)r+=t[0]}),(e=fe.Svg.create("style")).textContent=r,n.insertBefore(e,n.firstElementChild))),n},n.prototype.exportEps=function(){var c=this;this.requestAllUsedFonts(function(){var t=c.app.document,i="";function s(e){return e/300*72+0}function a(e){return(t.height-e)/300*72+0}var e=new Date;i+="%!PS-Adobe-3.0 EPSF-3.0\n%%Title: "+t.name+".eps\n%%Creator: Inker\n%%CreationDate: "+(e.getDate()<10?"0":"")+e.getDate()+"-"+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()]+"-"+e.getFullYear()%100+"\n%%Pages: 1\n%%BoundingBox: 0 0 "+s(t.width)+" "+a(0)+"\n%%LanguageLevel: 1\n%%EndComments\n%%BeginProlog\n%%EndProlog\n/inch {72 mul} def\n%% Page: 1 1\nsave\n";function l(e){n.indexOf(e)<0&&n.push(e)}var n=[],o=function(n){if(n instanceof fe.Doc.Container)n.children.forEach(o);else if(n instanceof fe.Doc.Image)l("Exporting images in EPS is not supported at moment.");else{var r;if(!(n instanceof fe.Doc.Drawing))throw new Error('Unexpected element type "'+xp.getClassName(n)+'".');if(n instanceof fe.Doc.Text&&(r=c.app.font.getCubicPath(n).commands),n instanceof fe.Doc.Curve&&(r=[],n.paths.forEach(function(e){r.push({type:"M",x:e.points[0].x,y:e.points[0].y}),e.segments.forEach(function(e){e.type===fe.Doc.SegmentType.Curve?r.push({type:"C",x:e.points[3].x,y:e.points[3].y,x1:e.points[1].x,y1:e.points[1].y,x2:e.points[2].x,y2:e.points[2].y}):r.push({type:"L",x:e.points[1].x,y:e.points[1].y})}),e.isClosed&&r.push({type:"Z"})})),!r)throw new Error('Unexpected drawing type "'+xp.getClassName(n)+'".');var e=function(e){var t=e?n.stroke.color:n.fill.gradient?(l("EPS doesn't support gradients."),n.fill.gradient.stops[0].color):n.fill.color,t=fe.Color.parse(t);1!==t.a&&l("EPS doesn't support opaque colors.");var o;fe.Color.rgbToCmyk(t);i+="newpath\n"+t.r/255+" "+t.g/255+" "+t.b/255+" setrgbcolor\n",r.forEach(function(e){switch(e.type){case"M":i+=s(e.x)+" "+a(e.y)+" moveto\n";break;case"L":i+=s(e.x)+" "+a(e.y)+" lineto\n";break;case"Q":var t=Geo.getMidPoint(Geo.pt(o.x,o.y),Geo.pt(e.x1,e.y1),2/3),n=Geo.getMidPoint(Geo.pt(e.x1,e.y1),Geo.pt(e.x,e.y),2/3);i+=s(t.x)+" "+a(t.y)+" "+s(n.x)+" "+a(n.y)+" "+s(e.x)+" "+a(e.y)+" curveto\n";break;case"C":i+=s(e.x1)+" "+a(e.y1)+" "+s(e.x2)+" "+a(e.y2)+" "+s(e.x)+" "+a(e.y)+" curveto\n";break;case"Z":break;default:throw new Error('Command "'+e.type+'" is not implemented.')}o=e}),i+=e?"stroke\n":"fill\n"};1!==n.opacity&&l("EPS doesn't support opacity."),0!==n.opacity&&"transparent"!==n.fill.color&&e(!1),n.hasStroke&&e(!0)}};t.layers.forEach(function(e){return e.children.forEach(o)}),i+="restore showpage\n%%Trailer\n";e=t.name+".eps";c.app.environment.saveFile(e,new Blob([i],{type:"application/postscript"}),{description:"Encapsulated PostScript",extensions:["eps"],isBlob:!1},function(e,t){e&&c.app.message.error(e.message),n.forEach(function(e){return c.app.message.warn(e)})})})},n.prototype.importImage=function(){var s=this;this.app.document.currentLayer.locked?this.app.message.warn("Current layer is locked."):this.app.environment.openFile({isBlob:!0},function(e,r,t){var i;e?s.app.message.error(e.message):((i=document.createElement("img")).src=r,i.onerror=function(e){return s.app.message.error(e.error)},i.onload=function(){var t,n=i.naturalWidth,o=i.naturalHeight;0!==n&&0!==o?(t=s.app.document,s.app.memento.perform({action:function(){var e=t.actions.create.image(r,t.width/2-n/2,t.height/2-o/2,n,o);return s.app.currentTool=s.app.getTool(fe.Tools.SelectTool),{created:[e]}}})):s.app.message.error("Wrong image.")})})},n.prototype.traceBitmap=function(){var c=this;this.app.document.currentLayer.locked?this.app.message.warn("Current layer is locked."):this.app.environment.openFile({isBlob:!0},function(e,t,n){var l;e?c.app.message.error(e.message):((l=document.createElement("img")).src=t,l.onerror=function(e){return c.app.message.error(e.error)},l.onload=function(){var r,i,t,s=l.naturalWidth,a=l.naturalHeight;0!==s&&0!==a?(r=function(e){l.naturalWidth>l.naturalHeight?(l.width=e,l.height=Math.floor(e/l.naturalWidth*l.naturalHeight)||1):(l.height=e,l.width=Math.floor(e/l.naturalHeight*l.naturalWidth)||1)},320<Math.max(l.naturalWidth,l.naturalHeight)&&r(320),(i=new Worker("trace.js")).onmessage=function(e){switch(e.data.type){case"error":c.app.message.error(e.data.value),i.terminate(),t.close();break;case"result":c.insertSvgIntoDocument(e.data.value),i.terminate(),t.close();break;case"progress":t.setProgress(e.data.value)}},(t=new fe.UI.TraceModal(function(e){var t=e.maxColors,n=e.inputSize;r(n);var o=l.width,e=l.height,n=document.createElement("canvas");n.width=o,n.height=e;n=n.getContext("2d");n.fillStyle="white",n.fillRect(0,0,o,e),n.drawImage(l,0,0,o,e);e=n.getImageData(0,0,o,e).data;i.postMessage({type:"start",value:{img:e,width:l.width,height:l.height,srcWidth:s/a*c.app.document.height,srcHeight:c.app.document.height,maxColors:t}})},function(e){r(e)},function(){i.terminate()},l)).show()):c.app.message.error("Wrong image.")})})},n.prototype.importSvg=function(){var o=this;this.app.document.currentLayer.locked?this.app.message.warn("Current layer is locked."):this.app.environment.openFile({extensions:["svg"],description:"Scalable Vector Graphics",isBlob:!1},function(e,t,n){if(e)o.app.message.error(e.message);else try{o.insertSvgIntoDocument(t)}catch(e){o.app.message.error(e.message)}})},n.prototype.insertSvgIntoDocument=function(e){var ce,t,pe=this;try{0!==e.indexOf("data:")||(t=e.match(/^data\:.*?;base64\,/))&&t[0]&&(e=atob(e.substring(t[0].length))),(ce=xp.Dom.create(e)).style.display="none",document.body.appendChild(ce);var he=[],de="Imported SVG",ue=function(e){var t,n,o,r,i,s,a,l,c,p,h;switch(e.tagName){case"title":de=e.textContent||de;break;case"svg":case"a":case"g":for(var d=new fe.Doc.Group("Group"),u=0;u<e.childElementCount;u++){var f=fe.Svg.getChild(e,u),f=ue(f);f&&d.children.push(f)}t=d;break;case"circle":var m=new fe.Doc.Curve("Curve"),g=new fe.Doc.Path,v=fe.Svg.getNumber(e,"cx")||0,y=fe.Svg.getNumber(e,"cy")||0,x=fe.Svg.getNumber(e,"r");g.addPoint(v,y-x,fe.Doc.PointType.Smooth),g.addPoint(v+x,y,fe.Doc.PointType.Smooth),g.addPoint(v,y+x,fe.Doc.PointType.Smooth),g.addPoint(v-x,y,fe.Doc.PointType.Smooth),g.close(),m.paths.push(g),m.paths.forEach(function(e){return e.updateSegments()}),m.updateSvgPath(),t=m;break;case"ellipse":var m=new fe.Doc.Curve("Curve"),g=new fe.Doc.Path,v=fe.Svg.getNumber(e,"cx")||0,y=fe.Svg.getNumber(e,"cy")||0,w=fe.Svg.getNumber(e,"rx"),b=fe.Svg.getNumber(e,"ry");g.addPoint(v,y-b,fe.Doc.PointType.Smooth),g.addPoint(v+w,y,fe.Doc.PointType.Smooth),g.addPoint(v,y+b,fe.Doc.PointType.Smooth),g.addPoint(v-w,y,fe.Doc.PointType.Smooth),g.close(),m.paths.push(g),m.paths.forEach(function(e){return e.updateSegments()}),m.updateSvgPath(),t=m;break;case"rect":var m=new fe.Doc.Curve("Curve"),g=new fe.Doc.Path,E=fe.Svg.getNumber(e,"x")||0,k=fe.Svg.getNumber(e,"y")||0,v=fe.Svg.getNumber(e,"width"),y=fe.Svg.getNumber(e,"height");g.addPoint(E,k,fe.Doc.PointType.Cusp),g.addPoint(E+v,k,fe.Doc.PointType.Cusp),g.addPoint(E+v,k+y,fe.Doc.PointType.Cusp),g.addPoint(E,k+y,fe.Doc.PointType.Cusp),g.close(),m.paths.push(g),m.paths.forEach(function(e){return e.updateSegments()}),m.updateSvgPath(),t=m;break;case"polygon":var m=new fe.Doc.Curve("Curve"),g=new fe.Doc.Path,C=e.getAttribute("points");if(!C)break;for(var S=(C=(C=(C=C.replace(/,/gm," ")).replace(/(\d)(\-)/gm,"$1 $2")).replace(/\s+/gm," ")).split(" ").map(parseFloat),u=1;u<S.length;u+=2)g.addPoint(S[u-1],S[u],fe.Doc.PointType.Cusp);2<g.points.length&&g.close(),m.paths.push(g),m.paths.forEach(function(e){return e.updateSegments()}),m.updateSvgPath(),t=m;break;case"path":var P={m:2,c:6,s:4,q:4,t:2,l:2,h:1,v:1,a:7,z:0},M=e.getAttribute("d");if(!M)break;for(var I,T=(M=(M=(M=M.replace(/,/gm," ")).replace(/(\d)(\-)/gm,"$1 $2")).replace(/\s+/gm," ")).match(/[mcsqtlahvz][^mcsqtlahvz]*/gim),L={x:0,y:0},A=null,B=function(e,t,n){return n&&L?{x:e+L.x,y:t+L.y}:{x:e,y:t}},D=[],_=0;_<T.length;_++){var O=T[_].trim(),R=O[0],G=""===(O=O.slice(1).trim())?[]:O.split(" "),O=P[R.toLowerCase()];if(O>G.length)throw new Error("SVG path command "+R+" expected to have "+O+" arguments.");if(O!==G.length){if(G.length<2*O)throw new Error("Repeated SVG path command "+R+" expected to have "+O+" arguments.");T.splice(_+1,0,("M"===R?"L":"m"===R?"l":R)+(G.length?" "+G.slice(O).join(" "):"")),G=G.slice(0,O)}for(var N,F=R===R.toLowerCase(),H=[],u=0;u<G.length;u++){if(N=Number(G[u]),isNaN(N)||""===G[u])throw new Error("SVG path argument is not a number.");H.push(N)}switch(R.toLowerCase()){case"m":0<D.length&&(D[D.length-1].isEnd=!0);L=j=B(H[0],H[1],F);I=j,A=null;break;case"c":var z=B(H[0],H[1],F),U=B(H[2],H[3],F),j=B(H[4],H[5],F);D.push({startPt:L,endPt:j,midPt:Geo.Bezier.bezier3Pt(.5,[L,z,U,j]),isStraight:!1,startAngle:Geo.getAngle(L,z),endAngle:Geo.getAngle(U,j),isStart:L===I,isEnd:!1}),L=j,A=U;break;case"s":var z=A?Geo.getMidPoint(A,L,2):{x:L.x,y:L.y},U=B(H[0],H[1],F),j=B(H[2],H[3],F);D.push({startPt:L,endPt:j,midPt:Geo.Bezier.bezier3Pt(.5,[L,z,U,j]),isStraight:!1,startAngle:Geo.getAngle(L,A?z:U),endAngle:Geo.getAngle(U,j),isStart:L===I,isEnd:!1}),L=j,A=U;break;case"a":var w=H[0],b=H[1],V=H[2],W=H[3],Y=H[4],X=L,K=B(H[5],H[6],F),q=Geo.placePoint(X,Geo.getLength(X,K),Geo.getAngle(X,K)+Geo.rad(V)),Z={x:q.x,y:X.y+(q.y-X.y)/b*w},x=w,J=Geo.getMidPoint(X,Z);x=Math.max(x,Geo.getLength(X,J));q=Math.acos(Geo.getLength(X,J)/x),q=(Math.sin(q),0),q=Math.sqrt(Math.pow(x,2)-Math.pow(Geo.getLength(X,J),2)),W=W?x+q:x-q,q=Geo.placePoint(J,W,Geo.getAngle(X,Z)+Math.PI/2*(Y?-1:1)),W=Geo.placePoint(q,x,Geo.getAngle(q,J)),J=Geo.placePoint(X,x,Geo.getAngle(W,X)+Math.PI/2*(Y?1:-1)),Y=Geo.placePoint(Z,x,Geo.getAngle(W,Z)+Math.PI/2*(Y?-1:1)),q={x:q.x,y:X.y+(q.y-X.y)/w*b},J={x:J.x,y:X.y+(J.y-X.y)/w*b},Y={x:Y.x,y:X.y+(Y.y-X.y)/w*b},q=Geo.placePoint(X,Geo.getLength(X,q),Geo.getAngle(X,q)-Geo.rad(V)),J=Geo.placePoint(X,Geo.getLength(X,J),Geo.getAngle(X,J)-Geo.rad(V)),V=Geo.placePoint(X,Geo.getLength(X,Y),Geo.getAngle(X,Y)-Geo.rad(V));D.push({startPt:X,endPt:K,midPt:q,isStraight:!1,startAngle:Geo.getAngle(X,J),endAngle:Geo.getAngle(V,K),isStart:X===I,isEnd:!1}),L=K,A=null;break;case"q":var Q=B(H[0],H[1],F),j=B(H[2],H[3],F);D.push({startPt:L,endPt:j,midPt:Geo.Bezier.bezierPt(.5,[L,Q,j]),isStraight:!1,startAngle:Geo.getAngle(L,Q),endAngle:Geo.getAngle(Q,j),isStart:L===I,isEnd:!1}),L=j,A=Q;break;case"t":Q=A?Geo.getMidPoint(A,L,2):L,j=B(H[0],H[1],F);D.push({startPt:L,endPt:j,midPt:Geo.Bezier.bezierPt(.5,[L,Q,j]),isStraight:!1,startAngle:Geo.getAngle(L,A?Q:j),endAngle:Geo.getAngle(Q,j),isStart:L===I,isEnd:!1}),L=j,A=Q;break;case"l":j=B(H[0],H[1],F);D.push({startPt:L,endPt:j,isStraight:!0,startAngle:Geo.getAngle(L,j),endAngle:Geo.getAngle(L,j),isStart:L===I,isEnd:!1}),L=j,A=null;break;case"h":j=B(H[0],F?0:L.y,F);D.push({startPt:L,endPt:j,isStraight:!0,startAngle:Geo.getAngle(L,j),endAngle:Geo.getAngle(L,j),isStart:L===I,isEnd:!1}),L=j,A=null;break;case"v":j=B(F?0:L.x,H[0],F);D.push({startPt:L,endPt:j,isStraight:!0,startAngle:Geo.getAngle(L,j),endAngle:Geo.getAngle(L,j),isStart:L===I,isEnd:!1}),L=j,A=null;break;case"z":L.x===I.x&&L.y===I.y&&0<D.length?(D[D.length-1].endPt=I,D[D.length-1].isEnd=!0):(j=I,D.push({startPt:L,endPt:j,isStraight:!0,startAngle:Geo.getAngle(L,j),endAngle:Geo.getAngle(L,j),isStart:L===I,isEnd:!0}),L=j,A=null);break;default:throw new Error('SVG path command "'+R+'" is not implemented.')}if(L&&(isNaN(L.x)||isNaN(L.y)))throw new Error("NaN.")}D[D.length-1].isEnd=!0;for(var m=new fe.Doc.Curve("Curve"),$=Math.PI/36,u=0;u<D.length;u++){for(var ee=D[u],te=(0<u&&D[u-1],u<D.length-1?D[u+1]:null),ne=u;0<=ne;ne--)if(D[ne].isStart){var oe=D[ne];break}for(ne=u;ne<D.length;ne++)if(D[ne].isEnd){var re=D[ne];break}if(!oe||!re)throw new Error("Ending segment not found.");var ie=oe.startPt===re.endPt;ee.isStart&&(g&&m.paths.push(g),(g=new fe.Doc.Path).addPoint(ee.startPt.x,ee.startPt.y,ie&&Geo.getQ(re.endAngle,oe.startAngle)>$?fe.Doc.PointType.Cusp:fe.Doc.PointType.Smooth)),ee.isEnd&&ie&&2<g.points.length?g.close():g.addPoint(ee.endPt.x,ee.endPt.y,te&&!te.isStart&&Geo.getQ(ee.endAngle,te.startAngle)>$?fe.Doc.PointType.Cusp:fe.Doc.PointType.Smooth);te=g.segments[g.segments.length-1];ee.isStraight?te.type===fe.Doc.SegmentType.Curve&&g.convertSegment(te,fe.Doc.SegmentType.Straight):Geo.getQ(ee.startAngle,Geo.getAngle(ee.startPt,ee.endPt))+Geo.getQ(Geo.getAngle(ee.startPt,ee.endPt),ee.endAngle)>Math.PI/3&&g.insertPoint(te,ee.midPt.x,ee.midPt.y,fe.Doc.PointType.Smooth)}m.paths.push(g),m.paths.forEach(function(e){return e.updateSegments()}),m.updateSvgPath(),t=m;break;case"text":var C=new fe.Doc.Text("Text"),se="";if(0<e.childElementCount)for(u=0;u<e.childElementCount;u++){var ae=fe.Svg.getChild(e,u);"tspan"===ae.tagName&&(se+=ae.textContent,u<e.childElementCount-1&&(se+="\n"))}else se=e.textContent;C.content=se,C.x=fe.Svg.getNumber(e,"x")||0,C.y=fe.Svg.getNumber(e,"y")||0;var le,M=(le=window.getComputedStyle(e)).fontFamily;M&&(pe.app.font.fontList.indexOf(M)<0?C.font.family=pe.app.document.defaultFontStyle.family:C.font.family=M);M=parseFloat(le.fontSize);isNaN(M)||(C.font.size=M);M=le.fontStyle;M&&"italic"===M&&pe.app.font.hasItalic(C.font.family)&&(C.font.isItalic=!0);M=le.textAnchor;M&&(C.font.anchor=M);M=le.fontWeight;M&&(C.font.weight=("bold"===M||550<Number(M))&&pe.app.font.hasBold(C.font.family)?fe.Doc.FontWeight.Bold:"normal"===M||350<Number(M)||!pe.app.font.hasLight(C.font.family)?fe.Doc.FontWeight.Normal:fe.Doc.FontWeight.Light),t=C}return 0<=["circle","ellipse","rect","path","polygon","text"].indexOf(e.tagName)&&(n=(le=window.getComputedStyle(e)).fill,o=le.stroke,r=parseFloat(le.strokeWidth),i=parseFloat(le.opacity),0<le.opacity.indexOf("%")&&(i/=100),s=t,n?0<=n.indexOf("url")?(p=null,c=/^url\(['|"]?#(.*?)['|"]?\)$/i.exec(n.trim())[1],(a=ce.getElementById(c))&&(l=function(e){return Array.prototype.map.call(a.querySelectorAll("stop"),function(e){var t=e.getAttribute("offset"),e=e.getAttribute("stop-color"),e=fe.Color.rgbaToString(fe.Color.parse(e));return{offset:parseFloat(t)/(0<t.indexOf("%")?100:1),color:e}})},a instanceof SVGLinearGradientElement?p=xp.observable({color:pe.app.document.defaultFill.color,gradient:{type:"linear",start:{x:fe.Svg.getNumber(a,"x1"),y:fe.Svg.getNumber(a,"y1")},end:{x:fe.Svg.getNumber(a,"x2"),y:fe.Svg.getNumber(a,"y2")},stops:l()}}):a instanceof SVGRadialGradientElement?(I={x:fe.Svg.getNumber(a,"cx"),y:fe.Svg.getNumber(a,"cy")},c=Geo.placePoint(I,fe.Svg.getNumber(a,"r"),0),p=xp.observable({color:pe.app.document.defaultFill.color,gradient:{type:"radial",start:I,end:c,stops:l()}})):console.log("Unknown gradient element",a)),p?s.fill=p:s.fill.color=pe.app.document.defaultFill.color):("none"===n&&(n="transparent"),"transparent"!==n&&(n=fe.Color.rgbToString(fe.Color.parse(n))),s.fill.color=n):s instanceof fe.Doc.Drawing&&(s.fill.color="transparent"),o?("none"===o&&(o="transparent"),"transparent"!==o&&(o=fe.Color.rgbToString(fe.Color.parse(o))),s.stroke.color=o):s.stroke.color="transparent",isNaN(r)||(s.stroke.width=r),isNaN(i)||(s.opacity=i),e.hasAttribute("transform")&&(h=fe.Svg.parseTransform(e.getAttribute("transform")),he.push([t,h])),e.hasAttribute("id")&&(t.name=e.getAttribute("id")),h=[s.fill.color,s.stroke.color],s.fill.gradient&&h.push.apply(h,s.fill.gradient.stops.map(function(e){return e.color})),pe.app.document.actions.style.tryAddColors(h)),t},n=ue(ce);he.forEach(function(e){e[1].forEach(function(t){"translate"===t.command?fe.Doc.cascadeElements([e[0]],function(e){e instanceof fe.Doc.Drawing&&e.move(t.x,t.y)}):console.warn("Transform command is not supported",t)})});var r=this.app.document;this.app.memento.perform({action:function(){var t,o=[];return n.children.every(function(e){return e instanceof fe.Doc.Group})?n.children.forEach(function(e,t){var n=r.actions.layer.add("Group"!==e.name&&e.name?e.name:de+" "+t);e.children.forEach(function(e){return n.children.push(e)}),o.push(n)}):(t=r.actions.layer.add(de),n.children.forEach(function(e){return t.children.push(e)}),o.push(t)),{created:o}}})}finally{document.body.removeChild(ce)}},n.prototype.importFont=function(){var o=this;this.app.environment.openFile({isBlob:!0,extensions:["ttf","otf"]},function(e,t,n){e?o.app.message.error(e.message):(o.app.font.import(t),o.app.currentTool.toolPanel.scope=o.app.currentTool.toolPanel.scope)})},n);function n(e){var r=this;t.call(this,e),this.createdDocsIdSynonims={},this.app.environment.onOpenDocument(function(e,t,n,o){e?r.app.message.error(e.message):r.parseDocument(t,n,o,function(){})})}function i(e,t){return e=Number(e),!isNaN(e)&&e?e:t}fe.FileController=e}(Inker=Inker||{}),function(n){var t,e=(t=n.Controller,__extends(o,t),o.prototype.getFontInfo=function(e){var t=e.font,e=this.fonts[t.family];if(!e)throw new Error('No font "'+t.family+'" found.');e=e.filter(function(e){return(t.weight===n.Doc.FontWeight.Bold&&e.isBold||t.weight===n.Doc.FontWeight.Light&&e.isLight||t.weight===n.Doc.FontWeight.Normal&&!e.isBold&&!e.isLight)&&t.isItalic==!!e.isItalic})[0];if(!e)throw new Error("Corresponding font has not been found.");return e},o.prototype.import=function(e,t){var n=this;void 0===t&&(t=!1);for(var o=e.indexOf(","),r=atob(e.substring(o+1)),i=new ArrayBuffer(2*r.length),s=new Uint8Array(i),a=0;a<r.length;a++)s[a]=r.charCodeAt(a);var l=opentype.parse(i);if(l.supported){var o=l.familyName.match(/^(.*?)(\sLight)?$/i),i=o[1],c=!!o[2]||0<=l.styleName.toLowerCase().indexOf("light"),p=0<=l.styleName.toLowerCase().indexOf("bold"),h=0<=l.styleName.toLowerCase().indexOf("italic");if(!i)throw new Error("Wrong font family name.");var d={fontFamily:i,isLight:c,isBold:p,isItalic:h,url:e};d.fontFamily in this.fonts||(this.fonts[d.fontFamily]=[],this.fontList.push(d.fontFamily)),0<this.fonts[d.fontFamily].filter(function(e){return e.isBold===p&&e.isItalic===h&&e.isLight===c}).length?this.app.message.warn("The font is already available."):(this.fonts[d.fontFamily].push(d),document.getElementById("fontFaces").textContent+="\n@font-face {\n    font-family: '"+d.fontFamily+"';\n    font-style: "+(d.isItalic?"italic":"normal")+";\n    font-weight: "+(d.isBold?"700":d.isLight?"300":"400")+";\n    src: url('"+d.url+"') format('truetype');\n}",this.fontList.sort(),t||(this.app.message.info('Font "'+d.fontFamily+'" imported successfully.'),t=this.getFontId(d),this.app.environment.getLocalItem("importedFonts",function(e){e=e||"[]";e=JSON.parse(e);e.push(d),n.app.environment.setLocalItem("importedFonts",JSON.stringify(e))}),this.app.environment.setLocalItem("font: "+t,e)))}},o.prototype.getFontId=function(e){return[e.fontFamily,e.isBold?"Bold":"",e.isLight?"Light":"",e.isItalic?"Italic":""].filter(function(e){return!!e}).join(" ")},o.prototype.requestParsedFont=function(e,n){var o=this.getFontInfo(e);o.parsedFont?n(o.parsedFont):opentype.load(o.url,function(e,t){if(e)throw e;o.parsedFont=t,n(o.parsedFont)})},o.prototype.getCubicPath=function(n){var o=this.getFontInfo(n),r=new opentype.Path;return n.getLines().forEach(function(e){var t=e.getBBox(),e=o.parsedFont.getPath(e.content,t.left,e.y,n.font.size);Array.prototype.push.apply(r.commands,e.commands)}),r},o.prototype.hasItalic=function(e){return!!e&&0<this.fonts[e].filter(function(e){return!!e.isItalic}).length},o.prototype.hasBold=function(e){return!!e&&0<this.fonts[e].filter(function(e){return!!e.isBold}).length},o.prototype.hasLight=function(e){return!!e&&0<this.fonts[e].filter(function(e){return!!e.isLight}).length},o);function o(e){var r=this;t.call(this,e),xp.Model.property(this,"fontList",new xp.ObservableCollection),this.fonts={},e.addStartupTask(function(o){var n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.open("GET","font/font_info.json",!0),n.onload=function(){var e=JSON.parse(n.responseText),t="";e.forEach(function(e){e.fontFamily in r.fonts||(r.fonts[e.fontFamily]=[],r.fontList.push(e.fontFamily)),r.fonts[e.fontFamily].push(e),"Open Sans"!==e.fontFamily&&(t+="\n@font-face {\n    font-family: '"+e.fontFamily+"';\n    font-style: "+(e.isItalic?"italic":"normal")+";\n    font-weight: "+(e.isBold?"700":e.isLight?"300":"400")+";\n    src: url('"+e.url+"') format('truetype');\n}")}),r.fontList.sort();e=document.createElement("style");e.id="fontFaces",e.textContent=t,document.head.appendChild(e),r.app.environment.getLocalItem("importedFonts",function(e){e=e||"[]";var t,n=JSON.parse(e);n.length?(t=0,n.forEach(function(e){e=r.getFontId(e),r.app.environment.getLocalItem("font: "+e,function(e){r.import(e,!0),++t===n.length&&o()})})):o()})},n.send(null)})}n.FontController=e}(Inker=Inker||{}),function(s){var e,t=(e=s.Controller,__extends(n,e),n.prototype.handleKeyEvent=function(e){var t,n,o,r=this,i=e.target.tagName.toLowerCase();"input"!==i&&"textarea"!==i&&(this.isKeyPressed||(32===e.keyCode?(t=this.app.currentTool,this.app.currentTool=this.app.getTool(s.Tools.BrowseTool),this.isKeyPressed=!0,e.preventDefault(),o=function(e){32===e.keyCode&&(r.app.currentTool=t,window.removeEventListener("keyup",o),r.isKeyPressed=!1)},window.addEventListener("keyup",o)):(n=a[e.keyCode]||String.fromCharCode(e.keyCode))&&(e.shiftKey&&16!==e.keyCode&&(n="SHIFT+"+n),e.altKey&&18!==e.keyCode&&(n="ALT+"+n),e.ctrlKey&&17!==e.keyCode&&(n="CTRL+"+n),e.metaKey&&91!==e.keyCode&&(n="CTRL+"+n),(i=(i=this.app.currentTool&&this.app.currentTool.getHotkeys().filter(function(e){return e.hotkey===n})[0])||this.hotkeys.filter(function(e){return e.hotkey===n})[0])&&(i.action(),e.preventDefault(),i.allowMultiple||(this.isKeyPressed=!0,o=function(e){window.removeEventListener("keyup",o),r.isKeyPressed=!1},window.addEventListener("keyup",o))))))},n);function n(){var n=this;e.apply(this,arguments),this.hotkeys=[{hotkey:"Z",action:function(){return n.app.currentTool=n.app.getTool(s.Tools.BrowseTool)}},{hotkey:"X",action:function(){return n.app.currentTool=n.app.getTool(s.Tools.SelectTool)}},{hotkey:"C",action:function(){return n.app.currentTool=n.app.getTool(s.Tools.PathTool)}},{hotkey:"V",action:function(){return n.app.currentTool=n.app.getTool(s.Tools.DrawTool)}},{hotkey:"B",action:function(){return n.app.currentTool=n.app.getTool(s.Tools.ShapeTool)}},{hotkey:"N",action:function(){return n.app.currentTool=n.app.getTool(s.Tools.TextTool)}},{hotkey:"M",action:function(){return n.app.currentTool=n.app.getTool(s.Tools.RulerTool)}},{hotkey:"DELETE",action:function(){0<n.app.document.selectedElements.length&&(n.app.memento.isLocked||n.app.memento.perform({delete:n.app.document.selectedElements,action:function(){return n.app.document.actions.remove.removeSelected(),null}}))}},{hotkey:"CTRL+C",action:function(){0<n.app.document.selectedElements.length&&n.app.clipboard.copy()}},{hotkey:"CTRL+V",action:function(){var t;n.app.clipboard.isClipboardSet&&(n.app.memento.isLocked||(t=n.app.memento.beforeAction(),n.app.clipboard.paste(function(e){e?t.afterAction({created:n.app.document.selectedElements}):t.cancelWithNoChanges()})))}},{hotkey:"CTRL+X",action:function(){n.app.clipboard.isClipboardSet&&(n.app.memento.isLocked||n.app.memento.perform({delete:n.app.document.selectedElements,action:function(){return n.app.clipboard.cut(),null}}))}},{hotkey:"SHIFT+D",action:function(){0<n.app.document.selectedElements.length&&(n.app.memento.isLocked||n.app.memento.perform({action:function(){return n.app.document.actions.create.duplicateSelected(),{created:n.app.document.selectedElements}}}))}},{hotkey:"CTRL+Z",action:function(){n.app.memento.isUndoPossible&&n.app.memento.undo()}},{hotkey:"CTRL+SHIFT+Z",action:function(){n.app.memento.isRedoPossible&&n.app.memento.redo()}},{hotkey:"CTRL+Y",action:function(){n.app.memento.isRedoPossible&&n.app.memento.redo()}},{hotkey:"CTRL+A",action:function(){n.app.document.actions.select.selectAll()}},{hotkey:"CTRL+D",action:function(){n.app.document.actions.select.deselectAll()}},{hotkey:"CTRL+G",action:function(){2<=n.app.document.selectedElements.length&&(n.app.memento.isLocked||n.app.memento.perform({delete:n.app.document.selectedElements,action:function(){return{created:[n.app.document.actions.group.groupSelected()]}}}))}},{hotkey:"CTRL+U",action:function(){var e=n.app.document.selectedElements.filter(function(e){return e instanceof s.Doc.Group});0<e.length&&(n.app.memento.isLocked||n.app.memento.perform({delete:e,action:function(){var t=[];return e.forEach(function(e){n.app.document.actions.group.ungroup(e),t=t.concat(n.app.document.selectedElements.slice(0))}),n.app.document.actions.select.deselectAll(),t.forEach(function(e){return n.app.document.actions.select.selectElement(e)}),{created:t}}}))}},{hotkey:"CTRL+SHIFT+U",action:function(){var e=n.app.document.selectedElements.filter(function(e){return e instanceof s.Doc.Group});0<e.length&&(n.app.memento.isLocked||n.app.memento.perform({delete:e,action:function(){var t=[];return e.forEach(function(e){n.app.document.actions.group.ungroupDeep(e),t=t.concat(n.app.document.selectedElements.slice(0))}),n.app.document.actions.select.deselectAll(),t.forEach(function(e){return n.app.document.actions.select.selectElement(e)}),{created:t}}}))}},{hotkey:"PAGEUP",action:function(){0<n.app.document.selectedElements.length&&(n.app.memento.isLocked||n.app.memento.perform({arrange:n.app.document.selectedElements,action:function(){return n.app.document.actions.arrange.bringSelectedForward(),null}}))}},{hotkey:"PAGEDOWN",action:function(){0<n.app.document.selectedElements.length&&(n.app.memento.isLocked||n.app.memento.perform({arrange:n.app.document.selectedElements,action:function(){return n.app.document.actions.arrange.bringSelectedBackward(),null}}))}},{hotkey:"HOME",action:function(){0<n.app.document.selectedElements.length&&(n.app.memento.isLocked||n.app.memento.perform({arrange:n.app.document.selectedElements,action:function(){return n.app.document.actions.arrange.bringSelectedFront(),null}}))}},{hotkey:"END",action:function(){0<n.app.document.selectedElements.length&&(n.app.memento.isLocked||n.app.memento.perform({arrange:n.app.document.selectedElements,action:function(){return n.app.document.actions.arrange.bringSelectedBack(),null}}))}},{hotkey:"CTRL+S",action:function(){n.app.document.isSaved||n.app.file.save()}},{hotkey:"=",action:function(){var e=n.app.window.canvas;e.zoom(e.domElement.offsetWidth/2,e.domElement.offsetHeight/2,!0)}},{hotkey:"NUM+",action:function(){var e=n.app.window.canvas;e.zoom(e.domElement.offsetWidth/2,e.domElement.offsetHeight/2,!0)}},{hotkey:"-",action:function(){var e=n.app.window.canvas;e.zoom(e.domElement.offsetWidth/2,e.domElement.offsetHeight/2,!1)}},{hotkey:"NUM-",action:function(){var e=n.app.window.canvas;e.zoom(e.domElement.offsetWidth/2,e.domElement.offsetHeight/2,!1)}}]}s.KeyController=t;var a={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",18:"ALT",27:"ESCAPE",32:"SPACE",33:"PAGEUP",34:"PAGEDOWN",35:"END",36:"HOME",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN",45:"INSERT",46:"DELETE",91:"CMD",106:"NUM*",107:"NUM+",109:"NUM-",110:"NUMDEL",111:"NUM/",187:"=",189:"-",219:"[",221:"]"}}(Inker=Inker||{}),function(p){var o,e=(o=p.Controller,__extends(i,o),i.prototype.onDocumentChanged=function(){var e;this.app.document?(e=this.docCopies[this.app.document.id],this.isRedoPossible=e.index<e.copies.length-1,this.isUndoPossible=0<e.index):(this.isRedoPossible=!1,this.isUndoPossible=!1)},i.prototype.perform=function(t){var n=new r(this,t,this.app.document);try{var e=t.action();n.afterAction(e)}catch(e){n.cancelWithNoChanges(),t.onError?t.onError(e):this.app.message.error(e.message)}},i.prototype.beforeAction=function(e){return new r(this,e||{},this.app.document)},i.prototype._addCopy=function(e,t,n,o){var r=this.docCopies[o.id];r.index<r.copies.length-1&&(r.copies.splice(r.index+1),this.isRedoPossible=!1),r.copies.length===i.MaxUndoCount&&(r.copies.shift(),r.index--),r.copies.push({actions:e,selectedIPsBefore:t,selectedIPsAfter:n}),r.index++,this.isUndoPossible=!0,o.isSaved=!1},i.prototype.undo=function(){var e=this.app.document,e=this.docCopies[e.id];if(e.index<0)throw new Error("Undo is not possible.");this.onBeforeUndo.invoke({}),this.revertCopy(e.copies[e.index]),e.index--,this.isRedoPossible=!0,this.isUndoPossible=0<=e.index,this._locker=null},i.prototype.revertCopy=function(e){var o=this,r=[],i=[],s=this.app.document;e.actions.forEach(function(t){switch(t.action){case"prop":for(var e in t.props)s[e]=t.props[e].before;break;case"modify":(n=s.getElementById(t.id))instanceof p.Doc.Layer?s.layers[s.layers.indexOf(n)]=o.restoreElement(t.copyBefore):n.parent.children[n.parent.children.indexOf(n)]=o.restoreElement(t.copyBefore);break;case"create":var n;t.parentAfter.id?(n=s.getElementById(t.id),s.actions.remove.removeElement(n)):(n=s.layers.filter(function(e){return e.id===t.id})[0],s.actions.layer.setCurrent(n),s.actions.layer.removeCurrent());break;case"delete":i.push({el:o.restoreElement(t.copyBefore),parentBefore:t.parentBefore});break;case"arrange":r.push({el:s.getElementById(t.id),parentBefore:t.parentBefore,parentAfter:t.parentAfter});break;default:throw new Error('Unknown action "'+t.action+'".')}});var a=new xp.Dictionary,l=[];if(i.concat(r).forEach(function(e){var t,n;e.parentBefore.id?(t=s.getElementById(e.parentBefore.id),(n=a.get(t))||(n=[],a.set(t,n)),n.push({el:e.el,index:e.parentBefore.index})):l.push({layer:e.el,index:e.parentBefore.index})}),a.pairs.forEach(function(e){e.value.sort(function(e,t){return e.index>t.index?1:e.index<t.index?-1:0})}),l.sort(function(e,t){return e.index>t.index?1:e.index<t.index?-1:0}),0<l.length){l.forEach(function(e){s.layers.indexOf(e.layer)<0&&s.layers.push(e.layer)});for(var t=[],n=0;n<s.layers.length;n++)t.push(n);var c={};l.forEach(function(e){c[e.layer.id]=e.index,t.splice(t.indexOf(e.index),1)}),s.layers.filter(function(t){return 0===l.filter(function(e){return e.layer===t}).length}).forEach(function(e){return c[e.id]=t.shift()}),s.layers.sort(function(e,t){return c[e.id]>c[t.id]?1:c[e.id]<c[t.id]?-1:0}),l.forEach(function(e){if(s.layers.indexOf(e.layer)!==e.index)throw new Error("Item is placed at wrong index.")})}0<a.pairs.length&&a.pairs.forEach(function(e){var t=e.key,n=e.value;n.forEach(function(e){t.children.indexOf(e.el)<0&&(e.el.parent?(e.el.parent.children.detach(e.el.parent.children.indexOf(e.el)),t.children.attach(e.el,t.children.length)):t.children.push(e.el))});for(var o=[],r=0;r<t.children.length;r++)o.push(r);var i={};n.forEach(function(e){i[e.el.id]=e.index,o.splice(o.indexOf(e.index),1)}),t.children.filter(function(t){return 0===n.filter(function(e){return e.el===t}).length}).forEach(function(e){return i[e.id]=o.shift()}),t.children.sort(function(e,t){return i[e.id]>i[t.id]?1:i[e.id]<i[t.id]?-1:0}),n.forEach(function(e){if(t.children.indexOf(e.el)!==e.index)throw new Error("Item is placed at wrong index.")})}),s.actions.select.deselectAll(),e.selectedIPsBefore.forEach(function(e){return s.actions.select.selectElement(s.getElement(e))})},i.prototype.redo=function(){var o=this,r=this.app.document,e=this.docCopies[r.id];if(e.index++,e.index>e.copies.length-1)throw e.index--,new Error("Redo is not possible.");var i=[],s=[];e.copies[e.index].actions.forEach(function(t){switch(t.action){case"prop":for(var e in t.props)r[e]=t.props[e].after;break;case"modify":(n=r.getElementById(t.id))instanceof p.Doc.Layer?r.layers[r.layers.indexOf(n)]=o.restoreElement(t.copyAfter):n.parent.children[n.parent.children.indexOf(n)]=o.restoreElement(t.copyAfter);break;case"create":(n=o.restoreElement(t.copyAfter))instanceof p.Doc.Layer&&(r.currentLayer=n),s.push({el:n,parentAfter:t.parentAfter});break;case"delete":var n;t.parentBefore.id?(n=r.getElementById(t.id),r.actions.remove.removeElement(n)):(n=r.layers.filter(function(e){return e.id===t.id})[0],r.actions.layer.setCurrent(n),r.actions.layer.removeCurrent());break;case"arrange":i.push({el:r.getElementById(t.id),parentBefore:t.parentBefore,parentAfter:t.parentAfter});break;default:throw new Error('Unknown action "'+t.action+'".')}});var a=new xp.Dictionary,l=[];if(s.concat(i).forEach(function(e){var t,n;e.parentAfter.id?(t=r.getElementById(e.parentAfter.id),(n=a.get(t))||(n=[],a.set(t,n)),n.push({el:e.el,index:e.parentAfter.index})):l.push({layer:e.el,index:e.parentAfter.index})}),a.pairs.forEach(function(e){e.value.sort(function(e,t){return e.index>t.index?1:e.index<t.index?-1:0})}),l.sort(function(e,t){return e.index>t.index?1:e.index<t.index?-1:0}),0<l.length){l.forEach(function(e){r.layers.indexOf(e.layer)<0&&r.layers.push(e.layer)});for(var t=[],n=0;n<r.layers.length;n++)t.push(n);var c={};l.forEach(function(e){c[e.layer.id]=e.index,t.splice(t.indexOf(e.index),1)}),r.layers.filter(function(t){return 0===l.filter(function(e){return e.layer===t}).length}).forEach(function(e){return c[e.id]=t.shift()}),r.layers.sort(function(e,t){return c[e.id]>c[t.id]?1:c[e.id]<c[t.id]?-1:0}),l.forEach(function(e){if(r.layers.indexOf(e.layer)!==e.index)throw new Error("Item is placed at wrong index.")})}0<a.pairs.length&&a.pairs.forEach(function(e){var t=e.key,n=e.value;n.forEach(function(e){t.children.indexOf(e.el)<0&&(e.el.parent?(e.el.parent.children.detach(e.el.parent.children.indexOf(e.el)),t.children.attach(e.el,t.children.length)):t.children.push(e.el))});for(var o=[],r=0;r<t.children.length;r++)o.push(r);var i={};n.forEach(function(e){i[e.el.id]=e.index,o.splice(o.indexOf(e.index),1)}),t.children.filter(function(t){return 0===n.filter(function(e){return e.el===t}).length}).forEach(function(e){return i[e.id]=o.shift()}),t.children.sort(function(e,t){return i[e.id]>i[t.id]?1:i[e.id]<i[t.id]?-1:0}),n.forEach(function(e){if(t.children.indexOf(e.el)!==e.index)throw new Error("Item is placed at wrong index.")})}),r.actions.select.deselectAll(),e.copies[e.index].selectedIPsAfter.forEach(function(e){return r.actions.select.selectElement(r.getElement(e))}),this.isUndoPossible=!0,this.isRedoPossible=e.index<e.copies.length-1},i.prototype.restoreElement=function(e){var t=p.Json.deserialize(p.Json.serialize(e)),o=function(e,t){if(e.id=t.id,t instanceof p.Doc.Container)for(var n=0;n<t.children.length;n++)o(e.children[n],t.children[n])};return o(t,e),t},i.prototype.getRoughSize=function(e){for(var t=[],n=[e],o=0;n.length;){var r=n.pop();if("boolean"==typeof r)o+=4;else if("string"==typeof r)o+=2*r.length;else if("number"==typeof r)o+=8;else if("object"==typeof r&&-1===t.indexOf(r))for(var i in t.push(r),r)n.push(r[i])}return o},Object.defineProperty(i.prototype,"isLocked",{get:function(){return this._locker},enumerable:!0,configurable:!0}),i.prototype.lock=function(e){this._locker=e},i.prototype.unlock=function(){this._locker=null},i.MaxUndoCount=20,i);function i(e){var t=this;o.call(this,e),this._locker=null,xp.Model.property(this,"isUndoPossible",!1),xp.Model.property(this,"isRedoPossible",!1),this.docCopies={};function n(e){t.docCopies[e.id]={index:-1,copies:[]}}this.app.documents.onCollectionChanged.addHandler(function(e){e.action===xp.CollectionChangeAction.Create&&n(e.newItem),e.action===xp.CollectionChangeAction.Delete&&delete t.docCopies[e.oldItem.id]}),this.app.documents.forEach(n),new xp.BindingCallManager(e,"document",function(){return t.onDocumentChanged()}),this.onBeforeUndo=new xp.Event}p.MementoController=e;var r=(t.prototype.moreBeforeAction=function(e){var t=this,n=this.doc;e.modify&&0<e.modify.length&&e.modify.forEach(function(e){t.modifyCopies.push({action:"modify",id:e.id,copyBefore:t.cloneElement(e),copyAfter:null})}),e.arrange&&0<e.arrange.length&&e.arrange.forEach(function(e){t.arrangeCopies.push({action:"arrange",id:e.id,parentBefore:t.getParentInfo(e,n),parentAfter:null})}),e.delete&&0<e.delete.length&&e.delete.forEach(function(e){t.deleteCopies.push({action:"delete",id:e.id,parentBefore:t.getParentInfo(e,n),copyBefore:t.cloneElement(e)})}),e.props&&0<e.props.length&&e.props.forEach(function(e){t.propsCopy.props[e]={before:t.cloneElement(n[e]),after:null}}),this.selectedIPsBefore=n.selectedElements.map(function(e){return n.getIndexPath(e)})},t.prototype.afterAction=function(e){var n=this;if(this.done)throw new Error("Already memorized.");this.memento.unlock();var t=this.before;e=e||{};var o=this.doc;e.created&&0<e.created.length&&(this.createCopies=[],e.created.forEach(function(e){n.createCopies.push({action:"create",id:e.id,parentAfter:n.getParentInfo(e,o),copyAfter:n.cloneElement(e)})})),t.modify&&0<t.modify.length&&t.modify.forEach(function(e,t){n.modifyCopies[t].copyAfter=n.cloneElement(e)}),t.arrange&&0<t.arrange.length&&t.arrange.forEach(function(e,t){n.arrangeCopies[t].parentAfter=n.getParentInfo(e,o)}),t.props&&0<t.props.length&&t.props.forEach(function(e){n.propsCopy.props[e].after=n.cloneElement(o[e])}),this.selectedIPsAfter=o.selectedElements.map(function(e){return o.getIndexPath(e)});t=[];this.modifyCopies&&(t=t.concat(this.modifyCopies)),this.arrangeCopies&&(t=t.concat(this.arrangeCopies)),this.deleteCopies&&(t=t.concat(this.deleteCopies)),this.createCopies&&(t=t.concat(this.createCopies)),this.propsCopy&&this.propsCopy.props&&0<Object.keys(this.propsCopy.props).length&&t.push(this.propsCopy),0<t.length&&this.memento._addCopy(t,this.selectedIPsBefore,this.selectedIPsAfter,this.doc),this.done=!0},t.prototype.cancelWithNoChanges=function(){this.memento.unlock(),this.done=!0},t.prototype.cancelWithRestore=function(){if(this.done)throw new Error("Already memorized.");this.memento.unlock();var e=[];this.modifyCopies&&(e=e.concat(this.modifyCopies)),this.arrangeCopies&&(e=e.concat(this.arrangeCopies)),this.deleteCopies&&(e=e.concat(this.deleteCopies)),this.createCopies&&(e=e.concat(this.createCopies)),this.propsCopy&&this.propsCopy.props&&0<Object.keys(this.propsCopy.props).length&&e.push(this.propsCopy),0<e.length&&this.memento.revertCopy({actions:e,selectedIPsBefore:this.selectedIPsBefore,selectedIPsAfter:this.selectedIPsAfter}),this.done=!0},t.prototype.cloneElement=function(e){e instanceof p.Doc.Curve&&e.writePath(),e instanceof p.Doc.Container&&p.Doc.cascadeElements(e.children,function(e){e instanceof p.Doc.Curve&&e.writePath()});var t=p.Json.deserialize(p.Json.serialize(e));if(t.id=e.id,e instanceof p.Doc.Container){var n=[],o=[];p.Doc.cascadeElements(e.children,function(e){n.push(e)}),p.Doc.cascadeElements(t.children,function(e){o.push(e)});for(var r=0;r<n.length;r++)o[r].id=n[r].id}return t},t.prototype.getParentInfo=function(e,t){return{id:e.parent?e.parent.id:void 0,index:(e.parent?e.parent.children:t.layers).indexOf(e)}},t);function t(e,t,n){if(this.modifyCopies=[],this.arrangeCopies=[],this.deleteCopies=[],this.createCopies=[],this.propsCopy={action:"prop",props:{}},this.done=!1,this.memento=e,this.before=t,this.doc=n,e.isLocked)throw new Error("Memento is locked.");e.lock(this),this.moreBeforeAction(t)}p.ActionWriter=r}(Inker=Inker||{}),function(t){var n,e=(n=t.Controller,__extends(o,n),o.prototype.error=function(e){this.show(e,"error",null,!1)},o.prototype.warn=function(e){this.show(e,"warn",null,!0)},o.prototype.info=function(e){this.show(e,"info",null,!0)},o.prototype.dialog=function(e,t){this.show(e,"info",t,!1)},o.prototype.blockingDialog=function(e,t,n){xp.MessageBox.show(e,t,n)},o.prototype.log=function(e){this.show(e,"log",null,!0)},o.prototype.show=function(e,t,n,o){this.messageListElement.showMessage(e,t,n,o),this.messages.push({message:e,type:t||"unknown",time:Date.now()})},o);function o(e){n.call(this,e),this.messages=[],this.messageListElement=new t.UI.MessageList(e)}t.MessageController=e}(Inker=Inker||{}),function(e){var r,i={document:{width:800,height:600,dimension:"px"},drawTool:{jitter:4},help:{displayTips:!0},markers:{size:12},panels:{objectBrowserCollapsed:!1},snap:{anglesDeg:[0,90],distance:16,on:!0,visible:!0,pixels:!1}},t=(r=e.Controller,__extends(n,r),n.prototype.setDefaultSettings=function(){this.applySettings(i)},n.prototype.applySettings=function(e){var t=this;this.bindings.forEach(function(e){return e.unbind()}),this.bindings.splice(0);var n,o=!0;for(n in e){var r=xp.observable(e[n]);this[n]=r;for(var i in r){var s=new xp.BindingCallManager(this,n+"."+i,function(){o||t.saveSettings()});this.bindings.push(s)}}o=!1},n.prototype.saveSettings=function(){var e;this.app.platform.isChromeApp?chrome.storage.sync.set({settings:this}):(e=JSON.stringify(this),window.localStorage.setItem("settings",e))},n);function n(e){var a=this;if(r.call(this,e),xp.Model.nonEnumerableField(this,"bindings",[]),e.platform.isChromeApp)chrome.storage.sync.get({settings:i},function(e){var t,n=e.settings;for(t in n)for(var o in n[t]){var r,i,s=n[t][o];"object"!=typeof s||0<(r=Object.keys(s)).length&&r.every(function(e){return!isNaN(+e)})&&(i=[],r.forEach(function(e){return i[+e]=s[e]}),n[t][o]=i)}a.applySettings(n)});else{var e=window.localStorage.getItem("settings")||"{}",t=JSON.parse(e);if(t){for(var n in i)for(var o in n in t||(t[n]={}),i[n])o in t[n]||(t[n][o]=i[n][o]);this.applySettings(t)}else this.setDefaultSettings()}}e.SettingsController=t}(Inker=Inker||{}),function(p){!function(n){var t=0;var o,Ruler=(o=xp.Model,__extends(e,o),e);function e(e){o.call(this),xp.Model.property(this,"name",e),xp.Model.nonEnumerableField(this,"parent"),xp.Model.nonEnumerableField(this,"id",(++t).toString())}n.Element=Ruler;var r,i=(__extends(s,r=Ruler),s);function s(e){var t=this;r.call(this,e),xp.Model.property(this,"children",new xp.ObservableCollection),xp.Model.property(this,"isExpanded",!0),new xp.BindingCallManager(this,"children",function(e){t.children.forEach(function(e){return e.parent=t}),t.children.onCollectionChanged.addHandler(function(e){e.action!==xp.CollectionChangeAction.Create&&e.action!==xp.CollectionChangeAction.Attach||(e.newItem.parent=t),e.action!==xp.CollectionChangeAction.Delete&&e.action!==xp.CollectionChangeAction.Detach||(e.oldItem.parent=null),e.action===xp.CollectionChangeAction.Replace&&(e.oldItem.parent=null,e.newItem.parent=t)},t)})}var Image=function(e){function Group(){e.apply(this,arguments)}return __extends(Group,e),Group}(n.Container=i);n.Group=Image;Image=function(t){function Layer(e){t.call(this,e),xp.Model.property(this,"locked",!1),xp.Model.property(this,"hidden",!1)}return __extends(Layer,t),Layer}(i);n.Layer=Image;var a,i=(__extends(l,a=Ruler),l.prototype.getBBox=function(){throw new Error("Unable to get bounding box of an abstract element.")},l.prototype.move=function(e,t){throw new Error("Unable to move an abstract element.")},l.prototype.scale=function(e,t){throw new Error("Unable to scale an abstract element.")},l.prototype.rotate=function(e,t){throw new Error("Unable to rotate an abstract element.")},l);function l(e){a.call(this,e),xp.Model.property(this,"fill",xp.observable({color:"transparent",gradient:null})),xp.Model.property(this,"stroke",xp.observable({color:"#222",width:2})),xp.Model.property(this,"opacity",1),xp.Model.property(this,"hasStroke",!1,{enumerable:!1});e=new xp.Expression('!({stroke.color} === "" || {stroke.color} === "transparent" || {stroke.width} === 0)',this);new xp.BindingManager(this,"hasStroke",e,"result")}Image=function(t){function Image(e){t.call(this,e),xp.Model.property(this,"left"),xp.Model.property(this,"top"),xp.Model.property(this,"width"),xp.Model.property(this,"height"),xp.Model.property(this,"url")}return __extends(Image,t),Image.prototype.getBBox=function(){return{left:this.left,top:this.top,width:this.width,height:this.height}},Image.prototype.move=function(e,t){this.left=e,this.top=t},Image.prototype.scale=function(e,t){var n=this.getBBox();t=t||n,this.left=(n.left-t.left)/t.width*e.width+e.left,this.top=(n.top-t.top)/t.height*e.height+e.top,this.width=n.width/t.width*e.width,this.height=n.height/t.height*e.height},Image.prototype.rotate=function(e,t){throw new Error("Unable to rotate image.")},Image}(n.Drawing=i);n.Image=Image;i=function(t){function Text(e){t.call(this,e),xp.Model.property(this,"x"),xp.Model.property(this,"y"),xp.Model.property(this,"content",""),xp.Model.property(this,"font",xp.observable({family:"sans-serif",weight:c.Normal,size:32,isItalic:!1,anchor:n.TextAnchor.Middle}))}return __extends(Text,t),Text.prototype.getBBox=function(){var n=this,e=p.Svg.create("svg"),o=p.Svg.create("text");this.content.split("\n").forEach(function(e,t){t=p.Svg.create("tspan",{x:n.x,dy:0<t?n.font.size/3*4:0});t.textContent=e||"&nbsp;",o.appendChild(t)}),p.Svg.setAttributes(o,{x:this.x,y:this.y,"font-size":this.font.size,"font-family":this.font.family,"font-style":this.font.isItalic?"italic":"normal","font-weight":this.font.weight,"text-anchor":this.font.anchor}),e.appendChild(o),e.style.position="absolute",document.body.appendChild(e);var t=o.getBBox();return document.body.removeChild(e),{left:(0===t.width?this:t).x,top:0===t.height?this.y-this.font.size:t.y,width:0===t.width?1:t.width,height:0===t.height?4*this.font.size/3:t.height}},Text.prototype.move=function(e,t){var n=this.getBBox();this.x=this.x-n.left+e,this.y=this.y-n.top+t},Text.prototype.scale=function(e,t){var n=this.getBBox();t=t||n,e.width<0&&(e.left=e.left+e.width,e.width=-e.width),e.height<0&&(e.top=e.top+e.height,e.height=-e.height),this.x=(this.x-t.left)/t.width*e.width+e.left,this.y=(this.y-t.top)/t.height*e.height+e.top,this.font.size=this.font.size/t.height*Math.abs(e.height)},Text.prototype.rotate=function(e,t){throw new Error("Unable to rotate text. Convert to curve first.")},Text.prototype.getLines=function(){var r=this,i=[];return this.content.split("\n").forEach(function(e,t){var n,o=new Text("Line");for(n in r.fill)o.fill[n]=r.fill[n];for(n in r.stroke)o.stroke[n]=r.stroke[n];for(n in r.font)o.font[n]=r.font[n];o.x=r.x,o.y=r.y+r.font.size*t*4/3,o.content=e,i.push(o)}),i},Text}(i);n.Text=i,(i=n.FontWeight||(n.FontWeight={}))[i.Light=300]="Light",i[i.Normal=400]="Normal",i[i.Bold=700]="Bold";var c=n.FontWeight;n.TextAnchor={Left:"end",Middle:"middle",Right:"start"};Ruler=function(e){function Ruler(){e.call(this),xp.Model.property(this,"x",0),xp.Model.property(this,"y",0),xp.Model.property(this,"a",0),xp.Model.property(this,"isTemp",!1)}return __extends(Ruler,e),Ruler.prototype.getDistance=function(e,t){var n=this.x,o=this.y,r=this.a,i=n+Math.cos(r),r=o+Math.sin(r);return Math.abs((r-o)*e-(i-n)*t+i*o-r*n)/Math.sqrt((r-o)*(r-o)+(i-n)*(i-n))},Ruler.prototype.getClosestPoint=function(e,t){var n=this.a;return Geo.getLinesIntersection({x:this.x,y:this.y},{x:this.x+Math.cos(n),y:this.y+Math.sin(n)},{x:e,y:t},{x:e+Math.cos(n+Math.PI/2),y:t+Math.sin(n+Math.PI/2)},!0)},Ruler}(Ruler);n.Ruler=Ruler}(p.Doc||(p.Doc={}))}(Inker=Inker||{}),function(n){!function(h){var e=function(i){function Curve(e){var n=this;i.call(this,e),xp.Model.property(this,"paths",new xp.ObservableCollection,{enumerable:!1}),Object.defineProperty(this,"path",{value:[],enumerable:!0,configurable:!0,writable:!0});xp.Model.property(this,"svgPath","",{enumerable:!1}),xp.Model.property(this,"isClosed",!1,{enumerable:!1});function o(){n.isClosed=n.paths.every(function(e){return e.isClosed})}function r(e){"isClosed"===e&&o()}function t(){n.paths.forEach(function(e){e.curve=n,e.onPropertyChanged.hasHandler(r)&&e.onPropertyChanged.removeHandler(r),e.onPropertyChanged.addHandler(r,n)}),o(),n.paths.onCollectionChanged.addHandler(function(e){var t;e.action!==xp.CollectionChangeAction.Create&&e.action!==xp.CollectionChangeAction.Attach&&e.action!==xp.CollectionChangeAction.Replace||((t=e.newItem).curve=n,o(),t.onPropertyChanged.hasHandler(r)&&t.onPropertyChanged.removeHandler(r),t.onPropertyChanged.addHandler(r,n)),e.action!==xp.CollectionChangeAction.Delete&&e.action!==xp.CollectionChangeAction.Detach||o()},n)}this.onPropertyChanged.addHandler(function(e){"paths"===e&&t()},this),t()}return __extends(Curve,i),Curve.prototype.updateSvgPath=function(){this.svgPath=this.paths.map(function(e){return e.getSvgPath()}).join(" ")},Curve.prototype.getBBox=function(){var t=[],n=[],o=[],r=[];this.paths.forEach(function(e){0===e.segments.length?(t.push(e.points[0].x),n.push(e.points[0].y),o.push(e.points[0].x),r.push(e.points[0].y)):e.segments.forEach(function(e){e.type===d.Straight?(t.push(Math.min(e.points[0].x,e.points[1].x)),n.push(Math.min(e.points[0].y,e.points[1].y)),o.push(Math.max(e.points[0].x,e.points[1].x)),r.push(Math.max(e.points[0].y,e.points[1].y))):(t.push(Geo.Bezier.minBezier3(e.points[0].x,e.points[1].x,e.points[2].x,e.points[3].x)),n.push(Geo.Bezier.minBezier3(e.points[0].y,e.points[1].y,e.points[2].y,e.points[3].y)),o.push(Geo.Bezier.maxBezier3(e.points[0].x,e.points[1].x,e.points[2].x,e.points[3].x)),r.push(Geo.Bezier.maxBezier3(e.points[0].y,e.points[1].y,e.points[2].y,e.points[3].y)))})});var e=Math.min.apply(null,t),i=Math.min.apply(null,n);return{left:e,top:i,width:Math.max.apply(null,o)-e,height:Math.max.apply(null,r)-i}},Curve.prototype.move=function(e,t){var n=this.getBBox(),o=e-n.left,r=t-n.top;this.paths.forEach(function(e){e.points.forEach(function(e){e.x+=o,e.y+=r}),e.updateSegments()}),this.updateSvgPath(),this.fill.gradient&&(n=this.fill.gradient,this.fill.gradient.start={x:n.start.x+o,y:n.start.y+r},this.fill.gradient.end={x:n.end.x+o,y:n.end.y+r})},Curve.prototype.scale=function(t,n){var e,o;n=n||this.getBBox(),this.paths.forEach(function(e){e.points.forEach(function(e){Path.scalePoint(e,t,n)}),e.updateSegments()}),this.updateSvgPath(),this.fill.gradient&&(e=this.fill.gradient,o=function(e,t,n){var o=0===t.width&&0===n.width?1:0===t.width||0===n.width?0:t.width/n.width,r=0===t.height&&0===n.height?1:0===t.height||0===n.height?0:t.height/n.height;return{x:t.left+(e.x-n.left)*o,y:t.top+(e.y-n.top)*r}},this.fill.gradient.start=o(e.start,t,n),this.fill.gradient.end=o(e.end,t,n))},Curve.prototype.rotate=function(t,n){var e,o;this.paths.forEach(function(e){e.points.forEach(function(e){Path.rotatePoint(e,t,n)}),e.updateSegments()}),this.updateSvgPath(),this.fill.gradient&&(e=this.fill.gradient,o=function(e,t,n){return Geo.placePoint(t,Geo.getLength(e,t),Geo.getAngle(t,e)+n)},this.fill.gradient.start=o(e.start,t,n),this.fill.gradient.end=o(e.end,t,n))},Curve.prototype.strokeToPath=function(l){var r,c,t=this;function p(e,t,n){var o="number"==typeof e.force?r*e.force:r;return e.type===h.PointType.Smooth||void 0===t||void 0===n||(n=Geo.getQ(t,n),o*=Geo.Bezier.bezier3(n/Math.PI,1,1.25,1.5,4)),o}this.hasStroke&&(r=this.stroke.width,c=[],this.paths.forEach(function(i){i.updateSegments();var e,t,n,o,r,s=new Path,a=new Path;i.segments.forEach(function(e){var t,n=i.pointBefore(e);t=n.type!==u.Smooth&&i.segmentBefore(e)?(t=n.a||Geo.getAngle(e.points[0],e.points[1]),r=i.segmentBefore(e),o=n.ar||Geo.getAngle(r.points[r.points.length-2],r.points[r.points.length-1]),r=Geo.getMidAngle(t,o),p(n,t,o)/2):(r=n.a||Geo.getAngle(e.points[0],e.points[1]),p(n)/2);var o=Geo.placePoint(n,t,r+Math.PI/2),r=Geo.placePoint(n,t,r-Math.PI/2),o={x:o.x,y:o.y,type:n.type},r={x:r.x,y:r.y,type:n.type};"a"in n&&(o.a=n.a,r.a=n.a),"ar"in n&&(o.ar=n.ar,r.ar=n.ar),s.points.push(o),a.points.push(r),s.segments.push({type:e.type}),a.segments.push({type:e.type})}),i.isClosed?(s.isClosed=!0,t=a.isClosed=!0,a.reverse(),c.push(s,a)):(o=i.segments[i.segments.length-1],r=(n=i.pointAfter(o)).ar||Geo.getAngle(o.points[o.points.length-2],o.points[o.points.length-1]),e=p(n)/2,o=Geo.placePoint(n,e,r+Math.PI/2),r=Geo.placePoint(n,e,r-Math.PI/2),o={x:o.x,y:o.y,type:u.Cusp},r={x:r.x,y:r.y,type:u.Cusp},"ar"in n&&(o.ar=n.ar,r.ar=n.ar),s.points[0].type=u.Cusp,a.points[0].type=u.Cusp,delete s.points[0].ar,delete a.points[0].ar,s.points.push(o),a.points.push(r),a.reverse(),s.segments.push({type:d.Straight}),Array.prototype.push.apply(s.points,a.points),Array.prototype.push.apply(s.segments,a.segments),s.segments.push({type:d.Straight}),s.isClosed=!0,c.push(s),"round"!==l||t||(s.updateSegments(),n=s.points.length,t=s.segmentBefore(s.points[0]),n=s.segmentBefore(s.points[n/2]),o=Geo.placePoint(Geo.getMidPoint(t.points[0],t.points[1]),Geo.getLength(t.points[0],t.points[1])/2,Geo.getAngle(t.points[0],t.points[1])+Math.PI/2),r=Geo.placePoint(Geo.getMidPoint(n.points[0],n.points[1]),Geo.getLength(n.points[0],n.points[1])/2,Geo.getAngle(n.points[0],n.points[1])+Math.PI/2),s.insertPoint(t,o.x,o.y,h.PointType.Smooth),s.insertPoint(n,r.x,r.y,h.PointType.Smooth)))}),this.paths.splice(0),c.forEach(function(e){return t.paths.push(e)}),n.BooleanOperations.removeSelfIntersections(this),this.updateSvgPath(),this.fill.color=this.stroke.color,this.stroke.color="transparent")},Curve.prototype.writePath=function(){var n,o,r=[];this.paths.forEach(function(e){r.push("P");for(var t=0;t<e.points.length;t++){switch(n=e.points[t],o=e.segments[t],n.type){case u.Cusp:r.push("c");break;case u.Smooth:r.push("s");break;default:throw new Error("Not implemented.")}if(r.push(n.x),r.push(n.y),"a"in n&&(r.push("a"),r.push(n.a)),"ar"in n&&(r.push("ar"),r.push(n.ar)),t<e.points.length-1||e.isClosed)switch(o.type){case d.Straight:r.push("S");break;case d.Curve:r.push("C");break;default:throw new Error("Not implemented.")}}}),this.path=r},Curve.prototype.readPath=function(){this.paths.splice(0);for(var e,t,n=this.path,o=0;o<n.length;)"P"===n[o]?(e&&(e.points.length===e.segments.length&&(e.isClosed=!0),this.paths.push(e)),e=new Path,o++):"C"===n[o]||"S"===n[o]?(t={type:"C"===n[o]?d.Curve:d.Straight},e.segments.push(t),o++):"c"!==n[o]&&"s"!==n[o]||(t={type:"c"===n[o]?u.Cusp:u.Smooth,x:n[++o],y:n[++o]},"a"===n[++o]&&(o++,t.a=n[o],o++),"ar"===n[o]&&(o++,t.ar=n[o],o++),e.points.push(t));e&&(e.points.length===e.segments.length&&(e.isClosed=!0),this.paths.push(e))},Curve}(h.Drawing);h.Curve=e;var Path=function(e){function Path(){e.call(this),this.points=[],this.segments=[],xp.Model.property(this,"isClosed",!1),xp.Model.nonEnumerableField(this,"curve")}return __extends(Path,e),Path.prototype.hasPoint=function(e){return 0<=this.points.indexOf(e)},Path.prototype.hasSegment=function(e){return 0<=this.segments.indexOf(e)},Path.prototype.assertHasPoint=function(e){if(!this.hasPoint(e))throw new Error("The point doesn't belong to a path.")},Path.prototype.assertHasSegment=function(e){if(!this.hasSegment(e))throw new Error("The segment doesn't belong to a path.")},Path.prototype.pointAfter=function(e){if("x"in e&&"y"in e){var t=e;return this.assertHasPoint(t),(t=this.points.indexOf(t))===this.points.length-1?this.isClosed?this.points[0]:null:this.points[t+1]}this.assertHasSegment(e);t=this.segments.indexOf(e);return this.pointAfter(this.points[t])},Path.prototype.pointBefore=function(e){if("x"in e&&"y"in e){var t=e;return this.assertHasPoint(t),0===(t=this.points.indexOf(t))?this.isClosed?this.points[this.points.length-1]:null:this.points[t-1]}this.assertHasSegment(e);t=this.segments.indexOf(e);return this.points[t]},Path.prototype.segmentAfter=function(e){if("x"in e&&"y"in e){var t=e;return this.assertHasPoint(t),(t=this.points.indexOf(t))!==this.points.length-1||this.isClosed?this.segments[t]:null}return this.assertHasSegment(e),(t=this.segments.indexOf(e))===this.segments.length-1?this.isClosed?this.segments[0]:null:this.segments[t+1]},Path.prototype.segmentBefore=function(e){var t,n;return 0===(n="x"in e&&"y"in e?(t=e,this.assertHasPoint(t),this.points.indexOf(t)):(n=e,this.assertHasSegment(n),this.segments.indexOf(n)))?this.isClosed?this.segments[this.segments.length-1]:null:this.segments[n-1]},Path.prototype.addPoint=function(e,t,n,o){if(this.isClosed)throw new Error("Path must be open.");o={x:e,y:t,type:n,force:"number"==typeof o?o:1};this.points.push(o),1<this.points.length&&(o={type:this.pointBefore(o).type===u.Cusp&&o.type===u.Cusp?d.Straight:d.Curve},this.segments.push(o),this.onSegmentTypeChange(o))},Path.prototype.insertPoint=function(e,t,n,o){this.assertHasSegment(e);var r=this.segments.indexOf(e),n={x:t,y:n,type:o};this.points.splice(r+1,0,n);o={type:n.type===u.Cusp&&this.pointAfter(n).type===u.Cusp?d.Straight:d.Curve};return this.segments.splice(r+1,0,o),this.segments[r].type=this.pointBefore(n).type===u.Cusp&&n.type===u.Cusp?d.Straight:d.Curve,this.onPointTypeChange(n),this.onSegmentTypeChange(e),this.onSegmentTypeChange(o),n},Path.prototype.movePoint=function(e,t,n){this.assertHasPoint(e),e.x=t,e.y=n;n=this.segmentBefore(e);n&&n.type===d.Straight&&((o=this.pointBefore(e)).type===u.Smooth&&(o.a=Geo.getAngle(o,e)),e.type===u.Smooth&&(e.a=Geo.getAngle(o,e)));var o=this.segmentAfter(e);o&&o.type===d.Straight&&((o=this.pointAfter(e)).type===u.Smooth&&(o.a=Geo.getAngle(e,o)),e.type===u.Smooth&&(e.a=Geo.getAngle(e,o)))},Path.prototype.convertPoint=function(e,t){this.assertHasPoint(e),t=void 0===t?e.type===u.Cusp?u.Smooth:u.Cusp:t,e.type!==t&&(e.type=t,this.onPointTypeChange(e))},Path.prototype.convertSegment=function(e,t){this.assertHasSegment(e),t=void 0===t?e.type===d.Curve?d.Straight:d.Curve:t,e.type!==t&&(e.type=t,this.onSegmentTypeChange(e))},Path.prototype.removePoint=function(e){if(this.assertHasPoint(e),1===this.points.length)throw new Error("Only one point left, unable to remove.");var t=this.segmentAfter(e),n=this.segmentBefore(e),o=this.pointAfter(e),r=this.pointBefore(e);t&&(this.segments.splice(this.segments.indexOf(t),1),t.type===d.Straight&&o.type===u.Smooth&&delete o.a),!this.pointAfter(e)||3===this.points.length&&this.isClosed?n&&(this.segments.splice(this.segments.indexOf(n),1),n.type===d.Straight&&r.type===u.Smooth&&delete r.a):n&&o&&(r.type===u.Cusp&&o.type===u.Cusp&&(n.type=d.Straight),n.type===d.Straight&&o.type===u.Smooth&&(n.type=d.Curve)),3===this.points.length&&(this.isClosed=!1);var i,e=this.points.indexOf(e);this.points.splice(e,1),r&&(i=this.segmentAfter(r)),i||o&&(i=this.segmentBefore(o)),i&&this.onSegmentTypeChange(i)},Path.prototype.getSubPaths=function(){var n=this,o=[];this.points.forEach(function(e){var t;(t=e).type!==u.Cusp&&n.pointBefore(t)&&n.pointAfter(t)&&n.segmentBefore(t).type!==d.Straight&&n.segmentAfter(t).type!==d.Straight||o.push(e)}),o.sort(function(e,t){e=n.points.indexOf(e),t=n.points.indexOf(t);return t<e?1:e<t?-1:0}),this.isClosed&&0<o.length&&o.push(o[0]);var e=[];if(this.isClosed&&0===o.length)e.push({points:this.points.concat(this.points[0].type===u.Smooth?this.points[0]:JSON.parse(JSON.stringify(this.points[0]))),segments:this.segments});else for(var t=0;t<o.length-1;t++){for(var r=o[t],i=o[t+1],s=[],a=[],l=r;s.push(l),a.push(this.segmentAfter(l)),l=this.pointAfter(l),l!==i;);s.push(r===i?JSON.parse(JSON.stringify(i)):i),e.push({points:s,segments:a})}return e},Path.prototype.close=function(){if(this.isClosed)throw new Error("Path is already closed.");if(this.points.length<3)throw new Error("Path must have at least 3 points before being closed.");this.isClosed=!0,this.segments.push({type:this.points[0].type===u.Cusp&&this.points[this.points.length-1].type===u.Cusp?d.Straight:d.Curve})},Path.prototype.open=function(e){if(!this.isClosed)throw new Error("Path is not closed.");if(e&&!this.hasPoint(e))throw new Error("Point doesn't belong to a path.");var t;e=e||this.points[0],this.segmentBefore(e).type===d.Straight&&((t=this.pointBefore(e)).type===u.Smooth&&delete t.a,e.type===u.Smooth&&delete e.a);for(var n=e,o=[n],r=[],e=this.pointAfter(e);e!==n;e=this.pointAfter(e))o.push(e),r.push(this.segmentBefore(e));this.isClosed=!1,this.points=o,this.segments=r},Path.prototype.reverse=function(){var e;this.points.reverse(),this.segments.reverse(),this.isClosed&&(e=this.points.pop(),this.points.unshift(e)),this.points.forEach(function(e){"a"in e&&(e.a=Geo.ca(e.a+Math.PI)),"ar"in e&&(e.ar=Geo.ca(e.ar+Math.PI))})},Path.prototype.updateSegments=function(){this.getSubPaths().forEach(function(e){var t,n;1===e.segments.length&&e.segments[0].type===d.Straight?e.segments[0].points=[e.points[0],e.points[1]]:(t=e.points[e.points.length-1],isNaN(t.ar)||(e.points[e.points.length-1]={x:t.x,y:t.y,a:t.ar,type:t.type}),n=function(e){if(0===e.length)return[];if(1===e.length)return e;if(2===e.length&&e[0]===e[1])return e.concat([e[0],e[0],e[0],e[0]]);var t=e[0]===e[e.length-1]&&1<e.length;e=e.slice(0);var n=[],o=0,r=!1;for(;o<e.length-1;)e[o].x===e[o+1].x&&e[o].y===e[o+1].y?r?n[n.length-1].length++:(n.push({index:o,length:2}),r=!0):r=!1,o++;for(o=n.length-1;0<=o;o--)0===n[o].index?e.splice(n[o].index+1,n[o].length-1):e.splice(n[o].index,n[o].length-1);if(1===e.length){for(var i=[e[0]],o=0;o<(t?n[0].length:n[0].length-1);o++)i.push(e[0],e[0],e[0]);return i}{var s,a,l,c;t&&(s=e[1],a=e[2],l=e[e.length-2],c=e[e.length-3],e.push(s,a),e.unshift(c,l))}for(var p=[e[0]],o=1;o<e.length;o++){var h=e[o-1],d=e[o];p.push(v(h,d,1/3),v(h,d,2/3),d)}for(o=0;o<4;o++)p=function(e){for(var t=e.slice(0),n=0;n<(e.length-1)/3-1;n++){var o=function(e,t,n,o,r,i,s){r=isNaN(o.a)?function(e,t,n,o,r,i,s){var a=w(o,t,o,i),l=w(t,o,t,i),c=w(i,o,i,t);if(0===l&&0===c)return y(t,i);E(t,o,o,i);var p=g(t,o)/(g(t,o)+g(o,i)),h=1,d=1;d=1-(h=p);l=w(e,t,e,o),c=w(s,i,s,o),e=w(o,n,o,e),s=w(o,r,o,s),l-=e,e=c-s,c=p<.5?1:S(2*(p-.5),1,1,0,.75),s=.5<p?1:S(2*(.5-p),1,1,0,.75);l<0&&(l<-Math.PI/12?h*=c:h*=S(-l/Math.PI*12,1,c,c));e<0&&(e<-Math.PI/12?d*=s:d*=S(-e/Math.PI*12,1,s,s));h=S(S(a/Math.PI,0,.5,1,1,1),.5,h),d=S(S(a/Math.PI,0,.5,1,1,1),.5,d);p<.1&&(h*=S((.1-p)/.1,1,1,1,Math.sin(a/2)));.9<p&&(d*=S((p-.9)/.1,1,1,1,Math.sin(a/2)));d=h/(h+d),d=function(e,t,n){void 0===n&&(n=.5);var o={x:0,y:0},e=k(o,1-n,e),t=k(e,n,t);return y(o,t)}(y(t,o),y(o,i),d);if(isNaN(d))throw new Error("NaN");return d}(e,t,n,o,r,i,s):o.a;return function(e,t,n,o,r,i){Math.sqrt(3-2*Math.SQRT2);var s=function(e,t,n,o){var r=g(e,t),i=g(n,t),e=x(y(t,e),o+Math.PI),n=x(y(t,n),o),o=function(e,t){t=e/(e+t);if(0==t||1==t)throw new Error("Infinity.");return t};if(0===e&&0===n)return 0===r&&0===i?.5:o(r,i);e=Math.sqrt(r*Math.sin(e)),n=Math.sqrt(i*Math.sin(n)),n=e/(e+n);return 0!=n&&1!=n?n:o(r,i)}(t,n,o,i),a=function(e,t,n,o){t={x:(t.x-e.x*(1-o)*(1-o)-n.x*o*o)/(2*(1-o)*o),y:(t.y-e.y*(1-o)*(1-o)-n.y*o*o)/(2*(1-o)*o)};return[v(e,t,o),v(t,n,o)]}(t,n,o,s),l=w(n,a[0],n,e),c=w(n,a[1],n,r),s=w(e,t,e,n),e=w(r,o,r,n),r=g(n,a[0]),a=g(n,a[1]),s=(Math.PI-l-s)/Math.PI,e=(Math.PI-c-e)/Math.PI;s<0&&(s=0);e<0&&(e=0);r*=S(s,1.5,1.3,1.3,1,1,1,1),a*=S(e,1.5,1.3,1.3,1,1,1,1),r>g(t,n)&&(r=g(t,n));a>g(o,n)&&(a=g(o,n));return[k(n,r,i+Math.PI),k(n,a,i)]}(e,t,o,i,s,r)}(e[3*n],e[3*n+1],e[3*n+2],e[3*n+3],e[3*n+4],e[3*n+5],e[3*n+6]);t[3*n+2]=o[0],t[3*n+4]=o[1]}var r=e.length-1,i=isNaN(e[0].a)?NaN:e[0].a,s=isNaN(e[r].ar)?isNaN(e[r].a)?NaN:e[r].a+Math.PI:e[r].ar+Math.PI;{var a,l,c;4===e.length?(a=y(e[2],e[3]),l=y(e[1],e[0]),isNaN(i)?(c=v(e[3],e[2],1.5),t[1]=k(e[0],2*g(e[0],c)/3,y(e[0],c))):t[1]=C(e[0],e[1],e[2],e[3],k(e[3],g(e[2],e[3]),a),k(e[3],g(e[1],e[3]),a-b(a,y(e[1],e[3]))),k(e[3],g(e[0],e[3]),a-b(a,y(e[0],e[3]))),i),isNaN(s)?(c=v(e[0],e[1],1.5),t[2]=k(e[3],2*g(e[3],c)/3,y(e[3],c))):t[2]=C(e[3],e[2],e[1],e[0],k(e[0],g(e[1],e[0]),l),k(e[0],g(e[2],e[0]),l-b(l,y(e[2],e[0]))),k(e[0],g(e[3],e[0]),l-b(l,y(e[3],e[0]))),s)):(t[1]=C(e[0],e[1],e[2],e[3],e[4],e[5],e[6],i),t[r-1]=C(e[r],e[r-1],e[r-2],e[r-3],e[r-4],e[r-5],e[r-6],s))}return t}(p);t&&(p.splice(0,6),p.splice(p.length-6,6));for(o=0;o<n.length;o++)for(var u=n[o],f=3*u.index,m=0;m<3*(u.length-1);m++)p.splice(f,0,{x:p[f].x,y:p[f].y});return p}(e.points),e.segments.forEach(function(e,t){e.points=[n[3*t],n[3*t+1],n[3*t+2],n[3*t+3]]}))})},Path.prototype.getSvgPath=function(){if(0===this.points.length)return"";for(var e="M"+this.points[0].x+","+this.points[0].y,t=0;t<this.segments.length;t++){var n=this.segments[t];n.type===d.Straight&&(e+=xp.formatString(" L{0},{1}",n.points[1].x,n.points[1].y)),n.type===d.Curve&&(e+=xp.formatString(" C{0},{1} {2},{3} {4},{5}",n.points[1].x,n.points[1].y,n.points[2].x,n.points[2].y,n.points[3].x,n.points[3].y))}return this.isClosed&&(e+=" Z"),e},Path.prototype.onPointTypeChange=function(e){var t=this.segmentBefore(e),n=this.pointBefore(e),o=this.segmentAfter(e),r=this.pointAfter(e);e.type===u.Smooth&&t&&o&&t.type===d.Straight&&o.type===d.Straight&&(t.type=o.type=d.Curve,this.onSegmentTypeChange(t),this.onSegmentTypeChange(o)),t&&t.type===d.Straight&&(e.type===u.Smooth?e.a=Geo.getAngle(n,e):delete e.a),o&&o.type===d.Straight&&(e.type===u.Smooth?e.a=Geo.getAngle(e,r):delete e.a),t&&o&&t.type===d.Curve&&o.type===d.Curve&&(delete e.a,delete e.ar),e.type===u.Cusp&&(t&&t.type===d.Curve&&n.type===u.Cusp&&(t.type=d.Straight,this.onSegmentTypeChange(t)),o&&o.type===d.Curve&&r.type===u.Cusp&&(o.type=d.Straight,this.onSegmentTypeChange(o)))},Path.prototype.onSegmentTypeChange=function(e){var t=this.segmentBefore(e),n=this.pointBefore(e),o=this.segmentAfter(e),r=this.pointAfter(e);e.type===d.Curve&&n.type===u.Cusp&&r.type===u.Cusp&&(t&&t.type!==d.Curve||(r.type=u.Smooth,this.onPointTypeChange(r)),o&&o.type!==d.Curve||(n.type=u.Smooth,this.onPointTypeChange(n)),n.type===u.Cusp&&r.type===u.Cusp&&(e.type=d.Straight,this.onSegmentTypeChange(e))),n.type===u.Smooth&&(e.type===d.Straight&&(n.a=Geo.getAngle(n,r)),e.type===d.Curve&&(t&&t.type!==d.Curve||delete n.a)),r.type===u.Smooth&&(e.type===d.Straight&&(r.a=Geo.getAngle(n,r)),e.type===d.Curve&&(o&&o.type!==d.Curve||delete r.a)),e.type===d.Straight&&(n.type===u.Smooth&&t&&t.type===d.Straight&&(n.type=u.Cusp,delete n.a,this.onPointTypeChange(n)),r.type===u.Smooth&&o&&o.type===d.Straight&&(r.type=u.Cusp,delete r.a,this.onPointTypeChange(r))),e.type===d.Straight&&(n.type===u.Cusp&&delete n.a,r.type===u.Cusp&&delete r.a)},Path.scalePoint=function(e,t,n){var o=0===t.width&&0===n.width?1:0===t.width||0===n.width?0:t.width/n.width,r=0===t.height&&0===n.height?1:0===t.height||0===n.height?0:t.height/n.height;e.x=t.left+(e.x-n.left)*o,e.y=t.top+(e.y-n.top)*r,"a"in e&&(e.a=Geo.getAngle({x:0,y:0},{x:Math.cos(e.a)*o,y:Math.sin(e.a)*r})),"ar"in e&&(e.ar=Geo.getAngle({x:0,y:0},{x:Math.cos(e.ar)*o,y:Math.sin(e.ar)*r}))},Path.rotatePoint=function(e,t,n){t=Geo.placePoint(t,Geo.getLength(e,t),Geo.getAngle(t,e)+n);e.x=t.x,e.y=t.y,"a"in e&&(e.a=Geo.ca(e.a+n)),"ar"in e&&(e.ar=Geo.ca(e.ar+n))},Path.prototype.simplify=function(){var c=this,p=Math.PI/4.5,h=Math.PI/60;this.updateSegments(),this.getSubPaths().forEach(function(e){if(2<e.points.length){var t,n=e.points.slice(0),o=[],r=(n[0],n[n.length-1],e.segments.map(function(e){return Math.abs(Geo.getQSPt(e.points[0],e.points[1],e.points[1],e.points[2]))+Math.abs(Geo.getQPt(e.points[1],e.points[2],e.points[2],e.points[3]))})),i=c.isClosed&&e.points.length===c.points.length+1;do{if(i&&4===n.length||2===n.length)break;if(3===n.length){r[0]+r[1]<=2*h&&o.push(n[1]);break}t=!1;for(var s=n.length-2;1<=s;s--){var a=i||1<s?p:p/2,l=i||s<n.length-2?p:p/2;if(r[s-1]+r[s]<=a+l){o.push(n[s]),n.splice(s,1),r.splice(s-1,2,r[s-1]+r[s]),t=!0;break}}}while(n.reverse(),r.reverse(),t);o.forEach(function(e){return c.removePoint(e)})}})},Path}(xp.Model);h.Path=Path,(e=h.SegmentType||(h.SegmentType={}))[e.Straight=0]="Straight",e[e.Curve=1]="Curve";var d=h.SegmentType;(e=h.PointType||(h.PointType={}))[e.Smooth=0]="Smooth",e[e.Cusp=1]="Cusp";var u=h.PointType;function g(e,t){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))}function v(e,t,n){return void 0===n&&(n=.5),{x:e.x+(t.x-e.x)*n,y:e.y+(t.y-e.y)*n}}function y(e,t){var n=t.x-e.x,e=t.y-e.y;return function(e){for(;e>=2*Math.PI;)e-=2*Math.PI;for(;e<0;)e+=2*Math.PI;return e}(Math.atan2(e,n))}function r(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<=-Math.PI;)e+=2*Math.PI;return e}function x(e,t){return t<e&&(t+=2*Math.PI),Math.abs(r(t-e))}function w(e,t,n,o){t=y(e,t),o=y(n,o);return o<t&&(o+=2*Math.PI),Math.abs(r(o-t))}function b(e,t){return t<e&&(t+=2*Math.PI),r(t-e)}function E(e,t,n,o){t=y(e,t),o=y(n,o);return o<t&&(o+=2*Math.PI),r(o-t)}function k(e,t,n){return{x:e.x+t*Math.cos(n),y:e.y+t*Math.sin(n)}}function C(e,t,n,o,r,i,s,a){var l=0<=E(e,o,o,r)?1:-1,c=w(o,t,o,i),i=(c=w(n,t,r,i))<Math.PI/2?l*c/2:l*(Math.PI-c)/2,l=g(e,o),s=g(o,s);i*=s<l?S(2*(l/(l+s)-.5),1,.5,1/3):S(2*(.5-l/(l+s)),1,2/3);c=c<Math.PI/2?.552:S((Math.PI-c)/Math.PI*2,.5,.5,.552);return k(e,g(e,n)*c,isNaN(a)?y(e,o)-i:a)}function S(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(e<0||1<e)throw new Error("Out of range.");for(var o=0,r=t.length-1,i=0;i<=r;i++)o+=t[i]*Math.pow(1-e,r-i)*Math.pow(e,i)*s(r)/s(i)/s(r-i);return Math.round(1e6*o)/1e6}var t=[];function s(e){return 0===e||1===e?1:isNaN(t[e])?t[e]=s(e-1)*e:t[e]}}(n.Doc||(n.Doc={}))}(Inker=Inker||{}),function(l){var c,Document;function s(e,o){var r=function(e){e=e.slice(0);for(var t=0;t<e.length;t++){var n=e[t];o(n),n instanceof c.Container&&r(n.children)}};r(e)}function e(e){if(0===e.length)throw new Error("No drawings specified.");for(var t=e[0].getBBox(),n=t.left,o=t.top,r=t.left+t.width,i=t.top+t.height,s=1;s<e.length;s++){var a=e[s].getBBox();a.left<n&&(n=a.left),a.left+a.width>r&&(r=a.left+a.width),a.top<o&&(o=a.top),a.top+a.height>i&&(i=a.top+a.height)}return{left:n,top:o,width:r-n,height:i-o}}c=l.Doc||(l.Doc={}),Document=function(i){function Document(e,t,n){var a=this;i.call(this,e),this.actions={remove:{removeSelected:function(){for(var e=a.selectedElements.length-1;0<=e;e--){var t=a.selectedElements[e],n=t.parent;n.children.splice(n.children.indexOf(t),1)}a.selectedElements.splice(0)},removeElement:function(e){var t=e.parent;t.children.splice(t.children.indexOf(e),1);e=a.selectedElements.indexOf(e);0<=e&&a.selectedElements.splice(e,1)}},arrange:{appendSelectedTo:function(e){if(!a.isSelectionInsertCorrect(e))throw new Error("Incorrect insert operation.");if(!(e instanceof c.Layer&&e.locked))for(var t=a.selectedElements,n=0;n<t.length;n++)t[n].parent.children.detach(t[n].parent.children.indexOf(t[n])),e.children.attach(t[n],e.children.length)},prependSelectedTo:function(e){if(!(e instanceof c.Layer&&e.locked)){if(!a.isSelectionInsertCorrect(e))throw new Error("Incorrect insert operation.");for(var t=a.selectedElements,n=t.length-1;0<=n;n--)t[n].parent.children.detach(t[n].parent.children.indexOf(t[n])),e.children.attach(t[n],0)}},moveSelectedBefore:function(t){if(!a.isSelectionInsertCorrect(t.parent))throw new Error("Incorrect insert operation.");if(0<=a.selectedElements.indexOf(t))throw new Error("Selected elements cannot be moved before or after selected element.");a.layers[a.getIndexPath(t)[0]].locked||a.selectedElements.forEach(function(e){e.parent.children.detach(e.parent.children.indexOf(e)),t.parent.children.attach(e,t.parent.children.indexOf(t))})},moveSelectedAfter:function(n){if(!a.isSelectionInsertCorrect(n.parent))throw new Error("Incorrect insert operation.");if(0<=a.selectedElements.indexOf(n))throw new Error("Selected elements cannot be moved before or after selected element.");a.layers[a.getIndexPath(n)[0]].locked||a.selectedElements.forEach(function(e,t){e.parent.children.detach(e.parent.children.indexOf(e)),n.parent.children.attach(e,n.parent.children.indexOf(n)+1+t)})},bringSelectedForward:function(){var e=a.getIndexPath(a.selectedElements[a.selectedElements.length-1]),t=a.layers[e[0]];e[1]===t.children.length-1?e[0]<a.layers.length-1?a.actions.arrange.prependSelectedTo(a.layers[e[0]+1]):a.actions.arrange.appendSelectedTo(t):a.actions.arrange.moveSelectedAfter(2<e.length?t.children[e[1]]:t.children[e[1]+1])},bringSelectedBackward:function(){var e=a.getIndexPath(a.selectedElements[0]),t=a.layers[e[0]];0===e[1]?0<e[0]?a.actions.arrange.appendSelectedTo(a.layers[e[0]-1]):a.actions.arrange.prependSelectedTo(t):a.actions.arrange.moveSelectedBefore(2<e.length?t.children[e[1]]:t.children[e[1]-1])},bringSelectedFront:function(){a.actions.arrange.appendSelectedTo(a.layers[a.layers.length-1])},bringSelectedBack:function(){a.actions.arrange.prependSelectedTo(a.layers[0])}},layer:{add:function(e){e=new c.Layer(e);return a.layers.push(e),a.currentLayer=e},setCurrent:function(e){if(!(e instanceof c.Layer))throw new Error("Not a layer.");a.currentLayer=e},moveCurrentBefore:function(e){if(a.currentLayer!==e){var t=a.layers.indexOf(a.currentLayer),e=a.layers.indexOf(e);if(t<0||e<0)throw new Error("Layer doesn't belong to document.");t<e&&e--,a.layers.move(t,e)}},moveCurrentAfter:function(e){if(a.currentLayer!==e){var t=a.layers.indexOf(a.currentLayer),e=a.layers.indexOf(e);if(t<0||e<0)throw new Error("Layer doesn't belong to document.");e<t&&e++,a.layers.move(t,e)}},removeCurrent:function(){s(a.currentLayer.children,function(e){0<=a.selectedElements.indexOf(e)&&a.actions.select.deselectElement(e)}),a.layers.splice(a.layers.indexOf(a.currentLayer),1),0<a.layers.length?a.currentLayer=a.layers[a.layers.length-1]:a.currentLayer=null},lock:function(e){var t=[];s(e.children,function(e){0<=a.selectedElements.indexOf(e)&&t.push(e)}),t.forEach(function(e){return a.actions.select.deselectElement(e)}),e.locked=!0},unlock:function(e){e.locked=!1}},select:{selectElement:function(e){if(a.selectedElements.indexOf(e)<0){for(var t=e.parent;!(t instanceof c.Layer);t=t.parent)0<=a.selectedElements.indexOf(t)&&a.actions.select.deselectAll();t.locked||(a.actions.layer.setCurrent(t),a.selectedElements.push(e),a.sortSelected())}},deselectElement:function(e){e=a.selectedElements.indexOf(e);0<=e&&a.selectedElements.splice(e,1)},deselectAll:function(){a.selectedElements.splice(0)},selectAll:function(){a.selectedElements.splice(0),a.layers.forEach(function(e){e.hidden||e.locked||e.children.forEach(function(e){a.selectedElements.push(e)})})}},create:{image:function(e,t,n,o,r){a.actions.select.deselectAll();var i=new c.Image("Image");return i.url=e,i.left=t,i.top=n,i.width=o,i.height=r,a.currentLayer.children.push(i),a.actions.select.selectElement(i),i},text:function(e,t,n){a.actions.select.deselectAll();var o,r=new c.Text("Text");for(o in r.content=e,a.defaultFill)r.fill[o]=a.defaultFill[o];for(o in a.defaultStroke)r.stroke[o]=a.defaultStroke[o];for(o in a.defaultFontStyle)r.font[o]=a.defaultFontStyle[o];return"transparent"===a.defaultFill.color?"transparent"!==a.defaultStroke.color?r.fill.color=a.defaultStroke.color:a.colors[0]?r.fill.color=a.colors[0]:r.fill.color="black":r.fill.color=a.defaultFill.color,r.stroke.color="transparent",r.x=t,r.y=n,a.currentLayer.children.push(r),a.actions.select.selectElement(r),r},duplicateSelected:function(){var n=function(e){if(e instanceof c.Curve&&e.writePath(),e instanceof c.Container)for(var t=0;t<e.children.length;t++)n(e.children[t])},o=function(e){if(e instanceof c.Curve&&(e.readPath(),e.paths.forEach(function(e){return e.updateSegments()}),e.updateSvgPath()),e instanceof c.Container)for(var t=0;t<e.children.length;t++)o(e.children[t])},r=[];a.selectedElements.forEach(function(e){n(e);var t=xp.clone(e);o(t),r.push(t),e.parent.children.splice(e.parent.children.indexOf(e)+1,0,t)}),a.actions.select.deselectAll(),r.forEach(function(e){return a.actions.select.selectElement(e)})}},group:{groupSelected:function(){if(0<a.selectedElements.length){var t=new c.Group("Group");t.isExpanded=!1;var e=a.selectedElements[a.selectedElements.length-1];return e.parent.children.splice(e.parent.children.indexOf(e)+1,0,t),a.selectedElements.forEach(function(e){e.parent.children.detach(e.parent.children.indexOf(e)),t.children.attach(e,t.children.length)}),a.actions.select.deselectAll(),a.actions.select.selectElement(t),t}return null},ungroup:function(n){a.actions.select.deselectAll();var e=n.children.slice(0),o=n.parent.children.indexOf(n);e.forEach(function(e,t){n.children.detach(n.children.indexOf(e)),n.parent.children.attach(e,o+1+t),a.actions.select.selectElement(e)}),a.actions.remove.removeElement(n)},ungroupDeep:function(e){var t=[],n=function(){a.selectedElements.slice(0).forEach(function(e){e instanceof c.Group?(a.actions.group.ungroup(e),n()):t.push(e)})};a.actions.select.deselectAll(),a.actions.select.selectElement(e),n(),a.actions.select.deselectAll(),t.forEach(function(e){return a.actions.select.selectElement(e)})}},curve:{create:function(e,t,n,o){a.actions.select.deselectAll();var r,i=new c.Curve("Curve"),s=new c.Path;for(r in s.addPoint(e,t,n,o),a.defaultFill)i.fill[r]=a.defaultFill[r];for(r in a.defaultStroke)i.stroke[r]=a.defaultStroke[r];return i.paths.push(s),a.currentLayer.children.push(i),a.actions.select.selectElement(i),i},addPoint:function(e,t,n,o){var r,i;return a.cascadeSelected(c.Curve,function(e){return r=e}),r?(r.paths.forEach(function(e){e.isClosed||(i=e)}),i?(i.addPoint(e,t,n,o),i):(r=a.actions.curve.create(e,t,n,o)).paths[0]):(r=a.actions.curve.create(e,t,n,o)).paths[0]},insertPoint:function(e,t,n,o,r){return e.insertPoint(t,n,o,r)},movePoint:function(e,t,n,o){e.movePoint(t,n,o)},deletePoint:function(e,t,n){if(e.paths.indexOf(t)<0)throw new Error("The path doesn't belong to the curve.");1===t.points.length?1===e.paths.length?a.actions.remove.removeElement(e):e.paths.splice(e.paths.indexOf(t),1):t.removePoint(n)},convertPoint:function(e,t,n){e.convertPoint(t,n)},convertSegmant:function(e,t,n){e.convertSegment(t,n)},closePath:function(e){e.close()},openPath:function(e,t){e.open(t)},reversePath:function(e){e.reverse()},joinCurves:function(n){return(n=n.slice(0)).forEach(function(e,t){0<t&&(e.paths.forEach(function(e){return n[0].paths.push(e)}),a.actions.remove.removeElement(e))}),n[0]},splitCurves:function(e){e=e.slice(0);var r=[];e.forEach(function(o){o.paths.slice(0).forEach(function(e,t){var n;0<t&&(o.paths.splice(o.paths.indexOf(e),1),(n=new c.Curve("Curve")).fill=xp.observable(JSON.parse(JSON.stringify(o.fill))),n.stroke=xp.observable(JSON.parse(JSON.stringify(o.stroke))),n.paths.push(e),r.push(n),o.parent.children.splice(o.parent.children.indexOf(o)+t,0,n))})}),a.actions.select.deselectAll(),e.forEach(function(e){return a.actions.select.selectElement(e)}),r.forEach(function(e){return a.actions.select.selectElement(e)})},unite:function(e){a.actions.curve.removeSelfIntersections(e);for(var t=(e=e.slice(0))[0],n=1;n<e.length;n++)t=l.BooleanOperations.unite(t,e[n]),a.actions.remove.removeElement(e[n]);return e[0].parent.children.splice(e[0].parent.children.indexOf(e[0])+1,0,t),a.actions.remove.removeElement(e[0]),a.actions.select.deselectAll(),a.actions.select.selectElement(t),t},intersect:function(e){a.actions.curve.removeSelfIntersections(e);for(var t=(e=e.slice(0))[0],n=1;n<e.length;n++)t=l.BooleanOperations.intersect(t,e[n]),a.actions.remove.removeElement(e[n]);return e[0].parent.children.splice(e[0].parent.children.indexOf(e[0])+1,0,t),a.actions.remove.removeElement(e[0]),a.actions.select.deselectAll(),0<t.paths.length?(a.actions.select.selectElement(t),t):null},frontMinusBack:function(e){a.actions.curve.removeSelfIntersections(e),(e=e.slice(0)).sort(a.indexPathSorter).reverse();for(var t=e[0],n=1;n<e.length;n++)t=l.BooleanOperations.substract(t,e[n]),a.actions.remove.removeElement(e[n]);return e[0].parent.children.splice(e[0].parent.children.indexOf(e[0])+1,0,t),a.actions.remove.removeElement(e[0]),a.actions.select.deselectAll(),0<t.paths.length?(a.actions.select.selectElement(t),t):null},backMinusFront:function(e){a.actions.curve.removeSelfIntersections(e),(e=e.slice(0)).sort(a.indexPathSorter);for(var t=e[0],n=1;n<e.length;n++)t=l.BooleanOperations.substract(t,e[n]),a.actions.remove.removeElement(e[n]);return e[0].parent.children.splice(e[0].parent.children.indexOf(e[0])+1,0,t),a.actions.remove.removeElement(e[0]),a.actions.select.deselectAll(),0<t.paths.length?(a.actions.select.selectElement(t),t):null},removeSelfIntersections:function(e){e.forEach(function(e){e.isClosed&&l.BooleanOperations.removeSelfIntersections(e)})}},style:{tryAddColor:function(e){if("transparent"!==e){var t=l.Color.parse(e);if(0!==t.a){for(var n=a.colors.map(function(e){return l.Color.parse(e)}),o=0;o<n.length;o++)if(n[o].r===t.r&&n[o].g===t.g&&n[o].b===t.b&&n[o].a===t.a)return;a.colors.push(e)}}},tryAddColors:function(e){e=e.slice(0);for(var t,n=[];t=e.shift();)if("transparent"!==t){var o=l.Color.parse(t);if(0!==o.a){for(var r=a.colors.map(function(e){return l.Color.parse(e)}),i=!1,s=0;s<r.length;s++)r[s].r===o.r&&r[s].g===o.g&&r[s].b===o.b&&r[s].a===o.a&&(i=!0);i||n.some(function(e){return l.Color.areEqual(e,o)})||n.push(t)}}n.length&&a.colors.splice.apply(a.colors,[a.colors.length,0].concat(n))}}},this.indexPathSorter=function(e,t){e=a.getIndexPath(e),t=a.getIndexPath(t);return c.indexPathSorter(e,t)},xp.Model.property(this,"width",t),xp.Model.property(this,"height",n),xp.Model.property(this,"currentLayer"),xp.Model.property(this,"selectedElements",new xp.ObservableCollection),xp.Model.property(this,"layers",new xp.ObservableCollection),xp.Model.property(this,"rulers",new xp.ObservableCollection),xp.Model.property(this,"colors",new xp.ObservableCollection(Document.defaultColors)),xp.Model.property(this,"defaultFill",xp.observable(Document.defaultFill)),xp.Model.property(this,"defaultStroke",xp.observable(Document.defaultStroke)),xp.Model.property(this,"defaultFontStyle",xp.observable(Document.defaultFontStyle)),xp.Model.property(this,"hideOverflow",!1),xp.Model.property(this,"isSaved",!0,{enumerable:!1}),Object.defineProperty(this,"id",{writable:!0,enumerable:!1,configurable:!0,value:xp.createUuid()});n=Object.getOwnPropertyDescriptor(this,"actions");n.enumerable=!1,Object.defineProperty(this,"actions",n);function o(){a.colors.onCollectionChanged.addHandler(function(i){var e,t,n;i.action===xp.CollectionChangeAction.Replace&&(e=a.colors.indexOf(i.oldItem),t=a.colors.indexOf(i.newItem),n=a.colors.lastIndexOf(i.newItem),0<=t&&t!==i.newIndex||0<=n&&n!==i.newIndex?i.oldItem!==i.newItem&&(r=!0,a.colors[i.newIndex]=i.oldItem,r=!1):i.oldItem!==i.newItem&&!r&&(e<0||e>=i.newIndex)?(a.cascadeElements(c.Drawing,function(e){if(e.fill.color===i.oldItem&&(e.fill.color=i.newItem),e.stroke.color===i.oldItem&&(e.stroke.color=i.newItem),e.fill.gradient){var n=[];if(e.fill.gradient.stops.forEach(function(e,t){e.color===i.oldItem&&n.push({color:i.newItem,index:t})}),0<n.length){for(var t=e.fill.gradient,o=[],r=0;r<t.stops.length;r++)o.push({offset:t.stops[r].offset,color:t.stops[r].color});n.forEach(function(e){return o[e.index].color=e.color}),e.fill.gradient=xp.observable({start:t.start,end:t.end,type:t.type,stops:o})}}}),a.defaultFill.color===i.oldItem&&(a.defaultFill.color=i.newItem),a.defaultStroke.color===i.oldItem&&(a.defaultStroke.color=i.newItem)):i.oldItem===i.newItem||r||a.cascadeSelected(c.Drawing,function(e){if(e.fill.color===i.oldItem&&(e.fill.color=i.newItem),e.stroke.color===i.oldItem&&(e.stroke.color=i.newItem),e.fill.gradient){var n=[];if(e.fill.gradient.stops.forEach(function(e,t){e.color===i.oldItem&&n.push({color:i.newItem,index:t})}),0<n.length){for(var t=e.fill.gradient,o=[],r=0;r<t.stops.length;r++)o.push({offset:t.stops[r].offset,color:t.stops[r].color});n.forEach(function(e){return o[e.index].color=e.color}),e.fill.gradient=xp.observable({start:t.start,end:t.end,type:t.type,stops:o})}}}))},a)}var r=!1;this.onPropertyChanged.addHandler(function(e){"colors"===e&&o()},this),o()}return __extends(Document,i),Document.prototype.cascadeElements=function(t,n){s(this.layers,function(e){(!t||e instanceof t)&&n(e)})},Document.prototype.cascadeSelected=function(t,n){s(this.selectedElements,function(e){(!t||e instanceof t)&&n(e)})},Document.prototype.getSelectedElements=function(e){var t=[];return this.cascadeSelected(e,function(e){return t.push(e)}),t},Document.prototype.getSelectedBBox=function(){return 0===this.selectedElements.length?null:e(this.getSelectedElements(c.Drawing))},Document.prototype.sortSelected=function(){this.selectedElements.sort(this.indexPathSorter)},Document.prototype.getIndexPath=function(e){if(!(e.parent||e instanceof c.Layer))throw new Error("Element has no parent.");for(var t,n=[],o=e;o.parent;){if((t=o.parent.children.indexOf(o))<0)throw new Error("Parent doesn't contain a child, but child has a reference to parent.");n.push(t),o=o.parent}if(!(o instanceof c.Layer))throw new Error("Element was expected to be a layer.");if((t=this.layers.indexOf(o))<0)throw new Error("Document doesn't contain a layer.");return n.push(this.layers.indexOf(o)),n.reverse(),n},Document.prototype.getElement=function(e){if(0===e.length)throw new Error("No indices specified.");for(var t=this.layers[e[0]],n=1;n<e.length;n++){var o=t;if(e[n]<0||e[n]>o.children.length-1)throw new Error("No child at given index.");t=o.children[e[n]]}return t},Document.prototype.getElementById=function(e){for(var r=function(e,t){for(var n=0;n<e.children.length;n++){var o=e.children[n];if(o.id===t)return o;if(o instanceof c.Container){o=r(o,t);if(o)return o}}return null},t=0;t<this.layers.length;t++){if(this.layers[t].id===e)return this.layers[t];var n=r(this.layers[t],e);if(n)return n}throw new Error("Not found.")},Document.prototype.isSelectionInsertCorrect=function(e){if(!(e instanceof c.Container))throw new Error("Expected to be a container.");for(var t=!0,n=0;n<this.selectedElements.length;n++){var o=this.selectedElements[n];if(o instanceof c.Container&&(o===e||function(t,e){var n=!1;return s(e.children,function(e){e===t&&(n=!0)}),n}(e,o))){t=!1;break}}return t},Document.defaultColors=["#222","#248","#39c","#8b4","#fff","#ea3","#d42","#835"].map(function(e){return l.Color.rgbToString(l.Color.parse(e))}),Document.defaultFill={color:Document.defaultColors[0]},Document.defaultStroke={color:"transparent",width:2},Document.defaultFontStyle={family:"Open Sans",weight:c.FontWeight.Normal,size:72,isItalic:!1,anchor:c.TextAnchor.Right},Document}(c.Element),c.Document=Document,c.cascadeElements=s,c.indexPathSorter=function(e,t){for(var n=0;n<Math.min(e.length,t.length);n++){if(e[n]>t[n])return 1;if(e[n]<t[n])return-1}if(e.length>t.length)return 1;if(e.length<t.length)return-1;throw new Error("Duplicate paths.")},c.getDrawingsBBox=e}(Inker=Inker||{}),function(p){var t,s,e;function n(e,t){var n=this;s.call(this,t),this.tempRulers=[],this.cursors=[],this.app=e,this.docViewports={},e.document?this.onDocumentChanged():this.app.onPropertyChanged.addHandler(function(e){"document"===e&&n.onDocumentChanged()},this);var o={x:0,y:0,zoom:1};this.onViewportChanged=new xp.Event,Object.defineProperty(this,"viewport",{get:function(){return o},set:function(e){o=e,n.onViewportChange(),n.onViewportChanged.invoke(e)}}),this.app.platform.supportsTouch?this.registerTouchEvents():this.app.platform.onTouchSupportDetected.addHandler(function(){n.registerTouchEvents()})}t=p.UI||(p.UI={}),s=xp.Element,__extends(n,s),n.prototype.onDocumentChanged=function(){var e,t,n,o,r=this.app.document;r?(this.removeShapes(),r.id in this.docViewports||(n=this.domElement.offsetWidth,o=this.domElement.offsetHeight,e=(n-64)/r.width,t=(o-64)/r.height,t=Math.min(e,t),n=(n-r.width*t)/2,o=(o-r.height*t)/2,this.docViewports[r.id]={x:n,y:o,zoom:t}),this.createShapes(r),this.viewport=this.docViewports[r.id],this.prevCanvasSize={width:this.levels.viewport.clientWidth,height:this.levels.viewport.clientHeight}):this.removeShapes()},n.prototype.getTemplate=function(){var t=this;return this.levels={viewport:null,defs:null,page:null,markers:null,temp:null},xp.Dom.create('\n                <div class="Canvas">\n                    <svg>\n                        <defs></defs>\n                        <g data-type="Page" />\n                        <g data-type="Markers" />\n                        <g data-type="Temp" visibility="hidden" />\n                    </svg>\n                    <div id="messageListTarget"></div>\n                    <div id="actionMessage" style="display: none;"></div>\n                </div>',{"#actionMessage":function(e){return t.actionMessageElement=e},svg:function(e){return t.levels.viewport=e},defs:function(e){return t.levels.defs=e},'[data-type="Page"]':function(e){return t.levels.page=e},'[data-type="Markers"]':function(e){return t.levels.markers=e},'[data-type="Temp"]':function(e){return t.levels.temp=e}})},n.prototype.isBackgroundElement=function(e){return e===this.domElement||e===this.levels.viewport||e instanceof Element&&("PageRect"===e.getAttribute("data-type")||"PageShadowRect"===e.getAttribute("data-type"))},n.prototype.showActionMessage=function(e){var t=this.actionMessageElement;t.textContent=e,t.style.display="block",setTimeout(function(){return t.style.display="none"},1e3)},n.prototype.initEvents=function(){var n=this;s.prototype.initEvents.call(this),this.onShapeMouseDown=new xp.Event,this.onShapeDoubleClick=new xp.Event,this.onShapeContextMenu=new xp.Event,this.onContextMenu=new xp.Event;var o=!1;this.domElement.addEventListener("wheel",function(t){o||(o=!0,requestAnimationFrame(function(){var e=xp.createEventArgs(n,t);n.zoom(e.elementX,e.elementY,t.deltaY<0,Math.abs(t.deltaY)),o=!1}))}),this.domElement.addEventListener("contextmenu",function(e){e=xp.createEventArgs(n,e);n.onContextMenu.invoke(e)});function r(e){var t=n.domElement.getBoundingClientRect();return{domEvent:e,element:n,elementX:e.changedTouches[0].pageX-t.left,elementY:e.changedTouches[0].pageY-t.top}}this.onPointerDown=new xp.Event;var i=!1;this.domElement.addEventListener("touchstart",function(e){1===e.touches.length&&(e=r(e),n.onPointerDown.invoke(e)),i=!0}),this.domElement.addEventListener("touchend",function(e){var t;1===e.touches.length&&(t=r(e),n.onMouseUp.invoke(t)),e.preventDefault(),i=!1}),this.domElement.addEventListener("mousedown",function(e){i||(e=xp.createEventArgs(n,e),n.onPointerDown.invoke(e))}),window.addEventListener("resize",function(e){n.rulers&&n.rulers.forEach(function(e){return e.reset()})}),window.addEventListener("resize",function(){n.handleResize()})},n.prototype.registerTouchEvents=function(){function e(e){e=xp.createEventArgs(t,e),new p.Tools.Markers.TouchMarker(t.levels.markers,e.elementX,e.elementY)}var t=this;this.levels.viewport.addEventListener("touchstart",e,!0),this.levels.viewport.addEventListener("contextmenu",e,!0)},n.prototype.createShapes=function(e){var n=this;this.removeShapes(),this.docShape=new t.Shapes.DocShape(e,this),this.levels.page.appendChild(this.docShape.pageShadowElement1),this.levels.page.appendChild(this.docShape.pageShadowElement2),this.levels.page.appendChild(this.docShape.pageElement),this.levels.page.appendChild(this.docShape.element),this.levels.page.appendChild(this.docShape.pageBorderElement),this.levels.defs.appendChild(this.docShape.pageClipElement),this.levels.defs.appendChild(this.docShape.pageShadowFilter),this.levels.viewport.appendChild(this.docShape.rulersElement),this.rulers=this.docShape.rulers,this.rulerModeButton=new xp.ToggleButton({icon:t.Icons.tools.ruler,text:"Ruler",name:"rulerModeButton",init:function(e){function t(e){e.stopPropagation(),e.preventDefault(),n.app.currentTool.rulerModeEnabled=!n.app.currentTool.rulerModeEnabled}e.domElement.addEventListener("touchstart",t),e.domElement.addEventListener("mousedown",t),e.domElement.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault()})}}),this.domElement.appendChild(this.rulerModeButton.domElement)},n.prototype.removeShapes=function(){this.docShape&&this.docShape.remove(),this.docShape=null},n.prototype.onViewportChange=function(){this.levels.page.setAttribute("transform",xp.formatString("translate({1} {2}) scale({0})",this.viewport.zoom,this.viewport.x,this.viewport.y)),this.docShape&&this.rulers.forEach(function(e){return e.reset()});var e=this.app.document;e&&(this.docViewports[e.id]=this.viewport)},n.prototype.translateXIn=function(e){return(e-this.viewport.x)/this.viewport.zoom},n.prototype.translateYIn=function(e){return(e-this.viewport.y)/this.viewport.zoom},n.prototype.translateXOut=function(e){return e*this.viewport.zoom+this.viewport.x},n.prototype.translateYOut=function(e){return e*this.viewport.zoom+this.viewport.y},n.prototype.translateSizeIn=function(e){return e/this.viewport.zoom},n.prototype.translateSizeOut=function(e){return e*this.viewport.zoom},n.prototype.translateBoxIn=function(e){return{left:this.translateXIn(e.left),top:this.translateYIn(e.top),width:this.translateSizeIn(e.width),height:this.translateSizeIn(e.height)}},n.prototype.translateBoxOut=function(e){return{left:this.translateXOut(e.left),top:this.translateYOut(e.top),width:this.translateSizeOut(e.width),height:this.translateSizeOut(e.height)}},n.prototype.translatePtIn=function(e){return{x:this.translateXIn(e.x),y:this.translateYIn(e.y)}},n.prototype.translatePtOut=function(e){return{x:this.translateXOut(e.x),y:this.translateYOut(e.y)}},n.prototype.zoom=function(e,t,n,o){void 0===o&&(o=100),200<o&&(o=200),o<-200&&(o=-200);this.domElement.offsetWidth,this.domElement.offsetHeight;var r=this.viewport,o=r.zoom/4*o/100,o=n?r.zoom+o:r.zoom>o?r.zoom-o:r.zoom;this.viewport={x:r.x+(e-r.x)*(1-o/r.zoom),y:r.y+(t-r.y)*(1-o/r.zoom),zoom:o}},n.prototype.viewCenter=function(){var e=this.domElement.offsetWidth,t=this.domElement.offsetHeight;this.viewport={x:Math.round((e-this.app.document.width)/2),y:Math.round((t-this.app.document.height)/2),zoom:1}},n.prototype.viewAll=function(){var t=[];this.app.document.layers.forEach(function(e){p.Doc.cascadeElements(e.children,function(e){e instanceof p.Doc.Drawing&&t.push(e)})}),0<t.length&&(i=p.Doc.getDrawingsBBox(t)),i&&(0!==i.width||0!==i.height)||(i={left:0,top:0,width:this.app.document.width,height:this.app.document.height});var e=this.domElement.offsetWidth,n=this.domElement.offsetHeight,o=(e-64)/i.width,r=(n-64)/i.height,r=Math.min(o,r),e=-i.left*r+(e-i.width*r)/2,i=-i.top*r+(n-i.height*r)/2;this.viewport={x:e,y:i,zoom:r}},n.prototype.handleResize=function(){var e,t,n,o,r=this.prevCanvasSize;r&&(e={width:this.levels.viewport.clientWidth,height:this.levels.viewport.clientHeight},t=this.viewport,n=e.width/r.width,o=t.x+(e.width-r.width)/2,r=t.y+(e.height-r.height)/2,this.viewport={x:o+(e.width/2-o)*(1-n),y:r+(e.height/2-r)*(1-n),zoom:t.zoom*n},this.prevCanvasSize=e)},n.prototype.getSnappedCoords=function(t,n){var o=this,e=this.app.settings.snap.pixels?function(e){return{x:o.translateXOut(Math.round(o.translateXIn(e.x))),y:o.translateYOut(Math.round(o.translateYIn(e.y)))}}:function(e){return e};if(!this.app.settings.snap.on)return e({x:t,y:n});var r=this.rulers.filter(function(e){return o.app.getTool(p.Tools.RulerTool).selectedRulers.indexOf(e)<0});r.forEach(function(e){return e.isActive=!1});var i=this.app.settings.snap.distance,s=r.map(function(e){return{ruler:e,distance:e.getDistance(t,n)}}).filter(function(e){return e.distance<=i}).sort(function(e,t){return e.distance>t.distance?1:e.distance<t.distance?-1:0}).map(function(e){return e.ruler});if(0===s.length)return e({x:t,y:n});if(1===s.length)return s[0].isActive=!0,e(s[0].getClosestPoint(t,n));var a={x:this.translateXOut(s[0].model.x),y:this.translateYOut(s[0].model.y)},l=Geo.placePoint(a,1,s[0].model.a),c={x:this.translateXOut(s[1].model.x),y:this.translateYOut(s[1].model.y)},r=Geo.placePoint(c,1,s[1].model.a),r=Geo.getLinesIntersection(a,l,c,r,!0);return r&&Geo.getLength(r,{x:t,y:n})<=i?(s[0].isActive=!0,s[1].isActive=!0,e(r)):(s[0].isActive=!0,e(s[0].getClosestPoint(t,n)))},n.prototype.createTempRulers=function(n,o){var r=this;this.removeTempRulers(),this.app.settings.snap.anglesDeg.forEach(function(e){var t=new p.Doc.Ruler;t.x=n,t.y=o,t.a=Geo.rad(e),t.isTemp=!0,r.tempRulers.push(t),r.app.document.rulers.push(t)})},n.prototype.removeTempRulers=function(){var t=this.app.document.rulers;this.tempRulers&&this.tempRulers.forEach(function(e){0<=(e=t.indexOf(e))&&t.splice(e,1)}),this.tempRulers=[]},n.prototype.afterSnap=function(){this.rulers.forEach(function(e){return e.isActive=!1})},n.prototype.setCursor=function(e){this.cursors.push(e),this.domElement.style.cursor=e},n.prototype.replaceCursor=function(e){this.cursors[this.cursors.length-1]=e,this.domElement.style.cursor=e},n.prototype.removeLastCursor=function(){this.cursors.pop();var e=this.cursors.length;this.domElement.style.cursor=0<e?this.cursors[e-1]:""},e=n,t.Canvas=e}(Inker=Inker||{}),function(L){var e;(function(e){var t=(n.prototype.init=function(e,t){throw new Error("Abstract class.")},n.prototype.bind=function(e,t,n){n="string"==typeof n?new xp.BindingManager(this,n,e,t):new xp.BindingCallManager(e,t,n);this.bindings.push(n)},n.prototype.remove=function(){L.Svg.remove(this.element),this.bindings.forEach(function(e){return e.unbind()})},n);function n(e,t){this.model=e,this.canvas=t,this.bindings=[],this.init(e,t.levels.temp)}e.Shape=t;var o,i=(__extends(r,o=t),r.prototype.init=function(e,t){this.element=L.Svg.create("g"),t.appendChild(this.element),this.changesRegistrar=new xp.EventRegistrar,this.shapes=[]},Object.defineProperty(r.prototype,"models",{get:function(){return this._models},set:function(e){var o=this;this._models=e,this.changesRegistrar.unsubscribeAll(),this.shapes.forEach(function(e){return e.remove()}),this.shapes=[];var t=document.createDocumentFragment();if(e.forEach(function(e){e=o.createShape(e);o.shapes.push(e),t.appendChild(e.element)}),this.element.appendChild(t),!xp.isCollectionNotifier(e))throw new Error("Document models collection is not observable.");this.changesRegistrar.subscribe(e.onCollectionChanged,function(e){switch(e.action){case xp.CollectionChangeAction.Create:var t=o.createShape(e.newItem);o.shapes.splice(e.newIndex,0,t),L.Svg.insertChild(o.element,t.element,e.newIndex);break;case xp.CollectionChangeAction.Delete:(t=o.shapes.splice(e.oldIndex,1)[0]).remove();break;case xp.CollectionChangeAction.Replace:o.shapes.splice(e.oldIndex,1)[0].remove();var n=o.createShape(e.newItem);o.shapes.splice(e.newIndex,0,n),L.Svg.insertChild(o.element,n.element,e.newIndex);break;case xp.CollectionChangeAction.Attach:o.shapes.attach(o.canvas.movingShape,e.newIndex),L.Svg.insertChild(o.element,o.canvas.movingShape.element,e.newIndex);break;case xp.CollectionChangeAction.Detach:o.canvas.movingShape=o.shapes.detach(e.oldIndex),o.canvas.levels.temp.appendChild(o.canvas.movingShape.element);break;case xp.CollectionChangeAction.Move:n=o.shapes[e.oldIndex];o.shapes.move(e.oldIndex,e.newIndex),o.canvas.levels.temp.appendChild(n.element),L.Svg.insertChild(o.element,n.element,e.newIndex);break;default:throw new Error("Collection change type is not implemented.")}},this)},enumerable:!0,configurable:!0}),r.prototype.remove=function(){this.shapes.forEach(function(e){return e.remove()}),o.prototype.remove.call(this),this.changesRegistrar.unsubscribeAll()},r.prototype.createShape=function(e){if(e instanceof L.Doc.Group)return new u(e,this.canvas);if(e instanceof L.Doc.Layer)return new p(e,this.canvas);if(e instanceof L.Doc.Curve)return new x(e,this.canvas);if(e instanceof L.Doc.Image)return new E(e,this.canvas);if(e instanceof L.Doc.Text)return new S(e,this.canvas);throw new Error('No shapes are related to model "'+xp.getClassName(e)+'".')},r);function r(e,t){o.call(this,e,t)}e.ContainerShape=i;var s,a=(__extends(l,s=i),l.prototype.init=function(e,t){var o=this;s.prototype.init.call(this,e,t),this.rulers=[],this.element.setAttribute("data-type","Document"),this.pageShadowElement1=L.Svg.create("rect",{width:e.width,height:e.height,x:0,y:0,fill:l.ShadowColor,"data-type":"PageShadowRect",stroke:l.ShadowColor,"stroke-width":16,"vector-effect":"non-scaling-stroke"}),this.pageShadowElement2=L.Svg.create("rect",{width:e.width,height:e.height,x:0,y:0,fill:l.ShadowColor,"data-type":"PageShadowRect",stroke:l.ShadowColor,"stroke-width":8,"vector-effect":"non-scaling-stroke"}),this.pageElement=L.Svg.create("rect",{width:e.width,height:e.height,fill:l.BgColor,"data-type":"PageRect"}),this.pageBorderElement=L.Svg.create("rect",{width:e.width,height:e.height,x:0,y:0,fill:"none","data-type":"PageBorderRect","pointer-events":"none",stroke:l.BorderColor,"stroke-width":1,"vector-effect":"non-scaling-stroke"}),this.pageClipElement=L.Svg.create("clipPath",{id:"pageClip"});var n=L.Svg.create("rect",{width:e.width,height:e.height});this.pageClipElement.appendChild(n),this.rulersElement=L.Svg.create("g",{"data-type":"Rulers"}),this.pageShadowFilter=L.Svg.create("filter",{id:"dropShadow",height:"150%"},[L.Svg.create("feGaussianBlur",{in:"SourceAlpha",stdDeviation:4}),L.Svg.create("feComponentTransfer",{},[L.Svg.create("feFuncA",{type:"linear",slope:.3})]),L.Svg.create("feMerge",{},[L.Svg.create("feMergeNode"),L.Svg.create("feMergeNode",{in:"SourceGraphic"})])]);this.bind(e,"layers","models"),this.bind(e,"width",function(e){o.pageElement.setAttribute("width",e),o.pageShadowElement1.setAttribute("width",e),o.pageShadowElement2.setAttribute("width",e),o.pageBorderElement.setAttribute("width",e),n.setAttribute("width",e)}),this.bind(e,"height",function(e){o.pageElement.setAttribute("height",e),o.pageShadowElement1.setAttribute("height",e),o.pageShadowElement2.setAttribute("height",e),o.pageBorderElement.setAttribute("height",e),n.setAttribute("height",e)}),this.bind(e,"rulers",function(e){o.rulers.forEach(function(e){return e.remove()}),o.rulers.splice(0);function n(e){e=new I(e,o.canvas),o.rulersElement.appendChild(e.element),o.rulers.push(e)}e.forEach(n),e.onCollectionChanged.addHandler(function(e){var t;e.action!==xp.CollectionChangeAction.Attach&&e.action!==xp.CollectionChangeAction.Create&&e.action!==xp.CollectionChangeAction.Replace||n(e.newItem),e.action!==xp.CollectionChangeAction.Delete&&e.action!==xp.CollectionChangeAction.Detach&&e.action!==xp.CollectionChangeAction.Replace||(t=e.oldItem,e=o.rulers.filter(function(e){return e.model===t})[0],o.rulers.splice(o.rulers.indexOf(e),1),e.remove())},o)}),this.bind(e,"hideOverflow",function(e){e?o.element.setAttribute("clip-path","url(#pageClip)"):o.element.removeAttribute("clip-path")})},l.prototype.getSelectedShapes=function(){var n=[],o=this.model.selectedElements,r=function(e,t){e.shapes.forEach(function(e){e instanceof g?(0<=o.indexOf(e.model)||t)&&n.push(e):e instanceof i&&r(e,0<=o.indexOf(e.model)||t)})};return r(this,!1),n},l.prototype.remove=function(){s.prototype.remove.call(this),L.Svg.remove(this.pageElement),L.Svg.remove(this.pageShadowElement1),L.Svg.remove(this.pageShadowElement2),L.Svg.remove(this.rulersElement),L.Svg.remove(this.pageBorderElement),L.Svg.remove(this.pageClipElement)},l.BgColor="#aaa",l.ShadowColor="rgba(0,0,0,0.01)",l.BorderColor="rgba(0,0,0,0.1)",l);function l(e,t){s.call(this,e,t)}e.DocShape=a;var c,p=(__extends(h,c=i),h.prototype.init=function(e,t){var n=this;c.prototype.init.call(this,e,t),this.element.setAttribute("data-type","Layer");this.bind(e,"children","models"),this.bind(e,"name",function(e){return n.element.setAttribute("data-name",e)}),this.bind(e,"hidden",function(e){n.element.setAttribute("visibility",e?"hidden":"visible")}),this.bind(e,"locked",function(e){e?n.element.setAttribute("pointer-events","none"):n.element.removeAttribute("pointer-events")})},h);function h(e,t){c.call(this,e,t)}e.LayerShape=p;var d,u=(__extends(f,d=i),f.prototype.init=function(e,t){var n=this;d.prototype.init.call(this,e,t),this.element.setAttribute("data-type","Group");this.bind(e,"children","models"),this.bind(e,"children",function(e){return n.element.setAttribute("data-name",e)})},f);function f(e,t){d.call(this,e,t)}e.GroupShape=u;var m,g=(__extends(v,m=t),v.prototype.initPointerEvents=function(){var n=this;this.element.addEventListener("mousedown",function(e){e=xp.createEventArgs(n.canvas,e);(e.targetShape=n).canvas.onShapeMouseDown.invoke(e)}),this.element.addEventListener("dblclick",function(e){e=xp.createEventArgs(n.canvas,e);(e.targetShape=n).canvas.onShapeDoubleClick.invoke(e)}),this.element.addEventListener("contextmenu",function(e){e=xp.createEventArgs(n.canvas,e);(e.targetShape=n).canvas.onShapeContextMenu.invoke(e)});function t(e){var t=n.canvas.domElement.getBoundingClientRect();return{element:n.canvas,domEvent:e,elementX:e.changedTouches[0].pageX-t.left,elementY:e.changedTouches[0].pageY-t.top,targetShape:n}}var o=!1;this.element.addEventListener("touchstart",function(e){o||(e=t(e),n.canvas.onShapeMouseDown.invoke(e))}),this.element.addEventListener("touchend",function(e){e.preventDefault();e=t(e);o?(n.canvas.onShapeDoubleClick.invoke(e),o=!1):(o=!0,setTimeout(function(){o=!1},300))})},v);function v(){m.apply(this,arguments)}e.DrawingShape=g;var y,x=(__extends(w,y=g),w.prototype.init=function(e,t){var n=this;this.gradientPropChangeRegistrar=new xp.EventRegistrar,this.element=L.Svg.create("path"),this.element.setAttribute("data-type","Curve"),this.initPointerEvents(),t.appendChild(this.element);this.bind(e,"name",function(e){return n.element.setAttribute("data-name",e)}),this.bind(e,"svgPath",function(e){return L.Svg.setAttribute(n.element,"d",e)}),this.bind(e,"fill.color",function(e){return n.setFill()}),this.bind(e,"stroke.color",function(e){return n.setStroke()}),this.bind(e,"stroke.width",function(e){return n.setStroke()}),this.bind(e,"opacity",function(e){return n.element.setAttribute("opacity",e)}),this.bind(e,"isClosed",function(e){n.setFill(),n.setStroke()}),this.bind(e,"fill.gradient",function(e){n.setFill()})},w.prototype.setStroke=function(){this.model.hasStroke||this.model.isClosed?L.Svg.setAttributes(this.element,{stroke:"transparent"===this.model.stroke.color?"none":this.model.stroke.color,"stroke-width":this.model.stroke.width}):L.Svg.setAttributes(this.element,{stroke:(this.model.fill.gradient?this.model.fill.gradient.stops[0]:this.model.fill).color,"stroke-width":w.unclosedStrokeWidth})},w.prototype.setFill=function(){var o=this;if(this.model.isClosed)if(this.model.fill.gradient){this.gradientDef&&L.Svg.remove(this.gradientDef),this.gradientPropChangeRegistrar.unsubscribeAll();var n=this.model.fill.gradient,e="gradient"+this.model.id;switch(n.type){case"linear":this.gradientDef=L.Svg.create("linearGradient"),L.Svg.setAttributes(this.gradientDef,{x1:n.start.x,y1:n.start.y,x2:n.end.x,y2:n.end.y});break;case"radial":this.gradientDef=L.Svg.create("radialGradient",{cx:n.start.x,cy:n.start.y,r:Geo.getLength(n.start,n.end)});break;default:throw new Error('Unknown gradient type: "'+n.type+'".')}L.Svg.setAttribute(this.gradientDef,"id",e),L.Svg.setAttribute(this.gradientDef,"gradientUnits","userSpaceOnUse"),n.stops.forEach(function(e,t){e=L.Svg.create("stop",{offset:100*e.offset+"%","stop-color":e.color});o.gradientDef.appendChild(e)});var r=function(){n.stops.forEach(function(e,t){"transparent"!==e.color||(e=0===t?n.stops[t+1].color:t===n.stops.length-1?n.stops[t-1].color:null)&&"transparent"!==e&&((e=L.Color.parse(e)).a=0,L.Svg.getChild(o.gradientDef,t).setAttribute("stop-color",L.Color.rgbaToString(e)))})};r(),this.canvas.levels.defs.appendChild(this.gradientDef),this.element.setAttribute("fill","url(#"+e+")"),this.gradientPropChangeRegistrar.subscribe(n.onPropertyChanged,function(e){"start"!==e&&"end"!==e||("linear"===n.type?L.Svg.setAttributes(o.gradientDef,{x1:n.start.x,y1:n.start.y,x2:n.end.x,y2:n.end.y}):"radial"===n.type&&L.Svg.setAttributes(o.gradientDef,{cx:n.start.x,cy:n.start.y,r:Geo.getLength(n.start,n.end)}))}),n.stops.forEach(function(t,n){o.gradientPropChangeRegistrar.subscribe(t.onPropertyChanged,function(e){"color"===e&&(L.Svg.getChild(o.gradientDef,n).setAttribute("stop-color",t.color),r())})})}else"transparent"===this.model.fill.color?this.element.setAttribute("fill","none"):this.element.setAttribute("fill",this.model.fill.color),this.gradientDef&&L.Svg.remove(this.gradientDef),this.gradientPropChangeRegistrar.unsubscribeAll(),this.gradientDef=null;else this.element.setAttribute("fill","none"),this.gradientDef&&L.Svg.remove(this.gradientDef),this.gradientPropChangeRegistrar.unsubscribeAll(),this.gradientDef=null},w.prototype.remove=function(){y.prototype.remove.call(this),this.gradientDef&&L.Svg.remove(this.gradientDef)},w.unclosedStrokeWidth=2,w);function w(e,t){y.call(this,e,t)}e.CurveShape=x;var b,E=(__extends(k,b=g),k.prototype.init=function(e,t){var n=this;this.element=L.Svg.create("image"),this.element.setAttribute("data-type","Image"),this.initPointerEvents(),t.appendChild(this.element);this.bind(e,"name",function(e){return n.element.setAttribute("data-name",e)}),this.bind(e,"url",function(e){return n.element.setAttributeNS(L.Svg.XlinkNS,"xlink:href",e)}),this.bind(e,"left",function(e){return L.Svg.setAttribute(n.element,"x",e)}),this.bind(e,"top",function(e){return L.Svg.setAttribute(n.element,"y",e)}),this.bind(e,"width",function(e){return L.Svg.setAttribute(n.element,"width",e)}),this.bind(e,"height",function(e){return L.Svg.setAttribute(n.element,"height",e)}),this.bind(e,"opacity",function(e){return n.element.setAttribute("opacity",e)})},k);function k(e,t){b.call(this,e,t)}e.ImageShape=E;var C,S=(__extends(P,C=g),P.prototype.init=function(o,e){var r=this;this.element=L.Svg.create("text"),this.element.setAttribute("data-type","Text"),this.initPointerEvents(),e.appendChild(this.element);e=o;this.bind(e,"name",function(e){return r.element.setAttribute("data-name",e)}),this.bind(e,"x",function(e){L.Svg.setAttribute(r.element,"x",e);for(var t=0;t<r.element.childElementCount;t++)L.Svg.getChild(r.element,t).setAttribute("x",e.toString())}),this.bind(e,"y",function(e){return L.Svg.setAttribute(r.element,"y",e)}),this.bind(e,"content",function(e){for(;r.element.lastElementChild;)r.element.removeChild(r.element.lastElementChild);e.split("\n").forEach(function(e,t){var n=L.Svg.create("tspan",{x:o.x});0<t&&n.setAttribute("dy",(o.font.size/3*4).toString()),n.textContent=e,r.element.appendChild(n)})}),this.bind(e,"font.size",function(e){L.Svg.setAttribute(r.element,"font-size",e);var t=r.element.firstElementChild;if(t)for(;t=t.nextElementSibling;)t.setAttribute("dy",(e/3*4).toString())}),this.bind(e,"font.family",function(e){return L.Svg.setAttribute(r.element,"font-family",e)}),this.bind(e,"font.weight",function(e){return L.Svg.setAttribute(r.element,"font-weight",e)}),this.bind(e,"font.isItalic",function(e){e?r.element.setAttribute("font-style","italic"):r.element.removeAttribute("font-style")}),this.bind(e,"font.anchor",function(e){return L.Svg.setAttribute(r.element,"text-anchor",e)}),this.bind(e,"fill.color",function(e){return r.element.setAttribute("fill",e)}),this.bind(e,"stroke.color",function(e){return r.element.setAttribute("stroke",e)}),this.bind(e,"stroke.width",function(e){return L.Svg.setAttribute(r.element,"stroke-width",e)}),this.bind(e,"opacity",function(e){return L.Svg.setAttribute(r.element,"opacity",e)})},P);function P(e,t){C.call(this,e,t)}e.TextShape=S;var M,I=(__extends(T,M=t),T.prototype.init=function(e,t){var n=this;this.element=L.Svg.create("g",{"data-type":"Ruler","pointer-events":"none"}),this.sensElement=L.Svg.create("line",{stroke:"transparent","stroke-width":2*this.canvas.app.settings.snap.distance,"vector-effect":"non-scaling-stroke",class:"sens"}),this.lineElement=L.Svg.create("line",{stroke:T.style.color,"stroke-width":T.style.width,"vector-effect":"non-scaling-stroke",class:"line"}),this.element.appendChild(this.sensElement),this.element.appendChild(this.lineElement),t.appendChild(this.element);this.bind(e,"x",function(e){return n.reset()}),this.bind(e,"y",function(e){return n.reset()}),this.bind(e,"a",function(e){return n.reset()});e=this.canvas.app;this.bind(e,"settings.snap.visible",function(e){return n.reset()}),this.bind(e,"settings.snap.distance",function(e){return L.Svg.setAttribute(n.sensElement,"stroke-width",2*e)})},Object.defineProperty(T.prototype,"isActive",{set:function(e){L.Svg.setAttribute(this.lineElement,"stroke",e?T.style.active:T.style.color)},enumerable:!0,configurable:!0}),T.prototype.reset=function(){function e(e){return-1<=e.x&&e.x<=i+1&&-1<=e.y&&e.y<=s+1}var t,n=[],o={x:this.canvas.translateXOut(this.model.x),y:this.canvas.translateYOut(this.model.y)},r=Geo.placePoint(o,1,this.model.a),i=this.canvas.domElement.offsetWidth,s=this.canvas.domElement.offsetHeight,a=[{x:0,y:0},{x:i,y:0},{x:i,y:s},{x:0,y:s}];(t=Geo.getLinesIntersection(o,r,a[0],a[1],!0))&&e(t)&&n.push(t),(t=Geo.getLinesIntersection(o,r,a[1],a[2],!0))&&e(t)&&n.push(t),(t=Geo.getLinesIntersection(o,r,a[2],a[3],!0))&&e(t)&&n.push(t),(t=Geo.getLinesIntersection(o,r,a[3],a[0],!0))&&e(t)&&n.push(t),0!==n.length&&this.canvas.app.settings.snap.visible?2===n.length?(L.Svg.setAttributes(this.element,{visibility:"visible"}),L.Svg.setAttributes(this.sensElement,{x1:n[0].x,y1:n[0].y,x2:n[1].x,y2:n[1].y}),L.Svg.setAttributes(this.lineElement,{x1:n[0].x,y1:n[0].y,x2:n[1].x,y2:n[1].y})):console.warn("Unexpected ruler intersections count."):L.Svg.setAttribute(this.element,"visibility","hidden")},T.prototype.getDistance=function(e,t){t=this.model.getDistance(this.canvas.translateXIn(e),this.canvas.translateYIn(t));return this.canvas.translateSizeOut(t)},T.prototype.getClosestPoint=function(e,t){t=this.model.getClosestPoint(this.canvas.translateXIn(e),this.canvas.translateYIn(t));return{x:this.canvas.translateXOut(t.x),y:this.canvas.translateYOut(t.y)}},T.style={color:"#247",active:"#499",width:1},T);function T(e,t){M.call(this,e,t)}e.RulerShape=I})((e=L.UI||(L.UI={})).Shapes||(e.Shapes={}))}(Inker=Inker||{}),function(y){!function(d){var t,e=(t=xp.HBox,__extends(n,t),n.prototype.saveContainerScroll=function(){this.colorsContainerScrollLeft=this.colorsContainer.domElement.scrollLeft},n.prototype.restoreContainerScroll=function(){this.colorsContainer.domElement.scrollLeft=this.colorsContainerScrollLeft},Object.defineProperty(n.prototype,"colors",{set:function(e){var n=this,o=this.colorsContainerScrollLeft||this.colorsContainer.domElement.scrollLeft;this.colorsContainer.removeChildren(),this.colorChangeRegistrar.unsubscribeAll(),e&&(e.forEach(function(e,t){e=n.createColorButton(e,t);n.colorsContainer.insert(e,t)}),this.colorChangeRegistrar.subscribe(e.onCollectionChanged,function(e){var t;e.action===xp.CollectionChangeAction.Replace?n.colorsContainer.children[e.newIndex].domElement.style.backgroundColor=e.newItem:(n.colors=n.app.document.colors,n.colorEditModeEnabled&&e.action!==xp.CollectionChangeAction.Move&&(n.secondaryPicker&&(n.secondaryPicker.remove(),n.secondaryPicker=null,n.app.toolTip&&(n.app.toolTip.domElement.style.marginLeft="")),t=n.app.document.colors.length,n.onSetEditColor(void 0!==e.newIndex?e.newIndex:e.oldIndex<t?e.oldIndex:t-1,!1)),n.colorsContainer.domElement.scrollLeft=o)},this))},enumerable:!0,configurable:!0}),n.prototype.createColorButton=function(e,r){var i=this,a=new xp.Button;a.style="colorButton",a.domElement.style.backgroundColor=e;function l(e,t){var n,o;i.colorEditModeEnabled?0<=r&&(e?(i.secondaryPicker||(i.secondaryPicker=new u(app),i.secondaryPicker.appendTo(i.app.window),i.app.toolTip&&(n=i.secondaryPicker.domElement.getBoundingClientRect(),i.app.toolTip.domElement.style.marginLeft=+n.width+"px")),i.onSetEditColor(r,!0)):(i.onSetEditColor(r,!1),t||i.startColorDrag(i.colorsContainer.children[r],r))):(t=i.colorsContainer.children.indexOf(a),o=i.app.document.colors[t]||"transparent",e?0<app.document.selectedElements.length?i.app.memento.isLocked||i.app.memento.perform({modify:i.app.document.getSelectedElements(y.Doc.Drawing),action:function(){return i.app.document.cascadeSelected(y.Doc.Drawing,function(e){e.stroke.color=o}),null}}):i.app.memento.isLocked||i.app.memento.perform({props:["defaultFill"],action:function(){return i.app.document.defaultStroke.color=o,null}}):0<app.document.selectedElements.length?i.app.memento.isLocked||((e=i.app.currentTool)instanceof y.Tools.SelectTool&&0<e.selectedGStops.length?e.onGrandientColorChange(o):i.app.memento.perform({modify:i.app.document.getSelectedElements(y.Doc.Drawing),action:function(){return i.app.document.cascadeSelected(y.Doc.Drawing,function(e){e.fill.gradient&&(e.fill.gradient=null),e.fill.color=o}),null}})):i.app.memento.isLocked||i.app.memento.perform({props:["defaultFill"],action:function(){return i.app.document.defaultFill.color=o,null}}))}return a.domElement.addEventListener("mousedown",function(e){e=!(1===e.which&&!e.altKey&&!e.metaKey&&!e.ctrlKey);l(e)}),a.domElement.addEventListener("touchstart",function(e){var t=a.domElement.classList.contains("edit");t&&l(!1,!1);function n(){window.removeEventListener("touchmove",r),window.removeEventListener("touchend",i),window.removeEventListener("contextmenu",s)}var o=!1,r=function(){o=!0},i=function(){o||t||l(!1,!0),n()},s=function(){o||(l(!0,!0),n())};window.addEventListener("touchmove",r),window.addEventListener("touchend",i),window.addEventListener("contextmenu",s)}),a},n.prototype.onSetEditColor=function(e,t){this.colorsContainer.children.forEach(function(e){return e.domElement.classList.remove(t?"edit-secondary":"edit")}),0<=e&&e<this.colorsContainer.children.length&&(this.colorsContainer.children[e].domElement.classList.add(t?"edit-secondary":"edit"),this.colorsContainer.children[e].domElement.focus(),(t?this.secondaryPicker:this.colorPicker).bind("currentColor","document.colors["+e+"]",null,"white"))},n.prototype.startColorDrag=function(o,r){function n(){p||(p=xp.Dom.create('<div class="colorsDragRemove">Drag here to remove</div>'),document.body.appendChild(p),p.style.width=a.colorsContainer.domElement.getBoundingClientRect().width+"px")}function i(e){console.log("button move");var t=h(e),e=(e=e)instanceof MouseEvent?{x:e.clientX,y:e.clientY}:{x:e.touches[0].clientX,y:e.touches[0].clientY};!s||s.x===e.x&&s.y===e.y||n(),s=e,t!==o&&(l=!0,c&&g(),c=!1,a.colorsContainer.children.indexOf(o)>a.colorsContainer.children.indexOf(t)?o.insertBefore(t):o.insertAfter(t))}var s,a=this,l=!1,c=!1,p=document.querySelector(".colorsDragRemove"),h=function(e){var t=(e instanceof TouchEvent?e.touches[0]:e).pageX,e=(e instanceof TouchEvent?e.touches[0]:e).pageY,n=document.elementFromPoint(t,e),e=a.colorsContainer.children.filter(function(e){return e.domElement===n})[0];if(!e)throw new Error("Button not found.");return e},d=function(e){var t,n;window.removeEventListener("mouseup",d),window.removeEventListener("touchend",d),p&&p.parentElement.removeChild(p),a.domElement.removeEventListener("mouseleave",u),window.removeEventListener("touchmove",v),a.colorsContainer.children.forEach(function(e){e.domElement.removeEventListener("mousemove",i)}),a.colorsContainer.domElement.removeEventListener("mousemove",m),a.colorsContainer.domElement.removeEventListener("touchmove",m),c?a.app.document.colors.splice(r,1):!l||(t=a.colorsContainer.children.indexOf(o))!==r&&(n=a.secondaryPicker?y.Color.rgbaToString(y.Color.parse(a.secondaryPicker.currentColor)):null,a.app.document.colors.move(r,t),a.onSetEditColor(t,!1),n&&((n=a.app.document.colors.map(function(e){return y.Color.rgbaToString(y.Color.parse(e))}).indexOf(n))<0?(a.secondaryPicker.remove(),a.secondaryPicker=null):a.onSetEditColor(n,!0)))},u=function(e){n(),(e instanceof TouchEvent?e.touches[0]:e).clientY<=a.colorsContainer.domElement.getBoundingClientRect().top?(console.log("leave top"),c||(t(),c=!0)):console.log("leave not top")},f=o.domElement.clientWidth,m=function(e){var t=xp.createEventArgs(a.colorsContainer,e),n=a.colorsContainer.domElement,e=n.getBoundingClientRect();t.elementX<f&&(n.scrollLeft-=.4*f),e.width-t.elementX<f&&(n.scrollLeft+=.4*f)},t=function(){var e=o.domElement,t=e.getBoundingClientRect();e.style.left=t.left+"px",e.classList.remove("edit"),e.classList.add("removing"),p.classList.add("removing")},g=function(){var e=o.domElement;e.style.left="",e.classList.add("edit"),e.classList.remove("removing"),p.classList.remove("removing")};window.addEventListener("mouseup",d),window.addEventListener("touchend",d),this.domElement.addEventListener("mouseleave",u);var v=function(e){var t=document.elementFromPoint(e.touches[0].pageX,e.touches[0].pageY),n=a.colorsContainer.children.filter(function(e){return e.domElement===t})[0];t===a.domElement||n||u(e),n&&n!==o&&i(e)};window.addEventListener("touchmove",v),this.colorsContainer.children.forEach(function(e){e.domElement.addEventListener("mousemove",i)}),this.colorsContainer.domElement.addEventListener("touchmove",m),this.colorsContainer.domElement.addEventListener("mousemove",m)},n);function n(a,e){var l,c=this;e&&(e.useParentScope=!1,e.scope=a),t.call(this,e),this.app=a,this.colorChangeRegistrar=new xp.EventRegistrar,this.currentColorElement=new r,this.currentColorElement.appendTo(this),this.colorsContainer=new xp.HBox({style:"colorsContainer",flex:"shrink",scrollBar:"horizontal"}),this.colorsContainer.appendTo(this),this.bind("colors","document.colors"),this.buttonAddColor=new xp.Button({text:"+",onMouseDown:function(e){var t=c.app.document.colors.push(c.colorPicker.currentColor);c.onSetEditColor(t-1,!1),c.colorsContainer.domElement.scrollLeft=c.colorsContainer.domElement.scrollWidth},visible:!1}),this.buttonAddColor.appendTo(this),this.transparentButton=this.createColorButton("transparent",-1),this.transparentButton.domElement.classList.add("transparent"),this.transparentButton.appendTo(this);function p(){var t=c.app.document.colors.map(function(e){return{color:e,freq:0}});c.app.document.cascadeSelected(y.Doc.Drawing,function(e){e.fill.gradient||0<=(e=c.app.document.colors.indexOf(e.fill.color))&&t[e].freq++});var n,e,o=0;t.forEach(function(e){e.freq>o&&(o=e.freq,n=e.color)}),0<o?(e=c.app.document.colors.indexOf(n),c.onSetEditColor(e,!1)):c.onSetEditColor(0,!1),c.onSetEditColor(-1,!0)}var h=new xp.EventRegistrar;this.buttonEdit=new xp.Button({text:"Edit colors",onClick:function(){if(c.colorPicker){c.colorPicker.remove(),c.colorPicker=null,c.secondaryPicker&&(c.secondaryPicker.remove(),c.secondaryPicker=null),c.colorEditModeEnabled=!1,c.buttonEdit.text="Edit colors",c.buttonAddColor.visible=!1,c.onSetEditColor(-1,!1),c.onSetEditColor(-1,!0),h.unsubscribeAll();for(var e=c.app.document.colors,t=e.length-1;0<=t;t--)e.indexOf(e[t])<t&&e.splice(t,1);c.app.toolTip&&(c.app.toolTip.remove(),c.app.toolTip=null),l&&l.afterAction()}else{c.colorPicker=new u(a),c.colorPicker.appendTo(c.app.window),c.colorEditModeEnabled=!0,c.buttonEdit.text="Done",c.buttonAddColor.visible=!0;var n,o=c.app.document.getSelectedElements(y.Doc.Drawing);n=0<o.length&&0<=(n=c.app.document.colors.indexOf(o[0].fill.color))?n:0,c.onSetEditColor(n,!1),h.subscribe(c.app.document.selectedElements.onCollectionChanged,p);var r,i,s=[];c.app.document.cascadeElements(y.Doc.Drawing,function(e){return s.push(e)}),c.app.memento.isLocked||(l=a.memento.beforeAction({modify:s,props:["colors","defaultFill","defaultStroke"]}),r=function(){var e=c.colorPicker.domElement.getBoundingClientRect(),t=c.app.window.canvas.domElement.getBoundingClientRect();return{title:"How to use Color palette?",content:'<img src="help/color-palette.gif"/>',location:{x:e.right-t.left,y:e.top+e.height/2-t.top},bounds:t}},c.app.settings.help.displayTips&&(c.app.toolTip&&c.app.toolTip.remove(),c.app.toolTip=new d.ToolTip(c.app,r()),i=function(){c.app.toolTip.refresh(r())},window.addEventListener("resize",i),c.app.toolTip.onRemoved.addHandler(function(){window.removeEventListener("resize",i)})))}}}),this.buttonEdit.appendTo(this)}d.ColorPalette=e;var o,r=(o=xp.Element,__extends(i,o),i.prototype.getTemplate=function(){var t=this;return xp.Dom.create('\n                <div class="CurrentColorElement">\n                    <div class="fill"></div>\n                    <div class="stroke"></div>\n                </div>',{".fill":function(e){return t.fillElement=e},".stroke":function(e){return t.strokeElement=e}})},Object.defineProperty(i.prototype,"fillColor",{set:function(e){e&&"transparent"!==e?(this.fillElement.classList.remove("transparent"),this.fillElement.style.backgroundColor=e):(this.fillElement.classList.add("transparent"),this.fillElement.style.backgroundColor="")},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"strokeColor",{set:function(e){e&&"transparent"!==e?(this.strokeElement.classList.remove("transparent"),this.strokeElement.style.backgroundColor=e,this.domElement.classList.remove("fillOnly")):(this.strokeElement.classList.add("transparent"),this.strokeElement.style.backgroundColor="",this.domElement.classList.add("fillOnly"))},enumerable:!0,configurable:!0}),i);function i(){o.call(this),this.express("fillColor","{document.selectedElements[0].fill.color} || {document.defaultFill.color}"),this.express("strokeColor","{document.selectedElements[0].stroke.color} || {document.defaultStroke.color}")}var c,u=(c=xp.Element,__extends(s,c),s.prototype.getTemplate=function(){var t=this,e=xp.Dom.create('\n                <div class="ColorPicker">\n                    <input type="text" class="TextBox colorText"/>\n                    <div class="hsbContainer">\n                        <div class="sbContainer">\n                            <canvas class="sb"></canvas>\n                            <div class="sbTick"></div>\n                        </div>\n                        <div class="hContainer">\n                            <canvas class="h"></canvas>\n                            <div class="hTick"></div>\n                        </div>\n                    </div>\n                </div>',{".sb":function(e){return t.sbElement=e},".h":function(e){return t.hElement=e},".hContainer":function(e){return t.hContainerElement=e},".sbTick":function(e){return t.sbTickElement=e},".hTick":function(e){return t.hTickElement=e},".colorText":function(e){return t.colorText=e}});return this.sbElement.width=s.size,this.sbElement.height=s.size,this.hElement.width=1,this.hElement.height=s.size,e},Object.defineProperty(s.prototype,"currentColor",{get:function(){var e=y.Color.hsbToRgb(this.hsb);return y.Color.rgbToString(e)},set:function(e){var t;this.settingColorFromPicker||(t=y.Color.parse(e),(t=y.Color.rgbToHsb(t)).h!==this.hsb.h&&(this.hsb.h=t.h),t.s!==this.hsb.s&&(this.hsb.s=t.s),t.b!==this.hsb.b&&(this.hsb.b=t.b)),this.colorText.value=y.Color.rgbToHexString(y.Color.parse(e))},enumerable:!0,configurable:!0}),s.prototype.initEvents=function(){var s=this;c.prototype.initEvents.call(this);function o(e){var t=(e instanceof TouchEvent?e.touches[0]:e).pageX,e=(e instanceof TouchEvent?e.touches[0]:e).pageY,t=(t-r.left)/r.width,e=1-(e-r.top)/r.height;t<0&&(t=0),1<t&&(t=1),e<0&&(e=0),1<e&&(e=1),s.hsb.s=t,s.hsb.b=e,s.settingColorFromPicker=!0,s.onInput("currentColor",s.currentColor),s.settingColorFromPicker=!1}var r,i,a=!1,e=function(e){r=s.sbElement.getBoundingClientRect(),o(e);function t(e){e.preventDefault(),a||(requestAnimationFrame(function(){o(e),a=!1}),a=!0)}var n=function(e){window.removeEventListener("touchmove",t),window.removeEventListener("mousemove",t),window.removeEventListener("touchend",n),window.removeEventListener("mouseup",n)};window.addEventListener("touchmove",t),window.addEventListener("mousemove",t),window.addEventListener("touchend",n),window.addEventListener("mouseup",n)};this.sbElement.addEventListener("mousedown",e),this.sbElement.addEventListener("touchstart",e);function l(e){(e=((e instanceof TouchEvent?e.touches[0]:e).pageY-i.top)/i.height*360)<0&&(e=0),360<e&&(e=360),s.hsb.h=e,s.settingColorFromPicker=!0,s.onInput("currentColor",s.currentColor),s.settingColorFromPicker=!1}e=function(e){i=s.hElement.getBoundingClientRect(),l(e);function t(e){e.preventDefault(),a||(requestAnimationFrame(function(){l(e),a=!1}),a=!0)}var n=function(e){window.removeEventListener("touchmove",t),window.removeEventListener("mousemove",t),window.removeEventListener("touchend",n),window.removeEventListener("mouseup",n)};window.addEventListener("touchmove",t),window.addEventListener("mousemove",t),window.addEventListener("touchend",n),window.addEventListener("mouseup",n)};this.hContainerElement.addEventListener("mousedown",e),this.hContainerElement.addEventListener("touchstart",e),this.sbElement.oncontextmenu=function(e){return e.preventDefault()},this.hElement.oncontextmenu=function(e){return e.preventDefault()},this.hContainerElement.oncontextmenu=function(e){return e.preventDefault()},this.sbElement.onselectstart=function(e){return e.preventDefault()},this.hElement.onselectstart=function(e){return e.preventDefault()},this.hContainerElement.onselectstart=function(e){return e.preventDefault()},this.domElement.onselectstart=function(e){return e.preventDefault()},this.colorText.oninput=function(e){var t=s.colorText.selectionStart,n=s.colorText.value;"#"!==n[0]&&(n="#"+n);for(var o,r=/[\dA-F]/i,i=n.length-1;1<=i;i--)r.test(n[i])||(n=n.substring(0,i)+n.substring(i+1),t--);n=n.substring(0,7),s.colorText.value=n,t=Math.max(t,1),s.colorText.setSelectionRange(t,t),7===n.length&&y.Color.regexps.hex.test(n)&&(o=y.Color.parse(n),s.currentColor=y.Color.rgbToString(o),s.onInput("currentColor",s.currentColor))}},s.prototype.drawH=function(){for(var e,t=this.hElement.getContext("2d"),n=this.hElement.width,o=this.hElement.height,r={h:0,s:1,b:1},i=0;i<o;i++)r.h=360*i/o,e=y.Color.hsbToRgb(r),t.fillStyle="rgba("+e.r+","+e.g+","+e.b+",1)",t.fillRect(0,i,n,1)},s.prototype.drawSB=function(){for(var e,t=this.sbElement.getContext("2d"),n=this.sbElement.width,o=this.sbElement.height,r=t.createImageData(n,o),i=r.data,s={h:this.hsb.h,s:0,b:1},a=0;a<n;a++)for(var l=0;l<o;l++)s.s=a/n,s.b=1-l/o,e=y.Color.hsbToRgb(s),i[4*(a+l*n)]=e.r,i[4*(a+l*n)+1]=e.g,i[4*(a+l*n)+2]=e.b,i[4*(a+l*n)+3]=255;t.putImageData(r,0,0)},s.prototype.setHTickPosition=function(){var e=this.hElement.getBoundingClientRect().height;this.hTickElement.style.top=this.hsb.h/360*e+"px"},s.prototype.setSBTickPosition=function(){var e=this.sbElement.getBoundingClientRect();this.sbTickElement.style.left=this.hsb.s*e.width+"px",this.sbTickElement.style.top=(1-this.hsb.b)*e.height+"px"},s.size=128,s);function s(e){var t=this;c.call(this);e=(this.app=e).window.stylePanel.domElement.getBoundingClientRect();this.domElement.style.bottom=e.bottom-e.top+"px",this.hsb=xp.observable({h:0,s:0,b:1});new xp.BindingCallManager(this,"hsb.h",function(e){t.setHTickPosition(),t.drawSB()}),new xp.BindingCallManager(this,"hsb.s",function(e){t.setSBTickPosition()}),new xp.BindingCallManager(this,"hsb.b",function(e){t.setSBTickPosition()});this.drawH();function n(){t.setHTickPosition(),t.setSBTickPosition()}window.addEventListener("resize",n),this.onRemoved.addHandler(function(){return window.removeEventListener("resize",n)})}}(y.UI||(y.UI={}))}(Inker=Inker||{}),function(e){!function(e){var o,t=(o=xp.HBox,__extends(n,o),n.prototype.getTemplate=function(){return xp.Dom.create('<div class="DocTabPanel HBox"></div>')},Object.defineProperty(n.prototype,"documents",{set:function(e){var n=this;this.removeChildren(),this.docChangeRegistrar.unsubscribeAll(),e.forEach(function(e){n.createTab(e)}),this.docChangeRegistrar.subscribe(e.onCollectionChanged,function(e){switch(e.action){case xp.CollectionChangeAction.Create:n.createTab(e.newItem);break;case xp.CollectionChangeAction.Delete:n.removeTab(e.oldItem);break;case xp.CollectionChangeAction.Move:var t=n.getTab(e.newItem);n.insert(t,e.newIndex);break;case xp.CollectionChangeAction.Replace:(t=n.getTab(e.newItem)).doc=e.newItem;break;default:throw new Error("Not implemented.")}},this)},enumerable:!0,configurable:!0}),n.prototype.createTab=function(t){var e=this,n=new i(t);this.menu&&this.children[0]instanceof i&&this.menu.insert(this.children[0],0),this.insert(n,0),this.app.window.header.handleLayout(),n.onClick.addHandler(function(){e.app.memento.isLocked?e.app.message.warn("Please, finish action before switching documents."):n.doc.id!==e.app.document.id&&(e.app.document=e.app.documents.filter(function(e){return e.id===t.id})[0])},this),this.docChangeRegistrar.subscribe(n.onCloseClick,function(){e.app.memento.isLocked?e.app.message.warn("Please, finish action before closing document."):e.app.file.close(n.doc.id)},n)},n.prototype.getTab=function(t){return this.getAllTabs().filter(function(e){return e.doc.id===t.id})[0]},n.prototype.getAllTabs=function(){var e=this.children.filter(function(e){return e instanceof i});return this.menu&&(e=e.concat(this.menu.children.slice(0))),e.forEach(function(e){if(!(e instanceof i))throw new Error("Not a tab!")}),e},n.prototype.removeTab=function(e){var t=this.getTab(e);t.remove(),this.docChangeRegistrar.unsubscribe(function(e){return e.scope===t}),this.app.window.header.handleLayout()},n.prototype.setCurrentTab=function(t){var e=this.getAllTabs();e.forEach(function(e){return e.isCurrent=e.doc.id===t.id});e=e.filter(function(e){return e.isCurrent})[0];this.menu&&this.children[0]!==e&&(this.children[0]instanceof i&&this.menu.insert(this.children[0],0),this.insert(e,0))},n.prototype.handleLayout=function(){var t=this;this.expandButton&&this.expandButton.remove(),this.expandButton=null,this.menu&&(this.menu.children.slice(0).forEach(function(e){return t.append(e)}),this.menu.remove(),this.menu=null,this.isMenuExpanded=!1),this.domElement.scrollWidth>this.domElement.clientWidth&&1<this.app.documents.length&&(this.expandButton=new xp.Button({style:"docTabExpandButton",icon:e.Icons.down,onClick:function(e){e.domEvent.stopPropagation(),t.isMenuExpanded?t.collapseMenu():t.expandMenu()}}),this.menu=new xp.VBox({style:"docTabExpandMenu"}),this.children.filter(function(e){return!e.isCurrent}).forEach(function(e){return t.menu.append(e)}),this.expandButton.appendTo(this))},n.prototype.expandMenu=function(){var e=this;this.append(this.menu),this.isMenuExpanded=!0;var t=new xp.EventRegistrar,n=function(){window.removeEventListener("click",n),e.menu&&(t.unsubscribe(function(e){return e.event.hasHandler(e.handler)}),setTimeout(function(){e.isMenuExpanded&&e.collapseMenu()},0))};window.addEventListener("click",n),this.menu.cascadeBy(function(e){t.subscribe(e.onClick,function(e){e.domEvent.stopPropagation(),n()})})},n.prototype.collapseMenu=function(){this.menu&&this.menu.parent===this&&this.detachChild(this.menu),this.isMenuExpanded=!1},n);function n(e,t){var n=this;o.call(this,t),this.isMenuExpanded=!1,this.app=e,this.docChangeRegistrar=new xp.EventRegistrar,new xp.BindingCallManager(e,"documents",function(){return n.documents=e.documents}),new xp.BindingCallManager(e,"document",function(){n.children.forEach(function(e){return e.isCurrent=!1}),e.document&&n.setCurrentTab(e.document)})}e.DocTabPanel=t;var r,i=(r=xp.Element,__extends(s,r),s.prototype.getTemplate=function(){var t=this;return xp.Dom.create('\n                <span class="DocTab">\n                    <span class="text"></span>\n                    <span class="close"><span class="cross"></span></span>\n                </span>',{".text":function(e){return t.textElement=e},".close":function(e){return t.closeElement=e}})},Object.defineProperty(s.prototype,"docName",{set:function(e){this.textElement.textContent=e,this.domElement.title=e},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isCurrent",{get:function(){return this._isCurrent},set:function(e){(this._isCurrent=e)?this.domElement.classList.add("current"):this.domElement.classList.remove("current")},enumerable:!0,configurable:!0}),s);function s(e){var n=this;r.call(this),this.doc=e,this.useParentScope=!1,this.bind("docName","name",e),this.onCloseClick=new xp.Event,this.closeElement.addEventListener("click",function(e){var t=xp.createEventArgs(n,e);n.onCloseClick.invoke(t),e.stopPropagation()})}}(e.UI||(e.UI={}))}(Inker=Inker||{}),function(E){!function(s){var n,e=(n=xp.VBox,__extends(t,n),t.prototype.getTemplate=function(){return xp.Dom.create('<div class="DocTree VBox"></div>')},Object.defineProperty(t.prototype,"currentLayer",{set:function(t){this.children.forEach(function(e){e.model===t?e.itemNode.isSelected=!0:e.itemNode.isSelected=!1})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selectedElements",{set:function(t){var n=this;t&&(this.handleSelection(t),this.selectionRegistrar.unsubscribeAll(),this.selectionRegistrar.subscribe(t.onCollectionChanged,function(e){n.handleSelection(t)},this))},enumerable:!0,configurable:!0}),t.prototype.handleSelection=function(n){var o=function(e){var t=!0;0<=n.indexOf(e.model)?e.itemNode.isSelected=!0:(e.itemNode.isSelected=!1,t=!1),e.content.children.forEach(function(e){if(e instanceof u)0<=n.indexOf(e.model)?e.isSelected=!0:(e.isSelected=!1,t=!1);else{if(!(e instanceof r))throw new Error("Unexpected node type.");o(e),e.itemNode.isSelected||(t=!1)}}),t&&(e.itemNode.isSelected=!0)};this.children.forEach(function(e){e.content.children.forEach(function(e){if(e instanceof u)e.isSelected=0<=n.indexOf(e.model);else{if(!(e instanceof r))throw new Error("Unexpected node type.");o(e)}})})},Object.defineProperty(t.prototype,"layers",{set:function(e){var o=this;if(this.layersRegistrar.unsubscribeAll(),this.removeChildren(),e){this.currentLayer=this.app.document.currentLayer;for(var t=e.length-1;0<=t;t--){var n=new l(e[t],this);this.append(n)}this.layersRegistrar.subscribe(e.onCollectionChanged,function(e){switch(e.action){case xp.CollectionChangeAction.Attach:case xp.CollectionChangeAction.Create:var t=new l(e.newItem,o);o.insert(t,o.children.length-e.newIndex);break;case xp.CollectionChangeAction.Detach:case xp.CollectionChangeAction.Delete:(n=o.children[o.children.length-1-e.oldIndex]).remove();break;case xp.CollectionChangeAction.Replace:o.children[o.children.length-1-e.oldIndex].remove();t=new l(e.newItem,o);o.insert(t,o.children.length-e.newIndex);break;case xp.CollectionChangeAction.Move:var n;(n=o.children[o.children.length-1-e.oldIndex]).detach(),o.insert(n,o.children.length-e.newIndex)}},this)}},enumerable:!0,configurable:!0}),t.prototype.selectLayer=function(e){this.app.document.actions.layer.setCurrent(e.model)},t.prototype.selectOneNode=function(e){this.app.document.actions.select.deselectAll(),this.app.document.actions.select.selectElement(e.model),this.prevClickedNode=e},t.prototype.toggleNodeSelection=function(e){e.isSelected?this.app.document.actions.select.deselectElement(e.model):this.app.document.actions.select.selectElement(e.model),this.prevClickedNode=e},t.prototype.toggleMultipleNodesSelection=function(e){if(this.prevClickedNode){if(e.model.parent===this.prevClickedNode.model.parent)for(var t=e.model.parent,n=t.children.indexOf(e.model),o=t.children.indexOf(this.prevClickedNode.model),r=Math.min(n,o);r<=Math.max(n,o);r++)this.app.document.actions.select.selectElement(t.children[r])}else this.toggleNodeSelection(e);this.prevClickedNode=e},t.prototype.showNodeContextMenu=function(e,t,n,o){var r=this;if(e instanceof w)return xp.ContextMenu.show(t,n,[{text:"Paste",icon:s.Icons.paste,action:function(){var t,n=e.model;r.app.memento.isLocked||(t=r.app.memento.beforeAction(),r.app.clipboard.paste(function(e){e?(r.app.document.actions.arrange.appendSelectedTo(n),t.afterAction({created:r.app.document.selectedElements})):t.cancelWithNoChanges()}))},disabled:!this.app.clipboard.isClipboardSet||e.model.locked},{text:"Delete",icon:s.Icons.delete,action:function(){r.app.memento.isLocked||r.app.memento.perform({delete:[r.app.document.currentLayer],action:function(){return r.app.document.actions.layer.removeCurrent(),null}})}}],o);if(e instanceof g){var i=[{text:"Cut",icon:s.Icons.cut,action:function(){r.app.memento.isLocked||r.app.memento.perform({delete:r.app.document.selectedElements,action:function(){return r.app.clipboard.cut(),null}})},key:"Ctrl+X"},{text:"Copy",icon:s.Icons.copy,action:function(){r.app.clipboard.copy()},key:"Ctrl+C"},{text:"Paste",icon:s.Icons.paste,action:function(){var t,n=e.model;r.app.memento.isLocked||(t=r.app.memento.beforeAction(),r.app.clipboard.paste(function(e){e?(r.app.document.actions.arrange.moveSelectedAfter(n),t.afterAction({created:r.app.document.selectedElements})):t.cancelWithNoChanges()}))},disabled:!this.app.clipboard.isClipboardSet,key:"Ctrl+V"},{text:"Delete",icon:s.Icons.delete,action:function(){r.app.memento.isLocked||r.app.memento.perform({delete:r.app.document.selectedElements,action:function(){return r.app.document.actions.remove.removeSelected(),null}})},key:"Del"},{text:"Group",icon:s.Icons.group,action:function(){r.app.memento.isLocked||r.app.memento.perform({delete:r.app.document.selectedElements,action:function(){return{created:[r.app.document.actions.group.groupSelected()]}}})},disabled:this.app.document.selectedElements.length<2,key:"Ctrl+G"}];return e.model instanceof E.Doc.Group&&i.push({text:"Ungroup",icon:s.Icons.ungroup,action:function(){var e=r.app.document.selectedElements.filter(function(e){return e instanceof E.Doc.Group});0<e.length&&(r.app.memento.isLocked||r.app.memento.perform({delete:e,action:function(){var t=[];return e.forEach(function(e){r.app.document.actions.group.ungroup(e),t=t.concat(r.app.document.selectedElements.slice(0))}),r.app.document.actions.select.deselectAll(),t.forEach(function(e){return r.app.document.actions.select.selectElement(e)}),{created:t}}}))},key:"Ctrl+U"}),xp.ContextMenu.show(t,n,i,o)}},t.prototype.startNodeDrag=function(i){var s=this;console.log("drag start "+i.nameElement.innerText);var t,a=new xp.EventRegistrar,n=function(e){console.log("mmove "+e.element.nameElement.innerText);var t=e.element;t!==i&&(e.elementY<t.domElement.offsetHeight/2?t.markInsert("top"):t.markInsert("bottom"))},o=function(e){console.log("mleave "+e.element.nameElement.innerText),e.element.markInsert("none")},r=function(e){console.log("mup "+e.element.nameElement.innerText),a.unsubscribeAll();var t=e.element;if(t.markInsert("none"),t===i)e.domEvent.ctrlKey||e.domEvent.metaKey||e.domEvent.shiftKey||i instanceof w||e.domEvent instanceof TouchEvent||(s.app.document.actions.select.deselectAll(),s.app.document.actions.select.selectElement(t.model));else{var n=i.model,o=t.model,r=e.elementY<t.domElement.offsetHeight/2,e=(s.app.document.selectedElements,s.app.document);if(!s.app.memento.isLocked){t=s.app.memento.beforeAction({arrange:n instanceof E.Doc.Layer?[e.currentLayer]:e.selectedElements});if(o instanceof E.Doc.Layer)n instanceof E.Doc.Layer?r?e.actions.layer.moveCurrentAfter(o):e.actions.layer.moveCurrentBefore(o):r?e.layers.indexOf(o)<e.layers.length-1&&e.actions.arrange.prependSelectedTo(e.layers[e.layers.indexOf(o)+1]):e.actions.arrange.appendSelectedTo(o);else if(o instanceof E.Doc.Group)r?e.actions.arrange.moveSelectedAfter(o):e.actions.arrange.appendSelectedTo(o);else{if(!(o instanceof E.Doc.Drawing))throw new Error("Unexpected document model.");r?e.actions.arrange.moveSelectedAfter(o):e.actions.arrange.moveSelectedBefore(o)}t.afterAction()}}};i instanceof w?this.children.forEach(function(e){a.subscribe(e.itemNode.onMouseMove,n,s),a.subscribe(e.itemNode.onMouseLeave,o,s),a.subscribe(e.itemNode.onMouseUp,r,s)}):(t=[],i.model instanceof E.Doc.Group&&i.parent.content.cascadeBy(function(e){e instanceof g&&e!==i&&t.push(e)}),this.cascadeBy(function(e){e instanceof g&&0<=s.app.document.selectedElements.indexOf(e.model)&&e!==i&&t.push(e)}),this.cascadeBy(function(e){e instanceof g&&t.indexOf(e)<0&&(a.subscribe(e.onMouseMove,n,s),a.subscribe(e.onMouseLeave,o,s),a.subscribe(e.onMouseUp,r,s))})),window.addEventListener("touchmove",m),window.addEventListener("touchend",function e(t){p&&r(xp.createEventArgs(p,t));window.removeEventListener("touchmove",m);window.removeEventListener("touchend",e)});var e=function(){a.unsubscribeAll(),window.removeEventListener("mouseup",e),window.removeEventListener("touchend",e)};window.addEventListener("mouseup",e),window.addEventListener("touchend",e);var l,c=this.domElement,p=i,h=new xp.Dictionary(i instanceof w?this.children.map(function(e){return{key:e.itemNode.domElement,value:e.itemNode}}):(l=[],s.cascadeBy(function(e){e instanceof g&&t.indexOf(e)<0&&l.push({key:e.domElement,value:e})}),l)),d=24,u=24,f=c.getBoundingClientRect();function m(e){var t=function(e){var t=e.touches[0].pageX,n=e.touches[0].pageY,e=c.getBoundingClientRect();if(t<e.left||t>e.right||n<e.top||n>e.bottom)return;var o,r=document.elementFromPoint(t,n);for(;!(o=h.get(r))&&r!==c&&r.parentElement;)r=r.parentElement;return o||null}(e);t!==p&&(p&&o(xp.createEventArgs(p,e)),p=t),t&&n(xp.createEventArgs(t,e)),e.touches[0].clientY<f.top+d&&e.touches[0].clientY>f.top-u&&(c.scrollTop-=(f.top+d-e.touches[0].clientY)/2),e.touches[0].clientY>f.bottom-d&&e.touches[0].clientY<f.bottom+u&&(c.scrollTop+=(e.touches[0].clientY-f.bottom+d)/2)}},t.prototype.focusInput=function(e,t){this.app.window.focusInput(e,t)},t);function t(e,t){n.call(this,t),this.app=e,this.layersRegistrar=new xp.EventRegistrar,this.bind("layers","document.layers"),this.bind("currentLayer","document.currentLayer"),this.bind("selectedElements","document.selectedElements"),this.selectionRegistrar=new xp.EventRegistrar}s.DocTree=e;var o,r=(o=xp.VBox,__extends(i,o),i.prototype.getTemplate=function(){return xp.Dom.create('<div class="ContainerNode VBox"></div>')},i.prototype.initEvents=function(){var e=this;o.prototype.initEvents.call(this),this.modelsChangeRegistrar=new xp.EventRegistrar,this.onRemoved.addHandler(function(){return e.modelsChangeRegistrar.unsubscribeAll()},this)},i.prototype.createItemNode=function(){this.itemNode=new v(this.model,this.tree,this),this.itemNode.appendTo(this)},i.prototype.createContent=function(){this.content=new xp.VBox,this.content.style="nodeContent",this.content.appendTo(this)},i.prototype.setDefaults=function(){o.prototype.setDefaults.call(this),this.flex="none"},Object.defineProperty(i.prototype,"expanded",{set:function(e){this.itemNode.expanded=e,this.content.visible=e},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"models",{set:function(e){var n=this;if(this.content.removeChildren(),e){for(var t=e.length-1;0<=t;t--)this.createChildNode(e[t]).appendTo(this.content);this.modelsChangeRegistrar.subscribe(e.onCollectionChanged,function(e){switch(e.action){case xp.CollectionChangeAction.Create:var t=n.createChildNode(e.newItem);n.content.insert(t,n.content.children.length-e.newIndex);break;case xp.CollectionChangeAction.Delete:(t=n.content.children[n.content.children.length-1-e.oldIndex]).remove();break;case xp.CollectionChangeAction.Replace:n.content.children[n.content.children.length-1-e.oldIndex].remove();t=n.createChildNode(e.newItem);n.content.insert(t,n.content.children.length-e.newIndex);break;case xp.CollectionChangeAction.Move:(t=n.content.children[n.content.children.length-1-e.oldIndex]).detach(),n.content.insert(t,n.content.children.length-e.newIndex);break;case xp.CollectionChangeAction.Attach:n.content.insert(n.tree.movedNode,n.content.children.length-e.newIndex),n.tree.movedNode=null;break;case xp.CollectionChangeAction.Detach:(t=n.content.children[n.content.children.length-1-e.oldIndex]).detach(),n.tree.movedNode=t}},this)}},enumerable:!0,configurable:!0}),i.prototype.createChildNode=function(e){if(e instanceof E.Doc.Drawing)return new u(e,this.tree);if(e instanceof E.Doc.Group)return new i(e,this.tree);throw new Error("Not implemented.")},i);function i(e,t){o.call(this),this.tree=t,this.model=e,this.createItemNode(),this.createContent(),this.useParentScope=!1,this.scope=e,this.bind("models","children"),this.bind("expanded","isExpanded")}var a,l=(__extends(c,a=r),c.prototype.getTemplate=function(){return xp.Dom.create('<div class="LayerNode ContainerNode VBox"></div>')},c.prototype.createItemNode=function(){this.itemNode=new w(this.model,this.tree,this),this.itemNode.appendTo(this)},c);function c(e,t){a.call(this,e,t)}var p,g=(p=xp.Element,__extends(h,p),h.prototype.getTemplate=function(){var t=this;return xp.Dom.create('\n                <div class="ItemNode">\n                    <span class="name"></span>\n                    <span class="menu"></span>\n                </div>',{".name":function(e){return t.nameElement=e},".menu":function(e){return t.menuElement=e}})},Object.defineProperty(h.prototype,"modelName",{set:function(e){this.nameElement.textContent=e},enumerable:!0,configurable:!0}),h.prototype.editName=function(e){var t,n,o,r,i,s,a=this;this.domElement.querySelector(".TextBox")||(t=!1,n=new xp.TextBox({text:this.model.name}),o=function(e){void 0===e&&(e=!1),t||(t=!0,n.domElement.removeEventListener("blur",s),window.removeEventListener("mousedown",i),window.removeEventListener("keydown",r),e||(a.model.name=n.domElement.value),setTimeout(function(){return n.remove()}))},r=function(e){27===e.keyCode&&o(!0)},i=function(e){e.target!==n.domElement&&o()},n.onTextChange.addHandler(function(e){return o()}),s=function(){o()},n.domElement.addEventListener("blur",s),window.addEventListener("mousedown",i),window.addEventListener("keydown",r),this.nameElement.appendChild(n.domElement),this.tree.focusInput(n.domElement,e),n.domElement.selectionStart=0,n.domElement.selectionEnd=n.domElement.value.length)},h.prototype.initEvents=function(){var t=this;p.prototype.initEvents.call(this),this.bind("modelName","name"),this.onDoubleClick.addHandler(function(e){e.domEvent.stopPropagation(),t.editName(!1)});var n=!1;this.domElement.addEventListener("touchstart",function(e){e.stopPropagation(),console.log("node text touch"),n&&t.editName(!0),n=!0,setTimeout(function(){return n=!1},300)}),this.menuElement.addEventListener("mousedown",function(e){return e.stopPropagation(),t.openedMenu?(t.openedMenu.close(),void(t.openedMenu=null)):void(t.openedMenu=t.tree.showNodeContextMenu(t,t.menuElement,"vertical",function(){return t.openedMenu=null}))}),this.menuElement.addEventListener("touchstart",function(e){return e.stopPropagation()}),this.menuElement.addEventListener("click",function(e){return e.stopPropagation()}),this.menuElement.addEventListener("dblclick",function(e){return e.stopPropagation()}),this.onMouseDown.addHandler(function(e){if(o)o=!1;else if(console.log("Node mousedown"),t.model instanceof E.Doc.Layer||!t.tree.app.document.layers[t.tree.app.document.getIndexPath(t.model)[0]].locked){if(3===e.domEvent.which||e.domEvent.altKey)return e.domEvent.preventDefault(),t.isSelected||(t instanceof w?t.tree.selectLayer(t):t.tree.selectOneNode(t)),void t.tree.showNodeContextMenu(t,e.domEvent.pageX,e.domEvent.pageY);t instanceof w?t.tree.selectLayer(t):e.domEvent.shiftKey?t.tree.toggleMultipleNodesSelection(t):e.domEvent.ctrlKey||e.domEvent.metaKey?t.tree.toggleNodeSelection(t):t.isSelected||t.tree.selectOneNode(t),t.isSelected&&t.tree.startNodeDrag(t)}else console.log("Element is locked.")},this);var o=!1,r=function(e){console.log("Node touchend"),a(),t instanceof w?t.tree.selectLayer(t):t.tree.selectOneNode(t)},i=function(e){console.log("Node touchmove"),a(),t.isSelected&&(t instanceof w?t.tree.selectLayer(t):t.isSelected||t.tree.selectOneNode(t),t.tree.startNodeDrag(t))},s=function(e){console.log("Node contextmenu"),a(),t instanceof w?t.tree.selectLayer(t):t.tree.toggleNodeSelection(t),t.isSelected&&t.tree.startNodeDrag(t)},a=function(){t.domElement.removeEventListener("touchmove",i),t.domElement.removeEventListener("contextmenu",s),t.domElement.removeEventListener("touchend",r)};this.domElement.addEventListener("touchstart",function(e){o=!0,console.log("Node touchstart"),t.model instanceof E.Doc.Layer||!t.tree.app.document.layers[t.tree.app.document.getIndexPath(t.model)[0]].locked?(t.domElement.addEventListener("touchmove",i),t.domElement.addEventListener("contextmenu",s),t.domElement.addEventListener("touchend",r),t.isSelected&&e.preventDefault()):console.log("Element is locked.")})},h.prototype.setDefaults=function(){p.prototype.setDefaults.call(this),this.flex="none"},Object.defineProperty(h.prototype,"isSelected",{get:function(){return this._isSelected},set:function(e){(this._isSelected=e)?this.domElement.classList.add("selected"):this.domElement.classList.remove("selected")},enumerable:!0,configurable:!0}),h.prototype.markInsert=function(e){switch(e){case"top":this.domElement.classList.remove("insertBottom"),this.domElement.classList.add("insertTop");break;case"bottom":this.domElement.classList.remove("insertTop"),this.domElement.classList.add("insertBottom");break;case"none":this.domElement.classList.remove("insertTop"),this.domElement.classList.remove("insertBottom");break;default:throw new Error('Unknown value "'+e+'".')}},h);function h(e,t){p.call(this),this.model=e,this.tree=t,this.useParentScope=!1,this.scope=e;e=document.createElement("i");"."===s.Icons.menu[0]?e.classList.add(s.Icons.menu.slice(1)):e.style.backgroundImage="url("+s.Icons.menu+")",this.menuElement.appendChild(e)}var d,u=(__extends(f,d=g),f.prototype.getTemplate=function(){var t=this;return xp.Dom.create('\n                <div class="DrawingItemNode ItemNode">\n                    <span class="nodeIcon icon colorIcon"></span>\n                    <span class="name"></span>\n                    <span class="menu"></span>\n                </div>',{".name":function(e){return t.nameElement=e},".menu":function(e){return t.menuElement=e},".icon":function(e){return t.iconElement=e}})},f.prototype.setFill=function(e){var t=this;if(this.gradientPropChangeRegistrar.unsubscribeAll(),e.gradient){this.iconElement.classList.remove("transparent");var o=e.gradient,n=o.stops.map(function(e,t){var n=e.color;return"transparent"!==e.color||(t=0===t?o.stops[t+1].color:t===o.stops.length-1?o.stops[t-1].color:null)&&"transparent"!==t&&((t=E.Color.parse(t)).a=0,n=E.Color.rgbaToString(t)),n+" "+100*e.offset+"%"}).join(", ");switch(o.type){case"linear":var r=function(){t.iconElement.style.background="linear-gradient("+Geo.deg(Geo.getAngle(o.start,o.end)+Math.PI/2)+"deg, "+n+")"};r(),this.gradientPropChangeRegistrar.subscribe(o.onPropertyChanged,function(e){"start"!==e&&"end"!==e||r()});break;case"radial":this.iconElement.style.background="radial-gradient(circle, "+n+")";break;default:throw new Error('Unknown gradient type "'+o.type+'".')}}else this.iconElement.style.background=e.color,"transparent"===e.color?this.iconElement.classList.add("transparent"):this.iconElement.classList.remove("transparent")},f.prototype.setStroke=function(e){this.iconElement.style.borderColor=e.color,"transparent"===e.color||0===e.width?this.iconElement.classList.add("noStroke"):this.iconElement.classList.remove("noStroke")},f);function f(e,t){var n=this;d.call(this,e,t),this.gradientPropChangeRegistrar=new xp.EventRegistrar,this.bind(function(){return n.setFill(e.fill)},"fill.color"),this.bind(function(){return n.setFill(e.fill)},"fill.gradient"),this.bind(function(){return n.setFill(e.fill)},"fill"),this.bind(function(){return n.setFill(e.fill)},"fill.gradient.stops.0.color"),this.bind(function(){return n.setFill(e.fill)},"fill.gradient.stops.1.color"),this.bind(function(){return n.setStroke(e.stroke)},"stroke.color")}var m,v=(__extends(y,m=g),y.prototype.getTemplate=function(){var t=this;return xp.Dom.create('\n                <div class="ContainerItemNode ItemNode">\n                    <span class="nodeIcon expander"></span>\n                    <span class="name"></span>\n                    <span class="menu"></span>\n                </div>',{".name":function(e){return t.nameElement=e},".menu":function(e){return t.menuElement=e},".expander":function(e){return t.expanderElement=e}})},y.prototype.initEvents=function(){var t=this;m.prototype.initEvents.call(this),this.expanderElement.addEventListener("mousedown",function(e){t.model.isExpanded=!t.model.isExpanded,e.stopPropagation()}),this.expanderElement.addEventListener("touchstart",function(e){e.stopPropagation()})},Object.defineProperty(y.prototype,"expanded",{set:function(e){e?(this.expanderElement.classList.add("expanded"),this.expanderElement.classList.remove("collapsed")):(this.expanderElement.classList.add("collapsed"),this.expanderElement.classList.remove("expanded"))},enumerable:!0,configurable:!0}),y);function y(e,t,n){m.call(this,e,t),this.container=n}var x,w=(__extends(b,x=v),b.prototype.getTemplate=function(){var t=this;return xp.Dom.create('\n                <div class="LayerItemNode ContainerItemNode ItemNode">\n                    <span class="nodeIcon expander"></span>\n                    <span class="nodeIcon hider"></span>\n                    <span class="nodeIcon locker"></span>\n                    <span class="name"></span>\n                    <span class="menu"></span>\n                </div>',{".name":function(e){return t.nameElement=e},".menu":function(e){return t.menuElement=e},".expander":function(e){return t.expanderElement=e},".hider":function(e){return t.hiderElement=e},".locker":function(e){return t.lockerElement=e}})},b.prototype.initEvents=function(){var t=this;x.prototype.initEvents.call(this),this.hiderElement.addEventListener("mousedown",function(e){e.stopPropagation(),t.model.hidden=!t.model.hidden}),this.hiderElement.addEventListener("touchstart",function(e){e.stopPropagation()}),this.lockerElement.addEventListener("mousedown",function(e){e.stopPropagation(),t.tree.app.memento.isLocked||t.tree.app.memento.perform({modify:[t.model],action:function(){return t.model.locked?t.tree.app.document.actions.layer.unlock(t.model):t.tree.app.document.actions.layer.lock(t.model),null}})}),this.lockerElement.addEventListener("touchstart",function(e){e.stopPropagation()}),this.bind("isLayerHidden","hidden"),this.bind("isLayerLocked","locked")},Object.defineProperty(b.prototype,"isLayerHidden",{set:function(e){e?this.hiderElement.classList.remove("show"):this.hiderElement.classList.add("show")},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"isLayerLocked",{set:function(e){e?(this.domElement.classList.add("locked"),this.lockerElement.classList.add("locked")):(this.domElement.classList.remove("locked"),this.lockerElement.classList.remove("locked"))},enumerable:!0,configurable:!0}),b);function b(){x.apply(this,arguments)}}(E.UI||(E.UI={}))}(Inker=Inker||{}),function(e){var o,r;function t(e,t){var n=this;t.scrollBar="none",r.call(this,t,[new xp.Button({icon:o.Icons.logo,style:"logo",init:function(e){return n.logoButton=e}}),new xp.Button({text:"Undo",onClick:function(){return n.app.memento.undo()},icon:o.Icons.undo,enabled:"{memento.isUndoPossible}"}),new xp.Button({text:"Redo",onClick:function(){return n.app.memento.redo()},icon:o.Icons.redo,enabled:"{memento.isRedoPossible}"}),new xp.HBox({flex:"none",scrollBar:"none"},[new xp.Button({text:"Save",onClick:function(){return n.app.file.save()},icon:o.Icons.save,enabled:"({document} && !{document.isSaved})"}),new xp.Button({text:"Save As",onClick:function(){return n.app.file.saveAs()},icon:o.Icons.save,enabled:"(!!{document})",visible:"{platform.isChromeApp}"})]),new o.DocTabPanel(e,{flex:"shrink",margin:"0 1em",scrollBar:"none",init:function(e){return n.tabPanel=e}}),new xp.HBox({flex:"none",scrollBar:"none"},[new xp.Button({text:"New",onClick:function(){return n.app.file.new()},icon:o.Icons.new}),new xp.Button({text:"Open",onClick:function(){return n.app.file.open()},icon:o.Icons.open}),new xp.Button({icon:o.Icons.down,onClick:function(t){n.app.environment.getRecentDocuments(function(e){xp.ContextMenu.show(t.element.domElement,"vertical",0===e.length?[{text:"No recent files",disabled:!0,action:function(){}}]:e.map(function(e){return{text:e.name,action:function(){return n.app.file.open(e.id)}}}))})}})]),new xp.Placeholder({style:"windowDrag",flex:"stretch",height:"3em",width:"2em"}),new xp.HBox({visible:"{platform.isChromeApp}",style:"windowControls",flex:"none",height:"3em"},[new xp.Button({onClick:function(){return chrome.app.window.current().minimize()},icon:o.Icons.window.minimize}),new xp.Button({onClick:function(){return chrome.app.window.current().maximize()},icon:o.Icons.window.maximize,visible:"(!{window.isMaximized})"}),new xp.Button({onClick:function(){return chrome.app.window.current().restore()},icon:o.Icons.window.restore,visible:"{window.isMaximized}"}),new xp.Button({onClick:function(){return n.app.close()},icon:o.Icons.window.close})])]),this.app=e,window.addEventListener("resize",function(){return n.handleLayout()}),this.onRendered.addHandler(function(){return n.handleLayout()})}o=e.UI||(e.UI={}),r=xp.HBox,__extends(t,r),t.prototype.handleLayout=function(){var e=this,n={conditions:[],handle:function(e,t){n.conditions.push([e,t])},apply:function(){n.conditions.forEach(function(e){e[0]()}),e.domElement.scrollWidth>e.domElement.clientWidth&&n.conditions.forEach(function(e){e[1]()})}};n.handle(function(){e.logoButton.icon=o.Icons.logo,e.logoButton.domElement.classList.remove("collapsed")},function(){e.logoButton.icon=o.Icons.logo_small,e.logoButton.domElement.classList.add("collapsed")}),n.handle(function(){return e.domElement.classList.remove("collapsed")},function(){return e.domElement.classList.add("collapsed")}),n.apply(),this.tabPanel.handleLayout(),n.apply()},e=t,o.Header=e}(Inker=Inker||{}),function(e){var t,n;function o(){var e=this;n.call(this,{style:"content",maxWidth:"48em",height:"100%",padding:"1em 2em",width:"100%",itemsAlign:"stretch",itemsIndent:"0.5em"},[new xp.Label({style:"title",text:"HELP"}),new xp.CheckBox({text:"Display tips",checked:"{settings.help.displayTips}"}),new xp.VBox({flex:"stretch"},[new xp.Html({flex:"none",style:"helpArticle",init:function(e){e.domElement.onselectstart=function(e){return e.stopPropagation()},e.domElement.oncontextmenu=function(e){xp.ContextMenu.show(e.pageX,e.pageY,[{text:"Copy",icon:t.Icons.copy,action:function(){return document.execCommand("copy",!1,null)}}])}},html:'\n                        <article>\n\n                        <p>Official website <a href="http://inker.co/" target="_blank" rel="noreferrer noopener">inker.co</a></p>\n\n                        <h1>Overview</h1>\n\n                        <p>Inker is a <b>vector graphics editor</b> designed to simplify the creation of <b>neat shapes</b> which can be a part of a logotype, comic art or any other digital drawing. Images created with Inker <b>can be exported to <a href="http://en.wikipedia.org/wiki/Scalable_Vector_Graphics" target="_blank">SVG</a></b> and used anywhere in the web or in other graphics editor like Adobe Illustrator or CorelDRAW.</p>\n                        <p>In order to work with this app you are <b>recommended</b> to use a <b>mouse with two buttons and wheel</b> and a <b>keyboard</b>.</p>\n                        <p>On <b>touch screen</b> device use tap for primary action, tap and hold for secondary action, multi-touch for zoom.</p>\n\n\n                        <h1>Tools</h1>\n\n                        <h4>Path tool</h4>\n                        <img src="help/path-tool.gif"/>\n                        <p>Path tool is a major Inker tool. It is used for <b>creating curves</b>. Every curve consists of paths. Every path consists of points (smooth or cusp) and segments (curve or straight).</p>\n                        <p>Use left and right mouse buttons to <b>add points and segments</b> of different types and <b>convert them</b>. <b>Close the path</b> by right-clicking the start point. <b>Drag points and segments</b> to adjust the shape (right click to <b>reflect</b> selected points).</p>\n                        <p>To <b>make a hole</b> create two shapes with opposite directions, select them both and click <b>Join paths</b> or <b>Back minus front</b> (Inker uses <a href="http://en.wikipedia.org/wiki/Nonzero-rule" target="_blank">non-zero winding rule</a> to determine which paths are holes).</p>\n                        <p>Use as little number of points as possible to simplify curve adjustment.</p>\n\n                        <h4>Draw tool</h4>\n                        <img src="help/draw-tool.gif"/>\n                        <p>This tool is used for <b>free-hand drawing</b>. Use Pencil to draw shapes\' <b>outlines</b>, Brush to draw <b>brush lines</b>, Eraser to <b>erase</b> parts of shapes.</p> It is recommended to use a graphics tablet for better results.\n\n                        <h4>Select tool</h4>\n                        <p>Use Select tool to <b>select, move, arrange, scale or rotate</b> the shapes.</p> You can also edit <b>gradients</b> with this shape.\n\n                        <h4>Shape tool</h4>\n                        <p><b>Circles or rectangles</b> can be drawn with this tool.</p>\n\n                        <h4>Text tool</h4>\n                        <p>Click on the canvas and <b>type a text</b>. Text can be converted to a curve, but avoid converting large texts as far as they may contain lots of points and decrease performance when you edit them.</p>\n\n                        <h4>Ruler tool</h4>\n                        <p>Rulers are used to <b>align curves\' points</b> to them.</p>\n                        <p>When you drag a point, hit <b>SHIFT</b> and <b>additional rulers</b> will appear. The angles of these rulers can be specified at Ruler tool panel.</p>\n\n                        <h4>Browse tool</h4>\n                        <p>This tool is used for <b>browsing around</b> or reviewing your job.</p>\n                        <p>Hold <b>space bar</b> to enable this tool, move around, and release <b>space bar</b> to return to previously active tool.</p>\n\n\n                        <h1>Color palette</h1>\n                        \n                        <img src="help/color-palette.gif"/>\n                        <p>The Color palette is used to select and adjust the document colors.</p>\n                        <p>Left click a color to <b>fill</b> the selected shapes, right click to pick the <b>stroke color</b>. When no shapes are selected, picked colors will be set as <b>default</b>.</p>\n                        <p>Click the <b>Edit colors</b> button to start adjusting the colors. Left click to select a color, right click to adjust two colors at the same time. Drag the colors to organize them. To <b>add</b> a color click <b>+</b>. To <b>remove</b> a color drag it away. Click <b>Done</b> when you are done.</p>\n\n                        <h1>Gradients</h1>\n                        \n                        <img src="help/gradient.gif"/>\n                        <p>Click "Linear gradient" or "Radial gradient" button to <b>add gradient</b> to selected shapes.</p>\n                        <p>Click a gradient stop to <b>move</b> all selected gradient stops (hold SHIFT to select multiple gradient stops or deselect one).</p>\n\n                        <h1>Object browser</h1>\n                        \n                        <img src="help/object-browser.gif"/>\n                        <p>Use object browser to <b>add a layer, select multiple objects, arrange them, rename, delete or merge in a group</b>.</p>\n                        <p>Click an eye icon to toggle <b>layer\'s visibility</b>.</p>\n\n\n                        <h1>Export/import</h1>\n\n                        <p>To <b>export</b> a drawing click a menu icon in the top-left corner and then choose between PNG (pixel image) or SVG (vector image).</p>\n                        <p>You can also <b>import a sketch</b> image, but avoid importing large images as it will decrease performance while working with the app or saving the files.</p>\n\n\n                        <h1>Hot keys</h1>\n\n                        <p>To draw like a ninja use the <b>hot keys</b>:</p>\n\n                        <h4>General hot keys</h4>\n                        <table class="hotKeyTable">\n                          <tr><td>CTRL+Z</td><td>undo</td></tr>\n                          <tr><td>CTRL+Y or<br/>CTRL+SHIFT+Z</td><td>redo</td></tr>\n                          <tr><td>DELETE</td><td>delete</td></tr>\n                          <tr><td>CTRL+X</td><td>cut</td></tr>\n                          <tr><td>CTRL+C</td><td>copy</td></tr>\n                          <tr><td>CTRL+V</td><td>paste copied</td></tr>\n                          <tr><td>SHIFT+D</td><td>duplicate</td></tr>\n                          <tr><td>CTRL+A</td><td>select all</td></tr>\n                          <tr><td>CTRL+D</td><td>deselect all</td></tr>\n                          <tr><td>CTRL+G</td><td>merge in a group</td></tr>\n                          <tr><td>CTRL+U</td><td>ungroup</td></tr>\n                          <tr><td>CTRL+SHIFT+U</td><td>deep ungroup</td></tr>\n                          <tr><td>PAGEUP</td><td>bring forward</td></tr>\n                          <tr><td>PAGEDOWN</td><td>send backward</td></tr>\n                          <tr><td>HOME</td><td>bring front</td></tr>\n                          <tr><td>END</td><td>send back</td></tr>\n                          <tr><td>Z or<br/>SPACE</td><td>Browse tool</td></tr>\n                          <tr><td>X</td><td>Select tool</td></tr>\n                          <tr><td>C</td><td>Path tool</td></tr>\n                          <tr><td>V</td><td>Draw tool</td></tr>\n                          <tr><td>B</td><td>Shape tool</td></tr>\n                          <tr><td>N</td><td>Text tool</td></tr>\n                          <tr><td>M</td><td>Ruler tool</td></tr>\n                          <tr><td>CTRL+S</td><td>save</td></tr>\n                          <tr><td>+ or =</td><td>zoom in</td></tr>\n                          <tr><td>-</td><td>zoom out</td></tr>\n                        </table>\n\n                        <h4>Path tool hot keys</h4>\n                        <table class="hotKeyTable">\n                          <tr><td>DELETE</td><td>delete points</td></tr>\n                          <tr><td>ALT+A</td><td>align points</td></tr>\n                          <tr><td>ALT+D</td><td>duplicate points</td></tr>\n                        </table>\n\n                        <h4>Draw tool hot keys</h4>\n                        <table class="hotKeyTable">\n                          <tr><td>Q</td><td>pencil</td></tr>\n                          <tr><td>W</td><td>brush</td></tr>\n                          <tr><td>E</td><td>eraser</td></tr>\n                          <tr><td>[</td><td>decrease brush</td></tr>\n                          <tr><td>]</td><td>increase brush</td></tr>\n                        </table>\n\n                        <h4>Ruler tool hot keys</h4>\n                        <table class="hotKeyTable">\n                          <tr><td>DELETE</td><td>delete rulers</td></tr>\n                          <tr><td>ALT+D</td><td>duplicate rulers</td></tr>\n                        </table>\n                        \n                        <h4>Right click</h4>\n                        <p>If your pointer device doesn\'t have a secondary button, you can imitate the <b>right click</b> by holding <b>ALT</b> or <b>CTRL</b> key while doing a click.</p>\n                        \n                        <h4>macOS</h4>\n                        <p>Use <b>Command</b> key instead of <b>Control</b>.</p>\n\n\n                        <h1>Good luck!</h1>\n\n                        <p>For any questions e-mail via <a href="mailto:inkerapp@gmail.com">inkerapp@gmail.com</a></p>\n\n                        </article>\n                    '})]),new xp.HBox({contentAlign:"right",margin:"1em 0 0 0"},[new xp.Button({text:"Close",onClick:function(){return e.close()},style:"largeButton"})])])}t=e.UI||(e.UI={}),n=xp.Modal,__extends(o,n),o.prototype.getTemplate=function(){return xp.Dom.create('<div class="HelpModal Modal VBox"></div>')},e=o,t.HelpModal=e}(Inker=Inker||{}),function(e){(e.UI||(e.UI={})).Icons={addLayer:".icon_addLayer",bringBack:".icon_bringBack",bringBackward:".icon_bringBackward",bringForward:".icon_bringForward",bringFront:".icon_bringFront",browseTool:{all:".icon_browseTool_all",center:".icon_browseTool_center"},brush:".icon_brush",copy:".icon_copy",cut:".icon_cut",delete:".icon_delete",deselect:".icon_deselect",down:".icon_down",eraser:".icon_eraser",gradientLinear:".icon_gradientLinear",gradientRadial:".icon_gradientRadial",group:".icon_group",help:".icon_help",left:".icon_left",logo:"style/img/inker_logo_32.svg",logo_small:".icon_inker_small",menu:".icon_menu",new:".icon_new",open:".icon_open",paste:".icon_paste",pathTool:{align:".icon_pathTool_align",backMFront:".icon_pathTool_backMFront",close:".icon_pathTool_close",distort:".icon_pathTool_distort",frontMBack:".icon_pathTool_frontMBack",intersection:".icon_pathTool_intersection",join:".icon_pathTool_join",open:".icon_pathTool_open",reverse:".icon_pathTool_reverse",simplify:".icon_pathTool_simplify",split:".icon_pathTool_split",strokeToPath:".icon_pathTool_strokeToPath",union:".icon_pathTool_union"},pencil:".icon_pencil",plus:".icon_plus",redo:".icon_redo",right:".icon_right",save:".icon_save",select:".icon_select",selectTool:{flipX:".icon_selectTool_flipX",flipY:".icon_selectTool_flipY"},shapeTool:{ellipse:".icon_shapeTool_ellipse",rectangle:".icon_shapeTool_rectangle"},textTool:{anchorLeft:".icon_textTool_anchorLeft",anchorMiddle:".icon_textTool_anchorMiddle",anchorRight:".icon_textTool_anchorRight",weightBold:".icon_textTool_weightBold",weightLight:".icon_textTool_weightLight",weightNormal:".icon_textTool_weightNormal"},tools:{browse:".icon_browseTool",path:".icon_pathTool",draw:".icon_pencil",ruler:".icon_rulerTool",select:".icon_selectTool",shape:".icon_shapeTool",text:".icon_textTool"},undo:".icon_undo",ungroup:".icon_ungroup",up:".icon_up",window:{close:".icon_window_close",maximize:".icon_window_maximize",minimize:".icon_window_minimize",restore:".icon_window_restore"},zoomIn:".icon_zoomIn",zoomOut:".icon_zoomOut"}}(Inker=Inker||{}),function(e){var s,n;function o(e,t){n.call(this,t);t=function(e){e.preventDefault(),e.stopPropagation()};this.domElement.addEventListener("mousedown",t),this.domElement.addEventListener("mousemove",t),this.domElement.addEventListener("mouseup",t),this.domElement.addEventListener("click",t),this.domElement.addEventListener("touchstart",t),this.domElement.addEventListener("touchmove",t),this.domElement.addEventListener("touchend",t)}s=e.UI||(e.UI={}),n=xp.VBox,__extends(o,n),o.prototype.getTemplate=function(){return xp.Dom.create('<div class="MessageList VBox"></div>')},o.prototype.showMessage=function(e,t,r,n){if(["error","warn","info","log"].indexOf(t)<0)throw new Error("Unknown message type "+t+".");var i=new xp.HBox({style:"message "+t,onClick:function(){i.domElement.classList.toggle("expanded")},init:function(e){e.domElement.addEventListener("touchstart",function(){return e.onClick.invoke(null)})}},[new xp.Label({flex:"stretch",style:"messageText",text:e,init:function(e){e.domElement.onselectstart=function(e){return e.stopPropagation()}}}),new xp.HBox({flex:"none",scrollBar:"none",style:"messageButtonsContainer",init:function(n){if(r)for(var o in r)!function(t){var e=new xp.Button({style:"messageButton",text:o,onClick:function(e){r[t](),i.remove()},init:function(e){e.domElement.addEventListener("touchstart",function(){return e.onClick.invoke(null)})}});n.append(e)}(o);else{var e=new xp.Button({style:"messageClose",icon:s.Icons.window.close,onClick:function(){return i.remove()},init:function(e){e.domElement.addEventListener("touchstart",function(){return e.onClick.invoke(null)})}});n.append(e)}}})]);this.append(i),n&&setTimeout(function(){i.domElement.classList.add("closing"),setTimeout(function(){i.remove()},2e3)},o.autoCloseTimeout)},o.autoCloseTimeout=5e3,e=o,s.MessageList=e}(Inker=Inker||{}),function(e){var t,o;function n(e,t){var n=this;o.call(this,{style:"content",maxWidth:"24em",maxHeight:"100%",padding:"1em 2em"},[new xp.Label({style:"title",text:"New document"}),new xp.Placeholder({height:"2em",flex:"shrink"}),new xp.VBox({itemsAlign:"stretch",itemsIndent:"1em"},[new xp.HBox({itemsIndent:"0.5em",contentAlign:"right"},[new xp.Label({text:"Doc. name"}),new xp.TextBox({placeholder:"name",text:"{name}",type:"string",width:"10em",flex:"none"})]),new xp.HBox({itemsIndent:"0.5em",contentAlign:"right"},[new xp.Label({text:"Width (px)"}),new xp.TextBox({placeholder:"width",text:"{width}",type:"number",width:"10em",flex:"none"})]),new xp.HBox({itemsIndent:"0.5em",contentAlign:"right"},[new xp.Label({text:"Height (px)"}),new xp.TextBox({placeholder:"height",text:"{height}",type:"number",width:"10em",flex:"none"})])]),new xp.Label({name:"label_error",style:"errorText"}),new xp.Placeholder({height:"3em",flex:"shrink"}),new xp.HBox({contentAlign:"right"},[new xp.Button({text:"Cancel",style:"largeButton",onClick:function(e){return n.close()}}),new xp.Button({text:"OK",style:"largeButton",onClick:function(e){return n.tryCreateDoc()}})])]),this.resultCallback=t,this.doc=xp.observable(e),this.onRendered.addHandler(function(){n.scope=n.doc},this),this.onClose=function(){return window.removeEventListener("keypress",n.keyPressHandler),!0},this.keyPressHandler=function(e){13===e.keyCode&&n.tryCreateDoc()},window.addEventListener("keypress",this.keyPressHandler)}t=e.UI||(e.UI={}),o=xp.Modal,__extends(n,o),n.prototype.getTemplate=function(){return xp.Dom.create('<div class="NewDocModal Modal VBox"></div>')},n.prototype.tryCreateDoc=function(){"string"==typeof this.doc.name&&""!==this.doc.name.trim()?isNaN(+this.doc.width)||this.doc.width<1?this.label_error.text="Invalid width":isNaN(+this.doc.height)||this.doc.height<1?this.label_error.text="Invalid height":(this.close(),this.resultCallback(this.doc)):this.label_error.text="Invalid name"},e=n,t.NewDocModal=e}(Inker=Inker||{}),function(n){var o,r,e;function t(e){var t=this;r.call(this,e,[new xp.HBox({style:"buttonsPanel",height:"3em",scrollBar:"none"},[new xp.Button({text:"Add layer",onClick:function(){return t.onAddLayer.invoke(!0)},icon:o.Icons.addLayer}),new xp.Placeholder,new xp.Button({style:"buttonCollapse",icon:o.Icons.right,init:function(e){return t.buttonCollapse=e},onClick:function(){return t.onInput("collapsed",!t.collapsed)}})]),new xp.VBox({name:"rightActions"},[new xp.Placeholder({height:"1em"}),new xp.Button({icon:o.Icons.bringFront,text:"Front",enabled:"({document.selectedElements.length} > 0)",onClick:function(){return t.app.getTool(n.Tools.SelectTool).actions.bringFront()}}),new xp.Button({icon:o.Icons.bringForward,text:"Fwd",enabled:"({document.selectedElements.length} > 0)",onClick:function(){return t.app.getTool(n.Tools.SelectTool).actions.bringForward()}}),new xp.Button({icon:o.Icons.bringBackward,text:"Bwd",enabled:"({document.selectedElements.length} > 0)",onClick:function(){return t.app.getTool(n.Tools.SelectTool).actions.bringBackward()}}),new xp.Button({icon:o.Icons.bringBack,text:"Back",enabled:"({document.selectedElements.length} > 0)",onClick:function(){return t.app.getTool(n.Tools.SelectTool).actions.bringBack()}}),new xp.Button({margin:"1em 0 0 0",text:"Desel.",icon:o.Icons.deselect,enabled:"({document.selectedElements.length} > 0)",onClick:function(){return t.app.document.actions.select.deselectAll()}})]),new o.DocTree(app,{name:"tree",flex:"stretch"})]),this.app=app}o=n.UI||(n.UI={}),r=xp.VBox,__extends(t,r),t.prototype.getTemplate=function(){return xp.Dom.create('<div class="ObjectBrowser VBox"></div>')},t.prototype.defineProperties=function(){var t=this;r.prototype.defineProperties.call(this),this.defineProperty("collapsed",{setter:function(e){e?(t.buttonCollapse.icon=o.Icons.left,t.buttonCollapse.text="Objects",t.domElement.classList.add("collapsed"),t.domElement.classList.remove("expanded")):(t.buttonCollapse.icon=o.Icons.right,t.buttonCollapse.text="",t.domElement.classList.remove("collapsed"),t.domElement.classList.add("expanded")),t.app&&t.app.window&&t.app.window.canvas.handleResize()}})},t.prototype.setDefaults=function(){r.prototype.setDefaults.call(this),this.collapsed=!1},t.prototype.initEvents=function(){r.prototype.initEvents.call(this),this.onAddLayer=new xp.Event},e=t,o.ObjectBrowser=e}(Inker=Inker||{}),function(e){var i,s;function t(n,e,t,o){var r=this;s.call(this,{style:"content",maxHeight:"100%",maxWidth:"100%",height:"22em",onClose:function(){return 0<n.documents.length}},[new xp.HBox({flex:"stretch",scrollBar:"none"},[new xp.VBox({padding:"2em 0 2em 2em",width:"10em",style:"leftPanel"},[new xp.Html({html:'<div class="startScreen_logo"></div>',flex:"none"}),new xp.Placeholder({height:"1em",flex:"shrink"}),new xp.ToggleButton({style:"largeButton",group:"tab",text:"Create new",checked:!0,onCheckChange:function(e){r.recentDocTab.visible=!1,r.newDocTab.visible=!0,e.element.parent.children[e.element.parent.children.indexOf(e.element)+1].checked=!1}}),new xp.ToggleButton({style:"largeButton",group:"tab",text:"Recent docs",onCheckChange:function(e){r.newDocTab.visible=!1,r.recentDocTab.visible=!0,e.element.parent.children[e.element.parent.children.indexOf(e.element)-1].checked=!1}}),new xp.Button({style:"largeButton",text:"Open...",icon:i.Icons.open,onClick:function(){n.file.open(null,function(){r.close()})}})]),new xp.VBox({width:"19em",padding:"2em 2em 2em 1em",style:"rightPanel"},[new xp.VBox({itemsAlign:"stretch",flex:"stretch",init:function(e){return r.newDocTab=e}},[new xp.Label({style:"title",text:"Create new"}),new xp.Placeholder({height:"1em",flex:"shrink"}),new xp.VBox({itemsIndent:"1em"},[new xp.HBox({itemsIndent:"0.5em",contentAlign:"right"},[new xp.Label({text:"Doc. name"}),new xp.TextBox({placeholder:"name",text:"{name}",type:"string",width:"10em",flex:"none"})]),new xp.HBox({itemsIndent:"0.5em",contentAlign:"right"},[new xp.Label({text:"width (px)"}),new xp.TextBox({placeholder:"width",text:"{width}",type:"number",width:"10em",flex:"none"})]),new xp.HBox({itemsIndent:"0.5em",contentAlign:"right"},[new xp.Label({text:"height (px)"}),new xp.TextBox({placeholder:"height",text:"{height}",type:"number",width:"10em",flex:"none"})])]),new xp.Label({name:"label_error",style:"errorText"}),new xp.Placeholder,new xp.HBox({contentAlign:"right"},[new xp.Button({text:"Create",style:"largeButton",onClick:function(e){return r.onCreate()}})])]),new xp.VBox({visible:!1,itemsAlign:"stretch",flex:"stretch",init:function(e){return r.recentDocTab=e}},[new xp.Label({text:"Recent",style:"title"}),new xp.VBox({itemsAlign:"left",flex:"shrink",padding:"0 0 0 0.5em"},0===t.length?[new xp.Label({text:"No recent files"})]:t.map(function(t){return new xp.Label({text:t.name,style:"action",onClick:function(e){n.file.open(t.id,function(){return r.close()})}})}))])])])]),this.doc=xp.observable(e),this.createDoc=o,this.onRendered.addHandler(function(){r.scope=r.doc},this),this.onClosed=new xp.Event,this.keyPressHandler=function(e){13===e.keyCode&&r.onCreate()},window.addEventListener("keypress",this.keyPressHandler)}i=e.UI||(e.UI={}),s=xp.Modal,__extends(t,s),t.prototype.getTemplate=function(){return xp.Dom.create('<div class="StartScreen Modal VBox"></div>')},t.prototype.close=function(){s.prototype.close.call(this),window.removeEventListener("keypress",this.keyPressHandler),this.onClosed.invoke(!0)},t.prototype.onCreate=function(){return"string"!=typeof this.doc.name||""===this.doc.name.trim()?!(this.label_error.text="Invalid name"):isNaN(+this.doc.width)||this.doc.width<1?!(this.label_error.text="Invalid width"):isNaN(+this.doc.height)||this.doc.height<1?!(this.label_error.text="Invalid height"):(this.createDoc(this.doc),void this.close())},e=t,i.StartScreen=e}(Inker=Inker||{}),function(s){var a,l,e;function t(n,e){var o=this;l.call(this,e,[new a.ColorPalette(n,{name:"colorPalette",flex:"shrink",height:"2.5em"}),new xp.HBox({scrollBar:"none"},[new xp.Label({text:"stroke width:",margin:"0 0.25em 0 0.5em",style:"inputLabel",visible:'(({document.selectedElements[0].stroke.color} || {document.defaultStroke.color}) !== "transparent")'}),new xp.TextBox({text:"({document.selectedElements[0].stroke.width} !== undefined ? {document.selectedElements[0].stroke.width} : {document.defaultStroke.width})",visible:'(({document.selectedElements[0].stroke.color} || {document.defaultStroke.color}) !== "transparent")',flex:"none",width:"3em",type:"number",min:0,onTextChange:function(e){var t=parseFloat(e.newText)||0;0<n.document.selectedElements.length?o.app.memento.isLocked||o.app.memento.perform({modify:o.app.document.getSelectedElements(s.Doc.Drawing),action:function(){return n.document.cascadeSelected(s.Doc.Drawing,function(e){e.stroke.width=t}),null}}):o.app.memento.isLocked||o.app.memento.perform({props:["defaultStroke"],action:function(){return n.document.defaultStroke.width=t,null}})}})]),new xp.HBox({scrollBar:"none"},[new xp.Label({text:"opacity:",margin:"0 0.25em 0 1em",style:"inputLabel"}),new xp.TextBox({name:"textBox_opacity",text:"({document.selectedElements[0].opacity})",flex:"none",width:"3em",type:"number",min:0,max:1,step:.1,onTextChange:function(e){var t=parseFloat(e.newText)||0;0<n.document.selectedElements.length&&(o.app.memento.isLocked||o.app.memento.perform({modify:o.app.document.getSelectedElements(s.Doc.Drawing),action:function(){return n.document.cascadeSelected(s.Doc.Drawing,function(e){e.opacity=t}),null}}))}})]),new xp.HBox({scrollBar:"none"},[new xp.Button({margin:"0 0 0 1em",text:"Linear\ngradient",icon:a.Icons.gradientLinear,style:"multilineButton",enabled:"({document.selectedElements.length} > 0)",onClick:function(){return o.setLinearGradient()},key:"advanced"}),new xp.Button({text:"Radial\ngradient",icon:a.Icons.gradientRadial,style:"multilineButton",enabled:"({document.selectedElements.length} > 0)",onClick:function(){return o.setRadialGradient()},key:"advanced"})])]),this.app=n,this.toolItems=this.children.slice(0),this.moreButton=new xp.Button({style:"stylePanelMoreButton",text:"More",icon:a.Icons.up,onClick:function(e){e.domEvent.stopPropagation(),o.isMenuExpanded?o.collapseMenu():o.expandMenu()}}),this.moreMenu=new xp.HBox({style:"stylePanelMoreMenu ToolPanel",scope:this.scope,useParentScope:!1}),this.onScopeChanged.addHandler(function(){o.moreMenu.scope=o.scope}),window.addEventListener("resize",function(){return o.handleLayout()}),this.onRendered.addHandler(function(){return o.handleLayout()});var t=new xp.EventRegistrar;this.bind(function(){t.unsubscribeAll(),n.document&&n.document.colors&&t.subscribe(n.document.colors.onCollectionChanged,function(e){e.action!==xp.CollectionChangeAction.Replace&&o.handleLayout()}),o.handleLayout()},"document.colors");var r=new xp.Expression('({document.selectedElements[0].stroke.color} || {document.defaultStroke.color}) !== "transparent"',this.app),i=null;r.onPropertyChanged.addHandler(function(e){r.result!==i&&(o.handleLayout(),i=r.result)})}a=s.UI||(s.UI={}),l=xp.HBox,__extends(t,l),t.prototype.setLinearGradient=function(){var e,n=this;this.app.memento.isLocked||(0<(e=this.app.document.getSelectedElements(s.Doc.Drawing).filter(function(e){return!e.fill.gradient||"radial"===e.fill.gradient.type})).length&&this.app.memento.perform({modify:e,action:function(){return e.forEach(function(e){var t;e.fill.gradient?"radial"===e.fill.gradient.type&&(t=e.fill.gradient,e.fill.gradient=xp.observable({type:"linear",start:Geo.getMidPoint(t.end,t.start,2),end:t.end,stops:t.stops})):(t=e.getBBox(),e.fill.gradient=xp.observable({type:"linear",start:{x:t.left+t.width/2,y:t.top},end:{x:t.left+t.width/2,y:t.top+t.height},stops:[{offset:0,color:e.fill.color},{offset:1,color:n.app.document.defaultStroke.color}]}))}),null}}),this.app.currentTool instanceof s.Tools.SelectTool||(this.app.currentTool=this.app.getTool(s.Tools.SelectTool)))},t.prototype.setRadialGradient=function(){var e,n=this;this.app.memento.isLocked||(0<(e=this.app.document.getSelectedElements(s.Doc.Drawing).filter(function(e){return!e.fill.gradient||"linear"===e.fill.gradient.type})).length&&this.app.memento.perform({modify:e,action:function(){return e.forEach(function(e){var t;e.fill.gradient?"linear"===e.fill.gradient.type&&(t=e.fill.gradient,e.fill.gradient=xp.observable({type:"radial",start:Geo.getMidPoint(t.end,t.start),end:t.end,stops:t.stops})):(t=e.getBBox(),e.fill.gradient=xp.observable({type:"radial",start:{x:t.left+t.width/2,y:t.top+t.height/2},end:{x:t.left+t.width/2,y:t.top+t.height},stops:[{offset:0,color:e.fill.color},{offset:1,color:n.app.document.defaultStroke.color}]}))}),null}}),this.app.currentTool instanceof s.Tools.SelectTool||(this.app.currentTool=this.app.getTool(s.Tools.SelectTool)))},t.prototype.handleLayout=function(){var t=this;this.collapseMenu(),this.colorPalette.saveContainerScroll(),this.colorPalette.flex="none";for(var e=this.children.length-1;0<=e;e--)this.children[e].detach();for(e=this.moreMenu.children.length-1;0<=e;e--)this.moreMenu.children[e].detach();var n=this.domElement.clientWidth,o=[];this.toolItems.forEach(function(e){o.push(e.domElement.style.flex),e.domElement.style.flex="none !important",t.append(e)});for(e=this.toolItems.length-1;1<=e;e--){var r=this.toolItems[e];if(!(this.domElement.scrollWidth>n)||r instanceof xp.Placeholder)break;this.moreMenu.prepend(r)}0<this.moreMenu.children.length&&(this.append(this.moreButton),this.domElement.scrollWidth>n&&this.moreMenu.prepend(r),this.moreMenu.visible=!1,this.append(this.moreMenu)),this.toolItems.forEach(function(e,t){e.domElement.style.flex=o[t]}),this.colorPalette.flex="shrink",this.colorPalette.restoreContainerScroll()},t.prototype.expandMenu=function(){var e=this;this.moreMenu.visible=!0,this.isMenuExpanded=!0;var t=new xp.EventRegistrar,n=function(){window.removeEventListener("click",n),t.unsubscribeAll(),setTimeout(function(){e.isMenuExpanded&&e.collapseMenu()},0)};window.addEventListener("click",n),this.moreMenu.cascadeBy(function(e){e instanceof xp.Button?t.subscribe(e.onClick,function(e){e.domEvent.stopPropagation(),n()}):t.subscribe(e.onClick,function(e){return e.domEvent.stopPropagation()})})},t.prototype.collapseMenu=function(){this.moreMenu.visible=!1,this.isMenuExpanded=!1},e=t,a.StylePanel=e}(Inker=Inker||{}),function(e){var o,r;function t(e,t){var n=this;r.call(this,e,t),this.isMenuExpanded=!1,this.applyMarkup({flex:"stretch",scrollBar:"horizontal"}),this.toolItems=this.children.slice(0),this.moreButton=new xp.Button({style:"toolPanelMoreButton",text:"More",icon:o.Icons.down,onClick:function(e){e.domEvent.stopPropagation(),n.isMenuExpanded?n.collapseMenu():n.expandMenu()}}),this.moreMenu=new xp.HBox({style:"toolPanelMoreMenu ToolPanel"}),this.moreMenu.useParentScope=!1,this.moreMenu.scope=this.scope,this.onScopeChanged.addHandler(function(){return n.moreMenu.scope=n.scope}),window.addEventListener("resize",function(){n.isActive&&n.handleLayout()})}o=e.UI||(e.UI={}),r=xp.HBox,__extends(t,r),t.prototype.getTemplate=function(){return xp.Dom.create('<div class="ToolPanel HBox"></div>')},t.prototype.defineProperties=function(){var t=this;r.prototype.defineProperties.call(this),this.defineProperty("isActive",{setter:function(e){e?(t.domElement.classList.remove("inactive"),t.handleLayout()):t.domElement.classList.add("inactive")}})},t.prototype.handleLayout=function(){var t=this;this.collapseMenu(),this.domElement.classList.remove("collapsed");for(var e=this.children.length-1;0<=e;e--)this.children[e].detach();for(e=this.moreMenu.children.length-1;0<=e;e--)this.moreMenu.children[e].detach();var n=this.domElement.clientWidth;this.toolItems.forEach(function(e){t.append(e)}),this.domElement.scrollWidth>n&&this.domElement.classList.add("collapsed");for(e=this.toolItems.length-1;0<=e;e--){var o=this.toolItems[e];if(!(this.domElement.scrollWidth>n))break;this.moreMenu.prepend(o)}0<this.moreMenu.children.length&&(this.append(this.moreButton),this.domElement.scrollWidth>n&&this.moreMenu.prepend(o),this.moreMenu.visible=!1,this.append(this.moreMenu))},t.prototype.expandMenu=function(){var e=this;this.moreMenu.visible=!0,this.isMenuExpanded=!0;var t=new xp.EventRegistrar,n=function(){window.removeEventListener("click",n),t.unsubscribeAll(),setTimeout(function(){e.isMenuExpanded&&e.collapseMenu()},0)};window.addEventListener("click",n),this.moreMenu.cascadeBy(function(e){e instanceof xp.Button?t.subscribe(e.onClick,function(e){e.domEvent.stopPropagation(),n()}):t.subscribe(e.onClick,function(e){return e.domEvent.stopPropagation()})})},t.prototype.collapseMenu=function(){this.moreMenu.visible=!1,this.isMenuExpanded=!1},e=t,o.ToolPanel=e}(Inker=Inker||{}),function(e){var o,r;function t(e,t){var n=this;r.call(this,t,[]),this.toolButtons=[],this.isMenuExpanded=!1,this.app=e,this.moreButton=new xp.Button({style:"toolSelectorMoreButton toolToggle",icon:o.Icons.right,text:"More",onClick:function(e){e.domEvent.stopPropagation(),n.isMenuExpanded?n.collapseMenu():n.expandMenu()}}),this.moreMenu=new xp.HBox({style:"toolSelectorMoreMenu"}),window.addEventListener("resize",function(){return n.handleLayout()})}o=e.UI||(e.UI={}),r=xp.VBox,__extends(t,r),t.prototype.getTemplate=function(){return xp.Dom.create('<div class="ToolSelector VBox"></div>')},t.prototype.addToolButton=function(e){this.insert(e,this.toolButtons.length),this.toolButtons.push(e)},t.prototype.handleLayout=function(){var t=this;if(this.collapseMenu(),0!==this.toolButtons.length){for(var e=this.children.length-1;0<=e;e--)this.children[e].detach();for(e=this.moreMenu.children.length-1;0<=e;e--)this.moreMenu.children[e].detach();this.append(this.toolButtons[0]);var n=this.domElement.getBoundingClientRect().height,o=this.toolButtons[0].domElement.getBoundingClientRect().height;this.detachChild(this.toolButtons[0]);var r,i,s=0,a=[],l=[];this.toolButtons.forEach(function(e){((s+=o)<=n?a:l).push(e)}),0<a.length&&0<l.length&&l.unshift(a.splice(a.length-1,1)[0]),this.app.currentTool&&(i=function(e,t){for(var n=0;n<e.length;n++)if(t(e[n]))return e[n];return null}(this.toolButtons,function(e){return t.app.currentTool.getName()===e.text}),r=l.indexOf(i),0<a.length&&0<=r&&(l.splice(r,1),l.unshift(a[a.length-1]),a.splice(a.length-1,1,i))),a.forEach(function(e){return t.append(e)}),l.forEach(function(e){return t.moreMenu.append(e)}),0<this.moreMenu.children.length&&0<this.children.length&&(this.append(this.moreButton),r=this.moreButton.domElement.getBoundingClientRect().top,i=parseFloat(window.getComputedStyle(this.domElement).fontSize),this.moreMenu.domElement.style.top=r/i+"em")}},t.prototype.expandMenu=function(){var t=this;this.append(this.moreMenu),this.isMenuExpanded=!0;var n=function(e){window.removeEventListener("click",n),setTimeout(function(){t.isMenuExpanded&&t.collapseMenu()},0)};window.addEventListener("click",n)},t.prototype.collapseMenu=function(){this.moreMenu.parent===this&&this.detachChild(this.moreMenu),this.isMenuExpanded=!1},e=t,o.ToolSelector=e}(Inker=Inker||{}),function(e){var t,r;function n(t,e){var n=this;r.call(this),this.refresh(e),t.window.append(this);function o(){n.remove()}t.window.canvas.domElement;this.doNotShowElement.onmousedown=function(e){t.settings.help.displayTips=!1,o()},this.closeElement.onmousedown=function(e){o()}}t=e.UI||(e.UI={}),r=xp.Element,__extends(n,r),n.prototype.refresh=function(e){var t=this;setTimeout(function(){return t._refresh(e)},0)},n.prototype._refresh=function(e){var t=e.title,n=e.content.trim(),o=app.window.domElement.getBoundingClientRect(),r=e.bounds||o,i=e.location;this.domElement.classList.add("left"),this.titleElement.textContent=t,"<"===n[0]?this.contentElement.innerHTML=n:this.contentElement.textContent=n;o=this.domElement.getBoundingClientRect(),e=this.arrowElement.getBoundingClientRect(),t=e.height/2,i.x,n=i.y-t,r.top,r.bottom;this.domElement.style.left=r.left+i.x+"px";i.y,r.height;n+e.height-t<=o.height?(this.domElement.style.top=r.top+t+"px",this.arrowElement.style.top=n-t+"px"):(this.domElement.style.top=r.top+n+e.height-o.height+"px",this.arrowElement.style.top=o.height-e.height+"px"),this.domElement.classList.add("visible")},n.prototype.getTemplate=function(){var t=this;return xp.Dom.create('\n                <div class="ToolTip">\n                    <div class="arrow"></div>\n                    <div class="container">\n                        <div class="top"><span class="title">Title</span><a class="close">✕</a></div>\n                        <div class="content">Content</div>\n                        <a class="doNotShow">✕ I\'ve seen all the tips, do not show</a>\n                    </div>\n                </div>\n                ',{".arrow":function(e){return t.arrowElement=e},".title":function(e){return t.titleElement=e},".content":function(e){return t.contentElement=e},".close":function(e){return t.closeElement=e},".doNotShow":function(e){return t.doNotShowElement=e}})},e=n,t.ToolTip=e}(Inker=Inker||{}),function(e){var t,s;function n(t,n,o,r){var i=this;s.call(this,{style:"content",maxWidth:"24em",maxHeight:"100%",padding:"1em 2em"},[new xp.Label({style:"title",text:"Trace image"}),new xp.Placeholder({height:"2em",flex:"shrink"}),new xp.VBox({itemsAlign:"stretch",itemsIndent:"1em"},[new xp.HBox({itemsIndent:"0.5em",contentAlign:"right"},[new xp.Label({text:"Max colors count"}),new xp.TextBox({placeholder:"max colors count",value:"{maxColors}",type:"number",min:2,max:32,width:"10em",flex:"none"})]),new xp.HBox({itemsIndent:"0.5em",contentAlign:"right"},[new xp.Label({text:"Input size (px)"}),new xp.TextBox({placeholder:"input size",value:"{inputSize}",type:"number",min:1,max:4096,width:"10em",flex:"none",onTextChange:function(e){return n(Number(e.newText)||1)}})]),new xp.VBox({itemsIndent:"none",contentAlign:"middle"},[new xp.Label({text:"Warning: larger size increases quality"}),new xp.Label({text:"but the processing takes longer"})]),new xp.VBox({maxHeight:"12em",itemsAlign:"left",contentAlign:"top",init:function(e){var t=document.createElement("div");e.domElement.appendChild(t),t.appendChild(r)}})]),new xp.Placeholder({height:"3em",flex:"shrink"}),new xp.HBox({contentAlign:"right"},[new xp.Label({init:function(e){return i.progressLabel=e}}),new xp.Button({text:"Start",style:"largeButton",onClick:function(e){e.element.visible=!1,i.state.inProgress=!0,t({maxColors:i.state.maxColors,inputSize:i.state.inputSize})}}),new xp.Button({text:"Cancel",style:"largeButton",onClick:function(e){i.close(),o()}})])]),this.state=xp.observable({maxColors:3,inputSize:Math.max(r.width,r.height),inProgress:!1,progress:0}),this.onRendered.addHandler(function(){i.scope=i.state},this)}t=e.UI||(e.UI={}),s=xp.Modal,__extends(n,s),n.prototype.getTemplate=function(){return xp.Dom.create('<div class="NewDocModal Modal VBox"></div>')},n.prototype.setProgress=function(e){this.progressLabel.text=Math.round(100*e)+"%"},e=n,t.TraceModal=e}(Inker=Inker||{}),function(d){var i,e=(i=xp.Window,__extends(t,i),t.prototype.getTemplate=function(){var e=document.body;return[].slice.call(e.children).forEach(function(e){"script"!==e.tagName.toLowerCase()&&e.parentElement.removeChild(e)}),i.prototype.getTemplate.call(this)},t.prototype.onAddLayer=function(){var e=this;if(this.app.document){for(var t=1,n="",o=this.app.document.layers.map(function(e){return e.name});n="Layer "+t,t++,0<=o.indexOf(n););this.app.memento.isLocked||this.app.memento.perform({action:function(){return{created:[e.app.document.actions.layer.add(n)]}}})}},t.prototype.initExtraButton=function(){var n=this;this.extraButton.domElement.addEventListener("touchstart",function(e){e.stopPropagation()}),this.extraButton.domElement.addEventListener("mousedown",function(e){e.stopPropagation()}),this.extraButton.domElement.addEventListener("click",function(e){e.stopPropagation(),function(e){e.stopPropagation(),e.preventDefault();n.extraButton.domElement.getBoundingClientRect();var t,e=!n.app.document;n.extraMenu?n.extraMenu.close():(n.app.feature.canUseAdvanced||(t=function(){n.app.feature.redirect()}),n.extraMenu=new xp.ContextMenu([{text:"Export PNG",icon:d.UI.Icons.save,action:function(){return n.app.file.exportPng()},disabled:e},{text:"Export SVG",icon:d.UI.Icons.save,action:t||function(){return n.app.file.exportSvg()},disabled:e},{text:"Export EPS",icon:d.UI.Icons.save,action:t||function(){return n.app.file.exportEps()},disabled:e},{text:"Import image",icon:d.UI.Icons.open,action:function(){return n.app.file.importImage()},disabled:e},{text:"Import SVG (shapes)",icon:d.UI.Icons.open,action:function(){return n.app.file.importSvg()},disabled:e},{text:"Auto-trace image",icon:d.UI.Icons.pathTool.strokeToPath,action:function(){return n.app.file.traceBitmap()},disabled:e},{text:"Help",icon:d.UI.Icons.help,action:function(){return(new d.UI.HelpModal).show()},disabled:e}]),n.app.feature.canUseAdvanced||n.extraMenu.children.forEach(function(e,t){1!==t&&2!==t||e.domElement.classList.add("pay")}),n.extraMenu.show(n.extraButton.domElement,"vertical"),n.extraMenu.onClosed.addHandler(function(){return n.extraMenu=null}))}(e)})},t.prototype.focusInput=function(o,e){var t,n,r,i,s,a,l,c,p,h=this;e?(o.classList.add("inputTouchEdit"),t=xp.Dom.create('<div class="inputTouchEditFade"></div>'),document.body.appendChild(t),e=function(e){e.preventDefault(),e.stopPropagation()},t.addEventListener("touchstart",e),t.addEventListener("mousedown",e),t.addEventListener("click",e),n=o.parentElement,r=o.nextElementSibling,o.previousElementSibling&&o.previousElementSibling.classList.contains("Label")&&((i=o.previousElementSibling).classList.add("inputTouchEditLabel"),"number"===o.type&&i.classList.add("numberTouchEditLabel"),document.body.appendChild(i)),document.body.appendChild(o),this.showingTouchInput=!0,"number"!==o.type&&o.focus(),"number"===o.type&&(a=[(e=function(n){return new xp.Button({style:"numberTouchEditButton "+(n?"up":"down"),icon:n?d.UI.Icons.up:d.UI.Icons.down,onClick:function(){var e=parseFloat(o.value)||0,t=parseFloat(o.step)||1;n?e+=t:e-=t,.1===t&&(e=+e.toFixed(1)),s(e)},init:function(e){return e.domElement.addEventListener("touchstart",function(e){return e.stopPropagation()})}})})(!(s=function(e){e>parseFloat(o.max)&&(e=parseFloat(o.max)),e<parseFloat(o.min)&&(e=parseFloat(o.min)),o.value=e.toString(),o.dispatchEvent(new Event("change"))})),e(!0)],this.append(a[0]),this.append(a[1])),l=function(){t.removeEventListener("touchstart",c),o.removeEventListener("keydown",p),o.classList.remove("inputTouchEdit"),document.body.removeChild(t),a&&(a[0].remove(),a[1].remove(),s(+o.value)),h.showingTouchInput=!1,i&&(i.classList.remove("inputTouchEditLabel"),i.classList.remove("nemberTouchEditLabel"),n.insertBefore(i,r)),n.insertBefore(o,r)},c=function(){l()},p=function(e){13===e.keyCode&&(e.preventDefault(),e.stopPropagation(),l())},t.addEventListener("touchstart",c),o.addEventListener("keydown",p)):o.focus()},t.prototype.fixChromeFlexboxScroll=function(){var e=document.getElementById("chromeFlexboxFixStyle");e||((e=document.createElement("style")).id="chromeFlexboxFixStyle",e.textContent=".HBox, .VBox { overflow: hidden !important; }"),setTimeout(function(){e.parentElement!==document.head&&document.head.appendChild(e),setTimeout(function(){e.parentElement===document.head&&document.head.removeChild(e)},10)},10)},t);function t(n){var e,o=this;i.call(this,{title:'({document.name} || "Inker")',itemsAlign:"stretch",minWidth:"auto",minHeight:"auto",height:"100%",scrollBar:"none"},[new d.UI.Header(n,{name:"header"}),new xp.HBox({style:"toolPanelPre"},[new xp.Button({name:"extraButton",icon:d.UI.Icons.menu,width:"3em",minHeight:"3em"}),new xp.HBox({name:"toolPanelContainer",flex:"stretch",scrollBar:"none",minHeight:"3em"}),new xp.Button({text:"Help",onClick:function(){return(new d.UI.HelpModal).show()},icon:d.UI.Icons.help,style:"helpButton largeButton"})]),new xp.HBox({flex:"stretch",itemsAlign:"stretch",scrollBar:"none"},[new d.UI.ToolSelector(n,{name:"toolSelector",minWidth:"3em",scrollBar:"none"}),new d.UI.Canvas(n,{flex:"stretch",name:"canvas"}),new d.UI.ObjectBrowser({width:"16em",flex:"none",collapsed:"{settings.panels.objectBrowserCollapsed}",onAddLayer:function(){return o.onAddLayer()}})]),new d.UI.StylePanel(n,{height:"2.5em",flex:"none",name:"stylePanel"})]),this.app=n,this.scope=n,setTimeout(function(){return o.style="loaded"}),this.initExtraButton(),this.onKeyDown.addHandler(function(e){return o.app.key.handleKeyEvent(e.domEvent)},this),n.platform.isChromeApp&&(e=chrome.app.window.current(),xp.Model.property(this,"isMaximized",!0),e.onMaximized.addListener(function(){o.isMaximized=!0}),e.onMinimized.addListener(function(){o.isMaximized=!1}),e.onRestored.addListener(function(){o.isMaximized=e.isMaximized()}),e.onBoundsChanged.addListener(function(){o.isMaximized=e.isMaximized()})),this.onPropertyChanged.addHandler(function(e){"isMaximized"===e&&(o.domElement.style.border=o.isMaximized?"":"1px solid "+d.Tools.Markers.MarkerStyle.color2)});var t=!1;new xp.BindingCallManager(n,"document",function(e){n.document?t&&(t=!1,o.toolSelector.enabled=!0,o.toolPanelContainer.enabled=!0,o.stylePanel.enabled=!0):(t=!0,o.toolSelector.enabled=!1,o.toolPanelContainer.enabled=!1,o.stylePanel.enabled=!1)}),!window.DEBUG&&n.platform.isWeb&&window.addEventListener("beforeunload",function(e){var t=n.documents.filter(function(e){return!e.isSaved});if(0<t.length){t="Some documents are not saved:\n"+t.map(function(e){return e.name}).join("\n");return(e||window.event).returnValue=t}});var r=this.domElement.querySelector("#messageListTarget");n.message.messageListElement.renderTo(r),window.addEventListener("error",function(e){e=e&&e.error&&e.error.message?e.error.message:"Unknown error";n.message.error(e)}),window.addEventListener("touchstart",function(e){var t;o.showingTouchInput||(t=e.srcElement)instanceof HTMLInputElement&&(e.stopPropagation(),e.preventDefault(),o.focusInput(t,!0))})}d.Window=e}(Inker=Inker||{}),function(b){var e;(function(h){h.MarkerStyle={color1:"#222",color1a:"#a31",color2:"#d42",color2a:"#d42",fillColor:"#222",activeColor:"#d42",strokeColor:"#d42",activeStrokeColor:"#e92",strokeWidth:2,size:11.5*window.devicePixelRatio};var r=(Object.defineProperty(e.prototype,"cx",{get:function(){return b.Svg.getNumber(this.rect1,"x")+h.MarkerStyle.size/2},set:function(e){b.Svg.setAttribute(this.rect1,"x",Math.round(e)-h.MarkerStyle.size/2),b.Svg.setAttribute(this.rect2,"x",Math.round(e)-h.MarkerStyle.size/2-1)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cy",{get:function(){return b.Svg.getNumber(this.rect2,"y")+h.MarkerStyle.size/2},set:function(e){b.Svg.setAttribute(this.rect1,"y",Math.round(e)-h.MarkerStyle.size/2),b.Svg.setAttribute(this.rect2,"y",Math.round(e)-h.MarkerStyle.size/2-1)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"selected",{get:function(){return this._selected},set:function(e){this._selected=e,b.Svg.setAttribute(this.rect1,"stroke",e?h.MarkerStyle.color2:h.MarkerStyle.color1a),b.Svg.setAttribute(this.rect2,"stroke",e?h.MarkerStyle.color1a:h.MarkerStyle.color1)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){return this.rect1.getAttribute("fill")},set:function(e){this.rect1.setAttribute("fill",e)},enumerable:!0,configurable:!0}),e.prototype.remove=function(){b.Svg.remove(this.element)},e);function e(e,t,n){var o=this;this.element=b.Svg.create("g",{"data-type":"SquareMarker"}),this.rect1=b.Svg.create("rect",{width:h.MarkerStyle.size,height:h.MarkerStyle.size,x:t-h.MarkerStyle.size/2,y:n-h.MarkerStyle.size/2,fill:"transparent",stroke:h.MarkerStyle.color1a,"stroke-width":1}),this.rect2=b.Svg.create("rect",{width:h.MarkerStyle.size+2,height:h.MarkerStyle.size+2,x:t-h.MarkerStyle.size/2-1,y:n-h.MarkerStyle.size/2-1,fill:"transparent",stroke:h.MarkerStyle.color1,"stroke-width":1}),this.element.appendChild(this.rect1),this.element.appendChild(this.rect2),e.appendChild(this.element),this.element.addEventListener("touchstart",function(e){o.rect1.setAttribute("stroke-width","2"),o.rect2.setAttribute("stroke-width","2");var t=function(){o.element.removeEventListener("touchend",t),o.rect1.setAttribute("stroke-width","1"),o.rect2.setAttribute("stroke-width","1")};o.element.addEventListener("touchend",t)})}h.SquareMarker=r;var d=(Object.defineProperty(t.prototype,"cx",{get:function(){return b.Svg.getNumber(this.circle1,"cx")},set:function(e){b.Svg.setAttribute(this.circle1,"cx",Math.round(e)),b.Svg.setAttribute(this.circle2,"cx",Math.round(e))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cy",{get:function(){return b.Svg.getNumber(this.circle1,"cy")},set:function(e){b.Svg.setAttribute(this.circle1,"cy",Math.round(e)),b.Svg.setAttribute(this.circle2,"cy",Math.round(e))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selected",{get:function(){return this._selected},set:function(e){this._selected=e,b.Svg.setAttribute(this.circle1,"stroke",e?h.MarkerStyle.color2:h.MarkerStyle.color1a),b.Svg.setAttribute(this.circle2,"stroke",e?h.MarkerStyle.color1a:h.MarkerStyle.color1)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this.circle1.getAttribute("fill")},set:function(e){this.circle1.setAttribute("fill",e)},enumerable:!0,configurable:!0}),t.prototype.remove=function(){b.Svg.remove(this.element)},t);function t(e,t,n){var o=this;this.element=b.Svg.create("g",{"data-type":"RoundMarker"}),this.circle1=b.Svg.create("circle",{r:h.MarkerStyle.size/2,cx:t,cy:n,fill:"transparent",stroke:h.MarkerStyle.strokeColor,"stroke-width":1}),this.circle2=b.Svg.create("circle",{r:h.MarkerStyle.size/2+1,cx:t,cy:n,fill:"transparent",stroke:h.MarkerStyle.fillColor,"stroke-width":1}),this.element.appendChild(this.circle1),this.element.appendChild(this.circle2),e.appendChild(this.element),this.element.addEventListener("touchstart",function(e){o.circle1.setAttribute("stroke-width","2"),o.circle2.setAttribute("stroke-width","2");var t=function(){o.element.addEventListener("touchend",t),o.circle1.setAttribute("stroke-width","1"),o.circle2.setAttribute("stroke-width","1")};o.element.addEventListener("touchend",t)})}h.RoundMarker=d;var n=(Object.defineProperty(o.prototype,"end",{get:function(){return this._end},set:function(e){this._end=e,b.Svg.setAttributes(this.element,{x:Math.min(this.start.x,this.end.x),y:Math.min(this.start.y,this.end.y),width:Math.abs(this.end.x-this.start.x),height:Math.abs(this.end.y-this.start.y)})},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"bBox",{get:function(){return{left:Math.min(this.start.x,this.end.x),top:Math.min(this.start.y,this.end.y),width:Math.abs(this.end.x-this.start.x),height:Math.abs(this.end.y-this.start.y)}},enumerable:!0,configurable:!0}),o.prototype.remove=function(){b.Svg.remove(this.element)},o);function o(e,t,n){this.element=b.Svg.create("rect",{fill:"transparent",stroke:h.MarkerStyle.strokeColor,"stroke-width":h.MarkerStyle.strokeWidth,"pointer-events":"none"}),e.appendChild(this.element),this.start=t,this.end=n}h.SelectBox=n;Object.defineProperty(s.prototype,"bBox",{get:function(){return this._bBox},set:function(e){for(var t in this._bBox=e,this.markers){var n=this.markers[t];n instanceof a&&(n.cx=e.left+(n.scaleVector.x+1)/2*e.width,n.cy=e.top+(n.scaleVector.y+1)/2*e.height),n instanceof p&&(n.cx=e.left+(n.scaleVector.x+1)/2*e.width+n.scaleVector.x*s.rotateIndent,n.cy=e.top+(n.scaleVector.y+1)/2*e.height+n.scaleVector.x*s.rotateIndent)}this.markers.rotate.cx=e.left+e.width/2,this.markers.rotate.cy=e.top-s.rotateIndent,this.lockAxisEditOnZeroSize(e)},enumerable:!0,configurable:!0}),s.prototype.lockAxisEditOnZeroSize=function(e){this.markers.left.setVisibility(0!==e.width),this.markers.right.setVisibility(0!==e.width),this.markers.top.setVisibility(0!==e.height),this.markers.bottom.setVisibility(0!==e.height),this.markers.topLeft.setVisibility(0!==e.width&&0!==e.height),this.markers.topRight.setVisibility(0!==e.width&&0!==e.height),this.markers.bottomLeft.setVisibility(0!==e.width&&0!==e.height),this.markers.bottomRight.setVisibility(0!==e.width&&0!==e.height),this.markers.rotateTopLeft.setVisibility(0!==e.width&&0!==e.height),this.markers.rotateTopRight.setVisibility(0!==e.width&&0!==e.height),this.markers.rotateBottomLeft.setVisibility(0!==e.width&&0!==e.height),this.markers.rotateBottomRight.setVisibility(0!==e.width&&0!==e.height),0===e.width&&0===e.height?this.markers.rotate.element.setAttribute("visibility","hidden"):this.markers.rotate.element.removeAttribute("visibility")},s.prototype.remove=function(){for(var e in this.markers)this.markers[e].remove();this.onScaleMarkerMDown.removeAllHandlers()},s.indent=h.MarkerStyle.size/2,s.rotateIndent=2*h.MarkerStyle.size,n=s;function s(e,t){var o,r=this,n=s.indent,i=s.rotateIndent;for(o in this.markers={topRight:new a(e,t.left+t.width+n,t.top-n,{x:1,y:-1}),bottomRight:new a(e,t.left+t.width+n,t.top+t.height+n,{x:1,y:1}),bottomLeft:new a(e,t.left-n,t.top+t.height+n,{x:-1,y:1}),topLeft:new a(e,t.left-n,t.top-n,{x:-1,y:-1}),top:new a(e,t.left+t.width/2,t.top-n,{x:0,y:-1}),right:new a(e,t.left+t.width+n,t.top+t.height/2,{x:1,y:0}),left:new a(e,t.left-n,t.top+t.height/2,{x:-1,y:0}),bottom:new a(e,t.left+t.width/2,t.top+t.height+n,{x:0,y:1}),rotate:new d(e,t.left+t.width/2,t.top-s.rotateIndent),rotateTopRight:new p(e,t.left+t.width+i,t.top-i,{x:1,y:-1}),rotateBottomRight:new p(e,t.left+t.width+i,t.top+t.height+i,{x:1,y:1}),rotateBottomLeft:new p(e,t.left-i,t.top+t.height+i,{x:-1,y:1}),rotateTopLeft:new p(e,t.left-i,t.top-i,{x:-1,y:-1})},this.markers.rotateTopLeft.element.style.display="none",this.markers.rotateBottomRight.element.style.display="none",this.markers.rotateBottomLeft.element.style.display="none",this.markers.rotateTopRight.element.style.display="none",this.markers.rotate.element.style.cursor="move",this._bBox=t,this.lockAxisEditOnZeroSize(t),this.onScaleMarkerMDown=new xp.Event,this.onRotateMarkerMDown=new xp.Event,this.markers)this.markers[o]instanceof a&&function(){var n=r.markers[o];n.element.addEventListener("mousedown",function(e){console.log("selectbox: mousedown");var t={};t.targetMarker=n,t.domEvent=e,r.onScaleMarkerMDown.invoke(t),e.stopPropagation()}),n.element.addEventListener("touchstart",function(e){console.log("selectbox: touchstart"),e.preventDefault();var t={};t.targetMarker=n,t.domEvent=e,r.onScaleMarkerMDown.invoke(t),e.stopPropagation()})}(),this.markers[o]instanceof p&&function(){var n=r.markers[o];n.element.addEventListener("mousedown",function(e){var t={};t.targetMarker=n,t.domEvent=e,r.onRotateMarkerMDown.invoke(t),e.stopPropagation()}),n.element.addEventListener("touchstart",function(e){var t={};t.targetMarker=n,t.domEvent=e,r.onRotateMarkerMDown.invoke(t),e.stopPropagation()})}();this.markers.rotate.element.addEventListener("mousedown",function(e){var t={};t.targetMarker=r.markers.rotate,t.domEvent=e,r.onRotateMarkerMDown.invoke(t),e.stopPropagation()}),this.markers.rotate.element.addEventListener("touchstart",function(e){var t={};t.targetMarker=r.markers.rotate,t.domEvent=e,r.onRotateMarkerMDown.invoke(t),e.stopPropagation()})}h.ScaleBox=n;var i,a=(__extends(l,i=r),l.prototype.setVisibility=function(e){e?this.element.removeAttribute("visibility"):this.element.setAttribute("visibility","hidden")},l);function l(e,t,n,o){i.call(this,e,t,n),0!==(this.scaleVector=o).x&&o.x===o.y?this.element.style.cursor="nwse-resize":0===o.x?this.element.style.cursor="ns-resize":0===o.y?this.element.style.cursor="ew-resize":this.element.style.cursor="nesw-resize"}h.ScaleMarker=a;var c,p=(__extends(u,c=d),u.prototype.setVisibility=function(e){e?this.element.removeAttribute("visibility"):this.element.setAttribute("visibility","hidden")},u);function u(e,t,n,o){c.call(this,e,t,n),this.scaleVector=o,this.element.style.cursor="move"}h.RotateMarker=p;Object.defineProperty(f.prototype,"points",{get:function(){return this._points},set:function(e){var n=this;(this._points=e).forEach(function(e,t){n.markers[t].cx=e.x,n.markers[t].cy=e.y});for(var t=xp.formatString("M{0},{1} ",e[0].x,e[0].y),o=1;o<e.length;o++)t+=xp.formatString("L{0},{1} ",e[o].x,e[o].y);t+="z",this.borderElement.setAttribute("d",t)},enumerable:!0,configurable:!0}),f.prototype.remove=function(){this.markers.forEach(function(e){return e.remove()}),b.Svg.remove(this.borderElement),this.onDistortMarkerMDown.removeAllHandlers()},n=f;function f(t,e){var o=this;this.borderElement=b.Svg.create("path",{fill:"none","pointer-events":"none",stroke:h.MarkerStyle.strokeColor,"stroke-width":h.MarkerStyle.strokeWidth,"stroke-dasharray":"8, 16"}),t.appendChild(this.borderElement),this.markers=[],this.onDistortMarkerMDown=new xp.Event,e.forEach(function(e){var n=new r(t,0,0);n.element.setAttribute("cursor","move"),t.appendChild(n.element),n.element.addEventListener("mousedown",function(e){var t={};t.targetMarker=n,t.domEvent=e,o.onDistortMarkerMDown.invoke(t),e.stopPropagation()}),n.element.addEventListener("touchstart",function(e){var t={};t.targetMarker=n,(t.domEvent=e).preventDefault(),o.onDistortMarkerMDown.invoke(t),e.stopPropagation()}),o.markers.push(n)}),this.points=e}h.DistortBox=n,h.createHighlight=function(e,t,n){if(t instanceof b.Doc.Curve)r=b.Svg.create("path",{d:t.svgPath});else if(t instanceof b.Doc.Image)r=b.Svg.create("rect",{x:t.left,y:t.top,width:t.width,height:t.height});else{if(!(t instanceof b.Doc.Text))throw new Error("Not implemented.");var o=t.getBBox(),t=32<t.font.weight*n.viewport.zoom?16:t.font.weight*n.viewport.zoom/2,r=b.Svg.create("path",{d:"M"+o.left+","+(o.top+t)+" v"+-t+" h"+t+" M"+(o.left+o.width-t)+","+o.top+" h"+t+" v"+t+" M"+(o.left+o.width)+","+(o.top+o.height-t)+" v"+t+" h"+-t+" M"+(o.left+t)+","+(o.top+o.height)+" h"+-t+" v"+-t})}return b.Svg.setAttributes(r,{fill:"none",stroke:h.MarkerStyle.strokeColor,"stroke-width":h.MarkerStyle.strokeWidth/n.viewport.zoom,"stroke-opacity":.5,"pointer-events":"none",transform:xp.formatString("translate({0} {1}) scale({2})",n.viewport.x,n.viewport.y,n.viewport.zoom)}),e.appendChild(r),r};Object.defineProperty(m.prototype,"points",{set:function(e){var t,n=this;2===(e=(this._points=e).map(function(e){return{x:n.canvas.translateXOut(e.x),y:n.canvas.translateYOut(e.y)}})).length&&(t=Geo.getLength(e[0],e[1])<24?xp.formatString("M{0},{1} {2},{3}",e[0].x,e[0].y,e[1].x,e[1].y):(t=Geo.getMidPoint(e[0],e[1]),xp.formatString("M{0},{1} {2},{3} {4},{5}",e[0].x,e[0].y,t.x,t.y,e[1].x,e[1].y))),4===e.length&&(t=xp.formatString("M{0},{1} C{2},{3} {4},{5} {6},{7}",e[0].x,e[0].y,e[1].x,e[1].y,e[2].x,e[2].y,e[3].x,e[3].y),m.displayCubicPoints&&(b.Svg.setAttribute(this.a1,"cx",e[1].x),b.Svg.setAttribute(this.a1,"cy",e[1].y),b.Svg.setAttribute(this.a2,"cx",e[2].x),b.Svg.setAttribute(this.a2,"cy",e[2].y))),b.Svg.setAttribute(this.pathElement,"d",t),b.Svg.setAttribute(this.sensElement,"d",t),this._isStartSegment&&24<=Geo.getLength(e[0],e[e.length-1])?b.Svg.setAttribute(this.pathElement,"marker-start","url(#midSegmentMarker)"):this.pathElement.removeAttribute("marker-start")},enumerable:!0,configurable:!0}),m.prototype.remove=function(){b.Svg.remove(this.element),m.displayCubicPoints&&(b.Svg.remove(this.a1),b.Svg.remove(this.a2)),this.onMouseDown.removeAllHandlers(),this.onMouseEnter.removeAllHandlers(),this.onMouseLeave.removeAllHandlers()},Object.defineProperty(m.prototype,"isStartSegment",{set:function(e){(this._isStartSegment=e)&&24<=Geo.getLength(this._points[0],this._points[this._points.length-1])?b.Svg.setAttribute(this.pathElement,"marker-start","url(#midSegmentMarker)"):this.pathElement.removeAttribute("marker-start")},enumerable:!0,configurable:!0}),Object.defineProperty(m.prototype,"isVisible",{set:function(e){},enumerable:!0,configurable:!0}),m.createMidMarker=function(){var e=b.Svg.create("marker",{id:"midSegmentMarker",orient:"auto",markerWidth:"8",markerHeight:"6",refX:"0",refY:"3"}),t=b.Svg.create("path",{d:"M0,0 8,3 0,6 Z",fill:h.MarkerStyle.strokeColor,opacity:.5});return e.appendChild(t),e},m.displayCubicPoints=!1,m.sensWidth=h.MarkerStyle.size,n=m;function m(e,t,n){var o=this;this.canvas=n,this.element=b.Svg.create("g"),this.pathElement=b.Svg.create("path",{fill:"transparent",stroke:h.MarkerStyle.strokeColor,"stroke-width":h.MarkerStyle.strokeWidth,"vector-effect":"non-scaling-stroke","pointer-events":"none","marker-mid":"url(#midSegmentMarker)","stroke-opacity":.5}),this.sensElement=b.Svg.create("path",{fill:"none",stroke:"transparent","stroke-width":m.sensWidth,"vector-effect":"non-scaling-stroke","pointer-events":"stroke"}),this.addPointElement=b.Svg.create("circle",{r:h.MarkerStyle.size/2,fill:h.MarkerStyle.activeColor,opacity:0,"pointer-events":"none"}),this.element.appendChild(this.pathElement),this.element.appendChild(this.sensElement),this.element.appendChild(this.addPointElement),this.sensElement.addEventListener("mouseenter",function(e){b.Svg.setAttribute(o.addPointElement,"opacity",1)}),this.sensElement.addEventListener("mousemove",function(e){e=xp.createEventArgs(o.canvas,e),e=b.Svg.getClosestPointOnSvgPath(o.sensElement,{x:e.elementX,y:e.elementY});b.Svg.setAttributes(o.addPointElement,{cx:e.x,cy:e.y})}),this.sensElement.addEventListener("mouseleave",function(e){b.Svg.setAttribute(o.addPointElement,"opacity",0)}),this.onMouseDown=new xp.Event;function r(e){console.log("Sensitive segment down.");var t=xp.createEventArgs(o.canvas,e),e=b.Svg.getClosestPointOnSvgPath(o.sensElement,{x:t.elementX,y:t.elementY});t.elementX=e.x,t.elementY=e.y,o.onMouseDown.invoke(t)}this.sensElement.addEventListener("mousedown",r),this.sensElement.addEventListener("touchstart",function(e){var t=b.Svg.create("path",{d:o.pathElement.getAttribute("d"),fill:"transparent",stroke:h.MarkerStyle.strokeColor,"stroke-width":2*h.MarkerStyle.strokeWidth,"vector-effect":"non-scaling-stroke","pointer-events":"none","stroke-opacity":.5});o.pathElement.parentElement.insertBefore(t,o.pathElement.nextElementSibling),setTimeout(function(){t.parentElement.removeChild(t)},750),r(e)}),this.onMouseEnter=new xp.Event,this.sensElement.addEventListener("mouseenter",function(e){var t=xp.createEventArgs(o.canvas,e),e=b.Svg.getClosestPointOnSvgPath(o.sensElement,{x:t.elementX,y:t.elementY});t.elementX=e.x,t.elementY=e.y,o.onMouseEnter.invoke(t)}),this.onMouseLeave=new xp.Event,this.sensElement.addEventListener("mouseleave",function(e){var t=xp.createEventArgs(o.canvas,e),e=b.Svg.getClosestPointOnSvgPath(o.sensElement,{x:t.elementX,y:t.elementY});t.elementX=e.x,t.elementY=e.y,o.onMouseLeave.invoke(t)}),m.displayCubicPoints&&(this.a1=b.Svg.create("circle",{r:2,fill:"red"}),this.a2=b.Svg.create("circle",{r:2,fill:"blue"}),e.appendChild(this.a1),e.appendChild(this.a2)),this.points=t,e.appendChild(this.element)}h.SegmentMarker=n;g.prototype.update=function(){var e,t,n;n=void 0===this.startA?xp.formatString("M{0},{1} L{2},{3}",this.startPt.x,this.startPt.y,this.endPt.x,this.endPt.y):(e=Geo.getLength(this.startPt,this.endPt),t=Geo.placePoint(this.startPt,e/3,Geo.getMidAngle(this.startA,Geo.getAngle(this.startPt,this.endPt))),n=Geo.getMidPoint(this.startPt,t,1.5),n=Geo.placePoint(this.endPt,e/3,Geo.getAngle(this.endPt,n)),xp.formatString("M{0},{1} C{2},{3} {4},{5} {6},{7}",this.startPt.x,this.startPt.y,t.x,t.y,n.x,n.y,this.endPt.x,this.endPt.y)),this.element.setAttribute("d",n)},g.prototype.remove=function(){b.Svg.remove(this.element)},n=g;function g(e,t,n,o){this.element=b.Svg.create("path",{stroke:h.MarkerStyle.strokeColor,"stroke-width":h.MarkerStyle.strokeWidth,"stroke-dasharray":"5, 5","pointer-events":"none","stroke-opacity":"0.25",fill:"none"}),this.startPt=t,this.endPt=n,this.startA=o,this.update(),e.appendChild(this.element)}h.TempLineMarker=n;Object.defineProperty(v.prototype,"coord",{set:function(e){this.point.cx=e.x,this.point.cy=e.y,b.Svg.setAttributes(this.line1,{x1:e.x-2*h.MarkerStyle.size,y1:e.y,x2:e.x+2*h.MarkerStyle.size,y2:e.y}),b.Svg.setAttributes(this.line2,{x1:e.x,y1:e.y,x2:e.x,y2:e.y-2*h.MarkerStyle.size})},enumerable:!0,configurable:!0}),v.prototype.remove=function(){b.Svg.remove(this.element),this.onMarkerMouseDown.removeAllHandlers(),this.onTextInput.removeAllHandlers(),this.binding.unbind(),this.registrar.unsubscribeAll(),this.textShape&&this.textShape.element.removeAttribute("visibility")},n=v;function v(e,t,n,o,r){var i=this;this.text=r,this.element=b.Svg.create("g"),this.line1=b.Svg.create("line",{stroke:h.MarkerStyle.strokeColor,width:2,"pointer-events":"none"}),this.line2=b.Svg.create("line",{stroke:h.MarkerStyle.strokeColor,width:2,"pointer-events":"none"}),this.element.appendChild(this.line1),this.element.appendChild(this.line2),this.point=new d(this.element,t,n),b.Svg.setAttributes(this.point.element,{cursor:"move"}),this.coord={x:t,y:n},e.appendChild(this.element),this.onMarkerMouseDown=new xp.Event;n=function(e){e=xp.createEventArgs(o,e);e.elementX=i.point.cx,e.elementY=i.point.cy,(e.targetMarker=i).onMarkerMouseDown.invoke(e)};this.point.element.addEventListener("mousedown",n),this.point.element.addEventListener("touchstart",n),this.fo=document.createElementNS(b.Svg.SvgNS,"foreignObject");e="http://www.w3.org/1999/xhtml",n=document.createElementNS(e,"body");n.setAttribute("style","width:100%; height:100%; padding:0; margin:0; overflow:hidden;"),this.textArea=document.createElementNS(e,"textarea"),this.textArea.setAttribute("style","width:100%; height:100%; padding:0; margin:0; background-color:transparent; overflow:hidden; resize:none; outline:none; white-space:nowrap; border:none;"),this.textArea.addEventListener("mousedown",function(e){return e.stopPropagation()}),this.textArea.addEventListener("touchstart",function(e){return e.stopPropagation()}),this.textArea.addEventListener("mousewheel",function(e){return e.preventDefault()}),this.element.insertBefore(this.fo,this.element.firstElementChild),this.fo.appendChild(n),n.appendChild(this.textArea);var s=!1;this.text.content;this.onTextInput=new xp.Event,this.textArea.addEventListener("input",function(e){s=!0,r.content=i.textArea.value,i.onTextInput.invoke(i.textArea.value),s=!1}),this.textArea.style.width="100%",this.textArea.style.height="100%";function a(){i.textArea.style.fontFamily=r.font.family,i.textArea.style.fontSize=r.font.size*o.viewport.zoom+"px",i.textArea.style.fontWeight=r.font.weight.toString(),r.font.isItalic?i.textArea.style.fontStyle="italic":i.textArea.style.fontStyle="",i.textArea.style.textAlign=r.font.anchor===b.Doc.TextAnchor.Left?"right":r.font.anchor===b.Doc.TextAnchor.Right?"left":"center"}function l(){i.textArea.style.color=r.fill.color}function c(){r.hasStroke&&("webkitTextStroke"in i.textArea.style?(i.textArea.style.webkitTextStrokeColor=r.stroke.color,i.textArea.style.webkitTextStrokeWidth=r.stroke.width*o.viewport.zoom+"px"):i.textArea.style.textShadow=xp.formatString("-{0}px -{0}px 0 {1}, {0}px -{0}px 0 {1}, -{0}px {0}px 0 {1}, {0}px {0}px 0 {1}",r.stroke.width,r.stroke.color))}function p(){var e=r.getBBox(),t=r.font.size*o.viewport.zoom;i.fo.setAttribute("x",o.translateXOut(e.left).toString()),i.fo.setAttribute("y",o.translateYOut(e.top).toString()),i.fo.setAttribute("width",o.translateSizeOut(e.width).toString()),i.fo.setAttribute("height",(o.translateSizeOut(e.height)+t/3).toString()),s||(i.textArea.value=r.content)}this.binding=new xp.BindingCallManager(r,"content",function(e){p()}),this.registrar=new xp.EventRegistrar,this.registrar.subscribe(r.font.onPropertyChanged,function(){setTimeout(a),setTimeout(p)},this),this.registrar.subscribe(o.onViewportChanged,function(){a(),c(),p()},this),this.registrar.subscribe(r.fill.onPropertyChanged,function(e){"color"===e&&l()},this),this.registrar.subscribe(r.stroke.onPropertyChanged,function(e){"color"!==e&&"width"!==e||c()},this),this.registrar.subscribe(r.onPropertyChanged,function(e){"x"!==e&&"y"!==e||p()},this),a(),l(),c(),p();n=o.docShape.getSelectedShapes().filter(function(e){return e.model===r})[0];n&&(n.element.setAttribute("visibility","hidden"),this.textShape=n),setTimeout(function(){i.textArea.focus(),i.textArea.selectionStart=i.textArea.selectionEnd=i.textArea.value.length})}h.TextMarker=n;y.prototype.setPoints=function(e){if(e.length<2)this.element.setAttribute("d","");else{for(var t,n,o=[],r=[],i=0;i<e.length-1;i++)t=this.brushSize*e[i].force,n=Geo.getAngle(e[i],e[i+1]),o.push(Geo.placePoint(e[i],t/2,n-Math.PI/2)),r.push(Geo.placePoint(e[i],t/2,n+Math.PI/2)),i===e.length-2&&(o.push(Geo.placePoint(e[i+1],t/2,n-Math.PI/2)),r.push(Geo.placePoint(e[i+1],t/2,n+Math.PI/2)));for(var s="M"+o[0].x+","+o[0].y,i=1;i<o.length;i++)s+=" "+o[i].x+","+o[i].y;for(i=r.length-1;0<=i;i--)s+=" "+r[i].x+","+r[i].y;s+=" z",this.element.setAttribute("d",s)}},y.prototype.remove=function(){b.Svg.remove(this.element)},n=y;function y(e,t,n){this.brushSize=n||h.MarkerStyle.strokeWidth,this.element=b.Svg.create("path",{"pointer-events":"none",fill:h.MarkerStyle.strokeColor}),this.setPoints(t),e.appendChild(this.element)}h.PencilMarker=n;x.prototype.selectGStop=function(e){this.stops[e].selected=!0},x.prototype.deselectStops=function(){this.stops.forEach(function(e){return e.selected=!1})},x.prototype.update=function(e){var r=this;this.gradient=e,this.stops.forEach(function(e){return e.remove()}),this.stops=[];var i=this.canvas.translatePtOut(e.start),s=this.canvas.translatePtOut(e.end);e.stops.forEach(function(e,t){var n=Geo.getMidPoint(i,s,e.offset),o=new d(r.element,n.x,n.y);o.color=e.color,o.element.setAttribute("cursor","move");e=function(e){e.preventDefault();var t=xp.createEventArgs(r.canvas,e);t.targetMarker=o,t.gradientMarker=r,t.gStopIndex=r.stops.indexOf(o),e.stopPropagation(),r.onGStopMDown.invoke(t)};o.element.addEventListener("mousedown",e),o.element.addEventListener("touchstart",e),r.stops.push(o)}),b.Svg.setAttributes(this.line,{x1:i.x,y1:i.y,x2:s.x,y2:s.y}),b.Svg.setAttributes(this.sensLine,{x1:i.x,y1:i.y,x2:s.x,y2:s.y})},x.prototype.updateColors=function(e){var n=this;e.stops.forEach(function(e,t){n.stops[t].color=e.color})},x.prototype.updateLocation=function(n){var o=this.canvas.translatePtOut(n.start),r=this.canvas.translatePtOut(n.end);this.stops.forEach(function(e,t){t=Geo.getMidPoint(o,r,n.stops[t].offset);e.cx=t.x,e.cy=t.y}),b.Svg.setAttributes(this.line,{x1:o.x,y1:o.y,x2:r.x,y2:r.y}),b.Svg.setAttributes(this.sensLine,{x1:o.x,y1:o.y,x2:r.x,y2:r.y})},x.prototype.remove=function(){b.Svg.remove(this.element),this.onGStopMDown.removeAllHandlers(),this.onInsertGStopMDown.removeAllHandlers()},n=x;function x(e,t,n){this.canvas=n,this.gradient=t,this.element=b.Svg.create("g"),this.onGStopMDown=new xp.Event,this.onInsertGStopMDown=new xp.Event,this.line=b.Svg.create("line",{stroke:h.MarkerStyle.strokeColor,"stroke-width":h.MarkerStyle.strokeWidth,"stroke-dasharray":"5, 5",opacity:.5,"pointer-events":"none",fill:"none"}),this.element.appendChild(this.line),this.sensLine=b.Svg.create("line",{stroke:"transparent","stroke-width":h.MarkerStyle.size,fill:"none"}),this.element.appendChild(this.sensLine),this.insertGStopEl=b.Svg.create("circle",{fill:h.MarkerStyle.activeColor,visibility:"hidden",r:h.MarkerStyle.size/2,"pointer-events":"none"}),this.element.appendChild(this.insertGStopEl),this.stops=[],this.update(this.gradient),e.appendChild(this.element)}h.GradientMarker=n;w.prototype.remove=function(){b.Svg.remove(this.element)},n=w;function w(e,t,n){var o=this,r=h.MarkerStyle.size/2,i=h.MarkerStyle.size;this.element=b.Svg.create("circle",{r:r,opacity:.25,cx:t,cy:n,fill:h.MarkerStyle.activeColor,"pointer-events":"none"}),e.appendChild(this.element);var s,a=Date.now(),l=function(){requestAnimationFrame(function(e){e=Date.now(),500<=(s=e-a)?o.remove():(b.Svg.setAttributes(o.element,{r:r+(i-r)*s/500,opacity:.25+-.25*s/500}),l())})};l()}h.TouchMarker=n})((e=b.Tools||(b.Tools={})).Markers||(e.Markers={}))}(Inker=Inker||{}),function(e){var t,r;function n(e,t){var n,o=this;r.call(this),this.app=e,this.canvas=t,this.markersContainer=t.levels.markers,this.registrar=new xp.EventRegistrar,this.scope=e,new xp.BindingCallManager(this.scope,"document",function(e){o.doc=e,o.isEnabled&&o.onDocumentChanged()}),new xp.BindingCallManager(this.scope,"document.selectedElements",function(e){n&&n.event.hasHandler(n.handler)&&n.event.removeHandler(n.handler),o.doc&&(n=o.doc.selectedElements.onCollectionChanged.addHandler(function(){o.isEnabled&&o.onSelectionChanged()},o))}),xp.Model.property(this,"rulerModeEnabled",!1,{setterConvertor:function(e){return o.app.window.canvas.rulerModeButton.checked=e,o.onRulerModeChanged.invoke(e),e}}),this.onRulerModeChanged=new xp.Event,this.defineProperties(),this.createToolPanel()}t=e.Tools||(e.Tools={}),r=xp.Model,__extends(n,r),n.prototype.defineProperties=function(){},n.prototype.enable=function(){var n=this;this.isEnabled=!0,this.rulerModeEnabled=!1,this.onEnabled(),this.app.window.canvas.rulerModeButton.visible=this.supportsRulerMode(),this.rulerEventRegistrar=this.rulerEventRegistrar||new xp.EventRegistrar,this.supportsRulerMode()&&this.rulerEventRegistrar.subscribe(this.app.window.onKeyDown,function(e){var t;16===e.domEvent.keyCode&&(n.rulerModeEnabled=!0,t=n.rulerEventRegistrar.subscribe(n.app.window.onKeyUp,function(e){n.rulerModeEnabled=!1,n.rulerEventRegistrar.unsubscribe(function(e){return e===t})}))})},n.prototype.disable=function(){this.isEnabled=!1,this.onDisabled(),this.rulerEventRegistrar.unsubscribeAll()},n.prototype.onEnabled=function(){},n.prototype.onDisabled=function(){this.registrar.unsubscribeAll()},n.prototype.onDocumentChanged=function(){},n.prototype.onSelectionChanged=function(){},n.prototype.getHotkeys=function(){return[]},n.prototype.performDrag=function(n){var e,o,c,t,r,i,s,a,p=this;this.isDragging?console.log("Another drag is in process."):(e=function(e){e.preventDefault()},c=!(o=function(e){var t,n=p.canvas.domElement.getBoundingClientRect(),n=e instanceof TouchEvent?(t=e.changedTouches[0].pageX-n.left,e.changedTouches[0].pageY-n.top):(t=e.pageX-n.left,e.pageY-n.top);return{x:t,y:n}}),t=function(t){if(t instanceof TouchEvent&&1<t.touches.length){if(a(),t.preventDefault(),n.cursor&&p.canvas.removeLastCursor(),!n.cancel)throw new Error(p.getName()+" Tool doesn't implement action cancellation.");requestAnimationFrame(function(){n.cancel()}),r(t)}else p.isDragging=!0,t.preventDefault(),c||(requestAnimationFrame(function(){var e=o(t);n.move(e.x,e.y,t),c=!1}),c=!0)},r=function(e){p.isDragging=!0;function t(s){1<s.touches.length&&!c&&(requestAnimationFrame(function(){var e,t,n={x:s.touches[0].clientX,y:s.touches[0].clientY},o={x:s.touches[1].clientX,y:s.touches[1].clientY},r=Geo.getLength(n,o),i=Geo.getMidPoint(n,o);r<16||(t=(e=p.app.window.canvas).viewport,e.viewport={x:i.x+(t.x-l.x)*r/a,y:i.y+(t.y-l.y)*r/a,zoom:t.zoom*r/a},a=r,l=i,c=!1)}),c=!0)}var n={x:e.touches[0].clientX,y:e.touches[0].clientY},o={x:e.touches[1].clientX,y:e.touches[1].clientY},a=Geo.getLength(n,o),l=Geo.getMidPoint(n,o),r=function(e){0===e.touches.length&&(window.removeEventListener("touchmove",t),window.removeEventListener("touchend",r),p.isDragging=!1)};window.addEventListener("touchmove",t),window.addEventListener("touchend",r)},i=function(e){a(),p.isDragging=!1,e.preventDefault();var t=o(e);n.end&&requestAnimationFrame(function(){n.end(t.x,t.y,e)}),n.cursor&&p.canvas.removeLastCursor()},s=function(e){27===e.keyCode&&n.cancel&&(a(),p.isDragging=!1,e.preventDefault(),n.cursor&&p.canvas.removeLastCursor(),requestAnimationFrame(function(){n.cancel()}))},n.cursor&&this.canvas.setCursor(n.cursor),a=function(){window.removeEventListener("selectstart",e),window.removeEventListener("mousemove",t),window.removeEventListener("touchmove",t),window.removeEventListener("contextmenu",i),setTimeout(function(){return window.removeEventListener("mousedown",i)},0),window.removeEventListener("mouseup",i),window.removeEventListener("touchend",i),window.removeEventListener("keyup",s)},window.addEventListener("selectstart",e),window.addEventListener("mousemove",t),window.addEventListener("touchmove",t),window.addEventListener("contextmenu",i),setTimeout(function(){return window.addEventListener("mousedown",i)},0),window.addEventListener("mouseup",i),window.addEventListener("touchend",i),window.addEventListener("keyup",s))},n.prototype.refreshMarkers=function(){},e=n,t.Tool=e}(Inker=Inker||{}),function(s){!function(p){p.INERTIA=.01,p.MIN_INERTIA_VELOCITY=1;var e,t=(e=p.Tool,__extends(n,e),n.prototype.getName=function(){return"Browse"},n.prototype.getIcon=function(){return s.UI.Icons.tools.browse},n.prototype.createToolPanel=function(){this.toolPanel=new o(this.app,this)},n.prototype.getCursor=function(){return"-webkit-grab"},n.prototype.getHelpMessage=function(){return null},n.prototype.supportsRulerMode=function(){return!1},n.prototype.createStyleNode=function(){var e=document.createElement("style");e.setAttribute("id","BrowseToolStyle"),e.innerHTML='[data-type="Ruler"] { visibility: hidden; }',document.head.appendChild(e),this.styleNode=e},n.prototype.removeStyleNode=function(){document.head.removeChild(this.styleNode)},n.prototype.defineProperties=function(){var t=document.createElement("style");t.setAttribute("id","viewOutlinesOnlyStyle"),t.textContent='* [data-type="Curve"] { fill: transparent; stroke: black; stroke-width: 1; vector-effect: non-scaling-stroke; opacity: 1; }',xp.Model.property(this,"viewOutlinesOnly",!1,{setterConvertor:function(e){return e?document.head.appendChild(t):document.head.removeChild(t),e}})},n.prototype.onEnabled=function(){var t=this;this.registrar.subscribe(this.canvas.onPointerDown,function(e){t.startBrowsing(e.elementX,e.elementY)},this),this.createStyleNode()},n.prototype.onDisabled=function(){e.prototype.onDisabled.call(this),this.removeStyleNode()},n.prototype.startBrowsing=function(e,t){var a=this,l={x:e,y:t,time:Date.now()},c=null;this.performDrag({move:function(e,t){var n=a.canvas.viewport;a.canvas.viewport={x:n.x+e-l.x,y:n.y+t-l.y,zoom:n.zoom},c=l,l={x:e,y:t,time:Date.now()}},end:function(e,t){var n,o,r,i,s;l&&c&&(n=(l.x-c.x)/(l.time-c.time),o=(l.y-c.y)/(l.time-c.time),r=Math.sqrt(n*n+o*o),i=Geo.getAngle(Geo.pt(0,0),Geo.pt(n,o)),console.log("V",r),r>=p.MIN_INERTIA_VELOCITY&&(s=function(o){requestAnimationFrame(function(){var e,t=Date.now(),n=t-o;0<(r-=p.INERTIA*n)&&(e=a.canvas.viewport,a.canvas.viewport={x:e.x+r*n*Math.cos(i),y:e.y+r*n*Math.sin(i),zoom:e.zoom},s(t))})})(Date.now()))},cancel:function(){},cursor:"-webkit-grabbing"})},n);function n(){e.apply(this,arguments)}p.BrowseTool=t;var r,o=(r=s.UI.ToolPanel,__extends(i,r),i.prototype.onViewCenterClick=function(){this.app.window.canvas.viewCenter()},i.prototype.onViewAllClick=function(){this.app.window.canvas.viewAll()},i.prototype.onZoomInClick=function(){var e=this.app.window.canvas;e.zoom(e.domElement.offsetWidth/2,e.domElement.offsetHeight/2,!0)},i.prototype.onZoomOutClick=function(){var e=this.app.window.canvas;e.zoom(e.domElement.offsetWidth/2,e.domElement.offsetHeight/2,!1)},i);function i(e,t,n){var o=this;r.call(this,n,[new xp.HBox({},[new xp.Button({text:"View center",icon:s.UI.Icons.browseTool.center,onClick:function(){return o.onViewCenterClick()}}),new xp.Button({text:"View all",icon:s.UI.Icons.browseTool.all,onClick:function(){return o.onViewAllClick()}}),new xp.Button({text:"Zoom in",icon:s.UI.Icons.zoomIn,onClick:function(){return o.onZoomInClick()}}),new xp.Button({text:"Zoom out",icon:s.UI.Icons.zoomOut,onClick:function(){return o.onZoomOutClick()}})]),new xp.HBox({},[new xp.CheckBox({text:"Hide overflow",checked:"{document.hideOverflow}",margin:"0 0.25em 0 0.75em"}),new xp.CheckBox({text:"View outlines",checked:"{viewOutlinesOnly}",margin:"0 0.75em 0 0.25em"})]),new xp.HBox({},[new xp.Label({text:"width:",margin:"0 0.25em 0 0.75em"}),new xp.TextBox({text:"{document.width}",width:"4em",type:"number",min:1}),new xp.Label({text:"height:",margin:"0 0.25em 0 0.75em"}),new xp.TextBox({text:"{document.height}",width:"4em",type:"number",min:1})]),new xp.HBox({margin:"0 0 0 0.5em"},[new xp.Label({text:"markers size:",margin:"0 0.25em 0 0.5em",style:"inputLabel"}),new xp.TextBox({value:"{app.settings.markers.size}",type:"number",width:"3em",min:4,max:24,step:4})])]),this.app=e,this.tool=t,this.useParentScope=!1,this.scope=new xp.Scope(this.tool,this.app)}}(s.Tools||(s.Tools={}))}(Inker=Inker||{}),function(j){!function(i){var e,t=(e=i.Tool,__extends(n,e),n.prototype.getName=function(){return"Draw"},n.prototype.getIcon=function(){return j.UI.Icons.tools.draw},n.prototype.createToolPanel=function(){this.toolPanel=new o(this.app,this)},n.prototype.getCursor=function(){switch(this.mode){case"pencil":return"url(style/img/cursor_drawTool.png) 1 17, default";case"brush":case"simple-brush":return this.getBrushCursor();case"eraser":return this.getEraserCursor();default:return"default"}},n.prototype.getBrushCursor=function(){var e=this.brushSize*this.canvas.viewport.zoom;return'url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="'+e+'" height="'+e+'"><circle cx="'+e/2+'" cy="'+e/2+'" r="'+e/2+'" fill="'+this.doc.defaultFill.color+"\" /></svg>') "+e/2+" "+e/2+", auto"},n.prototype.getEraserCursor=function(){var e=this.brushSize*this.canvas.viewport.zoom;return'url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="'+e+'" height="'+e+'"><circle cx="'+(e/2-1)+'" cy="'+(e/2-1)+'" r="'+(e/2-1)+'" fill="white" stroke="black" stroke-width="1" /></svg>\') '+e/2+" "+e/2+", auto"},n.prototype.getHotkeys=function(){var e=this;return[{hotkey:"Q",action:function(){return e.mode="pencil"}},{hotkey:"W",action:function(){return e.mode="brush"}},{hotkey:"E",action:function(){return e.mode="eraser"}},{hotkey:"[",action:function(){return e.brushSize=e.brushSize<9?1:8*Math.floor((e.brushSize-8)/8)},allowMultiple:!0},{hotkey:"]",action:function(){return e.brushSize=8*Math.floor((e.brushSize+8)/8)},allowMultiple:!0}]},n.prototype.getHelpMessage=function(){return'<img src="help/draw-tool.gif"/>'},n.prototype.supportsRulerMode=function(){return!0},n.prototype.defineProperties=function(){xp.Model.property(this,"mode","pencil"),xp.Model.property(this,"brushSize",16)},n.prototype.onEnabled=function(){var t=this;this.registrar.subscribe(this.canvas.onPointerDown,function(e){t.startCreating(e.elementX,e.elementY,e.domEvent instanceof TouchEvent?e.domEvent.changedTouches[0].force:null)},this),this.registrar.subscribe(this.canvas.onViewportChanged,function(e){t.createMarkers(),t.canvas.replaceCursor(t.getCursor())},this),this.createMarkers(),this.registrar.subscribe(this.onPropertyChanged,function(e){"mode"!==e&&"brushSize"!==e||t.canvas.replaceCursor(t.getCursor())},this)},n.prototype.onDisabled=function(){e.prototype.onDisabled.call(this),this.removeMarkers()},n.prototype.onSelectionChanged=function(){this.createHighlights()},n.prototype.onDocumentChanged=function(){this.createHighlights()},n.prototype.startCreating=function(e,t,n){var o,z,r,U=this;this.doc.currentLayer.locked?this.app.message.warn("Current layer is locked."):(o=this.canvas.getSnappedCoords(e,t),z=[{x:o.x,y:o.y,force:"pencil"===this.mode?1:n}],r="pencil"===this.mode?(r=this.doc.getSelectedElements(j.Doc.Curve),this.app.getTool(i.BrowseTool).viewOutlinesOnly?void 0:0<r.length?r[0].hasStroke?r[0].stroke.width*this.canvas.viewport.zoom:void 0:"transparent"!==this.doc.defaultStroke.color&&0<this.doc.defaultStroke.width?this.doc.defaultStroke.width*this.canvas.viewport.zoom:void 0):this.brushSize*this.canvas.viewport.zoom,this.pencilMarker=new i.Markers.PencilMarker(this.canvas.levels.markers,z,r),this.rulerModeEnabled&&this.canvas.createTempRulers(this.canvas.translateXIn(e),this.canvas.translateYIn(t)),this.performDrag({move:function(e,t,n){t=U.canvas.getSnappedCoords(e,t),n={x:t.x,y:t.y,force:"pencil"!==U.mode&&n instanceof TouchEvent&&"number"==typeof n.changedTouches[0].force?n.changedTouches[0].force:1};n.x===z[z.length-1].x&&n.y===z[z.length-1].y||(z.push(n),U.pencilMarker.setPoints(z))},cancel:function(){U.removePencilMarker(),U.canvas.removeTempRulers()},end:function(){if(U.removePencilMarker(),U.canvas.removeTempRulers(),!(z.length<2)){for(var e=+U.app.settings.drawTool.jitter,t=4*e,a=Math.PI/4,l=Math.PI/4,c=16*e,p=4*e,h=16*e,n=+U.app.settings.drawTool.jitter,o=1;o<z.length-1;o++)if((n-=Geo.getLength(z[o-1],z[o]))<0){z[0].force=z[o].force;break}n=+U.app.settings.drawTool.jitter;for(o=z.length-2;0<=o;o--)if((n-=Geo.getLength(z[o+1],z[o]))<0){z[z.length-1].force=z[o].force;break}for(var d,u,f=[z[0]],r=0,i=[],n=0,o=1;o<z.length-1;o++)e<=(n=Geo.getLength(z[o-1],z[o]))?f.push(z[o]):(r+=n,i.push(z[o])),e<=r&&f.push({x:i.map(function(e){return e.x}).reduce(function(e,t){return e+t})/i.length,y:i.map(function(e){return e.y}).reduce(function(e,t){return e+t})/i.length,force:i.map(function(e){return e.force}).reduce(function(e,t){return e+t})/i.length}),(e<=r||e<=n)&&(r=0,i.splice(0));Geo.getLength(z[z.length-1],f[f.length-1])<e&&f.pop(),f.push(z[z.length-1]),z=f;for(n=0,o=1;o<z.length;o++)if(e<=(n+=Geo.getLength(z[o-1],z[o]))||o===z.length-1){d=Geo.getAngle(z[0],z[o]);break}n=0;for(o=z.length-2;0<=o;o--)if(e<=(n+=Geo.getLength(z[o+1],z[o]))||0===o){u=Geo.getAngle(z[o],z[z.length-1]);break}for(var m=[],o=2;o<z.length-2;o++){var s=Geo.getQPt(z[o-2],z[o-1],z[o-1],z[o]),g=Geo.getQPt(z[o-1],z[o],z[o],z[o+1]),v=Geo.getQPt(z[o],z[o+1],z[o+1],z[o+2]);(a<g-s||a<g-v)&&m.push(z[o])}for(f=[z[0]],r=0,i=[],n=0,o=1;o<z.length-1;o++)t<=(n=Geo.getLength(z[o-1],z[o]))||0<=m.indexOf(z[o])?f.push(z[o]):(r+=n,i.push(z[o])),t<=r&&f.push({x:i.map(function(e){return e.x}).reduce(function(e,t){return e+t})/i.length,y:i.map(function(e){return e.y}).reduce(function(e,t){return e+t})/i.length,force:i.map(function(e){return e.force}).reduce(function(e,t){return e+t})/i.length}),(t<=r||t<=n||0<=m.indexOf(z[o]))&&(r=0,i.splice(0));Geo.getLength(z[z.length-1],f[f.length-1])<t&&m.indexOf(f[f.length-1])<0&&f.pop(),f.push(z[z.length-1]),z=f;for(var y,x=[],w=0,o=0;o<=m.length;o++){if((y=o>m.length-1?z.length:z.indexOf(m[o]))<0)throw new Error("Out of range.");x.push(z.slice(w,y+1)),w=y}x.forEach(function(e){for(var t=0,n=1;n<e.length;n++)t+=Geo.getLength(e[n-1],e[n]);f=[e[0]];for(var o=0,r=0,i=2*c<t?l:l/2,s=4*c<t?c:c/2,n=1;n<e.length-1;n++)o+=Geo.getQPt(e[n-1],e[n],e[n],e[n+1]),r+=Geo.getLength(e[n-1],e[n]),(0<=m.indexOf(e[n])||o>=(n===e.length-2?2*i:i)||r>=(n===e.length-2?2*s:s))&&(r=o=0,f.push(e[n]));f.push(e[e.length-1]),e.splice(0),Array.prototype.push.apply(e,f)}),z=[],x.forEach(function(e){z=z.concat(e.slice(0,e.length-1))});var b=x[x.length-1];if(z.push(b[b.length-1]),"pencil"===U.mode){var E,k,C=[];U.doc.cascadeSelected(j.Doc.Curve,function(e){return Array.prototype.push.apply(C,e.paths)});var S=1+p;if(C.forEach(function(e){var t;e.isClosed||((t=Geo.getLength(U.canvas.translatePtOut(e.points[0]),z[0]))<=p&&t<S&&(E=e,S=t,k=!0),(t=Geo.getLength(U.canvas.translatePtOut(e.points[e.points.length-1]),z[0]))<=p&&t<S&&(E=e,S=t,k=!1))}),!E){var P,S=1+p;if(C.forEach(function(n){n.segments.forEach(function(e){var t=4===e.points.length?Geo.Bezier.getClosestPoint(z[0],e.points.map(function(e){return U.canvas.translatePtOut(e)}),.01):Geo.getLinesIntersection(U.canvas.translatePtOut(e.points[0]),U.canvas.translatePtOut(e.points[1]),z[0],Geo.placePoint(z[0],1,Geo.getAngle(e.points[0],e.points[1])+Math.PI/2),!0),t=Geo.getLength(t,z[0]);t<=p&&t<S&&(P=n,L=e,S=t)})}),P){var M=P.segments.indexOf(L),I=Geo.getQ(d,Geo.getAngle(L.points[0],L.points[1])),T=Geo.getQ(d,Geo.getAngle(L.points[L.points.length-1],L.points[L.points.length-2]))<I,S=1+p;if(P.segments.forEach(function(n){n.points.forEach(function(e){var t=4===n.points.length?Geo.Bezier.getClosestPoint(z[z.length-1],n.points.map(function(e){return U.canvas.translatePtOut(e)}),.01):Geo.getLinesIntersection(U.canvas.translatePtOut(n.points[0]),U.canvas.translatePtOut(n.points[1]),z[z.length-1],Geo.placePoint(z[z.length-1],1,Geo.getAngle(n.points[0],n.points[1])+Math.PI/2),!0),t=Geo.getLength(t,z[z.length-1]);t<=p&&t<S&&(A=n,S=t)})}),A){if(U.app.memento.isLocked)return;var L,A,B,D=app.memento.beforeAction({modify:[P.curve]}),_=P,b=_.segments.indexOf(A),O=_.pointBefore(L),R=_.pointAfter(A);if(_.isClosed||(T&&M<b||!T&&b<M&&3<=_.points.length?_.close():T=b<M),T&&(z.reverse(),I=M,M=b,b=I,I=L,L=A,A=I,I=_.pointAfter(O),O=_.pointBefore(R),R=I,d=u+Math.PI,u=d+Math.PI),0===P.segments.length)throw new Error("Path has no segments.");if(O!==R)for(;3<_.points.length&&(B=_.pointAfter(O))!==R;)_.removePoint(B);for(o=z.length-2;1<=o;o--)_.insertPoint(_.segmentAfter(O),U.canvas.translateXIn(z[o].x),U.canvas.translateYIn(z[o].y),0<=m.indexOf(z[o])?j.Doc.PointType.Cusp:j.Doc.PointType.Smooth);return _.updateSegments(),_.curve.updateSvgPath(),U.createMarkers(),void D.afterAction()}}}U.app.memento.isLocked||U.app.memento.perform({modify:P?[P.curve]:E?[E.curve]:null,action:function(){if(P)if(P.isClosed){var n=P;k=T?(n.open(n.pointAfter(L)),!0):(n.open(n.pointBefore(L)),!1),E=P}else{if(T){do{var e=P.segments[0]}while(P.removePoint(P.points[0]),e!==L);k=!0}else{do{e=P.segments[P.segments.length-1]}while(P.removePoint(P.points[P.points.length-1]),e!==L);k=!1}E=P}var t;k&&E.reverse(),E&&(t=E.segments[E.segments.length-1],t=Geo.getQ(d,Geo.getAngle(t.points[t.points.length-2],t.points[t.points.length-1])),a<=t&&E.convertPoint(E.points[E.points.length-1],j.Doc.PointType.Cusp)),(n=E||U.doc.actions.curve.create(U.canvas.translateXIn(z[0].x),U.canvas.translateYIn(z[0].y),j.Doc.PointType.Smooth).paths[0]).movePoint(n.points[n.points.length-1],U.canvas.translateXIn(z[0].x),U.canvas.translateYIn(z[0].y)),console.log("Detecting overlap...");for(var o=h,r=!1,i=U.canvas.translatePtOut(n.points[0]),s=z.length-1;3<=s;s--){if(Geo.getDistanceToLine(i,z[s],z[s-1],!1)<p){r=!0,console.log("Distance",Geo.getDistanceToLine(i,z[s],z[s-1],!1)),console.log("Overlap detected."),z.splice(s);break}if((o-=Geo.getLength(z[s],z[s-1]))<=0)break}return z.shift(),z.forEach(function(e,t){n.addPoint(U.canvas.translateXIn(e.x),U.canvas.translateYIn(e.y),0<=m.indexOf(e)?j.Doc.PointType.Cusp:j.Doc.PointType.Smooth,e.force),t===z.length-1&&(r||Geo.getLength(e,U.canvas.translatePtOut(n.points[0]))<=p)&&2<n.points.length&&(n.close(),E?(e=n.segments[0],e=Geo.getQ(u,Geo.getAngle(e.points[0],e.points[1])),a<=e&&n.convertPoint(n.points[0],j.Doc.PointType.Cusp)):Geo.getQ(d,u)>=a&&n.convertPoint(n.points[0],j.Doc.PointType.Cusp))}),n.updateSegments(),n.curve.updateSvgPath(),U.createMarkers(),E?null:{created:[n.curve]}}})}else if("simple-brush"===U.mode)U.app.memento.perform({action:function(){U.doc.actions.select.deselectAll();for(var e=U.doc.actions.curve.create(U.canvas.translateXIn(z[0].x),U.canvas.translateYIn(z[0].y),j.Doc.PointType.Smooth,z[0].force),t=1;t<z.length;t++)U.doc.actions.curve.addPoint(U.canvas.translateXIn(z[t].x),U.canvas.translateYIn(z[t].y),0<=m.indexOf(z[t])?j.Doc.PointType.Cusp:j.Doc.PointType.Smooth,z[t].force);return e.stroke.color="black",e.stroke.width=U.brushSize,e.strokeToPath("round"),e.fill.color=U.doc.defaultFill.color,U.createMarkers(),{created:U.doc.getSelectedElements(j.Doc.Curve)}}});else{if("brush"!==U.mode&&"eraser"!==U.mode)throw new Error('Mode "'+U.mode+'" is not implemented.');var G,N,F=U.doc.selectedElements.slice(0),D=U.doc.getSelectedElements(j.Doc.Curve).filter(function(e){return e.isClosed}),H=D[D.length-1];U.app.memento.isLocked||(G=j.BooleanOperations.e,j.BooleanOperations.e=.01,U.app.memento.perform({delete:H?[H]:null,action:function(){U.doc.actions.select.deselectAll(),N=U.doc.actions.curve.create(U.canvas.translateXIn(z[0].x),U.canvas.translateYIn(z[0].y),j.Doc.PointType.Smooth,z[0].force);for(var e=1;e<z.length;e++)U.doc.actions.curve.addPoint(U.canvas.translateXIn(z[e].x),U.canvas.translateYIn(z[e].y),0<=m.indexOf(z[e])?j.Doc.PointType.Cusp:j.Doc.PointType.Smooth,z[e].force);return N.stroke.color="black",N.stroke.width=U.brushSize,N.strokeToPath("round"),"brush"===U.mode?H?U.doc.actions.curve.unite([H,N]):("transparent"!==U.doc.defaultFill.color?N.fill.color=U.doc.defaultFill.color:"transparent"!==U.doc.defaultStroke.color?N.fill.color=U.doc.defaultStroke.color:U.doc.colors[0]&&(N.fill.color=U.doc.colors[0]),N.stroke.color="transparent"):H?(N.paths[0].reverse(),U.doc.actions.curve.backMinusFront([H,N])):U.doc.actions.remove.removeElement(N),U.doc.cascadeSelected(j.Doc.Curve,function(e){e.paths.forEach(function(e){return e.updateSegments()}),e.updateSvgPath()}),U.createMarkers(),j.BooleanOperations.e=G,{created:U.doc.getSelectedElements(j.Doc.Curve)}},onError:function(e){N&&N.parent,U.doc.actions.remove.removeElement(N),F.forEach(function(e){U.doc.actions.select.selectElement(e)}),app.memento.unlock(),j.BooleanOperations.e=G,U.app.message.error(e.message)}}))}}}}))},n.prototype.createMarkers=function(){this.removeMarkers(),this.createHighlights()},n.prototype.removeMarkers=function(){this.removeHighlights(),this.removePencilMarker()},n.prototype.createHighlights=function(){var t,n=this;this.removeHighlights(),this.doc&&(t=document.createDocumentFragment(),this.doc.cascadeSelected(j.Doc.Drawing,function(e){e=i.Markers.createHighlight(t,e,n.canvas);n.highlights.push(e)}),this.canvas.levels.markers.appendChild(t))},n.prototype.removeHighlights=function(){this.highlights&&this.highlights.forEach(function(e){return j.Svg.remove(e)}),this.highlights=[]},n.prototype.removePencilMarker=function(){this.pencilMarker&&this.pencilMarker.remove(),this.pencilMarker=null},n);function n(){e.apply(this,arguments)}i.DrawTool=t;var r,o=(r=j.UI.ToolPanel,__extends(s,r),s);function s(e,t,n){var o=this;r.call(this,n,[new xp.HBox({},[new xp.ToggleButton({text:"Pencil",item:"pencil",selectedItem:"{mode}",icon:j.UI.Icons.pencil}),new xp.ToggleButton({text:"Brush",item:"simple-brush",selectedItem:"{mode}",icon:j.UI.Icons.brush,visible:!1}),new xp.ToggleButton({text:"Brush",item:"brush",selectedItem:"{mode}",icon:j.UI.Icons.brush,visible:!1}),new xp.ToggleButton({text:"Eraser",item:"eraser",selectedItem:"{mode}",icon:j.UI.Icons.eraser,visible:!1})]),new xp.HBox({},[new xp.Button({text:"Deselect",icon:j.UI.Icons.deselect,enabled:"({app.document.selectedElements.length} > 0)",onClick:function(){return o.app.document.actions.select.deselectAll()}})]),new xp.HBox({},[new xp.HBox({enabled:'({mode}==="brush" || {mode}==="eraser" || {mode}==="simple-brush")'},[new xp.Label({text:"brush size:",margin:"0 0.25em 0 0.5em"}),new xp.TextBox({text:"{brushSize}",type:"number",min:1,step:1,width:"4em"})]),new xp.Label({text:"jitter:",margin:"0 0.25em 0 0.5em"}),new xp.TextBox({text:"{app.settings.drawTool.jitter}",type:"number",min:2,step:1,max:16,width:"4em"})])]),this.app=e,this.tool=t,this.useParentScope=!1,this.scope=t}}(j.Tools||(j.Tools={}))}(Inker=Inker||{}),function(C){!function(k){var n,e=(n=k.Tool,__extends(r,n),r.prototype.getName=function(){return"Path"},r.prototype.getIcon=function(){return C.UI.Icons.tools.path},r.prototype.createToolPanel=function(){this.toolPanel=new t(this.app,this)},r.prototype.getCursor=function(){return"url(style/img/cursor_pathTool.png) 1 1, default"},r.prototype.getHotkeys=function(){var e=this;return[{hotkey:"DELETE",action:function(){return e.actions.deletePoints()}},{hotkey:"ALT+A",action:function(){return e.actions.alignPoints()}},{hotkey:"ALT+D",action:function(){return e.actions.duplicatePoints()}}]},r.prototype.getHelpMessage=function(){return'<img src="help/path-tool.gif"/>'},r.prototype.supportsRulerMode=function(){return!0},r.prototype.onEnabled=function(){var t=this;this.registrar.subscribe(this.canvas.onPointerDown,function(e){t.onCanvasMouseDown(e)},this),this.registrar.subscribe(this.canvas.onMouseMove,function(e){t.isDragging||t.onDummyMouseMove(e)},this),this.registrar.subscribe(this.onRulerModeChanged,function(e){e?(e=t.selectedPoints.length?t.selectedPoints[t.selectedPoints.length-1]:null)&&0===t.canvas.tempRulers.length&&(t.canvas.createTempRulers(e.x,e.y),t.pointForRulers=e):(t.canvas.removeTempRulers(),t.pointForRulers=null)}),this.registrar.subscribe(this.canvas.onViewportChanged,function(e){t.updateMarkers()},this),this.doc&&this.createMarkers(),this.resetSelectedCurves(),this.restoreSelectedPoints()},r.prototype.onDocumentChanged=function(){this.createMarkers(),this.resetSelectedCurves()},r.prototype.onSelectionChanged=function(){this.createMarkers(),this.resetSelectedCurves()},r.prototype.onDisabled=function(){var n=this;this.saveSelectedPoints(),this.registrar.unsubscribeAll(),this.removeMarkers(),this.canvas.removeTempRulers(),this.pointForRulers=null,this.canvas.afterSnap(),this.doc.cascadeElements(C.Doc.Curve,function(e){for(var t=e.paths.length-1;0<=t;t--)e.paths[t].points.length<2&&(e.paths.splice(t,1),0===e.paths.length&&n.doc.actions.remove.removeElement(e))})},r.prototype.resetSelectedCurves=function(){var t=this;this.selectedCurves.splice(0),this.doc.getSelectedElements(C.Doc.Curve).forEach(function(e){return t.selectedCurves.push(e)})},r.prototype.selectPoint=function(t){var e;this.selectedPoints.indexOf(t)<0&&((e=this.pointMarkers.filter(function(e){return e.p===t})[0]).marker.selected=!0,this.selectedPoints.push(e.p),this.selectedPaths.indexOf(e.path)<0&&this.selectedPaths.push(e.path))},r.prototype.deselectPoint=function(t){var n;0<=this.selectedPoints.indexOf(t)&&((n=this.pointMarkers.filter(function(e){return e.p===t})[0]).marker.selected=!1,this.selectedPoints.splice(this.selectedPoints.indexOf(n.p),1),0===this.pointMarkers.filter(function(e){return e.path===n.path&&!0===e.marker.selected}).length&&this.selectedPaths.splice(this.selectedPaths.indexOf(n.path),1))},r.prototype.deselectAllPoints=function(){this.pointMarkers.forEach(function(e){return e.marker.selected=!1}),this.selectedPoints.splice(0),this.selectedPaths.splice(0)},r.prototype.saveSelectedPoints=function(){this.savedSelectedPoints=this.selectedPoints.slice(0)},r.prototype.restoreSelectedPoints=function(){var e=this;this.savedSelectedPoints&&this.savedSelectedPoints.forEach(function(t){0<e.pointMarkers.filter(function(e){return e.p===t}).length&&e.selectPoint(t)})},r.prototype.execSelPoints=function(t,e){var n=this,o=this.pointMarkers.filter(function(e){return 0<=n.selectedPoints.indexOf(e.p)}),r=[],i=[];switch(o.forEach(function(e){t(n.doc,e.curve,e.path,e.p),r.indexOf(e.path)<0&&r.push(e.path),i.indexOf(e.curve)<0&&i.push(e.curve)}),r.forEach(function(e){return e.updateSegments()}),i.forEach(function(e){return e.updateSvgPath()}),e){case"none":break;case"update":this.updateMarkers(r);break;case"recreate":this.createMarkers();break;default:throw new Error('Unknown markers action "'+e+'".')}return{curves:i,paths:r}},r.prototype.getAffectedPaths=function(){var t=this,e=this.pointMarkers.filter(function(e){return 0<=t.selectedPoints.indexOf(e.p)}),n=[];return e.forEach(function(e){n.indexOf(e.path)<0&&n.push(e.path)}),n},r.prototype.getAffectedCurves=function(){var t=this,e=this.pointMarkers.filter(function(e){return 0<=t.selectedPoints.indexOf(e.p)}),n=[];return e.forEach(function(e){n.indexOf(e.curve)<0&&n.push(e.curve)}),n},r.prototype.onDummyMouseMove=function(e){var t=this.canvas.getSnappedCoords(e.elementX,e.elementY);this.tempLineMarker&&(this.tempLineMarker.endPt=t,this.tempLineMarker.update()),this.updatePointMarkersOpacity(e.elementX,e.elementY)},r.prototype.onCanvasMouseDown=function(v){var y,x,w,b,E=this;this.doc.currentLayer.locked?this.app.message.warn("Current layer is locked."):this.distortBox||this.app.memento.isLocked||(y={x:v.elementX,y:v.elementY,force:1},b=[y],this.performDrag({move:function(e,t,n){var o={x:e,y:t,force:1};(!w||!x)&&Geo.getLength(y,o)<r.selectionMinDistance||(v.domEvent instanceof TouchEvent||3===v.domEvent.which||v.domEvent.altKey||v.domEvent.metaKey||v.domEvent.ctrlKey?(b.push(o),w||(w=new k.Markers.PencilMarker(E.canvas.levels.markers,b),v.domEvent.shiftKey||E.deselectAllPoints(),E.removeTempLineMarker()),w&&w.setPoints(b)):(x||(x=new k.Markers.SelectBox(E.canvas.levels.markers,y,o),v.domEvent.shiftKey||E.deselectAllPoints(),E.removeTempLineMarker()),x&&(x.end={x:e,y:t})))},cancel:function(){x&&x.remove(),w&&w.remove()},end:function(n,o,r){if(x||w){if(x&&(t=E.canvas.translateBoxIn(x.bBox),E.doc.cascadeSelected(C.Doc.Curve,function(e){e.paths.forEach(function(e){e.points.forEach(function(e){e.x>=t.left&&e.y>=t.top&&e.x<=t.left+t.width&&e.y<=t.top+t.height&&(!r.shiftKey||E.selectedPoints.indexOf(e)<0?E.selectPoint(e):E.deselectPoint(e))})})}),x.remove()),w){if(b.length<2)return;b.push(y),w.setPoints(b);for(var e,t,i,s,a,l=b,c=[l[0]],p=+E.app.settings.drawTool.jitter,h=0,d=[],u=1;u<l.length-1;u++)p<=(e=Geo.getLength(l[u-1],l[u]))?c.push(l[u]):(h+=e,d.push(l[u])),p<=h&&c.push({x:d.map(function(e){return e.x}).reduce(function(e,t){return e+t})/d.length,y:d.map(function(e){return e.y}).reduce(function(e,t){return e+t})/d.length,force:1}),(p<=h||p<=e)&&(h=0,d.splice(0));Geo.getLength(l[l.length-1],c[c.length-1])<p&&c.pop(),c.push(l[l.length-1]),l=c,(t=E.doc.getSelectedBBox())&&(i=E.canvas.translateXOut(Math.min.apply(null,l.map(function(e){return e.x}))),s=E.canvas.translateYOut(Math.min.apply(null,l.map(function(e){return e.y}))),a={x:Math.min(t.left,i)-100,y:Math.min(t.top,s)-100},E.doc.cascadeSelected(C.Doc.Curve,function(e){e.paths.forEach(function(e){e.points.forEach(function(e){for(var t=0,n=1;n<l.length;n++)Geo.getLinesIntersection(a,e,E.canvas.translatePtIn(l[n-1]),E.canvas.translatePtIn(l[n]))&&t++;t%2==1&&(!r.shiftKey||E.selectedPoints.indexOf(e)<0?E.selectPoint(e):E.deselectPoint(e))})})})),setTimeout(function(){return w.remove()},100)}E.createTempLineMarker()}else{var f=r instanceof MouseEvent&&3===r.which||r.altKey||v.domEvent.metaKey||r.ctrlKey,m=function(e){var t=E.canvas.getSnappedCoords(n,o),e=E.doc.actions.curve.addPoint(E.canvas.translateXIn(t.x),E.canvas.translateYIn(t.y),e?C.Doc.PointType.Cusp:C.Doc.PointType.Smooth);e.updateSegments(),e.curve.updateSvgPath(),E.canvas.afterSnap(),E.createMarkers(),E.deselectAllPoints(),E.selectPoint(e.points[e.points.length-1])},g=E.getLastUnclosedPath();g?(1===g.points.length&&E.doc.actions.select.deselectElement(g.curve),E.app.memento.isLocked||E.app.memento.perform({modify:2<=g.points.length?[g.curve]:null,action:function(){return 1===g.points.length&&E.doc.actions.select.selectElement(g.curve),m(f),2===g.points.length?{created:[g.curve]}:null}})):m(f)}}}))},r.prototype.onPointPointerDown=function(e,t,n,o,r,l,i){var c=this;this.rulerModeEnabled&&(0<=this.selectedPoints.indexOf(n)&&0<=this.selectedPoints.indexOf(this.pointForRulers)||0===this.canvas.tempRulers.length)&&(this.canvas.createTempRulers(n.x,n.y),this.pointForRulers=n),this.selectedPoints.indexOf(n)<0&&(this.deselectAllPoints(),this.selectPoint(n));var s,a,p,h=!1,d=this.selectedPoints.map(function(e){return{pt:e,coords:{x:c.canvas.translateXOut(e.x),y:c.canvas.translateYOut(e.y)}}}),u=(this.canvas.translateXOut(n.x),r.elementX,this.canvas.translateYOut(n.y),r.elementY,this.canvas.translateXOut(n.x)),f=this.canvas.translateYOut(n.y),m=r.elementX,g=r.elementY,v=(s=1/0,a=-1/0,d.forEach(function(e){e.coords.x<s&&(s=e.coords.x),e.coords.x>a&&(a=e.coords.x)}),(s+a)/2);!i&&this.app.memento.isLocked||(p=i||null,this.performDrag({cursor:"move",move:function(e,t){var a;1===c.selectedPoints.length&&l||(h||(p=p||c.app.memento.beforeAction({modify:c.getAffectedCurves()}),c.removeTempLineMarker(),h=!0),t=c.canvas.getSnappedCoords(u+e-m,f+t-g),a={x:t.x-u,y:t.y-f},c.execSelPoints(function(e,t,n,o){var r=d.filter(function(e){return e.pt===o})[0].coords,i=l?a.x*(r.x>v&&v<u||r.x<v&&u<v?1:r.x<v&&v<u||r.x>v&&u<v?-1:0):a.x,s=a.y;e.actions.curve.movePoint(n,o,c.canvas.translateXIn(r.x+i),c.canvas.translateYIn(r.y+s))},"update"))},cancel:function(){p&&p.cancelWithRestore(),c.createTempLineMarker(),c.canvas.afterSnap()},end:function(){if(h)p&&p.afterAction();else if(l){if(!p){if(c.app.memento.isLocked)return;p=c.app.memento.beforeAction({modify:[t.curve]})}!t.isClosed&&n===t.points[0]&&2<t.points.length?c.doc.actions.curve.closePath(t):c.doc.actions.curve.convertPoint(t,n),t.updateSegments(),e.updateSvgPath(),c.createMarkers(),c.canvas.afterSnap(),p.afterAction()}else p&&(t.updateSegments(),e.updateSvgPath(),c.createMarkers(),c.canvas.afterSnap(),p.afterAction());c.createTempLineMarker(),c.canvas.afterSnap()}}))},r.prototype.onSegmentMouseDown=function(n,o){var r,e,t,i,s,a,l,c,p,h,d=this;this.isDragging||(o.domEvent.stopPropagation(),r=this.segmentMarkers.filter(function(e){return e.seg===n})[0],e=function(){var e,t;d.app.memento.isLocked||(e=d.app.memento.beforeAction({modify:[r.curve]}),t=d.doc.actions.curve.insertPoint(r.path,n,d.canvas.translateXIn(o.elementX),d.canvas.translateYIn(o.elementY),C.Doc.PointType.Smooth),r.path.updateSegments(),r.curve.updateSvgPath(),d.createMarkers(),d.onPointPointerDown(r.curve,r.path,t,d.pointMarkers.filter(function(e){return e.p===t})[0].marker,o,o.domEvent instanceof MouseEvent&&3===o.domEvent.which||o.domEvent.altKey||o.domEvent.metaKey||o.domEvent.ctrlKey,e))},t=function(){d.app.memento.isLocked||d.app.memento.perform({modify:[r.curve],action:function(){return d.doc.actions.curve.convertSegmant(r.path,n),r.path.updateSegments(),r.curve.updateSvgPath(),d.createMarkers(),null}})},o.domEvent instanceof TouchEvent?((i=o.domEvent.target).style.opacity="0",document.body.appendChild(i),s=function(){document.body.removeChild(i),window.removeEventListener("touchend",s)},window.addEventListener("touchend",s),a=function(){e(),h()},l=function(){e(),h()},c=function(){t(),h()},p=function(e){e.cancelBubble=!0},h=function(){window.removeEventListener("contextmenu",c),window.removeEventListener("mousedown",p),window.removeEventListener("touchmove",a),window.removeEventListener("touchend",l)},window.addEventListener("contextmenu",c),window.addEventListener("mousedown",p,!0),window.addEventListener("touchmove",a),window.addEventListener("touchend",l)):(1!==o.domEvent.which||o.domEvent.altKey||o.domEvent.metaKey||o.domEvent.ctrlKey?t:e)())},r.prototype.startDistort=function(){var c=this;if(this.selectedPoints.length<2)this.app.message.warn("There must be at least two points selected.");else{var p=this.selectedPoints.slice(0),h=this.getAffectedPaths(),d=this.getAffectedCurves();this.removeMarkers();for(var u=p[0].x,f=p[0].y,m=p[0].x,g=p[0].y,e=1;e<p.length;e++)p[e].x<u&&(u=p[e].x),p[e].y<f&&(f=p[e].y),p[e].x>m&&(m=p[e].x),p[e].y>g&&(g=p[e].y);this.distortBox=new k.Markers.DistortBox(this.canvas.levels.markers,[this.canvas.translatePtOut({x:u,y:f}),this.canvas.translatePtOut({x:m,y:f}),this.canvas.translatePtOut({x:m,y:g}),this.canvas.translatePtOut({x:u,y:g})]);var v=p.map(function(e){return{x:e.x,y:e.y}});this.distortBox.onDistortMarkerMDown.addHandler(function(e){var t,n,o,i=c.distortBox.markers.indexOf(e.targetMarker);n=e.domEvent instanceof TouchEvent?(t=e.targetMarker.cx-e.domEvent.touches[0].pageX,e.targetMarker.cy-e.domEvent.touches[0].pageY):(t=e.targetMarker.cx-e.domEvent.pageX,e.targetMarker.cy-e.domEvent.pageY);var s,r,a,l=!0;c.app.memento.isLocked||(s=!1,r=function(e){e.stopPropagation(),s||(requestAnimationFrame(function(){l&&(o=c.app.memento.beforeAction({modify:d}),l=!1);var r=c.distortBox.points;e instanceof TouchEvent?(r[i].x=e.touches[0].pageX+t,r[i].y=e.touches[0].pageY+n):(r[i].x=e.pageX+t,r[i].y=e.pageY+n),c.distortBox.points=r,p.forEach(function(t,e){var n=Geo.getMidPoint(r[0],r[1],m===u?.5:(v[e].x-u)/(m-u)),o=Geo.getMidPoint(r[3],r[2],m===u?.5:(v[e].x-u)/(m-u)),o=Geo.getMidPoint(n,o,g===f?.5:(v[e].y-f)/(g-f)),e=h.filter(function(e){return 0<=e.points.indexOf(t)})[0];c.doc.actions.curve.movePoint(e,t,c.canvas.translateXIn(o.x),c.canvas.translateYIn(o.y))}),h.forEach(function(e){return e.updateSegments()}),d.forEach(function(e){return e.updateSvgPath()}),s=!1}),s=!0)},a=function(e){e.stopPropagation(),e.stopImmediatePropagation(),window.removeEventListener("mousemove",r),window.removeEventListener("touchmove",r),window.removeEventListener("mouseup",a),window.removeEventListener("touchend",a),requestAnimationFrame(function(){o&&o.afterAction()})},window.addEventListener("mousemove",r),window.addEventListener("touchmove",r),window.addEventListener("mouseup",a),window.addEventListener("touchend",a))});var t=function(e){c.isEnabled&&(c.removeDistortBox(),c.createMarkers()),e.stopPropagation(),e.preventDefault(),window.removeEventListener("mousedown",t),window.removeEventListener("touchstart",t)};window.addEventListener("mousedown",t),window.addEventListener("touchstart",t);var n=this.canvas.viewport,o=function(){var e,t;c.distortBox?(e=c.distortBox.points,t=c.canvas.viewport,e.forEach(function(e){e.x=(e.x-n.x)/n.zoom*t.zoom+t.x,e.y=(e.y-n.y)/n.zoom*t.zoom+t.y}),c.distortBox.points=e,n=t):c.canvas.onViewportChanged.removeHandler(o)};this.canvas.onViewportChanged.addHandler(o)}},r.prototype.removeDistortBox=function(){this.distortBox&&this.distortBox.remove(),this.distortBox=null},r.prototype.createMarkers=function(){this.createSegmentMarkers(),this.createPointMarkers(),this.createTempLineMarker()},r.prototype.updateMarkers=function(e){this.updateSegmentMarkers(e),this.updatePointMarkers(e),this.updateTempLineMarker()},r.prototype.removeMarkers=function(){this.removeSegmentMarkers(),this.removePointMarkers(),this.removeTempLineMarker(),this.removeDistortBox()},r.prototype.createPointMarkers=function(){var h=this;this.removePointMarkers();var e=document.createDocumentFragment();this.doc.cascadeSelected(C.Doc.Curve,function(p){p.paths.forEach(function(c){c.points.forEach(function(s){var a;switch(s.type){case C.Doc.PointType.Cusp:a=new k.Markers.SquareMarker(e,h.canvas.translateXOut(s.x),h.canvas.translateYOut(s.y));break;case C.Doc.PointType.Smooth:a=new k.Markers.RoundMarker(e,h.canvas.translateXOut(s.x),h.canvas.translateYOut(s.y));break;default:throw new Error("Unexpected point type.")}h.pointMarkers.push({curve:p,path:c,p:s,marker:a}),a.element.addEventListener("mousedown",function(e){var t=xp.createEventArgs(h.canvas,e);t.domEvent.stopPropagation(),l||h.onPointPointerDown(p,c,s,a,t,3===e.which||e.altKey||e.metaKey||e.ctrlKey)}),a.element.addEventListener("mouseenter",function(e){h.removeTempLineMarker()}),a.element.addEventListener("mouseleave",function(e){h.createTempLineMarker()});var l=!1;a.element.addEventListener("touchstart",function(e){var t=xp.createEventArgs(h.canvas,e);t.domEvent.stopPropagation(),l=!0;var n=function(e){h.onPointPointerDown(p,c,s,a,t,!0),i()},o=function(e){h.onPointPointerDown(p,c,s,a,t,!1),i()},r=function(e){h.onPointPointerDown(p,c,s,a,t,!1),i()};function i(){a.element.removeEventListener("touchend",o),a.element.removeEventListener("touchend",n),a.element.removeEventListener("touchmove",r),l=!1}a.element.addEventListener("touchend",o),a.element.addEventListener("contextmenu",n),a.element.addEventListener("touchmove",r)})})})}),this.canvas.levels.markers.appendChild(e),this.updatePointMarkersVisibility()},r.prototype.updatePointMarkers=function(t){var n=this;this.pointMarkers.forEach(function(e){(!t||0<=t.indexOf(e.path))&&(e.marker.cx=n.canvas.translateXOut(e.p.x),e.marker.cy=n.canvas.translateYOut(e.p.y))}),this.updatePointMarkersVisibility()},r.prototype.updatePointMarkersOpacity=function(e,t){},r.prototype.updatePointMarkersVisibility=function(){},r.prototype.removePointMarkers=function(){this.pointMarkers&&this.pointMarkers.forEach(function(e){return e.marker.remove()}),this.pointMarkers=[],this.selectedPoints.splice(0),this.selectedPaths.splice(0)},r.prototype.createSegmentMarkers=function(){var i=this;this.removeSegmentMarkers();var s=document.createDocumentFragment();this.doc.cascadeSelected(C.Doc.Curve,function(r){r.paths.forEach(function(o){o.segments.forEach(function(t,e){var n=new k.Markers.SegmentMarker(s,t.points,i.canvas);i.segmentMarkers.push({curve:r,path:o,seg:t,marker:n}),o.isClosed&&(n.isVisible=!1),n.onMouseDown.addHandler(function(e){e.domEvent.cancelBubble=!0,i.onSegmentMouseDown(t,e)},i),n.onMouseEnter.addHandler(function(e){i.removeTempLineMarker()},i),n.onMouseLeave.addHandler(function(e){i.createTempLineMarker()},i),0===e&&(n.isStartSegment=!0)})})}),this.canvas.levels.markers.appendChild(s)},r.prototype.updateSegmentMarkers=function(t){this.segmentMarkers.forEach(function(e){(!t||0<=t.indexOf(e.path))&&(e.marker.points=e.seg.points)})},r.prototype.removeSegmentMarkers=function(){this.segmentMarkers.forEach(function(e){return e.marker.remove()}),this.segmentMarkers=[]},r.prototype.createTempLineMarker=function(){this.removeTempLineMarker();var e,t,n=this.getLastPtOfUnclosedPath();n&&(n.a?t=n.a:n.type!==C.Doc.PointType.Smooth||(e=this.getLastUnclosedPath().segmentBefore(n))&&(t=Geo.getAngle(e.points[e.points.length-2],e.points[e.points.length-1])),n={x:this.canvas.translateXOut(n.x),y:this.canvas.translateYOut(n.y)},this.tempLineMarker=new k.Markers.TempLineMarker(this.canvas.levels.markers,n,n,t))},r.prototype.updateTempLineMarker=function(){var e;!this.tempLineMarker||(e=this.getLastPtOfUnclosedPath())&&(e={x:this.canvas.translateXOut(e.x),y:this.canvas.translateYOut(e.y)},this.tempLineMarker.startPt=e,this.tempLineMarker.update())},r.prototype.removeTempLineMarker=function(){this.tempLineMarker&&this.tempLineMarker.remove(),this.tempLineMarker=null},r.prototype.getLastPtOfUnclosedPath=function(){var e=this.getLastUnclosedPath();return e?e.points[e.points.length-1]:null},r.prototype.getLastUnclosedPath=function(){var t,n;return this.doc.cascadeSelected(C.Doc.Curve,function(e){return t=e}),t&&t.paths.forEach(function(e){e.isClosed||(n=e)}),n||null},r.prototype.refreshMarkers=function(){this.createMarkers()},r.selectionMinDistance=8,r);function r(e,t){var d=this;n.call(this,e,t),this.selectedPoints=new xp.ObservableCollection([],!1),this.selectedPaths=new xp.ObservableCollection([],!1),this.selectedCurves=new xp.ObservableCollection([],!1),this.actions={deletePoints:function(){var o,e;0!==d.selectedPoints.length?(e=d.getAffectedCurves(),o=[],e.forEach(function(t){var e=d.pointMarkers.filter(function(e){return e.curve===t&&e.marker.selected}).length,n=0;t.paths.forEach(function(e){return n+=e.points.length}),e===n&&o.push(t)}),e=e.filter(function(e){return o.indexOf(e)<0}),d.app.memento.isLocked||d.app.memento.perform({delete:0<o.length?o:null,modify:0<e.length?e:null,action:function(){return d.execSelPoints(function(e,t,n,o){e.actions.curve.deletePoint(t,n,o)},"recreate"),null}})):d.app.message.warn("There must be at least one point selected.")},openPath:function(){var e,t;1===d.selectedPoints.length?(e=d.getAffectedPaths()[0],t=d.selectedPoints[0],d.app.memento.isLocked||d.app.memento.perform({modify:[e.curve],action:function(){return d.doc.actions.curve.openPath(e,t),e.updateSegments(),e.curve.updateSvgPath(),d.createMarkers(),null}})):d.app.message.warn("There must be one point selected.")},closePath:function(){var e;1===d.selectedPaths.length?(e=d.selectedPaths[0],d.app.memento.isLocked||d.app.memento.perform({modify:[e.curve],action:function(){return d.doc.actions.curve.closePath(e),e.updateSegments(),e.curve.updateSvgPath(),d.createMarkers(),null}})):d.app.message.warn("There must be one path selected.")},reversePath:function(){var e;1===d.selectedPaths.length?(e=d.selectedPaths[0],d.app.memento.isLocked||d.app.memento.perform({modify:[e.curve],action:function(){return d.doc.actions.curve.reversePath(e),e.updateSegments(),e.curve.updateSvgPath(),d.createMarkers(),null}})):d.app.message.warn("There must be one path selected.")},joinCurves:function(){var t=d.selectedCurves;t.length<2?d.app.message.warn("There must be at least two curves selected."):d.app.memento.isLocked||d.app.memento.perform({delete:t,action:function(){var e=d.doc.actions.curve.joinCurves(t);return e.paths.forEach(function(e){return e.updateSegments()}),e.updateSvgPath(),d.createMarkers(),{created:[e]}}})},splitCurves:function(){var e=d.selectedCurves;0!==e.length?d.app.memento.isLocked||d.app.memento.perform({delete:e,action:function(){return d.doc.actions.curve.splitCurves(e),d.doc.cascadeSelected(C.Doc.Curve,function(e){e.paths.forEach(function(e){return e.updateSegments()}),e.updateSvgPath()}),d.createMarkers(),{created:d.doc.selectedElements}}}):d.app.message.warn("There must be at least one curve selected.")},removeSelfIntersections:function(){var e=d.selectedCurves;e.length<1?d.app.message.warn("There must be at least one curve selected."):e.every(function(e){return e.isClosed})?d.app.memento.isLocked||d.app.memento.perform({modify:e,action:function(){return e.forEach(function(e){C.BooleanOperations.removeSelfIntersections(e),e.updateSvgPath()}),d.createMarkers(),null}}):d.app.message.warn("All selected curves must be closed.")},uniteCurves:function(){var t=d.selectedCurves;t.length<1?d.app.message.warn("There must be at least one curve selected."):t.every(function(e){return e.isClosed})?d.app.memento.isLocked||(1===t.length?d.actions.removeSelfIntersections():d.app.memento.perform({delete:t,action:function(){var e=d.doc.actions.curve.unite(t);return e.paths.forEach(function(e){return e.updateSegments()}),e.updateSvgPath(),d.createMarkers(),{created:[e]}}})):d.app.message.warn("All selected curves must be closed.")},intersectCurves:function(){var t=d.selectedCurves;t.length<2?d.app.message.warn("There must be at least two curves selected."):t.every(function(e){return e.isClosed})?d.app.memento.isLocked||d.app.memento.perform({delete:t,action:function(){var e=d.doc.actions.curve.intersect(t);return e&&(e.paths.forEach(function(e){return e.updateSegments()}),e.updateSvgPath()),d.createMarkers(),e?{created:[e]}:null}}):d.app.message.warn("All selected curves must be closed.")},frontMinusBack:function(){var t=d.selectedCurves;t.length<2?d.app.message.warn("There must be at least two curves selected."):t.every(function(e){return e.isClosed})?d.app.memento.isLocked||d.app.memento.perform({delete:t,action:function(){var e=d.doc.actions.curve.frontMinusBack(t);return e&&(e.paths.forEach(function(e){return e.updateSegments()}),e.updateSvgPath()),d.createMarkers(),e?{created:[e]}:null}}):d.app.message.warn("All selected curves must be closed.")},backMinusFront:function(){var t=d.selectedCurves;t.length<2?d.app.message.warn("There must be at least two curves selected."):t.every(function(e){return e.isClosed})?d.app.memento.isLocked||d.app.memento.perform({delete:t,action:function(){var e=d.doc.actions.curve.backMinusFront(t);return e&&(e.paths.forEach(function(e){return e.updateSegments()}),e.updateSvgPath()),d.createMarkers(),e?{created:[e]}:null}}):d.app.message.warn("All selected curves must be closed.")},strokeToPath:function(){var e=d.selectedCurves;e.length<1?d.app.message.warn("There must be at least one curve selected."):d.app.memento.isLocked||d.app.memento.perform({modify:e,action:function(){return d.doc.cascadeSelected(C.Doc.Curve,function(e){e.strokeToPath()}),d.createMarkers(),null}})},simplify:function(){var e=d.selectedCurves;e.length<1?d.app.message.warn("There must be at least one curve selected."):d.app.memento.isLocked||d.app.memento.perform({modify:e,action:function(){return d.doc.cascadeSelected(C.Doc.Curve,function(e){e.paths.forEach(function(e){e.simplify(),e.updateSegments()}),e.updateSvgPath()}),d.createMarkers(),null}})},alignPoints:function(){if(d.selectedPoints.length<2)d.app.message.warn("There must be at least two points selected.");else if(d.app.settings.snap.anglesDeg.length<1)d.app.message.warn("There must be at least one angle to snap to. Set it at Ruler Tool panel.");else if(!d.app.memento.isLocked){for(var o=d.selectedPoints.slice(0),e=[],t=[],n=1;n<o.length;n++)e.push(Geo.getAngle(o[0],o[n])),t.push(Geo.getLength(o[0],o[n]));for(var r=e[0],i=t[0],n=1;n<e.length;n++)r=Geo.getMidAngle(r,e[n],Math.max(i,t[n])/(i+t[n])),i+=(t[n]-i)*Math.max(i,t[n])/(i+t[n]);90<(r=Geo.deg(r))&&r<=270?r-=180:270<r&&(r-=360);for(var s,a=360,n=0;n<d.app.settings.snap.anglesDeg.length;n++){var l=Math.abs(r-d.app.settings.snap.anglesDeg[n]);90<l&&(l=180-l),l<a&&(a=l,s=d.app.settings.snap.anglesDeg[n])}s=Geo.rad(s);for(var c=[0],p=[o[0]],n=1;n<o.length;n++){var h=Geo.getLinesIntersection(o[0],Geo.placePoint(o[0],1,s),o[n],Geo.placePoint(o[n],1,s+Math.PI/2),!0);c.push(Geo.getLength(o[n],h)),p.push(h)}d.app.memento.isLocked||d.app.memento.perform({modify:d.getAffectedCurves(),action:function(){for(var e=d.getAffectedPaths(),t=0;t<o.length;t++){var n=e.filter(function(e){return 0<=e.points.indexOf(o[t])})[0];d.doc.actions.curve.movePoint(n,o[t],p[t].x,p[t].y)}return e.forEach(function(e){return e.updateSegments()}),d.getAffectedCurves().forEach(function(e){return e.updateSvgPath()}),d.updateMarkers(),null}})}},duplicatePoints:function(){var l=new xp.Dictionary;d.pointMarkers.forEach(function(e){var t;e.marker.selected&&((t=l.get(e.path))||(t=[],l.set(e.path,t)),t.push(e.p))}),l.pairs.slice(0).forEach(function(e){(e.key.isClosed&&e.value.length<3||!e.key.isClosed&&e.value.length<2)&&l.set(e.key,void 0)}),0!==l.pairs.length?(l.pairs.forEach(function(n){n.value.sort(function(e,t){e=n.key.points.indexOf(e),t=n.key.points.indexOf(t);return t<e?1:e<t?-1:0})}),d.app.memento.isLocked||d.app.memento.perform({action:function(){for(var e=d.doc.actions.curve.create(l.pairs[0].value[0].x,l.pairs[0].value[0].y,l.pairs[0].value[0].type),t=0;t<l.pairs.length;t++){var n,o=l.pairs[t].key,r=l.pairs[t].value;0===t?n=e.paths[0]:(n=new C.Doc.Path,e.paths.push(n));for(var i=0;i<r.length;i++)0===t&&0===i||(n.addPoint(r[i].x,r[i].y,r[i].type),0<i&&n.convertSegment(n.segments[n.segments.length-1],o.segmentBefore(r[i]).type));o.isClosed&&(n.close(),n.convertSegment(n.segments[n.segments.length-1],o.segmentBefore(r[0]).type))}var s,a=l.pairs[0].key.curve;for(s in a.fill)e.fill[s]=a.fill[s];for(s in a.stroke)e.stroke[s]=a.stroke[s];return e.paths.forEach(function(e){return e.updateSegments()}),e.updateSvgPath(),d.createMarkers(),{created:[e]}}})):d.app.message.warn("There must be at least 3 points selected for closed path or 2 for open path.")},symmertify:function(){var e,y,s,n,t,o,r=d.doc.getSelectedElements(C.Doc.Curve);0!==r.length?r.every(function(e){return e.isClosed})?d.app.memento.isLocked||(e=C.Doc.getDrawingsBBox(r),y=e.left+e.width/2,s=[],r.forEach(function(e){var t={curve:e,pathsInters:[]};s.push(t);for(var n=0;n<e.paths.length;n++){var o=e.paths[n],r=[],i={path:o,segInters:r};t.pathsInters.push(i),o.segments.forEach(function(t){var e=Math.min.apply(null,t.points.map(function(e){return e.y})),n=Math.max.apply(null,t.points.map(function(e){return e.y})),o={x:y,y:e},e={x:y,y:n};2===t.points.length?(n=Geo.getLinesIntersection(t.points[0],t.points[1],o,e))&&r.push({pt:n,seg:t,a:Geo.getAngle(t.points[0],t.points[1])}):Geo.Bezier.getBezier3LineIntersections(t.points,[o,e],.001).forEach(function(e){e.pt.x!==t.points[t.points.length-1].x&&r.push({pt:e.pt,seg:t,a:e.a})})})}}),n=[],s.forEach(function(t){t.pathsInters.forEach(function(e){0===e.segInters.length&&Math.max.apply(null,e.path.points.map(function(e){return e.x}))>y&&((e=n.filter(function(e){return e.curve===t.curve})[0])||(e={curve:t.curve,deletedPathsCount:0},n.push(e)),e.deletedPathsCount++)})}),t=n.filter(function(e){return e.curve.paths.length===e.deletedPathsCount}).map(function(e){return e.curve}),o=r.filter(function(e){return t.indexOf(e)<0}),d.app.memento.perform({modify:o,delete:0<t.length?t:null,action:function(){return t.forEach(function(e){return d.doc.actions.remove.removeElement(e)}),(s=s.filter(function(e){return 0<=o.indexOf(e.curve)})).forEach(function(v){v.pathsInters.forEach(function(e){if(0===e.segInters.length)if(Math.max.apply(null,e.path.points.map(function(e){return e.x}))>y)v.curve.paths.splice(v.curve.paths.indexOf(e.path),1);else{for(var t=xp.clone(e.path),n=0;n<e.path.points.length;n++)t.movePoint(t.points[n],2*y-e.path.points[n].x,e.path.points[n].y);t.reverse(),v.curve.paths.splice(v.curve.paths.indexOf(e.path)+1,0,t)}else{var o=e.path,r=Math.PI/6,i=e.segInters.filter(function(e){return e.a>=Math.PI/2&&e.a<3*Math.PI/2}),s=e.segInters.filter(function(e){return i.indexOf(e)<0});if(i.length!==s.length)throw new Error("In and out symmetry winding mismatch.");for(var a=[];0<i.length;){var l=i.shift(),c=new C.Doc.Path;c.points.push({x:l.pt.x,y:l.pt.y,type:l.a>Math.PI-r/2&&l.a<Math.PI+r/2?C.Doc.PointType.Smooth:C.Doc.PointType.Cusp}),c.segments.push({type:l.seg.type});var p=l.seg,h=s.filter(function(e){return e.seg===p})[0];h&&p.type===C.Doc.SegmentType.Curve&&(f=Geo.Bezier.bezier3Pt(.5,p.points),c.points.push({x:f.x,y:f.y,type:C.Doc.PointType.Smooth}),c.segments.push({type:C.Doc.SegmentType.Curve}));for(var d=0;!(h=s.filter(function(e){return e.seg===p})[0]);){if(p=o.segmentAfter(p),p===l.seg&&1<++d)throw new Error("Looped while trying to find symmetry ending.");c.segments.push({type:p.type});var u=o.pointBefore(p);c.points.push({x:u.x,y:u.y,type:u.type})}s.splice(s.indexOf(h),1);var f=Geo.ca2(h.a);c.points.push({x:h.pt.x,y:h.pt.y,type:-r/2<f&&f<r/2?C.Doc.PointType.Smooth:C.Doc.PointType.Cusp});var m=xp.clone(c);m.points.forEach(function(e){return m.movePoint(e,2*y-e.x,e.y)}),m.reverse(),Array.prototype.push.apply(c.points,m.points.slice(1,m.points.length-1)),Array.prototype.push.apply(c.segments,m.segments.slice(0)),c.isClosed=!0,a.push(c)}var g=v.curve.paths.indexOf(o);v.curve.paths.splice(g,1),a.forEach(function(e,t){v.curve.paths.splice(g+t,0,e)})}v.curve.paths.forEach(function(e){return e.updateSegments()}),v.curve.updateSvgPath()})}),d.createMarkers(),null}})):d.app.message.warn("Selected curves must be closed."):d.app.message.warn("There must be at least 1 curve selected.")}},this.pointMarkers=[],this.segmentMarkers=[];e=k.Markers.SegmentMarker.createMidMarker();t.levels.defs.appendChild(e)}k.PathTool=e;var i,t=(i=C.UI.ToolPanel,__extends(o,i),o.prototype.onMoreClick=function(e){e=e.element.domElement.getBoundingClientRect();xp.ContextMenu.show(e.left,e.bottom,[{text:"Nothing added yet :)",action:function(){}}])},o.prototype.onCombineClick=function(e){var t=this,n=e.element.domElement.getBoundingClientRect(),e=this.app.document.getSelectedElements(C.Doc.Curve).length<2;xp.ContextMenu.show(n.left,n.bottom,[{text:"Union",icon:C.UI.Icons.pathTool.union,action:function(){return t.tool.actions.uniteCurves()},disabled:e},{text:"Intersection",icon:C.UI.Icons.pathTool.intersection,action:function(){return t.tool.actions.intersectCurves()},disabled:e},{text:"Front minus back",icon:C.UI.Icons.pathTool.frontMBack,action:function(){return t.tool.actions.frontMinusBack()},disabled:e},{text:"Back minus front",icon:C.UI.Icons.pathTool.backMFront,action:function(){return t.tool.actions.backMinusFront()},disabled:e}])},o);function o(e,t,n){var o=this;i.call(this,n,[new xp.HBox({},[new xp.Button({text:"Delete\npoints",icon:C.UI.Icons.delete,enabled:"({selectedPoints.length} > 0)",onClick:function(){return o.tool.actions.deletePoints()},style:"multilineButton"}),new xp.Button({key:"advanced",text:"Align\npoints",icon:C.UI.Icons.pathTool.align,enabled:"({selectedPoints.length} > 1)",onClick:function(){1<o.tool.selectedPoints.length&&o.tool.actions.alignPoints()},style:"multilineButton"}),new xp.Button({key:"advanced",text:"Distort\npoints",icon:C.UI.Icons.pathTool.distort,enabled:"({selectedPoints.length} > 1)",onClick:function(){1<o.tool.selectedPoints.length&&o.tool.startDistort()},style:"multilineButton"}),new xp.Button({key:"advanced",text:"Duplicate\npoints",icon:C.UI.Icons.copy,enabled:"({selectedPoints.length} > 2)",onClick:function(){o.tool.actions.duplicatePoints()},style:"multilineButton"})]),new xp.HBox({},[new xp.Button({text:"Open\npath",icon:C.UI.Icons.pathTool.open,enabled:"({selectedPoints.length} === 1 && {selectedPaths[0].isClosed} === true)",onClick:function(){return o.tool.actions.openPath()},style:"multilineButton"}),new xp.Button({text:"Reverse\npath",icon:C.UI.Icons.pathTool.reverse,enabled:"({selectedPaths.length} === 1)",onClick:function(){return o.tool.actions.reversePath()},style:"multilineButton"}),new xp.Button({text:"Join\npaths",icon:C.UI.Icons.pathTool.join,enabled:"({selectedCurves.length} > 1)",onClick:function(){return o.tool.actions.joinCurves()},style:"multilineButton"}),new xp.Button({text:"Split\npaths",icon:C.UI.Icons.pathTool.split,enabled:"({selectedCurves.length} === 1 && {selectedCurves[0].paths.length} > 1)",onClick:function(){return o.tool.actions.splitCurves()},style:"multilineButton"})]),new xp.HBox({},[new xp.Button({key:"advanced",text:"Union",icon:C.UI.Icons.pathTool.union,enabled:"({selectedCurves.length} > 0)",onClick:function(){return o.tool.actions.uniteCurves()},style:"multilineButton"}),new xp.Button({key:"advanced",text:"Inter-\nsection",icon:C.UI.Icons.pathTool.intersection,enabled:"({selectedCurves.length} > 1)",onClick:function(){return o.tool.actions.intersectCurves()},style:"multilineButton"}),new xp.Button({key:"advanced",text:"Front\n- back",icon:C.UI.Icons.pathTool.frontMBack,enabled:"({selectedCurves.length} > 1)",onClick:function(){return o.tool.actions.frontMinusBack()},style:"multilineButton"}),new xp.Button({key:"advanced",text:"Back -\nfront",icon:C.UI.Icons.pathTool.backMFront,enabled:"({selectedCurves.length} > 1)",onClick:function(){return o.tool.actions.backMinusFront()},style:"multilineButton"})]),new xp.HBox({},[new xp.Button({key:"advanced",text:"Stroke\nto path",icon:C.UI.Icons.pathTool.strokeToPath,enabled:"({selectedCurves.length} === 1 && {selectedCurves[0].hasStroke})",onClick:function(){return o.tool.actions.strokeToPath()},style:"multilineButton"})])]),this.app=e,this.tool=t,this.useParentScope=!1,this.scope=t}}(C.Tools||(C.Tools={}))}(Inker=Inker||{}),function(l){!function(e){var t,n=(t=e.Tool,__extends(o,t),o.prototype.getName=function(){return"Ruler"},o.prototype.getIcon=function(){return l.UI.Icons.tools.ruler},o.prototype.createToolPanel=function(){this.toolPanel=new i(this.app,this)},o.prototype.getCursor=function(){return"url(style/img/cursor_rulerTool.png) 1 1, default"},o.prototype.getHotkeys=function(){var e=this;return[{hotkey:"DELETE",action:function(){return e.actions.deleteSelected()}},{hotkey:"SHIFT+D",action:function(){return e.actions.duplicateSelected()}}]},o.prototype.getHelpMessage=function(){return null},o.prototype.supportsRulerMode=function(){return!1},o.prototype.createStyleNode=function(){var e=document.createElement("style");e.setAttribute("id","RulerToolStyle"),e.innerHTML='[data-type="Ruler"] { cursor: move; pointer-events: visible; } [data-type="Ruler"]:hover .sens { stroke: hsla(0, 0%, 0%, 0.05) }',document.head.appendChild(e),this.styleNode=e},o.prototype.removeStyleNode=function(){document.head.removeChild(this.styleNode)},o.prototype.defineProperties=function(){var e=this;xp.Model.property(this,"selectedRulers",new xp.ObservableCollection([],!1)),xp.Model.property(this,"currentRuler"),new xp.BindingCallManager(app,"document.rulers",function(){return e.deselectAllRulers()})},o.prototype.onEnabled=function(){var r=this;this.deselectAllRulers(),this.registrar.subscribe(this.canvas.onPointerDown,function(e){for(var t=r.canvas.rulers,n=r.app.settings.snap.distance,o=t.length-1;0<=o;o--)if(t[o].getDistance(e.elementX,e.elementY)<=n)return void r.onRulerMDown(t[o],e);r.startCreating(e.elementX,e.elementY)},this),this.createStyleNode()},o.prototype.onDisabled=function(){t.prototype.onDisabled.call(this),this.deselectAllRulers(),this.selectedRulers.splice(0),this.removeStyleNode()},o.prototype.onDocumentChanged=function(){this.selectedRulers.splice(0)},o.prototype.selectRuler=function(t){var e;0===this.selectedRulers.filter(function(e){return e.model===t}).length&&(e=this.canvas.rulers.filter(function(e){return e.model===t})[0],this.selectedRulers.push(e),e.isActive=!0,this.currentRuler=e.model)},o.prototype.deselectRuler=function(t){var e=this.selectedRulers.filter(function(e){return e.model===t})[0];e&&(e=this.canvas.rulers.filter(function(e){return e.model===t})[0],this.selectedRulers.splice(this.selectedRulers.indexOf(e),1),e.isActive=!1),0<this.selectedRulers.length?this.currentRuler=this.selectedRulers[this.selectedRulers.length-1].model:this.currentRuler=null},o.prototype.deselectAllRulers=function(){this.selectedRulers.forEach(function(e){return e.isActive=!1}),this.selectedRulers.splice(0),this.currentRuler=null},o.prototype.startCreating=function(e,t){var n,i,s,a=this;this.app.settings.snap.visible?this.app.memento.isLocked||(n=this.app.memento.beforeAction({props:["rulers"]}),i=new l.Doc.Ruler,s=this.canvas.getSnappedCoords(e,t),i.x=this.canvas.translateXIn(s.x),i.y=this.canvas.translateYIn(s.y),this.doc.rulers.push(i),this.deselectAllRulers(),this.selectRuler(i),this.performDrag({cursor:"move",move:function(e,t,n){var o=a.canvas.getSnappedCoords(e,t),r=Geo.getAngle(s,o);o.x===e&&o.y===t&&(t=Geo.deg(r),r=Geo.rad(t+2.5-(t+2.5)%5)),i.a=r},cancel:function(){a.doc.rulers.splice(a.doc.rulers.length-1,1),n.cancelWithNoChanges()},end:function(){n.afterAction()}})):this.app.message.warn('Press "Display rulers" check box to make rulers visible.')},o.prototype.onRulerMDown=function(e,t){var i,s,a,l,c,p,h,n,d=this;t.domEvent.ctrlKey||t.domEvent.metaKey||t.domEvent.shiftKey?0<=this.selectedRulers.indexOf(e)?this.deselectRuler(e.model):this.selectRuler(e.model):(this.selectedRulers.indexOf(e)<0&&(this.deselectAllRulers(),this.selectRuler(e.model)),0<this.selectedRulers.length&&(i=t.elementX,s=t.elementY,a=this.selectedRulers.map(function(e){return{x:e.model.x,y:e.model.y}}),l=Math.min.apply(Math,a.map(function(e){return d.canvas.translateXOut(e.x)})),c=Math.max.apply(Math,a.map(function(e){return d.canvas.translateXOut(e.x)})),p=Math.min.apply(Math,a.map(function(e){return d.canvas.translateYOut(e.y)})),h=Math.max.apply(Math,a.map(function(e){return d.canvas.translateYOut(e.y)})),this.app.memento.isLocked||(n=this.app.memento.beforeAction({props:["rulers"]}),this.performDrag({cursor:"move",move:function(o,r){var n=[[l,p],[c,p],[c,h],[p,h]].map(function(e){var t=e[0],n=e[1],e={x:t,y:n},t={x:t+o-i,y:n+r-s},n=d.canvas.getSnappedCoords(t.x,t.y);return{init:e,pos:t,snap:n,dist:Geo.getLength(t,n)}}).sort(function(e,t){return e.dist-t.dist})[0];d.selectedRulers.forEach(function(e,t){e.model.x=a[t].x+d.canvas.translateSizeIn(n.snap.x-n.init.x),e.model.y=a[t].y+d.canvas.translateSizeIn(n.snap.y-n.init.y)})},cancel:function(){d.selectedRulers.forEach(function(e,t){e.model.x=a[t].x,e.model.y=a[t].y}),n.cancelWithNoChanges()},end:function(){n.afterAction()}}))))},o);function o(){var o=this;t.apply(this,arguments),this.actions={deleteSelected:function(){o.app.memento.isLocked||o.app.memento.perform({props:["rulers"],action:function(){for(var e=o.selectedRulers.length-1;0<=e;e--)o.app.document.rulers.splice(o.app.document.rulers.indexOf(o.selectedRulers[e].model),1);return o.selectedRulers.splice(0),null}})},duplicateSelected:function(){o.app.memento.isLocked||o.app.memento.perform({props:["rulers"],action:function(){var n=o.selectedRulers.map(function(e){return e.model});return o.deselectAllRulers(),n.forEach(function(e){var t=new l.Doc.Ruler;t.a=e.a;e=Geo.placePoint({x:e.x,y:e.y},16,n[0].a+Math.PI/2*(0<=Math.cos(n[0].a)?1:-1));t.x=e.x,t.y=e.y,o.app.document.rulers.push(t),o.selectRuler(t)}),null}})}}}e.RulerTool=n;var r,i=(r=l.UI.ToolPanel,__extends(s,r),s.prototype.onDeleteClick=function(){this.tool.actions.deleteSelected()},s.prototype.onDuplicateClick=function(){this.tool.actions.duplicateSelected()},s);function s(e,t,n){var i=this;r.call(this,n,[new xp.Button({text:"Delete",icon:l.UI.Icons.delete,enabled:"({selectedRulers.length} > 0)",onClick:function(){return i.onDeleteClick()}}),new xp.Button({text:"Duplicate",icon:l.UI.Icons.copy,enabled:"({selectedRulers.length} > 0)",onClick:function(){return i.onDuplicateClick()}}),new xp.HBox({margin:"0 0.5em"},[new xp.Label({text:"angle:",margin:"0 0.25em 0 0",style:"inputLabel"}),new xp.TextBox({type:"number",name:"textBox_angle",width:"3em"})]),new xp.CheckBox({text:"Snap to rulers",margin:"0 0.5em",checked:"{app.settings.snap.on}"}),new xp.HBox({},[new xp.Label({text:"snap distance:",margin:"0 0.25em 0 0.5em",style:"inputLabel"}),new xp.TextBox({text:"{app.settings.snap.distance}",type:"number",min:0,width:"3em"})]),new xp.HBox({margin:"0 0 0 0.5em"},[new xp.Label({text:"snap to angles:",margin:"0 0.25em 0 0.5em",style:"inputLabel"}),new xp.TextBox({name:"textBox_snapToAngles",width:"8em"})]),new xp.CheckBox({text:"Snap to pixels",margin:"0 0.5em",checked:"{app.settings.snap.pixels}"})]),this.app=e,this.tool=t,this.useParentScope=!1,this.scope=t;new xp.BindingCallManager(this.scope,"currentRuler.a",function(e){isNaN(e)?i.textBox_angle.value="":i.textBox_angle.value=Geo.deg(e)});this.textBox_angle.onTextChange.addHandler(function(e){var t;isNaN(i.textBox_angle.text)||(t=Geo.rad(parseFloat(i.textBox_angle.text)),i.tool.selectedRulers.forEach(function(e){return e.model.a=t}))},this);new xp.BindingCallManager(this.scope,"app.settings.snap.anglesDeg",function(e){return void 0===e&&(e=[]),i.textBox_snapToAngles.text=e.join(" ")});this.textBox_snapToAngles.onTextChange.addHandler(function(e){for(var t=e.newText.trim().split(" ").map(function(e){return parseFloat(e)}).filter(function(e){return!isNaN(e)}),n=0;n<t.length;n++){var o=Geo.deg(Geo.ca(Geo.rad(t[n])));90<o&&o<=270?o-=180:270<o&&(o-=360),o=Math.round(1e3*o)/1e3,t[n]=o}if(0===t.length)return[0,90];for(var r=[],n=0;n<t.length;n++)r.indexOf(t[n])<0&&r.push(t[n]);r.sort(function(e,t){return t<e?1:e<t?-1:0}),i.app.settings.snap.anglesDeg=r})}}(l.Tools||(l.Tools={}))}(Inker=Inker||{}),function(m){!function(r){var t,e=(t=r.Tool,__extends(n,t),n.prototype.getName=function(){return"Select"},n.prototype.getIcon=function(){return m.UI.Icons.tools.select},n.prototype.createToolPanel=function(){this.toolPanel=new o(this.app,this)},n.prototype.getCursor=function(){return"url(style/img/cursor_selectTool.png) 1 1, default"},n.prototype.createStyleNode=function(){var e=document.createElement("style");e.setAttribute("id","SelectToolStyle"),e.innerHTML='[data-type="Document"] * { cursor: move; }',document.head.appendChild(e),this.styleNode=e},n.prototype.removeStyleNode=function(){document.head.removeChild(this.styleNode)},n.prototype.getHelpMessage=function(){return null},n.prototype.supportsRulerMode=function(){return!0},n.prototype.onEnabled=function(){var i=this;this.registrar.subscribe(this.canvas.onPointerDown,function(e){i.canvas.isBackgroundElement(e.domEvent.target)?i.onCanvasMDown(e):console.log("canvas: down but not a target")},this),this.registrar.subscribe(this.canvas.onShapeMouseDown,function(e){i.onShapeMDown(e),e.domEvent.stopPropagation()},this),this.registrar.subscribe(this.canvas.onShapeDoubleClick,function(e){e.domEvent.stopPropagation();var t=e.targetShape.model;i.doc.layers[i.doc.getIndexPath(t)[0]].locked||requestAnimationFrame(function(){t instanceof m.Doc.Curve?i.app.currentTool=i.app.getTool(r.PathTool):t instanceof m.Doc.Text&&(i.app.currentTool=i.app.getTool(r.TextTool))})},this),this.registrar.subscribe(this.canvas.onShapeContextMenu,function(e){i.onShapeContextMenu(e),e.domEvent.stopPropagation()},this),this.registrar.subscribe(this.canvas.onContextMenu,function(e){i.onCanvasContextMenu(e),e.domEvent.stopPropagation()},this),this.registrar.subscribe(this.canvas.onViewportChanged,function(e){i.createMarkers()},this);var s;this.registrar.subscribe(this.app.window.onKeyDown,function(e){var t,n,o,r;37<=e.domEvent.keyCode&&e.domEvent.keyCode<=40&&(0<(t=i.doc.getSelectedElements(m.Doc.Drawing)).length&&(i.app.memento.isLocked||(s=s||i.app.memento.beforeAction({modify:t}),n=i.canvas.translateSizeIn(2),o=37===e.domEvent.keyCode?-n:39===e.domEvent.keyCode?n:0,r=38===e.domEvent.keyCode?-n:40===e.domEvent.keyCode?n:0,t.forEach(function(e){var t=e.getBBox();e.move(t.left+o,t.top+r)}),i.removeMarkers())))},this),this.registrar.subscribe(this.app.window.onKeyUp,function(e){37<=e.domEvent.keyCode&&e.domEvent.keyCode<=40&&(i.createMarkers(),s&&(s.afterAction(),s=null))},this),this.doc&&this.createMarkers(),this.createStyleNode()},n.prototype.onDocumentChanged=function(){this.createMarkers()},n.prototype.onSelectionChanged=function(){this.createMarkers()},n.prototype.onDisabled=function(){this.registrar.unsubscribeAll(),this.showMarkers(),this.removeMarkers(),this.removeStyleNode()},n.prototype.createMarkers=function(){this.createHighlights(),this.createScaleBox(),this.createGradientMarkers()},n.prototype.removeMarkers=function(){this.removeHighlights(),this.removeScaleBox(),this.removeGradientMarkers()},n.prototype.hideMarkers=function(){this.canvas.levels.markers.setAttribute("visibility","hidden")},n.prototype.showMarkers=function(){this.canvas.levels.markers.removeAttribute("visibility")},n.prototype.refreshMarkers=function(){this.createMarkers()},n.prototype.onShapeMDown=function(e){var u=this,n=this.app.document.selectedElements.slice(0),o=e.elementX,r=e.elementY;this.rulerModeEnabled&&this.canvas.createTempRulers(this.canvas.translateXIn(o),this.canvas.translateYIn(r));var i,t,s,a,l,c,p,h=this.app.document.getIndexPath(e.targetShape.model);this.doc.layers[h[0]].locked||(i=this.app.document.layers[h[0]].children[h[1]],t=function(){u.doc.selectedElements.indexOf(i)<0?u.doc.actions.select.selectElement(i):u.doc.actions.select.deselectElement(i)},s=function(){var l,c,p,h,t,d;u.doc.selectedElements.indexOf(i)<0&&(u.doc.actions.select.deselectAll(),u.doc.actions.select.selectElement(i)),(1===e.domEvent.which||e.domEvent instanceof TouchEvent)&&(l=e.elementX,c=e.elementY,t=!(h=p=0),u.app.memento.isLocked||u.performDrag({cursor:"move",move:function(n,o){t&&(d=u.app.memento.beforeAction({modify:u.doc.getSelectedElements(m.Doc.Drawing)}),u.removeMarkers(),t=!1);var e=u.canvas.translateBoxOut(u.doc.getSelectedBBox()),r=[{x:e.left,y:e.top},{x:e.left+e.width,y:e.top},{x:e.left+e.width,y:e.top+e.height},{x:e.left,y:e.top+e.height}].map(function(e){return{x:e.x-p+n-l,y:e.y-h+o-c}}),i=r.map(function(e){return u.canvas.getSnappedCoords(e.x,e.y)}),e=[0].sort(function(e,t){return Geo.getLength(r[e],i[e])-Geo.getLength(r[t],i[t])})[0],s=i[e].x-r[e].x,a=i[e].y-r[e].y;u.doc.getSelectedElements(m.Doc.Drawing).forEach(function(e){var t=e.getBBox();e.move(t.left+u.canvas.translateSizeIn(s-p+n-l),t.top+u.canvas.translateSizeIn(a-h+o-c))}),l=n,c=o,p=s,h=a},cancel:function(){u.doc.getSelectedElements(m.Doc.Drawing).forEach(function(e){var t=e.getBBox();e.move(t.left+u.canvas.translateSizeIn(o-l-p),t.top+u.canvas.translateSizeIn(r-c-h))}),d&&d.cancelWithNoChanges(),app.document.selectedElements.splice.apply(app.document.selectedElements,[0,app.document.selectedElements.length].concat(n)),u.canvas.afterSnap(),u.createMarkers(),u.canvas.removeTempRulers()},end:function(){u.createMarkers(),u.canvas.afterSnap(),u.canvas.removeTempRulers(),d&&d.afterAction()}}))},e.domEvent instanceof TouchEvent?(this.isShapeTouched=!0,a=function(){console.log("select touch move"),s(),p()},l=function(){console.log("select touch end"),u.doc.selectedElements.indexOf(i)<0&&(u.doc.actions.select.deselectAll(),u.doc.actions.select.selectElement(i)),p()},c=function(e){console.log("select context menu"),e.preventDefault(),t(),p()},p=function(){e.targetShape.element.removeEventListener("touchmove",a),e.targetShape.element.removeEventListener("touchend",l),e.targetShape.element.removeEventListener("contextmenu",c),u.isShapeTouched=!0},e.targetShape.element.addEventListener("touchmove",a),e.targetShape.element.addEventListener("touchend",l),e.targetShape.element.addEventListener("contextmenu",c)):this.isShapeTouched||(e.domEvent.ctrlKey||e.domEvent.metaKey?t:s)())},n.prototype.onCanvasMDown=function(l){var c=this;console.log("canvas: down");var n,e=this.app.document.selectedElements.slice(0);l.domEvent.ctrlKey||l.domEvent.metaKey||l.domEvent.shiftKey||l.domEvent.altKey||this.doc.actions.select.deselectAll(),this.performDrag({move:function(e,t){(n=n||new r.Markers.SelectBox(c.canvas.levels.markers,{x:e,y:t},{x:e,y:t})).end={x:e,y:t}},cancel:function(){n&&n.remove(),e.forEach(function(e){c.app.document.actions.select.selectElement(e)})},end:function(){var a;n&&(a=c.canvas.translateBoxIn(n.bBox),c.doc.layers.forEach(function(e){e.hidden||e.locked||e.children.forEach(function(e){var t;if(e instanceof m.Doc.Drawing)t=e.getBBox();else if(e instanceof m.Doc.Group){var n,o,r,i,s=!0;if(m.Doc.cascadeElements(e.children,function(e){e instanceof m.Doc.Drawing&&(t=e.getBBox(),(s||t.left<n)&&(n=t.left),(s||t.top<o)&&(o=t.top),(s||t.left+t.width>r)&&(r=t.left+t.width),(s||t.top+t.top>i)&&(i=t.top+t.height),s=s&&!1)}),s)return;t={left:n,top:o,width:r-n,height:i-o}}t.left>=a.left&&t.top>=a.top&&t.left+t.width<=a.left+a.width&&t.top+t.height<=a.top+a.height&&(l.domEvent.altKey?c.doc.actions.select.deselectElement(e):c.doc.actions.select.selectElement(e))})}),n.remove())}})},n.prototype.createHighlights=function(){var t,n=this;this.removeHighlights(),this.doc&&(t=document.createDocumentFragment(),this.doc.cascadeSelected(m.Doc.Drawing,function(e){e=r.Markers.createHighlight(t,e,n.canvas);n.highlights.push(e)}),this.canvas.levels.markers.appendChild(t))},n.prototype.removeHighlights=function(){this.highlights&&this.highlights.forEach(function(e){return m.Svg.remove(e)}),this.highlights=[]},n.prototype.onScaleMarkerMDown=function(r,e,t){var a=this;console.log("scale: down. "+e+", "+t);function l(e,t){var n={},o=a.canvas.getSnappedCoords(e,t);return r.scaleVector.x<0?(n.left=o.x,n.width=h.left+h.width-o.x):0<r.scaleVector.x?(n.left=h.left,n.width=o.x-h.left):(n.left=h.left,n.width=h.width),r.scaleVector.y<0?(n.top=o.y,n.height=h.top+h.height-o.y):0<r.scaleVector.y?(n.top=h.top,n.height=o.y-h.top):(n.top=h.top,n.height=h.height),i&&0!==h.width&&0!==h.height&&(h.width,h.height,o=(e=n.width/h.width)<(t=n.height/h.height)?e:t,e=t<e?t:e,n.width=h.width*o,r.scaleVector.x<0&&(n.left=h.left+h.width-n.width),n.height=h.height*e,r.scaleVector.y<0&&(n.top=h.top+h.height-n.height)),n}var n=this.scaleBox.bBox,c=0<r.scaleVector.x?n.left+n.width-e:r.scaleVector.x<0?n.left-e:0,p=0<r.scaleVector.y?n.top+n.height-t:r.scaleVector.y<0?n.top-t:0,i=0!==r.scaleVector.x&&0!==r.scaleVector.y,h=this.scaleBox.bBox;this.hideMarkers();var d=this.canvas.docShape.getSelectedShapes(),u=!0;this.app.memento.isLocked||this.performDrag({cursor:"move",move:function(e,t,n){console.log("scale: move. "+e+", "+t),u&&(console.log("scale: move - first time"),u=!1);var t=l(e+=c,t+=p),o=0===t.width&&0===h.width?1:0===t.width||0===h.width?0:t.width/h.width,r=0===t.height&&0===h.height?1:0===t.height||0===h.height?0:t.height/h.height,i=a.canvas.translateXIn(t.left)-a.canvas.translateXIn(h.left)*o,s=a.canvas.translateYIn(t.top)-a.canvas.translateYIn(h.top)*r;d.forEach(function(e){e.element.setAttribute("transform",xp.formatString("translate({0} {1}) scale({2} {3})",i,s,o,r))})},cancel:function(){d.forEach(function(e){e.element.removeAttribute("transform")}),a.showMarkers(),a.createMarkers()},end:function(e,t,n){console.log("scale: up. "+e+", "+t),e+=c,t+=p,d.forEach(function(e){e.element.removeAttribute("transform")});var o=l(e,t),r=a.doc.getSelectedElements(m.Doc.Drawing);a.app.memento.perform({modify:r,action:function(){return r.forEach(function(e){e.scale(a.canvas.translateBoxIn(o),a.canvas.translateBoxIn(h))}),null}}),a.showMarkers(),a.createMarkers()}})},n.prototype.onRotateMarkerMDown=function(e,t,n){var i=this,s=this.canvas.docShape.getSelectedShapes(),o=this.scaleBox.bBox,a={x:o.left+o.width/2,y:o.top+o.height/2},n={x:t,y:n},l=Geo.getAngle(a,n);this.hideMarkers(),this.app.memento.isLocked||this.performDrag({cursor:"move",move:function(e,t,n){0;var o=Geo.getQS(l,Geo.getAngle(a,{x:e,y:t}));n.shiftKey&&(o=Geo.rad(Math.round(1e3*(Geo.deg(o)+7.5-(Geo.deg(o)+7.5)%15))/1e3)),s.forEach(function(e){e.element.setAttribute("transform",xp.formatString("rotate({0} {1} {2})",180*o/Math.PI,i.canvas.translateXIn(a.x),i.canvas.translateYIn(a.y)))})},cancel:function(){s.forEach(function(e){e.element.removeAttribute("transform")}),i.showMarkers(),i.createMarkers()},end:function(e,t,n){s.forEach(function(e){e.element.removeAttribute("transform")});var o=Geo.getQS(l,Geo.getAngle(a,{x:e,y:t}));n.shiftKey&&(o=Geo.rad(Math.round(1e3*(Geo.deg(o)+7.5-(Geo.deg(o)+7.5)%15))/1e3));var r=i.doc.getSelectedElements(m.Doc.Drawing);i.app.memento.isLocked||(i.app.memento.perform({modify:r,action:function(){return r.forEach(function(e){e.rotate({x:i.canvas.translateXIn(a.x),y:i.canvas.translateYIn(a.y)},o)}),null}}),i.showMarkers(),i.createMarkers())}})},n.prototype.createScaleBox=function(){var e,n=this;this.scaleBox&&this.scaleBox.remove(),this.doc&&0<this.doc.selectedElements.length&&(e=this.doc.getSelectedBBox(),this.scaleBox=new r.Markers.ScaleBox(this.canvas.levels.markers,{left:this.canvas.translateXOut(e.left),top:this.canvas.translateYOut(e.top),width:this.canvas.translateSizeOut(e.width),height:this.canvas.translateSizeOut(e.height)}),this.scaleBox.onScaleMarkerMDown.addHandler(function(e){var t=xp.createEventArgs(n.canvas,e.domEvent);e instanceof TouchEvent&&window.dispatchEvent(e.domEvent),n.onScaleMarkerMDown(e.targetMarker,t.elementX,t.elementY)},this),this.scaleBox.onRotateMarkerMDown.addHandler(function(e){var t=xp.createEventArgs(n.canvas,e.domEvent);n.onRotateMarkerMDown(e.targetMarker,t.elementX,t.elementY)},this))},n.prototype.removeScaleBox=function(){this.scaleBox&&(this.scaleBox.remove(),this.scaleBox=null)},n.prototype.onGrandientColorChange=function(t){var e=this,n=[];this.selectedGStops.forEach(function(e){n.indexOf(e.drawing)<0&&n.push(e.drawing)}),this.app.memento.isLocked||this.app.memento.perform({modify:n,action:function(){return e.selectedGStops.forEach(function(e){e.drawing.fill.gradient.stops[e.index].color=t}),e.gradientMarkers.forEach(function(e){0<=n.indexOf(e.drawing)&&e.marker.updateColors(e.drawing.fill.gradient)}),null}})},n.prototype.createGradientMarkers=function(){var f=this;this.removeGradientMarkers();var o=document.createDocumentFragment();this.doc.cascadeSelected(m.Doc.Drawing,function(n){var e=new xp.BindingCallManager(n,"fill.gradient",function(e){var t=f.gradientMarkers.filter(function(e){return e.drawing===n})[0];e?t?(f.selectedGStops.filter(function(e){return e.drawing===n}).forEach(function(e){f.selectedGStops.splice(f.selectedGStops.indexOf(e),1)}),t.marker.update(e)):(e=new r.Markers.GradientMarker(o,n.fill.gradient,f.canvas),f.gradientMarkers.push({drawing:n,marker:e}),e.onGStopMDown.addHandler(function(s){var a,l,c,p,e,h,d,u,o=f.gradientMarkers.filter(function(e){return e.marker===s.gradientMarker})[0].drawing,r=s.targetMarker.selected;s.targetMarker.selected||(s.domEvent.shiftKey||(f.selectedGStops.forEach(function(t){f.gradientMarkers.filter(function(e){return e.drawing===t.drawing})[0].marker.deselectStops()}),f.selectedGStops.splice(0)),s.targetMarker.selected=!0,f.selectedGStops.push({drawing:o,index:s.gStopIndex})),f.app.memento.isLocked||(l=f.doc.getSelectedElements(m.Doc.Drawing).filter(function(t){return 0<f.selectedGStops.filter(function(e){return e.drawing===t}).length}),c=f.selectedGStops.filter(function(e){return 0===e.index||e.index===e.drawing.fill.gradient.stops.length-1}),(p=f.selectedGStops.filter(function(e){return e.drawing===o&&e.index===s.gStopIndex})[0])&&(e={x:s.elementX,y:s.elementY},h=s.targetMarker.cx-s.elementX,d=s.targetMarker.cy-s.elementY,u=e,f.rulerModeEnabled&&f.canvas.createTempRulers(f.canvas.translateXIn(s.targetMarker.cx),f.canvas.translateYIn(s.targetMarker.cy)),f.performDrag({move:function(e,t){if(!a){if(e===s.elementX&&t===s.elementY)return;a=f.app.memento.beforeAction({modify:l})}var n=f.canvas.getSnappedCoords(e+h,t+d);e=n.x-h,t=n.y-d;var o,r=e-u.x,i=t-u.y;0<=c.indexOf(p)?l.forEach(function(t){f.selectedGStops.filter(function(e){return e.drawing===t&&0<=c.indexOf(e)}).forEach(function(e){0===e.index&&(t.fill.gradient.start={x:t.fill.gradient.start.x+f.canvas.translateSizeIn(r),y:t.fill.gradient.start.y+f.canvas.translateSizeIn(i)}),e.index===t.fill.gradient.stops.length-1&&(t.fill.gradient.end={x:t.fill.gradient.end.x+f.canvas.translateSizeIn(r),y:t.fill.gradient.end.y+f.canvas.translateSizeIn(i)})})}):(o=p.drawing.fill.gradient,n=Geo.getClosestPointAtLine(f.canvas.translatePtIn({x:e,y:t}),o.start,o.end,!1),(n=Geo.getLength(n,o.start)/Geo.getLength(o.start,o.end))<=o.stops[s.gStopIndex-1].offset&&(n=1===s.gStopIndex?o.stops[s.gStopIndex-1].offset+(o.stops[s.gStopIndex+1].offset-o.stops[s.gStopIndex-1].offset)/50:o.stops[s.gStopIndex-1].offset),n>=o.stops[s.gStopIndex+1].offset&&(n=s.gStopIndex===o.stops.length-2?o.stops[s.gStopIndex+1].offset-(o.stops[s.gStopIndex+1].offset-o.stops[s.gStopIndex-1].offset)/50:o.stops[s.gStopIndex+1].offset),o.stops[s.gStopIndex].offset=n),l.map(function(t){return f.gradientMarkers.filter(function(e){return e.drawing===t})[0]}).forEach(function(e){return e.marker.updateLocation(e.drawing.fill.gradient)}),u={x:e,y:t}},cancel:function(){a&&a.cancelWithRestore(),f.canvas.afterSnap(),f.canvas.removeTempRulers()},end:function(e,t){var n;a?a.afterAction():s.domEvent.shiftKey&&r&&(s.targetMarker.selected=!1,n=f.selectedGStops.filter(function(e){return e.drawing===o&&e.index===s.gStopIndex})[0],f.selectedGStops.splice(f.selectedGStops.indexOf(n),1)),f.canvas.afterSnap(),f.canvas.removeTempRulers()}})))})):t&&(t.marker.remove(),f.gradientMarkers.splice(f.gradientMarkers.indexOf(t),1),f.selectedGStops.filter(function(e){return e.drawing===n}).forEach(function(e){return f.selectedGStops.splice(f.selectedGStops.indexOf(e),1)}))});f.gradientBindings.push({drawing:n,binding:e})}),this.canvas.levels.markers.appendChild(o)},n.prototype.removeGradientMarkers=function(){this.gradientMarkers&&this.gradientMarkers.forEach(function(e){e.marker.remove()}),this.gradientMarkers=[],this.gradientBindings&&this.gradientBindings.forEach(function(e){e.binding.unbind()}),this.gradientBindings=[],this.selectedGStops=[]},n.prototype.onShapeContextMenu=function(e){var n,t,o=this;e.domEvent.preventDefault(),this.isShapeTouched||(t=this.doc.getIndexPath(e.targetShape.model),this.doc.layers[t[0]].locked||(n=this.doc.layers[t[0]].children[t[1]],t=[{text:"Cut",icon:m.UI.Icons.cut,action:function(){0<o.doc.selectedElements.length&&(o.app.memento.isLocked||o.app.memento.perform({delete:o.doc.selectedElements,action:function(){return o.app.clipboard.cut(),null}}))},key:"Ctrl+X"},{text:"Copy",icon:m.UI.Icons.copy,action:function(){o.app.clipboard.copy()},key:"Ctrl+C"},{text:"Paste",icon:m.UI.Icons.paste,action:function(){var t;o.app.memento.isLocked||(t=o.app.memento.beforeAction(),o.app.clipboard.paste(function(e){e?(o.doc.actions.arrange.moveSelectedAfter(n),t.afterAction({created:o.app.document.selectedElements})):t.cancelWithNoChanges()}))},disabled:!this.app.clipboard.isClipboardSet,key:"Ctrl+V"},{text:"Duplicate",icon:m.UI.Icons.copy,action:function(){o.app.memento.isLocked||o.app.memento.perform({action:function(){return o.doc.actions.create.duplicateSelected(),{created:o.doc.selectedElements}}})},key:"Shift+D",disabled:0===this.doc.selectedElements.length},{text:"Delete",icon:m.UI.Icons.delete,action:function(){o.app.memento.isLocked||o.app.memento.perform({delete:o.doc.selectedElements,action:function(){return o.app.document.actions.remove.removeSelected(),null}})},key:"Del"},{text:"Group",icon:m.UI.Icons.group,action:function(){o.app.memento.isLocked||o.app.memento.perform({delete:o.doc.selectedElements,action:function(){return{created:[o.app.document.actions.group.groupSelected()]}}})},disabled:this.app.document.selectedElements.length<2,key:"Ctrl+G"}],n instanceof m.Doc.Group&&t.push({text:"Ungroup",icon:m.UI.Icons.ungroup,action:function(){o.app.memento.isLocked||o.app.memento.perform({delete:[n],action:function(){return o.app.document.actions.group.ungroup(n),{created:o.doc.selectedElements}}})},key:"Ctrl+U"}),this.shapeContextMenu&&this.shapeContextMenu.remove(),this.canvasContextMenu&&this.canvasContextMenu.remove(),this.shapeContextMenu=new xp.ContextMenu(t),this.shapeContextMenu.show(e.domEvent.pageX,e.domEvent.pageY),this.shapeContextMenu.onRemoved.addHandler(function(){return o.shapeContextMenu=null})))},n.prototype.onCanvasContextMenu=function(i){var s=this;i.domEvent.preventDefault(),this.canvasContextMenu=new xp.ContextMenu([{text:"Paste",key:"Ctrl+V",icon:m.UI.Icons.paste,action:function(){var t;s.app.memento.isLocked||(t=s.app.memento.beforeAction(),s.app.clipboard.paste(function(e){var n,o,r;e?(n=s.scaleBox.bBox,o=s.canvas.translateSizeIn(i.elementX-n.left),r=s.canvas.translateSizeIn(i.elementY-n.top),s.doc.cascadeSelected(m.Doc.Drawing,function(e){var t=e.getBBox();e.move(t.left+o-n.width/2,t.top+r-n.height/2)}),s.createMarkers(),t.afterAction({created:s.app.document.selectedElements})):t.cancelWithNoChanges()}))},disabled:!this.app.clipboard.isClipboardSet}]),this.canvasContextMenu.show(i.domEvent.pageX,i.domEvent.pageY),this.canvasContextMenu.onRemoved.addHandler(function(){return s.canvasContextMenu=null})},n);function n(){var e=this;t.apply(this,arguments),this.actions={flipX:function(){e.app.memento.isLocked||e.app.memento.perform({modify:e.doc.getSelectedElements(m.Doc.Drawing),action:function(){var t=e.app.document.getSelectedBBox(),n={left:t.left+t.width,top:t.top,width:-t.width,height:t.height};return t&&e.app.document.cascadeSelected(m.Doc.Drawing,function(e){return e.scale(n,t)}),e.createMarkers(),null}})},flipY:function(){e.app.memento.isLocked||e.app.memento.perform({modify:e.doc.getSelectedElements(m.Doc.Drawing),action:function(){var t=e.app.document.getSelectedBBox(),n={left:t.left,top:t.top+t.height,width:t.width,height:-t.height};return t&&e.app.document.cascadeSelected(m.Doc.Drawing,function(e){return e.scale(n,t)}),e.createMarkers(),null}})},bringForward:function(){e.app.memento.isLocked||e.app.memento.perform({arrange:e.app.document.selectedElements,action:function(){return e.app.document.actions.arrange.bringSelectedForward(),null}})},bringBackward:function(){e.app.memento.isLocked||e.app.memento.perform({arrange:e.app.document.selectedElements,action:function(){return e.app.document.actions.arrange.bringSelectedBackward(),null}})},bringFront:function(){e.app.memento.isLocked||e.app.memento.perform({arrange:e.app.document.selectedElements,action:function(){return e.app.document.actions.arrange.bringSelectedFront(),null}})},bringBack:function(){e.app.memento.isLocked||e.app.memento.perform({arrange:e.app.document.selectedElements,action:function(){return e.app.document.actions.arrange.bringSelectedBack(),null}})}}}r.SelectTool=e;var i,o=(i=m.UI.ToolPanel,__extends(s,i),s.prototype.onDeleteClick=function(){var e=this;this.app.memento.isLocked||this.app.memento.perform({delete:this.app.document.selectedElements,action:function(){return e.app.document.actions.remove.removeSelected(),null}})},s.prototype.onCutClick=function(){var e=this;this.app.memento.isLocked||this.app.memento.perform({delete:this.app.document.selectedElements,action:function(){return e.app.clipboard.cut(),null}})},s.prototype.onCopyClick=function(){this.app.clipboard.copy()},s.prototype.onPasteClick=function(){var t,n=this;this.app.memento.isLocked||(t=this.app.memento.beforeAction(),this.app.clipboard.paste(function(e){e?t.afterAction({created:n.app.document.selectedElements}):t.cancelWithNoChanges()}))},s.prototype.onDuplicateClick=function(){var e=this;this.app.memento.isLocked||this.app.memento.perform({action:function(){return e.app.document.actions.create.duplicateSelected(),{created:e.app.document.selectedElements}}})},s.prototype.onSelectAllClick=function(){this.app.document.actions.select.selectAll()},s.prototype.onDeselectAllClick=function(){this.app.document.actions.select.deselectAll()},s.prototype.onFlipXClick=function(){this.tool.actions.flipX()},s.prototype.onFlipYClick=function(){this.tool.actions.flipY()},s.prototype.onBringForwardClick=function(){this.tool.actions.bringForward()},s.prototype.onBringBackwardClick=function(){this.tool.actions.bringBackward()},s.prototype.onBringFrontClick=function(){this.tool.actions.bringFront()},s.prototype.onBringBackClick=function(){this.tool.actions.bringBack()},s);function s(e,t,n){var o=this;i.call(this,n,[new xp.HBox({},[new xp.Button({text:"Cut",icon:m.UI.Icons.cut,enabled:"({document.selectedElements.length} > 0)",onClick:function(){return o.onCutClick()}}),new xp.Button({text:"Copy",icon:m.UI.Icons.copy,enabled:"({document.selectedElements.length} > 0)",onClick:function(){return o.onCopyClick()}}),new xp.Button({text:"Paste",icon:m.UI.Icons.paste,enabled:"{clipboard.isClipboardSet}",onClick:function(){return o.onPasteClick()}}),new xp.Button({text:"Delete",icon:m.UI.Icons.delete,enabled:"({document.selectedElements.length} > 0)",onClick:function(){return o.onDeleteClick()}}),new xp.Button({text:"Duplicate",icon:m.UI.Icons.copy,enabled:"({document.selectedElements.length} > 0)",onClick:function(){return o.onDuplicateClick()}})]),new xp.HBox({},[new xp.Button({text:"Select All",icon:m.UI.Icons.select,onClick:function(){return o.onSelectAllClick()}}),new xp.Button({text:"Deselect",icon:m.UI.Icons.deselect,enabled:"({document.selectedElements.length} > 0)",onClick:function(){return o.onDeselectAllClick()}})]),new xp.HBox({},[new xp.Button({text:"Flip X",icon:m.UI.Icons.selectTool.flipX,enabled:"({document.selectedElements.length} > 0)",onClick:function(){return o.onFlipXClick()}}),new xp.Button({text:"Flip Y",icon:m.UI.Icons.selectTool.flipY,enabled:"({document.selectedElements.length} > 0)",onClick:function(){return o.onFlipYClick()}})]),new xp.HBox({},[new xp.Button({text:"Front",icon:m.UI.Icons.bringFront,enabled:"({document.selectedElements.length} > 0)",onClick:function(){return o.onBringFrontClick()}}),new xp.Button({text:"Forward",icon:m.UI.Icons.bringForward,enabled:"({document.selectedElements.length} > 0)",onClick:function(){return o.onBringForwardClick()}}),new xp.Button({text:"Backward",icon:m.UI.Icons.bringBackward,enabled:"({document.selectedElements.length} > 0)",onClick:function(){return o.onBringBackwardClick()}}),new xp.Button({text:"Back",icon:m.UI.Icons.bringBack,enabled:"({document.selectedElements.length} > 0)",onClick:function(){return o.onBringBackClick()}})])]),this.app=e,this.scope=e,this.tool=t}}(m.Tools||(m.Tools={}))}(Inker=Inker||{}),function(w){!function(o){var e,t=(e=o.Tool,__extends(n,e),n.prototype.getName=function(){return"Shape"},n.prototype.getIcon=function(){return w.UI.Icons.tools.shape},n.prototype.createToolPanel=function(){this.toolPanel=new i(this.app,this)},n.prototype.getCursor=function(){switch(this.data.currentShapeType){case"rectangle":return n.cursors.rectangle;case"ellipse":return n.cursors.ellipse;default:return"default"}},n.prototype.getHelpMessage=function(){return null},n.prototype.supportsRulerMode=function(){return!1},n.prototype.defineProperties=function(){xp.Model.property(this,"data",xp.observable({currentShapeType:"rectangle",preserveAspectRatio:!0,startFromCenter:!1}))},n.prototype.onEnabled=function(){var t=this;this.registrar.subscribe(this.canvas.onPointerDown,function(e){t.startCreating(e.elementX,e.elementY,t.data.preserveAspectRatio,t.data.startFromCenter)},this),this.registrar.subscribe(this.data.onPropertyChanged,function(e){"currentShapeType"===e&&t.canvas.replaceCursor(t.getCursor())},this),this.registrar.subscribe(this.canvas.onViewportChanged,function(e){t.createHighlights()},this),this.createHighlights()},n.prototype.onDisabled=function(){e.prototype.onDisabled.call(this),this.removeHighlights()},n.prototype.onSelectionChanged=function(){this.createHighlights()},n.prototype.onDocumentChanged=function(){this.createHighlights()},n.prototype.startCreating=function(p,h,d,u){var f,m,g,v,e,y,x=this;this.doc.currentLayer.locked?this.app.message.warn("Current layer is locked."):(g=this.doc,this.removeHighlights(),e=this.canvas.getSnappedCoords(p,h),p=e.x,h=e.y,this.app.memento.isLocked||this.performDrag({move:function(e,t,n){var o=x.canvas.getSnappedCoords(e,t);e=o.x,t=o.y;var r,i,s,a,l=(l=e-p)||1,c=(c=t-h)||1;d&&(Math.abs(l)>Math.abs(c)?c/=Math.abs(c/l):l/=Math.abs(l/c)),a={x:p,y:h},o={x:p+l,y:h+c},f||e===p||t===h||(y=x.app.memento.beforeAction(),g.actions.select.deselectAll(),"rectangle"===x.data.currentShapeType&&(m=g.actions.curve.addPoint(0,0,w.Doc.PointType.Cusp),f=m.curve,g.actions.curve.addPoint(1,0,w.Doc.PointType.Cusp),g.actions.curve.addPoint(1,1,w.Doc.PointType.Cusp),g.actions.curve.addPoint(0,1,w.Doc.PointType.Cusp),g.actions.curve.closePath(m)),"ellipse"===x.data.currentShapeType&&(m=g.actions.curve.addPoint(0,.5,w.Doc.PointType.Smooth),f=m.curve,g.actions.curve.addPoint(.5,0,w.Doc.PointType.Smooth),g.actions.curve.addPoint(1,.5,w.Doc.PointType.Smooth),g.actions.curve.addPoint(.5,1,w.Doc.PointType.Smooth),g.actions.curve.closePath(m)),m.updateSegments(),f.move(x.canvas.translateXIn(a.x),x.canvas.translateYIn(a.y)),(v=x.canvas.docShape.getSelectedShapes()[0]).element.setAttribute("vector-effect","non-scaling-stroke")),v&&(a=u?(r=2*x.canvas.translateSizeIn(o.x-a.x),i=2*x.canvas.translateSizeIn(o.y-a.y),s=x.canvas.translateXIn(p+l/(r-1))*(1-r),x.canvas.translateYIn(h+c/(i-1))*(1-i)):(r=x.canvas.translateSizeIn(o.x-a.x),i=x.canvas.translateSizeIn(o.y-a.y),s=x.canvas.translateXIn(p)*(1-r),x.canvas.translateYIn(h)*(1-i)),v.element.setAttribute("transform","translate("+s+" "+a+") scale("+r+" "+i+")"))},cancel:function(){v&&(v.element.removeAttribute("transform"),v.element.removeAttribute("vector-effect")),f&&x.app.document.actions.remove.removeElement(f),y&&y.cancelWithNoChanges(),x.createHighlights()},end:function(e,t,n){var o=x.canvas.getSnappedCoords(e,t);e=o.x,t=o.y,v&&(v.element.removeAttribute("transform"),v.element.removeAttribute("vector-effect"));var o=(o=e-p)||1,e=(e=t-h)||1;f?(d&&(Math.abs(o)>Math.abs(e)?e=e/Math.abs(e)*Math.abs(o):o=o/Math.abs(o)*Math.abs(e)),t={x:p,y:h},e={x:p+o,y:h+e},f.scale(u?{left:x.canvas.translateXIn(2*t.x-e.x),top:x.canvas.translateYIn(2*t.y-e.y),width:2*x.canvas.translateSizeIn(e.x-t.x),height:2*x.canvas.translateSizeIn(e.y-t.y)}:{left:x.canvas.translateXIn(t.x),top:x.canvas.translateYIn(t.y),width:x.canvas.translateSizeIn(e.x-t.x),height:x.canvas.translateSizeIn(e.y-t.y)}),y&&y.afterAction({created:[f]})):y&&y.cancelWithNoChanges(),x.createHighlights()}}))},n.prototype.createHighlights=function(){var t,n=this;this.removeHighlights(),this.doc&&(t=document.createDocumentFragment(),this.doc.cascadeSelected(w.Doc.Drawing,function(e){e=o.Markers.createHighlight(t,e,n.canvas);n.highlights.push(e)}),this.canvas.levels.markers.appendChild(t))},n.prototype.removeHighlights=function(){this.highlights&&this.highlights.forEach(function(e){return w.Svg.remove(e)}),this.highlights=[]},n.cursors={rectangle:"url(style/img/cursor_shapeTool_rectangle.png) 5 5, default",ellipse:"url(style/img/cursor_shapeTool_ellipse.png) 5 5, default"},n);function n(){e.apply(this,arguments)}o.ShapeTool=t;var r,i=(r=w.UI.ToolPanel,__extends(s,r),s);function s(e,t,n){r.call(this,n,[new xp.HBox({},[new xp.ToggleButton({text:"Rectangle",icon:w.UI.Icons.shapeTool.rectangle,item:"rectangle",selectedItem:"{data.currentShapeType}"}),new xp.ToggleButton({text:"Ellipse",icon:w.UI.Icons.shapeTool.ellipse,item:"ellipse",selectedItem:"{data.currentShapeType}"})]),new xp.HBox({},[new xp.CheckBox({margin:"0 0 0 0.5em",text:"Preserve aspect ratio",checked:"{data.preserveAspectRatio}"}),new xp.CheckBox({margin:"0 0 0 0.5em",text:"Start from center",checked:"{data.startFromCenter}"})])]),this.app=e,this.useParentScope=!1,this.scope=t}}(w.Tools||(w.Tools={}))}(Inker=Inker||{}),function(y){!function(s){var n,e=(n=s.Tool,__extends(t,n),t.prototype.getName=function(){return"Text"},t.prototype.getIcon=function(){return y.UI.Icons.tools.text},t.prototype.createToolPanel=function(){this.toolPanel=new o(this.app,this)},t.prototype.getCursor=function(){return"url(style/img/cursor_textTool.png) 1 1, default"},t.prototype.createStyleNode=function(){var e=document.createElement("style");e.setAttribute("id","SelectToolStyle"),e.innerHTML='[data-type="Text"] { cursor: text; }',document.head.appendChild(e),this.styleNode=e},t.prototype.removeStyleNode=function(){document.head.removeChild(this.styleNode)},t.prototype.getHelpMessage=function(){return""},t.prototype.supportsRulerMode=function(){return!1},t.prototype.defineProperties=function(){var e=this;xp.Model.property(this,"currentText"),new xp.BindingCallManager(this,"currentText.content",function(){e.currentText?e.createHighlights():e.removeHighlights()})},t.prototype.onEnabled=function(){var t=this;this.registrar.subscribe(this.canvas.onPointerDown,function(e){t.currentText&&t.initialValue?(console.log("text: end edit",e.domEvent),t.endEdit()):(console.log("text: start creating",e.domEvent),t.startCreatingText(e.elementX,e.elementY))},this),this.registrar.subscribe(this.canvas.onShapeMouseDown,function(e){e.targetShape.model instanceof y.Doc.Text&&(t.app.document.actions.select.deselectAll(),t.app.document.actions.select.selectElement(e.targetShape.model),e.domEvent.stopPropagation())},this),this.registrar.subscribe(this.canvas.onViewportChanged,function(e){t.createMarkers()},this),this.registrar.subscribe(this.app.memento.onBeforeUndo,function(e){t.applyTextChange()},this),this.handleSelectionChange(),this.createStyleNode()},t.prototype.onDocumentChanged=function(){this.initialValue=null,this.createMarkers(),this.handleSelectionChange()},t.prototype.onSelectionChanged=function(){this.handleSelectionChange()},t.prototype.onDisabled=function(){var t=this;n.prototype.onDisabled.call(this),this.doc.cascadeElements(y.Doc.Text,function(e){e.content||t.doc.actions.remove.removeElement(e)}),this.endEdit(),this.removeMarkers(),this.removeStyleNode()},t.prototype.handleSelectionChange=function(){this.isHackySelectionRestore||(this.endEdit(),this.currentText=this.getFirstSelectedText(),this.currentText&&1===this.doc.selectedElements.length&&this.startEdit(),this.createHighlights())},t.prototype.startCreatingText=function(n,o){var r=this,i=!1;this.performDrag({move:function(e,t){e===n&&t===o||(i=!0)},cancel:function(){},end:function(e,t){i||r.createText(e,t)}})},t.prototype.createText=function(e,t){var n=this;this.endEdit(),this.doc.currentLayer.locked?this.app.message.warn("Current layer is locked."):this.app.memento.isLocked||this.app.memento.perform({action:function(){return n.doc.actions.select.deselectAll(),{created:[n.app.document.actions.create.text("Text",n.canvas.translateXIn(e),n.canvas.translateYIn(t))]}}})},t.prototype.onTextPropChange=function(){this.createHighlights()},t.prototype.startEdit=function(){this.initialValue=this.currentText.content,this.createTextMarker()},t.prototype.endEdit=function(){this.applyTextChange(),this.removeTextMarker(),this.initialValue=null},t.prototype.applyTextChange=function(){var t=this;if(this.currentText&&this.initialValue){var e={selectedElements:this.doc.selectedElements.slice(0),selectOld:function(){1===e.selectedElements.length&&e.selectedElements[0]===t.currentText||(t.isHackySelectionRestore=!0,t.doc.actions.select.deselectAll(),t.doc.actions.select.selectElement(t.currentText))},selectNew:function(){t.doc.actions.select.deselectAll(),e.selectedElements.forEach(function(e){return t.doc.actions.select.selectElement(e)}),t.isHackySelectionRestore=!1}};if(this.currentText.content.trim()){var n=this.currentText.content;if(n!==this.initialValue){if(this.currentText.content=this.initialValue,e.selectOld(),this.app.memento.isLocked)return!0;this.app.memento.perform({modify:[this.currentText],action:function(){return t.currentText.content=n,t.initialValue=n,null}}),e.selectNew()}}else{if(this.currentText.content=this.initialValue,e.selectOld(),this.app.memento.isLocked)return!0;this.app.memento.perform({delete:[this.currentText],action:function(){return t.doc.actions.remove.removeElement(t.currentText),t.currentText=null,t.initialValue=null}}),e.selectNew()}}},t.prototype.getFirstSelectedText=function(){if(this.doc)return this.doc.getSelectedElements(y.Doc.Text)[0]||null},t.prototype.onTextMarkerMouseDown=function(){var o,e,r=this;this.app.memento.isLocked||(this.applyTextChange(),this.removeHighlights(),e={x:this.currentText.x,y:this.currentText.y},this.performDrag({move:function(e,t,n){o=o||r.app.memento.beforeAction({modify:[r.currentText]}),r.currentText.x=r.canvas.translateXIn(e),r.currentText.y=r.canvas.translateYIn(t),r.textMarker.coord={x:e,y:t}},cancel:function(){r.currentText.x=e.x,r.currentText.y=e.y,o&&o.cancelWithNoChanges(),r.textMarker.coord={x:r.canvas.translateXOut(e.x),y:r.canvas.translateYOut(e.y)},r.createHighlights()},end:function(){o&&o.afterAction(),r.createHighlights()}}))},t.prototype.createMarkers=function(){this.createHighlights()},t.prototype.removeMarkers=function(){this.removeHighlights(),this.removeTextMarker()},t.prototype.updateTextMarkerPosition=function(){this.textMarker&&this.currentText&&(this.textMarker.coord={x:this.canvas.translateXOut(this.currentText.x),y:this.canvas.translateYOut(this.currentText.y)})},t.prototype.centrifyTextPosition=function(){var e=this.canvas.translateBoxOut(this.currentText.getBBox()),t=this.canvas.domElement.getBoundingClientRect();this.canvas.viewport={x:t.width/2-this.canvas.translateSizeOut(this.currentText.x+e.width/2),y:t.height/2-this.canvas.translateSizeOut(this.currentText.y+e.height/2),zoom:this.canvas.viewport.zoom}},t.prototype.createTextMarker=function(){var t=this;this.removeTextMarker(),this.currentText&&(this.textMarker=new s.Markers.TextMarker(this.canvas.levels.markers,this.canvas.translateXOut(this.currentText.x),this.canvas.translateYOut(this.currentText.y),this.canvas,this.currentText),this.textMarker.onTextInput.addHandler(this.onTextPropChange,this),this.textMarker.onMarkerMouseDown.addHandler(function(e){e.domEvent.stopPropagation(),t.onTextMarkerMouseDown()},this),window.addEventListener("resize",this.onWindowResize))},t.prototype.removeTextMarker=function(){window.removeEventListener("resize",this.onWindowResize),this.textMarker&&this.textMarker.remove(),this.textMarker=null},t.prototype.createHighlights=function(){var t,n=this;this.removeHighlights(),this.doc&&(t=document.createDocumentFragment(),this.doc.cascadeSelected(y.Doc.Text,function(e){e=s.Markers.createHighlight(t,e,n.canvas);n.highlights.push(e)}),this.canvas.levels.markers.appendChild(t))},t.prototype.removeHighlights=function(){this.highlights&&this.highlights.forEach(function(e){return y.Svg.remove(e)}),this.highlights=[]},t.prototype.refreshMarkers=function(){this.createMarkers()},t.prototype.convertTextsToCurves=function(){var o,g,r,v=this,i=this.doc.getSelectedElements(y.Doc.Text);0<i.length&&(this.applyTextChange(),this.app.memento.isLocked||(o=this.app.memento.beforeAction({delete:i}),g=[],this.doc.actions.select.deselectAll(),r=0,i.forEach(function(t,n){v.app.font.requestParsedFont(t,function(){var e=v.app.font.getCubicPath(t);!function(e,t,n,o){var r,i=new y.Doc.Curve("Converted text");e.parent.children.splice(e.parent.children.indexOf(e)+1,0,i),v.doc.actions.select.selectElement(i);for(var s=[],a=function(e){e=t.commands.indexOf(e);return 0===e?null:t.commands[e+1]},l=0;l<t.commands.length;l++){var c,p=t.commands[l];switch(p.type){case"M":r&&!r.isClosed&&(v.doc.actions.curve.closePath(r),(h=r.segmentBefore(r.points[0])).type=y.Doc.SegmentType.Straight,h.points=[r.pointBefore(r.points[0]),r.points[0]]),(r=new y.Doc.Path).points.push({x:p.x,y:p.y,type:y.Doc.PointType.Smooth}),i.paths.push(r);break;case"L":c=a(p)&&"Z"!==a(p).type&&"M"!==a(p).type?(v.doc.actions.curve.addPoint(p.x,p.y,y.Doc.PointType.Smooth),r.points[r.points.length-1]):(v.doc.actions.curve.closePath(r),r.points[0]);var h=r.segmentBefore(c);s.push({path:r,seg:h}),h.points=[r.pointBefore(c),c];break;case"Q":c=a(p)&&"Z"!==a(p).type&&"M"!==a(p).type?(v.doc.actions.curve.addPoint(p.x,p.y,y.Doc.PointType.Smooth),r.points[r.points.length-1]):(v.doc.actions.curve.closePath(r),r.points[0]);var h=r.segmentBefore(c),d=r.pointBefore(c),u={x:p.x1,y:p.y1};h.points=[d,Geo.getMidPoint(d,u,2/3),Geo.getMidPoint(c,u,2/3),c];break;case"C":c=a(p)&&"Z"!==a(p).type&&"M"!==a(p).type?(v.doc.actions.curve.addPoint(p.x,p.y,y.Doc.PointType.Smooth),r.points[r.points.length-1]):(v.doc.actions.curve.closePath(r),r.points[0]);var h=r.segmentBefore(c),d=r.pointBefore(c),f={x:p.x1,y:p.y1},u={x:p.x2,y:p.y2};h.points=[d,f,u,c];break;case"Z":r.isClosed||(v.doc.actions.curve.closePath(r),h=r.segmentBefore(r.points[0]),s.push({path:r,seg:h}),h.points=[r.pointBefore(r.points[0]),r.points[0]]);break;default:throw new Error('Command "'+p.type+'" is not implemented.')}}for(var m in i.paths.forEach(function(o){if(!o.isClosed)throw new Error("Path must be closed.");o.points.forEach(function(e){var t=o.segmentBefore(e),n=o.segmentAfter(e),t=Geo.getAngle(t.points[t.points.length-2],t.points[t.points.length-1]),n=Geo.getAngle(n.points[0],n.points[1]);.05<Geo.getQ(t,n)&&v.doc.actions.curve.convertPoint(o,e,y.Doc.PointType.Cusp)})}),s.forEach(function(e){return v.app.document.actions.curve.convertSegmant(e.path,e.seg,y.Doc.SegmentType.Straight)}),i.paths.forEach(function(e){return e.updateSegments()}),i.updateSvgPath(),e.fill)i.fill[m]=e.fill[m];for(m in e.stroke)i.stroke[m]=e.stroke[m];v.doc.actions.remove.removeElement(e),g[n]=i,o()}(t,e,n,function(){++r===i.length&&(o.afterAction({created:g}),v.app.currentTool=v.app.getTool(s.PathTool))})})})))},t);function t(){var e=this;n.apply(this,arguments),this.isHackySelectionRestore=!1,this.onWindowResize=function(){setTimeout(function(){e.currentText&&(e.centrifyTextPosition(),e.updateTextMarkerPosition())},10)}}s.TextTool=e;var r,o=(r=y.UI.ToolPanel,__extends(i,r),i.prototype.onFontSizeChange=function(e){var t,n=this,o=parseFloat(e.newText);o&&0<o&&(this.tool.applyTextChange(),t=this.app.document.getSelectedElements(y.Doc.Text),this.app.memento.isLocked||(0<t.length?this.app.memento.perform({modify:t,action:function(){return t.forEach(function(e){return e.font.size=o}),n.tool.onTextPropChange(),null}}):this.app.memento.perform({props:["defaultFontStyle"],action:function(){return n.app.document.defaultFontStyle.size=o,null}})))},i.prototype.onFontWeightClick=function(e){var t,n=this,o=parseFloat(e.element.item);o&&0<o&&(this.tool.applyTextChange(),t=this.app.document.getSelectedElements(y.Doc.Text),this.app.memento.isLocked||(0<t.length?this.app.memento.perform({modify:t,action:function(){return t.forEach(function(e){return e.font.weight=o}),n.tool.onTextPropChange(),null}}):this.app.memento.perform({props:["defaultFontStyle"],action:function(){return n.app.document.defaultFontStyle.weight=o,null}})))},i.prototype.onItalicChange=function(t){var e=this;this.tool.applyTextChange();var n=this.app.document.getSelectedElements(y.Doc.Text);this.app.memento.isLocked||(0<n.length?this.app.memento.perform({modify:n,action:function(){return n.forEach(function(e){return e.font.isItalic=t.checked}),e.tool.onTextPropChange(),null}}):this.app.memento.perform({props:["defaultFontStyle"],action:function(){return e.app.document.defaultFontStyle.isItalic=t.checked,null}}))},i.prototype.onAnchorClick=function(e){var t=this;this.tool.applyTextChange();var n=e.element.item,o=this.app.document.getSelectedElements(y.Doc.Text);this.app.memento.isLocked||(0<o.length?this.app.memento.perform({modify:o,action:function(){return o.forEach(function(e){return e.font.anchor=n}),t.tool.onTextPropChange(),null}}):this.app.memento.perform({props:["defaultFontStyle"],action:function(){return t.app.document.defaultFontStyle.anchor=n,null}}))},i.prototype.onConvertToCurveClick=function(){this.tool.convertTextsToCurves()},i.prototype.onImportFontClick=function(){this.app.file.importFont()},i);function i(e,t,n){var o=this;r.call(this,n,[new xp.HBox({},[new l({name:"fontFamilyCombo",width:"14em",margin:"0 0 0 0.5em",flex:"none"}),new xp.TextBox({text:"({currentText.font.size} || {app.document.defaultFontStyle.size})",type:"number",min:1,margin:"0 0 0 0.5em",width:"4em",flex:"none",onTextChange:function(e){return o.onFontSizeChange(e)}})]),new xp.HBox({},[new xp.ToggleButton({text:"Light",style:"textToolPanel_lightText",selectedItem:"({currentText.font.weight} || {app.document.defaultFontStyle.weight})",enabled:"({app}.font.hasLight({currentText.font.family} || {app.document.defaultFontStyle.family}))",item:"300",onMouseDown:function(e){return o.onFontWeightClick(e)},margin:"0 0 0 1em"}),new xp.ToggleButton({text:"Normal",style:"textToolPanel_normalText",selectedItem:"({currentText.font.weight} || {app.document.defaultFontStyle.weight})",item:"400",onMouseDown:function(e){return o.onFontWeightClick(e)}}),new xp.ToggleButton({text:"Bold",style:"textToolPanel_boldText",selectedItem:"({currentText.font.weight} || {app.document.defaultFontStyle.weight})",enabled:"({app}.font.hasBold({currentText.font.family} || {app.document.defaultFontStyle.family}))",item:"700",onMouseDown:function(e){return o.onFontWeightClick(e)}}),new xp.CheckBox({text:"Italic",checked:'(typeof {currentText.font.isItalic} === "boolean" ? {currentText.font.isItalic} : {app.document.defaultFontStyle.isItalic})',enabled:"({app}.font.hasItalic({currentText.font.family} || {app.document.defaultFontStyle.family}))",margin:"0 0 0 1em",style:"textToolPanel_italicText",onCheckChange:function(e){return o.onItalicChange(e)}})]),new xp.HBox({},[new xp.ToggleButton({icon:y.UI.Icons.textTool.anchorLeft,selectedItem:"({currentText.font.anchor} || {app.document.defaultFontStyle.anchor})",item:"end",margin:"0 0 0 1em",onMouseDown:function(e){return o.onAnchorClick(e)}}),new xp.ToggleButton({icon:y.UI.Icons.textTool.anchorMiddle,selectedItem:"({currentText.font.anchor} || {app.document.defaultFontStyle.anchor})",item:"middle",onMouseDown:function(e){return o.onAnchorClick(e)}}),new xp.ToggleButton({icon:y.UI.Icons.textTool.anchorRight,selectedItem:"({currentText.font.anchor} || {app.document.defaultFontStyle.anchor})",item:"start",margin:"0 0.5em 0 0",onMouseDown:function(e){return o.onAnchorClick(e)}})]),new xp.HBox({margin:"0 0 0 0.5em"},[new xp.Button({key:"advanced",text:"Convert to curve",icon:y.UI.Icons.pathTool.strokeToPath,enabled:'(typeof {currentText} === "object")',onClick:function(){return o.onConvertToCurveClick()}}),new xp.Button({style:"unstable",text:"Import font",icon:y.UI.Icons.new,onClick:function(){return o.onImportFontClick()}})])]),this.app=e,this.tool=t,this.useParentScope=!1,this.scope=t,this.fontFamilyCombo.onFontFamilySelected.addHandler(function(t){o.tool.applyTextChange();var e=o.app.document.getSelectedElements(y.Doc.Text);o.app.memento.isLocked||(0<e.length?o.app.memento.perform({modify:e,action:function(){return e.forEach(function(e){return e.font.family=t}),(e[0].font.weight===y.Doc.FontWeight.Bold&&!o.app.font.hasBold(t)||e[0].font.weight===y.Doc.FontWeight.Light&&!o.app.font.hasLight(t))&&e.forEach(function(e){return e.font.weight=y.Doc.FontWeight.Normal}),e[0].font.isItalic&&!o.app.font.hasItalic(t)&&e.forEach(function(e){return e.font.isItalic=!1}),o.tool.onTextPropChange(),null}}):o.app.memento.perform({props:["defaultFontStyle"],action:function(){return o.app.document.defaultFontStyle.family=t,(o.app.document.defaultFontStyle.weight===y.Doc.FontWeight.Bold&&!o.app.font.hasBold(t)||o.app.document.defaultFontStyle.weight===y.Doc.FontWeight.Light&&!o.app.font.hasLight(t))&&(o.app.document.defaultFontStyle.weight=y.Doc.FontWeight.Normal),o.app.document.defaultFontStyle.isItalic&&!o.app.font.hasItalic(t)&&(o.app.document.defaultFontStyle.isItalic=!1),null}}))},this)}var a,l=(a=xp.VBox,__extends(c,a),c.prototype.getTemplate=function(){return xp.Dom.create('<span class="FontFamilyCombo VBox"></span>')},c.prototype.initElement=function(){var n=this;a.prototype.initElement.call(this),this.selectedElement=new h,this.selectedElement.appendTo(this),this.fontContainer=new xp.VBox,this.fontContainer.style="fontContainer",this.fontContainer.visible=!1,this.fontContainer.appendTo(this),this.selectedElement.onMouseDown.addHandler(function(e){var t;e.domEvent.stopPropagation(),n.fontContainer.visible?n.fontContainer.visible=!1:(n.selectedElement.domElement.getBoundingClientRect(),n.fontContainer.visible=!0,n.fontContainer.domElement.style.maxHeight=.9*app.window.canvas.domElement.clientHeight+"px",t=function(e){e.target!==n.fontContainer.domElement&&(n.fontContainer.visible=!1,window.removeEventListener("mousedown",t))},window.addEventListener("mousedown",t))},this)},c.prototype.initEvents=function(){a.prototype.initEvents.call(this),this.onFontFamilySelected=new xp.Event},c.prototype.setDefaults=function(){a.prototype.setDefaults.call(this),this.contentAlign="middle"},Object.defineProperty(c.prototype,"selectedFont",{get:function(){return this._selectedFont},set:function(e){this._selectedFont=e,this.selectedElement.domElement.textContent=e,this.selectedElement.domElement.style.fontFamily=e},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"fonts",{set:function(e){var n=this;this.fontContainer.removeChildren(),e.forEach(function(e){var t=new f(e);t.appendTo(n.fontContainer),t.onMouseDown.addHandler(function(e){e.domEvent.stopPropagation(),n.selectedFont=t.font,n.onFontFamilySelected.invoke(t.font),n.fontContainer.visible=!1},n)})},enumerable:!0,configurable:!0}),c);function c(e){var n=this;a.call(this,e),this.bind(function(t){t&&t.onCollectionChanged.addHandler(function(e){n.fonts=t},n),n.fonts=t||[]},"app.font.fontList"),this.express("selectedFont","{currentText.font.family} || {app.document.defaultFontStyle.family}")}var p,h=(p=xp.Element,__extends(d,p),d.prototype.getTemplate=function(){return xp.Dom.create('<span class="SelectedFontItem"></span>')},d);function d(){p.apply(this,arguments)}var u,f=(u=xp.Element,__extends(m,u),m.prototype.getTemplate=function(){return xp.Dom.create('<span class="FontFamilyItem"></span>')},m);function m(e,t){u.call(this,t),this.font=e,this.domElement.textContent=e,this.domElement.style.fontFamily=e}}(y.Tools||(y.Tools={}))}(Inker=Inker||{}),function(c){!function(e){e.serialize=function(e,t){return JSON.stringify(e,function(e,t){var n;if("object"!=typeof t||Array.isArray(t)||null===t||("Object"!==(n=xp.getClassName(t))&&(t["doc-model"]=n),t instanceof c.Doc.Element&&(t["doc-model-id"]=t.id,t instanceof c.Doc.Curve&&t.writePath())),"actions"!==e)return"currentLayer"===e?t.id:"selectedElements"===e?t.map(function(e){return e.id}):("segment"===e&&delete t.points,t)},t?" ":void 0)},e.deserialize=function(e){var i,s={},a=[];if((e=JSON.parse(e,function(e,t){if("object"==typeof t&&null!==t&&"doc-model"in t){if("Object"===t["doc-model"])return delete t["doc-model"],t;if("ObservableObject"===t["doc-model"])return delete t["doc-model"],"fill"!==e||"gradient"in t||(t.gradient=null),xp.observable(t);var n=l.get(t["doc-model"]);if(!n)throw new Error('No constructor specified for model "'+t["doc-model"]+'".');var o,r=new n;for(o in t)"currentLayer"!==o&&"selectedElements"!==o&&"doc-model"!==o&&"doc-model-id"!==o&&(r[o]=t[o]);return r instanceof c.Doc.Element&&(s[t["doc-model-id"]]=r),r instanceof c.Doc.Curve&&(0===r.paths.length&&r.readPath(),r.paths.forEach(function(e){return e.updateSegments()}),r.updateSvgPath()),r}return"currentLayer"===e&&(i=t),"selectedElements"===e&&(a=t),t}))instanceof c.Doc.Document){var t=e;t.currentLayer=s[i],a.forEach(function(e){t.selectedElements.push(s[e])});for(var n=t.rulers.length-1;0<=n;n--)t.rulers[n].isTemp&&t.rulers.splice(n,1)}return e};var l=new xp.Dictionary([c.Doc.Document,c.Doc.Group,c.Doc.Layer,c.Doc.Curve,c.Doc.Path,c.Doc.Image,c.Doc.Ruler,c.Doc.Text].map(function(e){return{key:e.toString().match(/^function\s*(.*?)\s*\(/)[1],value:e}}))}(c.Json||(c.Json={}))}(Inker=Inker||{}),function(p){var C;function n(e,t,n,o){var t=function(e,t){e.paths.slice(0).concat(t.paths.slice(0)).forEach(T),e.paths.slice(0).concat(t.paths.slice(0)).forEach(function(e){return e.updateSegments()});var n=[],o=[];e.paths.forEach(function(e){var a={path:e,ints:[]};n.push(a),t.paths.forEach(function(t){var s=o.filter(function(e){return e.path===t})[0];s||(s={path:t,ints:[]},o.push(s)),e.segments.forEach(function(i){t.segments.forEach(function(e){for(var t=M(i,e),n=0;n<t.seg1Ints.length;n++){t.seg1Ints[n].int.t,C.e;var o=t.seg1Ints[n].int.t>1-2*C.e,r=t.seg2Ints[n].int.t<2*C.e;t.seg2Ints[n].int.t,C.e;o||r||(a.ints.push(t.seg1Ints[n]),s.ints.push(t.seg2Ints[n]))}})})})});function r(e,n){return e.map(function(e){var t=I(e.ints,e.path).map(function(e){return e.path}).map(function(e){return{path:e,inner:s(2===e.points.length?Geo.getMidPoint(e.points[0],e.points[1]):e.points[1],n)}});return{path:e.path,subs:t}})}var i=r(n,t),e=r(o,e);return{subs1:i,subs2:e}}(e,t),r=[];t.subs1.forEach(function(e){e.subs.forEach(function(e){n(e)&&r.push(e.path)})}),t.subs2.forEach(function(e){e.subs.forEach(function(e){o(e)&&r.push(e.path)})});var t=function(e){var t=[];for(;0<e.length;){var n=e[0];if(e.shift(),n.isClosed)t.push(n);else{for(var o=new p.Doc.Path,r=n;;){Array.prototype.push.apply(o.segments,r.segments);var i=r.points.slice(0,r.points.length-1);Array.prototype.push.apply(o.points,i);var s=r.points[r.points.length-1];if(!s)throw new Error("Path has no points.");if(s===n.points[0])break;if(0===e.length)throw new Error("No more sub-paths but the search still continues.");if(!(r=e.filter(function(e){return e.points[0]===s||e.points[e.points.length-1]===s})[0]))throw new Error("No path was found with the given endpoint.");r.points[r.points.length-1]===s&&r.reverse(),e.splice(e.indexOf(r),1)}o.isClosed=!0,t.push(o)}}return t}(r),i=new p.Doc.Curve;return i.name=e.name,i.fill=e.fill,i.stroke=e.stroke,t.forEach(function(e){return i.paths.push(e)}),i.paths.forEach(function(e){return e.updateSegments()}),i.isClosed=!0,i}function s(e,t){return 0!==S(e,t)}function S(n,e){e.paths.forEach(T);var o=[],r=[];e.paths.forEach(function(e){e.segments.forEach(function(e){var t=Math.min.apply(null,e.points.map(function(e){return e.x})),e=Math.min.apply(null,e.points.map(function(e){return e.y}));o.push(t),r.push(e)})});function i(e){0<e.t&&(0<=Geo.getQS(a,e.a)?t++:t--)}var s={x:Math.min.apply(null,o)-1,y:Math.min.apply(null,r)-1},t=0,a=Geo.getAngle(n,s);e.paths.forEach(function(e){e.segments.forEach(function(e){var t;e.type!==p.Doc.SegmentType.Straight||(t=Geo.getLinesIntersection(n,s,e.points[0],e.points[1]))&&i({pt:t,a:Geo.getAngle(e.points[0],e.points[1]),t:t.x===e.points[0].x&&t.y===e.points[0].y?0:t.x===e.points[1].x&&t.y===e.points[1].y?1:1/(1+Geo.getLength(t,e.points[1])/Geo.getLength(e.points[0],t))}),e.type===p.Doc.SegmentType.Curve&&Geo.Bezier.getBezier3LineIntersections(e.points,[n,s],C.e).forEach(i)})});e=e.getBBox();if(0!==t&&(n.x<e.left||n.x>e.left+e.width||n.y<e.top||n.y>e.top+e.height))throw new Error("Seems point is outside.");return t}function P(e){T(e);for(var t,n=0,o=e.points[0];t=o,n+=((o=e.pointAfter(o)).x-t.x)*(o.y+t.y),o!==e.points[0];);return n<0}function M(o,r){var e,t,n,i,s,a={seg1Ints:[],seg2Ints:[]};return o.type===p.Doc.SegmentType.Curve&&r.type===p.Doc.SegmentType.Curve?Geo.Bezier.getBezier3Intersections(o.points,r.points,C.e).forEach(function(e){var t={x:e.int1.pt.x,y:e.int1.pt.y,type:e.int1.a===e.int2.a?p.Doc.PointType.Smooth:p.Doc.PointType.Cusp},n={int:e.int1,seg:o,pt:t,other:null},t={int:e.int2,seg:r,pt:t,other:n};n.other=t,a.seg1Ints.push(n),a.seg2Ints.push(t)}):o.type===p.Doc.SegmentType.Straight&&r.type===p.Doc.SegmentType.Straight?(e=Geo.getLinesIntersection(o.points[0],o.points[1],r.points[0],r.points[1]))&&(n={x:e.x,y:e.y,type:p.Doc.PointType.Cusp},t={int:{pt:e,a:Geo.getAngle(o.points[0],o.points[1]),t:Geo.getLength(o.points[0],e)/(Geo.getLength(o.points[0],e)+Geo.getLength(e,o.points[1]))},seg:o,pt:n,other:null},n={int:{pt:e,a:Geo.getAngle(r.points[0],r.points[1]),t:Geo.getLength(r.points[0],e)/(Geo.getLength(r.points[0],e)+Geo.getLength(e,r.points[1]))},seg:r,pt:n,other:t},t.other=n,a.seg1Ints.push(t),a.seg2Ints.push(n)):o.type===p.Doc.SegmentType.Straight?(i=Geo.Bezier.getBezier3LineIntersections(r.points,o.points,C.e),s=Geo.getAngle(o.points[0],o.points[1]),i.forEach(function(e){var t={x:e.pt.x,y:e.pt.y,type:e.a===s?p.Doc.PointType.Smooth:p.Doc.PointType.Cusp},n={int:{pt:e.pt,a:s,t:Geo.getLength(o.points[0],e.pt)/(Geo.getLength(o.points[0],e.pt)+Geo.getLength(e.pt,o.points[1]))},seg:o,pt:t,other:null},t={int:e,seg:r,pt:t,other:n};n.other=t,a.seg1Ints.push(n),a.seg2Ints.push(t)})):(i=Geo.Bezier.getBezier3LineIntersections(o.points,r.points,C.e),s=Geo.getAngle(r.points[0],r.points[1]),i.forEach(function(e){var t={x:e.pt.x,y:e.pt.y,type:e.a===s?p.Doc.PointType.Smooth:p.Doc.PointType.Cusp},n={int:e,seg:o,pt:t,other:null},t={int:{pt:e.pt,a:s,t:Geo.getLength(r.points[0],e.pt)/(Geo.getLength(r.points[0],e.pt)+Geo.getLength(e.pt,r.points[1]))},seg:r,pt:t,other:n};n.other=t,a.seg1Ints.push(n),a.seg2Ints.push(t)})),a}function I(e,r){var t=[];e.sort(function(e,t){var n=r.segments.indexOf(e.seg),o=r.segments.indexOf(t.seg);return o<n?1:n<o?-1:e.int.t>t.int.t?1:e.int.t<t.int.t?-1:0});for(var n=0;n<e.length;n++){var o=e[n],i=n===e.length-1?e[0]:e[n+1],s=new p.Doc.Path;if(o.seg===i.seg&&o.int.t<i.int.t)(a=o.seg).type===p.Doc.SegmentType.Straight?(s.points.push(o.pt,i.pt),s.segments.push({type:p.Doc.SegmentType.Straight})):(c=Geo.Bezier.splitBezier3Segment(a.points,o.int.t).seg2,c=Geo.Bezier.splitBezier3Segment(c,(i.int.t-o.int.t)/(1-o.int.t)).seg1,c=Geo.Bezier.bezier3Pt(.5,c),o.int.t,i.int.t,s.points.push(o.pt,{x:c.x,y:c.y,type:p.Doc.PointType.Smooth},i.pt),s.segments.push({type:p.Doc.SegmentType.Curve},{type:p.Doc.SegmentType.Curve}));else{s.points.push(o.pt),s.segments.push({type:o.seg.type});for(var a=r.segmentAfter(o.seg);a!==i.seg;a=r.segmentAfter(a))s.points.push(r.pointBefore(a)),s.segments.push(a);if(s.points.push(r.pointBefore(i.seg)),s.points.push(i.pt),s.segments.push({type:i.seg.type}),s.points.length<=s.segments.length)throw new Error("Error!");s.segments[0].type===p.Doc.SegmentType.Curve&&(l=Geo.Bezier.bezier3Pt((1+o.int.t)/2,o.seg.points),s.points.splice(1,0,{x:l.x,y:l.y,type:p.Doc.PointType.Smooth}),s.segments.unshift({type:p.Doc.SegmentType.Curve}));var l,c=s.points.length-1;s.segments[c-1].type===p.Doc.SegmentType.Curve&&(l=Geo.Bezier.bezier3Pt(i.int.t/2,i.seg.points),s.points.splice(c,0,{x:l.x,y:l.y,type:p.Doc.PointType.Smooth}),s.segments.push({type:p.Doc.SegmentType.Curve}))}t.push({path:s,srcPath:r,startInt:o,endInt:i})}return 0===e.length&&t.push({path:r,srcPath:r,startInt:null,endInt:null}),t}function T(e){if(!e.isClosed)throw new Error("Path is not closed.")}(C=p.BooleanOperations||(p.BooleanOperations={})).e=.001,C.unite=function(e,t){return n(e,t,function(e){return!e.inner},function(e){return!e.inner})},C.substract=function(e,t){return n(e,t,function(e){return!e.inner},function(e){return e.inner})},C.intersect=function(e,t){return n(e,t,function(e){return e.inner},function(e){return e.inner})},C.isPointInsideCurve=s,C.isPathClockwise=P,C.removeSelfIntersections=function(n){n.paths.forEach(function(e){T(e),e.updateSegments()});for(var e=[],t=0;t<n.paths.length;t++){var o=e.filter(function(e){return e.path===n.paths[t]})[0];o||(o={path:n.paths[t],ints:[]},e.push(o));for(var r=t;r<n.paths.length;r++){var i=e.filter(function(e){return e.path===n.paths[r]})[0];i||(i={path:n.paths[r],ints:[]},e.push(i));for(var s=0;s<n.paths[t].segments.length-(t===r?1:0);s++)for(var a=n.paths[t].segments[s],l=t===r?s+1:0;l<n.paths[r].segments.length;l++)for(var c=M(a,n.paths[r].segments[l]),p=0;p<c.seg1Ints.length;p++){var h=t!==r,d=t===r&&l===s+1,u=t===r&&0===s&&l===n.paths[r].segments.length-1,f=c.seg1Ints[p].int.t<2*C.e,m=c.seg1Ints[p].int.t>1-2*C.e,g=c.seg2Ints[p].int.t<2*C.e,v=c.seg2Ints[p].int.t>1-2*C.e;(h||d)&&(m||g)||u&&(f||v)||(o.ints.push(c.seg1Ints[p]),i.ints.push(c.seg2Ints[p]))}}}var y=[];e.forEach(function(e){I(e.ints,e.path).forEach(function(e){y.push({path:e.path,startInt:e.startInt,endInt:e.endInt})})}),y.forEach(function(e){e.path.points[0]={x:e.path.points[0].x,y:e.path.points[0].y,type:e.path.points[0].type},e.path.points[e.path.points.length-1]={x:e.path.points[e.path.points.length-1].x,y:e.path.points[e.path.points.length-1].y,type:e.path.points[e.path.points.length-1].type}});for(var x,w,b=[];0<y.length;)if(x||(x=y.shift(),w=x.endInt),x.path.isClosed)b.push(x.path),x=null;else{if(x.startInt.other!==w){var E=y.filter(function(e){return e.startInt&&e.startInt.other===w})[0];if(!E)throw new Error("No sub-path found.");y.splice(y.indexOf(E),1),Array.prototype.push.apply(x.path.points,E.path.points.slice(1)),Array.prototype.push.apply(x.path.segments,E.path.segments),w=E.endInt}x.startInt.other!==w||(x.path.points.pop(),x.path.isClosed=!0,b.push(x.path),x=null)}var k=[];return b.forEach(function(e){var t;e.updateSegments(),2<e.points.length&&(Geo.getMidPoint(Geo.getMidPoint(e.points[0],e.points[1],1-10*C.e),Geo.getMidPoint(e.points[1],e.points[2],10*C.e)),-1!==(t=S(Geo.placePoint(e.points[1],(Geo.getLength(e.points[0],e.points[1])+Geo.getLength(e.points[1],e.points[2]))*C.e,Geo.getMidAngle(Geo.getAngle(e.segments[0].points[e.segments[0].points.length-2],e.segments[0].points[e.segments[0].points.length-1]),Geo.getAngle(e.segments[1].points[0],e.segments[1].points[1]))+Math.PI/2*(P(e)?1:-1)),n))&&1!==t&&0!==t||k.push(e))}),n.paths.splice(0),k.forEach(function(e){e.updateSegments(),n.paths.push(e)}),n}}(Inker=Inker||{});var app=new Inker.Application;xp.Log.DisplayMessages=0,app.start(),window.addEventListener("contextmenu",function(e){e.preventDefault()});