let t={shapesType:["triangles"],shapesNumber:40,shapesAlpha:.7,autoAdjustShapesAlpha:!0,workingSize:128,backgroundColor:"#ffffff",shapesPerIteration:100,maxMutations:16,seed:100,overflow:"visible",renderAs:"paths",geometryPrecision:3,transformPrecision:6},e=null;globalThis.addEventListener("message",(async l=>{let o=(await import("/modules/seed-random/seed-random.js")).default,[f,M]=l.data;M=i(t,M),e=new c(f,M,o);let{geometryPrecision:w,transformPrecision:g}=M;globalThis.postMessage([0,`<svg viewBox="0 0 ${f.width} ${f.height}">`]),e.onStep=t=>{let i=e.getProgress(),l=`style="fill: ${s(t.color[0],t.color[1],t.color[2],t.alpha)};"`,o="";if(t.shape instanceof p){let i=t.shape.points.map((([t,i])=>new DOMPoint(t*e.scale,i*e.scale)));if("cut"===M.overflow){let t=new DOMRect(0,0,f.width,f.height);i=u(t,i),i=i.map((({x:t,y:e})=>new DOMPoint(r(t,w),r(e,w))))}let[s,...h]=i;o+=`<path ${`d="M ${s.x} ${s.y} `+h.map((({x:t,y:e})=>`L ${t} ${e}`)).join(" ")+' Z"'} ${l}></path>`}else if(t.shape instanceof $){let i=t.shape.bbox.left*e.scale,s=t.shape.bbox.top*e.scale,c=t.shape.bbox.width*e.scale,p=t.shape.bbox.height*e.scale,$=null;if(0!==t.shape.angle){let e=new DOMPoint(i+c/2,s+p/2);$=new DOMMatrix,$.translateSelf(e.x,e.y),$.rotateSelf(n(t.shape.angle)),$.translateSelf(-e.x,-e.y)}if("shapes"===M.renderAs){i=r(i,w),s=r(s,w),c=r(c,w),p=r(p,w);let t="";$&&(t='transform="'+h(a($,g))+'"'),o=`<rect x="${i}" y="${s}" width="${c}" height="${p}" ${t} ${l}></rect>`}else if("paths"===M.renderAs)if("visible"===M.overflow){let t='d="'+[["M",i,s],["H",i+c],["V",s+p],["H",i],["V",s],["Z"]].map((t=>t.join(" "))).join(" ")+'"',e="";$&&(e='transform="'+h(a($,g))+'"'),o+=`<path ${t} ${e} ${l}></path>`}else if("cut"===M.overflow){let t=new DOMRect(0,0,f.width,f.height),e=[new DOMPoint(i,s),new DOMPoint(i+c,s),new DOMPoint(i+c,s+p),new DOMPoint(i,s+p)];$&&(e=e.map((t=>t.matrixTransform($)))),e=u(t,e),e=e.map((({x:t,y:e})=>new DOMPoint(r(t,w),r(e,w))));let[h,...n]=e,a=`d="M ${h.x} ${h.y} `+n.map((({x:t,y:e})=>`L ${t} ${e}`)).join(" ")+' Z"';o+=`<path ${a} ${l}></path>`}}globalThis.postMessage([i,o])},e.onEnd=t=>{globalThis.postMessage([1,"</svg>"])},e.start()}));let i=(t,e)=>{let i={};for(let[s,h]of Object.entries(t))i[s]=void 0!==e[s]?e[s]:t[s];return i},s=(t,e,i,s)=>{let h=t=>{let e=t.toString(16);return 1==e.length?"0"+e:e};return 1===s?"#"+h(t)+h(e)+h(i):`rgba(${t},${e},${i},${s=r(s,2)})`},h=t=>`matrix(${t.a}, ${t.b}, ${t.c}, ${t.d}, ${t.e}, ${t.f})`,n=t=>t*(180/Math.PI),r=(t,e=0)=>{let i=Math.pow(10,e);return Math.round((t+Number.EPSILON)*i)/i},a=(t,e)=>t.is2D?new DOMMatrix([r(t.a,e),r(t.b,e),r(t.c,e),r(t.d,e),r(t.e,e),r(t.f,e)]):new DOMMatrix([r(t.m11,e),r(t.m12,e),r(t.m13,e),r(t.m14,e),r(t.m21,e),r(t.m22,e),r(t.m23,e),r(t.m24,e),r(t.m31,e),r(t.m32,e),r(t.m33,e),r(t.m34,e),r(t.m41,e),r(t.m42,e),r(t.m43,e),r(t.m44,e)]),l=(t,e,i)=>Math.max(e,Math.min(i,t)),o=(t,e)=>Math.sqrt(t/(3*e))/255,u=(t,e)=>{let i,s=(t,e,i,s)=>8&i?new DOMPoint(t.x+(e.x-t.x)*(s.height-t.y)/(e.y-t.y),s.height):4&i?new DOMPoint(t.x+(e.x-t.x)*(s.y-t.y)/(e.y-t.y),s.y):2&i?new DOMPoint(s.width,t.y+(e.y-t.y)*(s.width-t.x)/(e.x-t.x)):1&i?new DOMPoint(s.x,t.y+(e.y-t.y)*(s.x-t.x)/(e.x-t.x)):null,h=(t,e)=>{let i=0;return t.x<e.x?i|=1:t.x>e.width&&(i|=2),t.y<e.y?i|=4:t.y>e.height&&(i|=8),i};for(let n=1;n<=8;n*=2){let r=e[e.length-1],a=!(h(r,t)&n);i=[];for(let l=0;l<e.length;l++){let o=e[l],u=!(h(o,t)&n);u!==a&&i.push(s(r,o,n,t)),u&&i.push(o),r=o,a=u}if(!(e=i).length)break}return i};class c{#t=0;#e=0;#i=0;#s;constructor(t,e,i){let s=Math.max(t.width/e.workingSize,t.height/e.workingSize,1),h=t.width/s,n=t.height/s,r=new f(h,n,e.backgroundColor);r.context.drawImage(t,0,0,h,n),this.options=e,this.scale=s,this.getRandomNumber=new i(e.seed),this.onStep=()=>{},this.onEnd=()=>{},this.#t=r.width,this.#e=r.height,this.#s=new M(r,new f(this.#t,this.#e,e.backgroundColor))}getProgress(){return r(this.#i/this.options.shapesNumber,2)}getRandomNumber(){}getRandomPoint(t,e){return[~~(this.getRandomNumber()*t),~~(this.getRandomNumber()*e)]}start(){this.#h()}async#h(){let t=await this.#n();t=await this.#r(t),this.#i+=1,t.distance<this.#s.distance&&(this.#s=t.apply(this.#s),this.onStep(t)),this.#a()}#a(){this.#i<this.options.shapesNumber?setTimeout((()=>this.#h()),10):this.onEnd(this.#s)}#n(){let t=this.options.shapesPerIteration,e=null,i=[];for(let s=0;s<t;s+=1){let t,s=Math.floor(this.getRandomNumber()*this.options.shapesType.length),h=this.options.shapesType[s];"triangles"===h?t=p:"rectangles"===h&&(t=$);let n=new t(this.#t,this.#e,this);n.init();let r=new w(n,this).compute(this.#s).then((t=>{(!e||t.distance<e.distance)&&(e=t)}));i.push(r)}return Promise.all(i).then((()=>e))}#r(t){let e=this.options.maxMutations,i=0,s=null,h=t,n=new Promise((t=>s=t)),r=()=>{if(i>=e)return s(h);h.mutate().compute(this.#s).then((t=>{t.distance<h.distance?(i=0,h=t):i+=1,r()}))};return r(),n}}class f extends OffscreenCanvas{#l=null;constructor(t,e,i){super(t,e),this.context=this.getContext("2d"),i&&(this.context.fillStyle=i,this.context.fillRect(0,0,t,e))}drawStep(t){this.context.globalAlpha=t.alpha,this.context.fillStyle=`rgb(${t.color[0]}, ${t.color[1]}, ${t.color[2]})`,this.context.strokeStyle=`rgb(${t.color[0]}, ${t.color[1]}, ${t.color[2]})`,t.shape.render(this.context)}getImageData(){return this.#l||(this.#l=this.context.getImageData(0,0,this.width,this.height)),this.#l}getDifference(t){let e=this.getImageData(),i=t.getImageData(),s=0;for(let t=0;t<e.data.length;t+=1)if(t%4!=3){let h=i.data[t]-e.data[t];s+=h*h}return s}getDistance(t){let e=this.getDifference(t);return o(e,this.width*this.height)}clone(){let t=new f(this.width,this.height);return t.context.drawImage(this,0,0),t}}class M{constructor(t,e,i=Infinity){this.sourceCanvas=t,this.destCanvas=e,this.distance=Infinity===i?t.getDistance(e):i}}class w{#o=null;shape=null;alpha=null;color=[0,0,0];distance=Infinity;constructor(t,e){this.#o=e,this.shape=t,this.alpha=this.#o.options.shapesAlpha}apply(t){let e=t.destCanvas.clone();return e.drawStep(this),new M(t.sourceCanvas,e,this.distance)}mutate(){let t=this.shape.mutate(),e=new w(t,this.#o);if(this.#o.options.autoAdjustShapesAlpha){let t=this.alpha+.08*(this.#o.getRandomNumber()-.5);e.alpha=l(t,.1,1)}return e}compute(t){let e={shape:this.shape.rasterize(this.alpha).getImageData(),current:t.destCanvas.getImageData(),target:t.sourceCanvas.getImageData()},i=t.destCanvas.width*t.destCanvas.height,s=this.shape.bbox,h=this.#u(s,e,this.alpha),n=this.#c(s,e,h),r=((t,e)=>Math.pow(255*t,2)*(3*e))(t.distance,i);return this.color=[...h],this.distance=o(r+n,i),Promise.resolve(this)}#c(t,e,i){let s,h,n,r,a,l,o,u,c,f,M,w,p,$,{shape:g,current:m,target:d}=e,P=g.data,b=m.data,y=d.data,D=g.width,O=g.height,x=m.width,I=m.height;var v=0;for(M=0;M<O;M+=1)if($=M+t.top,!($<0||$>=I))for(f=0;f<D;f+=1)p=t.left+f,p<0||p>=x||(c=4*(f+M*D),s=P[c+3],0!==s&&(w=4*(p+$*x),s/=255,h=1-s,n=y[w]-b[w],r=y[w+1]-b[w+1],a=y[w+2]-b[w+2],l=y[w]-(i[0]*s+b[w]*h),u=y[w+1]-(i[1]*s+b[w+1]*h),o=y[w+2]-(i[2]*s+b[w+2]*h),v-=n*n+r*r+a*a,v+=l*l+u*u+o*o));return v}#u(t,e,i){let s,h,n,r,a,o,{shape:u,current:c,target:f}=e,M=u.data,w=c.data,p=f.data,$=u.width,g=u.height,m=c.width,d=c.height,P=[0,0,0],b=0;for(n=0;n<g;n+=1)if(o=n+t.top,!(o<0||o>=d))for(h=0;h<$;h+=1)a=t.left+h,a<0||a>=m||(s=4*(h+n*$),0!==M[s+3]&&(r=4*(a+o*m),P[0]+=(p[r]-w[r])/i+w[r],P[1]+=(p[r+1]-w[r+1])/i+w[r+1],P[2]+=(p[r+2]-w[r+2])/i+w[r+2],b+=1));return P.map((t=>~~(t/b))).map((t=>l(t,0,255)))}}class p{w=0;h=0;count=3;bbox={};points=null;#o=null;constructor(t,e,i){this.w=t,this.h=e,this.#o=i}init(){return this.points=this.#f(),this.computeBBox(),this}render(t){t.beginPath(),this.points.forEach((([e,i],s)=>{s?t.lineTo(e,i):t.moveTo(e,i)})),t.closePath(),t.fill()}mutate(){let t=new p(0,0,this.#o);t.points=this.points.map((t=>t.slice()));let e=Math.floor(this.#o.getRandomNumber()*this.points.length),i=t.points[e],s=2*this.#o.getRandomNumber()*Math.PI,h=20*this.#o.getRandomNumber();return i[0]+=~~(h*Math.cos(s)),i[1]+=~~(h*Math.sin(s)),t.computeBBox()}computeBBox(){let t=[this.points.reduce(((t,e)=>Math.min(t,e[0])),Infinity),this.points.reduce(((t,e)=>Math.min(t,e[1])),Infinity)],e=[this.points.reduce(((t,e)=>Math.max(t,e[0])),-Infinity),this.points.reduce(((t,e)=>Math.max(t,e[1])),-Infinity)];return this.bbox={left:t[0],top:t[1],width:e[0]-t[0]||1,height:e[1]-t[1]||1},this}#f(){let t=this.#o.getRandomPoint(this.w,this.h),e=[t];for(let i=1;i<this.count;i+=1){let i=2*this.#o.getRandomNumber()*Math.PI,s=20*this.#o.getRandomNumber();e.push([t[0]+~~(s*Math.cos(i)),t[1]+~~(s*Math.sin(i))])}return e}rasterize(t){let e=new f(this.bbox.width,this.bbox.height),i=e.context;return i.fillStyle="#000",i.globalAlpha=t,i.translate(-this.bbox.left,-this.bbox.top),this.render(i),e}}class ${bbox={};w=0;h=0;angle=0;count=4;points=null;#o=null;constructor(t,e,i){this.w=t,this.h=e,this.#o=i}init(){return this.points=this.#f(),this.computeBBox(),this}render(t){t.save();let e=((...t)=>{let e=t.reduce(((t,e)=>[t[0]+e[0],t[1]+e[1]]));return[e[0]/t.length,e[1]/t.length]})(this.points[0],this.points[2]);t.translate(e[0],e[1]),t.rotate(this.angle),t.translate(-e[0],-e[1]),t.beginPath(),this.points.forEach((([e,i],s)=>{s?t.lineTo(e,i):t.moveTo(e,i)})),t.closePath(),t.fill(),t.restore()}mutate(){let t=new $(0,0,this.#o);t.points=this.points.map((t=>t.slice()));let e=~~(20*(this.#o.getRandomNumber()-.5));switch(Math.floor(8*this.#o.getRandomNumber())){case 0:t.points[0][0]+=e,t.points[3][0]+=e;break;case 1:t.points[0][1]+=e,t.points[1][1]+=e;break;case 2:t.points[1][0]+=e,t.points[2][0]+=e;break;case 3:t.points[2][1]+=e,t.points[3][1]+=e;break;case 4:case 5:case 6:case 7:t.angle=(e/20+.5)*Math.PI}return t.computeBBox()}computeBBox(){let t=[this.points.reduce(((t,e)=>Math.min(t,e[0])),Infinity),this.points.reduce(((t,e)=>Math.min(t,e[1])),Infinity)],e=[this.points.reduce(((t,e)=>Math.max(t,e[0])),-Infinity),this.points.reduce(((t,e)=>Math.max(t,e[1])),-Infinity)];return this.bbox={left:t[0],top:t[1],width:e[0]-t[0]||1,height:e[1]-t[1]||1},this}#f(){let t=this.#o.getRandomPoint(this.w,this.h),e=this.#o.getRandomPoint(this.w,this.h),i=Math.min(t[0],e[0]),s=Math.max(t[0],e[0]),h=Math.min(t[1],e[1]),n=Math.max(t[1],e[1]);return[[i,h],[s,h],[s,n],[i,n]]}rasterize(t){let e=new f(this.bbox.width,this.bbox.height),i=e.context;return i.fillStyle="#000",i.globalAlpha=t,i.translate(-this.bbox.left,-this.bbox.top),this.render(i),e}}