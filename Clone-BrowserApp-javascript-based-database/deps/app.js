var sql,showConfirmation=function(a,c,b){$("#dialog_confirmation p").text(a);$("#dialog_confirmation_accept").unbind(".confirm-dialog").bind("click.confirm-dialog",b);$("#dialog_confirmation").openModal({out_duration:100,in_duration:150})},errorToast=function(a){Materialize.toast(i18n.getMessage("msg_error",a),2E3)},AppUi=function(){var a=function(a){$(".contentTab").hide();$(".sidebar a").removeClass("active");$(this).addClass("active");if("btnRunSql"==$(this).attr("id"))RunSql.show();else{a=$(this).parent().index();
var b=$(this).children("span").text();switch(a){case 2:Tables.show(b);break;case 5:Views.show(b);break;case 7:Indexes.show(b);break;case 9:Triggers.show(b)}}};return{reload:function(c){sql.send({action:"reload"},function(b){var e=$("#btnRunSql").unbind("click").click(a),f=$(".sidebar .db_entries"),f={table:[f.eq(0).empty(),"view_compact"],view:[f.eq(2).empty(),"web"],index:[f.eq(3).empty(),"list"],trigger:[f.eq(4).empty(),"settings_ethernet"]};if(b[0]){b=b[0].values;for(var h=0;h<b.length;h++){var p=
b[h][0],v=b[h][1],x=f[v];x&&(v=$('<a class="waves-effect"/>').attr("type",v).appendTo(x[0]).click(a).append($('<i class="material-icons small left"/>').text(x[1])).append($("<span/>").text(p)),c&&p==c&&(e=v))}}e.click()})}}}(),moreOptionsClicked=function(a,c){switch(a){case 0:FileIO.open(openDb);break;case 1:AppUi.reload();break;case 2:DbSettings.show();break;case 4:var b={preserveBlobs:!0,action:"export"},e;switch(c){case 0:b.type=["table"];b.includeDrop=!0;b.includeData=!0;e="tables.sql";break;
case 1:b.type=["table","view","index","trigger"];b.includeDrop=!0;b.includeData=!0;e="database.sql";break;case 2:b.type=["table","view","index","trigger"],e="dbstructure.sql"}if(!e)break;FileIO.save(b,e);break;case 5:FileIO.open(importSql,!0)}},openDb=function(a,c){var b=new SQL(a,function(e){e.error?(errorToast(e.error),b.terminate()):(sql.terminate(),sql=b,sql.saveTarget=c,AppUi.reload(),$("#size-menu label").text(a.name))})},saveDB=function(){FileIO.save({preserveBlobs:!0,action:"exportDB"},$("#size-menu label").text(),
sql.saveTarget)},importSql=function(){var a=function(a){$("#start_sql_import").hasClass("disabled")||($("#import_sql p").hide(),$("#start_sql_import").addClass("disabled"),$("#import_sql .progress").show().children().css("width","0%"),$("#btn_cancel_import").hide(),sql.send({preserveBlobs:!0,action:"import",transaction:$("#chkTransaction").is(":checked"),file:a},c))},c=function(a){void 0!=a.progress?$("#import_sql .progress > div").css("width",100*a.progress+"%"):(a.error?($("#import_sql .progress").hide(),
$("#import_sql pre").show().text(a.error),$("#import_sql b").show().text(void 0!=a.line?i18n.getMessage("msg_error_at_line",[a.line]):i18n.getMessage("msg_error_import")),$("#btn_cancel_import").show()):($("#import_sql").closeModal(),Materialize.toast(i18n.getMessage("msg_import_complete"),2E3)),AppUi.reload())};return function(b){$("#import_sql h4").text(i18n.getMessage("title_import",b.name));$("#import_sql p").show().children("input").attr("checked","checked");$("#import_sql .progress, #import_sql b, #import_sql pre").hide();
$("#btn_cancel_import").show();$("#start_sql_import").removeClass("disabled").unbind(".appui").bind("click.appui",a.bind(this,b));$("#import_sql").openModal({out_duration:100,in_duration:150,dismissible:!1})}}();
$(function(){i18n.onLoad(function(){$("[i18n-id]").each(function(){var a=i18n.getMessage($(this).attr("i18n-id"));$(this).attr("i18n-attr")?$(this).attr($(this).attr("i18n-attr"),a):$(this).text(a)});sql=new SQL(null,AppUi.reload);$("#btn_add_table").click(Tables.showAdd);window.Hammer||(window.Hammer=function(){},window.Hammer.prototype.on=function(){});var a=new PopupMenu("menu_open","menu_reload","title_db_properties",null,["menu_export","menu_export_tables","menu_export_db","menu_export_db_structure"],
"title_import_sql");a.attachTo($("#app_more_options"));a.onPopupItemClicked=moreOptionsClicked;$("#save-db").click(saveDB)})});
var DbSettings=function(){var a={},c,b=function(a){var b=$(this).val();b.match(/^\-?[0-9]+$/)&&parseInt(b)>=parseInt($(this).attr("min"))?$(this).attr("last-number-input",$(this).val()):(a.stopPropagation(),a.preventDefault(),$(this).val($(this).attr("last-number-input")).change())},e=function(){var a={};$("#db_settings input").each(function(){var b=$(this).attr("property-name");if(b){var c=$(this).attr("original-value"),e=$(this).is("[type='checkbox']")?$(this).is(":checked")?"1":"0":$(this).val();
c!=e&&(a[b]=e)}});return a},f=function(){$.isEmptyObject(e())?$("#accept_db_settings").addClass("disabled"):$("#accept_db_settings").removeClass("disabled")},h=function(){if(!$(this).hasClass("disabled")){var a=e();$(this).addClass("disabled");if(!$.isEmptyObject(a)){$("#db_settings input").attr("disabled","disabled");var b="",c;for(c in a)b+="PRAGMA "+c+" = "+a[c]+";";sql.send({action:"exec",preserveBlobs:!0,sql:b},function(a){a.error?(errorToast(a.error),$("#db_settings input").removeAttr("disabled"),
$("#accept_db_settings").removeClass("disabled")):(Materialize.toast(i18n.getMessage("msg_db_properties_updated"),1E3),$("#db_settings").closeModal())})}}},p=function(){$("#db_settings tbody").empty();for(var b in a)a[b].remove()};return{show:function(){c||(c={db_setting_section_versioning:{schema_version:0,user_version:0,application_id:0},db_setting_section_pages_or_sizes:{page_size:"512 1024 2048 4096 8192 16384 32768 65536".split(" "),page_count:1,max_page_count:0,journal_mode:"Delete Truncate Persist Memory Wal Off".split(" "),
journal_size_limit:-1,wal_autocheckpoint:0,cache_size:0,cache_spill:2},db_setting_section_file_io:{legacy_file_format:2,locking_mode:["Normal","Exclusive"],query_only:2,secure_delete:2,synchronous:["Off","Normal","Full"],mmap_size:0},db_setting_section_others:{auto_vacuum:["None","Full","Incremental"],automatic_index:2,busy_timeout:0,foreign_keys:2,defer_foreign_keys:2,encoding:1,read_uncommitted:2,recursive_triggers:2,reverse_unordered_selects:2}});$("#db_settings tbody").empty();$("#accept_db_settings").addClass("disabled").unbind("click").click(h);
var e="",x;for(x in c)for(var A in c[x])e+="PRAGMA "+A+";";sql.send({action:"exec",preserveBlobs:!0,sql:e},function(e){if(e.error)errorToast(e.error);else{var n=$("#db_settings tbody"),g=0,d;for(d in c){var h=c[d];$("<td colspan=2>").appendTo($("<tr/>").appendTo(n)).text(i18n.getMessage(d));for(var B in h){var w=h[B],u=e[g++].values[0][0],r=$("<tr/>").appendTo(n).append($("<td/>").text(i18n.getMessage("db_setting_"+B))),r=$("<td>").appendTo(r),t;if(w.constructor==Array){t=$('<input type="text" readonly>').appendTo(r);
$("<span/>").appendTo(r.addClass("combo-box"));r=a[B];r||(r=new PopupMenu,r.items=w,r.translated=!0,a[B]=r);for(var q=0;q<r.items.length;q++)r.items[q].toUpperCase()==(u+"").toUpperCase()&&t.val(r.items[q]);""==t.val()&&("number"==typeof u&&r.items[u]?t.val(r.items[u]):t.val(r.items[0]));u=t.val();r.attachTo(t)}else switch(w){case 0:case -1:t=$('<input type="number">').appendTo(r).val(u).attr("min",w);t.attr("last-number-input",t.val()).change(b);break;case 1:t=$('<input type="text" readonly>').appendTo(r).val(u);
break;case 2:t=$('<div class="switch"><label>'+i18n.getMessage("label_off")+' <input type="checkbox"><span class="lever"></span> '+i18n.getMessage("label_on")+"</label></div>").appendTo(r).find("input"),1==u&&t.attr("checked","checked")}1!=w&&t.attr("property-name",B).attr("original-value",u).change(f)}}}});$("#db_settings").openModal({out_duration:100,in_duration:120,dismissible:!1,complete:p})}}}(),FileIO=function(){var a=function(a){var b=$("<input type='file' />");b.change(function(){this.files&&
this.files[0]&&a&&a(this.files[0])});b.click()},c=function(a,b){var c=$("<a/>").get(0);c.download=b;sql.send(a,function(a){a.error?errorToast(a.error):(a=URL.createObjectURL(a.blob),c.href=a,c.dispatchEvent(new MouseEvent("click")),URL.revokeObjectURL(a))})},b=function(a,b){var c=$("<a/>").get(0);c.download=b;c.href=a;window.setTimeout(function(){c.dispatchEvent(new MouseEvent("click"))},10)},e=function(a,b){chrome.fileSystem.chooseEntry({type:b?"openFile":"openWritableFile"},function(b){b&&b.file(function(n){return a(n,
b)})})},f=function(a,b){var c=function(a,b){var c=Date.now(),e=function(){a.readyState===a.WRITING&&4E3>Date.now()-c?setTimeout(e,100):a.readyState===a.WRITING?(console.error("Write operation taking too long, aborting! (current writer readyState is "+a.readyState+")"),a.abort()):b()};setTimeout(e,100)};b(function(b){a.createWriter(function(a){a.truncate(b.size);c(a,function(){a.onwriteend=function(){Materialize.toast(i18n.getMessage("msg_file_saved"),1E3)};a.seek(0);a.write(b)})})})},h=function(a){return function(b){sql.send(a,
function(a){a.error?errorToast(a.error):b(a.blob)})}},p=function(a,b,c){c?f(c,h(a)):chrome.fileSystem.chooseEntry({type:"saveFile",suggestedName:b},function(b){b&&f(b,h(a))})},v=function(a,b){var c=function(b){var c=new XMLHttpRequest;c.open("GET",a,!0);c.responseType="arraybuffer";c.onload=function(a){200==this.status&&b(new Blob([this.response]))};c.send()};chrome.fileSystem.chooseEntry({type:"saveFile",suggestedName:b},function(a){a&&f(a,c)})};return chrome&&chrome.fileSystem?{save:p,open:e,download:v}:
{save:c,open:a,download:b}}(),i18n=function(){if(chrome&&chrome.i18n&&chrome.i18n.getMessage)return{getMessage:chrome.i18n.getMessage,onLoad:function(a){a()}};var a;if(navigator.languages)a=navigator.languages;else{var c=navigator.userLanguage||navigator.language;"string"==typeof c&&(a=[c],0<c.indexOf("-")&&a.push(c.substr(0,c.indexOf("-"))))}0>a.indexOf("en")&&a.push("en");c=$.when.apply($,a.map(function(b,c){var f=$.Deferred();a[c]={};$.getJSON("_locales/"+b+"/messages.json").done(function(b){a[c]=
b}).always(function(){f.resolve()});return f}));c.done(function(){a.reverse();a=$.extend.apply($,a)});return{getMessage:function(b,c){var f;if(a[b])f=a[b].message;else return"";if(void 0==c||null==c)return f;c.constructor!=Array&&(c=[c]);return f.replace(/\$\d+/g,function(a){a=parseInt(a.substring(1))-1;return void 0!=c[a]?c[a]:""})},onLoad:c.done}}(),SQL=function(a,c){this._counter=0;this.callbacks={};var b=this;this.worker=new Worker("worker/sql.worker.js");this.worker.onmessage=function(a){b._handleResponse(a.data)};
this.send({action:"open",file:a},c)};SQL.prototype._handleResponse=function(a){this.callbacks[a.id]&&(this.callbacks[a.id](a),a.partialResponse||delete this.callbacks[a.id])};SQL.prototype.send=function(a,c){var b=this._counter++;a.id=b;this.callbacks[b]=c;this.worker.postMessage(a)};SQL.prototype.terminate=function(){this.worker.terminate()};var escapeSql=function(a){return"'"+a.replace(/'/g,"''")+"'"};function noop(){}
(function(a){var c,b,e=function(a){return a.closest(".table-container")},f=function(a,b){return a.children().first().children().eq(2*b)},h=function(a,b){return void 0!=b?a.find(".table-body span:nth-child("+(b+1)+")"):h(e(a),a.index()/2)},p=function(b){if(1==b.which){b.preventDefault();var c=(a(this).index()-1)/2,n=e(a(this)),d=n.find(".table-body span:nth-child("+(c+1)+")"),g=a(this).prev(),f=a(this).addClass("active");g.parent().addClass("active");var h=g.width(),l=parseInt(g.css("min-width"),10),
m=b.pageX,k=n.find("resizebar");0==k.length&&(k=a("<resizebar/>").appendTo(n));var z=a(this).position().left+(a(this).width()-k.width())/2;k.css({left:z,transform:a(this).parent().css("transform")}).show();a(document).bind("mousemove.datagrid",function(a){var b=a.pageX-m;b+h<l&&(b=l-h);g.width(h+b);d.width(h+b);k.css("left",z+b);a.preventDefault()}).bind("mouseup.datagrid",function(){a(document).unbind(".datagrid");f.removeClass("active");k.hide();g.parent().removeClass("active")})}},v=function(b){a(this).hasClass("active")||
(a(this).parent().children(".active").removeClass("active"),a(this).parent().parent().data("grid-options").onRowSelect(a(this).addClass("active").index()))},x=function(b){b=a(this).scrollTop();var c=Math.min(b,100)/100;a(this).children().first().css({transform:"translateY("+b+"px)",boxShadow:"0 0 "+4*c+"px rgba(0,0,0,"+.14*c+"), 0 "+4*c+"px "+8*c+"px rgba(0,0,0,"+.28*c+")"})},A=function(b){b.preventDefault();b=e(a(this));var c=b.data("grid-options"),n=c.allowEdit(a(this).index()),d=a(this).data("grid-value");
if(n||null!=d){var g=a("#daragrid_dialog").show().removeClass("has-blob");g.find("h4").text(f(b,a(this).index()).text());var h,p=g.find("img");null!=d&&d.blobType?("blob"==d.blobType?i18n.getMessage("column_type_blob_size",d.length):h=i18n.getMessage("column_type_blob_data",[d.length,d.blobType]),a("#daragrid_dialog_blob").text(h),g.addClass("has-blob"),a("#daragrid_dialog #daragrid_dialog_download").unbind(".datagrid").bind("click.datagrid",function(){FileIO.download(d.blobUrl,a("#daragrid_dialog h4").text()+
"."+d.blobType)}),"gif"!=d.blobType&&"jpg"!=d.blobType&&"png"!=d.blobType||p.attr("src",d.blobUrl)):h=null==d?"":d;var l=a("#daragrid_cell_text").val(h);!n&&g.hasClass("has-blob")||l.keyup().focus().select();var m=function(){a(document).unbind(".datagrid-prompt");g.hide();l.unbind(".datagrid-prompt");p.removeAttr("src")};if(n){g.addClass("allow-edit");l.removeAttr("readOnly").focus().select();var k=a(this),z=function(b){m();var n=[];k.parent().children().each(function(){n.push(a(this).data("grid-value"))});
c.onSave(k.index(),b,n,function(a){D(k,a)})};a("#daragrid_dialog_save").unbind("click").click(function(){a(this).hasClass("disabled")||z(l.val())}).addClass("disabled");l.bind("keyup.datagrid-prompt",function(b){a("#daragrid_dialog_save").removeClass("disabled")});a("#daragrid_dialog_delete").unbind("click").click(function(){z(null)});a("#daragrid_dialog_upload input").remove();a('<input type="file" />').prependTo("#daragrid_dialog_upload").change(function(a){z(this.files[0])})}else g.removeClass("allow-edit"),
l.attr("readonly","readonly");h=a(this).offset();g.css({left:Math.min(a(document).width()-g.width()-10,h.left),bottom:Math.max(a(document).height()-g.height()-h.top,10)});a(document).bind("mousedown.datagrid-prompt",function(b){a.contains(g.get(0),b.target)||m()}).bind("keyup.datagrid-prompt",function(a){27==a.which&&m()})}},C=function(b){b=a(this).parent();a(this).remove();b=b.prev().prev().removeClass("column-hidden");b.index();h(b).removeClass("column-hidden");b.children("column-expand-button").click()},
n=function(b){var c=this.parent();0==b?(c.addClass("column-hidden"),h(c).addClass("column-hidden"),a("<column-expand-button/>").prependTo(c.next().next()).click(C)):g(c)},g=function(b){var n=getComputedStyle(b.get(0),null);c.font=n.font;var d=Math.max(c.measureText(b.text()).width,parseInt(n.minWidth,10)),n=h(b);n.get(0)&&(c.font=getComputedStyle(n.get(0),null).font,n.each(function(){d=Math.max(d,c.measureText(a(this).text()).width)}));n.width(d);b.width(d)},d=function(b){g(a(this).parent())},D=function(a,
b){a.data("grid-value",b);null==b?a.text(i18n.getMessage("column_type_null")).addClass("no-display-value"):b.blobType?a.text(i18n.getMessage("column_type_blob_size",[b.length])).addClass("no-display-value"):a.text(b).removeClass("no-display-value")};a.fn.datagrid=function(g,e){e=a.extend({allowEdit:function(){return!1},onSave:function(){},onRowSelect:function(){},preserveHead:!1},e);c||(c=a("<canvas />").get(0).getContext("2d"),c.imageSmoothingEnabled=!1);b||(b=new PopupMenu("menu_hide_column","menu_auto_size"),
b.onPopupItemClicked=n);var h=this.scrollTop(0).data("grid-options",e).addClass("table-container"),f=g.columns.length,t,q=[],y;if(e.preserveHead)t=h.children(".table-body").empty(),h.children(".header").children("label").each(function(){q.push([a(this).width(),a(this).hasClass("column-hidden")])});else{h.empty().unbind("scroll").scroll(x);for(var l=a("<div>").addClass("header").appendTo(h),m=0;m<f;m++){var k=a("<label>").append(a("<span/>").text(g.columns[m]).dblclick(d)).appendTo(l);a("<resizeend>").html("&nbsp;").appendTo(l).mousedown(p);
b.attachTo(a("<column-menu-button/>").appendTo(k));0==m&&(headFont=getComputedStyle(k.get(0),null),c.font=headFont.font,y=parseInt(headFont.minWidth,10));q[m]=[Math.max(c.measureText(g.columns[m]).width,y),m]}a("<label>").html("<span>&nbsp;</span>").appendTo(l);t=a("<div>").addClass("table-body")}for(m=0;m<g.values.length;m++){y=a("<div>").appendTo(t).click(v);for(l=0;l<f;l++)k=a("<span>").appendTo(y).dblclick(A),D(k,g.values[m][l]),e.preserveHead?(k.width(q[l][0]+5),q[l][1]&&k.addClass("column-hidden")):
(0==m&&0==l&&(c.font=getComputedStyle(k.get(0),null)),q[l][0]=Math.max(c.measureText(k.text()).width,q[l][0]));a("<span>").appendTo(y)}if(!e.preserveHead){l=h.width()-100-26*f;for(m=k=0;m<q.length;m++)k+=q[m][0];f=function(b){return t.children().map(function(){return a(this).children().get(b)})};y=h.children().first().children();if(k<l)for(k=l/k,m=0;m<q.length;m++)l=q[m][0]*k,f(m).css("width",l+26),y.eq(2*m).css("width",l+21);else{q.sort(function(a,b){return a[0]-b[0]});for(var k=l,z=q.length,E=100,
m=0;m<q.length;m++)z--,q[m][0]<E?(l=q[m][0],k-=l,E=0>=z?100:Math.max(100,k/z)):(l=E,k-=l),f(q[m][1]).css("width",l+26),y.eq(2*q[m][1]).css("width",l+21)}t.appendTo(h)}return this};a.fn.datagridRowValues=function(b){var c=[];this.children(".table-body").children().eq(b).children().each(function(){c.push(a(this).data("grid-value"))});return c}})(jQuery);
var PopupMenu=function(){function a(){this.lastShown=null;this.items=$.extend([],arguments)}var c=function(a,b,c){a=$("<ul class='popup-menu' />").appendTo(a);for(var e=0;e<b.length;e++){var h=$("<li/>").appendTo(a);if(null==b[e])h.addClass("separator");else{var f;b[e].constructor===Array?(h.addClass("has-sub-popup").data("popup-children",b[e]),f=b[e][0]):f=b[e];c||(f=i18n.getMessage(f));$("<span class='waves-effect'/>").appendTo(h).text(f)}}return a};a.prototype.attachTo=function(a){var b=f.bind(this,
a);a.is("input")?(a.next().click(b),a.attr("readonly")?(a.click(b),a.keydown(x.bind(this,a,!0))):a.keyup(x.bind(this,a,!1))):a.click(b)};a.prototype.remove=function(){this.el&&(this.el.remove(),this.el=null)};a.prototype.onPopupItemClicked=function(a){};var b=function(a){$(document).unbind(".popup-menu");this.lastShown&&(a?this.el.stop().fadeOut("slow"):this.el.hide(),this.lastShown.removeClass("active").unbind(".popup-menu"),this.lastShown=null,this.lastParents.unbind(".popup-menu"),this.lastParents=
null);this.selectionIndex=-1},e=function(a){a.children(".selected").removeClass("selected").children("ul").hide()},f=function(a,g){if(this.lastShown){if(this.lastShown[0]==a[0]){this.autoShow&&(this.autoShow=g);return}b.call(this)}var d=a.is("input");if(!d||!a.is(":disabled")){this.el||(this.el=c(document.body,this.items,this.translated).addClass(d?"combo_popup":"abs_popup"),d?this.el.find("span").mousedown(C.bind(this)):this.el.find("span").click(h.bind(this)));e(this.el);var f=b.bind(this,!1);if(d){a.is(":focus")||
a.focus();if(a.attr("readonly")){this.selectionIndex=this.items.indexOf(a.val());var p=this.el.children().eq(this.selectionIndex).addClass("selected");this.el.show();d=a.offset();p=p.position();this.el.width(a.parent().outerWidth()).css({left:d.left,top:d.top-p.top}).velocity({translateY:[0,p.top+(a.parent().outerHeight()-this.el.outerHeight())/2],scaleY:[1,a.parent().outerHeight()/this.el.outerHeight()]},{duration:150,easing:"easeOutExpo"})}else d=a.offset(),this.el.width(a.parent().outerWidth()).show().css({left:d.left,
top:d.top+a.height(),maxHeight:$(document).height()-d.top-a.height()-20}).velocity({translateY:[0,-this.el.outerHeight()/2],scaleY:[1,0]},{duration:150,easing:"easeOutExpo"}),this.selectionIndex=-1,this.autoShow=g;a.bind("blur.popup-menu",f)}else{var d=a.offset(),p=Math.max(Math.min($(document).width()-this.el.width()-10,d.left),0),w=Math.max(Math.min(d.top+a.height(),$(document).height()-this.el.outerHeight()),0),u=this.el.css({left:p,top:w}).show().velocity({translateX:[0,d.left-p+(a.outerWidth()-
this.el.outerWidth())/2],translateY:[0,-(a.outerHeight()+this.el.outerHeight())/2],scaleX:[1,a.outerHeight()/this.el.outerHeight()],scaleY:[1,a.outerWidth()/this.el.width()]},{duration:200,easing:"easeOutExpo"});a.addClass("active");$(document).bind("mousedown.popup-menu",function(a){$.contains(u.get(0),a.target)||(a.stopPropagation(),a.preventDefault(),f())})}this.lastParents=a.parents().bind("scroll.popup-menu",f);this.lastShown=a}},h=function(a){var g=$(a.target).parent();if(g.hasClass("has-sub-popup")){e(g.parent());
g.addClass("selected");a=g.children("ul");0==a.length&&(a=g.data("popup-children").slice(1),a=c(g,a,this.translated).addClass("abs_popup"),a.find("span").click(h.bind(this)));e(a);a.show();var d=g.offset(),f=d.left,d=d.top,g=g.width(),v=a.width(),w=a.outerHeight(),u=$(window).height(),w=a.get(0).scrollHeight;d+w<u?(d=-16,a.removeClass("has_scroll").outerHeight(w)):u>=w+16?(d=u-d-w-16,a.removeClass("has_scroll").outerHeight(w)):(d=-d,a.addClass("has_scroll").outerHeight(u));f=f+g+v<$(document).width()?
g:-v;a.css({left:f,top:d}).velocity({translateX:[0,-f/2],opacity:[1,.6]},{duration:200,easing:"easeOutExpo"})}else a=p(g,[]),f=this.lastShown,b.call(this,!0),this.onPopupItemClicked.apply(f,a)},p=function(a,b){b.unshift(a.index());var c=a.parent().parent();c.hasClass("has-sub-popup")&&p(c,b);return b},v=function(a){this.el.children(".selected").removeClass("selected");if(-1==a)this.selectionIndex=-1;else{0>a?a=this.items.length-1:a>=this.items.length&&(a=0);this.selectionIndex=a;var b=this.el.children().eq(a).addClass("selected");
a=b.position().top;var b=b.height(),c=this.el.height();0>a?this.el.scrollTop(this.el.scrollTop()+a):a+b>c&&this.el.scrollTop(this.el.scrollTop()+a+b-c)}},x=function(a,c,d){var e=d.keyCode;if(c&&(32==e&&(e=13),!this.lastShown&&(40==e||38==e||13==e))){f.call(this,a);d.preventDefault();d.stopPropagation();return}switch(e){case 40:f.call(this,a);v.call(this,this.selectionIndex+1);d.preventDefault();d.stopPropagation();break;case 38:f.call(this,a);v.call(this,c&&0==this.selectionIndex?this.items.length-
1:this.selectionIndex-1);d.preventDefault();d.stopPropagation();break;case 13:-1<this.selectionIndex&&a.val(this.el.children().eq(this.selectionIndex).text()).trigger("input").trigger("change");case 27:d.preventDefault();d.stopPropagation();this.lastShown&&27==e&&c&&a.keyup(A);b.call(this);break;default:if(!c&&(!this.lastShown||this.autoShow)){c=a.val().toLocaleLowerCase();if(""!=c)for(d=0;d<this.items.length;d++)if(0==this.items[d].toLocaleLowerCase().indexOf(c)){f.call(this,a,!0);v.call(this,d);
return}b.call(this)}}},A=function(a){27==a.keyCode&&(a.preventDefault(),a.stopPropagation(),$(this).unbind("keyup",A))},C=function(a){a.preventDefault();a.stopPropagation();this.lastShown.val($(a.target).text()).trigger("input").trigger("change").focus();b.call(this)};return a}(),RunSql=function(){function a(a){sql.send({action:"exec",sql:b.getValue()},function(a){a.error?Materialize.toast("Error "+a.error,2E3):a[0]?$("#cardSqlResult").empty().show().datagrid(a[0]):$("#cardSqlResult").empty().hide()})}
var c=!1,b,e=function(a,c){var e=[["SELECT * FROM tableName","SELECT [ALL | DISTINCT] result FROM table-list WHERE expr","SELECT [ALL | DISTINCT] result [FROM table-list] [WHERE expr] [GROUP BY expr-list] [HAVING expr] [compound-op select]* [ORDER BY sort-expr-list] [LIMIT integer [( OFFSET | , ) integer]]"],"DELETE FROM tableName [WHERE expr];INSERT INTO tableName [(column-list)] VALUES(value-list);INSERT INTO tableName [(column-list)] select-statement;UPDATE tableName SET assignment [, assignment]* [WHERE expr];REPLACE INTO tableName [(column-list)] VALUES(value-list);REPLACE INTO tableName [(column-list)] select-statement".split(";"),
["CREATE TABLE IF NOT EXISTS tableName (column-def [, column-def]* [, constraint]*","CREATE TEMP TABLE IF NOT EXISTS tableName (column-def [, column-def]* [, constraint]*","CREATE TABLE tableName AS select-statement","CREATE TEMP TABLE tableName AS select-statement",null,"ALTER TABLE old_tableName RENAME TO new_tableName","ALTER TABLE x ADD COLUMN column-def",null,"CREATE INDEX IF NOT EXISTS indexName ON tableName ( columnName [, columnName]* )","CREATE UNIQUE INDEX IF NOT EXISTS indexName ON tableName ( columnName [, columnName]* )",
"CREATE [TEMPORARY] VIEW IF NOT EXISTS viewName AS selectStatement","CREATE [TEMPORARY] TRIGGER IF NOT EXISTS triggerName [ BEFORE | AFTER ] DELETE|INSERT|UPDATE ON tableName [ FOR EACH ROW ] [ WHEN expression ] BEGIN  semicolon-terminated-update-delete-select-or-insert-statements END"],["DROP TABLE tableName","DROP VIEW viewName","DROP INDEX indexName","DROP TRIGGER triggerName"],["REINDEX tableName","REINDEX indexName","REINDEX collationName"],["PRAGMA table_info (tableName)","PRAGMA index_list (tableName)",
"PRAGMA index_info (indexName)",null,"PRAGMA database_list","PRAGMA collation_list"]];e[a]&&e[a][c]&&(b.setValue(e[a][c]),b.focus())};return{show:function(){$("#contentRunSql").show();if(!c){c=!0;b=CodeMirror.fromTextArea($("#contentCodeMirror").get(0),{mode:"text/x-mariadb",value:"SELECT * FROM mytable",indentWithTabs:!0,lineWrapping:!0,smartIndent:!0,lineNumbers:!0,autofocus:!0,extraKeys:{"Ctrl-Enter":a,"Cmd-Enter":a}});$("#btnExecuteSql").click(a);var f=new PopupMenu(["Select","SELECT * FROM tableName",
"SELECT with WHERE clause","SELECT (general)"],"Data Manipulation;DELETE;INSERT values;INSERT using select;UPDATE;REPLACE values;REPLACE using select".split(";"),["Create / Alter","CREATE TABLE","CREATE TEMP TABLE","CREATE TABLE x AS select-statement","CREATE TEMP TABLE x AS select-statement",null,"ALTER TABLE x RENAME TO y","ALTER TABLE x ADD COLUMN column-def",null,"CREATE INDEX","CREATE UNIQUE INDEX","CREATE VIEW","CREATE TRIGGER"],["Drop","DROP TABLE","DROP VIEW","DROP INDEX","DROP TRIGGER"],
["Reindex","REINDEX tableName","REINDEX indexName","REINDEX collationName"],["PRAGMA","PRAGMA table_info","PRAGMA index_list","PRAGMA index_info",null,"PRAGMA database_list","PRAGMA collation_list"]);f.translated=!0;f.attachTo($("#btnSqlTemplates"));f.onPopupItemClicked=e}}}}();function PropertyManager(a,c,b){this.name=a;this.type=c;this.pragma=b}
PropertyManager.prototype.load=function(a){$("#propertyContent").show();$("#propertySql .card-title").text(this.name);$("#propertyContent .buttonbar").hide();$("#propertyColumns").hide();var c=this;a=$("#propertyCodeMirror");var b=a.data("codemirror");b||(b=CodeMirror.fromTextArea(a.get(0),{mode:"text/x-mariadb",autofocus:!0,readOnly:!0,lineWrapping:!0}),a.data("codemirror",b),b.setValue(""));a="SELECT sql FROM sqlite_master where name = "+escapeSql(this.name);this.pragma&&(a=a+"; PRAGMA "+this.pragma+
"("+escapeSql(this.name)+");");sql.send({action:"exec",sql:a},function(a){a.error?errorToast(a.error):a[0]?(c.success=!0,$("#propertyContent .buttonbar").show(),$("#btn_property_delete").unbind(".property-manager").bind("click.property-manager",c.confirmDelete.bind(c)),b.setValue(a[0].values[0][0]),a[1]&&($("#propertyColumns").show(),$("#propertyColumns .table-container").datagrid(a[1]))):(Materialize.toast(i18n.getMessage("msg_error_property_not_found",[c.type,c.name]),2E3),AppUi.reload())})};
PropertyManager.prototype.confirmDelete=function(){showConfirmation(i18n.getMessage("msg_confirm_delete_property",[this.type,this.name]),i18n.getMessage("btn_delete"),this.deleteItem.bind(this))};PropertyManager.prototype.deleteItem=function(){sql.send({action:"exec",sql:"drop "+this.type+" if exists "+escapeSql(this.name)},function(a){a.error?errorToast(a.error):AppUi.reload()})};
var Indexes=function(){return{show:function(a){(new PropertyManager(a,"index","index_xinfo")).load()}}}(),Triggers=function(){return{show:function(a){(new PropertyManager(a,"trigger")).load()}}}(),Tables=function(){var a,c=!1,b,e,f,h,p=function(b,c,e,d){c.data("row-value",b);var f=a.cols.values[c.index()],h=a.hasPrimaryKey&&1==f[a.pkIndex],g=!1;null==b?f=i18n.getMessage(h?"column_type_primary_key":"column_type_default_value",f[a.typeIndex]):b instanceof File?f=i18n.getMessage("column_type_blob_file",
b.name):null!=b&&b.blobType?f=i18n.getMessage("column_type_blob_data",[b.length,b.blobType]):(f=i18n.getMessage("column_type_empty_string",f[a.typeIndex]),g=!0);g&&d&&e.val(b);20<e.attr("placeholder",f).val().length?c.addClass("long_text"):c.removeClass("long_text")},v=function(){p($(this).val(),$(this).closest(".column_entry"),$(this))},x=function(){var a=$(this).closest(".column_entry");p(null,a,a.find("textarea").val(""))},A=function(){if(this.files[0]){var a=$(this).closest(".column_entry");p(this.files[0],
a,a.find("textarea").val(""))}this.value=null},C=function(b){b.preventDefault();if(!$(this).hasClass("disabled")){$("#add_entry_dialog form textarea").attr("disabled","disabled");$("#add_entry_dialog form .icon_button").hide();var c=$(this).addClass("disabled"),e="",d="",f=[],h=a.cols.columns.indexOf("name");$("#add_entry_dialog .column_entry").each(function(b){var c=$(this).data("row-value");null!=c&&(e&&(e+=", ",d+=", "),e+=escapeSql(a.cols.values[b][h]),d+="?",f.push(c))});var g=function(a){Materialize.toast(a,
2E3);$("#add_entry_dialog form textarea").removeAttr("disabled");$("#add_entry_dialog form .icon_button").show();c.removeClass("disabled")};e?(b="INSERT iNTO "+escapeSql(a.name)+" ("+e+") VALUES ("+d+")",sql.send({action:"statement",sql:b,args:f,preserveBlobs:!0},function(b){b.error?g(i18n.getMessage("msg_error",b.error)):($("#add_entry_dialog").closeModal(),a.searchTable(a.query))})):g(i18n.getMessage("msg_error_no_values_provided"))}},n=function(c,e){b||(b=$("#add_entry_dialog form > div").first(),
$("#add_entry_accept").click(C));var d=$("#add_entry_dialog form").empty();e=e?e:[];for(var f=a.cols.columns.indexOf("name"),h=0;h<a.cols.values.length;h++){var g=b.clone().appendTo(d);g.find("label").text(a.cols.values[h][f]);p(void 0!=e[h]?e[h]:null,g,g.find("textarea"),!0)}d.find(".tooltipped").tooltip();d.find("textarea").bind("input",v);d.find(".delete_button").click(x);d.find('[type="file"]').change(A);$("#add_entry_accept").removeClass("disabled");$("#add_entry_dialog").openModal({out_duration:100,
ready:function(){d.find("textarea").first().focus()}})},g=function(b){var c=$("#contentTable .table-container").datagridRowValues(a.selectedRow);n(b,c)},d=function(){var b=$("#contentTable .table-container").datagridRowValues(a.selectedRow),c=[],b=q(b,c);sql.send({action:"statement",sql:"DELETE FROM "+escapeSql(a.name)+" WHERE "+b+";",args:c},function(b){b.error?errorToast(b.error):a.searchTable(a.query)})},D=function(a){showConfirmation(i18n.getMessage("msg_confirm_delete_row"),i18n.getMessage("btn_delete"),
d)},B=function(a){a.preventDefault();if(!$(this).hasClass("disabled")){var b=$("#add_table_dialog input:disabled");$("#add_table_dialog input").attr("disabled","disabled");$("#add_table_new_column, #add_table_new_column").addClass("disabled");var c=function(a){Materialize.toast(a,2E3);$("#add_table_dialog input").removeAttr("disabled");b.attr("disabled","disabled");$("#add_table_new_column, #add_table_new_column").removeClass("disabled")},e=$("#add_table_name").val();if(""==e)c(i18n.getMessage("msg_error_no_table_name_provided")),
$("#add_table_name").focus();else{a="CREATE";$("#chkTmpTable").is(":checked")&&(a+=" TEMP");a+=" TABLE";$("#chkIfNotExist").is(":checked")&&(a+=" IF NOT EXISTS");a+=" "+escapeSql(e)+" (";var d=0,g=[],l=function(a,b){var c=a.find("[type='text']"),e=a.find("[type='checkbox']"),m=c.eq(0).val();if(""==m)return null;var k=escapeSql(m)+" ",l=c.eq(1).val();""!=l&&(k=-1<f.items.indexOf(l.toUpperCase())?k+l:k+escapeSql(l));e.eq(0).is(":checked")&&(b?k+=" PRIMARY KEY":g.push(escapeSql(m)),"INTEGER"==l.toUpperCase()&&
e.eq(1).is(":checked")&&(k+=" AUTOINCREMENT",d++));e.eq(3).is(":checked")&&(k+=" UNIQUE");c=c.eq(2).val();""!=c&&(k+=" DEFAULT ",k=-1<h.items.indexOf(c.toUpperCase())?k+c:k+escapeSql(c));e.eq(2).is(":checked")||(k+=" NOT NULL");return k},n=[],p=-1,q=null;$("#columnTable tr").each(function(){var a=l($(this),!1);null!=a&&(-1==p&&0<g.length&&(p=n.length,q=$(this)),n.push(a))});if(0==n.length)c(i18n.getMessage("msg_error_no_column_provided"));else{if(1==g.length)n[p]=l(q,!0);else if(1<g.length){if(0<
d){c(i18n.getMessage("msg_error_composite_increment_key"));return}n.push("PRIMARY KEY ("+g.join(", ")+")")}a+=n.join(", ")+")";sql.send({action:"exec",sql:a},function(a){a.error?c(i18n.getMessage("msg_error",a.error)):($("#add_table_dialog").closeModal(),AppUi.reload(e))})}}}},w=function(){var a=$("#columnTable tr").length,b=e.clone().appendTo($("#columnTable tbody")),c=b.find("[type='checkbox']").each(function(b){$(this).attr("id","addTableChk"+(b+5*a)).next().attr("for","addTableChk"+(b+5*a))}),
d=b.find("[type='text']");f.attachTo(d.eq(1));h.attachTo(d.eq(2));var g=function(){c.eq(0).is(":checked")&&"INTEGER"==d.eq(1).val().toUpperCase()?c.eq(1).removeAttr("disabled"):c.eq(1).removeAttr("checked").attr("disabled","disabled")};d.bind("input",g);c.eq(0).change(g);return b},u=function(a,b){a.baseSql=b.baseSql;a.hasPrimaryKey=b.hasPrimaryKey;a.cols=b[1];a.pkIndex=b.pkIndex;a.typeIndex=b[1].columns.indexOf("type");$("#contentTable .selection-wrapper").eq(1).show();c||(c=!0,$("#table_add_entry").click(n),
$("#table_copy_entry").click(g),$("#table_delete_entry").click(D))},r=function(b){return a.hasPrimaryKey?1!=a.cols.values[b][a.pkIndex]:0!=b},t=function(b,c,e,d){var f=[];e=q(e,f);var g=a.cols.columns.indexOf("name");b=a.cols.values[a.hasPrimaryKey?b:b-1][g];var g=escapeSql(a.name),h=f.slice(0);h.unshift(c);c={action:"statement",sql:"UPDATE "+g+" SET "+escapeSql(b)+" = ? WHERE "+e+";",args:h,resultSql:"SELECT "+(g+"."+escapeSql(b))+" from "+g+" WHERE "+e+";",resultArgs:f,preserveBlobs:!0};sql.send(c,
function(a){a.error?Materialize.toast("Error "+a.error,2E3):d(a[0])})},q=function(b,c){var e=a.cols.columns.indexOf("name"),d="",f=escapeSql(a.name)+".";if(a.hasPrimaryKey){var g=a.cols.columns.indexOf("pk");$.each(a.cols.values,function(a,h){1==h[g]&&(c.push(b[a]),d&&(d+=" AND "),d+=f+escapeSql(h[e])+" = ?")})}else c=[b[0]],d="rowid = ?";return d},y=function(b){a.selectedRow=b;$("#contentTable .selection-wrapper").first().show()},l=function(a,b){$("#contentTable .selection-wrapper").first().hide();
$("#contentTable .table-container").show().datagrid(a,{allowEdit:r,onSave:t,onRowSelect:y,preserveHead:b})};return{show:function(b){a=new TableManager(b,"table");a.showGrid=l;a.onDataLoad=u;a.load({action:"load",name:b})},showAdd:function(){var a=$("#add_table_dialog .modal-content");e||(e=$("#columnTable tr").first(),f=new PopupMenu("INTEGER","BLOB","DOUBLE","FLOAT","REAL","CHAR","TEXT","VARCHAR","BLOB","NUMERIC","DATETIME"),f.translated=!0,h=new PopupMenu("CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP"),
h.translated=!0,$("#add_table_new_column").click(function(){$(this).hasClass("disabled")||w().find("[type='text']").eq(0).focus()}),$("#add_table_accept").click(B));a.remove().prependTo($("#add_table_dialog"));var b=$("#columnTableHead");a.scroll(function(){var a=b.parent().position(),a=-Math.min(0,a.top),c=Math.min(a,100)/100;b.css({transform:"translateY("+a+"px)",boxShadow:"0 0 "+4*c+"px rgba(0,0,0,"+.14*c+"), 0 "+4*c+"px "+8*c+"px rgba(0,0,0,"+.28*c+")"})}).scroll();$("#chkTmpTable, #chkIfNotExist").removeAttr("checked").removeAttr("disabled");
$("#add_table_name").val("").removeAttr("disabled");$("#columnTable tbody").empty();$("#add_table_new_column, #add_table_new_column").removeClass("disabled");for(a=0;5>a;a++)w();$("#add_table_dialog").openModal({out_duration:100,in_duration:120,ready:function(){$("#add_table_name").focus()},complete:function(){f.remove();h.remove()}})}}}(),Views=function(){var a,c=function(a,c){$("#contentTable .table-container").show().datagrid(a,{preserveHead:c})};return{show:function(b){a=new TableManager(b,"view");
a.showGrid=c;a.onDataLoad=function(){};a.baseSql="select * from "+escapeSql(b);a.load({action:"exec",sql:a.baseSql})}}}();function TableManager(a,c){this.name=a;this.type=c}
TableManager.prototype.load=function(a){$("#contentTable").show();$("#contentTable .card-title").text(this.name);$("#contentTable .buttonbar").hide();$("#contentTable .selection-wrapper").hide();$("#contentTable .table-container").empty();var c=this;sql.send(a,function(a){a.error?(Materialize.toast("Error "+a.error,2E3),AppUi.reload()):(c.success=!0,$("#contentTable .buttonbar").show(),c.onDataLoad(c,a),c.showGrid(a[0]))});$("#contentTable #search_table").val("").unbind("keypress").keypress(function(a){13==
a.which&&c.searchTable($(this).val())});$("#btnTableProperties").unbind("click").click(function(){$("#contentTable").hide();(new PropertyManager(c.name,c.type,"table_info")).load()})};TableManager.prototype.searchTable=function(a){if(this.success){var c=this;sql.send({action:"exec",sql:this.baseSql,query:a},function(b){b.error?errorToast(b.error):b[0]?(c.showGrid(b[0],!0),c.query=a):$("#contentTable .table-body").empty()})}};
