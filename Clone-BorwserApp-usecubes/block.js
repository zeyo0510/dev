!function(){function a(a){return{r:a.r,ang:{a:a.ang.a,b:a.ang.b,g:a.ang.g-A},look:{x:-a.look.x,y:a.look.z,z:a.look.y}}}function b(a){return a.map(function(a){return a.split(";").map(function(a){return a[0]+a.substring(1).split("|").map(function(a){var b=a.split(":"),c=b[0],d=c.split(","),e=d[0];return["-"===e[0]?e.substring(1):"-"+e,d[2],d[1]].join(",")+(b[1]?":"+b[1]:"")}).join("|")}).join(";")})}function c(a,b,c,d){return a[d]&&a[d][b]&&a[d][b][c]}function d(a,b,c,d){return a[d+1]&&a[d+1][b]&&a[d+1][b][c]}function e(a,b,c,d){return a[d-1]&&a[d-1][b]&&a[d-1][b][c]}function f(a,b,c,d){return a[d]&&a[d][b+1]&&a[d][b+1][c]}function g(a,b,c,d){return a[d]&&a[d][b-1]&&a[d][b-1][c]}function h(a,b,c,d){return a[d]&&a[d][b]&&a[d][b][c+1]}function i(a,b,c,d){return a[d]&&a[d][b]&&a[d][b][c-1]}function j(a,b,c,d){return a[d]&&a[d][b+1]&&a[d][b+1][c]&&a[d][b-1]&&a[d][b-1][c]&&a[d][b]&&a[d][b][c+1]&&a[d][b][c-1]&&a[d+1]&&a[d+1][b]&&a[d+1][b][c]&&a[d-1]&&a[d-1][b]&&a[d-1][b][c]}function k(a,b,c,d){return j(a,b,c,d)&&a[d]&&a[d][b+1]&&a[d][b+1][c+1]&&a[d][b+1][c-1]&&a[d][b-1]&&a[d][b-1][c+1]&&a[d][b-1][c-1]&&a[d+1]&&a[d+1][b+1]&&a[d+1][b+1][c]&&a[d+1][b-1]&&a[d+1][b-1][c]&&a[d+1][b]&&a[d+1][b][c+1]&&a[d+1][b][c-1]&&a[d-1]&&a[d-1][b+1]&&a[d-1][b+1][c]&&a[d-1][b-1]&&a[d-1][b-1][c]&&a[d-1][b]&&a[d-1][b][c+1]&&a[d-1][b][c-1]}function l(a,b,c,d){return a[d]&&a[d][b+1]&&a[d][b+1][c]&&!a[d][b+1][c]._isOutline&&a[d][b-1]&&a[d][b-1][c]&&!a[d][b-1][c]._isOutline&&a[d][b]&&a[d][b][c+1]&&!a[d][b][c+1]._isOutline&&a[d][b][c-1]&&!a[d][b][c-1]._isOutline&&a[d+1]&&a[d+1][b]&&a[d+1][b][c]&&!a[d+1][b][c]._isOutline&&a[d-1]&&a[d-1][b]&&a[d-1][b][c]&&!a[d-1][b][c]._isOutline}function m(a,b,c,d){return f(a,b,c,d)||h(a,b,c,d)||g(a,b,c,d)||i(a,b,c,d)}function n(a,b,c,d,e){var j=[],k=f(a,b,c,d),l=h(a,b,c,d),m=g(a,b,c,d),n=i(a,b,c,d);return k&&k!==e&&j.push(k),l&&l!==e&&j.push(l),m&&m!==e&&j.push(m),n&&n!==e&&j.push(n),j}function o(a){a&&a.length&&a.forEach(function(a){delete a.block,delete a.blockID})}function p(a){Object.keys(a).forEach(function(b){Object.keys(a[b]).forEach(function(c){Object.keys(a[b][c]).forEach(function(d){var e=a[b][c][d];delete e._matchPriority,delete e._supportResolved,delete e.block,delete e.blockID})})})}function q(a,b,c,d){var e=a[d]&&a[d][b]&&a[d][b][c],j=f(a,b,c,d);j=j&&void 0===j.blockID&&e.color===j.color;var k=h(a,b,c,d);k=k&&void 0===k.blockID&&e.color===k.color;var l=g(a,b,c,d);l=l&&void 0===l.blockID&&e.color===l.color;var m=i(a,b,c,d);return m=m&&void 0===m.blockID&&e.color===m.color,!j&&!k||!j&&!m||!l&&!k||!l&&!m}function r(a,b){var c=Object.keys(a),d=parseInt(c[0],10),e=parseInt(c[0],10);c.forEach(function(a){a=parseInt(a,10),d=a>d?a:d,e=e>a?a:e});var f=(parseInt(d,10)+parseInt(e,10))/2;c=c.sort(function(a,b){return Math.abs(b-f)-Math.abs(a-f)}),c.forEach(function(c){c=parseInt(c,10);var d=a[c],e=Object.keys(d),f=parseInt(e[0],10),g=parseInt(e[0],10);e.forEach(function(a){a=parseInt(a,10),f=a>f?a:f,g=g>a?a:g});var h=(parseInt(f,10)+parseInt(g,10))/2;e=e.sort(function(a,b){return Math.abs(b-h)-Math.abs(a-h)}),e.forEach(function(a){b(parseInt(c,10),parseInt(a,10))})})}function s(a,b){b=!!b,a._supportResolved=b,a.forEach(function(a){a._supportResolved=b})}function t(a,b,c,d,e){return e?(!a[d]&&(a[d]={}),!a[d][b]&&(a[d][b]={}),a[d][b][c]=e):void(a[d]&&a[d][b]&&delete a[d][b][c])}function u(a,b,c,d,e){return e?(!a[b]&&(a[b]={}),!a[b][c]&&(a[b][c]={}),a[b][c][d]=e):void(a[b]&&a[b][c]&&delete a[b][c][d])}function v(a,b,c,d){return a[b]&&a[b][c]&&a[b][c][d]}function w(a,b,c,d,e){var f=!1,g=-1;return a.every(function(a,h){return f=a.r===b&&a.g===c&&a.b===d&&a.a===e,g=h,!f}),f||(a.push({r:b,g:c,b:d,a:e}),g++),g}function x(a){return a.toString(36)}function y(a,b){a._matchPriority=void 0===a._matchPriority?b:a._matchPriority+b}function z(a,b,c){function d(b){if("."===b[0].blockType||".."===b[0].blockType||"::"===b[0].blockType)return b;for(var c=b[0].position.z,d=[1,-1],e=["x","y"],f=b[0].position.x,g=b[0].position.y,h=b[0].position.x,i=b[0].position.y,j=1;j<b.length;j++)for(var k=0;k<e.length;k++)for(var l=e[k],m=0;m<d.length;m++){var n=d[m],o="x"===l?b[j].position.x+n:b[j].position.x,p="y"===l?b[j].position.y+n:b[j].position.y;if(!(a[c]&&a[c][o]&&a[c][o][p]))break;a[c][o][p].blockID===b[0].blockID&&(f=Math.max(f,o),g=Math.max(g,p),h=Math.min(h,o),i=Math.min(i,p))}var q=f===h?[f]:[f,h],r=g===i?[g]:[g,i],s=[];return q.forEach(function(b){r.forEach(function(d){s.push(a[c][b][d])})}),s}function e(d,e,f,g,h){c.all--,c.index++;var i=f[0].blockType,j=g[0].blockType;b[i].splice(b[i].indexOf(d),1),b[j].splice(b[j].indexOf(e),1),d.forEach(function(b,d){b.blockType=h,b.blockID=c.index,a[b.position.z][b.position.x][b.position.y]=b}),e.forEach(function(b,d){b.blockType=h,b.blockID=c.index,a[b.position.z][b.position.x][b.position.y]=b}),b[h]?b[h].push(d.concat(e)):b[h]=d.concat(e)}function f(a,b,c,d,f){for(var g=[],h=0;h<c.length;h++)for(var i=c[h],j=0;j<d.length;j++){var k=d[j];g.push(Math.sqrt((i.position.x-k.position.x)*(i.position.x-k.position.x)+(i.position.y-k.position.y)*(i.position.y-k.position.y)))}var l;switch(f){case"::::::::":l=[1,1,7,7];break;case"::::::":l=[1,1,5,5];break;case"::::":l="::"===c[0].blockType?[1,1,3,3]:[1,1];break;case"::":l=[1,1];break;case"....":l=[1,3];break;case"...":l=[1,2];break;case"..":l=[1]}for(var h=0;h<g.length;h++){if(!l.length)return e(a,b,c,d,f),!0;var m=g[h],n=l.indexOf(m);n>-1&&l.splice(n,1)}return l.length?!1:(e(a,b,c,d,f),!0)}var g=[{type:"::::",mergeTypes:[{type:"::::",result:"::::::::"}]},{type:"::::::",mergeTypes:[{type:"::",result:"::::::::"}]},{type:".",mergeTypes:[{type:".",result:".."}]},{type:"..",mergeTypes:[{type:".",result:"..."},{type:"..",result:"::"}]},{type:"...",mergeTypes:[{type:".",result:"...."}]},{type:"....",mergeTypes:[{type:"....",result:"::::"}]},{type:"::",mergeTypes:[{type:"::",result:"::::"},{type:"::::",result:"::::::"},{type:"::::::",result:"::::::::"}]},{type:"::::",mergeTypes:[{type:"::::",result:"::::::::"}]},{type:"::::::",mergeTypes:[{type:"::",result:"::::::::"}]}];g.forEach(function(a){if(b[a.type]&&b[a.type].length)for(var c=0;c<b[a.type].length;c++){var e=b[a.type][c],g=!1,h=d(e);a.mergeTypes.forEach(function(a){if(!g)for(var i=0;i<b[a.type].length;i++){var j=b[a.type][i];if(e[0].position.z===j[0].position.z&&e[0].color===j[0].color&&e[0].blockID!==j[0].blockID){var k=d(j);if(f(e,j,h,k,a.result)){g=!0,c-=2,c=Math.max(c,0);break}}}})}})}var A=(2*Math.PI,Math.PI/4,Math.PI/2),B={},C=12,D=10,E={"::::::::":[{ifOffset:4,data:[[!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0]]}],"::::::":[{ifOffset:3,data:[[!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0]]}],"::::":[{ifOffset:2,data:[[!0,!0,!0,!0],[!0,!0,!0,!0]]}],":::":[{ifOffset:1,data:[[!0,!0,!0],[!0,!0,!0]]}],"::":[{ifOffset:0,justComputeABCD:!0,data:[[!0,!0],[!0,!0]]}],":.":[{ifOffset:0,justComputeABCD:!0,data:[[!0],[!0,!0]]},{ifOffset:0,justComputeABCD:!0,data:[[!0,!0],[!0]]},{ifOffset:0,justComputeABCD:!0,data:[[!0,!0],[!1,!0]]}],"....":[{ifOffset:2,justComputeABCD:!0,data:[[!0,!0,!0,!0]]}],"...":[{ifOffset:1,justComputeABCD:!0,data:[[!0,!0,!0]]}],"..":[{ifOffset:0,justComputeABCD:!0,data:[[!0,!0]]}],".":[{ifOffset:0,justComputeA:!0,data:[[!0]]}]},F={"::::":E["::::"],":::":E[":::"],"::":E["::"],":.":E[":."],"....":E["...."],"...":E["..."],"..":E[".."]},G={":::":E[":::"],"::":E["::"],":.":E[":."],"...":E["..."],"..":E[".."]};Array.prototype.includes=function(a){return this.indexOf(a)>-1},B.parseToLatestModel=function(c){var d=[];if(c=c||{},!c.v&&c.data){var e="+"+c.data.map(function(a,b){var e,f,g,h,i=a.split("|"),j=i[0].split(","),k=i[1].split(","),l=x(~~j[0]),m=x(~~j[1]),n=x(~~j[2]);c.colors&&c.colors.length>0?(e=parseFloat(c.colors[k[0]].r,10),f=parseFloat(c.colors[k[0]].g,10),g=parseFloat(c.colors[k[0]].b,10),h=parseFloat(k[1],10)):(e=parseFloat(k[0],10),f=parseFloat(k[1],10),g=parseFloat(k[2],10),h=parseFloat(k[3],10));var o=w(d,e,f,g,h);return[l,m,n].join(",")+":"+o}).join("|");c.data=[e],c.v="1.0",c.colors=d}return c.v&&parseFloat(c.v,10)<1.1&&(c.colors.forEach(function(a){a.r=parseInt(255*a.r,10),a.g=parseInt(255*a.g,10),a.b=parseInt(255*a.b,10)}),delete c.v),c.v&&parseFloat(c.v,10)>=1.2&&(c.data=b(c.data),console.log("modelData.camera",c.camera),c.camera=a(c.camera),console.log("modelData.camera end",c.camera),delete c.v),c},B.compute=function(a,b,k){function l(a){Object.keys(A).forEach(function(b){A[b].forEach(function(b){b._needRemove=a.includes(b)}),A[b]=A[b].filter(function(a){return!a._needRemove})})}function w(){var b=0;H.forEach(function(c){c.every(function(f){var g=f.position.x,h=f.position.y,i=f.position.z,j=d(a,g,h,i),k=e(a,g,h,i);return I.includes(f.block)?k&&k._supportResolved?(b++,s(c,!0),c.forEach(function(a){a.block=I[I.length-1]}),!1):!0:j&&j._supportResolved&&!I.includes(j.block)||k&&k._supportResolved&&!I.includes(k.block)?(b++,s(c,!0),c.forEach(function(a){a.block=I[I.length-1]}),!1):!0})}),b&&(H=H.filter(function(a){return!a._supportResolved}),w())}k=void 0!=k?k:0;var x={all:0,index:0},A={};Object.keys(E).forEach(function(a){A[a]=[]});var H=[],I=[],J={},K={},L=Object.keys(a),M=parseInt(L[0],10);if(L.forEach(function(a){a=parseInt(a,10),M=M>a?a:M}),L=L.sort(function(a,b){return a-M-(b-M)}),L.forEach(function(b){function d(a){!n.includes(a)&&n.push(a)}function k(d,f,g,h){h=h||E;var i=0,k=a[b][d][f],l=e(a,d,f,b);if(void 0===k.blockID){var m={},n=-999999;Object.keys(h).forEach(function(e){var i,l=h[e],o={result:!1,A:!1,B:!1,C:!1,D:!1,E:!1,F:!1,G:!1,H:!1},p={A:[],B:[],C:[],D:[],E:[],F:[],G:[],H:[]},r={maxKey:null,max:n,A:0,B:0,C:0,D:0,E:0,F:0,G:0,H:0};i=l.map(function(a){return Object.assign(a.data,a),delete a.data.data,a.data}),g=g&&!q(a,d,f,b);var s,t,u;i.forEach(function(e,h){u=[],o.A=o.A||e.every(function(h,i){return h.every(function(h,l){var m=d+i,n=f-l+(g?e.ifOffset:0),o=c(a,m,n,b);return h?o&&void 0===o.blockID&&(j(a,m,n,b)||o._colorCanChange||o.color===k.color)?(r.A+=o._matchPriority,o.color=k.color,u.push(o),!0):!1:!0})}),o.A?(p.A=p.A.length?p.A:u,s=void 0,t=u.every(function(a){return void 0===s||!!a._supportResolved===s?(s=!!a._supportResolved,!0):!1}),t||(r.A+=1e5),r.maxKey=r.A>r.max?"A":r.maxKey,r.max=r[r.maxKey]):r.A=0,e.justComputeA||(u=[],o.B=o.B||e.every(function(h,i){return h.every(function(h,l){var m=d+l-(g?e.ifOffset:0),n=f+i,o=c(a,m,n,b);return h?o&&void 0===o.blockID&&(j(a,m,n,b)||o._colorCanChange||o.color===k.color)?(r.B+=o._matchPriority,o.color=k.color,u.push(o),!0):!1:!0})}),o.B?(s=void 0,t=u.every(function(a){return void 0===s||!!a._supportResolved===s?(s=!!a._supportResolved,!0):!1}),t||(r.B+=1e5),r.maxKey=r.B>r.max?"B":r.maxKey,r.max=r[r.maxKey],p.B=p.B.length?p.B:u):r.B=0,u=[],o.C=o.C||e.every(function(h,i){return h.every(function(h,l){var m=d-i,n=f+l-(g?e.ifOffset:0),o=c(a,m,n,b);return h?o&&void 0===o.blockID&&(j(a,m,n,b)||o._colorCanChange||o.color===k.color)?(r.C+=o._matchPriority,o.color=k.color,u.push(o),!0):!1:!0})}),o.C?(s=void 0,t=u.every(function(a){return void 0===s||!!a._supportResolved===s?(s=!!a._supportResolved,!0):!1}),t||(r.C+=1e5),r.maxKey=r.C>r.max?"C":r.maxKey,r.max=r[r.maxKey],p.C=p.C.length?p.C:u):r.C=0,u=[],o.D=o.D||e.every(function(h,i){return h.every(function(h,l){var m=d-l+(g?e.ifOffset:0),n=f-i,o=c(a,m,n,b);return h?o&&void 0===o.blockID&&(j(a,m,n,b)||o._colorCanChange||o.color===k.color)?(r.D+=o._matchPriority,o.color=k.color,u.push(o),!0):!1:!0})}),o.D?(s=void 0,t=u.every(function(a){return void 0===s||!!a._supportResolved===s?(s=!!a._supportResolved,!0):!1}),t||(r.D+=1e5),r.maxKey=r.D>r.max?"D":r.maxKey,r.max=r[r.maxKey],p.D=p.D.length?p.D:u):r.D=0,e.justComputeABCD||(u=[],o.E=o.E||e.every(function(h,i){return h.every(function(h,l){var m=d+i,n=f+l-(g?e.ifOffset:0),o=c(a,m,n,b);return h?o&&void 0===o.blockID&&(j(a,m,n,b)||o._colorCanChange||o.color===k.color)?(r.E+=o._matchPriority,o.color=k.color,u.push(o),!0):!1:!0})}),o.E?(s=void 0,t=u.every(function(a){return void 0===s||!!a._supportResolved===s?(s=!!a._supportResolved,!0):!1}),t||(r.E+=1e5),r.maxKey=r.E>r.max?"E":r.maxKey,r.max=r[r.maxKey],p.E=p.E.length?p.E:u):r.E=0,u=[],o.F=o.F||e.every(function(h,i){return h.every(function(h,l){var m=d-l+(g?e.ifOffset:0),n=f+i,o=c(a,m,n,b);return h?o&&void 0===o.blockID&&(j(a,m,n,b)||o._colorCanChange||o.color===k.color)?(r.F+=o._matchPriority,o.color=k.color,u.push(o),!0):!1:!0})}),o.F?(s=void 0,t=u.every(function(a){return void 0===s||!!a._supportResolved===s?(s=!!a._supportResolved,!0):!1}),t||(r.F+=1e5),r.maxKey=r.F>r.max?"F":r.maxKey,r.max=r[r.maxKey],p.F=p.F.length?p.F:u):r.F=0,u=[],o.G=o.G||e.every(function(h,i){return h.every(function(h,l){var m=d-i,n=f-l+(g?e.ifOffset:0),o=c(a,m,n,b);return h?o&&void 0===o.blockID&&(j(a,m,n,b)||o._colorCanChange||o.color===k.color)?(r.G+=o._matchPriority,o.color=k.color,u.push(o),!0):!1:!0})}),o.G?(s=void 0,t=u.every(function(a){return void 0===s||!!a._supportResolved===s?(s=!!a._supportResolved,!0):!1}),t||(r.G+=1e5),r.maxKey=r.G>r.max?"G":r.maxKey,r.max=r[r.maxKey],p.G=p.G.length?p.G:u):r.G=0,u=[],o.H=o.H||e.every(function(h,i){return h.every(function(h,l){var m=d+l-(g?e.ifOffset:0),n=f-i,o=c(a,m,n,b);return h?o&&void 0===o.blockID&&(j(a,m,n,b)||o._colorCanChange||o.color===k.color)?(r.H+=o._matchPriority,o.color=k.color,u.push(o),!0):!1:!0})}),o.H?(s=void 0,t=u.every(function(a){return void 0===s||!!a._supportResolved===s?(s=!!a._supportResolved,!0):!1}),t||(r.H+=1e5),r.maxKey=r.H>r.max?"H":r.maxKey,r.max=r[r.maxKey],p.H=p.H.length?p.H:u):r.H=0))}),m[e]={match:o,point:r,matchCubes:p},o.result=o.A||o.B||o.C||o.D||o.E||o.F||o.G||o.H});var o,r=n;if(Object.keys(m).forEach(function(a){m[a].match.result&&m[a].point.max>r&&(o=a,r=m[a].point.max)}),o){var s=(m[o].match,m[o].point),u=m[o].matchCubes,v=(h[o],[]),w={};u[s.maxKey].forEach(function(a){a&&(a.blockID=w),l&&(l.blockID=w),a.block=v,!p.includes(a)&&p.push(a),!v.includes(a)&&v.push(a)}),!t.includes(v)&&t.push(v),x.all++,x.index++,x[b]++,i++}}return i}void 0===x[b]&&(x[b]=0),b=parseInt(b,10);var m=a[b],n=[],p=[],t=[];if(r(m,function(c,d){var e=a[b][c][d];y(e,D)}),M!==b?r(m,function(c,k){var l=a[b][c][k],m=f(a,c,k,b),n=g(a,c,k,b),o=h(a,c,k,b),p=i(a,c,k,b),q=c,r=k,s=b-1,t=e(a,c,k,b),u=f(a,q,r,s),v=g(a,q,r,s),w=h(a,q,r,s),x=i(a,q,r,s);if(t&&t._supportResolved)l._supportResolved=!0,m&&(m.color===l.color||m._colorCanChange||j(a,c+1,k,b))&&(u&&u._supportResolved||(y(l,1e3),y(m,-1),d(l)),u&&t&&t.blockID!==u.blockID&&(y(l,1),d(l))),n&&(n.color===l.color||n._colorCanChange||j(a,c-1,k,b))&&(v&&v._supportResolved||(y(l,1e3),y(n,-1),d(l)),v&&t&&t.blockID!==v.blockID&&(y(l,1),d(l))),o&&(o.color===l.color||o._colorCanChange||j(a,c,k+1,b))&&(w&&w._supportResolved||(y(l,1e3),y(o,-1),d(l)),w&&t&&t.blockID!==w.blockID&&(y(l,1),d(l))),p&&(p.color===l.color||p._colorCanChange||j(a,c,k-1,b))&&(x&&x._supportResolved||(y(l,1e3),y(p,-1),d(l)),x&&t&&t.blockID!==x.blockID&&(y(l,1),d(l)));else{if(y(l,100),!t){var z=4;m&&z--,o&&z--,n&&z--,p&&z--,y(l,1e4*z)}d(l),m&&(m.color===l.color||m._colorCanChange||j(a,c+1,k,b))&&(u&&u._supportResolved&&(y(l,1e3),d(l)),u&&t&&t.blockID!==u.blockID&&(y(l,1),d(l))),n&&(n.color===l.color||n._colorCanChange||j(a,c-1,k,b))&&(v&&v._supportResolved&&(y(l,1e3),d(l)),v&&t&&t.blockID!==v.blockID&&(y(l,1),d(l))),o&&(o.color===l.color||o._colorCanChange||j(a,c,k+1,b))&&(w&&w._supportResolved&&(y(l,1e3),d(l)),w&&t&&t.blockID!==w.blockID&&(y(l,1),d(l))),p&&(p.color===l.color||p._colorCanChange||j(a,c,k-1,b))&&(x&&x._supportResolved&&(y(l,1e3),d(l)),x&&t&&t.blockID!==x.blockID&&(y(l,1),d(l)))}(l._colorCanChange||j(a,c,k,b))&&y(l,-1)}):r(m,function(a,b){m[a][b]._supportResolved=!0}),n=n.sort(function(a,b){return b._matchPriority-a._matchPriority}),n=n.filter(function(b){var c=j(a,b.position.x,b.position.y,b.position.z);return!c}),n.forEach(function(a){k(a.position.x,a.position.y,!0)}),M!==b){var u=!1;n.forEach(function(c){var d=c.position.x,j=c.position.y,k=a[b][d][j],l=e(a,d,j,b),m=f(a,d,j,b),n=g(a,d,j,b),o=h(a,d,j,b),p=i(a,d,j,b);l||m&&(!m||m.blockID===k.blockID)||o&&(!o||o.blockID===k.blockID)||n&&(!n||n.blockID===k.blockID)||p&&(!p||p.blockID===k.blockID)||(u=!0)}),u&&(x.all-=x[b],x[b]=0,l(t),o(p),p=[],t=[],n.forEach(function(a){k(a.position.x,a.position.y,!0,F)}));var u=!1;n.forEach(function(c){var d=c.position.x,j=c.position.y,k=a[b][d][j],l=e(a,d,j,b),m=f(a,d,j,b),n=g(a,d,j,b),o=h(a,d,j,b),p=i(a,d,j,b);l||m&&(!m||m.blockID===k.blockID)||o&&(!o||o.blockID===k.blockID)||n&&(!n||n.blockID===k.blockID)||p&&(!p||p.blockID===k.blockID)||(u=!0)}),u&&(x.all-=x[b],x[b]=0,l(t),o(p),p=[],t=[],n.forEach(function(a){k(a.position.x,a.position.y,!0,G)}));var u=!1;n.forEach(function(c){var d=c.position.x,j=c.position.y,k=a[b][d][j],l=e(a,d,j,b),m=f(a,d,j,b),n=g(a,d,j,b),o=h(a,d,j,b),p=i(a,d,j,b);l||m&&(!m||m.blockID===k.blockID)||o&&(!o||o.blockID===k.blockID)||n&&(!n||n.blockID===k.blockID)||p&&(!p||p.blockID===k.blockID)||(u=!0)}),u&&(x.all-=x[b],x[b]=0,l(t),o(p),p=[],t=[],n.forEach(function(a){k(a.position.x,a.position.y,!0)}))}r(m,k),t.forEach(function(a){var b=!a.every(function(a){return!a._supportResolved});b?(s(a,!0),a.forEach(function(a){a.block=t[t.length-1]})):(s(a,!1),!H.includes(a)&&H.push(a))});var v=!0;r(m,function(a,b){m[a][b]._supportResolved&&(v=!1)}),v&&r(m,function(a,b){var c=m[a][b];c._supportResolved=!0,c.block._supportResolved=!0,!I.includes(c.block)&&I.push(c.block)}),w()}),I.forEach(function(a){s(a,!1),!H.includes(a)&&H.push(a)}),H.length&&C>k)return k++,H.forEach(function(c){c.forEach(function(c){var d,j=c.position.x,k=c.position.y,l=c.position.z;if(!e(a,j,k,l)){var o=m(a,j,k,l-1);d=t(a,j,k,l-1,{color:o&&o.color||c.color,position:{x:j,y:k,z:l-1},selected:!1,_colorCanChange:!0,_isAddCube:!0}),b=!0}var p,q,r=f(a,j,k,l);if(r){if(!f(a,j,k,l-1)&&r._supportResolved){var o=m(a,r.position.x,r.position.y,r.position.z-1);t(a,j+1,k,l-1,{color:o&&o.color||d&&d.color||r.color,position:{x:j+1,y:k,z:l-1},selected:!1,_colorCanChange:!0,_isAddCube:!0}),p=!0,b=!0}}else{var s=n(a,j+1,k,l,c);s=s.filter(function(a){return a._supportResolved}),s.length&&(t(a,j+1,k,l,{color:c.color,position:{x:j+1,y:k,z:l},selected:!1,_colorCanChange:!0,_isAddCube:!0}),q=!0,b=!0)}var u=h(a,j,k,l);if(u){if(!h(a,j,k,l-1)&&!p&&u._supportResolved){var o=m(a,u.position.x,u.position.y,u.position.z-1);t(a,j,k+1,l-1,{color:o&&o.color||d&&d.color||u.color,position:{x:j,y:k+1,z:l-1},selected:!1,_colorCanChange:!0,_isAddCube:!0}),p=!0,b=!0}}else if(!q){var s=n(a,j,k+1,l,c);s=s.filter(function(a){return a._supportResolved}),s.length&&(t(a,j,k+1,l,{color:c.color,position:{x:j,y:k+1,z:l},selected:!1,_colorCanChange:!0,_isAddCube:!0}),q=!0,b=!0)}var v=g(a,j,k,l);if(v){if(!g(a,j,k,l-1)&&!p&&v._supportResolved){var o=m(a,v.position.x,v.position.y,v.position.z-1);t(a,j-1,k,l-1,{color:o&&o.color||d&&d.color||v.color,position:{x:j-1,y:k,z:l-1},selected:!1,_colorCanChange:!0,_isAddCube:!0}),p=!0,b=!0}}else if(!q){var s=n(a,j-1,k,l,c);s=s.filter(function(a){return a._supportResolved}),s.length&&(t(a,j-1,k,l,{color:c.color,position:{x:j-1,y:k,z:l},selected:!1,_colorCanChange:!0,_isAddCube:!0}),q=!0,b=!0)}var w=i(a,j,k,l);if(w){if(!i(a,j,k,l-1)&&!p&&w._supportResolved){var o=m(a,w.position.x,w.position.y,w.position.z-1);t(a,j,k-1,l-1,{color:o&&o.color||d&&d.color||w.color,position:{x:j,y:k-1,z:l-1},selected:!1,_colorCanChange:!0,_isAddCube:!0}),p=!0,b=!0}}else if(!q){var s=n(a,j,k-1,l,c);s=s.filter(function(a){return a._supportResolved}),s.length&&(t(a,j,k-1,l,{color:c.color,position:{x:j,y:k-1,z:l},selected:!1,_colorCanChange:!0,_isAddCube:!0}),q=!0,b=!0)}})}),p(a),B.compute(a,b,k);var N=[],O={};return z(a,A,x),Object.keys(a).forEach(function(b){Object.keys(a[b]).forEach(function(c){Object.keys(a[b][c]).forEach(function(e){c=parseInt(c,10),e=parseInt(e,10),b=parseInt(b,10);var f=a[b][c][e],g=d(a,c,e,b);f.blockID=v(N,c,e,b),N.push(f),u(O,c,e,b,f),void 0===J.x&&(J.x=K.x=c,J.y=K.y=e,J.z=K.z=b),J.x=c>J.x?c:J.x,J.y=e>J.y?e:J.y,J.z=b>J.z?b:J.z,K.x=c<K.x?c:K.x,K.y=e<K.y?e:K.y,K.z=b<K.z?b:K.z,b===M&&(void 0===J.baseX&&(J.baseX=K.baseX=c,J.baseY=K.baseY=e,J.baseZ=K.baseZ=b),J.baseX=c>J.baseX?c:J.baseX,J.baseY=e>J.baseY?e:J.baseY,J.baseZ=b>J.baseZ?b:J.baseZ,K.baseX=c<K.baseX?c:K.baseX,K.baseY=e<K.baseY?e:K.baseY,K.baseZ=b<K.baseZ?b:K.baseZ),g||(f.topCube=!0)})})}),{count:x,cubeZXY:a,cubes:N,cubeXYZ:O,unsupportBlocks:H,max:J,min:K,repair:k,hadAddCubes:!!b}},B.parseCubeData=function(a){function b(a,b,c){var d=c.split(";");d.forEach(function(c){var d=c[0],e=f[d],g=c.substr(1).split("|");e&&g.map(function(c){return e(a,b,c)})})}var c=B.parseToLatestModel(a),d=[],e=[],f={"+":function(a,b,c){var d=c.split(":"),e=d[0].split(","),f=d[1],g=parseInt(e[0],36),h=parseInt(e[1],36),i=parseInt(e[2],36),j=v(b,g,h,i),k=j||{};k.color=parseInt(f,10),k.position={x:g,y:h,z:i},k.selected=!1,j||(u(b,g,h,i,k),a.push(k))},"-":function(a,b,c){var d=c.split(":"),e=d[0].split(","),f=parseInt(e[0],36),g=parseInt(e[1],36),h=parseInt(e[2],36),i=v(b,f,g,h),j=a.indexOf(i);j>-1&&a.splice(j,1),u(b,f,g,h)},"\\":function(a,b,c){var d=c.split(":"),e=d[0].split(","),f=d[1].split("=")[1],g=parseInt(e[0],36),h=parseInt(e[1],36),i=parseInt(e[2],36),j=v(b,g,h,i);j&&(j.color=parseInt(f,10))}};c.data.forEach(function(a){b(d,e,a)});var g={};Object.keys(e).forEach(function(a){Object.keys(e[a]).forEach(function(b){Object.keys(e[a][b]).forEach(function(c){t(g,a,b,c,e[a][b][c])})})});var h={},i={};d.forEach(function(a,b){var c=a.position.x,d=a.position.y,e=a.position.z;void 0===h.x&&(h.x=i.x=c,h.y=i.y=d,h.z=i.z=e),h.x=c>h.x?c:h.x,h.y=d>h.y?d:h.y,h.z=e>h.z?e:h.z,i.x=c<i.x?c:i.x,i.y=d<i.y?d:i.y,i.z=e<i.z?e:i.z});var j={cubes:d,cubeZXY:g,cubeXYZ:e,max:h,min:i};return delete c.data,Object.assign(c,j)},B.clearBlockInCubes=function(a){a.forEach(function(a){delete a.block})};var H=[{b:26,g:26,r:160},{b:133,g:107,r:241},{b:13,g:90,r:191}],I=[{b:1,g:1,r:249},{b:247,g:120,r:249},{b:17,g:59,r:104}];B.processIpadColorNearToWeb=function(a,b){var c=[],d=[];return b.forEach(function(a,e){H.forEach(function(f,g){if(f.r===a.r&&f.g===a.g&&f.b===a.b){var h,i=e;b.forEach(function(a,b){I[g].r===a.r&&I[g].g===a.g&&I[g].b===a.b&&(h=b)}),c.push(i),d.push(h),void 0===h&&(a.r=I[g].r,a.g=I[g].g,a.b=I[g].b)}})}),a.forEach(function(a){c.forEach(function(b,c){a.color===b&&void 0!=d[c]&&(a.color=d[c])})}),a},B.removeInnerCubes=function(a){return Object.keys(a).forEach(function(b){Object.keys(a[b]).forEach(function(c){Object.keys(a[b][c]).forEach(function(d){var e=a[b][c][d];e._isOutline=!k(a,e.position.x,e.position.y,e.position.z),e._isOutline||(e._colorCanChange=!0)})})}),Object.keys(a).forEach(function(b){Object.keys(a[b]).forEach(function(c){Object.keys(a[b][c]).forEach(function(d){var e=a[b][c][d];l(a,e.position.x,e.position.y,e.position.z)&&(a[b][c][d]._isInnerCube=!0)})})}),Object.keys(a).forEach(function(b){Object.keys(a[b]).forEach(function(c){Object.keys(a[b][c]).forEach(function(d){a[b][c][d]._isInnerCube&&delete a[b][c][d]})})}),a},B.computeBlocks=function(a){B.processIpadColorNearToWeb(a.cubes,a.colors);var b=B.compute(a.cubeZXY);return B.clearBlockInCubes(b.cubes),b.colors=a.colors,b.camera=a.camera,b},onmessage=function(a){console.log("Message received from main script"),postMessage(B.computeBlocks(a.data))}}();