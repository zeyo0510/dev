function getGalleries(){chrome.mediaGalleries.getMediaFileSystems({interactive:"if_needed"},getGalleriesMD),galsData={}}function getGalleriesMD(e){for(var t=[],n=0;n<e.length;n++)t.push(chrome.mediaGalleries.getMediaFileSystemMetadata(e[n])),t[n].title=t[n].name.substr(t[n].name.lastIndexOf("\\")+1),t[n].root=e[n].root;drawGalleries(t.sort(sortItems))}function drawGalleries(e){galslist.innerHTML="";for(var t=0;t<e.length;t++)!function(e){var t=document.createElement("div"),n=document.createElement("span");viewThumb.checked?(t.className="listItemFT",n.className="itemNameTF"):(t.className="listItem",n.className="itemName"),t.setAttribute("data-icon","C"),n.innerHTML+=e.title,galslist.appendChild(t),t.appendChild(n),t.onclick=function(){galslist.innerHTML="",getItems(e.root),galsData.crumbs=[],addCrumb({title:e.title,id:e.root})}}(e[t]);if(0==e.length){var n=document.createElement("div");n.className="notFound",n.innerHTML="No galleries found.",galslist.appendChild(n)}}function getItems(e){var t,n=e.createReader(),a=[],i=[],l=0,s=0;n.readEntries(function(e){for(var n=0;n<e.length;n++)e[n].isFile&&(l++,s++,e[n].file(function(e){a.push({type:"file",title:e.name,file:e,size:e.size,src:URL.createObjectURL(e),ext:e.type}),l--,"invisible"==progressBar.className&&(progressBar.className="visible2"),t&&(progressBar.style.width=(s-l)*t+"px"),0==l&&drawList(i.sort(sortItems).concat(a.sort(sortItems)))})),e[n].isDirectory&&(l++,i.push({id:e[n],type:"folder",title:e[n].name}),l--);t=galslist.offsetWidth/s,0==l&&drawList(i.sort(sortItems).concat(a.sort(sortItems)))})}function sortItems(e,t){function n(e){for(var t,n,a=[],i=0,l=-1,s=0;t=(n=e.charAt(i++)).charCodeAt(0);){var o=46==t||t>=48&&57>=t;o!==s&&(a[++l]="",s=o),a[l]+=n}return a}var a,i=n(e.title.toLowerCase()),l=n(t.title.toLowerCase());for(x=0;i[x]&&l[x];x++)if(i[x]!==l[x]){var s=Number(i[x]),o=Number(l[x]);return a=s==i[x]&&o==l[x]?s-o:i[x]>l[x]?1:-1}return i.length-l.length}function drawList(e){galsData.curEntries=e,galslist.innerHTML="",progressBar.className="invisible";var t=0,n=0;galsData.videoList=[];for(var a=0;a<e.length;a++)if(function(e,a){var i=document.createElement("div"),l=document.createElement("span"),s=e.title,o=s.substr(s.lastIndexOf(".")),r=s.replace(o,""),c=document.createElement("canvas"),d=document.createElement("div");"folder"==e.type&&(t++,i.onclick=function(){galslist.innerHTML="",getItems(e.id),addCrumb(e)},viewThumb.checked?(i.className="listItemFT",l.className="itemNameTF"):(i.className="listItem",l.className="itemName"),i.setAttribute("data-icon","C"),l.innerHTML+=s,galslist.appendChild(i),i.appendChild(l)),"file"!=e.type||"video/mp4"!=e.ext&&"video/webm"!=e.ext||(t++,n++,galsData.videoList.push(e),i.onclick=function(){setVideo(e),galsData.curVid=a,analTracker.sendEvent("Navigation","Video","Mouse")},viewThumb.checked?(i.className="listItemT",c.id="thumb"+a,c.width=112,c.height=75,d.className="mask",l.className="itemNameT",l.id="label"+a,galslist.appendChild(i),i.appendChild(c),d.appendChild(l),i.appendChild(d)):(i.className="listItem",i.setAttribute("data-icon","A"),l.className="itemName",galslist.appendChild(i),i.appendChild(l)),i.id=s+e.size,l.innerHTML+=r)}(e[a],n),n>14){var i=document.createElement("div");i.className="upgrade",i.innerHTML="<a href='https://chrome.google.com/webstore/detail/loopit/ccpkbfgkcokjbnkegbeolhalebkfgogf?hl=en&gl=US' target='_blank'>Upgrade Now</a>",galslist.appendChild(i),i.onclick=function(){analTracker.sendEvent("Free","Upgrade")},analTracker.sendEvent("Free","Limit","Listed");break}if(n>0&&viewThumb.checked&&(galsData.curThumb=0,vidThumb.src=galsData.videoList[0].src),0==t){var l=document.createElement("div");l.className="notFound",l.innerHTML="No supported media found.",galslist.appendChild(l)}videlCheck&&!viewThumb.checked&&highlight()}function genThumbnail(){var e=galsData.curThumb,t="thumb"+e,n=document.getElementById(t),a=vidThumb.videoWidth/vidThumb.videoHeight,i="label"+e,l=document.getElementById(i),s=0,o=0;vidThumb.removeAttribute("width"),vidThumb.removeAttribute("height"),a>1?a>1.5?(vidThumb.height=75,s=(112-vidThumb.clientWidth)/2):(vidThumb.width=112,o=(75-vidThumb.clientHeight)/2):1>a?52/75>a?(n.width=52,vidThumb.width=52,o=(75-vidThumb.clientHeight)/2):(n.width=52,vidThumb.height=75,s=(52-vidThumb.clientWidth)/2):1==a&&(n.width=52,vidThumb.height=75,s=(52-vidThumb.clientWidth)/2),n.getContext("2d").drawImage(vidThumb,s,o,vidThumb.clientWidth,vidThumb.clientHeight),n.style.WebkitAnimation="grow 0.3s 0 linear",n.clientWidth<l.clientWidth&&l.classList.add(l.clientWidth>300?"marqueeSlower":l.clientWidth>200?"marqueeSlow":"marquee"),galsData.curThumb==galsData.videoList.length-1?(vidThumb.src="",highlight()):(vidThumb.src=galsData.videoList[e+1].src,galsData.curThumb++)}function addCrumb(e){galsData.crumbs.push(e),leaveCrumbs()}function leaveCrumbs(){cleanCrumbs();for(var e=0;e<galsData.crumbs.length;e++)!function(e,t){var n=document.createElement("li"),a=document.createElement("span");n.className="crumb",a.className="crumbLabel",a.innerHTML=e.title,n.onclick=function(){getItems(e.id),galsData.crumbs=galsData.crumbs.slice(0,t+1),leaveCrumbs(),analTracker.sendEvent("Navigation","History","Mouse")},breadCrumbs.appendChild(n),n.appendChild(a)}(galsData.crumbs[e],e)}function previousFolder(){if(galsData.crumbs){var e=galsData.crumbs.length-1,t=galsData.crumbs[e-1];0==e&&"homeButton"!==breadCrumbs.lastChild.id?(cleanCrumbs(),getGalleries(),analTracker.sendEvent("Navigation","History","Keyboard")):e>0&&(getItems(t.id),galsData.crumbs=galsData.crumbs.slice(0,e),leaveCrumbs(),analTracker.sendEvent("Navigation","History","Keyboard"))}}function nextVideo(){var e=videl.getAttribute("filename")+videl.getAttribute("size"),t=document.getElementById(e);t&&galsData.curVid!=galsData.videoList.length-1&&(galsData.curVid++,setVideo(galsData.videoList[galsData.curVid]),analTracker.sendEvent("Navigation","Video","Keyboard"))}function previousVideo(){var e=videl.getAttribute("filename")+videl.getAttribute("size"),t=document.getElementById(e);t&&0!=galsData.curVid&&(galsData.curVid--,setVideo(galsData.videoList[galsData.curVid]),analTracker.sendEvent("Navigation","Video","Keyboard"))}function setVideo(e){var t=e.title+e.size;vidlimit++,highlight(t),displayElm(contentDiv),setTimeout(function(){videl.src=e.src,videl.setAttribute("filename",e.title),videl.setAttribute("size",e.size),videlCheck=!0,analQuota={P:0,F:0,M:0,S:0},resetControls(),vidlimit>=100&&"hidden"==upgradeOverlay.className&&(displayElm(upgradeOverlay),analTracker.sendEvent("Free","Limit","Played"))},400)}function highlight(e){e||(e=videl.getAttribute("filename")+videl.getAttribute("size"));var t=document.getElementById(e);t&&(unhighlight(),t.scrollIntoViewIfNeeded(!1),setTimeout(function(){unhighlight(),t.className=viewThumb.checked?"selectedT":"selected"},200))}function unhighlight(){var e=document.getElementsByClassName("selected"),t="listItem";for(viewThumb.checked&&(e=document.getElementsByClassName("selectedT"),t="listItemT");e.length;)e[0].className=t}function cleanCrumbs(){for(;"homeButton"!==breadCrumbs.lastChild.id;)breadCrumbs.removeChild(breadCrumbs.lastChild)}function saveSettings(){var e=allowAnal.checked,t=function(){comareSetts?compareSetts.tracking!==e&&analTracker.sendEvent("Settings","Analytics",e):analTracker.sendEvent("Settings","Analytics",e)};analService.getConfig().addCallback(function(n){e||t(),n.setTrackingPermitted(e)}),setTimeout(function(){e&&t()},1e3)}function getSettings(){analService.getConfig().addCallback(function(e){chrome.storage.local.get("google-analytics.analytics.tracking-permitted",function(t){"google-analytics.analytics.tracking-permitted"in t?(allowAnal.checked=e.isTrackingPermitted(),compareSetts={tracking:e.isTrackingPermitted()}):saveSettings()})})}function screenInfo(){var e=window.devicePixelRatio,t=document.documentElement.clientWidth+"x"+document.documentElement.clientHeight,n={Viewport:t,"Pixel Ratio":e};chrome.storage.local.get("screenInfo",function(a){a.screenInfo?(t!==a.screenInfo.Viewport&&analTracker.sendEvent("Screen","Viewport",t),e!==a.screenInfo["Pixel Ratio"]&&analTracker.sendEvent("Screen","Pixel Ratio",e),(t!==a.screenInfo.Viewport||e!==a.screenInfo["Pixel Ratio"])&&chrome.storage.local.set({screenInfo:n},function(){})):chrome.storage.local.set({screenInfo:n},function(){analTracker.sendEvent("Screen","Viewport",t),analTracker.sendEvent("Screen","Pixel Ratio",e)})})}function displayElm(e){e.classList.toggle("visible"),e.classList.toggle("hidden")}function settingsMenuHandler(e,t,n,a){var i;e===prefsMenu?i="Prefs Menu":e===kbsMenu&&(i="KBS Menu"),"hidden"==e.className&&(n.className="menu-item menu-item-sel",a.className="menu-item",displayElm(t),setTimeout(function(){e.style.display="block",t.style.display="none"},300),setTimeout(function(){displayElm(e),analTracker.sendEvent("Navigation","Settings Panel",i)},400))}function liquid(){player.style.height=document.documentElement.clientHeight-nav.offsetHeight+"px",settingsPanel.style.top=(document.documentElement.clientHeight-settingsPanel.offsetHeight)/2+"px",settingsPanel.style.left=(document.documentElement.clientWidth-settingsPanel.offsetWidth)/2+"px",newsletterPanel.style.top=(document.documentElement.clientHeight-newsletterPanel.offsetHeight)/2+"px",newsletterPanel.style.left=(document.documentElement.clientWidth-newsletterPanel.offsetWidth)/2+"px",upgradePanel.style.top=(document.documentElement.clientHeight-upgradePanel.offsetHeight)/2+"px",upgradePanel.style.left=(document.documentElement.clientWidth-upgradePanel.offsetWidth)/2+"px",controlsNots.style.top=(player.offsetHeight-controlsNots.offsetHeight)/2+"px",controlsNots.style.left=(player.offsetWidth-controlsNots.offsetWidth)/2+"px"}function seekBarHandler(){if(videlCheck){var e,t=Math.round(videl.duration),n=Math.floor(videl.currentTime),a=parseInt(n/3600)%24,i=parseInt(n/60)%60,l=n%60;e=600>t?i+":"+(10>l?"0"+l:l):3600>t?(10>i?"0"+i:i)+":"+(10>l?"0"+l:l):36e3>t?a+":"+(10>i?"0"+i:i)+":"+(10>l?"0"+l:l):(10>a?"0"+a:a)+":"+(10>i?"0"+i:i)+":"+(10>l?"0"+l:l),seekBar.max=videl.duration,seekBar.value=videl.currentTime,curTime.innerHTML=e}}function seek(){videlCheck&&(videl.currentTime=seekBar.value,analQ("Seek","Mouse"))}function controlsNotsHandler(e){document.webkitFullscreenElement&&(controlsNots.setAttribute("data-icon",e),controlsNots.className="visible",setTimeout(function(){controlsNots.className="hidden"},600))}function playPause(){videlCheck&&(videl.paused?(videl.play(),playPauseButton.setAttribute("data-icon","K"),controlsNotsHandler("J")):(videl.pause(),playPauseButton.setAttribute("data-icon","J"),controlsNotsHandler("K")))}function mute(){videlCheck&&audioCheck()&&(videl.muted?(videl.muted=!1,muteButton.setAttribute("data-icon","N"),controlsNotsHandler("N")):(videl.muted=!0,muteButton.setAttribute("data-icon","R"),controlsNotsHandler("R")))}function audioCheck(){return videl.webkitAudioDecodedByteCount>0?(muteButton.setAttribute("data-icon","N"),muteButton.className="clickable",!0):(muteButton.setAttribute("data-icon","R"),muteButton.className="disabled",!1)}function zoomFit(){videl.style.width=player.offsetWidth+"px",videl.style.height=player.offsetHeight+"px",document.webkitIsFullScreen||player.classList.add("playerN"),videlCheck&&!document.webkitIsFullScreen?controls.className="controlsN":videlCheck||(controls.className="controlsNV")}function analQ(e,t){var n=e.charAt(0);analQuota[n]++,analQuota[n]<=1&&analTracker.sendEvent("Controls",e,t)}function resetControls(){var e=function(){muteButton.setAttribute("data-icon","N"),muteButton.className="clickable"};videlCheck?(1==videl.paused&&videl.play(),1==videl.muted&&(videl.muted=!1,e())):(curTime.innerHTML="0:00",e()),zoomFit(),playPauseButton.setAttribute("data-icon","K")}function shortcuts(){if(videlCheck)switch(event.preventDefault(),event.keyCode){case 70:toggleFullScreen();break;case 32:playPause(),analQ("Play/Pause","Keyboard");break;case 77:mute(),analQ("Mute/Unmute","Keyboard");break;case 40:nextVideo();break;case 38:previousVideo()}if(videlCheck&&!document.webkitIsFullScreen)switch(event.preventDefault(),event.keyCode){case 88:closeVideo(),analTracker.sendEvent("Controls","Close Video","Keyboard")}if(!document.webkitIsFullScreen)switch(event.preventDefault(),event.keyCode){case 72:getGalleries(),cleanCrumbs(),analTracker.sendEvent("Navigation","Home","Keyboard");break;case 83:if(getSettings(),displayElm(settingsOverlay),"visible"!==settingsOverlay.className)return;analTracker.sendEvent("Navigation","Settings Panel","Keyboard");break;case 8:previousFolder()}}function toggleFullScreen(){document.webkitFullscreenElement?document.webkitExitFullscreen():(player.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),analQ("Fullscreen Video","Keyboard"))}function idleCursor(){var e,t=!1;window.addEventListener("mousemove",function(){document.webkitIsFullScreen?(player.classList.add("cursorH"),controls.className="controlsFSh",t||(player.classList.remove("cursorH"),controls.className="controlsFSv",clearTimeout(e),e=setTimeout(function(){player.classList.add("cursorH"),document.webkitIsFullScreen&&(controls.className="controlsFSh"),t=!0,setTimeout(function(){t=!1},200)},1e3))):player.classList.remove("cursorH")})}function newsletter(){chrome.storage.local.get("newsletter",function(e){e.newsletter?"0.5"!==e.newsletter&&(displayElm(newsletterOverlay),newsletterOverlay.onclick=function(){var e="0.5";displayElm(newsletterOverlay),chrome.storage.local.set({newsletter:e},function(){}),setTimeout(function(){newsletterOverlay.style.display="none"},400)},newsletterPanel.onclick=function(){event.stopPropagation()}):chrome.storage.local.set({newsletter:"Taengoo~!!"},function(){newsletter()})})}function viewToggle(){viewThumb.checked?(viewThumb.checked=!1,listThumbButton.setAttribute("data-icon","H"),analTracker.sendEvent("Navigation","View","List")):(viewThumb.checked=!0,listThumbButton.setAttribute("data-icon","I"),analTracker.sendEvent("Navigation","View","Thumbnails")),sideBar.classList.add("sideBarT"),nav.classList.add("navT"),player.classList.add("playerT"),controls.classList.add("controlsT"),setView(),saveView(),setTimeout(function(){sideBar.classList.remove("sideBarT"),nav.classList.remove("navT"),player.classList.remove("playerT"),controls.classList.remove("controlsT"),videlCheck&&(zoomFit(),zoomCurrent())},350),galsData.curEntries?drawList(galsData.curEntries):getGalleries()}function saveView(){chrome.storage.local.set({view:viewThumb.checked},function(){})}function getView(){chrome.storage.local.get("view",function(e){"view"in e?(viewThumb.checked=e.view,setView(),viewThumb.checked?listThumbButton.setAttribute("data-icon","I"):listThumbButton.setAttribute("data-icon","H")):saveView()})}function setView(){sideBar.style.width=nav.style.marginLeft=player.style.marginLeft=controls.style.left=viewThumb.checked?"250px":"200px"}function loopToggle(){allowLoop.checked?(allowLoop.checked=!1,loopButton.setAttribute("data-icon","G"),videl.removeAttribute("loop")):(allowLoop.checked=!0,loopButton.setAttribute("data-icon","F"),videl.setAttribute("loop","")),saveLoop(),analTracker.sendEvent("Controls","Loop",allowLoop.checked)}function saveLoop(){chrome.storage.local.set({loop:allowLoop.checked},function(){})}function getLoop(){chrome.storage.local.get("loop",function(e){"loop"in e?(allowLoop.checked=e.loop,allowLoop.checked?loopButton.setAttribute("data-icon","F"):(loopButton.setAttribute("data-icon","G"),videl.removeAttribute("loop"))):saveLoop()})}function closeVideo(){displayElm(contentDiv),unhighlight(),setTimeout(function(){videl.src="",videlCheck=!1,resetControls(),displayElm(contentDiv),document.webkitIsFullScreen&&toggleFullScreen()},400)}function setFullscreenButton(){document.webkitIsFullScreen?fullscreenButton.setAttribute("data-icon","M"):fullscreenButton.setAttribute("data-icon","L")}var compareSetts,videlCheck,analQuota={P:0,F:0,M:0,S:0},vidlimit=0,analService=analytics.getService("LoopIt - Free"),analTracker=analService.getTracker("UA-46743561-1"),galsData={};window.addEventListener("load",function(){analTracker.sendAppView("Main"),liquid(),getSettings(),getView(),getLoop(),getGalleries(),newsletter(),idleCursor(),screenInfo(),settingsButton.addEventListener("click",function(){getSettings(),displayElm(settingsOverlay),analTracker.sendEvent("Navigation","Settings Panel","Mouse")}),addButton.addEventListener("click",function(){chrome.mediaGalleries.getMediaFileSystems({interactive:"yes"},getGalleriesMD),cleanCrumbs(),analTracker.sendEvent("Navigation","Galleries Manager","Mouse")}),homeButton.addEventListener("click",function(){getGalleries(),cleanCrumbs(),analTracker.sendEvent("Navigation","Home","Mouse")}),listThumbButton.addEventListener("click",viewToggle),scMenuItem.addEventListener("click",function(){settingsMenuHandler(kbsMenu,prefsMenu,this,settingsMenuItem)}),settingsMenuItem.addEventListener("click",function(){settingsMenuHandler(prefsMenu,kbsMenu,this,scMenuItem)}),settingsOverlay.addEventListener("click",function(){"visible"===this.className&&(getSettings(),displayElm(this))}),settingsPanel.addEventListener("click",function(){event.stopPropagation()}),applySettings.addEventListener("click",function(){saveSettings(),displayElm(settingsOverlay)}),upgradeOverlay.addEventListener("click",function(){"visible"===this.className&&(displayElm(this),vidlimit=0)}),upgradePanel.addEventListener("click",function(){event.stopPropagation()}),document.addEventListener("keyup",shortcuts),document.addEventListener("keydown",function(){event.preventDefault()}),videl.addEventListener("loadedmetadata",function(){displayElm(contentDiv)}),videl.addEventListener("loadeddata",audioCheck),videl.addEventListener("timeupdate",seekBarHandler),videl.addEventListener("ended",closeVideo),seekBar.addEventListener("input",seek),seekBar.addEventListener("mousedown",function(){videl.pause()}),seekBar.addEventListener("mouseup",function(){videl.play()}),vidThumb.addEventListener("loadeddata",genThumbnail),playPauseButton.addEventListener("click",function(){playPause(),analQ("Play/Pause","Mouse")}),muteButton.addEventListener("click",function(){mute(),analQ("Mute/Unmute","Mouse")}),loopButton.addEventListener("click",loopToggle),fullscreenButton.addEventListener("click",function(){videlCheck&&(toggleFullScreen(),analQ("Fullscreen Video","Mouse"))}),document.addEventListener("webkitfullscreenchange",function(){analTracker.sendAppView(document.webkitIsFullScreen?"Fullscreen":"Main"),setFullscreenButton()}),upgradeNow.addEventListener("click",function(){displayElm(upgradeOverlay),vidlimit=0,analTracker.sendEvent("Free","Upgrade")})}),window.addEventListener("resize",function(){liquid(),videlCheck&&zoomFit()});